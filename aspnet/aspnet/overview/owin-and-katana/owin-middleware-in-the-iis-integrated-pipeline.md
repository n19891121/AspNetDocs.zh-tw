---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: IIS 整合式管線中的 OWIN 中介軟體 |Microsoft Docs
author: Praburaj
description: 本文說明如何在 IIS 整合式管線中執行 OWIN 中介軟體元件（OMCs），以及如何設定 OMC 執行所在的管線事件。 您應該 。
ms.author: riande
ms.date: 11/07/2013
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: 7d157fb6bd9e2ae9b55af41ef06c1eb5e6310ce1
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78617135"
---
# <a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="1c6de-104">IIS 整合式管線中的 OWIN 中介軟體</span><span class="sxs-lookup"><span data-stu-id="1c6de-104">OWIN Middleware in the IIS integrated pipeline</span></span>

<span data-ttu-id="1c6de-105">[Praburaj Thiagarajan](https://github.com/Praburaj)， [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="1c6de-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

> <span data-ttu-id="1c6de-106">本文說明如何在 IIS 整合式管線中執行 OWIN 中介軟體元件（OMCs），以及如何設定 OMC 執行所在的管線事件。</span><span class="sxs-lookup"><span data-stu-id="1c6de-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="1c6de-107">閱讀本教學課程之前，您應該先參閱專案 Katana 和[OWIN 啟動類別偵測](owin-startup-class-detection.md)[的總覽](an-overview-of-project-katana.md)。</span><span class="sxs-lookup"><span data-stu-id="1c6de-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="1c6de-108">本教學課程是由 Rick Anderson （ [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ）、Chris Ross、Praburaj Thiagarajan 和 Howard Dierking （ [@howard\_Dierking](https://twitter.com/howard_dierking) ）撰寫。</span><span class="sxs-lookup"><span data-stu-id="1c6de-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>

<span data-ttu-id="1c6de-109">雖然[OWIN](an-overview-of-project-katana.md)中介軟體元件（OMCs）主要是設計成在伺服器中立的管線中執行，但也可以在 IIS 整合管線中執行 OMC （ \***不\*支援傳統模式**）。</span><span class="sxs-lookup"><span data-stu-id="1c6de-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="1c6de-110">藉由從套件管理員主控台（PMC）安裝下列套件，可以在 IIS 整合式管線中進行 OMC：</span><span class="sxs-lookup"><span data-stu-id="1c6de-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="1c6de-111">這表示所有的應用程式架構（即使尚未在 IIS 和 System.web 以外執行的架構）都可以受益于現有的 OWIN 中介軟體元件。</span><span class="sxs-lookup"><span data-stu-id="1c6de-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="1c6de-112">Visual Studio 2013 中新的身分識別系統（例如： Cookie、Microsoft 帳戶、Google、Facebook、Twitter、[持有人權杖](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html)、OAuth、授權伺服器、JWT、Azure Active Directory 和 Active directory federation services）隨附的所有 `Microsoft.Owin.Security.*` 套件都會撰寫為 OMCs，而且可以用於自我裝載和 IIS 裝載的案例。</span><span class="sxs-lookup"><span data-stu-id="1c6de-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="1c6de-113">OWIN 中介軟體如何在 IIS 整合式管線中執行</span><span class="sxs-lookup"><span data-stu-id="1c6de-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="1c6de-114">針對 OWIN 主控台應用程式，使用[啟動](owin-startup-class-detection.md)設定所建立的應用程式管線，是由使用 `IAppBuilder.Use` 方法來新增元件的順序所設定。</span><span class="sxs-lookup"><span data-stu-id="1c6de-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="1c6de-115">也就是說， [Katana](an-overview-of-project-katana.md)執行時間中的 OWIN 管線會依照其使用 `IAppBuilder.Use`註冊的順序來處理 OMCs。</span><span class="sxs-lookup"><span data-stu-id="1c6de-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="1c6de-116">在 IIS 整合式管線中，要求管線是由已訂閱一組預先定義之管線事件（例如[BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx)、 [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)、 [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)等）的[HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx)所組成。</span><span class="sxs-lookup"><span data-stu-id="1c6de-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="1c6de-117">如果我們比較 OMC 與 ASP.NET 世界中的[HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) ，則必須向正確的預先定義管線事件註冊 OMC。</span><span class="sxs-lookup"><span data-stu-id="1c6de-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="1c6de-118">例如，當要求進入管線中的[AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)階段時，HttpModule `MyModule` 會被叫用：</span><span class="sxs-lookup"><span data-stu-id="1c6de-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="1c6de-119">為了讓 OMC 參與這項相同的事件型執行排序， [Katana](an-overview-of-project-katana.md)執行時間程式碼會掃描[啟動](owin-startup-class-detection.md)設定，並將每個中介軟體元件訂閱到整合式管線事件。</span><span class="sxs-lookup"><span data-stu-id="1c6de-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="1c6de-120">例如，下列 OMC 和註冊程式碼可讓您查看中介軟體元件的預設事件註冊。</span><span class="sxs-lookup"><span data-stu-id="1c6de-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="1c6de-121">（如需有關建立 OWIN 啟動類別的詳細指示，請參閱[OWIN 啟動類別偵測](owin-startup-class-detection.md)）。</span><span class="sxs-lookup"><span data-stu-id="1c6de-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="1c6de-122">建立空白的 web 應用程式專案，並將其命名為**owin2**。</span><span class="sxs-lookup"><span data-stu-id="1c6de-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="1c6de-123">從 [套件管理員主控台] （PMC）中，執行下列命令：</span><span class="sxs-lookup"><span data-stu-id="1c6de-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="1c6de-124">新增 `OWIN Startup Class`，並將其命名為 `Startup`。</span><span class="sxs-lookup"><span data-stu-id="1c6de-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="1c6de-125">將產生的程式碼取代為下列內容（變更會反白顯示）：</span><span class="sxs-lookup"><span data-stu-id="1c6de-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="1c6de-126">按 F5 以執行應用程式。</span><span class="sxs-lookup"><span data-stu-id="1c6de-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="1c6de-127">啟動設定會設定具有三個中間件元件的管線，前兩個會顯示診斷資訊，而最後一個則會回應事件（也會顯示診斷資訊）。</span><span class="sxs-lookup"><span data-stu-id="1c6de-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="1c6de-128">`PrintCurrentIntegratedPipelineStage` 方法會顯示此中介軟體叫用所在的整合式管線事件和訊息。</span><span class="sxs-lookup"><span data-stu-id="1c6de-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="1c6de-129">[輸出] 視窗會顯示下列內容：</span><span class="sxs-lookup"><span data-stu-id="1c6de-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="1c6de-130">根據預設，Katana 執行時間會將每個 OWIN 中介軟體元件對應到[PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) ，而這會對應到 IIS 管線事件[PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx)。</span><span class="sxs-lookup"><span data-stu-id="1c6de-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="1c6de-131">階段標記</span><span class="sxs-lookup"><span data-stu-id="1c6de-131">Stage Markers</span></span>

<span data-ttu-id="1c6de-132">您可以使用 `IAppBuilder UseStageMarker()` 擴充方法，將 OMCs 標示為在管線的特定階段執行。</span><span class="sxs-lookup"><span data-stu-id="1c6de-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="1c6de-133">若要在特定階段執行一組中介軟體元件，請在註冊過程中，于最後一個元件之後插入階段標記。</span><span class="sxs-lookup"><span data-stu-id="1c6de-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="1c6de-134">您可以在管線的哪一個階段執行中介軟體，以及訂單元件必須執行的規則（本教學課程稍後會說明這些規則）。</span><span class="sxs-lookup"><span data-stu-id="1c6de-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="1c6de-135">將 `UseStageMarker` 方法新增至 `Configuration` 程式碼，如下所示：</span><span class="sxs-lookup"><span data-stu-id="1c6de-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="1c6de-136">`app.UseStageMarker(PipelineStage.Authenticate)` 呼叫會設定所有先前註冊的中介軟體元件（在此案例中為我們的兩個診斷元件），以在管線的驗證階段執行。</span><span class="sxs-lookup"><span data-stu-id="1c6de-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="1c6de-137">最後一個中介軟體元件（顯示診斷和回應要求）會在 `ResolveCache` 階段執行（ [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx)事件）。</span><span class="sxs-lookup"><span data-stu-id="1c6de-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="1c6de-138">按 F5 以執行應用程式。[輸出] 視窗會顯示下列內容：</span><span class="sxs-lookup"><span data-stu-id="1c6de-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="1c6de-139">階段標記規則</span><span class="sxs-lookup"><span data-stu-id="1c6de-139">Stage Marker Rules</span></span>

<span data-ttu-id="1c6de-140">Owin 中介軟體元件（OMC）可以設定為在下列 OWIN 管線階段事件中執行：</span><span class="sxs-lookup"><span data-stu-id="1c6de-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="1c6de-141">根據預設，OMCs 會在最後一個事件（`PreHandlerExecute`）上執行。</span><span class="sxs-lookup"><span data-stu-id="1c6de-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="1c6de-142">這就是為什麼我們的第一個範例程式碼會顯示「PreExecuteRequestHandler」。</span><span class="sxs-lookup"><span data-stu-id="1c6de-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="1c6de-143">您可以使用 `app.UseStageMarker` 方法，在 `PipelineStage` 列舉中列出的 OWIN 管線的任何階段，註冊要在先前執行的 OMC。</span><span class="sxs-lookup"><span data-stu-id="1c6de-143">You can use the a `app.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="1c6de-144">OWIN 管線和 IIS 管線會進行排序，因此 `app.UseStageMarker` 的呼叫必須是順序。</span><span class="sxs-lookup"><span data-stu-id="1c6de-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="1c6de-145">您無法將事件處理常式設定為在向註冊的最後一個事件之前的事件 `app.UseStageMarker`。</span><span class="sxs-lookup"><span data-stu-id="1c6de-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="1c6de-146">例如，*在呼叫之後*：</span><span class="sxs-lookup"><span data-stu-id="1c6de-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

   <span data-ttu-id="1c6de-147">將不會接受 `app.UseStageMarker` 傳遞 `Authenticate` 或 `PostAuthenticate` 的呼叫，也不會擲回任何例外狀況。</span><span class="sxs-lookup"><span data-stu-id="1c6de-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="1c6de-148">OMCs 會在最新階段執行，預設為 `PreHandlerExecute`。</span><span class="sxs-lookup"><span data-stu-id="1c6de-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="1c6de-149">階段標記是用來讓它們在稍早的時間執行。</span><span class="sxs-lookup"><span data-stu-id="1c6de-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="1c6de-150">如果您不按照順序指定階段標記，我們會四捨五入到先前的標記。</span><span class="sxs-lookup"><span data-stu-id="1c6de-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="1c6de-151">換句話說，新增階段標記會顯示「執行不晚于階段 X」。</span><span class="sxs-lookup"><span data-stu-id="1c6de-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="1c6de-152">OMC 會在 OWIN 管線中于其後面新增的最早階段標記執行。</span><span class="sxs-lookup"><span data-stu-id="1c6de-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="1c6de-153">呼叫 `app.UseStageMarker` 獲勝的最早階段。</span><span class="sxs-lookup"><span data-stu-id="1c6de-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="1c6de-154">例如，如果您從先前的範例切換 `app.UseStageMarker` 呼叫的順序：</span><span class="sxs-lookup"><span data-stu-id="1c6de-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

   <span data-ttu-id="1c6de-155">[輸出] 視窗將會顯示：</span><span class="sxs-lookup"><span data-stu-id="1c6de-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

   <span data-ttu-id="1c6de-156">OMCs 全都會在 `AuthenticateRequest` 階段中執行，因為最後一個 OMC 已向 `Authenticate` 事件註冊，而 `Authenticate` 事件在所有其他事件之前。</span><span class="sxs-lookup"><span data-stu-id="1c6de-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
