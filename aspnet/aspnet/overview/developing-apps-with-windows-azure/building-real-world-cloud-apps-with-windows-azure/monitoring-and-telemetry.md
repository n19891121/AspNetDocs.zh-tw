---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry
title: 監視和遙測（使用 Azure 建立真實世界的雲端應用程式） |Microsoft Docs
author: MikeWasson
description: 使用 Azure 電子書建立真實世界的雲端應用程式，是以 Scott Guthrie 所開發的簡報為基礎。 它會說明13個模式和實務，
ms.author: riande
ms.date: 07/09/2015
ms.assetid: 7e986ab5-6615-4638-add7-4614ce7b51db
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry
msc.type: authoredcontent
ms.openlocfilehash: 44941c9fd0dcd3223604fc4a4f2836f587578acb
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/28/2019
ms.locfileid: "74585622"
---
# <a name="monitoring-and-telemetry-building-real-world-cloud-apps-with-azure"></a><span data-ttu-id="33c78-104">監視和遙測（使用 Azure 建立真實世界的雲端應用程式）</span><span class="sxs-lookup"><span data-stu-id="33c78-104">Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)</span></span>

<span data-ttu-id="33c78-105">由[Mike Wasson](https://github.com/MikeWasson)， [Rick Anderson]((https://twitter.com/RickAndMSFT))， [Tom 作者: dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="33c78-105">by [Mike Wasson](https://github.com/MikeWasson), [Rick Anderson]((https://twitter.com/RickAndMSFT)), [Tom Dykstra](https://github.com/tdykstra)</span></span>

<span data-ttu-id="33c78-106">[下載 Fix It 專案](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4)或[下載電子書](https://blogs.msdn.com/b/microsoft_press/archive/2014/07/23/free-ebook-building-cloud-apps-with-microsoft-azure.aspx)</span><span class="sxs-lookup"><span data-stu-id="33c78-106">[Download Fix It Project](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4) or [Download E-book](https://blogs.msdn.com/b/microsoft_press/archive/2014/07/23/free-ebook-building-cloud-apps-with-microsoft-azure.aspx)</span></span>

> <span data-ttu-id="33c78-107">**使用 Azure 電子書建立真實世界的雲端應用程式**，是以 Scott Guthrie 所開發的簡報為基礎。</span><span class="sxs-lookup"><span data-stu-id="33c78-107">The **Building Real World Cloud Apps with Azure** e-book is based on a presentation developed by Scott Guthrie.</span></span> <span data-ttu-id="33c78-108">其中說明13種模式和作法，可協助您成功開發雲端 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="33c78-108">It explains 13 patterns and practices that can help you be successful developing web apps for the cloud.</span></span> <span data-ttu-id="33c78-109">如需電子書的相關資訊，請參閱[第一章](introduction.md)。</span><span class="sxs-lookup"><span data-stu-id="33c78-109">For information about the e-book, see [the first chapter](introduction.md).</span></span>

<span data-ttu-id="33c78-110">有很多人會依賴客戶，讓他們知道他們的應用程式何時關閉。</span><span class="sxs-lookup"><span data-stu-id="33c78-110">A lot of people rely on customers to let them know when their application is down.</span></span> <span data-ttu-id="33c78-111">這不是任何地方的最佳作法，尤其是不在雲端中。</span><span class="sxs-lookup"><span data-stu-id="33c78-111">That's not really a best practice anywhere, and especially not in the cloud.</span></span> <span data-ttu-id="33c78-112">並不保證快速通知，而當您收到通知時，您通常會得到最小或誤導的資料，告訴您發生了什麼事。</span><span class="sxs-lookup"><span data-stu-id="33c78-112">There's no guarantee of quick notification, and when you do get notified, you often get minimal or misleading data about what happened.</span></span> <span data-ttu-id="33c78-113">有了良好的遙測和記錄系統，您就可以瞭解應用程式的運作狀況，而當發生問題時，您會立即找出並提供有用的疑難排解資訊來處理。</span><span class="sxs-lookup"><span data-stu-id="33c78-113">With good telemetry and logging systems you can be aware of what's going on with your app, and when something does go wrong you find out right away and have helpful troubleshooting information to work with.</span></span>

## <a name="buy-or-rent-a-telemetry-solution"></a><span data-ttu-id="33c78-114">購買或出租遙測解決方案</span><span class="sxs-lookup"><span data-stu-id="33c78-114">Buy or rent a telemetry solution</span></span>

> [!NOTE]
> <span data-ttu-id="33c78-115">這篇文章是在[Application Insights](/azure/application-insights/app-insights-overview)發行之前撰寫的。</span><span class="sxs-lookup"><span data-stu-id="33c78-115">This article was written before [Application Insights](/azure/application-insights/app-insights-overview) was released.</span></span> <span data-ttu-id="33c78-116">Application Insights 是 Azure 上遙測解決方案的慣用方法。</span><span class="sxs-lookup"><span data-stu-id="33c78-116">Application Insights is the preferred approach for telemetry solutions on Azure.</span></span> <span data-ttu-id="33c78-117">如需詳細資訊，請參閱[設定 ASP.NET 網站的 Application Insights](/azure/application-insights/app-insights-asp-net) 。</span><span class="sxs-lookup"><span data-stu-id="33c78-117">See [Set up Application Insights for your ASP.NET website](/azure/application-insights/app-insights-asp-net) for more information.</span></span>

<span data-ttu-id="33c78-118">雲端環境最棒的其中一件事，就是很容易購買或出租您的勝利。</span><span class="sxs-lookup"><span data-stu-id="33c78-118">One of the things that's great about the cloud environment is that it's really easy to buy or rent your way to victory.</span></span> <span data-ttu-id="33c78-119">遙測是一個範例。</span><span class="sxs-lookup"><span data-stu-id="33c78-119">Telemetry is an example.</span></span> <span data-ttu-id="33c78-120">如果沒有這麼多工作，您可以將真正好用的遙測系統啟動並執行，以非常符合成本效益的方式運作。</span><span class="sxs-lookup"><span data-stu-id="33c78-120">Without a lot of effort you can get a really good telemetry system up and running, very cost-effectively.</span></span> <span data-ttu-id="33c78-121">有許多與 Azure 整合的絕佳合作夥伴，其中有些有免費層，因此您可以取得基本遙測資料，而不需要進行任何動作。</span><span class="sxs-lookup"><span data-stu-id="33c78-121">There are a bunch of great partners that integrate with Azure, and some of them have free tiers – so you can get basic telemetry for nothing.</span></span> <span data-ttu-id="33c78-122">以下只是 Azure 上目前可用的幾個：</span><span class="sxs-lookup"><span data-stu-id="33c78-122">Here are just a few of the ones currently available on Azure:</span></span>

- [<span data-ttu-id="33c78-123">新增 New relic</span><span class="sxs-lookup"><span data-stu-id="33c78-123">New Relic</span></span>](http://newrelic.com/)
- [<span data-ttu-id="33c78-124">AppDynamics</span><span class="sxs-lookup"><span data-stu-id="33c78-124">AppDynamics</span></span>](http://www.appdynamics.com/)
- [<span data-ttu-id="33c78-125">Dynatrace</span><span class="sxs-lookup"><span data-stu-id="33c78-125">Dynatrace</span></span>](https://datamarket.azure.com/application/b4011de2-1212-4375-9211-e882766121ff)

<span data-ttu-id="33c78-126">[Microsoft System Center](http://www.petri.co.il/microsoft-system-center-introduction.htm#)也包含監視功能。</span><span class="sxs-lookup"><span data-stu-id="33c78-126">[Microsoft System Center](http://www.petri.co.il/microsoft-system-center-introduction.htm#) also includes monitoring features.</span></span>

<span data-ttu-id="33c78-127">我們會快速逐步解說如何設定新的 New relic，以顯示使用遙測系統有多容易。</span><span class="sxs-lookup"><span data-stu-id="33c78-127">We'll quickly walk through setting up New Relic to show how easy it can be to use a telemetry system.</span></span>

<span data-ttu-id="33c78-128">在 Azure 管理入口網站中，註冊服務。</span><span class="sxs-lookup"><span data-stu-id="33c78-128">In the Azure management portal, sign up for the service.</span></span> <span data-ttu-id="33c78-129">按一下 [**新增**]，然後按一下 [**儲存**]。</span><span class="sxs-lookup"><span data-stu-id="33c78-129">Click **New**, and then click **Store**.</span></span> <span data-ttu-id="33c78-130">[**選擇附加**元件] 對話方塊隨即出現。</span><span class="sxs-lookup"><span data-stu-id="33c78-130">The **Choose an Add-on** dialog box appears.</span></span> <span data-ttu-id="33c78-131">向下 New relic，然後按一下 [**新增**]。</span><span class="sxs-lookup"><span data-stu-id="33c78-131">Scroll down and click **New Relic**.</span></span>

![選擇附加元件](monitoring-and-telemetry/_static/image1.png)

<span data-ttu-id="33c78-133">按一下向右箭號，然後選擇您想要的服務層級。</span><span class="sxs-lookup"><span data-stu-id="33c78-133">Click the right arrow and choose the service tier you want.</span></span> <span data-ttu-id="33c78-134">在此示範中，我們將使用免費層。</span><span class="sxs-lookup"><span data-stu-id="33c78-134">For this demo we'll use the free tier.</span></span>

![個人化附加元件](monitoring-and-telemetry/_static/image2.png)

<span data-ttu-id="33c78-136">按一下向右箭號，確認 [購買]，新的 New relic 現在會在入口網站中顯示為附加元件。</span><span class="sxs-lookup"><span data-stu-id="33c78-136">Click the right arrow, confirm the "purchase," and New Relic now shows up as an Add-on in the portal.</span></span>

![審查購買](monitoring-and-telemetry/_static/image3.png)

![在入口網站中新增 New relic 附加元件](monitoring-and-telemetry/_static/image4.png)

<span data-ttu-id="33c78-139">按一下 [**連接資訊**]，然後複製授權金鑰。</span><span class="sxs-lookup"><span data-stu-id="33c78-139">Click **Connection Info**, and copy the license key.</span></span>

![連接資訊](monitoring-and-telemetry/_static/image5.png)

<span data-ttu-id="33c78-141">在入口網站中，移至 web 應用程式的 [**設定**] 索引標籤，將 [**效能監視**] 設定為 [**附加**元件]，然後將 [**選擇附加**元件] 下拉式清單設定為 [**新 new relic**]。</span><span class="sxs-lookup"><span data-stu-id="33c78-141">Go to the **Configure** tab for your web app in the portal, set **Performance Monitoring** to **Add-On**, and set the **Choose Add-On** drop-down list to **New Relic**.</span></span> <span data-ttu-id="33c78-142">然後按一下 [**儲存**]。</span><span class="sxs-lookup"><span data-stu-id="33c78-142">Then click **Save**.</span></span>

![[設定] 索引標籤中的新 New relic](monitoring-and-telemetry/_static/image6.png)

<span data-ttu-id="33c78-144">在 Visual Studio 中，在您的應用程式中安裝新的 New relic NuGet 套件。</span><span class="sxs-lookup"><span data-stu-id="33c78-144">In Visual Studio, install the New Relic NuGet package in your app.</span></span>

![[設定] 索引標籤中的開發人員分析](monitoring-and-telemetry/_static/image7.png)

<span data-ttu-id="33c78-146">將應用程式部署至 Azure，並開始使用它。</span><span class="sxs-lookup"><span data-stu-id="33c78-146">Deploy the app to Azure and start using it.</span></span> <span data-ttu-id="33c78-147">建立幾個 Fix It 工作，以提供一些活動讓新的 New relic 監視。</span><span class="sxs-lookup"><span data-stu-id="33c78-147">Create a few Fix It tasks to provide some activity for New Relic to monitor.</span></span>

<span data-ttu-id="33c78-148">然後返回入口網站的 [**附加**元件] 索引標籤中的 [**新增 new relic** ] 頁面，然後按一下 [**管理**]。</span><span class="sxs-lookup"><span data-stu-id="33c78-148">Then go back to the **New Relic** page in the **Add-ons** tab of the portal and click **Manage**.</span></span> <span data-ttu-id="33c78-149">入口網站會將您傳送至新的 New relic 管理入口網站，使用單一登入進行驗證，因此您不需要再次輸入認證。</span><span class="sxs-lookup"><span data-stu-id="33c78-149">The portal sends you to the New Relic management portal, using single sign-on for authentication so you don't have to enter your credentials again.</span></span> <span data-ttu-id="33c78-150">[總覽] 頁面會顯示各種效能統計資料。</span><span class="sxs-lookup"><span data-stu-id="33c78-150">The Overview page presents a variety of performance statistics.</span></span> <span data-ttu-id="33c78-151">（按一下影像以查看完整大小的 [總覽] 頁面）。</span><span class="sxs-lookup"><span data-stu-id="33c78-151">(Click the image to see the overview page full size.)</span></span>

<span data-ttu-id="33c78-152">[![新的 New relic 監視 索引標籤](monitoring-and-telemetry/_static/image9.png)](monitoring-and-telemetry/_static/image8.png)</span><span class="sxs-lookup"><span data-stu-id="33c78-152">[![New Relic Monitoring tab](monitoring-and-telemetry/_static/image9.png)](monitoring-and-telemetry/_static/image8.png)</span></span>

<span data-ttu-id="33c78-153">以下是您可以看到的幾個統計資料：</span><span class="sxs-lookup"><span data-stu-id="33c78-153">Here are just a few of the statistics you can see:</span></span>

- <span data-ttu-id="33c78-154">一天中不同時間的平均回應時間。</span><span class="sxs-lookup"><span data-stu-id="33c78-154">Average response time at different times of day.</span></span>

    ![回應時間](monitoring-and-telemetry/_static/image10.png)
- <span data-ttu-id="33c78-156">一天中不同時間的輸送量速率（以每分鐘的要求數計算）。</span><span class="sxs-lookup"><span data-stu-id="33c78-156">Throughput rates (in requests per minute) at different times of day.</span></span>

    ![輸送量](monitoring-and-telemetry/_static/image11.png)
- <span data-ttu-id="33c78-158">處理不同 HTTP 要求所花費的伺服器 CPU 時間。</span><span class="sxs-lookup"><span data-stu-id="33c78-158">Server CPU time spent handling different HTTP requests.</span></span>

    ![Web 交易時間](monitoring-and-telemetry/_static/image12.png)
- <span data-ttu-id="33c78-160">應用程式代碼的不同部分所花費的 CPU 時間：</span><span class="sxs-lookup"><span data-stu-id="33c78-160">CPU time spent in different parts of the application code:</span></span>

    ![追蹤詳細資料](monitoring-and-telemetry/_static/image13.png)
- <span data-ttu-id="33c78-162">歷程記錄效能統計資料。</span><span class="sxs-lookup"><span data-stu-id="33c78-162">Historical performance statistics.</span></span>

    ![歷程記錄效能](monitoring-and-telemetry/_static/image14.png)
- <span data-ttu-id="33c78-164">對外部服務的呼叫，例如 Blob 服務，以及有關服務的可靠和回應程度的統計資料。</span><span class="sxs-lookup"><span data-stu-id="33c78-164">Calls to external services such as the Blob service and statistics about how reliable and responsive the service has been.</span></span>

    ![外部服務](monitoring-and-telemetry/_static/image15.png)

    ![外部服務](monitoring-and-telemetry/_static/image16.png)

    ![外部服務](monitoring-and-telemetry/_static/image17.png)
- <span data-ttu-id="33c78-168">有關全球何處或美國 web 應用程式流量來自何處的資訊。</span><span class="sxs-lookup"><span data-stu-id="33c78-168">Information about where in the world or where in the U.S. web app traffic came from.</span></span>

    ![地理位置](monitoring-and-telemetry/_static/image18.png)

<span data-ttu-id="33c78-170">您也可以設定報表和事件。</span><span class="sxs-lookup"><span data-stu-id="33c78-170">You can also set up reports and events.</span></span> <span data-ttu-id="33c78-171">例如，您可以在每次開始看到錯誤時，傳送電子郵件給警示支援人員以解決問題。</span><span class="sxs-lookup"><span data-stu-id="33c78-171">For example, you can say any time you start seeing errors, send an email to alert support staff to the problem.</span></span>

![報表](monitoring-and-telemetry/_static/image19.png)

<span data-ttu-id="33c78-173">新的 New relic 只是遙測系統的其中一個範例;您也可以從其他服務取得所有此項。</span><span class="sxs-lookup"><span data-stu-id="33c78-173">New Relic is just one example of a telemetry system; you can get all of this from other services as well.</span></span> <span data-ttu-id="33c78-174">雲端的優點是，不需要撰寫任何程式碼，而且最少或完全沒有費用，因此您突然可以取得更多有關應用程式的使用方式，以及您的客戶實際遇到的資訊。</span><span class="sxs-lookup"><span data-stu-id="33c78-174">The beauty of the cloud is that without having to write any code, and for minimal or no expense, you suddenly can get a lot more information about how your application is being used and what your customers are actually experiencing.</span></span>

<a id="log"></a>
## <a name="log-for-insight"></a><span data-ttu-id="33c78-175">記錄以深入解析</span><span class="sxs-lookup"><span data-stu-id="33c78-175">Log for insight</span></span>

<span data-ttu-id="33c78-176">遙測封裝是一個很好的第一個步驟，但您仍然必須檢測自己的程式碼。</span><span class="sxs-lookup"><span data-stu-id="33c78-176">A telemetry package is a good first step, but you still have to instrument your own code.</span></span> <span data-ttu-id="33c78-177">遙測服務會在發生問題時通知您，並告訴您客戶所遇到的情況，但可能不會讓您深入瞭解程式碼中的狀況。</span><span class="sxs-lookup"><span data-stu-id="33c78-177">The telemetry service tells you when there's a problem and tells you what the customers are experiencing, but it may not give you a lot of insight into what's going on in your code.</span></span>

<span data-ttu-id="33c78-178">您不想要遠端進入生產伺服器，以查看您的應用程式正在執行的作業。</span><span class="sxs-lookup"><span data-stu-id="33c78-178">You don't want to have to remote into a production server to see what your app is doing.</span></span> <span data-ttu-id="33c78-179">當您有一部伺服器時，這可能很實用，但當您擴充到數百部伺服器，而您不知道需要遠端執行哪些作業時，該怎麼辦？</span><span class="sxs-lookup"><span data-stu-id="33c78-179">That might be practical when you've got one server, but what about when you've scaled to hundreds of servers and you don't know which ones you need to remote into?</span></span> <span data-ttu-id="33c78-180">您的記錄應該提供足夠的資訊，讓您永遠都不需要從遠端進入實際執行伺服器來分析和偵測問題。</span><span class="sxs-lookup"><span data-stu-id="33c78-180">Your logging should provide enough information that you never have to remote into production servers to analyze and debug problems.</span></span> <span data-ttu-id="33c78-181">您應該記錄足夠的資訊，讓您可以只透過記錄來隔離問題。</span><span class="sxs-lookup"><span data-stu-id="33c78-181">You should be logging enough information so that you can isolate issues solely through the logs.</span></span>

### <a name="log-in-production"></a><span data-ttu-id="33c78-182">登入生產環境</span><span class="sxs-lookup"><span data-stu-id="33c78-182">Log in production</span></span>

<span data-ttu-id="33c78-183">有很多人只有在發生問題而想要進行 debug 時，才會在生產環境中開啟追蹤。</span><span class="sxs-lookup"><span data-stu-id="33c78-183">A lot of people turn on tracing in production only when there's a problem and they want to debug.</span></span> <span data-ttu-id="33c78-184">這可能會在您注意到問題的時間與取得有用的疑難排解資訊的時間之間產生明顯的延遲。</span><span class="sxs-lookup"><span data-stu-id="33c78-184">This can introduce a substantial delay between the time you're aware of a problem and the time you get useful troubleshooting information about it.</span></span> <span data-ttu-id="33c78-185">而您取得的資訊對於間歇錯誤可能不會有説明。</span><span class="sxs-lookup"><span data-stu-id="33c78-185">And the information you get might not be helpful for intermittent errors.</span></span>

<span data-ttu-id="33c78-186">在雲端環境中，我們建議的儲存體成本較低，因為您一律會在生產環境中保留登入。</span><span class="sxs-lookup"><span data-stu-id="33c78-186">What we recommend in the cloud environment where storage is cheap is that you always leave logging on in production.</span></span> <span data-ttu-id="33c78-187">如此一來，當錯誤發生時，您就已經記錄了，而且您有歷程記錄資料，可協助您分析隨著時間而開發的問題，或在不同時間定期發生。</span><span class="sxs-lookup"><span data-stu-id="33c78-187">That way when errors happen you already have them logged, and you have historical data that can help you analyze issues that develop over time or happen regularly at different times.</span></span> <span data-ttu-id="33c78-188">您可以將清除程式自動化以刪除舊的記錄檔，但您可能會發現設定這類程式比保留記錄更耗費資源。</span><span class="sxs-lookup"><span data-stu-id="33c78-188">You could automate a purge process to delete old logs, but you might find that it's more expensive to set up such a process than it is to keep the logs.</span></span>

<span data-ttu-id="33c78-189">相較于疑難排解時間和成本，您可以在發生問題時，讓所需的所有資訊都可供使用，而增加的記錄成本也很簡單。</span><span class="sxs-lookup"><span data-stu-id="33c78-189">The added expense of logging is trivial compared to the amount of troubleshooting time and money you can save by having all of the information you need already available when something goes wrong.</span></span> <span data-ttu-id="33c78-190">然後，當有人告訴您，他們在過去晚上8:00 時有隨機的錯誤，但他們並不記得該錯誤，您可以輕易地找出問題所在。</span><span class="sxs-lookup"><span data-stu-id="33c78-190">Then when someone tells you they had a random error sometime around 8:00 last night, but they don't remember the error, you can readily find out what the problem was.</span></span>

<span data-ttu-id="33c78-191">每月不到 $4，您可以保留 50 gb 的記錄檔，而記錄的效能影響很簡單，因為您必須記住一件事--為了避免效能瓶頸，請確定您的記錄程式庫是非同步。</span><span class="sxs-lookup"><span data-stu-id="33c78-191">For less than $4 a month you can keep 50 gigabytes of logs on hand, and the performance impact of logging is trivial so long as you keep one thing in mind -- in order to avoid performance bottlenecks, make sure your logging library is asynchronous.</span></span>

### <a name="differentiate-logs-that-inform-from-logs-that-require-action"></a><span data-ttu-id="33c78-192">區分記錄檔，以從需要採取動作的記錄來通知</span><span class="sxs-lookup"><span data-stu-id="33c78-192">Differentiate logs that inform from logs that require action</span></span>

<span data-ttu-id="33c78-193">記錄檔的目的是要通知（我希望您知道某專案）或 ACT （我想要做一些事）。</span><span class="sxs-lookup"><span data-stu-id="33c78-193">Logs are meant to INFORM (I want you to know something) or ACT (I want you to do something).</span></span> <span data-ttu-id="33c78-194">請小心，只針對真的需要人員或自動化程式採取行動的問題撰寫 ACT 記錄。</span><span class="sxs-lookup"><span data-stu-id="33c78-194">Be careful to only write ACT logs for issues that genuinely require a person or an automated process to take action.</span></span> <span data-ttu-id="33c78-195">有太多 ACT 記錄會造成雜訊，需要太多工來進行全部的檢查，以找出真正的問題。</span><span class="sxs-lookup"><span data-stu-id="33c78-195">Too many ACT logs will create noise, requiring too much work to sift through it all to find genuine issues.</span></span> <span data-ttu-id="33c78-196">而且，如果您的 ACT 記錄自動觸發某些動作，例如傳送電子郵件給支援人員，請避免單一問題觸發數以千計的這類動作。</span><span class="sxs-lookup"><span data-stu-id="33c78-196">And if your ACT logs automatically trigger some action such as sending email to support staff, avoid letting thousands of such actions be triggered by a single issue.</span></span>

<span data-ttu-id="33c78-197">在 .NET 的診斷追蹤中，可以指派錯誤、警告、資訊和 Debug/Verbose 層級的記錄。</span><span class="sxs-lookup"><span data-stu-id="33c78-197">In .NET System.Diagnostics tracing, logs can be assigned Error, Warning, Info, and Debug/Verbose level.</span></span> <span data-ttu-id="33c78-198">您可以保留 ACT 記錄的錯誤層級，並使用較低層級的通知記錄，來區別來自通知記錄的 ACT。</span><span class="sxs-lookup"><span data-stu-id="33c78-198">You can differentiate ACT from INFORM logs by reserving the Error level for ACT logs and using the lower levels for INFORM logs.</span></span>

![記錄層級](monitoring-and-telemetry/_static/image20.png)

### <a name="configure-logging-levels-at-run-time"></a><span data-ttu-id="33c78-200">在執行時間設定記錄層級</span><span class="sxs-lookup"><span data-stu-id="33c78-200">Configure logging levels at run time</span></span>

<span data-ttu-id="33c78-201">雖然可以在生產環境中記錄永遠開啟，但另一個最佳作法是執行記錄架構，讓您在執行時間調整您所記錄的詳細資料層級，而不需要重新部署或重新開機您的應用程式。</span><span class="sxs-lookup"><span data-stu-id="33c78-201">While it's worthwhile to have logging always on in production, another best practice is to implement a logging framework that enables you to adjust at run-time the level of detail that you're logging, without redeploying or restarting your application.</span></span> <span data-ttu-id="33c78-202">例如，當您在 `System.Diagnostics` 中使用追蹤設備時，可以建立錯誤、警告、資訊和 Debug/Verbose 記錄。</span><span class="sxs-lookup"><span data-stu-id="33c78-202">For example when you use the tracing facility in `System.Diagnostics` you can create Error, Warning, Info, and Debug/Verbose logs.</span></span> <span data-ttu-id="33c78-203">我們建議您一律在生產環境中記錄錯誤、警告和資訊記錄，而且您會想要能夠動態新增 Debug/Verbose 記錄，以進行逐案例的疑難排解。</span><span class="sxs-lookup"><span data-stu-id="33c78-203">We recommend you always log Error, Warning, and Info logs in production, and you'll want to be able to dynamically add Debug/Verbose logging for troubleshooting on a case-by-case basis.</span></span>

<span data-ttu-id="33c78-204">Azure App Service 中的 Web Apps 具有將 `System.Diagnostics` 記錄寫入檔案系統、資料表儲存體或 Blob 儲存體的內建支援。</span><span class="sxs-lookup"><span data-stu-id="33c78-204">Web Apps in Azure App Service have built-in support for writing `System.Diagnostics` logs to the file system, Table storage, or Blob storage.</span></span> <span data-ttu-id="33c78-205">您可以為每個儲存體目的地選取不同的記錄層級，而且可以即時變更記錄層級，而不必重新開機應用程式。</span><span class="sxs-lookup"><span data-stu-id="33c78-205">You can select different logging levels for each storage destination, and you can change the logging level on the fly without restarting your application.</span></span> <span data-ttu-id="33c78-206">Blob 儲存體支援可讓您更輕鬆地在應用程式記錄上執行[hdinsight](https://docs.microsoft.com/azure/hdinsight/)分析工作，因為 hdinsight 知道如何直接使用 Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="33c78-206">The Blob storage support makes it easier to run [HDInsight](https://docs.microsoft.com/azure/hdinsight/) analysis jobs on your application logs, because HDInsight knows how to work with Blob storage directly.</span></span>

### <a name="log-exceptions"></a><span data-ttu-id="33c78-207">記錄例外狀況</span><span class="sxs-lookup"><span data-stu-id="33c78-207">Log Exceptions</span></span>

<span data-ttu-id="33c78-208">不要單純放入*例外狀況。* 記錄程式碼中的 ToString （）。</span><span class="sxs-lookup"><span data-stu-id="33c78-208">Don't just put *exception.ToString()* in your logging code.</span></span> <span data-ttu-id="33c78-209">這會留下內容相關資訊。</span><span class="sxs-lookup"><span data-stu-id="33c78-209">That leaves out contextual information.</span></span> <span data-ttu-id="33c78-210">在發生 SQL 錯誤的情況下，它會留下 SQL 錯誤號碼。</span><span class="sxs-lookup"><span data-stu-id="33c78-210">In the case of SQL errors, it leaves out the SQL error number.</span></span> <span data-ttu-id="33c78-211">針對所有例外狀況，包括內容資訊、例外狀況本身和內部例外狀況，以確保您提供疑難排解所需的所有專案。</span><span class="sxs-lookup"><span data-stu-id="33c78-211">For all exceptions, include context information, the exception itself, and inner exceptions to make sure that you are providing everything that will be needed for troubleshooting.</span></span> <span data-ttu-id="33c78-212">例如，內容資訊可能包括伺服器名稱、交易識別碼，以及使用者名稱（而不是密碼或任何秘密！）。</span><span class="sxs-lookup"><span data-stu-id="33c78-212">For example, context information might include the server name, a transaction identifier, and a user name (but not the password or any secrets!).</span></span>

<span data-ttu-id="33c78-213">如果您依賴每一位開發人員來進行例外狀況記錄的正確動作，其中有些是不會的。</span><span class="sxs-lookup"><span data-stu-id="33c78-213">If you rely on each developer to do the right thing with exception logging, some of them won't.</span></span> <span data-ttu-id="33c78-214">為了確保每次都能以正確的方式執行，請將例外狀況處理直接放在記錄器介面中：將例外狀況物件本身傳遞至記錄器類別，並在記錄器類別中正確記錄例外狀況資料。</span><span class="sxs-lookup"><span data-stu-id="33c78-214">To ensure that it gets done the right way every time, build exception handling right into your logger interface: pass the exception object itself to the logger class and log the exception data properly in the logger class.</span></span>

### <a name="log-calls-to-services"></a><span data-ttu-id="33c78-215">記錄對服務的呼叫</span><span class="sxs-lookup"><span data-stu-id="33c78-215">Log calls to services</span></span>

<span data-ttu-id="33c78-216">我們強烈建議您在每次應用程式向外呼叫服務時（不論是在資料庫或 REST API 或任何外部服務）時，撰寫記錄檔。</span><span class="sxs-lookup"><span data-stu-id="33c78-216">We highly recommend that you write a log every time your app calls out to a service, whether it's to a database or a REST API or any external service.</span></span> <span data-ttu-id="33c78-217">您的記錄中不只會包含成功或失敗的指示，而是每個要求所花費的時間。</span><span class="sxs-lookup"><span data-stu-id="33c78-217">Include in your logs not only an indication of success or failure but how long each request took.</span></span> <span data-ttu-id="33c78-218">在雲端環境中，您通常會看到與緩慢的問題相關的問題，而不是完全中斷。</span><span class="sxs-lookup"><span data-stu-id="33c78-218">In the cloud environment you'll often see problems related to slow-downs rather than complete outages.</span></span> <span data-ttu-id="33c78-219">通常需要10毫秒的時間可能會突然開始花上一秒鐘。</span><span class="sxs-lookup"><span data-stu-id="33c78-219">Something that normally takes 10 milliseconds might suddenly start taking a second.</span></span> <span data-ttu-id="33c78-220">當有人告訴您您的應用程式速度變慢時，您希望能夠查看新的 New relic 或您擁有的任何遙測服務並驗證其經驗，然後您想要能夠查看自己的記錄，以深入瞭解為什麼速度變慢的細節。</span><span class="sxs-lookup"><span data-stu-id="33c78-220">When someone tells you your app is slow, you want to be able to look at New Relic or whatever telemetry service you have and validate their experience, and then you want to be able to look are your own logs to dive into the details of why it's slow.</span></span>

### <a name="use-an-ilogger-interface"></a><span data-ttu-id="33c78-221">使用 ILogger 介面</span><span class="sxs-lookup"><span data-stu-id="33c78-221">Use an ILogger interface</span></span>

<span data-ttu-id="33c78-222">當您建立生產應用程式時，我們建議您建立一個簡單的*ILogger*介面，並將其中的一些方法保持在其中。</span><span class="sxs-lookup"><span data-stu-id="33c78-222">What we recommend doing when you create a production application is to create a simple *ILogger* interface and stick some methods in it.</span></span> <span data-ttu-id="33c78-223">這可讓您在稍後輕鬆變更記錄執行，而不需要逐一查看所有程式碼。</span><span class="sxs-lookup"><span data-stu-id="33c78-223">This makes it easy to change the logging implementation later and not have to go through all your code to do it.</span></span> <span data-ttu-id="33c78-224">我們可以在整個修正 It 應用程式中使用 `System.Diagnostics.Trace` 類別，但我們會在執行*ILogger*的記錄類別中的幕後使用它，而我們會在整個應用程式中進行*ILogger*方法呼叫。</span><span class="sxs-lookup"><span data-stu-id="33c78-224">We could be using the `System.Diagnostics.Trace` class throughout the Fix It app, but instead we're using it under the covers in a logging class that implements *ILogger*, and we make *ILogger* method calls throughout the app.</span></span>

<span data-ttu-id="33c78-225">如此一來，如果您想要讓記錄更豐富，可以用您想要的任何記錄機制來取代[`System.Diagnostics.Trace`](https://docs.microsoft.com/azure/app-service-web/web-sites-dotnet-troubleshoot-visual-studio#apptracelogs) 。</span><span class="sxs-lookup"><span data-stu-id="33c78-225">That way, if you ever want to make your logging richer, you can replace [`System.Diagnostics.Trace`](https://docs.microsoft.com/azure/app-service-web/web-sites-dotnet-troubleshoot-visual-studio#apptracelogs) with whatever logging mechanism you want.</span></span> <span data-ttu-id="33c78-226">例如，當您的應用程式成長時，您可能會決定要使用更完整的記錄套件，例如[NLog](http://nlog-project.org/)或[Enterprise Library 記錄應用程式區塊](https://msdn.microsoft.com/library/dn440731(v=pandp.60).aspx)。</span><span class="sxs-lookup"><span data-stu-id="33c78-226">For example, as your app grows you might decide that you want to use a more comprehensive logging package such as [NLog](http://nlog-project.org/) or [Enterprise Library Logging Application Block](https://msdn.microsoft.com/library/dn440731(v=pandp.60).aspx).</span></span> <span data-ttu-id="33c78-227">（[Log4Net](http://logging.apache.org/log4net/)是另一個熱門的記錄架構，但它不會執行非同步記錄）。</span><span class="sxs-lookup"><span data-stu-id="33c78-227">([Log4Net](http://logging.apache.org/log4net/) is another popular logging framework but it doesn't do asynchronous logging.)</span></span>

<span data-ttu-id="33c78-228">使用架構（例如 NLog）的其中一個可能原因是有助於將記錄輸出分割成不同的高容量和高價值的資料存放區。</span><span class="sxs-lookup"><span data-stu-id="33c78-228">One possible reason for using a framework such as NLog is to facilitate dividing up logging output into separate high-volume and high-value data stores.</span></span> <span data-ttu-id="33c78-229">這可協助您有效率地儲存大量通知資料，而您不需要針對執行快速查詢，同時又能快速存取 ACT 資料。</span><span class="sxs-lookup"><span data-stu-id="33c78-229">That helps you to efficiently store large volumes of INFORM data that you don't need to execute fast queries against, while maintaining quick access to ACT data.</span></span>

### <a name="semantic-logging"></a><span data-ttu-id="33c78-230">語義記錄</span><span class="sxs-lookup"><span data-stu-id="33c78-230">Semantic Logging</span></span>

<span data-ttu-id="33c78-231">如需以較新的方式執行記錄以產生更有用的診斷資訊，請參閱[企業程式庫語義記錄應用程式區塊（樓板）](http://convective.wordpress.com/2013/08/12/semantic-logging-application-block-slab/)。</span><span class="sxs-lookup"><span data-stu-id="33c78-231">For a relatively new way to do logging that can produce more useful diagnostic information, see [Enterprise Library Semantic Logging Application Block (SLAB)](http://convective.wordpress.com/2013/08/12/semantic-logging-application-block-slab/).</span></span> <span data-ttu-id="33c78-232">樓板會使用 .NET 4.5 中[的 Windows 事件追蹤](https://msdn.microsoft.com/library/windows/desktop/bb968803.aspx)（ETW）和[EventSource](https://msdn.microsoft.com/library/system.diagnostics.tracing.eventsource.aspx)支援，讓您能夠建立更具結構化和可查詢的記錄。</span><span class="sxs-lookup"><span data-stu-id="33c78-232">SLAB uses [Event Tracing for Windows](https://msdn.microsoft.com/library/windows/desktop/bb968803.aspx) (ETW) and [EventSource](https://msdn.microsoft.com/library/system.diagnostics.tracing.eventsource.aspx) support in .NET 4.5 to enable you to create more structured and queryable logs.</span></span> <span data-ttu-id="33c78-233">您可以針對您所記錄的每一種事件種類定義不同的方法，讓您自訂您所撰寫的資訊。</span><span class="sxs-lookup"><span data-stu-id="33c78-233">You define a different method for each type of event that you log, which enables you to customize the information you write.</span></span> <span data-ttu-id="33c78-234">例如，若要記錄 SQL Database 錯誤，您可以呼叫 `LogSQLDatabaseError` 方法。</span><span class="sxs-lookup"><span data-stu-id="33c78-234">For example, to log a SQL Database error you might call a `LogSQLDatabaseError` method.</span></span> <span data-ttu-id="33c78-235">針對這種例外狀況，您知道資訊的重要部分是錯誤號碼，因此您可以在方法簽章中包含錯誤號碼參數，並將錯誤號碼記錄為所撰寫記錄檔記錄中的個別欄位。</span><span class="sxs-lookup"><span data-stu-id="33c78-235">For that kind of exception, you know a key piece of information is the error number, so you could include an error number parameter in the method signature and record the error number as a separate field in the log record you write.</span></span> <span data-ttu-id="33c78-236">因為此數目位於不同的欄位，所以您可以更輕鬆可靠地取得以 SQL 錯誤號碼為基礎的報表，而不只是將錯誤號碼串連成訊息字串。</span><span class="sxs-lookup"><span data-stu-id="33c78-236">Because the number is in a separate field you can more easily and reliably get reports based on SQL error numbers than you could if you were just concatenating the error number into a message string.</span></span>

## <a name="logging-in-the-fix-it-app"></a><span data-ttu-id="33c78-237">在修正 It 應用程式中登入</span><span class="sxs-lookup"><span data-stu-id="33c78-237">Logging in the Fix It app</span></span>

### <a name="the-ilogger-interface"></a><span data-ttu-id="33c78-238">ILogger 介面</span><span class="sxs-lookup"><span data-stu-id="33c78-238">The ILogger interface</span></span>

<span data-ttu-id="33c78-239">以下是 Fix It 應用程式中的*ILogger*介面。</span><span class="sxs-lookup"><span data-stu-id="33c78-239">Here is the *ILogger* interface in the Fix It app.</span></span>

[!code-csharp[Main](monitoring-and-telemetry/samples/sample1.cs)]

<span data-ttu-id="33c78-240">這些方法可讓您以*System. Diagnostics*支援的相同四個層級來寫入記錄。</span><span class="sxs-lookup"><span data-stu-id="33c78-240">These methods enable you to write logs at the same four levels supported by *System.Diagnostics*.</span></span> <span data-ttu-id="33c78-241">TraceApi 方法是用來記錄外部服務呼叫，並提供延遲的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="33c78-241">The TraceApi methods are for logging external service calls with information about latency.</span></span> <span data-ttu-id="33c78-242">您也可以加入一組適用于 Debug/Verbose 層級的方法。</span><span class="sxs-lookup"><span data-stu-id="33c78-242">You could also add a set of methods for Debug/Verbose level.</span></span>

### <a name="the-logger-implementation-of-the-ilogger-interface"></a><span data-ttu-id="33c78-243">ILogger 介面的記錄器執行</span><span class="sxs-lookup"><span data-stu-id="33c78-243">The Logger implementation of the ILogger interface</span></span>

<span data-ttu-id="33c78-244">介面的執行其實很簡單。</span><span class="sxs-lookup"><span data-stu-id="33c78-244">The implementation of the interface is really simple.</span></span> <span data-ttu-id="33c78-245">基本上，它只會呼叫標準的*系統診斷*方法。</span><span class="sxs-lookup"><span data-stu-id="33c78-245">It basically just calls into the standard *System.Diagnostics* methods.</span></span> <span data-ttu-id="33c78-246">下列程式碼片段會顯示這三個資訊方法，以及其中一個。</span><span class="sxs-lookup"><span data-stu-id="33c78-246">The following snippet shows all three of the Information methods and one each of the others.</span></span>

[!code-csharp[Main](monitoring-and-telemetry/samples/sample2.cs)]

### <a name="calling-the-ilogger-methods"></a><span data-ttu-id="33c78-247">呼叫 ILogger 方法</span><span class="sxs-lookup"><span data-stu-id="33c78-247">Calling the ILogger methods</span></span>

<span data-ttu-id="33c78-248">每次修正 It 應用程式中的程式碼攔截到例外狀況時，它會呼叫*ILogger*方法來記錄例外狀況的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="33c78-248">Every time code in the Fix It app catches an exception, it calls an *ILogger* method to log the exception details.</span></span> <span data-ttu-id="33c78-249">而且每次呼叫資料庫、Blob 服務或 REST API 時，它會在呼叫之前啟動碼錶、在服務傳回時停止碼錶，並記錄已耗用的時間，以及成功或失敗的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="33c78-249">And every time it makes a call to the database, Blob service, or a REST API, it starts a stopwatch before the call, stops the stopwatch when the service returns, and logs the elapsed time along with information about success or failure.</span></span>

<span data-ttu-id="33c78-250">請注意，記錄訊息包含 [類別名稱] 和 [方法名稱]。</span><span class="sxs-lookup"><span data-stu-id="33c78-250">Notice that the log message includes the class name and method name.</span></span> <span data-ttu-id="33c78-251">最好的作法是確保記錄檔訊息能夠識別應用程式程式碼的哪個部分會寫入它們。</span><span class="sxs-lookup"><span data-stu-id="33c78-251">It's a good practice to make sure that log messages identify what part of the application code wrote them.</span></span>

[!code-csharp[Main](monitoring-and-telemetry/samples/sample3.cs?highlight=6,14,20-21,25)]

<span data-ttu-id="33c78-252">因此，在每次修正 It 應用程式對 SQL Database 進行呼叫時，您都可以看到呼叫、呼叫它的方法，以及確切花費的時間。</span><span class="sxs-lookup"><span data-stu-id="33c78-252">So now for every time the Fix It app has made a call to SQL Database, you can see the call, the method that called it, and exactly how much time it took.</span></span>

![記錄中的 SQL Database 查詢](monitoring-and-telemetry/_static/image21.png)

![](monitoring-and-telemetry/_static/image22.png)

<span data-ttu-id="33c78-254">如果您流覽記錄檔，您可以看到資料庫呼叫所花費的時間是變數。</span><span class="sxs-lookup"><span data-stu-id="33c78-254">If you go browsing through the logs, you can see that the time database calls take is variable.</span></span> <span data-ttu-id="33c78-255">該資訊可能很有用：因為應用程式會記錄所有這項功能，所以您可以分析資料庫服務在一段時間內執行的歷程記錄趨勢。</span><span class="sxs-lookup"><span data-stu-id="33c78-255">That information could be useful: because the app logs all this you can analyze historical trends in how the database service is performing over time.</span></span> <span data-ttu-id="33c78-256">例如，服務可能會在大部分的時間內快速，但要求可能會失敗，而回應可能會在一天的特定時間變慢。</span><span class="sxs-lookup"><span data-stu-id="33c78-256">For instance, a service might be fast most of the time but requests might fail or responses might slow down at certain times of day.</span></span>

<span data-ttu-id="33c78-257">您可以對 Blob 服務執行相同的動作–每次應用程式上傳新檔案時，都會有一個記錄檔，而您可以看到上傳每個檔案所需的確切時間。</span><span class="sxs-lookup"><span data-stu-id="33c78-257">You can do the same thing for the Blob service – for every time the app uploads a new file, there's a log, and you can see exactly how long it took to upload each file.</span></span>

![Blob 上傳記錄檔](monitoring-and-telemetry/_static/image23.png)

<span data-ttu-id="33c78-259">每當您呼叫服務時，就只需要撰寫幾行程式碼，現在當有人說他們遇到問題時，您就知道問題到底是什麼，無論是錯誤，還是就算是執行緩慢。</span><span class="sxs-lookup"><span data-stu-id="33c78-259">It's just a couple extra lines of code to write every time you call a service, and now whenever someone says they ran into an issue, you know exactly what the issue was, whether it was an error, or even if it was just running slow.</span></span> <span data-ttu-id="33c78-260">您可以找出問題的來源，而不需要遠端登入伺服器，或在錯誤發生後開啟記錄，希望重新建立。</span><span class="sxs-lookup"><span data-stu-id="33c78-260">You can pinpoint the source of the problem without having to remote into a server or turn on logging after the error happens and hope to re-create it.</span></span>

## <a name="dependency-injection-in-the-fix-it-app"></a><span data-ttu-id="33c78-261">修正 It 應用程式中的相依性插入</span><span class="sxs-lookup"><span data-stu-id="33c78-261">Dependency Injection in the Fix It app</span></span>

<span data-ttu-id="33c78-262">您可能會想知道上述範例中的存放庫構造函式如何取得記錄器介面執行：</span><span class="sxs-lookup"><span data-stu-id="33c78-262">You might wonder how the repository constructor in the example shown above gets the logger interface implementation:</span></span>

[!code-csharp[Main](monitoring-and-telemetry/samples/sample4.cs?highlight=6)]

<span data-ttu-id="33c78-263">若要將介面連線到執行，應用程式會使用相依性[插入](http://en.wikipedia.org/wiki/Dependency_injection)（DI）搭配[AutoFac](http://autofac.org/)。</span><span class="sxs-lookup"><span data-stu-id="33c78-263">To wire up the interface to the implementation the app uses [dependency injection](http://en.wikipedia.org/wiki/Dependency_injection)(DI) with [AutoFac](http://autofac.org/).</span></span> <span data-ttu-id="33c78-264">DI 可讓您在整個程式碼中使用以介面為基礎的物件，而且只需要在一個位置指定介面具現化時所使用的實作為。</span><span class="sxs-lookup"><span data-stu-id="33c78-264">DI enables you to use an object based on an interface in many places throughout your code and only have to specify in one place the implementation that gets used when the interface is instantiated.</span></span> <span data-ttu-id="33c78-265">這可讓您更輕鬆地變更執行：例如，您可能會想要將 NLog 記錄器取代為診斷記錄器。</span><span class="sxs-lookup"><span data-stu-id="33c78-265">This makes it easier to change the implementation: for example, you might want to replace the System.Diagnostics logger with an NLog logger.</span></span> <span data-ttu-id="33c78-266">或者，若要進行自動化測試，您可能會想要取代記錄器的 mock 版本。</span><span class="sxs-lookup"><span data-stu-id="33c78-266">Or for automated testing you might want to substitute a mock version of the logger.</span></span>

<span data-ttu-id="33c78-267">修正 It 應用程式會在所有的存放庫和所有的控制器中使用 DI。</span><span class="sxs-lookup"><span data-stu-id="33c78-267">The Fix It application uses DI in all of the repositories and all of the controllers.</span></span> <span data-ttu-id="33c78-268">控制器類別的函式會取得*ITaskRepository*介面，與存放庫取得記錄器介面的方式相同：</span><span class="sxs-lookup"><span data-stu-id="33c78-268">The constructors of the controller classes get an *ITaskRepository* interface the same way the repository gets a logger interface:</span></span>

[!code-csharp[Main](monitoring-and-telemetry/samples/sample5.cs?highlight=5)]

<span data-ttu-id="33c78-269">應用程式會使用 AutoFac DI 程式庫來自動提供這些函式的*TaskRepository*和*記錄器*實例。</span><span class="sxs-lookup"><span data-stu-id="33c78-269">The app uses the AutoFac DI library to automatically provide *TaskRepository* and *Logger* instances for these constructors.</span></span>

[!code-csharp[Main](monitoring-and-telemetry/samples/sample6.cs?highlight=8,10)]

<span data-ttu-id="33c78-270">這段程式碼基本上會指出，任何位置的函式都需要*ILogger*介面、傳入*記錄器*類別的實例，而且每當需要*IFixItTaskRepository*介面時，就會傳入*FixItTaskRepository*類別的實例。</span><span class="sxs-lookup"><span data-stu-id="33c78-270">This code basically says that anywhere a constructor needs an *ILogger* interface, pass in an instance of the *Logger* class, and whenever it needs an *IFixItTaskRepository* interface, pass in an instance of the *FixItTaskRepository* class.</span></span>

<span data-ttu-id="33c78-271">[AutoFac](http://autofac.org/)是您可以使用的許多相依性插入架構之一。</span><span class="sxs-lookup"><span data-stu-id="33c78-271">[AutoFac](http://autofac.org/) is one of many dependency injection frameworks that you can use.</span></span> <span data-ttu-id="33c78-272">另一個熱門的是[Unity](https://blogs.msdn.com/b/agile/archive/2013/08/20/new-guide-dependency-injection-with-unity.aspx)，這是 Microsoft 模式與實務的建議和支援。</span><span class="sxs-lookup"><span data-stu-id="33c78-272">Another popular one is [Unity](https://blogs.msdn.com/b/agile/archive/2013/08/20/new-guide-dependency-injection-with-unity.aspx), which is recommended and supported by Microsoft Patterns and Practices.</span></span>

## <a name="built-in-logging-support-in-azure"></a><span data-ttu-id="33c78-273">Azure 中的內建記錄支援</span><span class="sxs-lookup"><span data-stu-id="33c78-273">Built-in logging support in Azure</span></span>

<span data-ttu-id="33c78-274">Azure 支援[Azure App Service 中 Web Apps](https://docs.microsoft.com/azure/app-service-web/web-sites-dotnet-troubleshoot-visual-studio)的下列記錄類型：</span><span class="sxs-lookup"><span data-stu-id="33c78-274">Azure supports the following kinds of [logging for Web Apps in Azure App Service](https://docs.microsoft.com/azure/app-service-web/web-sites-dotnet-troubleshoot-visual-studio):</span></span>

- <span data-ttu-id="33c78-275">[診斷] 追蹤（您可以在不重新開機網站的情況下開啟和關閉和設定層級）。</span><span class="sxs-lookup"><span data-stu-id="33c78-275">System.Diagnostics tracing (you can turn on and off and set levels on the fly without restarting the site).</span></span>
- <span data-ttu-id="33c78-276">Windows 事件。</span><span class="sxs-lookup"><span data-stu-id="33c78-276">Windows Events.</span></span>
- <span data-ttu-id="33c78-277">IIS 記錄檔（HTTP/FREB）。</span><span class="sxs-lookup"><span data-stu-id="33c78-277">IIS Logs (HTTP/FREB).</span></span>

<span data-ttu-id="33c78-278">Azure 支援下列雲端服務類型的[記錄](https://docs.microsoft.com/azure/cloud-services/cloud-services-dotnet-diagnostics)：</span><span class="sxs-lookup"><span data-stu-id="33c78-278">Azure supports the following kinds of [logging in Cloud Services](https://docs.microsoft.com/azure/cloud-services/cloud-services-dotnet-diagnostics):</span></span>

- <span data-ttu-id="33c78-279">系統診斷追蹤。</span><span class="sxs-lookup"><span data-stu-id="33c78-279">System.Diagnostics tracing.</span></span>
- <span data-ttu-id="33c78-280">效能計數器。</span><span class="sxs-lookup"><span data-stu-id="33c78-280">Performance counters.</span></span>
- <span data-ttu-id="33c78-281">Windows 事件。</span><span class="sxs-lookup"><span data-stu-id="33c78-281">Windows Events.</span></span>
- <span data-ttu-id="33c78-282">IIS 記錄檔（HTTP/FREB）。</span><span class="sxs-lookup"><span data-stu-id="33c78-282">IIS Logs (HTTP/FREB).</span></span>
- <span data-ttu-id="33c78-283">自訂目錄監視。</span><span class="sxs-lookup"><span data-stu-id="33c78-283">Custom directory monitoring.</span></span>

<span data-ttu-id="33c78-284">Fix It 應用程式會使用 System. Diagnostics 追蹤。</span><span class="sxs-lookup"><span data-stu-id="33c78-284">The Fix It app uses System.Diagnostics tracing.</span></span> <span data-ttu-id="33c78-285">您只需要啟用 web 應用程式中的診斷記錄，就會在入口網站中翻轉交換器，或呼叫 REST API。</span><span class="sxs-lookup"><span data-stu-id="33c78-285">All you need to do to enable System.Diagnostics logging in an web app is flip a switch in the portal or call the REST API.</span></span> <span data-ttu-id="33c78-286">在入口網站中，按一下您網站**的 [設定**] 索引標籤，然後向下滾動以查看 [**應用程式診斷**] 區段。</span><span class="sxs-lookup"><span data-stu-id="33c78-286">In the portal, click the **Configuration** tab for your site, and scroll down to see the **Application Diagnostics** section.</span></span> <span data-ttu-id="33c78-287">您可以開啟或關閉記錄，並選取您想要的記錄層級。</span><span class="sxs-lookup"><span data-stu-id="33c78-287">You can turn logging on or off and select the logging level you want.</span></span> <span data-ttu-id="33c78-288">您可以讓 Azure 將記錄寫入檔案系統或儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="33c78-288">You can have Azure write the logs to the file system or to a storage account.</span></span>

![[設定] 索引標籤中的應用程式診斷和網站診斷](monitoring-and-telemetry/_static/image24.png)

<span data-ttu-id="33c78-290">在 Azure 中啟用記錄功能之後，您可以在 [Visual Studio 輸出] 視窗中查看記錄檔的建立時間。</span><span class="sxs-lookup"><span data-stu-id="33c78-290">After you enable logging in Azure, you can see logs in the Visual Studio Output window as they are created.</span></span>

![串流記錄功能表](http://wacomdpsstorage.blob.core.windows.net/articlesmedia/content-ppe.windowsazure.com/documentation/articles/web-sites-dotnet-troubleshoot-visual-studio/20140115062810/tws-viewlogsmenu.png)

![串流記錄功能表](http://wacomdpsstorage.blob.core.windows.net/articlesmedia/content-ppe.windowsazure.com/documentation/articles/web-sites-dotnet-troubleshoot-visual-studio/20140115062810/tws-nologsyet.png)

<span data-ttu-id="33c78-293">您也可以將記錄寫入儲存體帳戶，並使用可存取 Azure 儲存體表格服務的任何工具來加以查看，例如 Visual Studio 或[Azure 儲存體總管](https://azure.microsoft.com/features/storage-explorer/)中的**伺服器總管**。</span><span class="sxs-lookup"><span data-stu-id="33c78-293">You can also have logs written to your storage account and view them with any tool that can access the Azure Storage Table service, such as **Server Explorer** in Visual Studio or [Azure Storage Explorer](https://azure.microsoft.com/features/storage-explorer/).</span></span>

![伺服器總管中的記錄](http://wacomdpsstorage.blob.core.windows.net/articlesmedia/content-ppe.windowsazure.com/documentation/articles/web-sites-dotnet-troubleshoot-visual-studio/20140115062810/tws-storagelogs.png)

## <a name="summary"></a><span data-ttu-id="33c78-295">總結</span><span class="sxs-lookup"><span data-stu-id="33c78-295">Summary</span></span>

<span data-ttu-id="33c78-296">執行現成的遙測系統、在您自己的程式碼中檢測記錄，以及在 Azure 中設定記錄非常簡單。</span><span class="sxs-lookup"><span data-stu-id="33c78-296">It's really simple to implement an out-of-the-box telemetry system, instrument logging in your own code, and configure logging in Azure.</span></span> <span data-ttu-id="33c78-297">當您有生產環境問題時，遙測系統和自訂記錄的組合將可協助您快速解決問題，然後才會成為客戶的主要問題。</span><span class="sxs-lookup"><span data-stu-id="33c78-297">And when you have production issues, the combination of a telemetry system and custom logs will help you resolve problems quickly before they become major issues for your customers.</span></span>

<span data-ttu-id="33c78-298">在[下一章](transient-fault-handling.md)中，我們將探討如何處理暫時性錯誤，使其不會成為您必須調查的生產環境問題。</span><span class="sxs-lookup"><span data-stu-id="33c78-298">In the [next chapter](transient-fault-handling.md) we'll look at how to handle transient errors so they don't become production issues that you have to investigate.</span></span>

## <a name="resources"></a><span data-ttu-id="33c78-299">資源</span><span class="sxs-lookup"><span data-stu-id="33c78-299">Resources</span></span>

<span data-ttu-id="33c78-300">如需詳細資訊，請參閱下列資源。</span><span class="sxs-lookup"><span data-stu-id="33c78-300">For more information, see the following resources.</span></span>

<span data-ttu-id="33c78-301">檔主要是關於遙測：</span><span class="sxs-lookup"><span data-stu-id="33c78-301">Documentation mainly about telemetry:</span></span>

- <span data-ttu-id="33c78-302">[Microsoft 模式和實務-Azure 指引](https://msdn.microsoft.com/library/dn568099.aspx)。</span><span class="sxs-lookup"><span data-stu-id="33c78-302">[Microsoft Patterns and Practices - Azure Guidance](https://msdn.microsoft.com/library/dn568099.aspx).</span></span> <span data-ttu-id="33c78-303">請參閱檢測和遙測指引、服務計量指引、健康情況端點監視模式，以及執行時間重新設定模式。</span><span class="sxs-lookup"><span data-stu-id="33c78-303">See Instrumentation and Telemetry guidance, Service Metering  guidance, Health Endpoint Monitoring pattern, and Runtime Reconfiguration pattern.</span></span>
- <span data-ttu-id="33c78-304">[雲端中的捏合：在 Azure 網站上啟用新的 New relic 效能監視](http://www.hanselman.com/blog/PennyPinchingInTheCloudEnablingNewRelicPerformanceMonitoringOnWindowsAzureWebsites.aspx)。</span><span class="sxs-lookup"><span data-stu-id="33c78-304">[Penny Pinching in the Cloud: Enabling New Relic Performance Monitoring on Azure Websites](http://www.hanselman.com/blog/PennyPinchingInTheCloudEnablingNewRelicPerformanceMonitoringOnWindowsAzureWebsites.aspx).</span></span>
- <span data-ttu-id="33c78-305">[Azure 上大規模服務設計的最佳作法雲端服務](https://msdn.microsoft.com/library/windowsazure/jj717232.aspx)。</span><span class="sxs-lookup"><span data-stu-id="33c78-305">[Best Practices for the Design of Large-Scale Services on Azure Cloud Services](https://msdn.microsoft.com/library/windowsazure/jj717232.aspx).</span></span> <span data-ttu-id="33c78-306">以標記 Simm 和 Michael Thomassy 的技術白皮書。</span><span class="sxs-lookup"><span data-stu-id="33c78-306">White paper by Mark Simms and Michael Thomassy.</span></span> <span data-ttu-id="33c78-307">請參閱遙測和診斷一節。</span><span class="sxs-lookup"><span data-stu-id="33c78-307">See the Telemetry and Diagnostics section.</span></span>
- <span data-ttu-id="33c78-308">[Application Insights 的新一代開發](https://msdn.microsoft.com/magazine/dn683794.aspx)。</span><span class="sxs-lookup"><span data-stu-id="33c78-308">[Next-Generation Development with Application Insights](https://msdn.microsoft.com/magazine/dn683794.aspx).</span></span> <span data-ttu-id="33c78-309">MSDN 雜誌文章。</span><span class="sxs-lookup"><span data-stu-id="33c78-309">MSDN Magazine article.</span></span>

<span data-ttu-id="33c78-310">檔主要是關於記錄：</span><span class="sxs-lookup"><span data-stu-id="33c78-310">Documentation mainly about logging:</span></span>

- <span data-ttu-id="33c78-311">[語義記錄應用程式區塊（樓板）](http://convective.wordpress.com/2013/08/12/semantic-logging-application-block-slab/)。</span><span class="sxs-lookup"><span data-stu-id="33c78-311">[Semantic Logging Application Block (SLAB)](http://convective.wordpress.com/2013/08/12/semantic-logging-application-block-slab/).</span></span> <span data-ttu-id="33c78-312">Neil Mackenzie 呈現使用樓板進行語義記錄的案例。</span><span class="sxs-lookup"><span data-stu-id="33c78-312">Neil Mackenzie presents the case for semantic logging with SLAB.</span></span>
- <span data-ttu-id="33c78-313">[建立具有語義記錄的結構化且有意義的記錄](https://channel9.msdn.com/Events/Build/2013/3-336)。</span><span class="sxs-lookup"><span data-stu-id="33c78-313">[Creating Structured and Meaningful Logs with Semantic Logging](https://channel9.msdn.com/Events/Build/2013/3-336).</span></span> <span data-ttu-id="33c78-314">影片「Julian Dominguez」呈現使用樓板進行語義記錄的情況。</span><span class="sxs-lookup"><span data-stu-id="33c78-314">(Video) Julian Dominguez presents the case for semantic logging with SLAB.</span></span>
- <span data-ttu-id="33c78-315">[EF6 SQL 記錄–第1部分：簡單記錄](http://blog.oneunicorn.com/2013/05/08/ef6-sql-logging-part-1-simple-logging/)。</span><span class="sxs-lookup"><span data-stu-id="33c78-315">[EF6 SQL Logging – Part 1: Simple Logging](http://blog.oneunicorn.com/2013/05/08/ef6-sql-logging-part-1-simple-logging/).</span></span> <span data-ttu-id="33c78-316">Arthur Vickers 說明如何記錄 EF 6 中 Entity Framework 所執行的查詢。</span><span class="sxs-lookup"><span data-stu-id="33c78-316">Arthur Vickers shows how to log queries executed by Entity Framework in EF 6.</span></span>
- <span data-ttu-id="33c78-317">[在 ASP.NET MVC 應用程式中使用 Entity Framework 的連接恢復功能和命令攔截](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md)。</span><span class="sxs-lookup"><span data-stu-id="33c78-317">[Connection Resiliency and Command Interception with the Entity Framework in an ASP.NET MVC Application](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md).</span></span> <span data-ttu-id="33c78-318">第四個在9部分的教學課程系列中，示範如何使用 EF 6 命令攔截功能，透過 Entity Framework 來記錄傳送至資料庫的 SQL 命令。</span><span class="sxs-lookup"><span data-stu-id="33c78-318">Fourth in a nine-part tutorial series, shows how to use the EF 6 command interception feature to log SQL commands sent to the database by Entity Framework.</span></span>
- <span data-ttu-id="33c78-319">[使用5.0 呼叫C#端資訊屬性來改善記錄](http://www.dotnetcurry.com/showarticle.aspx?ID=972)。</span><span class="sxs-lookup"><span data-stu-id="33c78-319">[Improve Logging using C# 5.0 Caller Info Attributes](http://www.dotnetcurry.com/showarticle.aspx?ID=972).</span></span> <span data-ttu-id="33c78-320">如何輕鬆地記錄呼叫方法的名稱，而不需要將其硬式編碼成常值，或使用反映手動取得。</span><span class="sxs-lookup"><span data-stu-id="33c78-320">How to easily log the name of the calling method without hard-coding it into literals or using reflection to get it manually.</span></span>

<span data-ttu-id="33c78-321">檔主要是關於疑難排解：</span><span class="sxs-lookup"><span data-stu-id="33c78-321">Documentation mainly about troubleshooting:</span></span>

- <span data-ttu-id="33c78-322">[Azure 疑難排解 &amp; 的調試 blog](https://blogs.msdn.com/b/kwill/)。</span><span class="sxs-lookup"><span data-stu-id="33c78-322">[Azure Troubleshooting &amp; Debugging blog](https://blogs.msdn.com/b/kwill/).</span></span>
- <span data-ttu-id="33c78-323">[AzureTools – Azure 開發人員支援小組所使用的診斷公用程式](https://blogs.msdn.com/b/kwill/archive/2013/08/26/azuretools-the-diagnostic-utility-used-by-the-windows-azure-developer-support-team.aspx?Redirected=true)。</span><span class="sxs-lookup"><span data-stu-id="33c78-323">[AzureTools – The Diagnostic Utility used by the Azure Developer Support Team](https://blogs.msdn.com/b/kwill/archive/2013/08/26/azuretools-the-diagnostic-utility-used-by-the-windows-azure-developer-support-team.aspx?Redirected=true).</span></span> <span data-ttu-id="33c78-324">引進並提供工具的下載連結，可在 Azure VM 上用來下載及執行各種不同的診斷和監視工具。</span><span class="sxs-lookup"><span data-stu-id="33c78-324">Introduces and provides a download link for a tool that can be used on an Azure VM to download and run a wide variety of diagnostic and monitoring tools.</span></span> <span data-ttu-id="33c78-325">當您需要診斷特定 VM 上的問題時，很有用。</span><span class="sxs-lookup"><span data-stu-id="33c78-325">Useful when you need to diagnose an issue on a particular VM.</span></span>
- <span data-ttu-id="33c78-326">[使用 Visual Studio，針對 Azure App Service 中的 web 應用程式進行疑難排解](https://docs.microsoft.com/azure/app-service-web/web-sites-dotnet-troubleshoot-visual-studio)。</span><span class="sxs-lookup"><span data-stu-id="33c78-326">[Troubleshoot a web app in Azure App Service using Visual Studio](https://docs.microsoft.com/azure/app-service-web/web-sites-dotnet-troubleshoot-visual-studio).</span></span> <span data-ttu-id="33c78-327">開始使用 System. Diagnostics 追蹤和遠端偵錯程式的逐步教學課程。</span><span class="sxs-lookup"><span data-stu-id="33c78-327">A step-by-step tutorial for getting started with System.Diagnostics tracing and remote debugging.</span></span>

<span data-ttu-id="33c78-328">影片：</span><span class="sxs-lookup"><span data-stu-id="33c78-328">Videos:</span></span>

- <span data-ttu-id="33c78-329">[防安全功能：建立可擴充、可復原的雲端服務](https://channel9.msdn.com/Series/FailSafe)。</span><span class="sxs-lookup"><span data-stu-id="33c78-329">[FailSafe: Building Scalable, Resilient Cloud Services](https://channel9.msdn.com/Series/FailSafe).</span></span> <span data-ttu-id="33c78-330">Ulrich Homann、Marc Mercuri 和 Mark Simm 的九部分系列。</span><span class="sxs-lookup"><span data-stu-id="33c78-330">Nine-part series by Ulrich Homann, Marc Mercuri, and Mark Simms.</span></span> <span data-ttu-id="33c78-331">以非常容易存取且有趣的方式呈現高階概念和架構原則，並提供 Microsoft 客戶諮詢小組（CAT）體驗與實際客戶的故事。</span><span class="sxs-lookup"><span data-stu-id="33c78-331">Presents high-level concepts and architectural principles in a very accessible and interesting way, with stories drawn from Microsoft Customer Advisory Team (CAT) experience with actual customers.</span></span> <span data-ttu-id="33c78-332">劇集4和9是關於監視和遙測。</span><span class="sxs-lookup"><span data-stu-id="33c78-332">Episodes 4 and 9 are about monitoring and telemetry.</span></span> <span data-ttu-id="33c78-333">第9集包含監視服務 MetricsHub、AppDynamics、New New relic 和 PagerDuty 的總覽。</span><span class="sxs-lookup"><span data-stu-id="33c78-333">Episode 9 includes an overview of monitoring services MetricsHub, AppDynamics, New Relic, and PagerDuty.</span></span>
- <span data-ttu-id="33c78-334">[打造 Big：從 Azure 客戶學到的經驗-第二部](https://channel9.msdn.com/Events/Build/2012/3-030)。</span><span class="sxs-lookup"><span data-stu-id="33c78-334">[Building Big: Lessons learned from Azure customers - Part II](https://channel9.msdn.com/Events/Build/2012/3-030).</span></span> <span data-ttu-id="33c78-335">Mark Simm 討論如何設計失敗和檢測所有專案。</span><span class="sxs-lookup"><span data-stu-id="33c78-335">Mark Simms talks about designing for failure and instrumenting everything.</span></span> <span data-ttu-id="33c78-336">類似于防故障的系列，並深入探討如何詳細說明。</span><span class="sxs-lookup"><span data-stu-id="33c78-336">Similar to the Failsafe series but goes into more how-to details.</span></span>

<span data-ttu-id="33c78-337">程式碼範例：</span><span class="sxs-lookup"><span data-stu-id="33c78-337">Code sample:</span></span>

- <span data-ttu-id="33c78-338">[Azure 中的雲端服務基本](https://code.msdn.microsoft.com/Cloud-Service-Fundamentals-4ca72649)概念。</span><span class="sxs-lookup"><span data-stu-id="33c78-338">[Cloud Service Fundamentals in Azure](https://code.msdn.microsoft.com/Cloud-Service-Fundamentals-4ca72649).</span></span> <span data-ttu-id="33c78-339">Microsoft Azure 客戶諮詢小組所建立的範例應用程式。</span><span class="sxs-lookup"><span data-stu-id="33c78-339">Sample application created by the Microsoft Azure Customer Advisory Team.</span></span> <span data-ttu-id="33c78-340">示範遙測和記錄實務，如下列文章中所述。</span><span class="sxs-lookup"><span data-stu-id="33c78-340">Demonstrates both telemetry and logging practices, as explained in the following articles.</span></span> <span data-ttu-id="33c78-341">此範例會使用[NLog](http://nlog-project.org/)來執行應用程式記錄。</span><span class="sxs-lookup"><span data-stu-id="33c78-341">The sample implements application logging by using [NLog](http://nlog-project.org/).</span></span> <span data-ttu-id="33c78-342">如需相關檔，請參閱[四個關於遙測和記錄的 TechNet wiki 文章系列](https://social.technet.microsoft.com/wiki/contents/articles/17987.cloud-service-fundamentals.aspx#Telemetry_coming_soon)。</span><span class="sxs-lookup"><span data-stu-id="33c78-342">For related documentation, see the [series of four TechNet wiki articles about telemetry and logging](https://social.technet.microsoft.com/wiki/contents/articles/17987.cloud-service-fundamentals.aspx#Telemetry_coming_soon).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="33c78-343">[上一頁](design-to-survive-failures.md)
> [下一頁](transient-fault-handling.md)</span><span class="sxs-lookup"><span data-stu-id="33c78-343">[Previous](design-to-survive-failures.md)
[Next](transient-fault-handling.md)</span></span>
