---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: 將現有網站從 SQL 成員資格遷移至 ASP.NET Identity-ASP.NET 4。x
author: Rick-Anderson
description: 本教學課程說明將現有 web 應用程式與使用 SQL 成員資格建立的使用者和角色資料移轉至新 ASP.NET Identity s 的步驟 .。。
ms.author: riande
ms.date: 12/19/2014
ms.custom: seoapril2019
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 2cfab96422340acc67ebb3b11f322ae1b258575d
ms.sourcegitcommit: 6727454a30f11ac2365e1cc8a37ef0005f5d15b3
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/09/2020
ms.locfileid: "96934119"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="ead5f-103">將現有的網站從 SQL 成員資格移轉至 ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="ead5f-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>

<span data-ttu-id="ead5f-104">依 [Rick Anderson](https://twitter.com/RickAndMSFT)、 [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="ead5f-104">by [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="ead5f-105">本教學課程說明將現有 web 應用程式與使用 SQL 成員資格建立的使用者和角色資料移轉至新的 ASP.NET Identity 系統的步驟。</span><span class="sxs-lookup"><span data-stu-id="ead5f-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="ead5f-106">此方法牽涉到將現有的資料庫架構變更為 ASP.NET Identity 所需的架構，並將舊的/新類別連接到該架構。</span><span class="sxs-lookup"><span data-stu-id="ead5f-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="ead5f-107">在您採用這種方法之後，一旦遷移資料庫之後，將可輕鬆地處理未來的身分識別更新。</span><span class="sxs-lookup"><span data-stu-id="ead5f-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>

<span data-ttu-id="ead5f-108">在本教學課程中，我們將使用 Visual Studio 2010 建立的 web 應用程式範本 (Web Form) 來建立使用者和角色資料。</span><span class="sxs-lookup"><span data-stu-id="ead5f-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="ead5f-109">接著，我們將使用 SQL 腳本，將現有的資料庫移轉到身分識別系統所需的資料表。</span><span class="sxs-lookup"><span data-stu-id="ead5f-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="ead5f-110">接下來，我們將會安裝必要的 NuGet 套件，並新增使用身分識別系統進行成員資格管理的新帳戶管理頁面。</span><span class="sxs-lookup"><span data-stu-id="ead5f-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="ead5f-111">作為遷移的測試，使用 SQL 成員資格建立的使用者應該能夠登入，而新的使用者應該能夠註冊。</span><span class="sxs-lookup"><span data-stu-id="ead5f-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="ead5f-112">您可以在[這裡](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/)找到完整的範例。</span><span class="sxs-lookup"><span data-stu-id="ead5f-112">You can find the complete sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="ead5f-113">另請參閱 [從 ASP.NET 成員資格遷移至 ASP.NET Identity](https://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity/)。</span><span class="sxs-lookup"><span data-stu-id="ead5f-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](https://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity/).</span></span>

## <a name="getting-started"></a><span data-ttu-id="ead5f-114">開始使用</span><span class="sxs-lookup"><span data-stu-id="ead5f-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="ead5f-115">建立具有 SQL 成員資格的應用程式</span><span class="sxs-lookup"><span data-stu-id="ead5f-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="ead5f-116">我們需要從使用 SQL 成員資格的現有應用程式開始，並擁有使用者和角色資料。</span><span class="sxs-lookup"><span data-stu-id="ead5f-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="ead5f-117">基於本文的目的，讓我們在 Visual Studio 2010 中建立 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="ead5f-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="ead5f-118">使用 ASP.NET Configuration tool 建立2個使用者： **oldAdminUser** 和 **oldUser。**</span><span class="sxs-lookup"><span data-stu-id="ead5f-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="ead5f-119">建立名為 Admin 的角色，並將 ' oldAdminUser ' 新增為該角色中的使用者。</span><span class="sxs-lookup"><span data-stu-id="ead5f-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="ead5f-120">使用 default.aspx 建立網站的管理員區段。</span><span class="sxs-lookup"><span data-stu-id="ead5f-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="ead5f-121">將 web.config 檔案中的授權標籤設定為只允許系統管理員角色中的使用者存取。</span><span class="sxs-lookup"><span data-stu-id="ead5f-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="ead5f-122">您可以在這裡找到詳細資訊 [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="ead5f-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="ead5f-123">在伺服器總管中查看資料庫，以瞭解 SQL 成員資格系統所建立的資料表。</span><span class="sxs-lookup"><span data-stu-id="ead5f-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="ead5f-124">使用者登入資料儲存在 aspnet \_ Users 和 aspnet \_ 成員資格資料表中，而角色資料則儲存在 aspnet \_ Roles 資料表中。</span><span class="sxs-lookup"><span data-stu-id="ead5f-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="ead5f-125">哪些使用者是哪些角色儲存在 aspnet UsersInRoles 資料表中的相關資訊 \_ 。</span><span class="sxs-lookup"><span data-stu-id="ead5f-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="ead5f-126">針對基本的成員資格管理，將上述表格中的資訊移植到 ASP.NET Identity 系統就已足夠。</span><span class="sxs-lookup"><span data-stu-id="ead5f-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="ead5f-127">遷移至 Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="ead5f-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="ead5f-128">安裝適用于 Web 或 Visual Studio 2013 的 Visual Studio Express 2013，以及 [最新的更新](https://www.microsoft.com/download/details.aspx?id=44921)。</span><span class="sxs-lookup"><span data-stu-id="ead5f-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="ead5f-129">在安裝的 Visual Studio 版本中開啟上述專案。</span><span class="sxs-lookup"><span data-stu-id="ead5f-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="ead5f-130">如果電腦上未安裝 SQL Server Express，當您開啟專案時，就會出現提示，因為連接字串會使用 SQL Express。</span><span class="sxs-lookup"><span data-stu-id="ead5f-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="ead5f-131">您可以選擇安裝 SQL Express 或作為解決方法，將連接字串變更為 LocalDb。</span><span class="sxs-lookup"><span data-stu-id="ead5f-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="ead5f-132">在本文中，我們會將它變更為 LocalDb。</span><span class="sxs-lookup"><span data-stu-id="ead5f-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="ead5f-133">開啟 web.config 並從變更連接字串。SQLExpress 來 (LocalDb) v 11.0。</span><span class="sxs-lookup"><span data-stu-id="ead5f-133">Open web.config and change the connection string from .SQLExpress to (LocalDb)v11.0.</span></span> <span data-ttu-id="ead5f-134">從連接字串中移除 ' User Instance = true '。</span><span class="sxs-lookup"><span data-stu-id="ead5f-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="ead5f-135">開啟伺服器總管，並確認可以觀察資料表架構和資料。</span><span class="sxs-lookup"><span data-stu-id="ead5f-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="ead5f-136">ASP.NET Identity 系統適用于版本4.5 或更高版本的架構。</span><span class="sxs-lookup"><span data-stu-id="ead5f-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="ead5f-137">將應用程式的目標重定為4.5 或更高版本。</span><span class="sxs-lookup"><span data-stu-id="ead5f-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="ead5f-138">建立專案以確認沒有任何錯誤。</span><span class="sxs-lookup"><span data-stu-id="ead5f-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="ead5f-139">安裝 Nuget 套件</span><span class="sxs-lookup"><span data-stu-id="ead5f-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="ead5f-140">在方案總管中，以滑鼠右鍵按一下 [ &gt; **管理 NuGet 套件**] 專案。</span><span class="sxs-lookup"><span data-stu-id="ead5f-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="ead5f-141">在搜尋方塊中，輸入「Asp.net Identity」。</span><span class="sxs-lookup"><span data-stu-id="ead5f-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="ead5f-142">在結果清單中選取封裝，然後按一下 [安裝]。</span><span class="sxs-lookup"><span data-stu-id="ead5f-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="ead5f-143">按一下 [我接受] 按鈕，接受授權合約。</span><span class="sxs-lookup"><span data-stu-id="ead5f-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="ead5f-144">請注意，此套件將會安裝相依性套件： EntityFramework 和 Microsoft ASP.NET 身分識別核心。</span><span class="sxs-lookup"><span data-stu-id="ead5f-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="ead5f-145">同樣地，如果您不想要啟用 OAuth 登入) ，請安裝下列套件 (略過最後4個 OWIN 套件：</span><span class="sxs-lookup"><span data-stu-id="ead5f-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

   - <span data-ttu-id="ead5f-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="ead5f-146">Microsoft.AspNet.Identity.Owin</span></span>
   - <span data-ttu-id="ead5f-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="ead5f-147">Microsoft.Owin.Host.SystemWeb</span></span>
   - <span data-ttu-id="ead5f-148">Owin。</span><span class="sxs-lookup"><span data-stu-id="ead5f-148">Microsoft.Owin.Security.Facebook</span></span>
   - <span data-ttu-id="ead5f-149">Owin，Google</span><span class="sxs-lookup"><span data-stu-id="ead5f-149">Microsoft.Owin.Security.Google</span></span>
   - <span data-ttu-id="ead5f-150">Owin. MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="ead5f-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
   - <span data-ttu-id="ead5f-151">Owin. 安全性 Twitter</span><span class="sxs-lookup"><span data-stu-id="ead5f-151">Microsoft.Owin.Security.Twitter</span></span>

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="ead5f-152">將資料庫移轉至新的身分識別系統</span><span class="sxs-lookup"><span data-stu-id="ead5f-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="ead5f-153">下一步是要將現有的資料庫移轉至 ASP.NET Identity 系統所需的架構。</span><span class="sxs-lookup"><span data-stu-id="ead5f-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="ead5f-154">為了達成此目的，我們會執行 SQL 腳本，其中包含一組命令來建立新的資料表，並將現有的使用者資訊遷移至新的資料表。</span><span class="sxs-lookup"><span data-stu-id="ead5f-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="ead5f-155">您可以在 [這裡](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql)找到腳本檔。</span><span class="sxs-lookup"><span data-stu-id="ead5f-155">The script file can be found [here](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="ead5f-156">此腳本檔是此範例特有的。</span><span class="sxs-lookup"><span data-stu-id="ead5f-156">This script file is specific to this sample.</span></span> <span data-ttu-id="ead5f-157">如果已自訂或修改使用 SQL 成員資格建立之資料表的架構，則必須據以變更腳本。</span><span class="sxs-lookup"><span data-stu-id="ead5f-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="ead5f-158">如何產生用於架構遷移的 SQL 腳本</span><span class="sxs-lookup"><span data-stu-id="ead5f-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="ead5f-159">若要讓 ASP.NET Identity 類別與現有使用者的資料一起運作，我們需要將資料庫架構遷移到 ASP.NET Identity 所需的架構。</span><span class="sxs-lookup"><span data-stu-id="ead5f-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="ead5f-160">我們可以藉由加入新的資料表，並將現有的資訊複製到這些資料表來完成這項作業。</span><span class="sxs-lookup"><span data-stu-id="ead5f-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="ead5f-161">根據預設，ASP.NET Identity 會使用 EntityFramework 將身分識別模型類別對應回資料庫，以儲存/取出資訊。</span><span class="sxs-lookup"><span data-stu-id="ead5f-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="ead5f-162">這些模型類別會執行定義使用者和角色物件的核心身分識別介面。</span><span class="sxs-lookup"><span data-stu-id="ead5f-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="ead5f-163">資料庫中的資料表和資料行是以這些模型類別為基礎。</span><span class="sxs-lookup"><span data-stu-id="ead5f-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="ead5f-164">Identity v 2.1.0 中的 EntityFramework 模型類別及其屬性如下所定義</span><span class="sxs-lookup"><span data-stu-id="ead5f-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="ead5f-165">**IdentityUser**</span><span class="sxs-lookup"><span data-stu-id="ead5f-165">**IdentityUser**</span></span> | <span data-ttu-id="ead5f-166">**類型**</span><span class="sxs-lookup"><span data-stu-id="ead5f-166">**Type**</span></span> | <span data-ttu-id="ead5f-167">**IdentityRole**</span><span class="sxs-lookup"><span data-stu-id="ead5f-167">**IdentityRole**</span></span> | <span data-ttu-id="ead5f-168">**IdentityUserRole**</span><span class="sxs-lookup"><span data-stu-id="ead5f-168">**IdentityUserRole**</span></span> | <span data-ttu-id="ead5f-169">**IdentityUserLogin**</span><span class="sxs-lookup"><span data-stu-id="ead5f-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="ead5f-170">**IdentityUserClaim**</span><span class="sxs-lookup"><span data-stu-id="ead5f-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="ead5f-171">識別碼</span><span class="sxs-lookup"><span data-stu-id="ead5f-171">Id</span></span> | <span data-ttu-id="ead5f-172">字串</span><span class="sxs-lookup"><span data-stu-id="ead5f-172">string</span></span> | <span data-ttu-id="ead5f-173">識別碼</span><span class="sxs-lookup"><span data-stu-id="ead5f-173">Id</span></span> | <span data-ttu-id="ead5f-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="ead5f-174">RoleId</span></span> | <span data-ttu-id="ead5f-175">ProviderKey</span><span class="sxs-lookup"><span data-stu-id="ead5f-175">ProviderKey</span></span> | <span data-ttu-id="ead5f-176">識別碼</span><span class="sxs-lookup"><span data-stu-id="ead5f-176">Id</span></span> |
| <span data-ttu-id="ead5f-177">使用者名稱</span><span class="sxs-lookup"><span data-stu-id="ead5f-177">Username</span></span> | <span data-ttu-id="ead5f-178">字串</span><span class="sxs-lookup"><span data-stu-id="ead5f-178">string</span></span> | <span data-ttu-id="ead5f-179">名稱</span><span class="sxs-lookup"><span data-stu-id="ead5f-179">Name</span></span> | <span data-ttu-id="ead5f-180">UserId</span><span class="sxs-lookup"><span data-stu-id="ead5f-180">UserId</span></span> | <span data-ttu-id="ead5f-181">UserId</span><span class="sxs-lookup"><span data-stu-id="ead5f-181">UserId</span></span> | <span data-ttu-id="ead5f-182">ClaimType</span><span class="sxs-lookup"><span data-stu-id="ead5f-182">ClaimType</span></span> |
| <span data-ttu-id="ead5f-183">PasswordHash</span><span class="sxs-lookup"><span data-stu-id="ead5f-183">PasswordHash</span></span> | <span data-ttu-id="ead5f-184">字串</span><span class="sxs-lookup"><span data-stu-id="ead5f-184">string</span></span> |  |  | <span data-ttu-id="ead5f-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="ead5f-185">LoginProvider</span></span> | <span data-ttu-id="ead5f-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="ead5f-186">ClaimValue</span></span> |
| <span data-ttu-id="ead5f-187">SecurityStamp</span><span class="sxs-lookup"><span data-stu-id="ead5f-187">SecurityStamp</span></span> | <span data-ttu-id="ead5f-188">字串</span><span class="sxs-lookup"><span data-stu-id="ead5f-188">string</span></span> |  |  |  | <span data-ttu-id="ead5f-189">使用者 \_ 識別碼</span><span class="sxs-lookup"><span data-stu-id="ead5f-189">User\_Id</span></span> |
| <span data-ttu-id="ead5f-190">電子郵件</span><span class="sxs-lookup"><span data-stu-id="ead5f-190">Email</span></span> | <span data-ttu-id="ead5f-191">字串</span><span class="sxs-lookup"><span data-stu-id="ead5f-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="ead5f-192">EmailConfirmed</span><span class="sxs-lookup"><span data-stu-id="ead5f-192">EmailConfirmed</span></span> | <span data-ttu-id="ead5f-193">bool</span><span class="sxs-lookup"><span data-stu-id="ead5f-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="ead5f-194">PhoneNumber</span><span class="sxs-lookup"><span data-stu-id="ead5f-194">PhoneNumber</span></span> | <span data-ttu-id="ead5f-195">字串</span><span class="sxs-lookup"><span data-stu-id="ead5f-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="ead5f-196">PhoneNumberConfirmed</span><span class="sxs-lookup"><span data-stu-id="ead5f-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="ead5f-197">bool</span><span class="sxs-lookup"><span data-stu-id="ead5f-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="ead5f-198">LockoutEnabled</span><span class="sxs-lookup"><span data-stu-id="ead5f-198">LockoutEnabled</span></span> | <span data-ttu-id="ead5f-199">bool</span><span class="sxs-lookup"><span data-stu-id="ead5f-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="ead5f-200">LockoutEndDate</span><span class="sxs-lookup"><span data-stu-id="ead5f-200">LockoutEndDate</span></span> | <span data-ttu-id="ead5f-201">Datetime</span><span class="sxs-lookup"><span data-stu-id="ead5f-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="ead5f-202">AccessFailedCount</span><span class="sxs-lookup"><span data-stu-id="ead5f-202">AccessFailedCount</span></span> | <span data-ttu-id="ead5f-203">int</span><span class="sxs-lookup"><span data-stu-id="ead5f-203">int</span></span> |  |  |  |  |

<span data-ttu-id="ead5f-204">每個模型都必須有對應至屬性之資料行的資料表。</span><span class="sxs-lookup"><span data-stu-id="ead5f-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="ead5f-205">類別和資料表之間的對應是在的方法中定義 `OnModelCreating` `IdentityDBContext` 。</span><span class="sxs-lookup"><span data-stu-id="ead5f-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="ead5f-206">這就是所謂的流暢 API 方法，您可以在 [這裡](https://msdn.microsoft.com/data/jj591617.aspx)找到更多詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="ead5f-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/data/jj591617.aspx).</span></span> <span data-ttu-id="ead5f-207">類別的設定如下所述</span><span class="sxs-lookup"><span data-stu-id="ead5f-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="ead5f-208">**類別**</span><span class="sxs-lookup"><span data-stu-id="ead5f-208">**Class**</span></span> | <span data-ttu-id="ead5f-209">**資料表**</span><span class="sxs-lookup"><span data-stu-id="ead5f-209">**Table**</span></span> | <span data-ttu-id="ead5f-210">**主要金鑰**</span><span class="sxs-lookup"><span data-stu-id="ead5f-210">**Primary key**</span></span> | <span data-ttu-id="ead5f-211">**外鍵**</span><span class="sxs-lookup"><span data-stu-id="ead5f-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="ead5f-212">IdentityUser</span><span class="sxs-lookup"><span data-stu-id="ead5f-212">IdentityUser</span></span> | <span data-ttu-id="ead5f-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="ead5f-213">AspnetUsers</span></span> | <span data-ttu-id="ead5f-214">識別碼</span><span class="sxs-lookup"><span data-stu-id="ead5f-214">Id</span></span> |  |
| <span data-ttu-id="ead5f-215">IdentityRole</span><span class="sxs-lookup"><span data-stu-id="ead5f-215">IdentityRole</span></span> | <span data-ttu-id="ead5f-216">AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="ead5f-216">AspnetRoles</span></span> | <span data-ttu-id="ead5f-217">識別碼</span><span class="sxs-lookup"><span data-stu-id="ead5f-217">Id</span></span> |  |
| <span data-ttu-id="ead5f-218">IdentityUserRole</span><span class="sxs-lookup"><span data-stu-id="ead5f-218">IdentityUserRole</span></span> | <span data-ttu-id="ead5f-219">AspnetUserRole</span><span class="sxs-lookup"><span data-stu-id="ead5f-219">AspnetUserRole</span></span> | <span data-ttu-id="ead5f-220">UserId + RoleId</span><span class="sxs-lookup"><span data-stu-id="ead5f-220">UserId + RoleId</span></span> | <span data-ttu-id="ead5f-221">使用者 \_ 識別碼- &gt; AspnetUsers RoleId- &gt; AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="ead5f-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="ead5f-222">IdentityUserLogin</span><span class="sxs-lookup"><span data-stu-id="ead5f-222">IdentityUserLogin</span></span> | <span data-ttu-id="ead5f-223">AspnetUserLogins</span><span class="sxs-lookup"><span data-stu-id="ead5f-223">AspnetUserLogins</span></span> | <span data-ttu-id="ead5f-224">ProviderKey + UserId + LoginProvider</span><span class="sxs-lookup"><span data-stu-id="ead5f-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="ead5f-225">UserId- &gt; AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="ead5f-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="ead5f-226">IdentityUserClaim</span><span class="sxs-lookup"><span data-stu-id="ead5f-226">IdentityUserClaim</span></span> | <span data-ttu-id="ead5f-227">AspnetUserClaims</span><span class="sxs-lookup"><span data-stu-id="ead5f-227">AspnetUserClaims</span></span> | <span data-ttu-id="ead5f-228">識別碼</span><span class="sxs-lookup"><span data-stu-id="ead5f-228">Id</span></span> | <span data-ttu-id="ead5f-229">使用者 \_ 識別碼- &gt; AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="ead5f-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="ead5f-230">有了此資訊，我們就可以建立 SQL 語句來建立新的資料表。</span><span class="sxs-lookup"><span data-stu-id="ead5f-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="ead5f-231">我們可以個別撰寫每個語句，也可以使用 EntityFramework PowerShell 命令來產生整個腳本，然後再視需要進行編輯。</span><span class="sxs-lookup"><span data-stu-id="ead5f-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="ead5f-232">若要這樣做，請在 VS 中，從 [ **View** ] 或 [ **Tools** ] 功能表開啟 **封裝管理員主控台**</span><span class="sxs-lookup"><span data-stu-id="ead5f-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="ead5f-233">執行「啟用-遷移」命令以啟用 EntityFramework 遷移。</span><span class="sxs-lookup"><span data-stu-id="ead5f-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="ead5f-234">執行「新增-遷移初始」命令，其會建立初始安裝程式碼以在 c # 中建立資料庫/VB。</span><span class="sxs-lookup"><span data-stu-id="ead5f-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="ead5f-235">最後一個步驟是執行 "Update-Database – Script" 命令，此命令會根據模型類別產生 SQL 腳本。</span><span class="sxs-lookup"><span data-stu-id="ead5f-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

<span data-ttu-id="ead5f-236">您可以使用這個資料庫產生腳本做為起點，我們將會進行額外的變更，以加入新的資料行及複製資料。</span><span class="sxs-lookup"><span data-stu-id="ead5f-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="ead5f-237">這項功能的優點是，我們會產生 `_MigrationHistory` 資料表，讓 EntityFramework 在未來版本的身分識別版本變更時，修改資料庫架構。</span><span class="sxs-lookup"><span data-stu-id="ead5f-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span>

<span data-ttu-id="ead5f-238">除了身分識別使用者模型類別中的其他屬性以外，SQL 成員資格使用者資訊還有其他屬性，也就是電子郵件、密碼嘗試、上次登入日期、上次鎖定的日期等。這是很有用的資訊，我們想要將它傳送到身分識別系統。</span><span class="sxs-lookup"><span data-stu-id="ead5f-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="ead5f-239">將其他屬性加入至使用者模型，然後將它們對應回資料庫中的資料表資料行，即可完成這項工作。</span><span class="sxs-lookup"><span data-stu-id="ead5f-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="ead5f-240">我們可以加入子類別化模型的類別來完成這項作業 `IdentityUser` 。</span><span class="sxs-lookup"><span data-stu-id="ead5f-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="ead5f-241">我們可以將屬性新增至這個自訂類別，並編輯 SQL 腳本，以便在建立資料表時加入對應的資料行。</span><span class="sxs-lookup"><span data-stu-id="ead5f-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="ead5f-242">此類別的程式碼會在文章中進一步說明。</span><span class="sxs-lookup"><span data-stu-id="ead5f-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="ead5f-243">`AspnetUsers`加入新屬性之後，用來建立資料表的 SQL 腳本是</span><span class="sxs-lookup"><span data-stu-id="ead5f-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="ead5f-244">接下來，我們需要將 SQL 成員資格資料庫中現有的資訊複製到新加入的資料表以進行識別。</span><span class="sxs-lookup"><span data-stu-id="ead5f-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="ead5f-245">這可以透過 SQL 直接將資料從一個資料表複製到另一個資料表來完成。</span><span class="sxs-lookup"><span data-stu-id="ead5f-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="ead5f-246">為了將資料加入資料表的資料列中，我們會使用 `INSERT INTO [Table]` 結構。</span><span class="sxs-lookup"><span data-stu-id="ead5f-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="ead5f-247">若要從另一個資料表複製，我們可以 `INSERT INTO` 搭配語句使用語句 `SELECT` 。</span><span class="sxs-lookup"><span data-stu-id="ead5f-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="ead5f-248">若要取得所有使用者資訊，我們需要查詢 *aspnet \_ 使用者* 和 *aspnet \_ 成員資格* 資料表，然後將資料複製到 *AspNetUsers* 資料表。</span><span class="sxs-lookup"><span data-stu-id="ead5f-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="ead5f-249">我們使用 `INSERT INTO` 和 `SELECT` 搭配 `JOIN` 和 `LEFT OUTER JOIN` 語句。</span><span class="sxs-lookup"><span data-stu-id="ead5f-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="ead5f-250">如需有關在資料表之間查詢和複製資料的詳細資訊，請參閱 [此](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) 連結。</span><span class="sxs-lookup"><span data-stu-id="ead5f-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="ead5f-251">此外，AspnetUserLogins 和 AspnetUserClaims 資料表的開頭都是空的，因為 SQL 成員資格中預設不會對應到此資訊。</span><span class="sxs-lookup"><span data-stu-id="ead5f-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="ead5f-252">唯一複製的資訊是針對使用者和角色。</span><span class="sxs-lookup"><span data-stu-id="ead5f-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="ead5f-253">針對在先前步驟中建立的專案，將資訊複製到 users 資料表的 SQL 查詢會是</span><span class="sxs-lookup"><span data-stu-id="ead5f-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="ead5f-254">在上述 SQL 語句中，會將來自 *aspnet \_ Users* 和 *aspnet \_ 成員資格* 資料表之每個使用者的相關資訊複製到 *AspnetUsers* 資料表的資料行中。</span><span class="sxs-lookup"><span data-stu-id="ead5f-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="ead5f-255">此處唯一進行的修改是複製密碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="ead5f-256">因為 SQL 成員資格中的密碼加密演算法使用 ' PasswordSalt ' 和 ' PasswordFormat '，所以我們也會連同雜湊密碼一起複製，以便用來依身分識別來解密密碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="ead5f-257">這在連結自訂密碼 hasher 時，會在文章中進一步說明。</span><span class="sxs-lookup"><span data-stu-id="ead5f-257">This is explained further in the article when hooking up a custom password hasher.</span></span>

<span data-ttu-id="ead5f-258">此腳本檔是此範例特有的。</span><span class="sxs-lookup"><span data-stu-id="ead5f-258">This script file is specific to this sample.</span></span> <span data-ttu-id="ead5f-259">對於具有其他資料表的應用程式，開發人員可以遵循類似的方法，在使用者模型類別上加入其他屬性，並將其對應至 AspnetUsers 資料表中的資料行。</span><span class="sxs-lookup"><span data-stu-id="ead5f-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="ead5f-260">若要執行腳本，</span><span class="sxs-lookup"><span data-stu-id="ead5f-260">To run the script,</span></span>

1. <span data-ttu-id="ead5f-261">開啟 [伺服器總管]。</span><span class="sxs-lookup"><span data-stu-id="ead5f-261">Open Server Explorer.</span></span> <span data-ttu-id="ead5f-262">展開 [>iapplicationbuilder.applicationservices] 連接以顯示資料表。</span><span class="sxs-lookup"><span data-stu-id="ead5f-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="ead5f-263">以滑鼠右鍵按一下 [資料表] 節點，然後選取 [新增查詢] 選項</span><span class="sxs-lookup"><span data-stu-id="ead5f-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="ead5f-264">在查詢視窗中，複製並貼上從遷移 .sql 檔案中的整個 SQL 腳本。</span><span class="sxs-lookup"><span data-stu-id="ead5f-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="ead5f-265">藉由按下 [執行] 箭號按鈕來執行腳本檔案。</span><span class="sxs-lookup"><span data-stu-id="ead5f-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="ead5f-266">重新整理伺服器總管視窗。</span><span class="sxs-lookup"><span data-stu-id="ead5f-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="ead5f-267">系統會在資料庫中建立五個新的資料表。</span><span class="sxs-lookup"><span data-stu-id="ead5f-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="ead5f-268">以下是 SQL 成員資格資料表中資訊對應至新身分識別系統的方式。</span><span class="sxs-lookup"><span data-stu-id="ead5f-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="ead5f-269">aspnet \_ 角色-- &gt; AspNetRoles</span><span class="sxs-lookup"><span data-stu-id="ead5f-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="ead5f-270">asp \_ netUsers 和 asp \_ netMembership-- &gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="ead5f-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="ead5f-271">aspnet \_ UserInRoles-- &gt; AspNetUserRoles</span><span class="sxs-lookup"><span data-stu-id="ead5f-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="ead5f-272">如上一節所述，AspNetUserClaims 和 AspNetUserLogins 資料表是空的。</span><span class="sxs-lookup"><span data-stu-id="ead5f-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="ead5f-273">AspNetUser 資料表中的 ' 鑒別子欄位應與定義為下一個步驟的模型類別名稱相符。</span><span class="sxs-lookup"><span data-stu-id="ead5f-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="ead5f-274">此外，PasswordHash 資料行的格式為「加密密碼 | 密碼 salt | 密碼格式」。</span><span class="sxs-lookup"><span data-stu-id="ead5f-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="ead5f-275">這可讓您使用特殊的 SQL 成員資格加密邏輯，讓您可以重複使用舊密碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="ead5f-276">本文稍後將會說明。</span><span class="sxs-lookup"><span data-stu-id="ead5f-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="ead5f-277">建立模型和成員資格頁面</span><span class="sxs-lookup"><span data-stu-id="ead5f-277">Creating models and membership pages</span></span>

<span data-ttu-id="ead5f-278">如先前所述，根據預設，識別功能會使用 Entity Framework 來與資料庫通訊，以儲存帳戶資訊。</span><span class="sxs-lookup"><span data-stu-id="ead5f-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="ead5f-279">若要使用資料表中的現有資料，我們需要建立對應回資料表的模型類別，然後在身分識別系統中連結它們。</span><span class="sxs-lookup"><span data-stu-id="ead5f-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="ead5f-280">作為身分識別合約的一部分，模型類別應該執行在 Identity. 核心 dll 中定義的介面，或者可以擴充 EntityFramework 中可用的這些介面的現有實作為。</span><span class="sxs-lookup"><span data-stu-id="ead5f-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="ead5f-281">在我們的範例中，AspNetRoles、AspNetUserClaims、AspNetLogins 和 AspNetUserRole 資料表的資料行，類似于現有的身分識別系統執行。</span><span class="sxs-lookup"><span data-stu-id="ead5f-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="ead5f-282">因此，我們可以重複使用現有的類別來對應至這些資料表。</span><span class="sxs-lookup"><span data-stu-id="ead5f-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="ead5f-283">AspNetUser 資料表有一些額外的資料行，可用來儲存 SQL 成員資格資料表中的其他資訊。</span><span class="sxs-lookup"><span data-stu-id="ead5f-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="ead5f-284">這可以藉由建立模型類別來對應，以擴充現有的 ' IdentityUser ' 實作為，並新增其他屬性。</span><span class="sxs-lookup"><span data-stu-id="ead5f-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="ead5f-285">在專案中建立 [模型] 資料夾，並加入類別使用者。</span><span class="sxs-lookup"><span data-stu-id="ead5f-285">Create a Models folder in the project and add a class User.</span></span> <span data-ttu-id="ead5f-286">類別的名稱應該符合 ' AspnetUsers ' 資料表的 ' 鑒別子資料行中新增的資料。</span><span class="sxs-lookup"><span data-stu-id="ead5f-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="ead5f-287">User 類別應擴充在 *EntityFramework* dll 中找到的 IdentityUser 類別。</span><span class="sxs-lookup"><span data-stu-id="ead5f-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="ead5f-288">宣告對應回 AspNetUser 資料行之類別中的屬性。</span><span class="sxs-lookup"><span data-stu-id="ead5f-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="ead5f-289">屬性 ID、Username、PasswordHash 和 SecurityStamp 是在 IdentityUser 中定義，因此會省略。</span><span class="sxs-lookup"><span data-stu-id="ead5f-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="ead5f-290">以下是具有所有屬性之使用者類別的程式碼</span><span class="sxs-lookup"><span data-stu-id="ead5f-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="ead5f-291">需要 Entity Framework DbCoNtext 類別，才能將模型中的資料保存回資料表，並從資料表中取出資料以填入模型。</span><span class="sxs-lookup"><span data-stu-id="ead5f-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="ead5f-292">*EntityFramework* Dll 定義 IdentityDbCoNtext 類別，它會與識別資料表互動以取得和儲存資訊。</span><span class="sxs-lookup"><span data-stu-id="ead5f-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="ead5f-293">IdentityDbCoNtext &lt; tuser 採用的是 &gt; 可延伸 IdentityUser 類別的任何類別的 ' tuser ' 類別。</span><span class="sxs-lookup"><span data-stu-id="ead5f-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="ead5f-294">建立新的類別 [ApplicationdbcoNtext，以擴充在 [模型] 資料夾下的 IdentityDbCoNtext，以在步驟1中建立的「使用者」類別傳遞</span><span class="sxs-lookup"><span data-stu-id="ead5f-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="ead5f-295">新身分識別系統中的使用者管理，是使用 &lt; &gt; *EntityFramework* Dll 中定義的 UserManager tuser 類別來完成。</span><span class="sxs-lookup"><span data-stu-id="ead5f-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="ead5f-296">我們需要建立擴充 UserManager 的自訂類別，並傳入在步驟1中建立的「使用者」類別。</span><span class="sxs-lookup"><span data-stu-id="ead5f-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="ead5f-297">在 [模型] 資料夾中，建立擴充 UserManager 使用者的新類別 UserManager &lt;&gt;</span><span class="sxs-lookup"><span data-stu-id="ead5f-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="ead5f-298">應用程式使用者的密碼會經過加密，並儲存在資料庫中。</span><span class="sxs-lookup"><span data-stu-id="ead5f-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="ead5f-299">SQL 成員資格中使用的密碼編譯演算法與新的身分識別系統中的加密演算法不同。</span><span class="sxs-lookup"><span data-stu-id="ead5f-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="ead5f-300">若要重複使用舊密碼，我們需要在舊使用者使用 SQL 成員資格演算法登入時，選擇性地解密密碼，同時在新使用者的身分識別中使用加密演算法。</span><span class="sxs-lookup"><span data-stu-id="ead5f-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="ead5f-301">UserManager 類別具有屬性 ' 並且 '，其會儲存實作為 ' IPasswordHasher ' 介面之類別的實例。</span><span class="sxs-lookup"><span data-stu-id="ead5f-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="ead5f-302">這是用來在使用者驗證交易期間加密/解密密碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="ead5f-303">在步驟3中定義的 UserManager 類別中，建立新的類別 SQLPasswordHasher，然後複製下列程式碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="ead5f-304">匯入 system.string 和 system.string 命名空間，以解決編譯錯誤。</span><span class="sxs-lookup"><span data-stu-id="ead5f-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="ead5f-305">EncodePassword 方法會根據預設的 SQL 成員資格加密執行來加密密碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="ead5f-306">這是取自 System.object dll。</span><span class="sxs-lookup"><span data-stu-id="ead5f-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="ead5f-307">如果舊的應用程式使用自訂的執行，則應該反映在此。</span><span class="sxs-lookup"><span data-stu-id="ead5f-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="ead5f-308">我們需要定義兩個其他方法 *HashPassword* 和 *VerifyHashedPassword* ，以使用 *EncodePassword* 方法來雜湊指定的密碼，或使用資料庫中現有的密碼來驗證純文字密碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="ead5f-309">SQL 成員資格系統使用 PasswordHash、PasswordSalt 和 PasswordFormat 來雜湊使用者在註冊或變更其密碼時所輸入的密碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="ead5f-310">在遷移期間，會將三個欄位儲存在 AspNetUser 資料表的 PasswordHash 資料行中，並以 ' | ' 字元分隔。</span><span class="sxs-lookup"><span data-stu-id="ead5f-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="ead5f-311">當使用者登入，且密碼具有這些欄位時，我們會使用 SQL 成員資格加密來檢查密碼;否則，我們會使用身分識別系統的預設加密來驗證密碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="ead5f-312">如此一來，舊的使用者就不需要在應用程式遷移之後變更其密碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="ead5f-313">宣告 UserManager 類別的函式，並將其以 SQLPasswordHasher 形式傳遞至函式中的屬性。</span><span class="sxs-lookup"><span data-stu-id="ead5f-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="ead5f-314">建立新的帳戶管理頁面</span><span class="sxs-lookup"><span data-stu-id="ead5f-314">Create new account management pages</span></span>

<span data-ttu-id="ead5f-315">遷移的下一個步驟是新增帳戶管理頁面，讓使用者註冊並登入。</span><span class="sxs-lookup"><span data-stu-id="ead5f-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="ead5f-316">SQL 成員資格的舊帳戶頁面會使用無法與新的身分識別系統搭配使用的控制項。</span><span class="sxs-lookup"><span data-stu-id="ead5f-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="ead5f-317">若要加入新的使用者管理頁面，請遵循此連結的教學課程， [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) 從「新增 Web Form 以便將使用者註冊至您的應用程式」步驟開始，因為我們已建立專案並新增 NuGet 套件。</span><span class="sxs-lookup"><span data-stu-id="ead5f-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="ead5f-318">我們需要對範例進行一些變更，才能使用我們在此提供的專案。</span><span class="sxs-lookup"><span data-stu-id="ead5f-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="ead5f-319">Register.aspx.cs 和 Login.aspx.cs 程式碼後方類別會使用 `UserManager` 來自身分識別套件的來建立使用者。</span><span class="sxs-lookup"><span data-stu-id="ead5f-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="ead5f-320">在此範例中，請遵循稍早所述的步驟，使用 [模型] 資料夾中加入的 UserManager。</span><span class="sxs-lookup"><span data-stu-id="ead5f-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="ead5f-321">使用已建立的使用者類別，而不是 Register.aspx.cs 和 Login.aspx.cs 程式碼後置於類別中的 IdentityUser。</span><span class="sxs-lookup"><span data-stu-id="ead5f-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="ead5f-322">這會在我們的自訂使用者類別中攔截到身分識別系統。</span><span class="sxs-lookup"><span data-stu-id="ead5f-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="ead5f-323">您可以略過建立資料庫的部分。</span><span class="sxs-lookup"><span data-stu-id="ead5f-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="ead5f-324">開發人員必須為新的使用者設定 ApplicationId，以符合目前的應用程式識別碼。</span><span class="sxs-lookup"><span data-stu-id="ead5f-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="ead5f-325">這可以藉由在 Register.aspx.cs 類別中建立使用者物件之前先查詢此應用程式的 ApplicationId 來完成，並在建立使用者之前進行設定。</span><span class="sxs-lookup"><span data-stu-id="ead5f-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span>

    <span data-ttu-id="ead5f-326">範例：</span><span class="sxs-lookup"><span data-stu-id="ead5f-326">Example:</span></span>

    <span data-ttu-id="ead5f-327">在 [Register.aspx.cs] 頁面中定義方法來查詢 aspnet \_ 應用程式資料表，並根據應用程式名稱取得應用程式識別碼</span><span class="sxs-lookup"><span data-stu-id="ead5f-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="ead5f-328">現在在使用者物件上設定此設定</span><span class="sxs-lookup"><span data-stu-id="ead5f-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="ead5f-329">使用舊的使用者名稱和密碼來登入現有的使用者。</span><span class="sxs-lookup"><span data-stu-id="ead5f-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="ead5f-330">使用 [註冊] 頁面來建立新的使用者。</span><span class="sxs-lookup"><span data-stu-id="ead5f-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="ead5f-331">也請確認使用者是否符合預期的角色。</span><span class="sxs-lookup"><span data-stu-id="ead5f-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="ead5f-332">移植到身分識別系統可協助使用者將 Open Authentication (OAuth) 新增至應用程式。</span><span class="sxs-lookup"><span data-stu-id="ead5f-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="ead5f-333">請參閱 [這裡](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) 已啟用 OAuth 的範例。</span><span class="sxs-lookup"><span data-stu-id="ead5f-333">Please refer to the sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="ead5f-334">後續步驟</span><span class="sxs-lookup"><span data-stu-id="ead5f-334">Next Steps</span></span>

<span data-ttu-id="ead5f-335">在本教學課程中，我們示範了如何將 SQL 成員資格的使用者移植到 ASP.NET Identity，但我們並未移植設定檔資料。</span><span class="sxs-lookup"><span data-stu-id="ead5f-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="ead5f-336">在下一個教學課程中，我們將探討如何將 SQL 成員資格的設定檔資料移植至新的身分識別系統。</span><span class="sxs-lookup"><span data-stu-id="ead5f-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="ead5f-337">您可以在本文底部留下意見反應。</span><span class="sxs-lookup"><span data-stu-id="ead5f-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="ead5f-338">*感謝 Tom Dykstra 和 Rick Anderson，以複習文章。*</span><span class="sxs-lookup"><span data-stu-id="ead5f-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
