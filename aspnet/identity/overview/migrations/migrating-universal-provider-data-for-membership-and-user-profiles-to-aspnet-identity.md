---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: 成員資格和使用者設定檔，以 ASP.NET 身分識別移轉通用提供者資料 (C#)-ASP.NET 4.x
author: rustd
description: 本教學課程將告訴您需要移轉使用者和角色的資料，以及使用現有的應用程式的通用提供者所建立的使用者設定檔資料的步驟...
ms.author: riande
ms.date: 12/13/2013
ms.custom: seoapril2019
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: de154dde122886976054159ad745982669ca9315
ms.sourcegitcommit: 51b01b6ff8edde57d8243e4da28c9f1e7f1962b2
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 05/06/2019
ms.locfileid: "65121378"
---
# <a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a><span data-ttu-id="69f48-103">將成員資格和使用者設定檔的通用提供者資料移轉至 ASP.NET Identity (C#)</span><span class="sxs-lookup"><span data-stu-id="69f48-103">Migrating Universal Provider Data for Membership and User Profiles to ASP.NET Identity (C#)</span></span>

<span data-ttu-id="69f48-104">藉由[請參閱 Pranav Rastogi](https://github.com/rustd)， [Rick Anderson]((https://twitter.com/RickAndMSFT))， [Robert McMurray](https://github.com/rmcmurray)， [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="69f48-104">by [Pranav Rastogi](https://github.com/rustd), [Rick Anderson]((https://twitter.com/RickAndMSFT)), [Robert McMurray](https://github.com/rmcmurray), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="69f48-105">本教學課程會說明需要移轉使用者和角色的資料，以及使用 ASP.NET 身分識別模型的現有應用程式的通用提供者所建立的使用者設定檔資料的步驟。</span><span class="sxs-lookup"><span data-stu-id="69f48-105">This tutorial describes the steps that are necessary to migrate user and role data and user profile data created using Universal Providers of an existing application to the ASP.NET Identity model.</span></span> <span data-ttu-id="69f48-106">方法此處提及來移轉使用者設定檔資料可以使用 SQL 成員資格的應用程式中。</span><span class="sxs-lookup"><span data-stu-id="69f48-106">The approach mentioned here to migrate user profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="69f48-107">版本的 Visual Studio 2013 中，ASP.NET 團隊推出了新的 ASP.NET 身分識別系統，以及您可以深入了解該版本[此處](../../index.md)。</span><span class="sxs-lookup"><span data-stu-id="69f48-107">With the release of Visual Studio 2013, the ASP.NET team introduced a new ASP.NET Identity system, and you can read more about that release [here](../../index.md).</span></span> <span data-ttu-id="69f48-108">要從 web 應用程式移轉的發行項上[到新的身分識別系統的 SQL 成員資格](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)，這篇文章說明如何移轉現有的應用程式，請依照下列使用者和角色管理的提供者模型的步驟新的身分識別模型。</span><span class="sxs-lookup"><span data-stu-id="69f48-108">Following up on the article to migrate web applications from [SQL Membership to the new Identity system](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), this article illustrates the steps to migrate existing applications that follow the Providers model for user and role management to the new Identity model.</span></span> <span data-ttu-id="69f48-109">本教學課程的焦點會在移轉使用者設定檔資料，來順暢地將它連結到新的系統。</span><span class="sxs-lookup"><span data-stu-id="69f48-109">The focus of this tutorial will be primarily on migrating the user profile data to seamlessly hook it into the new system.</span></span> <span data-ttu-id="69f48-110">移轉使用者和角色的資訊是類似 SQL 的成員資格。</span><span class="sxs-lookup"><span data-stu-id="69f48-110">Migrating user and role information is similar for SQL membership.</span></span> <span data-ttu-id="69f48-111">移轉設定檔資料需遵循的方法可以使用 SQL 成員資格的應用程式中。</span><span class="sxs-lookup"><span data-stu-id="69f48-111">The approach followed to migrate profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="69f48-112">例如，我們會開始使用 Visual Studio 2012 使用的提供者模型所建立的 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="69f48-112">As an example, we will start with a web app created using Visual Studio 2012 which uses the Providers model.</span></span> <span data-ttu-id="69f48-113">我們將則加入設定檔管理的程式碼、 註冊的使用者、 新增使用者設定檔資料、 移轉資料庫結構描述，然後變更應用程式使用的身分識別系統的使用者和角色管理。</span><span class="sxs-lookup"><span data-stu-id="69f48-113">We'll then add code for profile management, register a user, add profile data for the users, migrate the database schema, and then change the application to use the Identity system for user and role management.</span></span> <span data-ttu-id="69f48-114">為移轉的測試，使用通用的提供者所建立的使用者應該能夠登入，而且新的使用者應該無法註冊。</span><span class="sxs-lookup"><span data-stu-id="69f48-114">As a test of migration, users created using Universal Providers should be able to log in and new users should be able to register.</span></span>

> [!NOTE]
> <span data-ttu-id="69f48-115">您可以找到完整的範例，在[ https://github.com/suhasj/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations)。</span><span class="sxs-lookup"><span data-stu-id="69f48-115">You can find the complete sample at [https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations).</span></span>

## <a name="profile-data-migration-summary"></a><span data-ttu-id="69f48-116">設定檔資料移轉摘要</span><span class="sxs-lookup"><span data-stu-id="69f48-116">Profile data migration summary</span></span>

<span data-ttu-id="69f48-117">再開始移轉，讓我們看看設定檔資料儲存在提供者模型中的體驗。</span><span class="sxs-lookup"><span data-stu-id="69f48-117">Before starting with the migrations, let us look at the experience of storing profile data in the Providers model.</span></span> <span data-ttu-id="69f48-118">應用程式，使用者可以儲存多種方式的設定檔資料，最常見其間正在使用通用的提供者所隨附的內建的設定檔提供者。</span><span class="sxs-lookup"><span data-stu-id="69f48-118">Profile data for application users can be stored in multiple ways, the most common among them being using the inbuilt profile providers shipped along with the Universal Providers.</span></span> <span data-ttu-id="69f48-119">這些步驟會包含</span><span class="sxs-lookup"><span data-stu-id="69f48-119">The steps would include</span></span>

1. <span data-ttu-id="69f48-120">加入具有用來儲存設定檔資料屬性的類別。</span><span class="sxs-lookup"><span data-stu-id="69f48-120">Add a class that has properties used to store Profile data.</span></span>
2. <span data-ttu-id="69f48-121">新增類別來擴充 'ProfileBase'，並實作方法，以取得使用者的上述的設定檔資料。</span><span class="sxs-lookup"><span data-stu-id="69f48-121">Add a class that extends 'ProfileBase' and implements methods to get the above profile data for the user.</span></span>
3. <span data-ttu-id="69f48-122">使用預設設定檔提供者中的啟用*web.config*檔案，並在步驟 #2，用於存取設定檔資訊中宣告的類別定義。</span><span class="sxs-lookup"><span data-stu-id="69f48-122">Enable using default profile providers in the *web.config* file and define the class declared in step #2 to be used in accessing profile information.</span></span>

<span data-ttu-id="69f48-123">設定檔資訊會儲存為序列化的 xml 和資料庫中的 'Profiles' 資料表中的二進位資料。</span><span class="sxs-lookup"><span data-stu-id="69f48-123">The profile information is stored as serialized xml and binary data in the 'Profiles' table in the database.</span></span>

<span data-ttu-id="69f48-124">移轉應用程式使用新的 ASP.NET 身分識別系統之後, 會設定檔資訊還原序列化，並儲存為使用者類別的屬性。</span><span class="sxs-lookup"><span data-stu-id="69f48-124">After migrating the application to use the new ASP.NET Identity system, the profile information is deserialized and stored as properties on the user class.</span></span> <span data-ttu-id="69f48-125">然後，每個屬性可以對應到使用者資料表中的資料行。</span><span class="sxs-lookup"><span data-stu-id="69f48-125">Each property can then be mapped onto columns in the user table.</span></span> <span data-ttu-id="69f48-126">此處的優點是，屬性即可使用除了不需要序列化/還原序列化資料資訊每個使用者類別直接存取時的時間。</span><span class="sxs-lookup"><span data-stu-id="69f48-126">The advantage here is that the properties can be worked on directly using the user class in addition to not having to serialize/deserialize data information each time when accessing it.</span></span>

## <a name="getting-started"></a><span data-ttu-id="69f48-127">快速入門</span><span class="sxs-lookup"><span data-stu-id="69f48-127">Getting Started</span></span>

1. <span data-ttu-id="69f48-128">Visual Studio 2012 中建立新的 ASP.NET 4.5 Web Form 應用程式。</span><span class="sxs-lookup"><span data-stu-id="69f48-128">Create a new ASP.NET 4.5 Web Forms application in Visual Studio 2012.</span></span> <span data-ttu-id="69f48-129">目前的範例會使用 Web Forms 範本，但您也可以使用 MVC 應用程式。</span><span class="sxs-lookup"><span data-stu-id="69f48-129">The current sample uses the Web Forms template, but you could use MVC Application as well.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="69f48-130">建立新的資料夾 '模型' 儲存設定檔資訊</span><span class="sxs-lookup"><span data-stu-id="69f48-130">Create a new folder 'Models' to store profile information</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. <span data-ttu-id="69f48-131">舉例來說，讓我們儲存日期的生日、 縣 （市）、 高度和寬度的使用者設定檔中。</span><span class="sxs-lookup"><span data-stu-id="69f48-131">As an example, let us store the date of birth, city, height and weight of the user in profile.</span></span> <span data-ttu-id="69f48-132">高度和寬度會儲存為自訂類別，稱為 'PersonalStats' 中。</span><span class="sxs-lookup"><span data-stu-id="69f48-132">The height and weight are stored as a custom class called 'PersonalStats'.</span></span> <span data-ttu-id="69f48-133">若要儲存及擷取的設定檔，我們需要可擴充 'ProfileBase' 的類別。</span><span class="sxs-lookup"><span data-stu-id="69f48-133">To store and retrieve the profile, we need a class that extends 'ProfileBase'.</span></span> <span data-ttu-id="69f48-134">讓我們建立一個新的類別 'AppProfile' 來取得及儲存設定檔資訊。</span><span class="sxs-lookup"><span data-stu-id="69f48-134">Let's create a new class 'AppProfile' to get and store profile information.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. <span data-ttu-id="69f48-135">啟用中的設定檔*web.config*檔案。</span><span class="sxs-lookup"><span data-stu-id="69f48-135">Enable profile in the *web.config* file.</span></span> <span data-ttu-id="69f48-136">輸入用於儲存/擷取使用者資訊在步驟 #3 中建立的類別名稱。</span><span class="sxs-lookup"><span data-stu-id="69f48-136">Enter the class name to be used to store/retrieve user information created in step #3.</span></span>

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. <span data-ttu-id="69f48-137">從使用者取得設定檔資料，並將其儲存的 'Account' 資料夾中新增 web forms 網頁。</span><span class="sxs-lookup"><span data-stu-id="69f48-137">Add a web forms page in 'Account' folder to get the profile data from the user and store it.</span></span> <span data-ttu-id="69f48-138">以滑鼠右鍵按一下專案，並選取 [加入新項目]。</span><span class="sxs-lookup"><span data-stu-id="69f48-138">Right click on project and select 'Add new Item'.</span></span> <span data-ttu-id="69f48-139">新增與主版頁面 'AddProfileData.aspx' webforms 頁面。</span><span class="sxs-lookup"><span data-stu-id="69f48-139">Add a new webforms page with master page 'AddProfileData.aspx'.</span></span> <span data-ttu-id="69f48-140">複製下列 'MainContent' 區段中：</span><span class="sxs-lookup"><span data-stu-id="69f48-140">Copy the following in the 'MainContent' section:</span></span>

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   <span data-ttu-id="69f48-141">在程式碼後置中新增下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="69f48-141">Add the following code in the code behind:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   <span data-ttu-id="69f48-142">新增命名空間下的 AppProfile 類別定義要移除的編譯錯誤。</span><span class="sxs-lookup"><span data-stu-id="69f48-142">Add the namespace under which AppProfile class is defined to remove the compilation errors.</span></span>
6. <span data-ttu-id="69f48-143">執行應用程式，並建立新的使用者具有使用者名稱 '**olduser'。**</span><span class="sxs-lookup"><span data-stu-id="69f48-143">Run the app and create a new user with username '**olduser'.**</span></span> <span data-ttu-id="69f48-144">瀏覽至 'AddProfileData' 頁面，並新增使用者設定檔資訊。</span><span class="sxs-lookup"><span data-stu-id="69f48-144">Navigate to the 'AddProfileData' page and add profile information for the user.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

<span data-ttu-id="69f48-145">您可以確認資料會儲存為序列化的 xml，使用 [伺服器總管] 視窗的 'Profiles' 資料表中。</span><span class="sxs-lookup"><span data-stu-id="69f48-145">You can verify that the data is stored as serialized xml in the 'Profiles' table using the Server Explorer window.</span></span> <span data-ttu-id="69f48-146">在 Visual Studio 中，從 [檢視] 功能表上，選擇 [伺服器總管]。</span><span class="sxs-lookup"><span data-stu-id="69f48-146">In Visual Studio, from 'View' menu, choose 'Server Explorer'.</span></span> <span data-ttu-id="69f48-147">應該針對資料庫中定義的資料連接*web.config*檔案。</span><span class="sxs-lookup"><span data-stu-id="69f48-147">There should be a data connection for the database defined in the *web.config* file.</span></span> <span data-ttu-id="69f48-148">按一下資料連接，顯示不同的子類別目錄。</span><span class="sxs-lookup"><span data-stu-id="69f48-148">Clicking on the data connection shows different sub categories.</span></span> <span data-ttu-id="69f48-149">展開以顯示不同的資料表在資料庫中，以滑鼠右鍵按一下 'Profiles' 然後選擇 [顯示資料表資料] 檢視設定檔資料表中儲存的設定檔資料的 「 資料表 」。</span><span class="sxs-lookup"><span data-stu-id="69f48-149">Expand 'Tables' to show the different tables in your database, then right click on 'Profiles' and choose 'Show Table Data' to view the profile data stored in the Profiles table.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a><span data-ttu-id="69f48-150">移轉資料庫結構描述</span><span class="sxs-lookup"><span data-stu-id="69f48-150">Migrating database schema</span></span>

<span data-ttu-id="69f48-151">若要讓現有的資料庫使用的身分識別系統，我們需要更新以支援我們加入至原始的資料庫欄位的識別資料庫中的結構描述。</span><span class="sxs-lookup"><span data-stu-id="69f48-151">To make the existing database work with the Identity system, we need to update the schema in the Identity database to support the fields we added to the original database.</span></span> <span data-ttu-id="69f48-152">這可以使用 SQL 指令碼來建立新的資料表，並複製現有的資訊。</span><span class="sxs-lookup"><span data-stu-id="69f48-152">This can be done using SQL scripts to create new tables and copy the existing information.</span></span> <span data-ttu-id="69f48-153">在 [伺服器總管] 視窗中，展開 'DefaultConnection' 中顯示的資料表。</span><span class="sxs-lookup"><span data-stu-id="69f48-153">In the 'Server Explorer' window, expand the 'DefaultConnection' to display the tables.</span></span> <span data-ttu-id="69f48-154">以滑鼠右鍵按一下資料表，然後選取 [新增查詢]</span><span class="sxs-lookup"><span data-stu-id="69f48-154">Right click Tables and select 'New Query'</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

<span data-ttu-id="69f48-155">貼上的 SQL 指令碼[ https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt ](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt)並加以執行。</span><span class="sxs-lookup"><span data-stu-id="69f48-155">Paste the SQL script from [https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) and run it.</span></span> <span data-ttu-id="69f48-156">如果重新整理 'DefaultConnection' 時，我們可以看到，會新增新的資料表。</span><span class="sxs-lookup"><span data-stu-id="69f48-156">If the 'DefaultConnection' is refreshed, we can see that the new tables are added.</span></span> <span data-ttu-id="69f48-157">您可以檢查以查看已移轉資訊的資料表內的資料。</span><span class="sxs-lookup"><span data-stu-id="69f48-157">You can check the data inside the tables to see that the information has been migrated.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a><span data-ttu-id="69f48-158">若要使用 ASP.NET 身分識別應用程式移轉</span><span class="sxs-lookup"><span data-stu-id="69f48-158">Migrating the application to use ASP.NET Identity</span></span>

1. <span data-ttu-id="69f48-159">安裝 ASP.NET 身分識別所需的 Nuget 套件：</span><span class="sxs-lookup"><span data-stu-id="69f48-159">Install the Nuget packages needed for ASP.NET Identity:</span></span>

    - <span data-ttu-id="69f48-160">Microsoft.AspNet.Identity.EntityFramework</span><span class="sxs-lookup"><span data-stu-id="69f48-160">Microsoft.AspNet.Identity.EntityFramework</span></span>
    - <span data-ttu-id="69f48-161">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="69f48-161">Microsoft.AspNet.Identity.Owin</span></span>
    - <span data-ttu-id="69f48-162">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="69f48-162">Microsoft.Owin.Host.SystemWeb</span></span>
    - <span data-ttu-id="69f48-163">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="69f48-163">Microsoft.Owin.Security.Facebook</span></span>
    - <span data-ttu-id="69f48-164">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="69f48-164">Microsoft.Owin.Security.Google</span></span>
    - <span data-ttu-id="69f48-165">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="69f48-165">Microsoft.Owin.Security.MicrosoftAccount</span></span>
    - <span data-ttu-id="69f48-166">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="69f48-166">Microsoft.Owin.Security.Twitter</span></span>

   <span data-ttu-id="69f48-167">在 管理 Nuget 套件的詳細資訊可以找到[這裡](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span><span class="sxs-lookup"><span data-stu-id="69f48-167">More information on managing Nuget packages can be found [here](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span></span>
2. <span data-ttu-id="69f48-168">若要使用資料表中的現有資料，我們要建立模型類別將對應至資料表，並將它們連結在身分識別系統中。</span><span class="sxs-lookup"><span data-stu-id="69f48-168">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="69f48-169">身分識別合約的一部分，模型類別應實作 Identity.Core dll 中定義的介面，或可以擴充現有 Microsoft.AspNet.Identity.EntityFramework 這些介面的實作。</span><span class="sxs-lookup"><span data-stu-id="69f48-169">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span> <span data-ttu-id="69f48-170">我們將使用現有類別的角色、 使用者登入和使用者宣告。</span><span class="sxs-lookup"><span data-stu-id="69f48-170">We will be using the existing classes for role, user logins and user claims.</span></span> <span data-ttu-id="69f48-171">我們需要使用自訂的使用者，我們的範例。</span><span class="sxs-lookup"><span data-stu-id="69f48-171">We need to use a custom user for our sample.</span></span> <span data-ttu-id="69f48-172">以滑鼠右鍵按一下專案，並建立新的資料夾 'IdentityModels'。</span><span class="sxs-lookup"><span data-stu-id="69f48-172">Right click on the project and create new folder 'IdentityModels'.</span></span> <span data-ttu-id="69f48-173">加入新的 「 使用者 」 類別，如下所示：</span><span class="sxs-lookup"><span data-stu-id="69f48-173">Add a new 'User' class as shown below:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   <span data-ttu-id="69f48-174">請注意，'ProfileInfo' 現在是使用者類別的屬性。</span><span class="sxs-lookup"><span data-stu-id="69f48-174">Notice that the 'ProfileInfo' is now a property on the user class.</span></span> <span data-ttu-id="69f48-175">因此我們可以使用使用者類別直接使用設定檔資料。</span><span class="sxs-lookup"><span data-stu-id="69f48-175">Hence we can use the user class to directly work with profile data.</span></span>

<span data-ttu-id="69f48-176">在將檔案複製**IdentityModels**並**IdentityAccount**下載來源的資料夾 ( [ https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) )。</span><span class="sxs-lookup"><span data-stu-id="69f48-176">Copy the files in the **IdentityModels** and **IdentityAccount** folders from the download source ( [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ).</span></span> <span data-ttu-id="69f48-177">它們有剩餘的模型類別和新使用者和角色管理使用 ASP.NET 身分識別 Api 所需的頁面。</span><span class="sxs-lookup"><span data-stu-id="69f48-177">These have the remaining model classes and the new pages needed for user and role management using the ASP.NET Identity APIs.</span></span> <span data-ttu-id="69f48-178">所使用的方法是類似於 SQL 成員資格，且可以找到詳細的說明[此處](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)。</span><span class="sxs-lookup"><span data-stu-id="69f48-178">The approach used is similar to the SQL Membership and the detailed explanation can be found [here](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

## <a name="copying-profile-data-to-the-new-tables"></a><span data-ttu-id="69f48-179">將設定檔資料複製到新的資料表</span><span class="sxs-lookup"><span data-stu-id="69f48-179">Copying Profile data to the new tables</span></span>

<span data-ttu-id="69f48-180">如先前所述，我們要還原序列化設定檔資料表中的 xml 資料，並將它儲存在 AspNetUsers 資料表的資料行。</span><span class="sxs-lookup"><span data-stu-id="69f48-180">As mentioned earlier, we need to deserialize the xml data in the Profiles tables and store it in the columns of the AspNetUsers table.</span></span> <span data-ttu-id="69f48-181">因此剩下的就是填入必要資料，這些資料行上一個步驟中的 users 資料表中建立新的資料行。</span><span class="sxs-lookup"><span data-stu-id="69f48-181">The new columns were created in the users table in the previous step so all that is left is to populate those columns with the necessary data.</span></span> <span data-ttu-id="69f48-182">若要這樣做，我們將使用它來填入新建立的資料行，users 資料表中一次執行的主控台應用程式。</span><span class="sxs-lookup"><span data-stu-id="69f48-182">To do this, we will use a console application which is run once to populate the newly created columns in the users table.</span></span>

1. <span data-ttu-id="69f48-183">在現有的方案中建立新的主控台應用程式。</span><span class="sxs-lookup"><span data-stu-id="69f48-183">Create a new console application in the exiting solution.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. <span data-ttu-id="69f48-184">安裝最新版的 Entity Framework 套件。</span><span class="sxs-lookup"><span data-stu-id="69f48-184">Install the latest version of the Entity Framework package.</span></span>
3. <span data-ttu-id="69f48-185">新增為主控台應用程式的參考上述所建立的 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="69f48-185">Add the web application created above as a reference to the console application.</span></span> <span data-ttu-id="69f48-186">若要執行這以滑鼠右鍵按一下專案，然後 [新增參考]，然後解決方案中，按一下專案，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="69f48-186">To do this right click on Project, then 'Add References', then Solution, then click on the project and click OK.</span></span>
4. <span data-ttu-id="69f48-187">複製下列 Program.cs 類別中的程式碼。</span><span class="sxs-lookup"><span data-stu-id="69f48-187">Copy the below code in the Program.cs class.</span></span> <span data-ttu-id="69f48-188">此邏輯讀取的每個使用者設定檔資料、 將其序列化為 'ProfileInfo' 物件，並將它儲存回資料庫。</span><span class="sxs-lookup"><span data-stu-id="69f48-188">This logic reads profile data for each user, serializes it as 'ProfileInfo' object and stores it back to the database.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   <span data-ttu-id="69f48-189">部分使用的模型定義於 'IdentityModels' web 應用程式專案資料夾，因此您必須將包含對應的命名空間。</span><span class="sxs-lookup"><span data-stu-id="69f48-189">Some of the models used are defined in the 'IdentityModels' folder of the web application project, so you must include the corresponding namespaces.</span></span>
5. <span data-ttu-id="69f48-190">上述程式碼適用於應用程式中的資料庫檔案\_上一個步驟中建立的 web 應用程式專案的 [資料] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="69f48-190">The above code works on the database file in the App\_Data folder of the web application project created in the previous steps.</span></span> <span data-ttu-id="69f48-191">若要參考的請使用 web 應用程式的 web.config 中的連接字串更新主控台應用程式的 app.config 檔案中的連接字串。</span><span class="sxs-lookup"><span data-stu-id="69f48-191">To reference that, update the connection string in the app.config file of the console application with the connection string in the web.config of the web application.</span></span> <span data-ttu-id="69f48-192">也提供 'AttachDbFilename' 屬性中的完整實體路徑。</span><span class="sxs-lookup"><span data-stu-id="69f48-192">Also provide the complete physical path in the 'AttachDbFilename' property.</span></span>
6. <span data-ttu-id="69f48-193">開啟命令提示字元並瀏覽至上面的主控台應用程式的 bin 資料夾。</span><span class="sxs-lookup"><span data-stu-id="69f48-193">Open a command prompt and navigate to the bin folder of the above console application.</span></span> <span data-ttu-id="69f48-194">執行可執行檔，並檢閱的記錄輸出，如下圖所示。</span><span class="sxs-lookup"><span data-stu-id="69f48-194">Run the executable and review the log output as shown in the following image.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. <span data-ttu-id="69f48-195">在 [伺服器總管] 中開啟 'AspNetUsers' 資料表，並確認保存屬性的新資料行中的資料。</span><span class="sxs-lookup"><span data-stu-id="69f48-195">Open the 'AspNetUsers' table in the Server Explorer and verify the data in the new columns that hold the properties.</span></span> <span data-ttu-id="69f48-196">它們應該更新的相對應的屬性值。</span><span class="sxs-lookup"><span data-stu-id="69f48-196">They should be updated with the corresponding property values.</span></span>

## <a name="verify-functionality"></a><span data-ttu-id="69f48-197">驗證功能</span><span class="sxs-lookup"><span data-stu-id="69f48-197">Verify functionality</span></span>

<span data-ttu-id="69f48-198">使用會實作使用 ASP.NET 身分識別登入從舊的資料庫使用者的新加入的成員資格頁面。</span><span class="sxs-lookup"><span data-stu-id="69f48-198">Use the newly added membership pages that are implemented using ASP.NET Identity to login a user from the old database.</span></span> <span data-ttu-id="69f48-199">使用者應該能夠使用相同的認證登入。</span><span class="sxs-lookup"><span data-stu-id="69f48-199">The user should be able to log in using the same credentials.</span></span> <span data-ttu-id="69f48-200">請嘗試其他功能，例如新增 OAuth，建立新的使用者，並變更密碼的新增角色，將使用者新增至角色，依此類推。</span><span class="sxs-lookup"><span data-stu-id="69f48-200">Try the other functionalities like adding OAuth, creating a new user, changing a password, adding roles, add users to roles, etc.</span></span>

<span data-ttu-id="69f48-201">應該擷取和儲存在使用者資料表中舊的使用者和新的使用者設定檔資料。</span><span class="sxs-lookup"><span data-stu-id="69f48-201">The Profile data for the old user and the new users should be retrieved and stored in the users table.</span></span> <span data-ttu-id="69f48-202">應該不會再參考舊的資料表。</span><span class="sxs-lookup"><span data-stu-id="69f48-202">The old table should no longer be referenced.</span></span>

## <a name="conclusion"></a><span data-ttu-id="69f48-203">結論</span><span class="sxs-lookup"><span data-stu-id="69f48-203">Conclusion</span></span>

<span data-ttu-id="69f48-204">本文說明使用 ASP.NET 身分識別的成員資格提供者模型的移轉 web 應用程式的程序。</span><span class="sxs-lookup"><span data-stu-id="69f48-204">The article described the process of migrating web applications that used the provider model for membership to ASP.NET Identity.</span></span> <span data-ttu-id="69f48-205">發行項此外概述移轉連結至身分識別系統的使用者設定檔資料。</span><span class="sxs-lookup"><span data-stu-id="69f48-205">The article additionally outlined migrating profile data for users to be hooked into the Identity system.</span></span> <span data-ttu-id="69f48-206">請留下註解以下問題和移轉您的應用程式時所遇到的問題。</span><span class="sxs-lookup"><span data-stu-id="69f48-206">Please leave comments below for questions and issues encountered when you migrate your app.</span></span>

<span data-ttu-id="69f48-207">*感謝 Rick Anderson 和 Robert McMurray 的檢閱。*</span><span class="sxs-lookup"><span data-stu-id="69f48-207">*Thanks to Rick Anderson and Robert McMurray for reviewing the article.*</span></span>
