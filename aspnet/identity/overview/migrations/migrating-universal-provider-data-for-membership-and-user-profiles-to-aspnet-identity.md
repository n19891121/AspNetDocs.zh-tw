---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: 將成員資格和使用者設定檔的通用提供者資料C#遷移至 ASP.NET Identity （）-ASP.NET 4。x
author: rustd
description: 本教學課程說明遷移使用現有應用程式 Universal Providers 所建立的使用者和角色資料和使用者設定檔資料時，所需執行的步驟。
ms.author: riande
ms.date: 12/13/2013
ms.custom: seoapril2019
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 31f02a0cec3c531c45c37b7aad8456e01e80b5ea
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456109"
---
# <a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a><span data-ttu-id="fa0fb-103">將成員資格和使用者設定檔的通用提供者資料移轉至 ASP.NET Identity (C#)</span><span class="sxs-lookup"><span data-stu-id="fa0fb-103">Migrating Universal Provider Data for Membership and User Profiles to ASP.NET Identity (C#)</span></span>

<span data-ttu-id="fa0fb-104">by [Pranav 請參閱 rastogi](https://github.com/rustd)、 [Rick Anderson](https://twitter.com/RickAndMSFT)、 [Robert McMurray](https://github.com/rmcmurray)、 [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="fa0fb-104">by [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://twitter.com/RickAndMSFT), [Robert McMurray](https://github.com/rmcmurray), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="fa0fb-105">本教學課程說明將使用現有應用程式 Universal Providers 建立的使用者和角色資料和使用者設定檔資料移轉至 ASP.NET Identity 模型所需的步驟。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-105">This tutorial describes the steps that are necessary to migrate user and role data and user profile data created using Universal Providers of an existing application to the ASP.NET Identity model.</span></span> <span data-ttu-id="fa0fb-106">這裡所述用來遷移使用者設定檔資料的方法，也可以在具有 SQL 成員資格的應用程式中使用。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-106">The approach mentioned here to migrate user profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="fa0fb-107">隨著 Visual Studio 2013 的發行，ASP.NET 團隊引進了新的 ASP.NET Identity 系統，而您可以在[這裡](../../index.md)閱讀更多有關該版本的資訊。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-107">With the release of Visual Studio 2013, the ASP.NET team introduced a new ASP.NET Identity system, and you can read more about that release [here](../../index.md).</span></span> <span data-ttu-id="fa0fb-108">本文說明如何將 web 應用程式從[SQL 成員資格遷移至新的身分識別系統](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)，這篇文章說明了如何將遵循提供者模型的現有應用程式遷移至新的身分識別模型，以進行使用者和角色管理。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-108">Following up on the article to migrate web applications from [SQL Membership to the new Identity system](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), this article illustrates the steps to migrate existing applications that follow the Providers model for user and role management to the new Identity model.</span></span> <span data-ttu-id="fa0fb-109">本教學課程的重點主要在於遷移使用者設定檔資料，並將它緊密地連結到新系統。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-109">The focus of this tutorial will be primarily on migrating the user profile data to seamlessly hook it into the new system.</span></span> <span data-ttu-id="fa0fb-110">遷移使用者和角色資訊類似于 SQL 成員資格。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-110">Migrating user and role information is similar for SQL membership.</span></span> <span data-ttu-id="fa0fb-111">您也可以在具有 SQL 成員資格的應用程式中使用遷移設定檔資料所遵循的方法。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-111">The approach followed to migrate profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="fa0fb-112">例如，我們將從使用提供者模型的 Visual Studio 2012 建立的 web 應用程式開始。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-112">As an example, we will start with a web app created using Visual Studio 2012 which uses the Providers model.</span></span> <span data-ttu-id="fa0fb-113">接著，我們將新增程式碼以進行設定檔管理、註冊使用者、為使用者新增設定檔資料、遷移資料庫架構，然後將應用程式變更為使用身分識別系統進行使用者和角色管理。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-113">We'll then add code for profile management, register a user, add profile data for the users, migrate the database schema, and then change the application to use the Identity system for user and role management.</span></span> <span data-ttu-id="fa0fb-114">作為遷移的測試，使用 Universal Providers 建立的使用者應該能夠登入，而新的使用者應該能夠註冊。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-114">As a test of migration, users created using Universal Providers should be able to log in and new users should be able to register.</span></span>

> [!NOTE]
> <span data-ttu-id="fa0fb-115">您可以在[https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations)找到完整的範例。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-115">You can find the complete sample at [https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations).</span></span>

## <a name="profile-data-migration-summary"></a><span data-ttu-id="fa0fb-116">分析資料遷移摘要</span><span class="sxs-lookup"><span data-stu-id="fa0fb-116">Profile data migration summary</span></span>

<span data-ttu-id="fa0fb-117">開始進行遷移之前，讓我們看看在提供者模型中儲存設定檔資料的經驗。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-117">Before starting with the migrations, let us look at the experience of storing profile data in the Providers model.</span></span> <span data-ttu-id="fa0fb-118">應用程式使用者的設定檔資料可透過多種方式儲存，最常見的情況是使用隨附于 Universal Providers 的內建設定檔提供者。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-118">Profile data for application users can be stored in multiple ways, the most common among them being using the inbuilt profile providers shipped along with the Universal Providers.</span></span> <span data-ttu-id="fa0fb-119">這些步驟包括</span><span class="sxs-lookup"><span data-stu-id="fa0fb-119">The steps would include</span></span>

1. <span data-ttu-id="fa0fb-120">加入具有用來儲存設定檔資料之屬性的類別。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-120">Add a class that has properties used to store Profile data.</span></span>
2. <span data-ttu-id="fa0fb-121">加入擴充 ' ProfileBase ' 的類別，並執行方法來取得使用者的上述設定檔資料。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-121">Add a class that extends 'ProfileBase' and implements methods to get the above profile data for the user.</span></span>
3. <span data-ttu-id="fa0fb-122">在*web.config 檔案*中啟用使用預設設定檔提供者，並定義在步驟 #2 中宣告的類別，以用來存取設定檔資訊。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-122">Enable using default profile providers in the *web.config* file and define the class declared in step #2 to be used in accessing profile information.</span></span>

<span data-ttu-id="fa0fb-123">設定檔資訊會以序列化 xml 和二進位資料的形式儲存在資料庫的「設定檔」資料表中。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-123">The profile information is stored as serialized xml and binary data in the 'Profiles' table in the database.</span></span>

<span data-ttu-id="fa0fb-124">在遷移應用程式以使用新的 ASP.NET Identity 系統之後，會將設定檔資訊還原序列化，並儲存為使用者類別上的屬性。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-124">After migrating the application to use the new ASP.NET Identity system, the profile information is deserialized and stored as properties on the user class.</span></span> <span data-ttu-id="fa0fb-125">然後，每個屬性都可以對應到使用者資料表中的資料行。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-125">Each property can then be mapped onto columns in the user table.</span></span> <span data-ttu-id="fa0fb-126">這裡的優點是，除了每次存取資料資訊時，這些屬性都可以直接使用 user 類別來處理，而不必序列化/還原序列化資料。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-126">The advantage here is that the properties can be worked on directly using the user class in addition to not having to serialize/deserialize data information each time when accessing it.</span></span>

## <a name="getting-started"></a><span data-ttu-id="fa0fb-127">開始使用</span><span class="sxs-lookup"><span data-stu-id="fa0fb-127">Getting Started</span></span>

1. <span data-ttu-id="fa0fb-128">在 Visual Studio 2012 中建立新的 ASP.NET 4.5 Web Forms 應用程式。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-128">Create a new ASP.NET 4.5 Web Forms application in Visual Studio 2012.</span></span> <span data-ttu-id="fa0fb-129">目前的範例會使用 Web Forms 範本，但是您也可以使用 MVC 應用程式。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-129">The current sample uses the Web Forms template, but you could use MVC Application as well.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="fa0fb-130">建立新的資料夾「模型」以儲存設定檔資訊</span><span class="sxs-lookup"><span data-stu-id="fa0fb-130">Create a new folder 'Models' to store profile information</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. <span data-ttu-id="fa0fb-131">例如，讓我們將使用者的出生日期、城市、高度和權數儲存在設定檔中。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-131">As an example, let us store the date of birth, city, height and weight of the user in profile.</span></span> <span data-ttu-id="fa0fb-132">高度和權數會儲存為名為 ' PersonalStats ' 的自訂類別。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-132">The height and weight are stored as a custom class called 'PersonalStats'.</span></span> <span data-ttu-id="fa0fb-133">若要儲存和抓取設定檔，我們需要一個擴充 ' ProfileBase ' 的類別。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-133">To store and retrieve the profile, we need a class that extends 'ProfileBase'.</span></span> <span data-ttu-id="fa0fb-134">讓我們建立新的類別 ' AppProfile '，以取得並儲存設定檔資訊。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-134">Let's create a new class 'AppProfile' to get and store profile information.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. <span data-ttu-id="fa0fb-135">啟用*web.config*檔案中的設定檔。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-135">Enable profile in the *web.config* file.</span></span> <span data-ttu-id="fa0fb-136">輸入要用來儲存/取出在步驟 #3 中建立之使用者資訊的類別名稱。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-136">Enter the class name to be used to store/retrieve user information created in step #3.</span></span>

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. <span data-ttu-id="fa0fb-137">在 [帳戶] 資料夾中新增 web forms 頁面，以取得使用者的設定檔資料並加以儲存。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-137">Add a web forms page in 'Account' folder to get the profile data from the user and store it.</span></span> <span data-ttu-id="fa0fb-138">以滑鼠右鍵按一下專案，然後選取 [加入新專案]。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-138">Right click on project and select 'Add new Item'.</span></span> <span data-ttu-id="fa0fb-139">加入具有主版頁面 ' AddProfileData ' 的新 webforms 頁面。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-139">Add a new webforms page with master page 'AddProfileData.aspx'.</span></span> <span data-ttu-id="fa0fb-140">複製 [MainContent] 區段中的下列內容：</span><span class="sxs-lookup"><span data-stu-id="fa0fb-140">Copy the following in the 'MainContent' section:</span></span>

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   <span data-ttu-id="fa0fb-141">在程式碼後置中新增下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="fa0fb-141">Add the following code in the code behind:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   <span data-ttu-id="fa0fb-142">加入用來定義 AppProfile 類別的命名空間，以移除編譯錯誤。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-142">Add the namespace under which AppProfile class is defined to remove the compilation errors.</span></span>
6. <span data-ttu-id="fa0fb-143">執行應用程式，並建立使用者名稱為 '**olduser '** 的新使用者。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-143">Run the app and create a new user with username '**olduser'.**</span></span> <span data-ttu-id="fa0fb-144">流覽至 [AddProfileData] 頁面，並加入使用者的設定檔資訊。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-144">Navigate to the 'AddProfileData' page and add profile information for the user.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

<span data-ttu-id="fa0fb-145">您可以使用 [伺服器總管] 視窗，確認資料是以序列化 xml 的形式儲存在「設定檔」資料表中。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-145">You can verify that the data is stored as serialized xml in the 'Profiles' table using the Server Explorer window.</span></span> <span data-ttu-id="fa0fb-146">在 Visual Studio 中，從 [View] 功能表選擇 [伺服器總管]。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-146">In Visual Studio, from 'View' menu, choose 'Server Explorer'.</span></span> <span data-ttu-id="fa0fb-147">在*web.config 檔案*中定義的資料庫應該會有資料連線。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-147">There should be a data connection for the database defined in the *web.config* file.</span></span> <span data-ttu-id="fa0fb-148">按一下資料連線會顯示不同的子類別。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-148">Clicking on the data connection shows different sub categories.</span></span> <span data-ttu-id="fa0fb-149">展開 [資料表] 以顯示資料庫中的不同資料表，然後以滑鼠右鍵按一下 [設定檔]，再選擇 [顯示資料表資料] 來查看設定檔資料表中所儲存的設定檔資料。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-149">Expand 'Tables' to show the different tables in your database, then right click on 'Profiles' and choose 'Show Table Data' to view the profile data stored in the Profiles table.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a><span data-ttu-id="fa0fb-150">正在遷移資料庫架構</span><span class="sxs-lookup"><span data-stu-id="fa0fb-150">Migrating database schema</span></span>

<span data-ttu-id="fa0fb-151">若要讓現有的資料庫與身分識別系統搭配使用，我們需要更新身分識別資料庫中的架構，以支援我們新增至原始資料庫的欄位。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-151">To make the existing database work with the Identity system, we need to update the schema in the Identity database to support the fields we added to the original database.</span></span> <span data-ttu-id="fa0fb-152">這可以使用 SQL 腳本來建立新的資料表，並複製現有的資訊來完成。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-152">This can be done using SQL scripts to create new tables and copy the existing information.</span></span> <span data-ttu-id="fa0fb-153">在 [伺服器總管] 視窗中，展開 [DefaultConnection] 以顯示資料表。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-153">In the 'Server Explorer' window, expand the 'DefaultConnection' to display the tables.</span></span> <span data-ttu-id="fa0fb-154">以滑鼠右鍵按一下 [資料表]，然後選取 [新增查詢]</span><span class="sxs-lookup"><span data-stu-id="fa0fb-154">Right click Tables and select 'New Query'</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

<span data-ttu-id="fa0fb-155">從[https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt)貼上 SQL 腳本並加以執行。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-155">Paste the SQL script from [https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) and run it.</span></span> <span data-ttu-id="fa0fb-156">如果重新整理 ' DefaultConnection '，我們可以看到新的資料表已加入。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-156">If the 'DefaultConnection' is refreshed, we can see that the new tables are added.</span></span> <span data-ttu-id="fa0fb-157">您可以檢查資料表內的資料，以查看該資訊是否已遷移。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-157">You can check the data inside the tables to see that the information has been migrated.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a><span data-ttu-id="fa0fb-158">將應用程式遷移到使用 ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="fa0fb-158">Migrating the application to use ASP.NET Identity</span></span>

1. <span data-ttu-id="fa0fb-159">安裝 ASP.NET Identity 所需的 Nuget 套件：</span><span class="sxs-lookup"><span data-stu-id="fa0fb-159">Install the Nuget packages needed for ASP.NET Identity:</span></span>

    - <span data-ttu-id="fa0fb-160">Microsoft.AspNet.Identity.EntityFramework</span><span class="sxs-lookup"><span data-stu-id="fa0fb-160">Microsoft.AspNet.Identity.EntityFramework</span></span>
    - <span data-ttu-id="fa0fb-161">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="fa0fb-161">Microsoft.AspNet.Identity.Owin</span></span>
    - <span data-ttu-id="fa0fb-162">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="fa0fb-162">Microsoft.Owin.Host.SystemWeb</span></span>
    - <span data-ttu-id="fa0fb-163">Owin. 安全性 Facebook</span><span class="sxs-lookup"><span data-stu-id="fa0fb-163">Microsoft.Owin.Security.Facebook</span></span>
    - <span data-ttu-id="fa0fb-164">Owin。 Google</span><span class="sxs-lookup"><span data-stu-id="fa0fb-164">Microsoft.Owin.Security.Google</span></span>
    - <span data-ttu-id="fa0fb-165">Owin. Security. MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="fa0fb-165">Microsoft.Owin.Security.MicrosoftAccount</span></span>
    - <span data-ttu-id="fa0fb-166">Owin. Security. Twitter</span><span class="sxs-lookup"><span data-stu-id="fa0fb-166">Microsoft.Owin.Security.Twitter</span></span>

   <span data-ttu-id="fa0fb-167">如需有關管理 Nuget 套件的詳細資訊，請參閱[這裡](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span><span class="sxs-lookup"><span data-stu-id="fa0fb-167">More information on managing Nuget packages can be found [here](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span></span>
2. <span data-ttu-id="fa0fb-168">若要使用資料表中的現有資料，我們必須建立對應回資料表的模型類別，並在身分識別系統中連結它們。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-168">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="fa0fb-169">在身分識別合約中，模型類別應執行在 Identity. Core dll 中定義的介面，或可以擴充 EntityFramework 中的現有介面。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-169">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span> <span data-ttu-id="fa0fb-170">我們將針對角色、使用者登入和使用者宣告使用現有的類別。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-170">We will be using the existing classes for role, user logins and user claims.</span></span> <span data-ttu-id="fa0fb-171">我們需要在我們的範例中使用自訂使用者。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-171">We need to use a custom user for our sample.</span></span> <span data-ttu-id="fa0fb-172">以滑鼠右鍵按一下專案，然後建立新資料夾 ' IdentityModels '。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-172">Right click on the project and create new folder 'IdentityModels'.</span></span> <span data-ttu-id="fa0fb-173">加入新的「使用者」類別，如下所示：</span><span class="sxs-lookup"><span data-stu-id="fa0fb-173">Add a new 'User' class as shown below:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   <span data-ttu-id="fa0fb-174">請注意，' Profileinfo.txt ' 現在是 user 類別上的屬性。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-174">Notice that the 'ProfileInfo' is now a property on the user class.</span></span> <span data-ttu-id="fa0fb-175">因此，我們可以使用 user 類別直接處理設定檔資料。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-175">Hence we can use the user class to directly work with profile data.</span></span>

<span data-ttu-id="fa0fb-176">從下載來源（ [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ）複製**IdentityModels**和**IdentityAccount**資料夾中的檔案。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-176">Copy the files in the **IdentityModels** and **IdentityAccount** folders from the download source ( [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ).</span></span> <span data-ttu-id="fa0fb-177">這些包含其餘的模型類別，以及使用 ASP.NET Identity Api 進行使用者和角色管理所需的新頁面。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-177">These have the remaining model classes and the new pages needed for user and role management using the ASP.NET Identity APIs.</span></span> <span data-ttu-id="fa0fb-178">使用的方法類似 SQL 成員資格，而詳細的說明可以在[這裡](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)找到。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-178">The approach used is similar to the SQL Membership and the detailed explanation can be found [here](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

## <a name="copying-profile-data-to-the-new-tables"></a><span data-ttu-id="fa0fb-179">將設定檔資料複製到新的資料表</span><span class="sxs-lookup"><span data-stu-id="fa0fb-179">Copying Profile data to the new tables</span></span>

<span data-ttu-id="fa0fb-180">如先前所述，我們需要將設定檔資料表中的 xml 資料還原序列化，並將它儲存在 AspNetUsers 資料表的資料行中。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-180">As mentioned earlier, we need to deserialize the xml data in the Profiles tables and store it in the columns of the AspNetUsers table.</span></span> <span data-ttu-id="fa0fb-181">新的資料行是在上一個步驟的 [使用者] 資料表中建立的，因此，剩下的工作就是將所需的資料填入這些資料行。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-181">The new columns were created in the users table in the previous step so all that is left is to populate those columns with the necessary data.</span></span> <span data-ttu-id="fa0fb-182">若要這樣做，我們將使用主控台應用程式，它會執行一次，以填入 [使用者] 資料表中新建立的資料行。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-182">To do this, we will use a console application which is run once to populate the newly created columns in the users table.</span></span>

1. <span data-ttu-id="fa0fb-183">在現有的解決方案中建立新的主控台應用程式。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-183">Create a new console application in the exiting solution.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. <span data-ttu-id="fa0fb-184">安裝最新版的 Entity Framework 套件。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-184">Install the latest version of the Entity Framework package.</span></span>
3. <span data-ttu-id="fa0fb-185">將上述建立的 web 應用程式新增為主控台應用程式的參考。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-185">Add the web application created above as a reference to the console application.</span></span> <span data-ttu-id="fa0fb-186">若要執行此動作，請以滑鼠右鍵按一下 [專案]，然後按一下 [加入參考]、[方案]、專案，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-186">To do this right click on Project, then 'Add References', then Solution, then click on the project and click OK.</span></span>
4. <span data-ttu-id="fa0fb-187">複製 Program.cs 類別中的下列程式碼。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-187">Copy the below code in the Program.cs class.</span></span> <span data-ttu-id="fa0fb-188">此邏輯會讀取每個使用者的設定檔資料，並將其序列化為 ' Profileinfo.txt ' 物件，並將其儲存回資料庫。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-188">This logic reads profile data for each user, serializes it as 'ProfileInfo' object and stores it back to the database.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   <span data-ttu-id="fa0fb-189">某些使用的模型是在 web 應用程式專案的 ' IdentityModels ' 資料夾中定義，因此您必須包含對應的命名空間。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-189">Some of the models used are defined in the 'IdentityModels' folder of the web application project, so you must include the corresponding namespaces.</span></span>
5. <span data-ttu-id="fa0fb-190">上述程式碼適用于在上一個步驟中建立之 web 應用程式專案的 App\_Data 資料夾中的資料庫檔案。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-190">The above code works on the database file in the App\_Data folder of the web application project created in the previous steps.</span></span> <span data-ttu-id="fa0fb-191">若要參考該檔案，請在主控台應用程式的 app.config 檔案中，使用 web 應用程式的 web.config 中的連接字串來更新連接字串。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-191">To reference that, update the connection string in the app.config file of the console application with the connection string in the web.config of the web application.</span></span> <span data-ttu-id="fa0fb-192">也請在 ' AttachDbFilename ' 屬性中提供完整的實體路徑。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-192">Also provide the complete physical path in the 'AttachDbFilename' property.</span></span>
6. <span data-ttu-id="fa0fb-193">開啟命令提示字元，並流覽至上述主控台應用程式的 bin 資料夾。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-193">Open a command prompt and navigate to the bin folder of the above console application.</span></span> <span data-ttu-id="fa0fb-194">執行可執行檔，並檢查記錄輸出，如下圖所示。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-194">Run the executable and review the log output as shown in the following image.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. <span data-ttu-id="fa0fb-195">在伺服器總管中開啟 ' AspNetUsers ' 資料表，並確認保留屬性的新資料行中的資料。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-195">Open the 'AspNetUsers' table in the Server Explorer and verify the data in the new columns that hold the properties.</span></span> <span data-ttu-id="fa0fb-196">您應該使用對應的屬性值來更新它們。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-196">They should be updated with the corresponding property values.</span></span>

## <a name="verify-functionality"></a><span data-ttu-id="fa0fb-197">驗證功能</span><span class="sxs-lookup"><span data-stu-id="fa0fb-197">Verify functionality</span></span>

<span data-ttu-id="fa0fb-198">使用新加入的成員資格頁面（使用 ASP.NET Identity 來執行），以從舊的資料庫登入使用者。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-198">Use the newly added membership pages that are implemented using ASP.NET Identity to login a user from the old database.</span></span> <span data-ttu-id="fa0fb-199">使用者應該能夠使用相同的認證登入。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-199">The user should be able to log in using the same credentials.</span></span> <span data-ttu-id="fa0fb-200">嘗試其他功能，例如新增 OAuth、建立新使用者、變更密碼、新增角色、將使用者新增至角色等。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-200">Try the other functionalities like adding OAuth, creating a new user, changing a password, adding roles, add users to roles, etc.</span></span>

<span data-ttu-id="fa0fb-201">應抓取舊使用者和新使用者的設定檔資料，並將其儲存在使用者資料表中。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-201">The Profile data for the old user and the new users should be retrieved and stored in the users table.</span></span> <span data-ttu-id="fa0fb-202">不應再參考舊的資料表。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-202">The old table should no longer be referenced.</span></span>

## <a name="conclusion"></a><span data-ttu-id="fa0fb-203">結論</span><span class="sxs-lookup"><span data-stu-id="fa0fb-203">Conclusion</span></span>

<span data-ttu-id="fa0fb-204">本文描述的是將使用提供者模型的 web 應用程式遷移至 ASP.NET Identity 成員資格的程式。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-204">The article described the process of migrating web applications that used the provider model for membership to ASP.NET Identity.</span></span> <span data-ttu-id="fa0fb-205">本文另外也概述了遷移設定檔資料，讓使用者連結到身分識別系統。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-205">The article additionally outlined migrating profile data for users to be hooked into the Identity system.</span></span> <span data-ttu-id="fa0fb-206">請針對遷移應用程式時所遇到的問題和問題留下意見。</span><span class="sxs-lookup"><span data-stu-id="fa0fb-206">Please leave comments below for questions and issues encountered when you migrate your app.</span></span>

<span data-ttu-id="fa0fb-207">*感謝 Rick Anderson 和 Robert McMurray 來審查文章。*</span><span class="sxs-lookup"><span data-stu-id="fa0fb-207">*Thanks to Rick Anderson and Robert McMurray for reviewing the article.*</span></span>
