---
uid: identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
title: 使用 Azure Active Directory ASP.NET 4.x 開發 ASP.NET 應用程式
author: Rick-Anderson
description: 適用于 Azure Active Directory 的 Microsoft ASP.NET 工具可讓您輕鬆地針對裝載于 Azure 上的 web 應用程式啟用驗證。 您可以使用 Azure 驗證 。
ms.author: riande
ms.date: 08/14/2014
ms.assetid: 457d7eaf-ee76-4ceb-9082-c7c1721435ad
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
msc.type: authoredcontent
ms.openlocfilehash: 28425ea8d1312dfc6e14df9677396f2cbcf6f16d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78583850"
---
# <a name="developing-aspnet-apps-with-azure-active-directory"></a><span data-ttu-id="32a28-104">使用 Azure Active Dirctory 開發 ASP.NET 應用程式</span><span class="sxs-lookup"><span data-stu-id="32a28-104">Developing ASP.NET Apps with Azure Active Directory</span></span>

<span data-ttu-id="32a28-105">依[Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="32a28-105">by [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="32a28-106">適用于 Azure Active Directory 的 Microsoft ASP.NET 工具可簡化[Azure](https://www.windowsazure.com/home/features/web-sites/)上裝載之 web 應用程式的驗證啟用。</span><span class="sxs-lookup"><span data-stu-id="32a28-106">Microsoft ASP.NET tools for Azure Active Directory simplifies enabling authentication for web apps hosted on [Azure](https://www.windowsazure.com/home/features/web-sites/).</span></span> <span data-ttu-id="32a28-107">您可以使用 Azure 驗證，從您的組織驗證 Office 365 使用者、從內部部署 Active Directory 同步處理的公司帳戶，或在您自己的自訂 Azure Active Directory 網域中建立的使用者。</span><span class="sxs-lookup"><span data-stu-id="32a28-107">You can use Azure Authentication to authenticate Office 365 users from your organization, corporate accounts synced from your on-premise Active Directory or users created in your own custom Azure Active Directory domain.</span></span> <span data-ttu-id="32a28-108">啟用 Windows Azure 驗證會設定您的應用程式使用單一[Azure Active Directory](https://docs.microsoft.com/azure/active-directory/)租使用者來驗證使用者。</span><span class="sxs-lookup"><span data-stu-id="32a28-108">Enabling Windows Azure Authentication configures your application to authenticate users using a single [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) tenant.</span></span>

<span data-ttu-id="32a28-109">本教學課程將說明如何建立 ASP.NET 應用程式，其已設定為使用[Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) （Azure AD）登入。</span><span class="sxs-lookup"><span data-stu-id="32a28-109">This tutorial will show you how to create an ASP.NET application that is configured for sign-on with [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD).</span></span> <span data-ttu-id="32a28-110">您也將瞭解如何呼叫圖形 API 來取得目前已登入使用者的相關資訊，以及如何將應用程式部署至 Azure。</span><span class="sxs-lookup"><span data-stu-id="32a28-110">You will also learn how to call the Graph API to get information about the currently signed-in user and how to deploy the application to Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="32a28-111">必要條件</span><span class="sxs-lookup"><span data-stu-id="32a28-111">Prerequisites</span></span>

1. <span data-ttu-id="32a28-112">適用于 Web 或 [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013) 的 [Visual Studio Express 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) 。</span><span class="sxs-lookup"><span data-stu-id="32a28-112">[Visual Studio Express 2013 for Web](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express) or [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013).</span></span>
2. <span data-ttu-id="32a28-113">需要[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) -Update 3 或更新版本。</span><span class="sxs-lookup"><span data-stu-id="32a28-113">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) - Update 3 or higher is required.</span></span>
3. <span data-ttu-id="32a28-114">一個 Azure 帳戶。</span><span class="sxs-lookup"><span data-stu-id="32a28-114">An Azure account.</span></span> <span data-ttu-id="32a28-115">如果您還沒有帳戶，[請按一下這裡](https://azure.microsoft.com/pricing/free-trial/)取得免費試用版。</span><span class="sxs-lookup"><span data-stu-id="32a28-115">[Click here](https://azure.microsoft.com/pricing/free-trial/) for a free trial if you do not already have an account.</span></span>

## <a name="add-a-global-administrator-to-your-active-directory"></a><span data-ttu-id="32a28-116">將全域管理員新增至您的 Active Directory</span><span class="sxs-lookup"><span data-stu-id="32a28-116">Add a Global Administrator to your Active Directory</span></span>

1. <span data-ttu-id="32a28-117">登入 [Azure 管理入口網站](https://manage.windowsazure.com/)。</span><span class="sxs-lookup"><span data-stu-id="32a28-117">Sign in to the [Azure Management Portal](https://manage.windowsazure.com/).</span></span>
2. <span data-ttu-id="32a28-118">所有 Azure 帳戶都包含**預設目錄**-按一下它，然後按一下頁面頂端的 [**使用者**] 索引標籤（請參閱下圖）。</span><span class="sxs-lookup"><span data-stu-id="32a28-118">All Azure accounts contain a **Default Directory** -- click on it, then click the **Users** tab at the top of the page (see image below).</span></span>
3. <span data-ttu-id="32a28-119">按一下 [新增使用者]。</span><span class="sxs-lookup"><span data-stu-id="32a28-119">Click Add User.</span></span>
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image1.png)
4. <span data-ttu-id="32a28-120">建立具有**全域管理員**角色的新使用者。</span><span class="sxs-lookup"><span data-stu-id="32a28-120">Create a new user with the **Global Administrator** role.</span></span> <span data-ttu-id="32a28-121">按一下頂端功能表中的 [**使用者**]，然後按一下命令列上的 [**新增使用者**] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="32a28-121">Click **Users** from the top menu, and then click the **Add User** button on the command bar.</span></span>
5. <span data-ttu-id="32a28-122">在 [新增**使用者**] 對話方塊中，輸入新使用者的名稱，然後按一下向右箭號。</span><span class="sxs-lookup"><span data-stu-id="32a28-122">In the **Add User** dialog, enter a name for the new user and then click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image2.png)
6. <span data-ttu-id="32a28-123">輸入使用者名稱，並將角色設定為**全域管理員**。</span><span class="sxs-lookup"><span data-stu-id="32a28-123">Enter the user name and set the role to **Global Administrator**.</span></span> <span data-ttu-id="32a28-124">全域管理員需要替代的電子郵件地址，才能進行密碼復原。</span><span class="sxs-lookup"><span data-stu-id="32a28-124">Global administrators require an alternate email address for password recovery purposes.</span></span> <span data-ttu-id="32a28-125">完成後，請按一下向右箭號。</span><span class="sxs-lookup"><span data-stu-id="32a28-125">After you're finished, click the right arrow.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image3.png)
7. <span data-ttu-id="32a28-126">在對話方塊的下一個頁面上，按一下 [**建立**]。</span><span class="sxs-lookup"><span data-stu-id="32a28-126">On the next page of the dialog, click **Create**.</span></span> <span data-ttu-id="32a28-127">系統會為新使用者建立暫時密碼，並顯示在對話方塊中。</span><span class="sxs-lookup"><span data-stu-id="32a28-127">A temporary password will be created for the new user and displayed in the dialog.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image4.png)

   <span data-ttu-id="32a28-128">儲存密碼，您將必須在第一次登入之後變更密碼。</span><span class="sxs-lookup"><span data-stu-id="32a28-128">Save the password, you will be required to change the password after the first log in.</span></span> <span data-ttu-id="32a28-129">下圖顯示新的系統管理員帳戶。</span><span class="sxs-lookup"><span data-stu-id="32a28-129">The following image shows the new admin account.</span></span> <span data-ttu-id="32a28-130">您必須使用 Azure Active Directory 來登入您的應用程式，而不是此頁面上顯示的 Microsoft 帳戶。</span><span class="sxs-lookup"><span data-stu-id="32a28-130">You must use the Azure Active Directory to log into your app, not the Microsoft account also shown on this page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image5.png)

## <a name="create-an-aspnet-application"></a><span data-ttu-id="32a28-131">建立 ASP.NET 應用程式</span><span class="sxs-lookup"><span data-stu-id="32a28-131">Create an ASP.NET Application</span></span>

<span data-ttu-id="32a28-132">下列步驟會使用[適用于 Web 的 Visual Studio Express 2013](https://www.microsoft.com/download/details.aspx?id=40747)，而且需要[Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721)。</span><span class="sxs-lookup"><span data-stu-id="32a28-132">The following steps use [Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747), and requires [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721).</span></span>

1. <span data-ttu-id="32a28-133">在 Visual Studio 中，依**序按一下 [** 檔案] 和 [**新增專案**]。</span><span class="sxs-lookup"><span data-stu-id="32a28-133">In Visual Studio, click **File** and then **New Project**.</span></span> <span data-ttu-id="32a28-134">在 [**新增專案**] 對話方塊中，從C#左側功能表中選取 [Visual Web 專案]，然後按一下 **[確定]** 。</span><span class="sxs-lookup"><span data-stu-id="32a28-134">On the **New Project** dialog, select the Visual C# Web project from the left menu and click **OK**.</span></span> <span data-ttu-id="32a28-135">如果您不想要應用程式的功能，您可能也會想要取消核取 [**將 Application Insights 新增至專案**]。</span><span class="sxs-lookup"><span data-stu-id="32a28-135">You may also want to uncheck the **Add Application Insights to Project** if you don't want the functionality for your application.</span></span>
2. <span data-ttu-id="32a28-136">在 [**新增 ASP.NET 專案**] 對話方塊中，選取 [ **MVC**]，然後按一下 [**變更驗證**]。</span><span class="sxs-lookup"><span data-stu-id="32a28-136">In the **New ASP.NET Project** dialog, select **MVC**, and then click **Change Authentication**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image6.png)
3. <span data-ttu-id="32a28-137">在 [**變更驗證**] 對話方塊中，選取 [**組織帳戶**]。</span><span class="sxs-lookup"><span data-stu-id="32a28-137">On the **Change Authentication** dialog, select **Organizational Accounts**.</span></span> <span data-ttu-id="32a28-138">這些選項可用來自動向 Azure AD 註冊您的應用程式，以及自動設定您的應用程式以與 Azure AD 整合。</span><span class="sxs-lookup"><span data-stu-id="32a28-138">These options can be used to automatically register your application with Azure AD as well as automatically configure your application to integrate with Azure AD.</span></span> <span data-ttu-id="32a28-139">您不需要使用 [**變更驗證**] 對話方塊來註冊及設定您的應用程式，但這樣做會更輕鬆。</span><span class="sxs-lookup"><span data-stu-id="32a28-139">You don't have to use the **Change Authentication** dialog to register and configure your application, but it makes it much easier.</span></span> <span data-ttu-id="32a28-140">例如，如果您使用 Visual Studio 2012，您仍然可以在 Azure 管理入口網站中手動註冊應用程式，並更新其設定以與 Azure AD 整合。</span><span class="sxs-lookup"><span data-stu-id="32a28-140">If you are using Visual Studio 2012 for example, you can still manually register the application in the Azure Management Portal and update its configuration to integrate with Azure AD.</span></span>
   <span data-ttu-id="32a28-141">在下拉式功能表中，選取 [**雲端-單一組織**] 和 [**單一登入]、[讀取目錄資料**]。</span><span class="sxs-lookup"><span data-stu-id="32a28-141">In the drop-down menus, select **Cloud - Single Organization** and **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="32a28-142">輸入 Azure AD 目錄的網域（例如，在下列映射中） *aricka0yahoo.onmicrosoft.com*，然後按一下 **[確定]** 。</span><span class="sxs-lookup"><span data-stu-id="32a28-142">Enter the domain for your Azure AD directory, for example (in the images below) *aricka0yahoo.onmicrosoft.com*, and then click **OK**.</span></span> <span data-ttu-id="32a28-143">您可以從 azure 入口網站上預設目錄的 [網域] 索引標籤中取得功能變數名稱（請參閱下一個影像）。</span><span class="sxs-lookup"><span data-stu-id="32a28-143">You can get the domain name from the Domains tab for the Default Directory on the azure portal (see the next image down).</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image7.png)

   <span data-ttu-id="32a28-144">下圖顯示來自 Azure 入口網站的功能變數名稱。</span><span class="sxs-lookup"><span data-stu-id="32a28-144">The following image shows the domain name from the Azure portal.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image8.png)

    > [!NOTE]
    > <span data-ttu-id="32a28-145">您可以按一下 [**更多選項**]，選擇性地設定將在 Azure AD 中註冊的應用程式識別碼 URI。</span><span class="sxs-lookup"><span data-stu-id="32a28-145">You can optionally configure the Application ID URI that will be registered in Azure AD by clicking **More Options**.</span></span> <span data-ttu-id="32a28-146">[應用程式識別碼 URI] 是應用程式的唯一識別碼，會在 Azure AD 中註冊，並在與 Azure AD 通訊時供應用程式用來識別自己的身分。</span><span class="sxs-lookup"><span data-stu-id="32a28-146">The App ID URI is the unique identifier for an application, which is registered in Azure AD and used by the application to identify itself when communicating with Azure AD.</span></span> <span data-ttu-id="32a28-147">如需應用程式識別碼 URI 和已註冊應用程式之其他屬性的詳細資訊，請參閱[這個主題](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering)。</span><span class="sxs-lookup"><span data-stu-id="32a28-147">For more information about the App ID URI and other properties of registered applications, see [this topic](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span></span> <span data-ttu-id="32a28-148">按一下 [應用程式識別碼 URI] 欄位下方的核取方塊，您也可以選擇覆寫使用相同應用程式識別碼 URI 之 Azure AD 中的現有註冊。</span><span class="sxs-lookup"><span data-stu-id="32a28-148">By clicking the checkbox below the App ID URI field, you can also choose to overwrite an existing registration in Azure AD that uses the same App ID URI.</span></span>
4. <span data-ttu-id="32a28-149">按一下 **[確定**] 之後，就會出現登入對話方塊，您必須使用全域管理員帳戶（而不是與您的訂用帳戶相關聯的 Microsoft 帳戶）登入。</span><span class="sxs-lookup"><span data-stu-id="32a28-149">After clicking **OK**, a sign-in dialog will appear, and you'll need to sign in using a Global Administrator account (not the Microsoft account associated with your subscription).</span></span> <span data-ttu-id="32a28-150">如果您稍早建立了新的系統管理員帳戶，則必須變更密碼，然後使用新密碼重新登入。</span><span class="sxs-lookup"><span data-stu-id="32a28-150">If you created a new Administrator account earlier, you'll be required to change the password and then sign in again using the new password.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image9.png)
5. <span data-ttu-id="32a28-151">成功驗證之後，[**新增 ASP.NET 專案**] 對話方塊會顯示您的驗證選擇（**組織**）和新應用程式註冊所在的目錄（下圖中的*aricka0yahoo.onmicrosoft.com* ）。</span><span class="sxs-lookup"><span data-stu-id="32a28-151">After you've successfully authenticated, the **New ASP.NET Project** dialog will show your authentication choice (**Organizational** ) and the directory where the new application will be registered (*aricka0yahoo.onmicrosoft.com* in the image below).</span></span> <span data-ttu-id="32a28-152">在此資訊底下，選取標示為 **[主機在雲端中**] 的核取方塊。</span><span class="sxs-lookup"><span data-stu-id="32a28-152">Below this information, select the checkbox labeled **Host in the cloud**.</span></span> <span data-ttu-id="32a28-153">如果選取此核取方塊，專案將會布建為 Azure web 應用程式，並將于稍後啟用以方便發行。</span><span class="sxs-lookup"><span data-stu-id="32a28-153">If this checkbox is selected, the project will be provisioned as an Azure web app and will be enabled for easy publishing later.</span></span> <span data-ttu-id="32a28-154">按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="32a28-154">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image10.png)
6. <span data-ttu-id="32a28-155">[**設定 Azure 網站**] 對話方塊隨即出現，並使用自動產生的網站名稱和區域。</span><span class="sxs-lookup"><span data-stu-id="32a28-155">The **Configure Azure Website** dialog will appear, using an auto-generated site name and region.</span></span> <span data-ttu-id="32a28-156">另請注意您目前在對話方塊中登入的帳戶。</span><span class="sxs-lookup"><span data-stu-id="32a28-156">Also note the account you're currently signed into in the dialog.</span></span> <span data-ttu-id="32a28-157">您想要確保此帳戶是您的 Azure 訂用帳戶所連接的帳戶，通常是 Microsoft 帳戶。</span><span class="sxs-lookup"><span data-stu-id="32a28-157">You want to make sure that this account is the one that your Azure subscription is attached to, typically a Microsoft account.</span></span>

    > [!NOTE]
    > <span data-ttu-id="32a28-158">此專案需要資料庫。</span><span class="sxs-lookup"><span data-stu-id="32a28-158">This project requires a database.</span></span> <span data-ttu-id="32a28-159">您必須選取其中一個現有的資料庫，或建立一個新的。</span><span class="sxs-lookup"><span data-stu-id="32a28-159">You need to select one of your existing databases, or create a new one.</span></span> <span data-ttu-id="32a28-160">資料庫是必要的，因為專案已經使用本機資料庫檔案來儲存少量的驗證設定資料。</span><span class="sxs-lookup"><span data-stu-id="32a28-160">A database is required because the project already uses a local database file to store a small amount of authentication configuration data.</span></span> <span data-ttu-id="32a28-161">當您將應用程式部署至 Azure 網站時，此資料庫不會隨部署封裝，因此您必須選擇可在雲端中存取的資料庫。</span><span class="sxs-lookup"><span data-stu-id="32a28-161">When you deploy the application to an Azure Website, this database isn't packaged with the deployment, so you need to choose one that's accessible in the cloud.</span></span> <span data-ttu-id="32a28-162">按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="32a28-162">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image11.png)
7. <span data-ttu-id="32a28-163">將會建立專案，而且您的驗證選項和 web 應用程式選項會自動以專案設定。</span><span class="sxs-lookup"><span data-stu-id="32a28-163">The project will be created, and your authentication options and web app options will be automatically configured with the project.</span></span> <span data-ttu-id="32a28-164">完成此程式之後，請按 **^ F5**在本機執行專案。</span><span class="sxs-lookup"><span data-stu-id="32a28-164">Once this process has completed, run the project locally by pressing **^F5**.</span></span> <span data-ttu-id="32a28-165">您將必須使用您的組織帳戶登入。</span><span class="sxs-lookup"><span data-stu-id="32a28-165">You will be required to sign in using your organizational account.</span></span> <span data-ttu-id="32a28-166">提供您稍早建立之帳戶的使用者名稱和密碼，然後按一下 [登**入**]。</span><span class="sxs-lookup"><span data-stu-id="32a28-166">Provide the username and password for the account you created earlier and click **Sign in**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image12.png)
8. <span data-ttu-id="32a28-167">成功登入之後，ASP.NET 網站會顯示您已透過在頁面右上角顯示使用者名稱的方式進行驗證。</span><span class="sxs-lookup"><span data-stu-id="32a28-167">After successful sign in, the ASP.NET site will show that you've authenticated by displaying the username in the top right corner of the page.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image13.png)

   <span data-ttu-id="32a28-168">如果您收到錯誤：值不能為 null 或空白。</span><span class="sxs-lookup"><span data-stu-id="32a28-168">If you get the error: Value cannot be null or empty.</span></span> <span data-ttu-id="32a28-169">參數名稱： Linktext> ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="32a28-169">Parameter name: linkText ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)</span></span>

   <span data-ttu-id="32a28-170">請參閱本教學課程結尾的[debug](#dbg)一節。</span><span class="sxs-lookup"><span data-stu-id="32a28-170">see the [debug](#dbg) section at the end of the tutorial.</span></span>

## <a name="basics-of-the-graph-api"></a><span data-ttu-id="32a28-171">圖形 API 的基本概念</span><span class="sxs-lookup"><span data-stu-id="32a28-171">Basics of the Graph API</span></span>

<span data-ttu-id="32a28-172">[圖形 API](https://msdn.microsoft.com/library/azure/hh974476.aspx)是用來在 Azure AD 目錄中的物件上執行 CRUD 和其他作業的程式設計介面。</span><span class="sxs-lookup"><span data-stu-id="32a28-172">[The Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) is the programmatic interface used to perform CRUD and other operations on objects in your Azure AD directory.</span></span> <span data-ttu-id="32a28-173">如果您在 Visual Studio 2013 中建立新專案時選取 [組織帳戶] 選項進行驗證，則您的應用程式將已設定為呼叫圖形 API。</span><span class="sxs-lookup"><span data-stu-id="32a28-173">If you select an Organizational Account option for authentication when creating a new project in Visual Studio 2013, your application will already be configured to call the Graph API.</span></span> <span data-ttu-id="32a28-174">本節將簡短說明圖形 API 的運作方式。</span><span class="sxs-lookup"><span data-stu-id="32a28-174">This section briefly shows you how the Graph API works.</span></span>

1. <span data-ttu-id="32a28-175">在執行中的應用程式中，按一下頁面右上方的已登入使用者名稱。</span><span class="sxs-lookup"><span data-stu-id="32a28-175">In your running application, click on the name of the signed-in user at the top right of the page.</span></span> <span data-ttu-id="32a28-176">這會帶您前往 [使用者設定檔] 頁面，這是主控制器上的動作。</span><span class="sxs-lookup"><span data-stu-id="32a28-176">This will take you to the User Profile page, which is an action on the Home Controller.</span></span> <span data-ttu-id="32a28-177">您會發現資料表包含您稍早建立之系統管理員帳戶的相關使用者資訊。</span><span class="sxs-lookup"><span data-stu-id="32a28-177">You'll notice that the table contains user information about the administrator account you created earlier.</span></span> <span data-ttu-id="32a28-178">這項資訊會儲存在您的目錄中，並在頁面載入時呼叫圖形 API 來取得此資訊。</span><span class="sxs-lookup"><span data-stu-id="32a28-178">This information is stored in your directory, and the Graph API is called to retrieve this information when the page loads.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image15.png)
2. <span data-ttu-id="32a28-179">返回 Visual Studio 並展開 [**控制器**] 資料夾，然後開啟**HomeController.cs**檔案。</span><span class="sxs-lookup"><span data-stu-id="32a28-179">Go back to Visual Studio and expand the **Controllers** folder and then open the **HomeController.cs** file.</span></span> <span data-ttu-id="32a28-180">您會看到一個**UserProfile （）** 動作，其中包含用來抓取權杖的程式碼，然後呼叫圖形 API。</span><span class="sxs-lookup"><span data-stu-id="32a28-180">You'll see a **UserProfile()** action that contains code to retrieve a token and then call the Graph API.</span></span> <span data-ttu-id="32a28-181">這段程式碼複製如下：</span><span class="sxs-lookup"><span data-stu-id="32a28-181">This code is duplicated below:</span></span>

    [!code-csharp[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample1.cs?highlight=22)]

    <span data-ttu-id="32a28-182">若要呼叫圖形 API，您必須先取得權杖。</span><span class="sxs-lookup"><span data-stu-id="32a28-182">To call the Graph API, you first need to retrieve a token.</span></span> <span data-ttu-id="32a28-183">取得權杖時，必須將其字串值附加至圖形 API 的所有後續要求的授權標頭中。</span><span class="sxs-lookup"><span data-stu-id="32a28-183">When the token is retrieved, its string value must be appended in the Authorization header for all subsequent requests to the Graph API.</span></span> <span data-ttu-id="32a28-184">上述大部分程式碼會處理 Azure AD 的驗證詳細資料，以取得權杖、使用權杖來呼叫圖形 API，然後再轉換回應，以便在視圖中顯示。</span><span class="sxs-lookup"><span data-stu-id="32a28-184">Most of the code above handles the details of authenticating to Azure AD to get a token, using the token to make a call to the Graph API, and then transforming the response so that it can be presented in the View.</span></span>

    <span data-ttu-id="32a28-185">討論的最相關部分是下列醒目提示的程式程式碼： `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`。</span><span class="sxs-lookup"><span data-stu-id="32a28-185">The most relevant portion for discussion is the following highlighted line: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span></span> <span data-ttu-id="32a28-186">這一行代表已從 JSON 回應還原序列化並在視圖中顯示的使用者名稱。</span><span class="sxs-lookup"><span data-stu-id="32a28-186">This line represents the name of the user, which has been deserialized from the JSON response and is presented in the View.</span></span>

    <span data-ttu-id="32a28-187">您可以使用 HttpClient 呼叫圖形 API 並自行處理原始資料，但更簡單的方法是使用[Graph 用戶端程式庫（可透過 NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/)取得）。</span><span class="sxs-lookup"><span data-stu-id="32a28-187">You can call the Graph API using HttpClient and handle the raw data yourself, but an easier way is to use the [Graph Client Library which is available via NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span></span> <span data-ttu-id="32a28-188">用戶端程式庫會為您處理原始的 HTTP 要求並轉換傳回的資料，讓您更輕鬆地在 .NET 環境中使用圖形 API。</span><span class="sxs-lookup"><span data-stu-id="32a28-188">The Client Library handles the raw HTTP requests and the transformation of the returned data for you, and makes it much easier to work with the Graph API in a .NET environment.</span></span> <span data-ttu-id="32a28-189">請參閱 GitHub 上的相關圖形 API 程式碼範例[。](https://github.com/AzureADSamples)</span><span class="sxs-lookup"><span data-stu-id="32a28-189">See the related Graph API code samples on [GitHub.](https://github.com/AzureADSamples)</span></span>

## <a name="deploy-the-application-to-azure"></a><span data-ttu-id="32a28-190">將應用程式部署至 Azure</span><span class="sxs-lookup"><span data-stu-id="32a28-190">Deploy the Application to Azure</span></span>

<span data-ttu-id="32a28-191">下列步驟將說明如何將應用程式部署至 Azure。</span><span class="sxs-lookup"><span data-stu-id="32a28-191">The following steps will show you how to deploy the application to Azure.</span></span> <span data-ttu-id="32a28-192">在先前的步驟中，您已將新的專案與 Azure 上的 web 應用程式連線，因此只需幾個步驟就可以發佈。</span><span class="sxs-lookup"><span data-stu-id="32a28-192">In the earlier steps, you connected your new project with a web app on Azure, so it's ready to be published in just a few steps.</span></span>

1. <span data-ttu-id="32a28-193">在 Visual Studio 中，以滑鼠右鍵按一下專案，然後選取 [**發佈**]。</span><span class="sxs-lookup"><span data-stu-id="32a28-193">In Visual Studio, right-click on the project and select **Publish**.</span></span> <span data-ttu-id="32a28-194">[**發行 Web** ] 對話方塊隨即出現，並顯示每個設定。</span><span class="sxs-lookup"><span data-stu-id="32a28-194">The **Publish Web** dialog will appear with each setting already configured.</span></span> <span data-ttu-id="32a28-195">按 [**下一步]** 按鈕以移至 [**設定**] 頁面。</span><span class="sxs-lookup"><span data-stu-id="32a28-195">Click on the **Next** button to go to the **Settings** page.</span></span> <span data-ttu-id="32a28-196">系統可能會提示您進行驗證;請務必使用您的 Azure 訂用帳戶（通常是 Microsoft 帳戶），而不是您稍早建立的組織帳戶進行驗證。</span><span class="sxs-lookup"><span data-stu-id="32a28-196">You may be prompted to authenticate; make sure you authenticate using your Azure subscription account (typically a Microsoft account) and not the organizational account you created earlier.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image16.png)
2. <span data-ttu-id="32a28-197">勾選 [**啟用組織驗證**] 選項。</span><span class="sxs-lookup"><span data-stu-id="32a28-197">Check the **Enable Organizational Authentication** option.</span></span> <span data-ttu-id="32a28-198">在 [**網域**] 欄位中，輸入您目錄的網域。</span><span class="sxs-lookup"><span data-stu-id="32a28-198">In the **Domain** field, enter the domain for your directory.</span></span> <span data-ttu-id="32a28-199">從 [**存取層級**] 下拉式選單中，選取 [**單一登入]、[讀取目錄資料**]。</span><span class="sxs-lookup"><span data-stu-id="32a28-199">From the **Access Level** drop-down, select **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="32a28-200">您會發現，您所使用的先前資料庫已填入 [**資料庫**] 區段中。</span><span class="sxs-lookup"><span data-stu-id="32a28-200">You'll notice that the previous database you used is already populated in the **Databases** section.</span></span> <span data-ttu-id="32a28-201">按一下 [發行]。</span><span class="sxs-lookup"><span data-stu-id="32a28-201">Click **Publish**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image17.png)
3. <span data-ttu-id="32a28-202">Visual Studio 會開始部署您的網站，然後會出現新的瀏覽器視窗。</span><span class="sxs-lookup"><span data-stu-id="32a28-202">Visual Studio will begin deploying your website, and then a new browser window will appear.</span></span> <span data-ttu-id="32a28-203">系統可能會提示您再次向您的目錄進行驗證。</span><span class="sxs-lookup"><span data-stu-id="32a28-203">You may be prompted to authenticate to your directory once again.</span></span> <span data-ttu-id="32a28-204">經過驗證之後，系統會將您重新導向至 Azure 上新發佈的網站。</span><span class="sxs-lookup"><span data-stu-id="32a28-204">Once you've authenticated, you'll be redirected to your newly published website on Azure.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image18.png)

<a id="dbg"></a>
## <a name="debugging-the-app"></a><span data-ttu-id="32a28-205">偵錯工具</span><span class="sxs-lookup"><span data-stu-id="32a28-205">Debugging the app</span></span>

<span data-ttu-id="32a28-206">如果您收到下列錯誤訊息：值不能為 null 或空白。</span><span class="sxs-lookup"><span data-stu-id="32a28-206">If you get the following error: Value cannot be null or empty.</span></span> <span data-ttu-id="32a28-207">參數名稱： Linktext></span><span class="sxs-lookup"><span data-stu-id="32a28-207">Parameter name: linkText</span></span>

![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image19.png)

<span data-ttu-id="32a28-208">以下列內容取代*Views\Shared\\_LoginPartial. cshtml*檔案中的程式碼：</span><span class="sxs-lookup"><span data-stu-id="32a28-208">Replace the code in the *Views\Shared\\_LoginPartial.cshtml* file with the following:</span></span>

[!code-cshtml[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample2.cshtml?highlight=1-8,15-16)]

<span data-ttu-id="32a28-209">執行應用程式之後，如果登入的使用者顯示「Null 使用者」，請登出，然後使用您稍早建立的 Active Directory 帳戶重新登入。</span><span class="sxs-lookup"><span data-stu-id="32a28-209">After running the app, if the logged in user shows "Null User", sign out, and sign back in with the Active Directory account you created earlier.</span></span>

<span data-ttu-id="32a28-210">Rick Rainey [深入探討，這是一種要遵循的絕佳教學課程：使用 Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)的 Azure 網站和組織驗證。</span><span class="sxs-lookup"><span data-stu-id="32a28-210">An excellent tutorial to follow is Rick Rainey's [Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span></span>

## <a name="more-information"></a><span data-ttu-id="32a28-211">更多資訊</span><span class="sxs-lookup"><span data-stu-id="32a28-211">More Information</span></span>

- <span data-ttu-id="32a28-212">[深入了解：使用 Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/) 的 Azure 網站和組織驗證</span><span class="sxs-lookup"><span data-stu-id="32a28-212">[Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)</span></span>
- [<span data-ttu-id="32a28-213">Azure AD 圖形 API 總覽</span><span class="sxs-lookup"><span data-stu-id="32a28-213">Azure AD Graph API Overview</span></span>](https://msdn.microsoft.com/library/azure/hh974476.aspx)
- [<span data-ttu-id="32a28-214">Azure AD 中的驗證案例</span><span class="sxs-lookup"><span data-stu-id="32a28-214">Authentication Scenarios in Azure AD</span></span>](https://msdn.microsoft.com/library/azure/dn499820.aspx)
- [<span data-ttu-id="32a28-215">GitHub 上的 Azure AD 程式碼範例</span><span class="sxs-lookup"><span data-stu-id="32a28-215">Azure AD Code Samples on GitHub</span></span>](https://github.com/AzureADSamples)
