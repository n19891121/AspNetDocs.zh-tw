---
uid: identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
title: 將 ASP.NET Identity 新增至空白或現有的 Web form 專案-ASP.NET 4。x
author: raquelsa
description: 本教學課程說明如何將 ASP.NET Identity （ASP.NET 的成員資格系統）新增至 ASP.NET 應用程式。 當您建立新的 Web form 或 MVC 時 。
ms.author: riande
ms.date: 01/22/2019
ms.assetid: 1cbc0ed2-5bd6-4b62-8d34-4c193dcd8b25
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
msc.type: authoredcontent
ms.openlocfilehash: 8e82951d57f0b8052ee3f6530a7470be7d030206
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78584123"
---
# <a name="adding-aspnet-identity-to-an-empty-or-existing-web-forms-project"></a><span data-ttu-id="6e621-104">將 ASP.NET Identity 新增至空的或現有的 Web Form 專案</span><span class="sxs-lookup"><span data-stu-id="6e621-104">Adding ASP.NET Identity to an Empty or Existing Web Forms Project</span></span>

> <span data-ttu-id="6e621-105">本教學課程說明如何將[ASP.NET Identity](introduction-to-aspnet-identity.md) （ASP.NET 的新成員資格系統）新增至 ASP.NET 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6e621-105">This tutorial shows you how to add [ASP.NET Identity](introduction-to-aspnet-identity.md) (the new membership system for ASP.NET) to an ASP.NET application.</span></span>
> 
> <span data-ttu-id="6e621-106">當您使用個別帳戶在 Visual Studio 2017 RTM 中建立新的 Web form 或 MVC 專案時，Visual Studio 會安裝所有必要的套件，並為您新增所有必要的類別。</span><span class="sxs-lookup"><span data-stu-id="6e621-106">When you create a new Web Forms or MVC project in Visual Studio 2017 RTM with Individual Accounts, Visual Studio will install all the required packages and add all necessary classes for you.</span></span> <span data-ttu-id="6e621-107">本教學課程將說明將 ASP.NET Identity 支援加入現有 Web Forms 專案或新的空白專案的步驟。</span><span class="sxs-lookup"><span data-stu-id="6e621-107">This tutorial will illustrate the steps to add ASP.NET Identity support to your existing Web Forms project or a new empty project.</span></span> <span data-ttu-id="6e621-108">我將概述您需要安裝的所有 NuGet 套件，以及您需要新增的類別。</span><span class="sxs-lookup"><span data-stu-id="6e621-108">I will outline all the NuGet packages you need to install, and classes you need to add.</span></span> <span data-ttu-id="6e621-109">我將探討用來註冊新使用者和登入的範例 Web 表單，同時強調所有主要進入點 Api 以進行使用者管理和驗證。</span><span class="sxs-lookup"><span data-stu-id="6e621-109">I will go over sample Web Forms for registering new users and logging in while highlighting all main entry point APIs for user management and authentication.</span></span> <span data-ttu-id="6e621-110">這個範例會針對以 Entity Framework 為基礎的 SQL 資料儲存體，使用 ASP.NET Identity 預設的執行。</span><span class="sxs-lookup"><span data-stu-id="6e621-110">This sample will use the ASP.NET Identity default implementation for SQL data storage which is built on Entity Framework.</span></span> <span data-ttu-id="6e621-111">本教學課程中，我們將使用 LocalDB 作為 SQL database。</span><span class="sxs-lookup"><span data-stu-id="6e621-111">This tutorial, we will use LocalDB for the SQL database.</span></span>
> 

## <a name="get-started-with-aspnet-identity"></a><span data-ttu-id="6e621-112">開始使用 ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="6e621-112">Get started with ASP.NET Identity</span></span>

1. <span data-ttu-id="6e621-113">從安裝和執行[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/)開始。</span><span class="sxs-lookup"><span data-stu-id="6e621-113">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/).</span></span>
2. <span data-ttu-id="6e621-114">從 [開始] 頁面選取 [**新增專案**]，或者您可以使用功能表並依**序選取 [** 檔案] 和 [**新增專案**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-114">Select **New Project** from the Start page, or you can use the menu and select **File**, and then **New Project**.</span></span>
3. <span data-ttu-id="6e621-115">在左窗格中，依序展開 [**視覺效果C#** ] 和 [ **web**]，然後選取 [ **ASP.NET Web 應用程式（.net Framework）** ]。</span><span class="sxs-lookup"><span data-stu-id="6e621-115">In the left pane, expand **Visual C#**, then select **Web**, then **ASP.NET Web Application (.Net Framework)**.</span></span> <span data-ttu-id="6e621-116">將專案命名為 "WebFormsIdentity"，然後選取 **[確定]** 。</span><span class="sxs-lookup"><span data-stu-id="6e621-116">Name your project "WebFormsIdentity" and select **OK**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image17.png)
4. <span data-ttu-id="6e621-117">在 [**新增 ASP.NET 專案**] 對話方塊中，選取 [**空白**] 範本。</span><span class="sxs-lookup"><span data-stu-id="6e621-117">In the **New ASP.NET Project** dialog, select the **Empty** template.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image2.png)  
  
   <span data-ttu-id="6e621-118">請注意，[**變更驗證**] 按鈕已停用，而且此範本未提供任何驗證支援。</span><span class="sxs-lookup"><span data-stu-id="6e621-118">Notice the **Change Authentication** button is disabled and no authentication support is provided in this template.</span></span> <span data-ttu-id="6e621-119">Web Forms、MVC 和 Web API 範本可讓您選取驗證方法。</span><span class="sxs-lookup"><span data-stu-id="6e621-119">The Web Forms, MVC and Web API templates allow you to select the authentication approach.</span></span>

## <a name="add-identity-packages-to-your-app"></a><span data-ttu-id="6e621-120">將身分識別套件新增至您的應用程式</span><span class="sxs-lookup"><span data-stu-id="6e621-120">Add Identity packages to your app</span></span>

<span data-ttu-id="6e621-121">在方案總管中，以滑鼠右鍵按一下您的專案，然後選取 [**管理 NuGet 套件**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-121">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="6e621-122">搜尋**EntityFramework**套件，並安裝。</span><span class="sxs-lookup"><span data-stu-id="6e621-122">Search for and install the **Microsoft.AspNet.Identity.EntityFramework** package.</span></span> 
  
![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image15.png)
  
<span data-ttu-id="6e621-123">請注意，此封裝將會安裝相依性套件： **EntityFramework**和**Microsoft ASP.NET 身分識別核心**。</span><span class="sxs-lookup"><span data-stu-id="6e621-123">Note that this package will install the dependency packages: **EntityFramework** and **Microsoft ASP.NET Identity Core**.</span></span>

## <a name="add-a-web-form-to-register-users"></a><span data-ttu-id="6e621-124">新增 web 表單以註冊使用者</span><span class="sxs-lookup"><span data-stu-id="6e621-124">Add a web form to register users</span></span>

1. <span data-ttu-id="6e621-125">在**方案總管**中，以滑鼠右鍵按一下您的專案，然後依序選取 [**新增**] 和 [ **Web 表單**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-125">In **Solution Explorer**, right-click your project and select **Add**, and then **Web Form**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image4.png)
2. <span data-ttu-id="6e621-126">在 [**指定專案的名稱**] 對話方塊中，為新的 web 表單**註冊**命名，然後選取 **[確定]** 。</span><span class="sxs-lookup"><span data-stu-id="6e621-126">In the **Specify Name for Item** dialog box, name the new web form **Register**, and then select **OK**</span></span>
3. <span data-ttu-id="6e621-127">將產生的*Register .aspx*檔案中的標記取代為下列程式碼。</span><span class="sxs-lookup"><span data-stu-id="6e621-127">Replace the markup in the generated *Register.aspx* file with the code below.</span></span> <span data-ttu-id="6e621-128">程式碼變更已醒目提示。</span><span class="sxs-lookup"><span data-stu-id="6e621-128">The code changes are highlighted.</span></span> 

    [!code-html[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample1.aspx?highlight=9,12-40)]

    > [!NOTE]
    > <span data-ttu-id="6e621-129">這只是當您建立新的 ASP.NET Web form 專案時，所建立的*Register .aspx*檔案的簡化版本。</span><span class="sxs-lookup"><span data-stu-id="6e621-129">This is just a simplified version of the *Register.aspx* file that is created when you create a new ASP.NET Web Forms project.</span></span> <span data-ttu-id="6e621-130">上述標記會新增表單欄位和按鈕來註冊新的使用者。</span><span class="sxs-lookup"><span data-stu-id="6e621-130">The markup above adds form fields and a button to register a new user.</span></span>
4. <span data-ttu-id="6e621-131">開啟*Register.aspx.cs*檔案，並以下列程式碼取代檔案的內容：</span><span class="sxs-lookup"><span data-stu-id="6e621-131">Open the *Register.aspx.cs* file and replace the contents of the file with the following code:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample2.cs)]

    > [!NOTE] 
    > 
    > 1. <span data-ttu-id="6e621-132">上述程式碼是*Register.aspx.cs*檔案的簡化版本，當您建立新的 ASP.NET Web Forms 專案時會建立此檔案。</span><span class="sxs-lookup"><span data-stu-id="6e621-132">The code above is a simplified version of the *Register.aspx.cs* file that is created when you create a new ASP.NET Web Forms project.</span></span>
    > 2. <span data-ttu-id="6e621-133">*IdentityUser*類別是*IUser*介面的預設 EntityFramework 執行。</span><span class="sxs-lookup"><span data-stu-id="6e621-133">The *IdentityUser* class is the default EntityFramework implementation of the *IUser* interface.</span></span> <span data-ttu-id="6e621-134">*IUser*介面是 ASP.NET Identity 核心上使用者的最基本介面。</span><span class="sxs-lookup"><span data-stu-id="6e621-134">*IUser* interface is the minimal interface for a user on ASP.NET Identity Core.</span></span>
    > 3. <span data-ttu-id="6e621-135">*UserStore*類別是使用者存放區的預設 EntityFramework 執行。</span><span class="sxs-lookup"><span data-stu-id="6e621-135">The *UserStore* class is the default EntityFramework implementation of a user store.</span></span> <span data-ttu-id="6e621-136">這個類別會實 ASP.NET Identity 核心的最基本介面： *IUserStore*、 *IUserLoginStore*、 *IUserClaimStore*和*IUserRoleStore*。</span><span class="sxs-lookup"><span data-stu-id="6e621-136">This class implements the ASP.NET Identity Core's minimal interfaces: *IUserStore*, *IUserLoginStore*, *IUserClaimStore* and *IUserRoleStore*.</span></span>
    > 4. <span data-ttu-id="6e621-137">*UserManager*類別會公開使用者相關的 api，其會自動將變更儲存至*UserStore*。</span><span class="sxs-lookup"><span data-stu-id="6e621-137">The *UserManager* class exposes user related APIs which will automatically save changes to the *UserStore*.</span></span>
    > 5. <span data-ttu-id="6e621-138">*IdentityResult*類別代表身分識別作業的結果。</span><span class="sxs-lookup"><span data-stu-id="6e621-138">The *IdentityResult* class represents the result of an identity operation.</span></span>
5. <span data-ttu-id="6e621-139">在**方案總管**中，以滑鼠右鍵按一下您的專案，然後選取 [**新增**]、[**新增 ASP.NET 資料夾**] 和 [**應用程式\_資料**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-139">In **Solution Explorer**, right-click your project and select **Add**, **Add ASP.NET Folder** and then **App\_Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image5.png)
6. <span data-ttu-id="6e621-140">開啟*web.config*檔案，並為我們將用來儲存使用者資訊的資料庫新增連接字串專案。</span><span class="sxs-lookup"><span data-stu-id="6e621-140">Open the *Web.config* file and add a connection string entry for the database we will use to store user information.</span></span> <span data-ttu-id="6e621-141">資料庫將會在執行時間透過 EntityFramework 識別實體來建立。</span><span class="sxs-lookup"><span data-stu-id="6e621-141">The database will be created at runtime by EntityFramework for the Identity entities.</span></span> <span data-ttu-id="6e621-142">當您建立新的 Web form 專案時，連接字串類似于為您建立的。</span><span class="sxs-lookup"><span data-stu-id="6e621-142">The connection string is similar to one created for you when you create a new Web Forms project.</span></span> <span data-ttu-id="6e621-143">反白顯示的程式碼會顯示您應該新增的標記：</span><span class="sxs-lookup"><span data-stu-id="6e621-143">The highlighted code shows the markup you should add:</span></span>

    [!code-xml[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample3.xml?highlight=11-14)]
    
    > [!NOTE] 
    > <span data-ttu-id="6e621-144">若為 Visual Studio 2015 或更高版本，請將 `(localdb)\v11.0` 取代為連接字串中的 `(localdb)\MSSQLLocalDB`。</span><span class="sxs-lookup"><span data-stu-id="6e621-144">For Visual Studio 2015 or higher, replace `(localdb)\v11.0` with `(localdb)\MSSQLLocalDB` in your connection string.</span></span>
    
7. <span data-ttu-id="6e621-145">以滑鼠右鍵按一下專案*中的 [* 檔案] [登錄]，然後選取 [**設定為起始頁**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-145">Right click file *Register.aspx* in your project and select **Set as Start Page**.</span></span> <span data-ttu-id="6e621-146">按 Ctrl + F5 以建立並執行 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6e621-146">Press Ctrl + F5 to build and run the web application.</span></span> <span data-ttu-id="6e621-147">輸入新的 [使用者名稱] 和 [密碼]，然後選取 [**註冊**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-147">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image6.png)  

    > [!NOTE]
    > <span data-ttu-id="6e621-148">ASP.NET Identity 支援驗證，在此範例中，您可以確認來自身分識別核心套件的使用者和密碼驗證程式的預設行為。</span><span class="sxs-lookup"><span data-stu-id="6e621-148">ASP.NET Identity has support for validation and in this sample you can verify the default behavior on User and Password validators that come from the Identity Core package.</span></span> <span data-ttu-id="6e621-149">使用者的預設驗證程式（`UserValidator`）有一個屬性 `AllowOnlyAlphanumericUserNames`，其預設值設為 `true`。</span><span class="sxs-lookup"><span data-stu-id="6e621-149">The default validator for User (`UserValidator`) has a property `AllowOnlyAlphanumericUserNames` that has default value set to `true`.</span></span> <span data-ttu-id="6e621-150">密碼的預設驗證程式（`MinimumLengthValidator`）可確保密碼至少有6個字元。</span><span class="sxs-lookup"><span data-stu-id="6e621-150">The default validator for Password (`MinimumLengthValidator`) ensures that password has at least 6 characters.</span></span> <span data-ttu-id="6e621-151">這些驗證程式是 `UserManager` 的屬性，如果您想要擁有自訂驗證，可以覆寫這些內容。</span><span class="sxs-lookup"><span data-stu-id="6e621-151">These validators are properties on `UserManager` that can be overridden if you want to have custom validation,</span></span>

## <a name="verify-the-localdb-identity-database-and-tables-generated-by-entity-framework"></a><span data-ttu-id="6e621-152">確認 LocalDb 識別資料庫和產生的資料表 Entity Framework</span><span class="sxs-lookup"><span data-stu-id="6e621-152">Verify the LocalDb Identity database and tables generated by Entity Framework</span></span>

1. <span data-ttu-id="6e621-153">在 [ **View** ] 功能表中，選取 [**伺服器總管**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-153">In the **View** menu, select **Server Explorer**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image7.png)
2. <span data-ttu-id="6e621-154">展開 **[DefaultConnection （WebFormsIdentity）** ]，展開 [**資料表]** ，以滑鼠右鍵按一下**AspNetUsers** ，然後選取 [**顯示資料表資料**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-154">Expand **DefaultConnection (WebFormsIdentity)**, expand **Tables**, right-click **AspNetUsers** and then select **Show Table Data**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image8.png)  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image9.png)

## <a name="configure-the-application-for-owin-authentication"></a><span data-ttu-id="6e621-155">設定應用程式以進行 OWIN authentication</span><span class="sxs-lookup"><span data-stu-id="6e621-155">Configure the application for OWIN authentication</span></span>

<span data-ttu-id="6e621-156">此時，我們只新增了建立使用者的支援。</span><span class="sxs-lookup"><span data-stu-id="6e621-156">At this point we have only added support for creating users.</span></span> <span data-ttu-id="6e621-157">現在，我們將示範如何新增驗證以登入使用者。</span><span class="sxs-lookup"><span data-stu-id="6e621-157">Now, we are going to demonstrate how we can add authentication to login a user.</span></span> <span data-ttu-id="6e621-158">ASP.NET Identity 使用 Microsoft OWIN Authentication 中介軟體進行表單驗證。</span><span class="sxs-lookup"><span data-stu-id="6e621-158">ASP.NET Identity uses Microsoft OWIN Authentication middleware for forms authentication.</span></span> <span data-ttu-id="6e621-159">OWIN Cookie 驗證是以 Cookie 和宣告為基礎的驗證機制，可供[OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx)或 IIS 上裝載的任何架構使用。</span><span class="sxs-lookup"><span data-stu-id="6e621-159">The OWIN Cookie Authentication is a cookie and claims based authentication mechanism that can be used by any framework hosted on [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) or IIS.</span></span> <span data-ttu-id="6e621-160">使用此模型，可以跨多個架構使用相同的驗證套件，包括 ASP.NET MVC 和 Web Forms。</span><span class="sxs-lookup"><span data-stu-id="6e621-160">With this model, the same authentication packages can be used across multiple frameworks including ASP.NET MVC and Web Forms.</span></span> <span data-ttu-id="6e621-161">如需有關專案 Katana 以及如何在主機上執行中介軟體的詳細資訊，請參閱[使用 Katana 專案消費者入門](https://msdn.microsoft.com/magazine/dn451439.aspx)。</span><span class="sxs-lookup"><span data-stu-id="6e621-161">For more information on project Katana and how to run middleware in a host agnostic see [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx).</span></span>

## <a name="install-authentication-packages-to-your-application"></a><span data-ttu-id="6e621-162">將驗證套件安裝到您的應用程式</span><span class="sxs-lookup"><span data-stu-id="6e621-162">Install authentication packages to your application</span></span>

1. <span data-ttu-id="6e621-163">在方案總管中，以滑鼠右鍵按一下您的專案，然後選取 [**管理 NuGet 套件**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-163">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="6e621-164">搜尋***Owin***套件，並安裝。</span><span class="sxs-lookup"><span data-stu-id="6e621-164">Search for and install the ***Microsoft.AspNet.Identity.Owin*** package.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image16.png)

2. <span data-ttu-id="6e621-165">搜尋並安裝***Owin SystemWeb***套件。</span><span class="sxs-lookup"><span data-stu-id="6e621-165">Search for and install the ***Microsoft.Owin.Host.SystemWeb*** package.</span></span>

    > [!NOTE]
    > <span data-ttu-id="6e621-166">**Owin**套件包含一組 Owin 擴充功能類別，可用來管理和設定 ASP.NET Identity 核心套件所使用的 Owin authentication 中介軟體。</span><span class="sxs-lookup"><span data-stu-id="6e621-166">The **Microsoft.Aspnet.Identity.Owin** package contains a set of OWIN extension classes to manage and configure OWIN authentication middleware to be consumed by ASP.NET Identity Core packages.</span></span>
    > <span data-ttu-id="6e621-167">**SystemWeb**套件包含 Owin 伺服器，可讓 Owin 型應用程式使用 ASP.NET 要求管線在 IIS 上執行。</span><span class="sxs-lookup"><span data-stu-id="6e621-167">The **Microsoft.Owin.Host.SystemWeb** package contains an OWIN server that enables OWIN-based applications to run on IIS using the ASP.NET request pipeline.</span></span> <span data-ttu-id="6e621-168">如需詳細資訊，請參閱[IIS 整合式管線中的 OWIN 中介軟體](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md)。</span><span class="sxs-lookup"><span data-stu-id="6e621-168">For more information see [OWIN Middleware in the IIS integrated pipeline](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span></span>

## <a name="add-owin-startup-and-authentication-configuration-classes"></a><span data-ttu-id="6e621-169">新增 OWIN 啟動和驗證設定類別</span><span class="sxs-lookup"><span data-stu-id="6e621-169">Add OWIN startup and authentication configuration classes</span></span>

1. <span data-ttu-id="6e621-170">在**方案總管**中，以滑鼠右鍵按一下您的專案，然後依**序選取 [新增]** 和 [**加入新專案**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-170">In **Solution Explorer**, right-click your project, select **Add**, and then **Add New Item**.</span></span> <span data-ttu-id="6e621-171">在 [搜尋文字方塊] 對話方塊中，輸入 "*owin*"。</span><span class="sxs-lookup"><span data-stu-id="6e621-171">In the search text box dialog, type "*owin*".</span></span> <span data-ttu-id="6e621-172">將類別命名為「*啟動*」，然後選取 [**新增**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-172">Name the class "*Startup*" and select **Add**.</span></span> 
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image11.png)
2. <span data-ttu-id="6e621-173">在 Startup.cs 檔案中，新增如下所示的反白顯示程式碼，以設定 OWIN cookie 驗證。</span><span class="sxs-lookup"><span data-stu-id="6e621-173">In the Startup.cs file, add the highlighted code shown below to configure OWIN cookie authentication.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample4.cs?highlight=1,3,15-19)]

    > [!NOTE]
    > <span data-ttu-id="6e621-174">此類別包含用來指定 OWIN 啟動類別的 `OwinStartup` 屬性。</span><span class="sxs-lookup"><span data-stu-id="6e621-174">This class contains the `OwinStartup` attribute for specifying the OWIN startup class.</span></span> <span data-ttu-id="6e621-175">每個 OWIN 應用程式都有一個啟動類別，您可以在其中指定應用程式管線的元件。</span><span class="sxs-lookup"><span data-stu-id="6e621-175">Every OWIN application has a startup class where you specify components for the application pipeline.</span></span> <span data-ttu-id="6e621-176">如需此模型的詳細資訊，請參閱[OWIN 啟動類別偵測](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)。</span><span class="sxs-lookup"><span data-stu-id="6e621-176">See [OWIN Startup Class Detection](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) for more info on this model.</span></span>

## <a name="add-web-forms-for-registering-and-signing-in-users"></a><span data-ttu-id="6e621-177">新增用於註冊和登入使用者的 web 表單</span><span class="sxs-lookup"><span data-stu-id="6e621-177">Add web forms for registering and signing in users</span></span>

1. <span data-ttu-id="6e621-178">開啟*Register.aspx.cs*檔案，並新增下列程式碼，以在註冊成功時登入使用者。</span><span class="sxs-lookup"><span data-stu-id="6e621-178">Open the *Register.aspx.cs* file and add the following code which signs in the user when registration succeeds.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample5.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="6e621-179">由於 ASP.NET Identity 和 OWIN Cookie 驗證是以宣告為基礎的系統，因此架構會要求應用程式開發人員為使用者產生[ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="6e621-179">Since ASP.NET Identity and OWIN Cookie Authentication are claims based system, the framework requires the app developer to generate a [ClaimsIdentity](https://msdn.microsoft.com/library/microsoft.identitymodel.claims.claimsidentity.aspx) for the user.</span></span> <span data-ttu-id="6e621-180">ClaimsIdentity 包含使用者所有宣告的相關資訊，例如使用者所屬的角色。</span><span class="sxs-lookup"><span data-stu-id="6e621-180">ClaimsIdentity has information about all the claims for the user such as what Roles the user belongs to.</span></span> <span data-ttu-id="6e621-181">您也可以在這個階段為使用者新增更多宣告。</span><span class="sxs-lookup"><span data-stu-id="6e621-181">You can also add more claims for the user at this stage.</span></span>
    > - <span data-ttu-id="6e621-182">您可以使用 OWIN 中的 AuthenticationManager 來登入使用者，並呼叫 `SignIn` 並傳入 ClaimsIdentity，如上所示。</span><span class="sxs-lookup"><span data-stu-id="6e621-182">You can sign in the user by using the AuthenticationManager from OWIN and calling `SignIn` and passing in the ClaimsIdentity as shown above.</span></span> <span data-ttu-id="6e621-183">這段程式碼也會登入使用者，並產生 cookie。</span><span class="sxs-lookup"><span data-stu-id="6e621-183">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="6e621-184">此呼叫類似于[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)模組所使用的[FormAuthentication. SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="6e621-184">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
2. <span data-ttu-id="6e621-185">在**方案總管**中，以滑鼠右鍵按一下您的專案，然後依序選取 [**新增**] 和 [ **Web 表單**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-185">In **Solution Explorer**, right-click your project, select **Add**, and then **Web Form**.</span></span> <span data-ttu-id="6e621-186">為 web 表單**登**入命名。</span><span class="sxs-lookup"><span data-stu-id="6e621-186">Name the web form **Login**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image12.png)
3. <span data-ttu-id="6e621-187">將*登入 .aspx*檔案的內容取代為下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="6e621-187">Replace the contents of the *Login.aspx* file with the following code:</span></span>

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample6.aspx)]
4. <span data-ttu-id="6e621-188">以下列內容取代*Login.aspx.cs*檔案的內容：</span><span class="sxs-lookup"><span data-stu-id="6e621-188">Replace the contents of the *Login.aspx.cs* file with the following:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample7.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="6e621-189">`Page_Load` 現在會檢查目前使用者的狀態，並根據其 `Context.User.Identity.IsAuthenticated` 狀態採取動作。</span><span class="sxs-lookup"><span data-stu-id="6e621-189">The `Page_Load` now checks for the status of current user and takes action based on its `Context.User.Identity.IsAuthenticated` status.</span></span>
    >   <span data-ttu-id="6e621-190">**顯示已登入的使用者名稱**： Microsoft ASP.NET 身分識別架構已在[IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx)上新增擴充方法，可讓您取得已登入使用者的 `UserName` 和 `UserId`。</span><span class="sxs-lookup"><span data-stu-id="6e621-190">**Display Logged in User Name** : The Microsoft ASP.NET Identity Framework has added extension methods on [System.Security.Principal.IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx) that allows you to get the `UserName` and `UserId`  for the logged in User.</span></span> <span data-ttu-id="6e621-191">這些擴充方法會在 `Microsoft.AspNet.Identity.Core` 元件中定義。</span><span class="sxs-lookup"><span data-stu-id="6e621-191">These extension methods are defined in the `Microsoft.AspNet.Identity.Core` assembly.</span></span> <span data-ttu-id="6e621-192">這些擴充方法是[HttpCoNtext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx)的取代。</span><span class="sxs-lookup"><span data-stu-id="6e621-192">These extension methods are the replacement for [HttpContext.User.Identity.Name](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx) .</span></span>
    > - <span data-ttu-id="6e621-193">登入方法： `This` 方法會取代此範例中先前的 `CreateUser_Click` 方法，並在成功建立使用者之後，立即登入使用者。</span><span class="sxs-lookup"><span data-stu-id="6e621-193">SignIn method: `This` method replaces the previous `CreateUser_Click` method in this sample and now signs in the user after successfully creating the user.</span></span>   
    >   <span data-ttu-id="6e621-194">Microsoft OWIN Framework 在 `System.Web.HttpContext` 上新增了擴充方法，可讓您取得 `IOwinContext`的參考。</span><span class="sxs-lookup"><span data-stu-id="6e621-194">The Microsoft OWIN Framework has added extension methods on `System.Web.HttpContext` that allows you to get a reference to an `IOwinContext`.</span></span> <span data-ttu-id="6e621-195">這些擴充方法會在 `Microsoft.Owin.Host.SystemWeb` 元件中定義。</span><span class="sxs-lookup"><span data-stu-id="6e621-195">These extension methods are defined in `Microsoft.Owin.Host.SystemWeb` assembly.</span></span> <span data-ttu-id="6e621-196">`OwinContext` 類別會公開 `IAuthenticationManager` 屬性，其代表目前要求上可用的驗證中介軟體功能。</span><span class="sxs-lookup"><span data-stu-id="6e621-196">The `OwinContext` class exposes an `IAuthenticationManager` property that represents the Authentication middleware functionality available on the current request.</span></span> <span data-ttu-id="6e621-197">您可以使用 OWIN 中的 `AuthenticationManager` 登入使用者，並呼叫 `SignIn` 並傳入 `ClaimsIdentity`，如上所示。</span><span class="sxs-lookup"><span data-stu-id="6e621-197">You can sign in the user by using the `AuthenticationManager` from OWIN and calling `SignIn` and passing in the `ClaimsIdentity` as shown above.</span></span> <span data-ttu-id="6e621-198">由於 ASP.NET Identity 和 OWIN Cookie 驗證是以宣告為基礎的系統，因此架構會要求應用程式為使用者產生 `ClaimsIdentity`。</span><span class="sxs-lookup"><span data-stu-id="6e621-198">Because ASP.NET Identity and OWIN Cookie Authentication are claims-based system, the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="6e621-199">`ClaimsIdentity` 包含使用者所有宣告的相關資訊，例如使用者所屬的角色。</span><span class="sxs-lookup"><span data-stu-id="6e621-199">The `ClaimsIdentity` has information about all the claims for the user, such as what roles the user belongs to.</span></span> <span data-ttu-id="6e621-200">您也可以在這個階段為使用者新增更多宣告，這段程式碼也會登入使用者並產生 cookie。</span><span class="sxs-lookup"><span data-stu-id="6e621-200">You can also add more claims for the user at this stage This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="6e621-201">此呼叫類似于[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)模組所使用的[FormAuthentication. SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="6e621-201">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
    > - <span data-ttu-id="6e621-202">`SignOut` 方法：從 OWIN 取得 `AuthenticationManager` 的參考，並呼叫 `SignOut`。</span><span class="sxs-lookup"><span data-stu-id="6e621-202">`SignOut` method: Gets a reference to the `AuthenticationManager` from OWIN and calls `SignOut`.</span></span> <span data-ttu-id="6e621-203">這類似于[FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)模組所使用的[FormsAuthentication. SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx)方法。</span><span class="sxs-lookup"><span data-stu-id="6e621-203">This is analogous to [FormsAuthentication.SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx) method used by the [FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
5. <span data-ttu-id="6e621-204">按**Ctrl + F5**以建立並執行 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6e621-204">Press **Ctrl + F5** to build and run the web application.</span></span> <span data-ttu-id="6e621-205">輸入新的 [使用者名稱] 和 [密碼]，然後選取 [**註冊**]。</span><span class="sxs-lookup"><span data-stu-id="6e621-205">Enter a new user name and password and then select **Register**.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image13.png)  
   <span data-ttu-id="6e621-206">注意：此時會建立新的使用者並登入。</span><span class="sxs-lookup"><span data-stu-id="6e621-206">Note: At this point, the new user is created and logged in.</span></span>
6. <span data-ttu-id="6e621-207">選取 [**登出**] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="6e621-207">Select the **Log out** button.</span></span> <span data-ttu-id="6e621-208">系統會將您重新導向至 [登入] 表單。</span><span class="sxs-lookup"><span data-stu-id="6e621-208">You are redirected to the Log in form.</span></span>
7. <span data-ttu-id="6e621-209">輸入不正確使用者名稱或密碼，然後選取 [**登入**] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="6e621-209">Enter an invalid user name or password and select the **Log in** button.</span></span> 
   <span data-ttu-id="6e621-210">`UserManager.Find` 方法會傳回 null，且會顯示錯誤訊息：「*不正確使用者名稱或密碼*」。</span><span class="sxs-lookup"><span data-stu-id="6e621-210">The `UserManager.Find`  method will return null and the error message: " *Invalid user name or password* " will be displayed.</span></span>
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image14.png)
