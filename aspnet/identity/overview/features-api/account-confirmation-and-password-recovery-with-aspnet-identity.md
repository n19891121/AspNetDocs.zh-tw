---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: 帳戶確認和密碼復原-ASP.NET 身分識別 (C#)-ASP.NET 4.x
author: HaoK
description: 進行本教學課程之前，您應該先完成登入、 電子郵件確認和密碼重設建立安全的 ASP.NET MVC 5 web 應用程式。 本教學課程...
ms.author: riande
ms.date: 01/23/2019
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 2e4cd21d66e69590fb1642d7974e4b7f82cba0cb
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/17/2019
ms.locfileid: "59396417"
---
# <a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="4f2d6-104">帳戶確認和密碼復原，使用 ASP.NET Identity (C#)</span><span class="sxs-lookup"><span data-stu-id="4f2d6-104">Account confirmation and password recovery with ASP.NET Identity (C#)</span></span>

> <span data-ttu-id="4f2d6-105">在進行本教學課程之前您應該先完成[登入、 電子郵件確認和密碼重設建立安全的 ASP.NET MVC 5 web 應用程式](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-105">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="4f2d6-106">本教學課程包含更多詳細資料，並將為您示範如何設定本機帳戶的確認電子郵件，並可讓使用者重設其遺忘的密碼，在 ASP.NET 身分識別。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-106">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span>

<span data-ttu-id="4f2d6-107">本機使用者帳戶需要使用者建立帳戶的密碼和密碼 （安全） 儲存在 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-107">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="4f2d6-108">ASP.NET Identity 也支援不需要使用者建立應用程式密碼的社交帳戶。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-108">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="4f2d6-109">[社交帳戶](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)使用協力廠商 （例如 Google、 Twitter、 Facebook 或 Microsoft） 驗證使用者。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-109">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook, or Microsoft) to authenticate users.</span></span> <span data-ttu-id="4f2d6-110">本主題涵蓋下列資訊：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-110">This topic covers the following:</span></span>

- <span data-ttu-id="4f2d6-111">[建立 ASP.NET MVC 應用程式](#createMvc)並探索 ASP.NET 身分識別功能。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-111">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="4f2d6-112">建立身分識別範例</span><span class="sxs-lookup"><span data-stu-id="4f2d6-112">Build the Identity sample</span></span>](#build)
- [<span data-ttu-id="4f2d6-113">設定電子郵件確認</span><span class="sxs-lookup"><span data-stu-id="4f2d6-113">Set up email confirmation</span></span>](#email)

<span data-ttu-id="4f2d6-114">新的使用者註冊其電子郵件別名，這會建立本機帳戶。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-114">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="4f2d6-115">選取 [Register] 按鈕會傳送確認電子郵件，其中包含電子郵件地址的驗證語彙基元。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-115">Selecting the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="4f2d6-116">含有確認語彙基元，為其帳戶的電子郵件傳送給使用者。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-116">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="4f2d6-117">選取此連結確認帳戶。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-117">Selecting the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="4f2d6-118">復原/重設密碼</span><span class="sxs-lookup"><span data-stu-id="4f2d6-118">Password recovery/reset</span></span>

<span data-ttu-id="4f2d6-119">忘記其密碼的本機使用者可以有安全性權杖傳送給他們的電子郵件帳戶，讓他們能夠重設其密碼。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-119">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="4f2d6-120">使用者很快就會收到一封電子郵件，讓他們能夠重設其密碼的連結。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-120">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="4f2d6-121">選取此連結會移至重設頁面。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-121">Selecting the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="4f2d6-122">選取**重設**按鈕將會確認重設密碼。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-122">Selecting the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="4f2d6-123">建立 ASP.NET Web 應用程式</span><span class="sxs-lookup"><span data-stu-id="4f2d6-123">Create an ASP.NET web app</span></span>

<span data-ttu-id="4f2d6-124">開始安裝並執行[Visual Studio 2017](https://visualstudio.microsoft.com/)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-124">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/).</span></span>


1. <span data-ttu-id="4f2d6-125">建立新的 ASP.NET Web 專案，然後選取 [MVC] 範本。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-125">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="4f2d6-126">Web Form 也支援 ASP.NET 身分識別，因此您可以依照類似的步驟，在 web form 應用程式。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-126">Web Forms also support ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="4f2d6-127">若要驗證變更**個別使用者帳戶**。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-127">Change the authentication to **Individual User Accounts**.</span></span>
3. <span data-ttu-id="4f2d6-128">執行應用程式，請選取**註冊**連結，並註冊的使用者。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-128">Run the app, select the **Register** link and register a user.</span></span> <span data-ttu-id="4f2d6-129">此時，唯一的驗證電子郵件是使用[[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx)屬性。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-129">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="4f2d6-130">在 [伺服器總管] 中，瀏覽至**資料 Connections\DefaultConnection\Tables\AspNetUsers**，以滑鼠右鍵按一下，然後選取**開啟資料表定義**。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-130">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right-click and select **Open table definition**.</span></span>

    <span data-ttu-id="4f2d6-131">下圖顯示`AspNetUsers`結構描述：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-131">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="4f2d6-132">以滑鼠右鍵按一下**AspNetUsers**資料表，然後選取**顯示資料表資料**。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-132">Right-click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="4f2d6-133">此時已不確認電子郵件。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-133">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="4f2d6-134">ASP.NET Identity 的預設資料存放區是 Entity Framework，但您可以設定，以使用其他資料存放區，並新增額外的欄位。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-134">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="4f2d6-135">請參閱[額外的資源](#addRes)本教學課程的最後一節。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-135">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="4f2d6-136">[OWIN 啟動類別](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)( *Startup.cs* ) 應用程式會啟動，並叫用時會呼叫`ConfigureAuth`方法*應用程式\_Start\Startup.Auth.cs*，這會設定 OWIN 管線，並初始化 ASP.NET 身分識別。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-136">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="4f2d6-137">檢查 `ConfigureAuth` 方法。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-137">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="4f2d6-138">每個`CreatePerOwinContext`呼叫會註冊回呼 (儲存在`OwinContext`)，每個要求來建立指定型別的執行個體將一次呼叫。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-138">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="4f2d6-139">您可以在建構函式中設定中斷點並`Create`每個型別的方法 (`ApplicationDbContext, ApplicationUserManager`)，並確認每個要求上呼叫。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-139">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="4f2d6-140">執行個體`ApplicationDbContext`和`ApplicationUserManager`會儲存在 OWIN 內容中，可以存取整個應用程式。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-140">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="4f2d6-141">ASP.NET 身分識別連結到 cookie 中介軟體透過 OWIN 管線。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-141">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="4f2d6-142">如需詳細資訊，請參閱 <<c0> [ 每個要求存留期管理，在 ASP.NET 身分識別的 UserManager 類別](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-142">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="4f2d6-143">當您變更您的安全性設定檔時，會產生新的安全性戳記，並儲存在`SecurityStamp`欄位*AspNetUsers*資料表。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-143">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="4f2d6-144">請注意，`SecurityStamp`欄位是不同的安全性 cookie。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-144">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="4f2d6-145">安全性 cookie 不會儲存在`AspNetUsers`資料表 （或任何其他身分識別資料庫中的位置）。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-145">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="4f2d6-146">使用自我簽署的安全性 cookie 語彙基元[DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx)並建立不含`UserId, SecurityStamp`和到期時間資訊。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-146">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="4f2d6-147">Cookie 中介軟體會檢查每個要求的 cookie。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-147">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="4f2d6-148">`SecurityStampValidator`方法中的`Startup`類別叫用的資料庫，並定期檢查安全性戳記依照`validateInterval`。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-148">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="4f2d6-149">這只會每隔 30 分鐘 （在我們的範例），除非您變更您的安全性設定檔。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-149">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="4f2d6-150">在 30 分鐘的間隔已選擇將存取資料庫的次數降至最低。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-150">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="4f2d6-151">請參閱我[雙因素驗證的教學課程](index.md)如需詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-151">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="4f2d6-152">每個程式碼的註解`UseCookieAuthentication`方法支援 cookie 驗證。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-152">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="4f2d6-153">`SecurityStamp`欄位和相關聯的程式碼會提供額外一層的應用程式的安全性，當您變更密碼，您就會記錄從您用以登入瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-153">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="4f2d6-154">`SecurityStampValidator.OnValidateIdentity`方法可讓應用程式的使用者登入時，驗證安全性權杖時變更密碼，或使用外部登入使用。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-154">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="4f2d6-155">這樣才能確保以舊密碼產生的任何權杖 (cookie) 都會失效。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-155">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="4f2d6-156">在範例專案中，如果您變更使用者密碼然後新的權杖會為使用者產生，任何先前的權杖都會失效和`SecurityStamp`欄位會更新。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-156">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="4f2d6-157">身分識別系統可讓您設定您的應用程式，使用者的安全性設定檔變更時 (例如，當使用者變更其密碼或變更相關聯的登入 (例如 Facebook、 Google、 Microsoft 帳戶等)，使用者登出所有瀏覽器執行個體。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-157">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="4f2d6-158">例如下, 圖顯示[單一登出的範例](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt)應用程式，這可讓使用者選取一個按鈕，即可登出所有的瀏覽器執行個體 （在此情況下，在 IE、 Firefox 和 Chrome）。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-158">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by selecting one button.</span></span> <span data-ttu-id="4f2d6-159">或者，此範例可讓您只登出的特定瀏覽器執行個體。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-159">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="4f2d6-160">[單一登出的範例](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt)應用程式會顯示如何 ASP.NET 身分識別可讓您可以重新產生安全性權杖。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-160">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="4f2d6-161">這樣才能確保以舊密碼產生的任何權杖 (cookie) 都會失效。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-161">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="4f2d6-162">這項功能提供一層額外的安全性，以您的應用程式;當您變更您的密碼，則您會登出您已登入此應用程式。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-162">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="4f2d6-163">*應用程式\_Start\IdentityConfig.cs*檔案包含`ApplicationUserManager`，`EmailService`和`SmsService`類別。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-163">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="4f2d6-164">`EmailService`並`SmsService`類別會實作每個`IIdentityMessageService`介面，以便您在每個類別，以設定電子郵件和 SMS 常見的方法。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-164">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="4f2d6-165">雖然本教學課程中只會顯示如何將透過電子郵件通知[SendGrid](http://sendgrid.com/)，您可以傳送電子郵件使用 SMTP 和其他機制。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-165">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="4f2d6-166">`Startup`類別也包含將社交登入 （Facebook、 Twitter 等），請參閱我的教學課程的規範盤子[使用 Facebook、 Twitter、 LinkedIn 和 Google OAuth2 登入的 MVC 5 應用程式](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)如需詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-166">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="4f2d6-167">檢查`ApplicationUserManager`類別，其中包含的使用者身分識別資訊，並設定下列功能：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-167">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="4f2d6-168">密碼強度需求。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-168">Password strength requirements.</span></span>
- <span data-ttu-id="4f2d6-169">使用者被鎖定 （嘗試次數和時間）。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-169">User lock out (attempts and time).</span></span>
- <span data-ttu-id="4f2d6-170">雙因素驗證 (2FA)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-170">Two-factor authentication (2FA).</span></span> <span data-ttu-id="4f2d6-171">在另一個教學課程中，我會說明 2FA 和傳送簡訊。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-171">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="4f2d6-172">連結的電子郵件和 SMS 服務。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-172">Hooking up the email and SMS services.</span></span> <span data-ttu-id="4f2d6-173">（我會在另一個教學課程中說明 SMS）。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-173">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="4f2d6-174">`ApplicationUserManager`類別衍生自泛型`UserManager<ApplicationUser>`類別。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-174">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="4f2d6-175">`ApplicationUser` 衍生自[IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-175">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="4f2d6-176">`IdentityUser` 衍生自泛型`IdentityUser`類別：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-176">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="4f2d6-177">上述的屬性中的屬性符合`AspNetUsers`資料表，如上所示。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-177">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="4f2d6-178">泛型引數上的`IUser`可讓您在衍生類別，使用不同類型的主索引鍵。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-178">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="4f2d6-179">請參閱[ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt)範例顯示如何將主索引鍵從字串變更為 int 或 GUID。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-179">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="4f2d6-180">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="4f2d6-180">ApplicationUser</span></span>

<span data-ttu-id="4f2d6-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) 中定義*Models\IdentityModels.cs*為：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="4f2d6-182">上述反白顯示的程式碼會產生[ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-182">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="4f2d6-183">ASP.NET 身分識別和 OWIN 的 Cookie 驗證以宣告為基礎，因此架構需要應用程式來產生`ClaimsIdentity`使用者。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-183">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="4f2d6-184">`ClaimsIdentity` 資訊的相關使用者的名稱，例如使用者的所有宣告年齡和哪些角色的使用者屬於。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-184">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="4f2d6-185">您也可以在這個階段中新增更多的使用者宣告。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-185">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="4f2d6-186">OWIN`AuthenticationManager.SignIn`方法會傳入`ClaimsIdentity`並登入使用者：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-186">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="4f2d6-187">[使用 Facebook、 Twitter、 LinkedIn 和 Google OAuth2 登入的 MVC 5 應用程式](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)顯示如何新增其他屬性，以`ApplicationUser`類別。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-187">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="4f2d6-188">電子郵件確認</span><span class="sxs-lookup"><span data-stu-id="4f2d6-188">Email confirmation</span></span>

<span data-ttu-id="4f2d6-189">它是個不錯的主意，以確認新的使用者向以確認它們不會模擬其他人的電子郵件 （亦即，尚未註冊使用其他人的電子郵件）。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-189">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="4f2d6-190">假設您有討論論壇，您會想要防止`"bob@example.com"`註冊為`"joe@contoso.com"`。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-190">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="4f2d6-191">而不需要電子郵件確認`"joe@contoso.com"`無法從您的應用程式收到不想要的電子郵件。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-191">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="4f2d6-192">假設 Bob 不小心註冊為`"bib@example.com"`並沒注意到，他便無法使用密碼復原，因為應用程式不需要其正確的電子郵件。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-192">Suppose Bob accidentally registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="4f2d6-193">電子郵件確認來自 bot 提供有限的保護，並不提供保護，從決定濫發垃圾郵件者，它們有許多的工作電子郵件別名，它們可用來註冊。在下列範例中，使用者將無法變更其密碼，直到已確認他們的帳戶 （藉由它們選取他們註冊的電子郵件帳戶收到的確認連結。）您可以將此工作流程套用至其他案例中，例如傳送確認及重設系統管理員，等變更其設定檔的使用者的使用者傳送電子郵件建立的新帳戶密碼的連結。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-193">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them selecting a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="4f2d6-194">您通常想要防止新使用者張貼至您的網站的任何資料之前先確認電子郵件、 SMS 文字訊息或其他機制。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-194">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="build-a-more-complete-sample"></a><span data-ttu-id="4f2d6-195">建立更完整的範例</span><span class="sxs-lookup"><span data-stu-id="4f2d6-195">Build a more complete sample</span></span>

<span data-ttu-id="4f2d6-196">在本節中，您會使用 NuGet 來下載更完整範例，我們將使用。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-196">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="4f2d6-197">建立新***空***ASP.NET Web 專案。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-197">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="4f2d6-198">在套件管理員主控台中，輸入下列命令：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-198">In the Package Manager Console, enter the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="4f2d6-199">在本教學課程中，我們將使用[SendGrid](http://sendgrid.com/)傳送電子郵件。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-199">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="4f2d6-200">`Identity.Samples`套件會安裝我們將使用的程式碼。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-200">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="4f2d6-201">設定[專案，以使用 SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-201">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="4f2d6-202">測試建立本機帳戶執行應用程式中，選取**註冊**連結，然後張貼之註冊表單。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-202">Test local account creation by running the app, selecting the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="4f2d6-203">選取示範電子郵件連結，以模擬電子郵件確認。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-203">Select the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="4f2d6-204">移除此範例示範電子郵件連結確認程式碼 (`ViewBag.Link`帳戶控制器中的程式碼。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-204">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="4f2d6-205">請參閱`DisplayEmail`和`ForgotPasswordConfirmation`動作方法和 razor 檢視)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-205">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!WARNING]
> <span data-ttu-id="4f2d6-206">如果您變更任何安全性設定，在此範例中，生產應用程式必須進行安全性稽核會明確呼叫所做的變更。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-206">If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="4f2d6-207">檢查應用程式中的程式碼\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="4f2d6-207">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="4f2d6-208">此範例示範如何建立帳戶，並將它加入*Admin*角色。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-208">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="4f2d6-209">您應該更換此範例中的電子郵件，您將使用系統管理員帳戶的電子郵件。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-209">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="4f2d6-210">現在若要建立系統管理員帳戶的最簡單方式是以程式設計方式在`Seed`方法。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-210">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="4f2d6-211">我們希望有這項工具在未來，可讓您建立及管理使用者和角色。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-211">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="4f2d6-212">範例程式碼可以讓您建立和管理使用者和角色，但您必須先具備系統管理員帳戶以執行的角色和使用者管理頁面。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-212">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="4f2d6-213">在此範例中，就會植入資料庫時，會建立系統管理員帳戶。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-213">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="4f2d6-214">變更密碼，並將名稱變更為您可以在何處接收電子郵件通知的帳戶。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-214">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="4f2d6-215">安全性-機密資料絕不儲存在原始程式碼中。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-215">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="4f2d6-216">如先前所述`app.CreatePerOwinContext`startup 類別中的呼叫加入回呼`Create`DB 的應用程式內容、 使用者管理員和角色管理員類別的方法。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-216">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="4f2d6-217">OWIN 管線呼叫`Create`方法，這些類別的每個要求，並將每個類別的內容。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-217">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="4f2d6-218">帳戶控制器會公開使用者管理員從 HTTP 內容 （其中包含 OWIN 內容）：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-218">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="4f2d6-219">當使用者註冊本機帳戶，`HTTP Post Register`方法呼叫：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-219">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="4f2d6-220">上述程式碼會使用模型資料來建立新的使用者帳戶使用的電子郵件和輸入的密碼。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-220">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="4f2d6-221">資料存放區中的電子郵件別名時，帳戶建立失敗，並重新顯示表單。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-221">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="4f2d6-222">`GenerateEmailConfirmationTokenAsync`方法會建立安全的確認語彙基元，並將它儲存在 ASP.NET 身分識別資料存放區。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-222">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="4f2d6-223">[其中使用了 Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx)方法會建立一個連結，其中包含`UserId`和確認語彙基元。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-223">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="4f2d6-224">此連結，然後傳送電子郵件給使用者，使用者可以選取其電子郵件應用程式中的連結，以確認其帳戶。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-224">This link is then emailed to the user, the user can select on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="4f2d6-225">設定電子郵件確認</span><span class="sxs-lookup"><span data-stu-id="4f2d6-225">Set up email confirmation</span></span>

<span data-ttu-id="4f2d6-226">移至[Azure SendGrid 註冊頁面](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/)並註冊免費帳戶。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-226">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="4f2d6-227">加入程式碼來設定 SendGrid 如下所示：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-227">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="4f2d6-228">電子郵件用戶端經常只接受文字 (沒有 HTML)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-228">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="4f2d6-229">您應該提供中的文字和 HTML 的訊息。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-229">You should provide the message in text and HTML.</span></span> <span data-ttu-id="4f2d6-230">在 SendGrid 上述範例中，做法是使用`myMessage.Text`和`myMessage.Html`如上所示的程式碼。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-230">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="4f2d6-231">下列程式碼示範如何使用電子郵件傳送[MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx)類別 where`message.Body`傳回只的連結。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-231">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="4f2d6-232">安全性-機密資料絕不儲存在原始程式碼中。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-232">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="4f2d6-233">帳戶和認證會儲存在 appSetting 中。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-233">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="4f2d6-234">在 Azure 上，您可以安全地儲存這些值在 **[設定](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** 在 Azure 入口網站中的索引標籤。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-234">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="4f2d6-235">請參閱[最佳做法將密碼和其他機密資料部署到 ASP.NET 和 Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-235">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="4f2d6-236">輸入您的 SendGrid 認證，執行應用程式，註冊的電子郵件別名可以選取 [確認] 連結您的電子郵件中。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-236">Enter your SendGrid credentials, run the app, register with an email alias can select the confirm link in your email.</span></span> <span data-ttu-id="4f2d6-237">若要查看如何執行這項作業您[Outlook.com](http://outlook.com)電子郵件帳戶，請參閱 John Atten [ C# Outlook.Com SMTP 主機的 SMTP 組態](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx)和他[ASP.NET 身分識別 2.0:設定註冊帳戶驗證和雙因素授權](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)文章。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-237">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="4f2d6-238">一旦使用者選取**註冊**電子郵件地址會傳送包含驗證語彙基元確認電子郵件 按鈕。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-238">Once a user selects the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="4f2d6-239">含有確認語彙基元，為其帳戶的電子郵件傳送給使用者。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-239">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="4f2d6-240">檢查程式碼</span><span class="sxs-lookup"><span data-stu-id="4f2d6-240">Examine the code</span></span>

<span data-ttu-id="4f2d6-241">下列程式碼顯示 `POST ForgotPassword` 方法。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-241">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="4f2d6-242">如果尚未確認使用者電子郵件，方法就會以無訊息模式失敗。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-242">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="4f2d6-243">無效的電子郵件地址張貼錯誤時，如果惡意使用者就可以使用該資訊來尋找有效的使用者識別碼 （電子郵件別名） 攻擊。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-243">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="4f2d6-244">下列程式碼示範`ConfirmEmail`在帳戶控制器當使用者在傳送給他們的電子郵件中選取 [確認] 連結時所呼叫的方法：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-244">The following code shows the `ConfirmEmail` method in the account controller that is called when the user selects the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="4f2d6-245">一旦已使用遺忘的密碼權杖，它會失效。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-245">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="4f2d6-246">下列程式碼變更`Create`方法 (在*應用程式\_Start\IdentityConfig.cs*檔案) 會設定在過去 3 小時內到期的權杖。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-246">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="4f2d6-247">使用上述的程式碼，忘記的密碼和電子郵件確認語彙基元將於過去 3 小時內過期。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-247">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="4f2d6-248">預設值`TokenLifespan`是一天。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-248">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="4f2d6-249">下列程式碼顯示電子郵件確認方法：</span><span class="sxs-lookup"><span data-stu-id="4f2d6-249">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="4f2d6-250">若要讓您的應用程式更安全，ASP.NET 身分識別支援雙因素驗證 (2FA)。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-250">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="4f2d6-251">請參閱[ASP.NET 身分識別 2.0:設定帳戶驗證和雙因素授權](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx)由 John Atten。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-251">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="4f2d6-252">雖然您可以設定帳戶鎖定的密碼登入嘗試失敗，該方法可讓您的登入容易[DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack)鎖定。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-252">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="4f2d6-253">我們建議您只適用於帳戶鎖定 2FA。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-253">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="4f2d6-254">其他資源</span><span class="sxs-lookup"><span data-stu-id="4f2d6-254">Additional resources</span></span>

- [<span data-ttu-id="4f2d6-255">ASP.NET Identity 的自訂儲存體提供者概觀</span><span class="sxs-lookup"><span data-stu-id="4f2d6-255">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="4f2d6-256">[使用 Facebook、 Twitter、 LinkedIn 和 Google OAuth2 登入的 MVC 5 應用程式](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md)也會示範如何將使用者資料表中的設定檔資訊。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-256">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="4f2d6-257">[ASP.NET MVC 和身分識別 2.0:了解基本概念](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx)由 John Atten。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-257">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="4f2d6-258">ASP.NET Identity 簡介</span><span class="sxs-lookup"><span data-stu-id="4f2d6-258">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="4f2d6-259">[宣佈 ASP.NET 身分識別 2.0.0 RTM](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx)請參閱 Pranav rastogi。</span><span class="sxs-lookup"><span data-stu-id="4f2d6-259">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
