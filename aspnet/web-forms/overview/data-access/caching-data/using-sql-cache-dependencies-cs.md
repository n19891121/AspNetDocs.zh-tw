---
uid: web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
title: '使用 SQL 快取相依性 (c # ) |Microsoft Docs'
author: rick-anderson
description: 最簡單的快取策略是讓快取的資料在指定的一段時間之後過期。 但是這個簡單的方法表示快取的資料 maintai .。。
ms.author: riande
ms.date: 05/30/2007
ms.assetid: 0e91842c-7f10-4aed-8c23-4ee3e2774014
msc.legacyurl: /web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
msc.type: authoredcontent
ms.openlocfilehash: 6a039cdfb1da294744b92648386468f69193ae6b
ms.sourcegitcommit: 4e6d586faadbe4d9ef27122f86335ec9385134af
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/28/2020
ms.locfileid: "89045256"
---
# <a name="using-sql-cache-dependencies-c"></a><span data-ttu-id="9c8c4-104">使用 SQL 快取相依性 (C#)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-104">Using SQL Cache Dependencies (C#)</span></span>

<span data-ttu-id="9c8c4-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="9c8c4-106">[下載程式代碼](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip) 或 [下載 PDF](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip) or [Download PDF](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)</span></span>

> <span data-ttu-id="9c8c4-107">最簡單的快取策略是讓快取的資料在指定的一段時間之後過期。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-107">The simplest caching strategy is to allow cached data to expire after a specified period of time.</span></span> <span data-ttu-id="9c8c4-108">但這種簡單的方法表示快取的資料與基礎資料來源不會有任何關聯，而導致過時的資料被保留太久或目前的資料已過期。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-108">But this simple approach means that the cached data maintains no association with its underlying data source, resulting in stale data that is held too long or current data that is expired too soon.</span></span> <span data-ttu-id="9c8c4-109">更好的方法是使用 SqlCacheDependency 類別，讓資料保持快取狀態，直到其基礎資料在 SQL database 中經過修改為止。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-109">A better approach is to use the SqlCacheDependency class so that data remains cached until its underlying data has been modified in the SQL database.</span></span> <span data-ttu-id="9c8c4-110">本教學課程將為您示範作法。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-110">This tutorial shows you how.</span></span>

## <a name="introduction"></a><span data-ttu-id="9c8c4-111">簡介</span><span class="sxs-lookup"><span data-stu-id="9c8c4-111">Introduction</span></span>

<span data-ttu-id="9c8c4-112">快取技術在 [使用 ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) 的快取資料中檢查，而架構教學課程中的快取 [資料](caching-data-in-the-architecture-cs.md) 則使用以時間為基礎的到期日，在指定的期間之後收回快取中的資料。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-112">The caching techniques examined in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) and [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorials used a time-based expiry to evict the data from the cache after a specified period.</span></span> <span data-ttu-id="9c8c4-113">這種方法最簡單的方式，就是在快取的效能提升與資料過期之間取得平衡。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-113">This approach is the simplest way to balance the performance gains of caching against data staleness.</span></span> <span data-ttu-id="9c8c4-114">藉由選取 *x* 秒的到期時間，網頁開發人員 *concedes 只享受* 快取的效能優勢，而不只是 x 秒，而是讓她的資料絕對不會超過最長 *x* 秒的時間就會過時。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-114">By selecting a time expiry of *x* seconds, a page developer concedes to enjoy the performance benefits of caching for only *x* seconds, but can rest easy that her data will never be stale longer than a maximum of *x* seconds.</span></span> <span data-ttu-id="9c8c4-115">當然，對於靜態資料， *x* 可以擴充至 web 應用程式的存留期，如同在 [應用程式啟動時](caching-data-at-application-startup-cs.md) 快取資料中所做的檢查。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-115">Of course, for static data, *x* can be extended to the lifetime of the web application, as was examined in the [Caching Data at Application Startup](caching-data-at-application-startup-cs.md) tutorial.</span></span>

<span data-ttu-id="9c8c4-116">快取資料庫資料時，通常會選擇以時間為基礎的到期日，但通常是無法充分利用的解決方案。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-116">When caching database data, a time-based expiry is often chosen for its ease of use but is frequently an inadequate solution.</span></span> <span data-ttu-id="9c8c4-117">在理想情況下，資料庫資料會保持快取狀態，直到資料庫中的基礎資料經過修改為止。只有如此才會收回快取。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-117">Ideally, the database data would remain cached until the underlying data has been modified in the database; only then would the cache be evicted.</span></span> <span data-ttu-id="9c8c4-118">這種方法可將快取的效能優勢最大化，並將過時資料的持續時間降到最低。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-118">This approach maximizes the performance benefits of caching and minimizes the duration of stale data.</span></span> <span data-ttu-id="9c8c4-119">不過，為了享受這些優點，必須備妥一些系統，知道基礎資料庫資料何時經過修改，並從快取中收回對應的專案。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-119">However, in order to enjoy these benefits there must be some system in place that knows when the underlying database data has been modified and evicts the corresponding items from the cache.</span></span> <span data-ttu-id="9c8c4-120">在 ASP.NET 2.0 之前，網頁開發人員必須負責執行此系統。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-120">Prior to ASP.NET 2.0, page developers were responsible for implementing this system.</span></span>

<span data-ttu-id="9c8c4-121">ASP.NET 2.0 會提供[ `SqlCacheDependency` 類別](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx)和必要的基礎結構，以判斷資料庫中發生變更的時間，以便收回對應的快取專案。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-121">ASP.NET 2.0 provides a [`SqlCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) and the necessary infrastructure to determine when a change has occurred in the database so that the corresponding cached items can be evicted.</span></span> <span data-ttu-id="9c8c4-122">有兩種技術可判斷基礎資料的變更時間：通知和輪詢。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-122">There are two techniques for determining when the underlying data has changed: notification and polling.</span></span> <span data-ttu-id="9c8c4-123">在討論通知和輪詢之間的差異之後，我們會建立支援輪詢所需的基礎結構，然後探索如何 `SqlCacheDependency` 在宣告式和以程式設計的案例中使用類別。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-123">After discussing the differences between notification and polling, we'll create the infrastructure necessary to support polling and then explore how to use the `SqlCacheDependency` class in declarative and programmatically scenarios.</span></span>

## <a name="understanding-notification-and-polling"></a><span data-ttu-id="9c8c4-124">瞭解通知和輪詢</span><span class="sxs-lookup"><span data-stu-id="9c8c4-124">Understanding Notification and Polling</span></span>

<span data-ttu-id="9c8c4-125">有兩種方法可用來判斷資料庫中的資料何時修改：通知和輪詢。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-125">There are two techniques that can be used to determine when the data in a database has been modified: notification and polling.</span></span> <span data-ttu-id="9c8c4-126">使用通知時，資料庫會在上次執行查詢之後變更特定查詢的結果時，自動警示 ASP.NET 執行時間，此時會收回與查詢相關聯的快取專案。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-126">With notification, the database automatically alerts the ASP.NET runtime when the results of a particular query have been changed since the query was last executed, at which point the cached items associated with the query are evicted.</span></span> <span data-ttu-id="9c8c4-127">使用輪詢時，資料庫伺服器會維護上次更新特定資料表的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-127">With polling, the database server maintains information about when particular tables have last been updated.</span></span> <span data-ttu-id="9c8c4-128">ASP.NET 執行時間會定期輪詢資料庫，以檢查在快取中輸入資料表之後有哪些變更。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-128">The ASP.NET runtime periodically polls the database to check what tables have changed since they were entered into the cache.</span></span> <span data-ttu-id="9c8c4-129">已修改資料的資料表會收回其相關聯的快取專案。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-129">Those tables whose data has been modified have their associated cache items evicted.</span></span>

<span data-ttu-id="9c8c4-130">通知選項需要比輪詢更少的設定，而且更細微，因為它會追蹤查詢層級（而不是資料表層級）的變更。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-130">The notification option requires less setup than polling and is more granular since it tracks changes at the query level rather than at the table level.</span></span> <span data-ttu-id="9c8c4-131">可惜的是，通知只適用于 Microsoft SQL Server 2005 的完整版本，也就是) 的非 Express 版 (。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-131">Unfortunately, notifications are only available in the full editions of Microsoft SQL Server 2005 (i.e., the non-Express editions).</span></span> <span data-ttu-id="9c8c4-132">不過，輪詢選項可用於從7.0 到2005的所有 Microsoft SQL Server 版本。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-132">However, the polling option can be used for all versions of Microsoft SQL Server from 7.0 to 2005.</span></span> <span data-ttu-id="9c8c4-133">由於這些教學課程使用 Express 版的 SQL Server 2005，因此我們將著重于設定和使用輪詢選項。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-133">Since these tutorials use the Express edition of SQL Server 2005, we will focus on setting up and using the polling option.</span></span> <span data-ttu-id="9c8c4-134">請參閱本教學課程結尾的進一步閱讀章節，以取得 SQL Server 2005 s 通知功能的進一步資源。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-134">Consult the Further Reading section at the end of this tutorial for further resources on SQL Server 2005 s notification capabilities.</span></span>

<span data-ttu-id="9c8c4-135">使用輪詢時，資料庫必須設定為包含名為的資料表， `AspNet_SqlCacheTablesForChangeNotification` 該資料表具有三個數據行： `tableName` 、 `notificationCreated` 和 `changeId` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-135">With polling, the database must be configured to include a table named `AspNet_SqlCacheTablesForChangeNotification` that has three columns - `tableName`, `notificationCreated`, and `changeId`.</span></span> <span data-ttu-id="9c8c4-136">此資料表包含每個資料表的資料列，該資料列有可能需要在 web 應用程式的 SQL 快取相依性中使用的資料。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-136">This table contains a row for each table that has data that might need to be used in a SQL cache dependency in the web application.</span></span> <span data-ttu-id="9c8c4-137">`tableName`資料行會指定資料表的名稱， `notificationCreated` 並指出資料列新增至資料表的日期和時間。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-137">The `tableName` column specifies the name of the table while `notificationCreated` indicates the date and time the row was added to the table.</span></span> <span data-ttu-id="9c8c4-138">資料 `changeId` 行的型別為 `int` ，而且初始值為0。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-138">The `changeId` column is of type `int` and has an initial value of 0.</span></span> <span data-ttu-id="9c8c4-139">它的值會隨著資料表的每個修改而遞增。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-139">Its value is incremented with each modification to the table.</span></span>

<span data-ttu-id="9c8c4-140">除了 `AspNet_SqlCacheTablesForChangeNotification` 資料表以外，資料庫也需要在可能出現在 SQL 快取相依性中的每個資料表上包含觸發程式。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-140">In addition to the `AspNet_SqlCacheTablesForChangeNotification` table, the database also needs to include triggers on each of the tables that may appear in a SQL cache dependency.</span></span> <span data-ttu-id="9c8c4-141">每當插入、更新或刪除資料列，並在中遞增資料表的值時，就會執行這些觸發程式 `changeId` `AspNet_SqlCacheTablesForChangeNotification` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-141">These triggers are executed whenever a row is inserted, updated, or deleted and increment the table s `changeId` value in `AspNet_SqlCacheTablesForChangeNotification`.</span></span>

<span data-ttu-id="9c8c4-142">使用物件來快取資料時，ASP.NET 執行時間會追蹤資料表的目前 `changeId` `SqlCacheDependency` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-142">The ASP.NET runtime tracks the current `changeId` for a table when caching data using a `SqlCacheDependency` object.</span></span> <span data-ttu-id="9c8c4-143">系統會定期檢查資料庫，而且與 `SqlCacheDependency` `changeId` 資料庫中的值不同的任何物件都會被收回，因為不同的 `changeId` 值表示自快取資料以來，資料表已經有變更。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-143">The database is periodically checked and any `SqlCacheDependency` objects whose `changeId` differs from the value in the database are evicted since a differing `changeId` value indicates that there has been a change to the table since the data was cached.</span></span>

## <a name="step-1-exploring-theaspnet_regsqlexecommand-line-program"></a><span data-ttu-id="9c8c4-144">步驟1：探索 `aspnet_regsql.exe` 命令列程式</span><span class="sxs-lookup"><span data-stu-id="9c8c4-144">Step 1: Exploring the`aspnet_regsql.exe`Command Line Program</span></span>

<span data-ttu-id="9c8c4-145">使用輪詢方法時，必須將資料庫設定為包含上述基礎結構：預先定義的資料表 (`AspNet_SqlCacheTablesForChangeNotification`) 、一些預存程式，以及每個資料表上的觸發程式，這些資料表可用於 web 應用程式中的 SQL 快取相依性。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-145">With the polling approach the database must be setup to contain the infrastructure described above: a predefined table (`AspNet_SqlCacheTablesForChangeNotification`), a handful of stored procedures, and triggers on each of the tables that may be used in SQL cache dependencies in the web application.</span></span> <span data-ttu-id="9c8c4-146">您可以透過命令列程式 `aspnet_regsql.exe` （可在資料夾中找到）來建立這些資料表、預存程式和觸發程式 `$WINDOWS$\Microsoft.NET\Framework\version` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-146">These tables, stored procedures, and triggers can be created through the command line program `aspnet_regsql.exe`, which is found in the `$WINDOWS$\Microsoft.NET\Framework\version` folder.</span></span> <span data-ttu-id="9c8c4-147">若要建立 `AspNet_SqlCacheTablesForChangeNotification` 資料表和相關聯的預存程式，請從命令列執行下列命令：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-147">To create the `AspNet_SqlCacheTablesForChangeNotification` table and associated stored procedures, run the following from the command line:</span></span>

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample1.cmd)]

> [!NOTE]
> <span data-ttu-id="9c8c4-148">若要執行這些命令，指定的資料庫登入必須在 [`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx) 和 [`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx) 角色中。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-148">To execute these commands the specified database login must be in the [`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx) and [`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx) roles.</span></span> <span data-ttu-id="9c8c4-149">若要檢查命令列程式傳送至資料庫的 T-sql `aspnet_regsql.exe` ，請參閱 [此 blog 專案](http://scottonwriting.net/sowblog/posts/10709.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-149">To examine the T-SQL sent to the database by the `aspnet_regsql.exe` command line program, refer to [this blog entry](http://scottonwriting.net/sowblog/posts/10709.aspx).</span></span>

<span data-ttu-id="9c8c4-150">例如，若要將輪詢的基礎結構新增至 `pubs` 使用 Windows 驗證命名的資料庫伺服器上的 Microsoft SQL Server 資料庫 `ScottsServer` ，請流覽至適當的目錄，然後從命令列輸入：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-150">For example, to add the infrastructure for polling to a Microsoft SQL Server database named `pubs` on a database server named `ScottsServer` using Windows Authentication, navigate to the appropriate directory and, from the command line, enter:</span></span>

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample2.cmd)]

<span data-ttu-id="9c8c4-151">加入資料庫層級基礎結構之後，我們必須將觸發程式新增至將用於 SQL 快取相依性的資料表。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-151">After the database-level infrastructure has been added, we need to add the triggers to those tables that will be used in SQL cache dependencies.</span></span> <span data-ttu-id="9c8c4-152">再次使用 `aspnet_regsql.exe` 命令列程式，但使用參數指定資料表名稱， `-t` 而不使用 `-ed` 參數使用 `-et` ，如下所示：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-152">Use the `aspnet_regsql.exe` command line program again, but specify the table name using the `-t` switch and instead of using the `-ed` switch use `-et`, like so:</span></span>

[!code-html[Main](using-sql-cache-dependencies-cs/samples/sample3.html)]

<span data-ttu-id="9c8c4-153">若要將觸發程式加入 `authors` `titles` 資料庫上的和資料表 `pubs` `ScottsServer` ，請使用：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-153">To add the triggers to the `authors` and `titles` tables on the `pubs` database on `ScottsServer`, use:</span></span>

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample4.cmd)]

<span data-ttu-id="9c8c4-154">針對此教學課程，請將觸發程式加入至 `Products` 、 `Categories` 和 `Suppliers` 資料表。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-154">For this tutorial add the triggers to the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="9c8c4-155">我們將在步驟3中探討特定的命令列語法。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-155">We'll look at the particular command line syntax in Step 3.</span></span>

## <a name="step-2-referencing-a-microsoft-sql-server-2005-express-edition-database-inapp_data"></a><span data-ttu-id="9c8c4-156">步驟2：參考中的 Microsoft SQL Server 2005 Express Edition 資料庫`App_Data`</span><span class="sxs-lookup"><span data-stu-id="9c8c4-156">Step 2: Referencing a Microsoft SQL Server 2005 Express Edition Database in`App_Data`</span></span>

<span data-ttu-id="9c8c4-157">`aspnet_regsql.exe`命令列程式需要資料庫和伺服器名稱，才能新增必要的輪詢基礎結構。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-157">The `aspnet_regsql.exe` command line program requires the database and server name in order to add the necessary polling infrastructure.</span></span> <span data-ttu-id="9c8c4-158">但是位於資料夾中的 Microsoft SQL Server 2005 Express 資料庫的資料庫和伺服器名稱是什麼 `App_Data` ？</span><span class="sxs-lookup"><span data-stu-id="9c8c4-158">But what is the database and server name for a Microsoft SQL Server 2005 Express database that resides in the `App_Data` folder?</span></span> <span data-ttu-id="9c8c4-159">我認為最簡單的方法就是將資料庫附加至 `localhost\SQLExpress` 資料庫實例，然後使用 [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx)重新命名資料，而不需要探索資料庫和伺服器名稱。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-159">Rather than having to discover what the database and server names are, I ve found that the simplest approach is to attach the database to the `localhost\SQLExpress` database instance and rename the data using [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx).</span></span> <span data-ttu-id="9c8c4-160">如果您的電腦上已安裝 SQL Server 2005 的其中一個完整版本，則您可能已經在電腦上安裝 SQL Server Management Studio。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-160">If you have one of the full versions of SQL Server 2005 installed on your machine, then you likely already have SQL Server Management Studio installed on your computer.</span></span> <span data-ttu-id="9c8c4-161">如果您只有 Express edition，可以下載免費的 [Microsoft SQL Server Management Studio Express 版](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796)。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-161">If you only have the Express edition, you can download the free [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="9c8c4-162">從關閉 Visual Studio 開始。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-162">Start by closing Visual Studio.</span></span> <span data-ttu-id="9c8c4-163">接著，開啟 SQL Server Management Studio，然後選擇 `localhost\SQLExpress` 使用 Windows 驗證連接到伺服器。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-163">Next, open SQL Server Management Studio and choose to connect to the `localhost\SQLExpress` server using Windows Authentication.</span></span>

![附加至 localhost\SQLExpress 伺服器](using-sql-cache-dependencies-cs/_static/image1.gif)

<span data-ttu-id="9c8c4-165">**圖 1**：附加至 `localhost\SQLExpress` 伺服器</span><span class="sxs-lookup"><span data-stu-id="9c8c4-165">**Figure 1**: Attach to the `localhost\SQLExpress` Server</span></span>

<span data-ttu-id="9c8c4-166">連接到伺服器之後，Management Studio 將會顯示伺服器，並具有資料庫、安全性等的子資料夾。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-166">After connecting to the server, Management Studio will show the server and have subfolders for the databases, security, and so forth.</span></span> <span data-ttu-id="9c8c4-167">以滑鼠右鍵按一下 [資料庫] 資料夾，然後選擇 [附加] 選項。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-167">Right-click on the Databases folder and choose the Attach option.</span></span> <span data-ttu-id="9c8c4-168">這會顯示 [附加資料庫] 對話方塊 (請參閱 [圖 2]) 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-168">This will bring up the Attach Databases dialog box (see Figure 2).</span></span> <span data-ttu-id="9c8c4-169">按一下 [加入] 按鈕，然後選取 `NORTHWND.MDF` web 應用程式資料夾中的 [資料庫] 資料夾 `App_Data` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-169">Click the Add button and select the `NORTHWND.MDF` database folder in your web application s `App_Data` folder.</span></span>

<span data-ttu-id="9c8c4-170">[![附加 NORTHWND.MDF 檔。App_Data 資料夾中的 MDF 資料庫](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-170">[![Attach the NORTHWND.MDF Database from the App_Data Folder](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)</span></span>

<span data-ttu-id="9c8c4-171">**圖 2**： `NORTHWND.MDF` 從資料夾附加資料庫 `App_Data` ([按一下以查看完整大小的影像](using-sql-cache-dependencies-cs/_static/image2.png)) </span><span class="sxs-lookup"><span data-stu-id="9c8c4-171">**Figure 2**: Attach the `NORTHWND.MDF` Database from the `App_Data` Folder ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image2.png))</span></span>

<span data-ttu-id="9c8c4-172">這會將資料庫加入至 [資料庫] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-172">This will add the database to the Databases folder.</span></span> <span data-ttu-id="9c8c4-173">資料庫名稱可能是資料庫檔案的完整路徑，或前面加上 [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier)的完整路徑。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-173">The database name might be the full path to the database file or the full path prepended with a [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier).</span></span> <span data-ttu-id="9c8c4-174">若要避免在使用 aspnetregsql.exe 命令列工具時必須輸入這個冗長的資料庫名稱 \_ ，請在剛剛附加的資料庫上按一下滑鼠右鍵，然後選擇 [重新命名]，將資料庫重新命名為更容易使用的名稱。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-174">To avoid having to type in this lengthy database name when using the aspnet\_regsql.exe command line tool, rename the database to a more human-friendly name by right-clicking on database just attached and choosing Rename.</span></span> <span data-ttu-id="9c8c4-175">我已將資料庫重新命名為 DataTutorials。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-175">I ve renamed my database to DataTutorials .</span></span>

![將附加的資料庫重新命名為更易記的名稱](using-sql-cache-dependencies-cs/_static/image3.gif)

<span data-ttu-id="9c8c4-177">**圖 3**：將附加的資料庫重新命名為更易記的名稱</span><span class="sxs-lookup"><span data-stu-id="9c8c4-177">**Figure 3**: Rename the Attached Database to a More Human-Friendly Name</span></span>

## <a name="step-3-adding-the-polling-infrastructure-to-the-northwind-database"></a><span data-ttu-id="9c8c4-178">步驟3：將輪詢基礎結構新增至 Northwind 資料庫</span><span class="sxs-lookup"><span data-stu-id="9c8c4-178">Step 3: Adding the Polling Infrastructure to the Northwind Database</span></span>

<span data-ttu-id="9c8c4-179">既然我們已 `NORTHWND.MDF` 從資料夾附加資料庫，就可以 `App_Data` 開始加入輪詢基礎結構。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-179">Now that we have attached the `NORTHWND.MDF` database from the `App_Data` folder, we re ready to add the polling infrastructure.</span></span> <span data-ttu-id="9c8c4-180">假設您已將資料庫重新命名為 DataTutorials，請執行下列四個命令：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-180">Assuming that you ve renamed the database to DataTutorials, run the following four commands:</span></span>

[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample5.cmd)]

<span data-ttu-id="9c8c4-181">執行這四個命令之後，以滑鼠右鍵按一下 Management Studio 中的資料庫名稱，移至 [工作] 子功能表，然後選擇 [卸離]。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-181">After running these four commands, right-click on the database name in Management Studio, go to the Tasks submenu, and choose Detach.</span></span> <span data-ttu-id="9c8c4-182">然後關閉 Management Studio 然後重新開啟 Visual Studio。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-182">Then close Management Studio and reopen Visual Studio.</span></span>

<span data-ttu-id="9c8c4-183">一旦 Visual Studio 重新開啟後，請透過伺服器總管向內切入資料庫。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-183">Once Visual Studio has reopened, drill into the database through the Server Explorer.</span></span> <span data-ttu-id="9c8c4-184">請注意，新的資料表 (`AspNet_SqlCacheTablesForChangeNotification`) 、新的預存程式，以及 `Products` 、 `Categories` 和資料表上的觸發程式 `Suppliers` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-184">Note the new table (`AspNet_SqlCacheTablesForChangeNotification`), the new stored procedures, and the triggers on the `Products`, `Categories`, and `Suppliers` tables.</span></span>

![資料庫現在包含必要的輪詢基礎結構](using-sql-cache-dependencies-cs/_static/image4.gif)

<span data-ttu-id="9c8c4-186">**圖 4**：資料庫現在包含必要的輪詢基礎結構</span><span class="sxs-lookup"><span data-stu-id="9c8c4-186">**Figure 4**: The Database Now Includes the Necessary Polling Infrastructure</span></span>

## <a name="step-4-configuring-the-polling-service"></a><span data-ttu-id="9c8c4-187">步驟4：設定輪詢服務</span><span class="sxs-lookup"><span data-stu-id="9c8c4-187">Step 4: Configuring the Polling Service</span></span>

<span data-ttu-id="9c8c4-188">在資料庫中建立所需的資料表、觸發程式和預存程式之後，最後一個步驟是設定輪詢服務，這是藉 `Web.config` 由指定要使用的資料庫和輪詢頻率（以毫秒為單位）來完成。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-188">After creating the needed tables, triggers, and stored procedures in the database, the final step is to configure the polling service, which is done through `Web.config` by specifying the databases to use and the polling frequency in milliseconds.</span></span> <span data-ttu-id="9c8c4-189">下列標記會每秒輪詢一次 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-189">The following markup polls the Northwind database once every second.</span></span>

[!code-xml[Main](using-sql-cache-dependencies-cs/samples/sample6.xml)]

<span data-ttu-id="9c8c4-190">專案 `name` 中的值 `<add>` ( NorthwindDB ) 將人們可讀取的名稱與特定的資料庫產生關聯。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-190">The `name` value in the `<add>` element ( NorthwindDB ) associates a human-readable name with a particular database.</span></span> <span data-ttu-id="9c8c4-191">使用 SQL 快取相依性時，我們必須參考這裡定義的資料庫名稱，以及快取資料所依據的資料表。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-191">When working with SQL cache dependencies, we'll need to refer to the database name defined here as well as the table that the cached data is based on.</span></span> <span data-ttu-id="9c8c4-192">我們將瞭解如何使用類別，以程式設計方式將 SQL 快取相依性 `SqlCacheDependency` 與步驟6中的快取資料產生關聯。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-192">We'll see how to use the `SqlCacheDependency` class to programmatically associate SQL cache dependencies with cached data in Step 6.</span></span>

<span data-ttu-id="9c8c4-193">一旦建立 SQL 快取相依性之後，輪詢系統將會每毫秒連接至元素中定義的資料庫， `<databases>` `pollTime` 並執行 `AspNet_SqlCachePollingStoredProcedure` 預存程式。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-193">Once a SQL cache dependency has been established, the polling system will connect to the databases defined in the `<databases>` elements every `pollTime` milliseconds and execute the `AspNet_SqlCachePollingStoredProcedure` stored procedure.</span></span> <span data-ttu-id="9c8c4-194">這個預存程式（使用命令列工具在步驟3中新增 `aspnet_regsql.exe` ）-會傳回 `tableName` `changeId` 中每一筆記錄的和值 `AspNet_SqlCacheTablesForChangeNotification` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-194">This stored procedure - which was added back in Step 3 using the `aspnet_regsql.exe` command line tool - returns the `tableName` and `changeId` values for each record in `AspNet_SqlCacheTablesForChangeNotification`.</span></span> <span data-ttu-id="9c8c4-195">過期的 SQL 快取相依性會從快取中收回。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-195">Outdated SQL cache dependencies are evicted from the cache.</span></span>

<span data-ttu-id="9c8c4-196">此 `pollTime` 設定會導致效能與資料過期之間的取捨。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-196">The `pollTime` setting introduces a tradeoff between performance and data staleness.</span></span> <span data-ttu-id="9c8c4-197">較小的 `pollTime` 值會增加對資料庫的要求數目，但會更快速地從快取中收回過時的資料。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-197">A small `pollTime` value increases the number of requests to the database, but more quickly evicts stale data from the cache.</span></span> <span data-ttu-id="9c8c4-198">較大的 `pollTime` 值會減少資料庫要求的數目，但會增加後端資料變更和收回相關快取專案之間的延遲。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-198">A larger `pollTime` value reduces the number of database requests, but increases the delay between when the backend data changes and when the related cache items are evicted.</span></span> <span data-ttu-id="9c8c4-199">幸運的是，資料庫要求正在執行簡單的預存程式，而該預存程式只會從簡單的輕量資料表傳回幾個資料列。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-199">Fortunately, the database request is executing a simple stored procedure that s returning just a few rows from a simple, lightweight table.</span></span> <span data-ttu-id="9c8c4-200">但是，請使用不同的值進行實驗， `pollTime` 以找出應用程式的資料庫存取和資料過期之間的理想平衡。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-200">But do experiment with different `pollTime` values to find an ideal balance between database access and data staleness for your application.</span></span> <span data-ttu-id="9c8c4-201">允許的最小 `pollTime` 值是500。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-201">The smallest `pollTime` value allowed is 500.</span></span>

> [!NOTE]
> <span data-ttu-id="9c8c4-202">上述範例 `pollTime` 會在元素中提供單一值 `<sqlCacheDependency>` ，但您可以選擇性地在 `pollTime` 元素中指定值 `<add>` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-202">The above example provides a single `pollTime` value in the `<sqlCacheDependency>` element, but you can optionally specify the `pollTime` value in the `<add>` element.</span></span> <span data-ttu-id="9c8c4-203">如果您指定了多個資料庫，而且想要自訂每個資料庫的輪詢頻率，這就很有用。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-203">This is useful if you have multiple databases specified and want to customize the polling frequency per database.</span></span>

## <a name="step-5-declaratively-working-with-sql-cache-dependencies"></a><span data-ttu-id="9c8c4-204">步驟5：以宣告方式使用 SQL 快取相依性</span><span class="sxs-lookup"><span data-stu-id="9c8c4-204">Step 5: Declaratively Working with SQL Cache Dependencies</span></span>

<span data-ttu-id="9c8c4-205">在步驟1到4中，我們探討了如何設定所需的資料庫基礎結構，以及如何設定輪詢系統。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-205">In Steps 1 through 4 we looked at how to setup the necessary database infrastructure and configure the polling system.</span></span> <span data-ttu-id="9c8c4-206">有了這個基礎結構之後，我們就可以使用程式設計方式或宣告式技術，將專案新增至資料快取，以及相關聯的 SQL 快取相依性。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-206">With this infrastructure in place, we can now add items to the data cache with an associated SQL cache dependency using either programmatic or declarative techniques.</span></span> <span data-ttu-id="9c8c4-207">在此步驟中，我們將探討如何以宣告方式使用 SQL 快取相依性。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-207">In this step we'll examine how to declaratively work with SQL cache dependencies.</span></span> <span data-ttu-id="9c8c4-208">在步驟6中，我們將探討以程式設計的方法。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-208">In Step 6 we'll look at the programmatic approach.</span></span>

<span data-ttu-id="9c8c4-209">[使用 objectdatasource](caching-data-with-the-objectdatasource-cs.md)教學課程的快取資料會探索 ObjectDataSource 的宣告式快取功能。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-209">The [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial explored the declarative caching capabilities of the ObjectDataSource.</span></span> <span data-ttu-id="9c8c4-210">藉由將 `EnableCaching` 屬性設定為，並將屬性設定 `true` `CacheDuration` 為某個時間間隔，ObjectDataSource 將會自動快取在指定間隔內從其基礎物件傳回的資料。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-210">By simply setting the `EnableCaching` property to `true` and the `CacheDuration` property to some time interval, the ObjectDataSource will automatically cache the data returned from its underlying object for the specified interval.</span></span> <span data-ttu-id="9c8c4-211">ObjectDataSource 也可以使用一或多個 SQL 快取相依性。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-211">The ObjectDataSource can also use one or more SQL cache dependencies.</span></span>

<span data-ttu-id="9c8c4-212">若要示範如何以宣告方式使用 SQL 快取相依性，請開啟 `SqlCacheDependencies.aspx` 資料夾中的頁面， `Caching` 然後從 [工具箱] 將 GridView 拖曳至設計工具。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-212">To demonstrate using SQL cache dependencies declaratively, open the `SqlCacheDependencies.aspx` page in the `Caching` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="9c8c4-213">將 GridView 設定 `ID` 為 `ProductsDeclarative` ，並從其智慧標籤選擇將其系結至名為的新 ObjectDataSource `ProductsDataSourceDeclarative` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-213">Set the GridView s `ID` to `ProductsDeclarative` and, from its smart tag, choose to bind it to a new ObjectDataSource named `ProductsDataSourceDeclarative`.</span></span>

<span data-ttu-id="9c8c4-214">[![建立名為 ProductsDataSourceDeclarative 的新 ObjectDataSource](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-214">[![Create a New ObjectDataSource Named ProductsDataSourceDeclarative](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)</span></span>

<span data-ttu-id="9c8c4-215">**圖 5**：建立名為 `ProductsDataSourceDeclarative` ([按一下以查看完整大小影像](using-sql-cache-dependencies-cs/_static/image4.png)) 的新 ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="9c8c4-215">**Figure 5**: Create a New ObjectDataSource Named `ProductsDataSourceDeclarative` ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image4.png))</span></span>

<span data-ttu-id="9c8c4-216">將 ObjectDataSource 設定為使用 `ProductsBLL` 類別，並將 [選取] 索引標籤中的下拉式清單設定為 `GetProducts()` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-216">Configure the ObjectDataSource to use the `ProductsBLL` class and set the drop-down list in the SELECT tab to `GetProducts()`.</span></span> <span data-ttu-id="9c8c4-217">在 [更新] 索引標籤中，選擇 `UpdateProduct` 具有三個輸入參數的多載- `productName` 、 `unitPrice` 和 `productID` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-217">In the UPDATE tab, choose the `UpdateProduct` overload with three input parameters - `productName`, `unitPrice`, and `productID`.</span></span> <span data-ttu-id="9c8c4-218">在 [插入] 和 [刪除] 索引標籤中，將下拉式清單設定為 [無])  (。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-218">Set the drop-down lists to (None) in the INSERT and DELETE tabs.</span></span>

<span data-ttu-id="9c8c4-219">[![使用 UpdateProduct 多載搭配三個輸入參數](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-219">[![Use the UpdateProduct Overload with Three Input Parameters](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)</span></span>

<span data-ttu-id="9c8c4-220">**圖 6**：搭配三個輸入參數使用 UpdateProduct 多載 ([按一下以查看完整大小的影像](using-sql-cache-dependencies-cs/_static/image6.png)) </span><span class="sxs-lookup"><span data-stu-id="9c8c4-220">**Figure 6**: Use the UpdateProduct Overload with Three Input Parameters ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image6.png))</span></span>

<span data-ttu-id="9c8c4-221">[![將下拉式清單設定為 [插入] 和 [刪除] 索引標籤 ([無]) ](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-221">[![Set the Drop-Down List to (None) for the INSERT and DELETE Tabs](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)</span></span>

<span data-ttu-id="9c8c4-222">**圖 7**：將下拉式清單設定為 [插入] 和 [刪除] 索引標籤 ([無])  ([按一下以查看完整大小的影像](using-sql-cache-dependencies-cs/_static/image8.png)) </span><span class="sxs-lookup"><span data-stu-id="9c8c4-222">**Figure 7**: Set the Drop-Down List to (None) for the INSERT and DELETE Tabs ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image8.png))</span></span>

<span data-ttu-id="9c8c4-223">完成設定資料來源嚮導之後，Visual Studio 將會在 GridView 中為每個資料欄位建立 BoundFields 和 CheckBoxFields。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-223">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="9c8c4-224">移除所有欄位 `ProductName` ，但、 `CategoryName` 和 `UnitPrice` ，並依您的需要將這些欄位格式化。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-224">Remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="9c8c4-225">從 GridView 的智慧標籤，勾選 [啟用分頁]、[啟用排序] 和 [啟用編輯] 核取方塊。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-225">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="9c8c4-226">Visual Studio 會將 ObjectDataSource s `OldValuesParameterFormatString` 屬性設為 `original_{0}` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-226">Visual Studio will set the ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="9c8c4-227">為了讓 GridView 的編輯功能正常運作，請從宣告式語法完全移除此屬性，或將它設回其預設值 `{0}` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-227">In order for the GridView s edit feature to work properly, either remove this property entirely from the declarative syntax or set it back to its default value, `{0}`.</span></span>

<span data-ttu-id="9c8c4-228">最後，在 GridView 上方新增 Label Web 控制項，並將其 `ID` 屬性設定為 `ODSEvents` ，並將其 `EnableViewState` 屬性設定為 `false` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-228">Finally, add a Label Web control above the GridView and set its `ID` property to `ODSEvents` and its `EnableViewState` property to `false`.</span></span> <span data-ttu-id="9c8c4-229">進行這些變更之後，您的頁面宣告式標記看起來應該會如下所示。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-229">After making these changes, your page s declarative markup should look similar to the following.</span></span> <span data-ttu-id="9c8c4-230">請注意，我對 GridView 欄位進行了許多美觀的自訂，而這些欄位並非示範 SQL 快取相依性功能的必要專案。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-230">Note that I ve made a number of aesthetic customizations to the GridView fields that are not necessary to demonstrate the SQL cache dependency functionality.</span></span>

[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample7.aspx)]

<span data-ttu-id="9c8c4-231">接下來，為 ObjectDataSource s 事件建立事件處理常式 `Selecting` ，並在其中新增下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-231">Next, create an event handler for the ObjectDataSource s `Selecting` event and in it add the following code:</span></span>

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample8.cs)]

<span data-ttu-id="9c8c4-232">回想一下，ObjectDataSource s `Selecting` 事件只會在從其基礎物件中取出資料時引發。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-232">Recall that the ObjectDataSource s `Selecting` event fires only when retrieving data from its underlying object.</span></span> <span data-ttu-id="9c8c4-233">如果 ObjectDataSource 從自己的快取存取資料，則不會引發此事件。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-233">If the ObjectDataSource accesses the data from its own cache, this event is not fired.</span></span>

<span data-ttu-id="9c8c4-234">現在，請透過瀏覽器造訪此頁面。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-234">Now, visit this page through a browser.</span></span> <span data-ttu-id="9c8c4-235">由於我們尚未執行任何快取，因此每次您分頁、排序或編輯格線時，頁面應該會顯示 [正在引發的事件] 文字（如 [圖 8] 所示）。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-235">Since we ve yet to implement any caching, each time you page, sort, or edit the grid the page should display the text, 'Selecting event fired, as Figure 8 shows.</span></span>

<span data-ttu-id="9c8c4-236">[![每次 GridView 進行分頁、編輯或排序時，會引發選取事件的 ObjectDataSource](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-236">[![The ObjectDataSource s Selecting Event Fires Each Time the GridView is Paged, Edited, or Sorted](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)</span></span>

<span data-ttu-id="9c8c4-237">**圖 8**： `Selecting` 每次 GridView 進行分頁、編輯或排序 ([按一下以查看完整大小的影像](using-sql-cache-dependencies-cs/_static/image10.png) 時，都會引發 ObjectDataSource s 事件) </span><span class="sxs-lookup"><span data-stu-id="9c8c4-237">**Figure 8**: The ObjectDataSource s `Selecting` Event Fires Each Time the GridView is Paged, Edited, or Sorted ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image10.png))</span></span>

<span data-ttu-id="9c8c4-238">如我們在 [使用 ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) 教學課程快取資料中所見，將 `EnableCaching` 屬性設為， `true` 會導致 ObjectDataSource 在其屬性指定的持續時間內快取其資料 `CacheDuration` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-238">As we saw in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial, setting the `EnableCaching` property to `true` causes the ObjectDataSource to cache its data for the duration specified by its `CacheDuration` property.</span></span> <span data-ttu-id="9c8c4-239">ObjectDataSource 也有一個屬性，此[ `SqlCacheDependency` 屬性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx)會使用模式將一或多個 SQL 快取相依性新增至快取的資料：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-239">The ObjectDataSource also has a [`SqlCacheDependency` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), which adds one or more SQL cache dependencies to the cached data using the pattern:</span></span>

[!code-css[Main](using-sql-cache-dependencies-cs/samples/sample9.css)]

<span data-ttu-id="9c8c4-240">其中 *databaseName* 是中專案的屬性所指定的資料庫名稱 `name` `<add>` `Web.config` ，而 *tableName* 是資料庫資料表的名稱。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-240">Where *databaseName* is the name of the database as specified in the `name` attribute of the `<add>` element in `Web.config`, and *tableName* is the name of the database table.</span></span> <span data-ttu-id="9c8c4-241">例如，若要建立根據 Northwind s 資料表的 SQL 快取相依性無限快取資料的 ObjectDataSource `Products` ，請將 objectdatasource s `EnableCaching` 屬性設為 `true` ，並將其 `SqlCacheDependency` 屬性設定為 NorthwindDB： Products。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-241">For example, to create an ObjectDataSource that caches data indefinitely based on a SQL cache dependency against the Northwind s `Products` table, set the ObjectDataSource s `EnableCaching` property to `true` and its `SqlCacheDependency` property to NorthwindDB:Products .</span></span>

> [!NOTE]
> <span data-ttu-id="9c8c4-242">您可以使用 SQL 快取相依性 *和* 以時間為基礎的到期，將設定 `EnableCaching` 為 `true` 、 `CacheDuration` 時間間隔，以及 `SqlCacheDependency` 資料庫和資料表名稱 (s) 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-242">You can use a SQL cache dependency *and* a time-based expiry by setting `EnableCaching` to `true`, `CacheDuration` to the time interval, and `SqlCacheDependency` to the database and table name(s).</span></span> <span data-ttu-id="9c8c4-243">當達到以時間為基礎的到期時，或當輪詢系統注意到基礎資料庫資料已變更（以先發生者為准）時，ObjectDataSource 會收回其資料。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-243">The ObjectDataSource will evict its data when the time-based expiry is reached or when the polling system notes that the underlying database data has changed, whichever happens first.</span></span>

<span data-ttu-id="9c8c4-244">中的 GridView `SqlCacheDependencies.aspx` 會顯示來自兩個數據表的資料 `Products` ，而 `Categories` (product s `CategoryName` 欄位則是 `JOIN` 透過 `Categories`) 來抓取。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-244">The GridView in `SqlCacheDependencies.aspx` displays data from two tables - `Products` and `Categories` (the product s `CategoryName` field is retrieved via a `JOIN` on `Categories`).</span></span> <span data-ttu-id="9c8c4-245">因此，我們想要指定兩個 SQL 快取相依性： NorthwindDB： Products;NorthwindDB：分類。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-245">Therefore, we want to specify two SQL cache dependencies: NorthwindDB:Products;NorthwindDB:Categories .</span></span>

<span data-ttu-id="9c8c4-246">[![設定 ObjectDataSource 以支援使用 SQL 快取相依性的產品和類別進行快取](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-246">[![Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on Products and Categories](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)</span></span>

<span data-ttu-id="9c8c4-247">**圖 9**：設定 ObjectDataSource 以支援在上使用 SQL 快取相依性的快取 `Products` ， `Categories` ([按一下以查看完整大小的影像](using-sql-cache-dependencies-cs/_static/image12.png)) </span><span class="sxs-lookup"><span data-stu-id="9c8c4-247">**Figure 9**: Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on `Products` and `Categories` ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image12.png))</span></span>

<span data-ttu-id="9c8c4-248">設定 ObjectDataSource 以支援快取之後，請透過瀏覽器重新流覽頁面。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-248">After configuring the ObjectDataSource to support caching, revisit the page through a browser.</span></span> <span data-ttu-id="9c8c4-249">同樣地，所引發的文字「選取事件」應該會出現在第一頁流覽，但在分頁、排序或按一下 [編輯] 或 [取消] 按鈕時應該會消失。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-249">Again, the text 'Selecting event fired should appear on the first page visit, but should go away when paging, sorting, or clicking the Edit or Cancel buttons.</span></span> <span data-ttu-id="9c8c4-250">這是因為在將資料載入 ObjectDataSource 快取之後，它會一直留在那裡，直到 `Products` 或 `Categories` 資料表遭到修改或資料透過 GridView 更新為止。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-250">This is because after the data is loaded into the ObjectDataSource s cache, it remains there until the `Products` or `Categories` tables are modified or the data is updated through the GridView.</span></span>

<span data-ttu-id="9c8c4-251">逐頁查看方格並指出缺少「選取事件引發文字」之後，請開啟新的瀏覽器視窗，並流覽至 [編輯]、[插入] 和 [刪除] 區段中的基本教學課程， (`~/EditInsertDelete/Basics.aspx`) 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-251">After paging through the grid and noting the lack of the 'Selecting event fired text, open a new browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="9c8c4-252">更新產品的名稱或價格。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-252">Update the name or price of a product.</span></span> <span data-ttu-id="9c8c4-253">然後，從到第一個瀏覽器視窗，查看不同的資料頁面、排序方格，或按一下資料列的 [編輯] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-253">Then, from to the first browser window, view a different page of data, sort the grid, or click a row s Edit button.</span></span> <span data-ttu-id="9c8c4-254">這次，[選取引發的事件] 應該會再次出現，因為基礎資料庫資料已修改 (請參閱 [圖 10]) 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-254">This time, the 'Selecting event fired should reappear, as the underlying database data has been modified (see Figure 10).</span></span> <span data-ttu-id="9c8c4-255">如果文字未出現，請稍候片刻，然後再試一次。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-255">If the text does not appear, wait a few moments and try again.</span></span> <span data-ttu-id="9c8c4-256">請記住，輪詢服務會 `Products` 每毫秒檢查資料表的變更 `pollTime` ，因此在更新基礎資料和收回快取資料之間會有延遲。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-256">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>

<span data-ttu-id="9c8c4-257">[![修改 Products 資料表收回快取的產品資料](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-257">[![Modifying the Products Table Evicts the Cached Product Data](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)</span></span>

<span data-ttu-id="9c8c4-258">**圖 10**：修改 Products 資料表收回快取的產品資料 ([按一下以查看完整大小的影像](using-sql-cache-dependencies-cs/_static/image14.png)) </span><span class="sxs-lookup"><span data-stu-id="9c8c4-258">**Figure 10**: Modifying the Products Table Evicts the Cached Product Data ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image14.png))</span></span>

## <a name="step-6-programmatically-working-with-thesqlcachedependencyclass"></a><span data-ttu-id="9c8c4-259">步驟6：以程式設計方式使用 `SqlCacheDependency` 類別</span><span class="sxs-lookup"><span data-stu-id="9c8c4-259">Step 6: Programmatically Working with the`SqlCacheDependency`Class</span></span>

<span data-ttu-id="9c8c4-260">架構教學課程中的快取 [資料](caching-data-in-the-architecture-cs.md) ，探討了在架構中使用不同快取層的優點，而不是將快取與 ObjectDataSource 緊密結合在一起。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-260">The [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorial looked at the benefits of using a separate Caching Layer in the architecture as opposed to tightly coupling the caching with the ObjectDataSource.</span></span> <span data-ttu-id="9c8c4-261">在該教學課程中，我們建立了一個 `ProductsCL` 類別來示範如何以程式設計方式使用資料快取。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-261">In that tutorial we created a `ProductsCL` class to demonstrate programmatically working with the data cache.</span></span> <span data-ttu-id="9c8c4-262">若要在快取層中使用 SQL 快取相依性，請使用 `SqlCacheDependency` 類別。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-262">To utilize SQL cache dependencies in the Caching Layer, use the `SqlCacheDependency` class.</span></span>

<span data-ttu-id="9c8c4-263">使用輪詢系統時， `SqlCacheDependency` 物件必須與特定的資料庫和資料表配對相關聯。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-263">With the polling system, a `SqlCacheDependency` object must be associated with a particular database and table pair.</span></span> <span data-ttu-id="9c8c4-264">例如，下列程式碼會建立以 `SqlCacheDependency` Northwind 資料庫資料表為基礎的物件 `Products` ：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-264">The following code, for example, creates a `SqlCacheDependency` object based on the Northwind database s `Products` table:</span></span>

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample10.cs)]

<span data-ttu-id="9c8c4-265">S 函數的兩個輸入參數 `SqlCacheDependency` 分別是資料庫和資料表名稱。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-265">The two input parameters to the `SqlCacheDependency` s constructor are the database and table names, respectively.</span></span> <span data-ttu-id="9c8c4-266">如同使用 ObjectDataSource s `SqlCacheDependency` 屬性，所使用的資料庫名稱與中專案的屬性所指定的值相同 `name` `<add>` `Web.config` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-266">Like with the ObjectDataSource s `SqlCacheDependency` property, the database name used is the same as the value specified in the `name` attribute of the `<add>` element in `Web.config`.</span></span> <span data-ttu-id="9c8c4-267">資料表名稱是資料庫資料表的實際名稱。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-267">The table name is the actual name of the database table.</span></span>

<span data-ttu-id="9c8c4-268">若要將 `SqlCacheDependency` 與加入至資料快取的專案產生關聯，請使用可接受相依性的其中一個方法多載 `Insert` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-268">To associate a `SqlCacheDependency` with an item added to the data cache, use one of the `Insert` method overloads that accepts a dependency.</span></span> <span data-ttu-id="9c8c4-269">下列程式碼會將 *值* 加入至資料快取，以達無限期，但會將它與資料表上的相關聯 `SqlCacheDependency` `Products` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-269">The following code adds *value* to the data cache for an indefinite duration, but associates it with a `SqlCacheDependency` on the `Products` table.</span></span> <span data-ttu-id="9c8c4-270">簡單來說， *值* 將會保留在快取中，直到它因為記憶體限制而收回，或因為輪詢系統偵測到 `Products` 資料表自快取以來已經變更。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-270">In short, *value* will remain in the cache until it is evicted due to memory constraints or because the polling system has detected that the `Products` table has changed since it was cached.</span></span>

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample11.cs)]

<span data-ttu-id="9c8c4-271">快取層 `ProductsCL` 級的類別目前 `Products` 使用以時間為基礎的到期時間為60秒，來快取資料表中的資料。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-271">The Caching Layer s `ProductsCL` class currently caches data from the `Products` table using a time-based expiry of 60 seconds.</span></span> <span data-ttu-id="9c8c4-272">讓我們更新此類別，使其改為使用 SQL 快取相依性。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-272">Let s update this class so that it uses SQL cache dependencies instead.</span></span> <span data-ttu-id="9c8c4-273">`ProductsCL` `AddCacheItem` 負責將資料加入至快取的類別 s 方法，目前包含下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-273">The `ProductsCL` class s `AddCacheItem` method, which is responsible for adding the data to the cache, currently contains the following code:</span></span>

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample12.cs)]

<span data-ttu-id="9c8c4-274">更新此程式碼以使用 `SqlCacheDependency` 物件，而不是快取相依性 `MasterCacheKeyArray` ：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-274">Update this code to use a `SqlCacheDependency` object instead of the `MasterCacheKeyArray` cache dependency:</span></span>

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample13.cs)]

<span data-ttu-id="9c8c4-275">若要測試此功能，請將 GridView 新增至現有 GridView 底下的頁面 `ProductsDeclarative` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-275">To test this functionality, add a GridView to the page beneath the existing `ProductsDeclarative` GridView.</span></span> <span data-ttu-id="9c8c4-276">將這個新的 GridView 設定 `ID` 為， `ProductsProgrammatic` 並在其智慧標籤中，將它系結至名為的新 ObjectDataSource `ProductsDataSourceProgrammatic` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-276">Set this new GridView s `ID` to `ProductsProgrammatic` and, through its smart tag, bind it to a new ObjectDataSource named `ProductsDataSourceProgrammatic`.</span></span> <span data-ttu-id="9c8c4-277">將 ObjectDataSource 設定為使用 `ProductsCL` 類別，分別將 [選取和更新] 索引標籤中的下拉式清單設定為 `GetProducts` 和 `UpdateProduct` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-277">Configure the ObjectDataSource to use the `ProductsCL` class, setting the drop-down lists in the SELECT and UPDATE tabs to `GetProducts` and `UpdateProduct`, respectively.</span></span>

<span data-ttu-id="9c8c4-278">[![設定 ObjectDataSource 以使用 ProductsCL 類別](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-278">[![Configure the ObjectDataSource to Use the ProductsCL Class](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)</span></span>

<span data-ttu-id="9c8c4-279">**圖 11**：設定 ObjectDataSource 以使用 `ProductsCL` 類別 ([按一下以查看完整大小的影像](using-sql-cache-dependencies-cs/_static/image16.png)) </span><span class="sxs-lookup"><span data-stu-id="9c8c4-279">**Figure 11**: Configure the ObjectDataSource to Use the `ProductsCL` Class ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image16.png))</span></span>

<span data-ttu-id="9c8c4-280">[![從 [選取索引標籤] 下拉式清單中選取 GetProducts 方法](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-280">[![Select the GetProducts Method from the SELECT Tab s Drop-Down List](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)</span></span>

<span data-ttu-id="9c8c4-281">**圖 12**： `GetProducts` 從 [選取索引標籤] 下拉式清單選取方法 ([按一下以查看完整大小的影像](using-sql-cache-dependencies-cs/_static/image18.png)) </span><span class="sxs-lookup"><span data-stu-id="9c8c4-281">**Figure 12**: Select the `GetProducts` Method from the SELECT Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image18.png))</span></span>

<span data-ttu-id="9c8c4-282">[![從 [更新] 索引標籤的下拉式清單中選擇 UpdateProduct 方法](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-282">[![Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)</span></span>

<span data-ttu-id="9c8c4-283">**圖 13**：從 [更新] 索引標籤的下拉式清單中選擇 [UpdateProduct] 方法 ([按一下以查看完整大小的影像](using-sql-cache-dependencies-cs/_static/image20.png)) </span><span class="sxs-lookup"><span data-stu-id="9c8c4-283">**Figure 13**: Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image20.png))</span></span>

<span data-ttu-id="9c8c4-284">完成設定資料來源嚮導之後，Visual Studio 將會在 GridView 中為每個資料欄位建立 BoundFields 和 CheckBoxFields。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-284">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="9c8c4-285">就像是將第一個 GridView 加入至此頁面一樣，請移除所有欄位，包括 `ProductName` 、 `CategoryName` 和，並依 `UnitPrice` 您的需要將這些欄位格式化。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-285">Like with the first GridView added to this page, remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="9c8c4-286">從 GridView 的智慧標籤，勾選 [啟用分頁]、[啟用排序] 和 [啟用編輯] 核取方塊。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-286">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="9c8c4-287">和 objectdatasource 一樣 `ProductsDataSourceDeclarative` ，Visual Studio 會將 `ProductsDataSourceProgrammatic` objectdatasource s 屬性設 `OldValuesParameterFormatString` 為 `original_{0}` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-287">As with the `ProductsDataSourceDeclarative` ObjectDataSource, Visual Studio will set the `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="9c8c4-288">為了讓 GridView 的編輯功能正常運作，請將此屬性設回 (， `{0}` 或從宣告式語法中移除完全) 的屬性指派。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-288">In order for the GridView s edit feature to work properly, set this property back to `{0}` (or remove the property assignment from the declarative syntax altogether).</span></span>

<span data-ttu-id="9c8c4-289">完成這些工作之後，產生的 GridView 和 ObjectDataSource 宣告式標記看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-289">After completing these tasks, the resulting GridView and ObjectDataSource declarative markup should look like the following:</span></span>

[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample14.aspx)]

<span data-ttu-id="9c8c4-290">若要測試快取層中的 SQL 快取相依性， `ProductCL` 請在類別 s 方法中設定中斷點 `AddCacheItem` ，然後開始進行調試。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-290">To test the SQL cache dependency in the Caching Layer set a breakpoint in the `ProductCL` class s `AddCacheItem` method and then start debugging.</span></span> <span data-ttu-id="9c8c4-291">當您第一 `SqlCacheDependencies.aspx` 次造訪時，應該會叫用中斷點，因為第一次要求資料並放入快取中。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-291">When you first visit `SqlCacheDependencies.aspx`, the breakpoint should be hit as the data is requested for the first time and placed into the cache.</span></span> <span data-ttu-id="9c8c4-292">接下來，移至 GridView 中的另一個頁面，或排序其中一個資料行。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-292">Next, move to another page in the GridView or sort one of the columns.</span></span> <span data-ttu-id="9c8c4-293">這會導致 GridView 重新查詢其資料，但是應該在快取中找到資料，因為 `Products` 資料庫資料表尚未經過修改。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-293">This causes the GridView to requery its data, but the data should be found in the cache since the `Products` database table has not been modified.</span></span> <span data-ttu-id="9c8c4-294">如果在快取中找不到資料，請確定您的電腦上有足夠的記憶體可用，然後再試一次。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-294">If the data is repeatedly not found in the cache, make sure there is sufficient memory available on your computer and try again.</span></span>

<span data-ttu-id="9c8c4-295">逐頁查看 GridView 的幾個頁面之後，請開啟第二個瀏覽器視窗，並流覽至 [編輯]、[插入] 和 [刪除] 區段中的基本教學課程 (`~/EditInsertDelete/Basics.aspx`) 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-295">After paging through a few pages of the GridView, open a second browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="9c8c4-296">更新 Products 資料表中的記錄，然後從第一個瀏覽器視窗中，查看新頁面或按一下其中一個排序標頭。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-296">Update a record from the Products table and then, from the first browser window, view a new page or click on one of the sorting headers.</span></span>

<span data-ttu-id="9c8c4-297">在此案例中，您會看到兩個專案的其中一種：可能會叫用中斷點，表示快取的資料因為資料庫中的變更而收回;或者，將不會叫用中斷點，這表示 `SqlCacheDependencies.aspx` 現在會顯示過時的資料。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-297">In this scenario you will see one of two things: either the breakpoint will be hit, indicating that the cached data was evicted due to the change in the database; or, the breakpoint will not be hit, meaning that `SqlCacheDependencies.aspx` is now showing stale data.</span></span> <span data-ttu-id="9c8c4-298">如果未叫用中斷點，很可能是因為輪詢服務自從資料變更後尚未引發。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-298">If the breakpoint is not hit, it is likely because the polling service has not yet fired since the data was changed.</span></span> <span data-ttu-id="9c8c4-299">請記住，輪詢服務會 `Products` 每毫秒檢查資料表的變更 `pollTime` ，因此在更新基礎資料和收回快取資料之間會有延遲。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-299">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>

> [!NOTE]
> <span data-ttu-id="9c8c4-300">當您在中透過 GridView 編輯其中一項產品時，可能會出現此延遲 `SqlCacheDependencies.aspx` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-300">This delay is more likely to appear when editing one of the products through the GridView in `SqlCacheDependencies.aspx`.</span></span> <span data-ttu-id="9c8c4-301">在快取架構教學課程中的 [資料](caching-data-in-the-architecture-cs.md) 中，我們新增了快取相依性， `MasterCacheKeyArray` 以確保透過 `ProductsCL` 類別 s 方法編輯的資料已從快取 `UpdateProduct` 中收回。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-301">In the [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorial we added the `MasterCacheKeyArray` cache dependency to ensure that the data being edited through the `ProductsCL` class s `UpdateProduct` method was evicted from the cache.</span></span> <span data-ttu-id="9c8c4-302">不過，我們會在此步驟稍早修改方法時取代這個快取相依性 `AddCacheItem` ，因此，在 `ProductsCL` 輪詢系統記下資料表的變更之前，類別將會繼續顯示快取的資料 `Products` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-302">However, we replaced this cache dependency when modifying the `AddCacheItem` method earlier in this step and therefore the `ProductsCL` class will continue to show the cached data until the polling system notes the change to the `Products` table.</span></span> <span data-ttu-id="9c8c4-303">我們將瞭解如何 `MasterCacheKeyArray` 在步驟7中重新引入快取相依性。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-303">We'll see how to reintroduce the `MasterCacheKeyArray` cache dependency in Step 7.</span></span>

## <a name="step-7-associating-multiple-dependencies-with-a-cached-item"></a><span data-ttu-id="9c8c4-304">步驟7：建立多個相依性與快取專案的關聯</span><span class="sxs-lookup"><span data-stu-id="9c8c4-304">Step 7: Associating Multiple Dependencies with a Cached Item</span></span>

<span data-ttu-id="9c8c4-305">回想一下，快取相依性 `MasterCacheKeyArray` 是用來確保 *所有* 產品相關資料在更新時都會從快取中收回。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-305">Recall that the `MasterCacheKeyArray` cache dependency is used to ensure that *all* product-related data is evicted from the cache when any single item associated within it is updated.</span></span> <span data-ttu-id="9c8c4-306">例如，方法會快取 `GetProductsByCategoryID(categoryID)` `ProductsDataTables` 每個唯一 *類別類別* 值的實例。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-306">For example, the `GetProductsByCategoryID(categoryID)` method caches `ProductsDataTables` instances for each unique *categoryID* value.</span></span> <span data-ttu-id="9c8c4-307">如果已收回其中一個物件，則快 `MasterCacheKeyArray` 取相依性可確保也會移除其他物件。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-307">If one of these objects is evicted, the `MasterCacheKeyArray` cache dependency ensures that the others are also removed.</span></span> <span data-ttu-id="9c8c4-308">如果沒有這項快取相依性，當快取的資料遭到修改時，可能會有其他快取的產品資料已過期。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-308">Without this cache dependency, when the cached data is modified the possibility exists that other cached product data may be out of date.</span></span> <span data-ttu-id="9c8c4-309">因此，在使用 SQL 快取相依性時，我們必須維護快取相依性 `MasterCacheKeyArray` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-309">Consequently, it s important that we maintain the `MasterCacheKeyArray` cache dependency when using SQL cache dependencies.</span></span> <span data-ttu-id="9c8c4-310">但是，資料快取 s `Insert` 方法只允許單一相依性物件。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-310">However, the data cache s `Insert` method only allows for a single dependency object.</span></span>

<span data-ttu-id="9c8c4-311">此外，在使用 SQL 快取相依性時，可能需要將多個資料庫資料表關聯為相依性。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-311">Furthermore, when working with SQL cache dependencies we may need to associate multiple database tables as dependencies.</span></span> <span data-ttu-id="9c8c4-312">例如，在類別中快取的會 `ProductsDataTable` `ProductsCL` 包含每項產品的類別目錄和供應商名稱，但是此 `AddCacheItem` 方法只會使用的相依性 `Products` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-312">For example, the `ProductsDataTable` cached in the `ProductsCL` class contains the category and supplier names for each product, but the `AddCacheItem` method only uses a dependency on `Products`.</span></span> <span data-ttu-id="9c8c4-313">在此情況下，如果使用者更新了類別或供應商的名稱，快取的產品資料將會保留在快取中，而且會過期。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-313">In this situation, if the user updates the name of a category or supplier, the cached product data will remain in the cache and be out of date.</span></span> <span data-ttu-id="9c8c4-314">因此，我們想要讓快取的產品資料不只相依于 `Products` 資料表，也是 `Categories` 和 `Suppliers` 資料表。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-314">Therefore, we want to make the cached product data dependent on not only the `Products` table, but on the `Categories` and `Suppliers` tables as well.</span></span>

<span data-ttu-id="9c8c4-315">[ `AggregateCacheDependency` 類別](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx)提供一種方法，讓多個相依性與快取專案產生關聯。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-315">The [`AggregateCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) provides a means for associating multiple dependencies with a cache item.</span></span> <span data-ttu-id="9c8c4-316">首先，建立 `AggregateCacheDependency` 實例。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-316">Start by creating an `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="9c8c4-317">接下來，使用 s 方法新增相依性 `AggregateCacheDependency` 集合 `Add` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-317">Next, add the set of dependencies using the `AggregateCacheDependency` s `Add` method.</span></span> <span data-ttu-id="9c8c4-318">之後將專案插入資料快取時，就會傳入 `AggregateCacheDependency` 實例。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-318">When inserting the item into the data cache thereafter, pass in the `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="9c8c4-319">當 *任何* 實例的相依性 `AggregateCacheDependency` 變更時，就會收回快取的專案。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-319">When *any* of the `AggregateCacheDependency` instance s dependencies change, the cached item will be evicted.</span></span>

<span data-ttu-id="9c8c4-320">以下顯示類別 s 方法的更新程式碼 `ProductsCL` `AddCacheItem` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-320">The following shows the updated code for the `ProductsCL` class s `AddCacheItem` method.</span></span> <span data-ttu-id="9c8c4-321">方法會建立快取相依性 `MasterCacheKeyArray` `SqlCacheDependency` ，以及 `Products` 、 `Categories` 和資料表的物件 `Suppliers` 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-321">The method creates the `MasterCacheKeyArray` cache dependency along with `SqlCacheDependency` objects for the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="9c8c4-322">這些全都合併成一個 `AggregateCacheDependency` 名為的物件 `aggregateDependencies` ，接著會傳遞至 `Insert` 方法。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-322">These are all combined into one `AggregateCacheDependency` object named `aggregateDependencies`, which is then passed into the `Insert` method.</span></span>

[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample15.cs)]

<span data-ttu-id="9c8c4-323">測試這個新的程式碼。現在 `Products` ，、或資料表的變更會導致快取 `Categories` `Suppliers` 的資料被收回。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-323">Test this new code out. Now changes to the `Products`, `Categories`, or `Suppliers` tables cause the cached data to be evicted.</span></span> <span data-ttu-id="9c8c4-324">此外，在 `ProductsCL` `UpdateProduct` 透過 GridView 編輯產品時所呼叫的類別 s 方法會收回快取相依性 `MasterCacheKeyArray` ，這會導致快取的 `ProductsDataTable` 被收回，並在下一個要求時重新抓取資料。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-324">Moreover, the `ProductsCL` class s `UpdateProduct` method, which is called when editing a product through the GridView, evicts the `MasterCacheKeyArray` cache dependency, which causes the cached `ProductsDataTable` to be evicted and the data to be re-retrieved on the next request.</span></span>

> [!NOTE]
> <span data-ttu-id="9c8c4-325">SQL 快取相依性也可以與 [輸出](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx)快取搭配使用。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-325">SQL cache dependencies can also be used with [output caching](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx).</span></span> <span data-ttu-id="9c8c4-326">如需這項功能的示範，請參閱：搭配 [SQL Server 使用 ASP.NET 輸出](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx)快取。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-326">For a demonstration of this functionality, see: [Using ASP.NET Output Caching with SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).</span></span>

## <a name="summary"></a><span data-ttu-id="9c8c4-327">摘要</span><span class="sxs-lookup"><span data-stu-id="9c8c4-327">Summary</span></span>

<span data-ttu-id="9c8c4-328">快取資料庫資料時，資料在理想情況下會保留在快取中，直到在資料庫中進行修改為止。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-328">When caching database data, the data will ideally remain in the cache until it is modified in the database.</span></span> <span data-ttu-id="9c8c4-329">使用 ASP.NET 2.0，可以在宣告式和程式設計的案例中建立和使用 SQL 快取相依性。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-329">With ASP.NET 2.0, SQL cache dependencies can be created and used in both declarative and programmatic scenarios.</span></span> <span data-ttu-id="9c8c4-330">這種方法的挑戰之一，就是探索資料何時經過修改。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-330">One of the challenges with this approach is in discovering when the data has been modified.</span></span> <span data-ttu-id="9c8c4-331">完整版的 Microsoft SQL Server 2005 提供通知功能，可在查詢結果變更時警示應用程式。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-331">The full versions of Microsoft SQL Server 2005 provide notification capabilities that can alert an application when a query result has changed.</span></span> <span data-ttu-id="9c8c4-332">若為 SQL Server 2005 與舊版 SQL Server 的 Express Edition，則必須改用輪詢系統。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-332">For the Express Edition of SQL Server 2005 and older versions of SQL Server, a polling system must be used instead.</span></span> <span data-ttu-id="9c8c4-333">幸運的是，設定必要的輪詢基礎結構相當簡單。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-333">Fortunately, setting up the necessary polling infrastructure is fairly straightforward.</span></span>

<span data-ttu-id="9c8c4-334">快樂程式設計！</span><span class="sxs-lookup"><span data-stu-id="9c8c4-334">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="9c8c4-335">深入閱讀</span><span class="sxs-lookup"><span data-stu-id="9c8c4-335">Further Reading</span></span>

<span data-ttu-id="9c8c4-336">如需本教學課程中所討論之主題的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="9c8c4-336">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="9c8c4-337">在 Microsoft SQL Server 2005 中使用查詢通知</span><span class="sxs-lookup"><span data-stu-id="9c8c4-337">Using Query Notifications in Microsoft SQL Server 2005</span></span>](https://msdn.microsoft.com/library/ms175110.aspx)
- [<span data-ttu-id="9c8c4-338">建立查詢通知</span><span class="sxs-lookup"><span data-stu-id="9c8c4-338">Creating a Query Notification</span></span>](https://msdn.microsoft.com/library/ms188669.aspx)
- <span data-ttu-id="9c8c4-339">[使用類別在 ASP.NET 中快取 `SqlCacheDependency`](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-339">[Caching in ASP.NET with the `SqlCacheDependency` Class](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span></span>
- <span data-ttu-id="9c8c4-340">[ASP.NET SQL Server 註冊工具 (`aspnet_regsql.exe`) ](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-340">[ASP.NET SQL Server Registration Tool (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span></span>
- [<span data-ttu-id="9c8c4-341">總覽 `SqlCacheDependency`</span><span class="sxs-lookup"><span data-stu-id="9c8c4-341">Overview of `SqlCacheDependency`</span></span>](http://www.aspnetresources.com/blog/sql_cache_depedency_overview.aspx)

## <a name="about-the-author"></a><span data-ttu-id="9c8c4-342">關於作者</span><span class="sxs-lookup"><span data-stu-id="9c8c4-342">About the Author</span></span>

<span data-ttu-id="9c8c4-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，作者是七個 ASP/ASP. NET 書籍和創辦人 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)，自1998起一直都在使用 Microsoft Web 技術。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="9c8c4-344">Scott 以獨立顧問、訓練員和作者的形式運作。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-344">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="9c8c4-345">他的最新書籍是 [*在24小時內 ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-345">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="9c8c4-346">您可以在此聯繫[ mitchell@4GuysFromRolla.com 。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-346">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="9c8c4-347">或者透過他的 blog （可在中找到） [http://ScottOnWriting.NET](http://ScottOnWriting.NET) 。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-347">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="9c8c4-348">特別感謝</span><span class="sxs-lookup"><span data-stu-id="9c8c4-348">Special Thanks To</span></span>

<span data-ttu-id="9c8c4-349">本教學課程系列是由許多有用的審核者所審核。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-349">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="9c8c4-350">本教學課程的潛在客戶審核者是 Marko Rangel、Teresa Murphy 和 Hilton Giesenow。</span><span class="sxs-lookup"><span data-stu-id="9c8c4-350">Lead reviewers for this tutorial were Marko Rangel, Teresa Murphy, and Hilton Giesenow.</span></span> <span data-ttu-id="9c8c4-351">有興趣複習我即將推出的 MSDN 文章嗎？</span><span class="sxs-lookup"><span data-stu-id="9c8c4-351">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="9c8c4-352">如果是的話，請在這裡放置一行[ mitchell@4GuysFromRolla.com 。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-352">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="9c8c4-353">[上一個](caching-data-at-application-startup-cs.md) 
> [下一步](caching-data-with-the-objectdatasource-vb.md)</span><span class="sxs-lookup"><span data-stu-id="9c8c4-353">[Previous](caching-data-at-application-startup-cs.md)
[Next](caching-data-with-the-objectdatasource-vb.md)</span></span>
