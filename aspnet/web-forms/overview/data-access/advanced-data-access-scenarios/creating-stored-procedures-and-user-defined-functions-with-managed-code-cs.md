---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/creating-stored-procedures-and-user-defined-functions-with-managed-code-cs
title: '使用 Managed 程式碼建立預存程式和使用者定義函數 (c # ) |Microsoft Docs'
author: rick-anderson
description: Microsoft SQL Server 2005 與 .NET Common Language Runtime 整合，可讓開發人員透過 managed 程式碼建立資料庫物件。 本教學課程 .。。
ms.author: riande
ms.date: 08/03/2007
ms.assetid: 213eea41-1ab4-4371-8b24-1a1a66c515de
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/creating-stored-procedures-and-user-defined-functions-with-managed-code-cs
msc.type: authoredcontent
ms.openlocfilehash: c1882d019d9dfde2dc4f960cae65aa8268c97a51
ms.sourcegitcommit: 4e6d586faadbe4d9ef27122f86335ec9385134af
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/28/2020
ms.locfileid: "89045295"
---
# <a name="creating-stored-procedures-and-user-defined-functions-with-managed-code-c"></a><span data-ttu-id="2f04f-104">使用受控碼建立預存程序和使用者定義函式 (C#)</span><span class="sxs-lookup"><span data-stu-id="2f04f-104">Creating Stored Procedures and User-Defined Functions with Managed Code (C#)</span></span>

<span data-ttu-id="2f04f-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="2f04f-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="2f04f-106">[下載程式代碼](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_75_CS.zip) 或 [下載 PDF](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/datatutorial75cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="2f04f-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_75_CS.zip) or [Download PDF](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/datatutorial75cs1.pdf)</span></span>

> <span data-ttu-id="2f04f-107">Microsoft SQL Server 2005 與 .NET Common Language Runtime 整合，可讓開發人員透過 managed 程式碼建立資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-107">Microsoft SQL Server 2005 integrates with the .NET Common Language Runtime to allow developers to create database objects through managed code.</span></span> <span data-ttu-id="2f04f-108">本教學課程示範如何使用您的 Visual Basic 或 c # 程式碼，建立 managed 預存程式和受控使用者定義函數。</span><span class="sxs-lookup"><span data-stu-id="2f04f-108">This tutorial shows how to create managed stored procedures and managed user-defined functions with your Visual Basic or C# code.</span></span> <span data-ttu-id="2f04f-109">我們也會看到這些版本的 Visual Studio 如何讓您對這類 managed 資料庫物件進行 debug。</span><span class="sxs-lookup"><span data-stu-id="2f04f-109">We also see how these editions of Visual Studio allow you to debug such managed database objects.</span></span>

## <a name="introduction"></a><span data-ttu-id="2f04f-110">簡介</span><span class="sxs-lookup"><span data-stu-id="2f04f-110">Introduction</span></span>

<span data-ttu-id="2f04f-111">像是 Microsoft s SQL Server 2005 的資料庫會使用 [ (結構化查詢語言 (SQL) transact-sql) ](http://en.wikipedia.org/wiki/Transact-SQL) 來插入、修改及取出資料。</span><span class="sxs-lookup"><span data-stu-id="2f04f-111">Databases like Microsoft s SQL Server 2005 use the [Transact-Structured Query Language (T-SQL)](http://en.wikipedia.org/wiki/Transact-SQL) for inserting, modifying, and retrieving data.</span></span> <span data-ttu-id="2f04f-112">大部分的資料庫系統都包含用來分組一連串 SQL 語句的結構，這些語句接著可以用單一、可重複使用的單位來執行。</span><span class="sxs-lookup"><span data-stu-id="2f04f-112">Most database systems include constructs for grouping a series of SQL statements that can then be executed as a single, reusable unit.</span></span> <span data-ttu-id="2f04f-113">預存程式就是其中一個範例。</span><span class="sxs-lookup"><span data-stu-id="2f04f-113">Stored procedures are one example.</span></span> <span data-ttu-id="2f04f-114">另一種是 *使用者定義* 的函式 (udf) ，這是我們將在步驟9中更詳細地檢查的結構。</span><span class="sxs-lookup"><span data-stu-id="2f04f-114">Another is *User-Defined Functions*(UDFs), a construct that we will examine in greater detail in Step 9.</span></span>

<span data-ttu-id="2f04f-115">SQL 的核心是設計用來處理資料集。</span><span class="sxs-lookup"><span data-stu-id="2f04f-115">At its core, SQL is designed for working with sets of data.</span></span> <span data-ttu-id="2f04f-116">`SELECT`、 `UPDATE` 和 `DELETE` 語句本身就會套用至對應資料表中的所有記錄，而且只會受到其 `WHERE` 子句的限制。</span><span class="sxs-lookup"><span data-stu-id="2f04f-116">The `SELECT`, `UPDATE`, and `DELETE` statements inherently apply to all records in the corresponding table and are only limited by their `WHERE` clauses.</span></span> <span data-ttu-id="2f04f-117">但有許多語言功能是設計來一次處理一筆記錄，以及處理純量資料。</span><span class="sxs-lookup"><span data-stu-id="2f04f-117">Yet there are many language features designed for working with one record at a time and for manipulating scalar data.</span></span> <span data-ttu-id="2f04f-118">[ `CURSOR` 允許一](http://www.sqlteam.com/item.asp?ItemID=553)組記錄一次迴圈一個記錄。</span><span class="sxs-lookup"><span data-stu-id="2f04f-118">[`CURSOR` s](http://www.sqlteam.com/item.asp?ItemID=553) allow for a set of records to be looped through one at a time.</span></span> <span data-ttu-id="2f04f-119">字串操作函式（例如、和）使用純量 `LEFT` `CHARINDEX` `PATINDEX` 資料。</span><span class="sxs-lookup"><span data-stu-id="2f04f-119">String manipulation functions like `LEFT`, `CHARINDEX`, and `PATINDEX` work with scalar data.</span></span> <span data-ttu-id="2f04f-120">SQL 也包含和之類的控制流程語句 `IF` `WHILE` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-120">SQL also includes control flow statements like `IF` and `WHILE`.</span></span>

<span data-ttu-id="2f04f-121">在 Microsoft SQL Server 2005 之前，預存程式和 Udf 只能定義為 T-sql 語句的集合。</span><span class="sxs-lookup"><span data-stu-id="2f04f-121">Prior to Microsoft SQL Server 2005, stored procedures and UDFs could only be defined as a collection of T-SQL statements.</span></span> <span data-ttu-id="2f04f-122">不過，SQL Server 2005 的設計目的是要提供與 [Common Language Runtime (CLR) ](https://msdn.microsoft.com/netframework/aa497266.aspx)（所有 .net 元件所使用的執行時間）的整合。</span><span class="sxs-lookup"><span data-stu-id="2f04f-122">SQL Server 2005, however, was designed to provide integration with the [Common Language Runtime (CLR)](https://msdn.microsoft.com/netframework/aa497266.aspx), which is the runtime used by all .NET assemblies.</span></span> <span data-ttu-id="2f04f-123">因此，可以使用 managed 程式碼來建立 SQL Server 2005 資料庫中的預存程式和 Udf。</span><span class="sxs-lookup"><span data-stu-id="2f04f-123">Consequently, the stored procedures and UDFs in a SQL Server 2005 database can be created using managed code.</span></span> <span data-ttu-id="2f04f-124">也就是說，您可以建立預存程式或 UDF 作為 c # 類別中的方法。</span><span class="sxs-lookup"><span data-stu-id="2f04f-124">That is, you can create a stored procedure or UDF as a method in a C# class.</span></span> <span data-ttu-id="2f04f-125">這可讓這些預存程式和 Udf 利用 .NET Framework 中的功能，以及從您自己的自訂類別。</span><span class="sxs-lookup"><span data-stu-id="2f04f-125">This enables these stored procedures and UDFs to utilize functionality in the .NET Framework and from your own custom classes.</span></span>

<span data-ttu-id="2f04f-126">在本教學課程中，我們將探討如何建立 managed 預存程式和使用者定義的函式，以及如何將其整合到 Northwind 資料庫中。</span><span class="sxs-lookup"><span data-stu-id="2f04f-126">In this tutorial we will examine how to create managed stored procedures and User-Defined Functions and how to integrate them into our Northwind database.</span></span> <span data-ttu-id="2f04f-127">現在就開始吧！</span><span class="sxs-lookup"><span data-stu-id="2f04f-127">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="2f04f-128">受管理的資料庫物件在 SQL 對應專案方面提供一些優點。</span><span class="sxs-lookup"><span data-stu-id="2f04f-128">Managed database objects offer some advantages over their SQL counterparts.</span></span> <span data-ttu-id="2f04f-129">語言豐富且熟悉，以及重複使用現有程式碼和邏輯的能力，是主要優點。</span><span class="sxs-lookup"><span data-stu-id="2f04f-129">Language richness and familiarity and the ability to reuse existing code and logic are the main advantages.</span></span> <span data-ttu-id="2f04f-130">但是，當您使用的資料集不牽涉到許多程式邏輯時，管理資料庫物件的效率可能較低。</span><span class="sxs-lookup"><span data-stu-id="2f04f-130">But managed database objects are likely to be less efficient when working with sets of data that do not involve much procedural logic.</span></span> <span data-ttu-id="2f04f-131">如需更全面討論使用 managed 程式碼與 T-sql 的優點，請參閱 [使用 managed 程式碼來建立資料庫物件的優點](https://msdn.microsoft.com/library/k2e1fb36(VS.80).aspx)。</span><span class="sxs-lookup"><span data-stu-id="2f04f-131">For a more thorough discussion on the advantages of using managed code versus T-SQL, check out the [Advantages of Using Managed Code to Create Database Objects](https://msdn.microsoft.com/library/k2e1fb36(VS.80).aspx).</span></span>

## <a name="step-1-moving-the-northwind-database-out-ofapp_data"></a><span data-ttu-id="2f04f-132">步驟1：將 Northwind 資料庫移出`App_Data`</span><span class="sxs-lookup"><span data-stu-id="2f04f-132">Step 1: Moving the Northwind Database Out of`App_Data`</span></span>

<span data-ttu-id="2f04f-133">至此，我們到目前為止的所有教學課程都已在 web 應用程式的資料夾中使用 Microsoft SQL Server 2005 Express Edition 資料庫檔案 `App_Data` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-133">All of our tutorials thus far have used a Microsoft SQL Server 2005 Express Edition database file in the web application s `App_Data` folder.</span></span> <span data-ttu-id="2f04f-134">將資料庫放入 `App_Data` 簡化的散發和執行這些教學課程，因為所有檔案都位於一個目錄中，而且不需要額外的設定步驟來測試教學課程。</span><span class="sxs-lookup"><span data-stu-id="2f04f-134">Placing the database in `App_Data` simplified distributing and running these tutorials as all of the files were located within one directory and required no additional configuration steps to test the tutorial.</span></span>

<span data-ttu-id="2f04f-135">不過，在本教學課程中，我們會將 Northwind 資料庫移出 `App_Data` ，並明確地向 SQL Server 2005 Express Edition 資料庫實例註冊。</span><span class="sxs-lookup"><span data-stu-id="2f04f-135">For this tutorial, however, let s move the Northwind database out of `App_Data` and explicitly register it with the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="2f04f-136">雖然我們可以使用資料夾中的資料庫來執行此教學課程的步驟，但有 `App_Data` 幾個步驟會藉由明確地向 SQL Server 2005 Express Edition 資料庫實例註冊資料庫，使得更簡單的步驟。</span><span class="sxs-lookup"><span data-stu-id="2f04f-136">While we can perform the steps for this tutorial with the database in the `App_Data` folder, a number of the steps are made much simpler by explicitly registering the database with the SQL Server 2005 Express Edition database instance.</span></span>

<span data-ttu-id="2f04f-137">本教學課程的下載會有兩個資料庫檔案 `NORTHWND.MDF` ，並 `NORTHWND_log.LDF` 放在名為的資料夾中 `DataFiles` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-137">The download for this tutorial has the two database files - `NORTHWND.MDF` and `NORTHWND_log.LDF` - placed in a folder named `DataFiles`.</span></span> <span data-ttu-id="2f04f-138">如果您遵循自己的教學課程執行，請關閉 Visual Studio，並將 `NORTHWND.MDF` 和檔案 `NORTHWND_log.LDF` 從網站 s `App_Data` 資料夾移至網站以外的資料夾。</span><span class="sxs-lookup"><span data-stu-id="2f04f-138">If you are following along with your own implementation of the tutorials, close Visual Studio and move the `NORTHWND.MDF` and `NORTHWND_log.LDF` files from the website s `App_Data` folder to a folder outside of the website.</span></span> <span data-ttu-id="2f04f-139">一旦將資料庫檔案移至另一個資料夾，就必須向 SQL Server 2005 Express Edition 資料庫實例註冊 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="2f04f-139">Once the database files have been moved to another folder we need to register the Northwind database with the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="2f04f-140">這可以從 SQL Server Management Studio 完成。</span><span class="sxs-lookup"><span data-stu-id="2f04f-140">This can be done from SQL Server Management Studio.</span></span> <span data-ttu-id="2f04f-141">如果您的電腦上已安裝非 Express Edition 的 SQL Server 2005，則可能已安裝 Management Studio。</span><span class="sxs-lookup"><span data-stu-id="2f04f-141">If you have a non-Express Edition of SQL Server 2005 installed on your computer then you likely already have Management Studio installed.</span></span> <span data-ttu-id="2f04f-142">如果您的電腦上只有 SQL Server 2005 Express Edition，請花一點時間下載並安裝 [Microsoft SQL Server Management Studio Express](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796)。</span><span class="sxs-lookup"><span data-stu-id="2f04f-142">If you only have SQL Server 2005 Express Edition on your computer then take a moment to download and install [Microsoft SQL Server Management Studio Express](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="2f04f-143">啟動 SQL Server Management Studio。</span><span class="sxs-lookup"><span data-stu-id="2f04f-143">Launch SQL Server Management Studio.</span></span> <span data-ttu-id="2f04f-144">如 [圖 1] 所示，Management Studio 開始詢問要連接的伺服器。</span><span class="sxs-lookup"><span data-stu-id="2f04f-144">As Figure 1 shows, Management Studio starts by asking what server to connect to.</span></span> <span data-ttu-id="2f04f-145">在 [伺服器名稱] 中輸入 localhost\SQLExpress，在 [驗證] 下拉式清單中選擇 [Windows 驗證]，然後按一下 [連線]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-145">Enter localhost\SQLExpress for the server name, choose Windows Authentication in the Authentication drop-down list, and click Connect.</span></span>

![連接到適當的資料庫實例](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image1.png)

<span data-ttu-id="2f04f-147">**圖 1**：連接到適當的資料庫實例</span><span class="sxs-lookup"><span data-stu-id="2f04f-147">**Figure 1**: Connect to the Appropriate Database Instance</span></span>

<span data-ttu-id="2f04f-148">連接之後，物件總管視窗將會列出 SQL Server 2005 Express Edition 資料庫實例的相關資訊，包括其資料庫、安全性資訊、管理選項等等。</span><span class="sxs-lookup"><span data-stu-id="2f04f-148">Once you ve connected, the Object Explorer window will list information about the SQL Server 2005 Express Edition database instance, including its databases, security information, management options, and so forth.</span></span>

<span data-ttu-id="2f04f-149">我們需要將 Northwind 資料庫附加 `DataFiles` (或您可能已將其移) 至 SQL Server 2005 Express Edition 資料庫實例的任何位置。</span><span class="sxs-lookup"><span data-stu-id="2f04f-149">We need to attach the Northwind database in the `DataFiles` folder (or wherever you may have moved it) to the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="2f04f-150">以滑鼠右鍵按一下 [資料庫] 資料夾，然後從內容功能表中選擇 [附加] 選項。</span><span class="sxs-lookup"><span data-stu-id="2f04f-150">Right-click on the Databases folder and choose the Attach option from the context menu.</span></span> <span data-ttu-id="2f04f-151">這會顯示 [附加資料庫] 對話方塊。</span><span class="sxs-lookup"><span data-stu-id="2f04f-151">This will bring up the Attach Databases dialog box.</span></span> <span data-ttu-id="2f04f-152">按一下 [加入] 按鈕，向下切入至適當的檔案 `NORTHWND.MDF` ，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-152">Click the Add button, drill down to the appropriate `NORTHWND.MDF` file, and click OK.</span></span> <span data-ttu-id="2f04f-153">此時您的畫面看起來應該類似 [圖 2]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-153">At this point your screen should look similar to Figure 2.</span></span>

<span data-ttu-id="2f04f-154">[![連接到適當的資料庫實例](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image3.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image2.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-154">[![Connect to the Appropriate Database Instance](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image3.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image2.png)</span></span>

<span data-ttu-id="2f04f-155">**圖 2**：連接到適當的資料庫實例 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image4.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-155">**Figure 2**: Connect to the Appropriate Database Instance ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image4.png))</span></span>

> [!NOTE]
> <span data-ttu-id="2f04f-156">透過 Management Studio 連接到 SQL Server 2005 Express Edition 實例時，[附加資料庫] 對話方塊不會讓您向下切入到使用者設定檔目錄，例如我的檔。</span><span class="sxs-lookup"><span data-stu-id="2f04f-156">When connecting to the SQL Server 2005 Express Edition instance through Management Studio the Attach Databases dialog box does not allow you to drill down into user profile directories, such as My Documents.</span></span> <span data-ttu-id="2f04f-157">因此，請務必將 `NORTHWND.MDF` 和檔案放 `NORTHWND_log.LDF` 在非使用者設定檔目錄中。</span><span class="sxs-lookup"><span data-stu-id="2f04f-157">Therefore, make sure to place the `NORTHWND.MDF` and `NORTHWND_log.LDF` files in a non-user profile directory.</span></span>

<span data-ttu-id="2f04f-158">按一下 [確定] 按鈕以附加資料庫。</span><span class="sxs-lookup"><span data-stu-id="2f04f-158">Click the OK button to attach the database.</span></span> <span data-ttu-id="2f04f-159">[附加資料庫] 對話方塊會關閉，而物件總管現在應該會列出剛剛附加的資料庫。</span><span class="sxs-lookup"><span data-stu-id="2f04f-159">The Attach Databases dialog box will close and the Object Explorer should now list the just-attached database.</span></span> <span data-ttu-id="2f04f-160">Northwind 資料庫很可能會有類似的名稱 `9FE54661B32FDD967F51D71D0D5145CC_LINE ARTICLES\DATATUTORIALS\VOLUME 3\CSHARP\73\ASPNET_DATA_TUTORIAL_75_CS\APP_DATA\NORTHWND.MDF` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-160">Chances are the Northwind database has a name like `9FE54661B32FDD967F51D71D0D5145CC_LINE ARTICLES\DATATUTORIALS\VOLUME 3\CSHARP\73\ASPNET_DATA_TUTORIAL_75_CS\APP_DATA\NORTHWND.MDF`.</span></span> <span data-ttu-id="2f04f-161">以滑鼠右鍵按一下資料庫，然後選擇 [重新命名]，將資料庫重新命名為 Northwind。</span><span class="sxs-lookup"><span data-stu-id="2f04f-161">Rename the database to Northwind by right-clicking on the database and choosing Rename.</span></span>

![將資料庫重新命名為 Northwind](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image5.png)

<span data-ttu-id="2f04f-163">**圖 3**：將資料庫重新命名為 Northwind</span><span class="sxs-lookup"><span data-stu-id="2f04f-163">**Figure 3**: Rename the Database to Northwind</span></span>

## <a name="step-2-creating-a-new-solution-and-sql-server-project-in-visual-studio"></a><span data-ttu-id="2f04f-164">步驟2：在 Visual Studio 中建立新的方案和 SQL Server 專案</span><span class="sxs-lookup"><span data-stu-id="2f04f-164">Step 2: Creating a New Solution and SQL Server Project in Visual Studio</span></span>

<span data-ttu-id="2f04f-165">為了在 SQL Server 2005 中建立 managed 預存程式或 Udf，我們會將預存程式和 UDF 邏輯撰寫為類別中的 c # 程式碼。</span><span class="sxs-lookup"><span data-stu-id="2f04f-165">To create managed stored procedures or UDFs in SQL Server 2005 we will write the stored procedure and UDF logic as C# code in a class.</span></span> <span data-ttu-id="2f04f-166">撰寫程式碼之後，我們必須將此類別編譯成 (檔案的元件 `.dll`) 、向 SQL Server 資料庫註冊元件，然後在資料庫中建立指向元件中對應方法的預存程式或 UDF 物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-166">Once the code has been written, we will need to compile this class into an assembly (a `.dll` file), register the assembly with the SQL Server database, and then create a stored procedure or UDF object in the database that points to the corresponding method in the assembly.</span></span> <span data-ttu-id="2f04f-167">您可以手動執行這些步驟。</span><span class="sxs-lookup"><span data-stu-id="2f04f-167">These steps can all be performed manually.</span></span> <span data-ttu-id="2f04f-168">我們可以在任何文字編輯器中建立程式碼、使用 c # 編譯器 () 從命令列進行編譯、 [`csc.exe`](https://msdn.microsoft.com/library/ms379563(vs.80).aspx) 使用 [`CREATE ASSEMBLY`](https://msdn.microsoft.com/library/ms189524.aspx) 命令或從 Management Studio 向資料庫註冊，以及透過類似的方式新增預存程式或 UDF 物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-168">We can create the code in any text editor, compile it from the command line using the C# compiler ([`csc.exe`](https://msdn.microsoft.com/library/ms379563(vs.80).aspx)), register it with the database using the [`CREATE ASSEMBLY`](https://msdn.microsoft.com/library/ms189524.aspx) command or from Management Studio, and add the stored procedure or UDF object through similar means.</span></span> <span data-ttu-id="2f04f-169">幸好 Visual Studio 的 Professional 和 Team 系統版本包含了可將這些工作自動化的 SQL Server 專案類型。</span><span class="sxs-lookup"><span data-stu-id="2f04f-169">Fortunately, the Professional and Team Systems versions of Visual Studio include a SQL Server Project type that automates these tasks.</span></span> <span data-ttu-id="2f04f-170">在本教學課程中，我們將逐步解說如何使用 SQL Server 專案類型來建立 managed 預存程式和 UDF。</span><span class="sxs-lookup"><span data-stu-id="2f04f-170">In this tutorial we will walk through using the SQL Server Project type to create a managed stored procedure and UDF.</span></span>

> [!NOTE]
> <span data-ttu-id="2f04f-171">如果您使用的是 Visual Web Developer 或 Standard edition 的 Visual Studio，就必須改用手動方法。</span><span class="sxs-lookup"><span data-stu-id="2f04f-171">If you are using Visual Web Developer or the Standard edition of Visual Studio, then you will have to use the manual approach instead.</span></span> <span data-ttu-id="2f04f-172">步驟13提供手動執行這些步驟的詳細指示。</span><span class="sxs-lookup"><span data-stu-id="2f04f-172">Step 13 provides detailed instructions for performing these steps manually.</span></span> <span data-ttu-id="2f04f-173">在閱讀步驟13之前，建議您先閱讀步驟2到12，因為這些步驟包括重要 SQL Server 設定指示，無論您使用的是哪一個版本的 Visual Studio 都必須套用這些指示。</span><span class="sxs-lookup"><span data-stu-id="2f04f-173">I encourage you to read Steps 2 through 12 before reading Step 13 since these steps include important SQL Server configuration instructions that must be applied regardless of what version of Visual Studio you are using.</span></span>

<span data-ttu-id="2f04f-174">從開啟 Visual Studio 開始。</span><span class="sxs-lookup"><span data-stu-id="2f04f-174">Start by opening Visual Studio.</span></span> <span data-ttu-id="2f04f-175">在 [檔案] 功能表中，選擇 [新增專案] 以顯示 [新增專案] 對話方塊 (參閱 [圖 4]) 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-175">From the File menu, choose New Project to display the New Project dialog box (see Figure 4).</span></span> <span data-ttu-id="2f04f-176">向下切入至資料庫專案類型，然後從右側所列的範本中，選擇建立新的 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="2f04f-176">Drill down to the Database project type and then, from the Templates listed on the right, choose to create a new SQL Server Project.</span></span> <span data-ttu-id="2f04f-177">我選擇將此專案命名為 `ManagedDatabaseConstructs` ，並將其放在名為的方案內 `Tutorial75` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-177">I have chosen to name this project `ManagedDatabaseConstructs` and placed it within a Solution named `Tutorial75`.</span></span>

<span data-ttu-id="2f04f-178">[![建立新的 SQL Server 專案](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image7.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image6.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-178">[![Create a New SQL Server Project](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image7.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image6.png)</span></span>

<span data-ttu-id="2f04f-179">**圖 4**：建立新的 SQL Server 專案 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image8.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-179">**Figure 4**: Create a New SQL Server Project ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image8.png))</span></span>

<span data-ttu-id="2f04f-180">按一下 [新增專案] 對話方塊中的 [確定] 按鈕，以建立方案和 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="2f04f-180">Click the OK button in the New Project dialog box to create the Solution and SQL Server Project.</span></span>

<span data-ttu-id="2f04f-181">SQL Server 專案系結至特定的資料庫。</span><span class="sxs-lookup"><span data-stu-id="2f04f-181">A SQL Server Project is tied to a particular database.</span></span> <span data-ttu-id="2f04f-182">因此，在建立新的 SQL Server 專案之後，系統會立即要求您指定此資訊。</span><span class="sxs-lookup"><span data-stu-id="2f04f-182">Consequently, after creating the new SQL Server Project we are immediately asked to specify this information.</span></span> <span data-ttu-id="2f04f-183">[圖 5] 顯示新的 [資料庫參考] 對話方塊，該對話方塊已填妥以指向我們在步驟1中的 SQL Server 2005 Express Edition 資料庫實例中註冊的 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="2f04f-183">Figure 5 shows the New Database Reference dialog box that has been filled out to point to the Northwind database we registered in the SQL Server 2005 Express Edition database instance back in Step 1.</span></span>

![建立 SQL Server 專案與 Northwind 資料庫的關聯](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image9.png)

<span data-ttu-id="2f04f-185">**圖 5**：建立 SQL Server 專案與 Northwind 資料庫的關聯</span><span class="sxs-lookup"><span data-stu-id="2f04f-185">**Figure 5**: Associate the SQL Server Project with the Northwind Database</span></span>

<span data-ttu-id="2f04f-186">為了將我們將在此專案中建立的 managed 預存程式和 Udf 進行 debug 錯，我們必須啟用連接的 SQL/CLR 偵錯工具支援。</span><span class="sxs-lookup"><span data-stu-id="2f04f-186">In order to debug the managed stored procedures and UDFs we will create within this project, we need to enable SQL/CLR debugging support for the connection.</span></span> <span data-ttu-id="2f04f-187">當 SQL Server 專案與新的資料庫建立關聯時， (與我們在 [圖 5] 中所做的) 一樣，Visual Studio 會詢問我們是否要在連接上啟用 SQL/CLR 調試，請參閱 [圖 6] (。</span><span class="sxs-lookup"><span data-stu-id="2f04f-187">Whenever associating a SQL Server Project with a new database (as we did in Figure 5), Visual Studio asks us if we want to enable SQL/CLR debugging on the connection (see Figure 6).</span></span> <span data-ttu-id="2f04f-188">按一下 [是]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-188">Click Yes.</span></span>

![啟用 SQL/CLR 調試](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image10.png)

<span data-ttu-id="2f04f-190">**圖 6**：啟用 SQL/CLR 調試</span><span class="sxs-lookup"><span data-stu-id="2f04f-190">**Figure 6**: Enable SQL/CLR Debugging</span></span>

<span data-ttu-id="2f04f-191">此時，新的 SQL Server 專案已加入至方案中。</span><span class="sxs-lookup"><span data-stu-id="2f04f-191">At this point the new SQL Server Project has been added to the Solution.</span></span> <span data-ttu-id="2f04f-192">它包含名為的資料夾，其中包含名為的檔案 `Test Scripts` `Test.sql` ，可用來偵測在專案中建立的 managed 資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-192">It contains a folder named `Test Scripts` with a file named `Test.sql`, which is used for debugging the managed database objects created in the project.</span></span> <span data-ttu-id="2f04f-193">我們將在步驟12中探討如何進行調試。</span><span class="sxs-lookup"><span data-stu-id="2f04f-193">We will look at debugging in Step 12.</span></span>

<span data-ttu-id="2f04f-194">我們現在可以在這個專案中加入新的 managed 預存程式和 Udf，但是在我們開始之前，先將現有的 web 應用程式包含在解決方案中。</span><span class="sxs-lookup"><span data-stu-id="2f04f-194">We can now add new managed stored procedures and UDFs to this project, but before we do let s first include our existing web application in the Solution.</span></span> <span data-ttu-id="2f04f-195">從 [檔案] 功能表選取 [加入] 選項，然後選擇 [現有的網站]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-195">From the File menu select the Add option and choose Existing Web Site.</span></span> <span data-ttu-id="2f04f-196">流覽至適當的網站資料夾，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-196">Browse to the appropriate website folder and click OK.</span></span> <span data-ttu-id="2f04f-197">如圖7所示，這會更新方案，以包含兩個專案：網站和 `ManagedDatabaseConstructs` SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="2f04f-197">As Figure 7 shows, this will update the Solution to include two projects: the website and the `ManagedDatabaseConstructs` SQL Server Project.</span></span>

![方案總管現在包含兩個專案](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image11.png)

<span data-ttu-id="2f04f-199">**圖 7**：方案總管現在包含兩個專案</span><span class="sxs-lookup"><span data-stu-id="2f04f-199">**Figure 7**: The Solution Explorer Now Includes Two Projects</span></span>

<span data-ttu-id="2f04f-200">`NORTHWNDConnectionString`中的值 `Web.config` 目前會參考 `NORTHWND.MDF` `App_Data` 資料夾中的檔案。</span><span class="sxs-lookup"><span data-stu-id="2f04f-200">The `NORTHWNDConnectionString` value in `Web.config` currently references the `NORTHWND.MDF` file in the `App_Data` folder.</span></span> <span data-ttu-id="2f04f-201">由於我們已從移除此資料庫， `App_Data` 並在 SQL Server 2005 Express Edition 資料庫實例中明確地將它註冊，因此我們必須先更新 `NORTHWNDConnectionString` 該值。</span><span class="sxs-lookup"><span data-stu-id="2f04f-201">Since we removed this database from `App_Data` and explicitly registered it in the SQL Server 2005 Express Edition database instance, we need to correspondingly update the `NORTHWNDConnectionString` value.</span></span> <span data-ttu-id="2f04f-202">開啟 `Web.config` 網站中的檔案並變更值， `NORTHWNDConnectionString` 使連接字串讀取： `Data Source=localhost\SQLExpress;Initial Catalog=Northwind;Integrated Security=True` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-202">Open the `Web.config` file in the website and change the `NORTHWNDConnectionString` value so that the connection string reads: `Data Source=localhost\SQLExpress;Initial Catalog=Northwind;Integrated Security=True`.</span></span> <span data-ttu-id="2f04f-203">在這項變更之後， `<connectionStrings>` 中的區段 `Web.config` 看起來應該會如下所示：</span><span class="sxs-lookup"><span data-stu-id="2f04f-203">After this change, your `<connectionStrings>` section in `Web.config` should look similar to the following:</span></span>

[!code-xml[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample1.xml)]

> [!NOTE]
> <span data-ttu-id="2f04f-204">如 [先前的教學](debugging-stored-procedures-cs.md)課程中所述，從用戶端應用程式（例如 ASP.NET 網站）進行 SQL Server 物件的偵錯工具時，我們需要停用連接共用。</span><span class="sxs-lookup"><span data-stu-id="2f04f-204">As discussed in the [preceding tutorial](debugging-stored-procedures-cs.md), when debugging a SQL Server object from a client application, such as an ASP.NET website, we need to disable connection pooling.</span></span> <span data-ttu-id="2f04f-205">上方顯示的連接字串會停用連接共用 ( `Pooling=false` ) 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-205">The connection string shown above disables connection pooling ( `Pooling=false` ).</span></span> <span data-ttu-id="2f04f-206">如果您不打算從 ASP.NET 網站調試 managed 預存程式和 Udf，請啟用連接共用。</span><span class="sxs-lookup"><span data-stu-id="2f04f-206">If you do not plan on debugging the managed stored procedures and UDFs from the ASP.NET website, enable connection pooling.</span></span>

## <a name="step-3-creating-a-managed-stored-procedure"></a><span data-ttu-id="2f04f-207">步驟3：建立 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="2f04f-207">Step 3: Creating a Managed Stored Procedure</span></span>

<span data-ttu-id="2f04f-208">若要將 managed 預存程式加入至 Northwind 資料庫，我們必須先在 SQL Server 專案中建立預存程式做為方法。</span><span class="sxs-lookup"><span data-stu-id="2f04f-208">To add a managed stored procedure to the Northwind database we first need to create the stored procedure as a method in the SQL Server Project.</span></span> <span data-ttu-id="2f04f-209">在 [方案總管中，以滑鼠右鍵按一下 `ManagedDatabaseConstructs` 專案名稱，然後選擇 [加入新專案]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-209">From the Solution Explorer, right-click on the `ManagedDatabaseConstructs` project name and choose to add a new item.</span></span> <span data-ttu-id="2f04f-210">這會顯示 [加入新專案] 對話方塊，其中會列出可加入至專案的 managed 資料庫物件類型。</span><span class="sxs-lookup"><span data-stu-id="2f04f-210">This will display the Add New Item dialog box, which lists the types of managed database objects that can be added to the project.</span></span> <span data-ttu-id="2f04f-211">如圖8所示，這包括預存程式和使用者定義函式，還有其他功能。</span><span class="sxs-lookup"><span data-stu-id="2f04f-211">As Figure 8 shows, this includes stored procedures and User-Defined Functions, among others.</span></span>

<span data-ttu-id="2f04f-212">首先，讓我們加入一個預存程式，只傳回已停止的所有產品。</span><span class="sxs-lookup"><span data-stu-id="2f04f-212">Let s start by adding a stored procedure that simply returns all of the products that have been discontinued.</span></span> <span data-ttu-id="2f04f-213">將新的預存程式檔案命名為 `GetDiscontinuedProducts.cs` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-213">Name the new stored procedure file `GetDiscontinuedProducts.cs`.</span></span>

<span data-ttu-id="2f04f-214">[![加入名為 GetDiscontinuedProducts.cs 的新預存程式](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image13.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image12.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-214">[![Add a New Stored Procedure Named GetDiscontinuedProducts.cs](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image13.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image12.png)</span></span>

<span data-ttu-id="2f04f-215">**圖 8**：新增新的預存程式 `GetDiscontinuedProducts.cs` ，名為 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image14.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-215">**Figure 8**: Add a New Stored Procedure Named `GetDiscontinuedProducts.cs` ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image14.png))</span></span>

<span data-ttu-id="2f04f-216">這會建立具有下列內容的新 c # 類別檔案：</span><span class="sxs-lookup"><span data-stu-id="2f04f-216">This will create a new C# class file with the following content:</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample2.cs)]

<span data-ttu-id="2f04f-217">請注意，預存程式會實作為 `static` 名為之類別檔案內的方法 `partial` `StoredProcedures` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-217">Note that the stored procedure is implemented as a `static` method within a `partial` class file named `StoredProcedures`.</span></span> <span data-ttu-id="2f04f-218">此外，此 `GetDiscontinuedProducts` 方法會使用將 `SqlProcedure attribute` 方法標示為預存程式的來裝飾。</span><span class="sxs-lookup"><span data-stu-id="2f04f-218">Moreover, the `GetDiscontinuedProducts` method is decorated with the `SqlProcedure attribute`, which marks the method as a stored procedure.</span></span>

<span data-ttu-id="2f04f-219">下列程式碼會建立 `SqlCommand` 物件，並將其設定 `CommandText` 為 `SELECT` 查詢，該查詢會 `Products` 針對其欄位等於1的產品，從資料表傳回所有資料行 `Discontinued` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-219">The following code creates a `SqlCommand` object and sets its `CommandText` to a `SELECT` query that returns all of the columns from the `Products` table for products whose `Discontinued` field equals 1.</span></span> <span data-ttu-id="2f04f-220">然後，它會執行命令，並將結果傳回用戶端應用程式。</span><span class="sxs-lookup"><span data-stu-id="2f04f-220">It then executes the command and sends the results back to the client application.</span></span> <span data-ttu-id="2f04f-221">將此程式碼加入至 `GetDiscontinuedProducts` 方法。</span><span class="sxs-lookup"><span data-stu-id="2f04f-221">Add this code to the `GetDiscontinuedProducts` method.</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample3.cs)]

<span data-ttu-id="2f04f-222">所有的 managed 資料庫物件都具有物件的存取權，該[ `SqlContext` 物件](https://msdn.microsoft.com/library/ms131108.aspx)代表呼叫者的內容。</span><span class="sxs-lookup"><span data-stu-id="2f04f-222">All managed database objects have access to a [`SqlContext` object](https://msdn.microsoft.com/library/ms131108.aspx) that represents the context of the caller.</span></span> <span data-ttu-id="2f04f-223">`SqlContext`可透過其[ `Pipe` 屬性](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlcontext.pipe.aspx)提供[ `SqlPipe` 物件](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.aspx)的存取權。</span><span class="sxs-lookup"><span data-stu-id="2f04f-223">The `SqlContext` provides access to a [`SqlPipe` object](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.aspx) via its [`Pipe` property](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlcontext.pipe.aspx).</span></span> <span data-ttu-id="2f04f-224">此 `SqlPipe` 物件可用來 ferry SQL Server 資料庫與呼叫應用程式之間的資訊。</span><span class="sxs-lookup"><span data-stu-id="2f04f-224">This `SqlPipe` object is used to ferry information between the SQL Server database and the calling application.</span></span> <span data-ttu-id="2f04f-225">顧名思義， [ `ExecuteAndSend` 方法](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.executeandsend.aspx)會執行傳入的 `SqlCommand` 物件，並將結果傳回用戶端應用程式。</span><span class="sxs-lookup"><span data-stu-id="2f04f-225">As its name implies, the [`ExecuteAndSend` method](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.executeandsend.aspx) executes a passed-in `SqlCommand` object and sends the results back to the client application.</span></span>

> [!NOTE]
> <span data-ttu-id="2f04f-226">受管理的資料庫物件最適合使用程式邏輯的預存程式和 Udf，而不是以集合為基礎的邏輯。</span><span class="sxs-lookup"><span data-stu-id="2f04f-226">Managed database objects are best suited for stored procedures and UDFs that use procedural logic rather than set-based logic.</span></span> <span data-ttu-id="2f04f-227">程式邏輯牽涉到以逐資料列或使用純量資料的方式來處理資料集。</span><span class="sxs-lookup"><span data-stu-id="2f04f-227">Procedural logic involves working with sets of data on a row-by-row basis or working with scalar data.</span></span> <span data-ttu-id="2f04f-228">`GetDiscontinuedProducts`不過，我們剛剛建立的方法不包含程式邏輯。</span><span class="sxs-lookup"><span data-stu-id="2f04f-228">The `GetDiscontinuedProducts` method we just created, however, involves no procedural logic.</span></span> <span data-ttu-id="2f04f-229">因此，最好是以 T-sql 預存程式的形式來執行。</span><span class="sxs-lookup"><span data-stu-id="2f04f-229">Therefore, it would ideally be implemented as a T-SQL stored procedure.</span></span> <span data-ttu-id="2f04f-230">它會實作為 managed 預存程式，以示範建立和部署 managed 預存程式所需的步驟。</span><span class="sxs-lookup"><span data-stu-id="2f04f-230">It is implemented as a managed stored procedure to demonstrate the steps necessary for creating and deploying managed stored procedures.</span></span>

## <a name="step-4-deploying-the-managed-stored-procedure"></a><span data-ttu-id="2f04f-231">步驟4：部署 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="2f04f-231">Step 4: Deploying the Managed Stored Procedure</span></span>

<span data-ttu-id="2f04f-232">完成此程式碼之後，我們就可以將它部署到 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="2f04f-232">With this code complete, we are ready to deploy it to the Northwind database.</span></span> <span data-ttu-id="2f04f-233">部署 SQL Server 專案時，會將程式碼編譯為元件、向資料庫註冊元件，並在資料庫中建立對應的物件，並將它們連結至元件中的適當方法。</span><span class="sxs-lookup"><span data-stu-id="2f04f-233">Deploying a SQL Server Project compiles the code into an assembly, registers the assembly with the database, and creates the corresponding objects in the database, linking them to the appropriate methods in the assembly.</span></span> <span data-ttu-id="2f04f-234">在步驟13中，部署選項所執行的一組確切工作會更精確。</span><span class="sxs-lookup"><span data-stu-id="2f04f-234">The exact set of tasks performed by the Deploy option is more precisely spelled out in Step 13.</span></span> <span data-ttu-id="2f04f-235">`ManagedDatabaseConstructs`在方案總管中，以滑鼠右鍵按一下專案名稱，然後選擇 [部署] 選項。</span><span class="sxs-lookup"><span data-stu-id="2f04f-235">Right-click on the `ManagedDatabaseConstructs` project name in the Solution Explorer and choose the Deploy option.</span></span> <span data-ttu-id="2f04f-236">不過，部署會失敗並出現下列錯誤：「外部」附近的語法不正確。</span><span class="sxs-lookup"><span data-stu-id="2f04f-236">However, deployment fails with the following error: Incorrect syntax near 'EXTERNAL'.</span></span> <span data-ttu-id="2f04f-237">您可能要將目前資料庫的相容性層級設成高一點的值，以啟用這項功能。</span><span class="sxs-lookup"><span data-stu-id="2f04f-237">You may need to set the compatibility level of the current database to a higher value to enable this feature.</span></span> <span data-ttu-id="2f04f-238">請參閱預存程式的說明 `sp_dbcmptlevel` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-238">See help for the stored procedure `sp_dbcmptlevel`.</span></span>

<span data-ttu-id="2f04f-239">當您嘗試向 Northwind 資料庫註冊元件時，就會發生這個錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="2f04f-239">This error message occurs when attempting to register the assembly with the Northwind database.</span></span> <span data-ttu-id="2f04f-240">為了向 SQL Server 2005 資料庫註冊元件，資料庫的相容性層級必須設定為90。</span><span class="sxs-lookup"><span data-stu-id="2f04f-240">In order to register an assembly with a SQL Server 2005 database, the database s compatibility level must be set to 90.</span></span> <span data-ttu-id="2f04f-241">根據預設，新的 SQL Server 2005 資料庫的相容性層級是90。</span><span class="sxs-lookup"><span data-stu-id="2f04f-241">By default, new SQL Server 2005 databases have a compatibility level of 90.</span></span> <span data-ttu-id="2f04f-242">不過，使用 Microsoft SQL Server 2000 建立的資料庫預設相容性層級是80。</span><span class="sxs-lookup"><span data-stu-id="2f04f-242">However, databases created using Microsoft SQL Server 2000 have a default compatibility level of 80.</span></span> <span data-ttu-id="2f04f-243">由於 Northwind 資料庫一開始是 Microsoft SQL Server 2000 資料庫，因此它的相容性層級目前設定為80，因此需要增加至90才能註冊受管理的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-243">Since the Northwind database was initially a Microsoft SQL Server 2000 database, its compatibility level is currently set to 80 and therefore needs to be increased to 90 in order to register managed database objects.</span></span>

<span data-ttu-id="2f04f-244">若要更新資料庫的相容性層級，請在 Management Studio 中開啟新的查詢視窗，然後輸入：</span><span class="sxs-lookup"><span data-stu-id="2f04f-244">To update the database s compatibility level, open a New Query window in Management Studio and enter:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample4.sql)]

<span data-ttu-id="2f04f-245">按一下工具列中的 [執行] 圖示，以執行上述查詢。</span><span class="sxs-lookup"><span data-stu-id="2f04f-245">Click the Execute icon in the Toolbar to run the above query.</span></span>

<span data-ttu-id="2f04f-246">[![更新 Northwind 資料庫的相容性層級](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image16.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-246">[![Update the Northwind Database s Compatibility Level](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image16.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image15.png)</span></span>

<span data-ttu-id="2f04f-247">**圖 9**：更新 Northwind 資料庫的相容性層級 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image17.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-247">**Figure 9**: Update the Northwind Database s Compatibility Level ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image17.png))</span></span>

<span data-ttu-id="2f04f-248">更新相容性層級之後，重新部署 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="2f04f-248">After updating the compatibility level, redeploy the SQL Server Project.</span></span> <span data-ttu-id="2f04f-249">這次部署應該會完成，而不會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="2f04f-249">This time the deployment should complete without error.</span></span>

<span data-ttu-id="2f04f-250">返回 [SQL Server Management Studio]，以滑鼠右鍵按一下物件總管中的 Northwind 資料庫，然後選擇 [重新整理]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-250">Return to SQL Server Management Studio, right-click on the Northwind database in the Object Explorer, and choose Refresh.</span></span> <span data-ttu-id="2f04f-251">接下來，向下切入到 [可程式性] 資料夾，然後展開 [元件] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="2f04f-251">Next, drill down into the Programmability folder and then expand the Assemblies folder.</span></span> <span data-ttu-id="2f04f-252">如圖10所示，Northwind 資料庫現在包含專案所產生的元件 `ManagedDatabaseConstructs` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-252">As Figure 10 shows, the Northwind database now includes the assembly generated by the `ManagedDatabaseConstructs` project.</span></span>

![ManagedDatabaseConstructs 元件現在已向 Northwind 資料庫註冊](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image18.png)

<span data-ttu-id="2f04f-254">**圖 10**： `ManagedDatabaseConstructs` 元件現在已向 Northwind 資料庫註冊</span><span class="sxs-lookup"><span data-stu-id="2f04f-254">**Figure 10**: The `ManagedDatabaseConstructs` Assembly is Now Registered with the Northwind Database</span></span>

<span data-ttu-id="2f04f-255">也請展開 [預存程式] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="2f04f-255">Also expand the Stored Procedures folder.</span></span> <span data-ttu-id="2f04f-256">您會看到一個名為的預存程式 `GetDiscontinuedProducts` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-256">There you will see a stored procedure named `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="2f04f-257">這個預存程式是由部署程式所建立，並指向 `GetDiscontinuedProducts` 元件中的方法 `ManagedDatabaseConstructs` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-257">This stored procedure was created by the deployment process and points to the `GetDiscontinuedProducts` method in the `ManagedDatabaseConstructs` assembly.</span></span> <span data-ttu-id="2f04f-258">`GetDiscontinuedProducts`執行預存程式時，它會接著執行 `GetDiscontinuedProducts` 方法。</span><span class="sxs-lookup"><span data-stu-id="2f04f-258">When the `GetDiscontinuedProducts` stored procedure is executed, it, in turn, executes the `GetDiscontinuedProducts` method.</span></span> <span data-ttu-id="2f04f-259">因為這是 managed 預存程式，所以無法透過 Management Studio 進行編輯 (因此，預存程式名稱旁邊的鎖定圖示) 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-259">Since this is a managed stored procedure it cannot be edited through Management Studio (hence the lock icon next to the stored procedure name).</span></span>

![GetDiscontinuedProducts 預存程式會列在 [預存程式] 資料夾中。](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image19.png)

<span data-ttu-id="2f04f-261">**圖 11**： `GetDiscontinuedProducts` 預存程式列在 [預存程式] 資料夾中</span><span class="sxs-lookup"><span data-stu-id="2f04f-261">**Figure 11**: The `GetDiscontinuedProducts` Stored Procedure is Listed in the Stored Procedures Folder</span></span>

<span data-ttu-id="2f04f-262">在呼叫 managed 預存程式之前，我們必須先克服另外一項障礙：資料庫設定為防止執行 managed 程式碼。</span><span class="sxs-lookup"><span data-stu-id="2f04f-262">There is still one more hurdle we have to overcome before we can call the managed stored procedure: the database is configured to prevent execution of managed code.</span></span> <span data-ttu-id="2f04f-263">開啟新的查詢視窗並執行預存程式，即可確認此情況 `GetDiscontinuedProducts` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-263">Verify this by opening a new query window and executing the `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="2f04f-264">您將會收到下列錯誤訊息：已停用 .NET Framework 中的使用者程式碼執行。</span><span class="sxs-lookup"><span data-stu-id="2f04f-264">You will receive the following error message: Execution of user code in the .NET Framework is disabled.</span></span> <span data-ttu-id="2f04f-265">啟用 [clr 已啟用] 設定選項。</span><span class="sxs-lookup"><span data-stu-id="2f04f-265">Enable 'clr enabled configuration option.</span></span>

<span data-ttu-id="2f04f-266">若要檢查 Northwind 資料庫的設定資訊，請 `exec sp_configure` 在查詢視窗中輸入並執行命令。</span><span class="sxs-lookup"><span data-stu-id="2f04f-266">To examine the Northwind database s configuration information, enter and execute the command `exec sp_configure` in the query window.</span></span> <span data-ttu-id="2f04f-267">這會顯示 [clr 已啟用] 設定目前設定為0。</span><span class="sxs-lookup"><span data-stu-id="2f04f-267">This shows that the clr enabled setting is currently set to 0.</span></span>

<span data-ttu-id="2f04f-268">[![啟用 clr 的設定目前設定為0](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image21.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image20.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-268">[![The clr enabled Setting is Currently Set to 0](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image21.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image20.png)</span></span>

<span data-ttu-id="2f04f-269">**圖 12**：啟用 Clr 的設定目前設定為 0 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image22.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-269">**Figure 12**: The clr enabled Setting is Currently Set to 0 ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image22.png))</span></span>

<span data-ttu-id="2f04f-270">請注意，[圖 12] 中的每個設定都有四個列出的值：最小值和最大值，以及設定和執行的值。</span><span class="sxs-lookup"><span data-stu-id="2f04f-270">Note that each configuration setting in Figure 12 has four values listed with it: the minimum and maximum values and the config and run values.</span></span> <span data-ttu-id="2f04f-271">若要更新 clr 已啟用設定的設定值，請執行下列命令：</span><span class="sxs-lookup"><span data-stu-id="2f04f-271">To update the config value for the clr enabled setting, execute the following command:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample5.sql)]

<span data-ttu-id="2f04f-272">如果您重新執行，就 `exec sp_configure` 會看到上述語句將 clr enabled 設定的設定值更新為1，但回合值仍設為0。</span><span class="sxs-lookup"><span data-stu-id="2f04f-272">If you re-run the `exec sp_configure` you will see that the above statement updated the clr enabled setting s config value to 1, but that the run value is still set to 0.</span></span> <span data-ttu-id="2f04f-273">為了讓此設定變更生效，我們需要執行[ `RECONFIGURE` 命令](https://msdn.microsoft.com/library/ms176069.aspx)，這會將執行值設定為目前的設定值。</span><span class="sxs-lookup"><span data-stu-id="2f04f-273">For this configuration change to take affect we need to execute the [`RECONFIGURE` command](https://msdn.microsoft.com/library/ms176069.aspx), which will set the run value to the current config value.</span></span> <span data-ttu-id="2f04f-274">只要 `RECONFIGURE` 在查詢視窗中輸入，然後按一下工具列中的 [執行] 圖示。</span><span class="sxs-lookup"><span data-stu-id="2f04f-274">Simply enter `RECONFIGURE` in the query window and click the Execute icon in the Toolbar.</span></span> <span data-ttu-id="2f04f-275">如果您現在執行， `exec sp_configure` 您應該會看到已啟用 clr 的設定和執行值的值為1。</span><span class="sxs-lookup"><span data-stu-id="2f04f-275">If you run `exec sp_configure` now you should see a value of 1 for the clr enabled setting s config and run values.</span></span>

<span data-ttu-id="2f04f-276">啟用 clr 的設定完成之後，就可以開始執行 managed `GetDiscontinuedProducts` 預存程式。</span><span class="sxs-lookup"><span data-stu-id="2f04f-276">With the clr enabled configuration complete, we are ready to run the managed `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="2f04f-277">在查詢視窗中，輸入並執行命令 `exec` `GetDiscontinuedProducts` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-277">In the query window enter and execute the command `exec` `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="2f04f-278">叫用預存程式會導致方法中的對應 managed 程式碼 `GetDiscontinuedProducts` 執行。</span><span class="sxs-lookup"><span data-stu-id="2f04f-278">Invoking the stored procedure causes the corresponding managed code in the `GetDiscontinuedProducts` method to execute.</span></span> <span data-ttu-id="2f04f-279">這段程式碼 `SELECT` 會發出查詢來傳回所有已停止的產品，並將此資料傳回給呼叫應用程式，這在此實例中 SQL Server Management Studio。</span><span class="sxs-lookup"><span data-stu-id="2f04f-279">This code issues a `SELECT` query to return all products that are discontinued and returns this data to the calling application, which is SQL Server Management Studio in this instance.</span></span> <span data-ttu-id="2f04f-280">Management Studio 會接收這些結果，並將它們顯示在 [結果] 視窗中。</span><span class="sxs-lookup"><span data-stu-id="2f04f-280">Management Studio receives these results and displays them in the Results window.</span></span>

<span data-ttu-id="2f04f-281">[![GetDiscontinuedProducts 預存程式會傳回所有已停止的產品](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image24.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-281">[![The GetDiscontinuedProducts Stored Procedure Returns All Discontinued Products](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image24.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image23.png)</span></span>

<span data-ttu-id="2f04f-282">**圖 13**：預存程式會傳回 `GetDiscontinuedProducts` 所有已停止的產品 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image25.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-282">**Figure 13**: The `GetDiscontinuedProducts` Stored Procedure Returns All Discontinued Products ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image25.png))</span></span>

## <a name="step-5-creating-managed-stored-procedures-that-accept-input-parameters"></a><span data-ttu-id="2f04f-283">步驟5：建立接受輸入參數的 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="2f04f-283">Step 5: Creating Managed Stored Procedures that Accept Input Parameters</span></span>

<span data-ttu-id="2f04f-284">我們在這些教學課程中建立的許多查詢和預存程式都有使用 *參數*。</span><span class="sxs-lookup"><span data-stu-id="2f04f-284">Many of the queries and stored procedures we have created throughout these tutorials have used *parameters*.</span></span> <span data-ttu-id="2f04f-285">例如，在建立具 [類型資料集 tableadapter 教學課程的新預存程式](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) 中，我們建立了一個名為的預存程式，該預存程式 `GetProductsByCategoryID` 接受名為的輸入參數 `@CategoryID` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-285">For example, in the [Creating New Stored Procedures for the Typed DataSet s TableAdapters](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) tutorial we created a stored procedure named `GetProductsByCategoryID` that accepted an input parameter named `@CategoryID`.</span></span> <span data-ttu-id="2f04f-286">然後，預存程式會傳回其 `CategoryID` 欄位符合所提供參數值的所有產品 `@CategoryID` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-286">The stored procedure then returned all products whose `CategoryID` field matched the value of the supplied `@CategoryID` parameter.</span></span>

<span data-ttu-id="2f04f-287">若要建立可接受輸入參數的 managed 預存程式，只需在方法的定義中指定這些參數。</span><span class="sxs-lookup"><span data-stu-id="2f04f-287">To create a managed stored procedure that accepts input parameters, simply specify those parameters in the method s definition.</span></span> <span data-ttu-id="2f04f-288">為了說明這一點，讓我們將另一個 managed 預存程式新增至 `ManagedDatabaseConstructs` 名為的專案 `GetProductsWithPriceLessThan` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-288">To illustrate this, let s add another managed stored procedure to the `ManagedDatabaseConstructs` project named `GetProductsWithPriceLessThan`.</span></span> <span data-ttu-id="2f04f-289">此 managed 預存程式會接受指定價格的輸入參數，並傳回其 `UnitPrice` 欄位小於參數 s 值的所有產品。</span><span class="sxs-lookup"><span data-stu-id="2f04f-289">This managed stored procedure will accept an input parameter specifying a price and will return all products whose `UnitPrice` field is less than the parameter s value.</span></span>

<span data-ttu-id="2f04f-290">若要將新的預存程式加入至專案，請以滑鼠右鍵按一下 `ManagedDatabaseConstructs` 專案名稱，然後加入宣告新的預存程式。</span><span class="sxs-lookup"><span data-stu-id="2f04f-290">To add a new stored procedure to the project, right-click on the `ManagedDatabaseConstructs` project name and choose to add a new stored procedure.</span></span> <span data-ttu-id="2f04f-291">將檔案命名為 `GetProductsWithPriceLessThan.cs`。</span><span class="sxs-lookup"><span data-stu-id="2f04f-291">Name the file `GetProductsWithPriceLessThan.cs`.</span></span> <span data-ttu-id="2f04f-292">如我們在步驟3中所見，這將會建立一個新的 c # 類別檔案，其中包含一個名為的方法， `GetProductsWithPriceLessThan` 放在 `partial` 類別中 `StoredProcedures` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-292">As we saw in Step 3, this will create a new C# class file with a method named `GetProductsWithPriceLessThan` placed within the `partial` class `StoredProcedures`.</span></span>

<span data-ttu-id="2f04f-293">更新 `GetProductsWithPriceLessThan` 方法的定義，使其接受 [`SqlMoney`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.aspx) 名為的輸入參數 `price` ，並撰寫程式碼以執行並傳回查詢結果：</span><span class="sxs-lookup"><span data-stu-id="2f04f-293">Update the `GetProductsWithPriceLessThan` method s definition so that it accepts a [`SqlMoney`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.aspx) input parameter named `price` and write the code to execute and return the query results:</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample6.cs)]

<span data-ttu-id="2f04f-294">`GetProductsWithPriceLessThan`方法的定義和程式碼與 `GetDiscontinuedProducts` 在步驟3中建立之方法的定義和程式碼十分類似。</span><span class="sxs-lookup"><span data-stu-id="2f04f-294">The `GetProductsWithPriceLessThan` method s definition and code closely resembles the definition and code of the `GetDiscontinuedProducts` method created in Step 3.</span></span> <span data-ttu-id="2f04f-295">唯一的差異在於此 `GetProductsWithPriceLessThan` 方法會接受 () 的輸入參數 `price` 、 `SqlCommand` s 查詢包含 () 的參數 `@MaxPrice` ，而且會將參數加入至 `SqlCommand` s 集合， `Parameters` 並指派變數的值 `price` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-295">The only differences are that the `GetProductsWithPriceLessThan` method accepts as input parameter (`price`), the `SqlCommand` s query includes a parameter (`@MaxPrice`), and a parameter is added to the `SqlCommand` s `Parameters` collection is and assigned the value of the `price` variable.</span></span>

<span data-ttu-id="2f04f-296">新增此程式碼之後，請重新部署 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="2f04f-296">After adding this code, redeploy the SQL Server Project.</span></span> <span data-ttu-id="2f04f-297">接下來，返回 SQL Server Management Studio 並重新整理 [預存程式] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="2f04f-297">Next, return to SQL Server Management Studio and Refresh the Stored Procedures folder.</span></span> <span data-ttu-id="2f04f-298">您應該會看到新的專案 `GetProductsWithPriceLessThan` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-298">You should see a new entry, `GetProductsWithPriceLessThan`.</span></span> <span data-ttu-id="2f04f-299">從查詢視窗中，輸入並執行命令 `exec GetProductsWithPriceLessThan 25` ，這會列出所有小於 $25 的產品，如圖14所示。</span><span class="sxs-lookup"><span data-stu-id="2f04f-299">From a query window, enter and execute the command `exec GetProductsWithPriceLessThan 25`, which will list all products less than $25, as Figure 14 shows.</span></span>

<span data-ttu-id="2f04f-300">[![顯示 $25 下的產品](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image27.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-300">[![Products Under $25 are Displayed](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image27.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image26.png)</span></span>

<span data-ttu-id="2f04f-301">**圖 14**： $25 下的產品會顯示 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image28.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-301">**Figure 14**: Products Under $25 are Displayed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image28.png))</span></span>

## <a name="step-6-calling-the-managed-stored-procedure-from-the-data-access-layer"></a><span data-ttu-id="2f04f-302">步驟6：從資料存取層呼叫 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="2f04f-302">Step 6: Calling the Managed Stored Procedure from the Data Access Layer</span></span>

<span data-ttu-id="2f04f-303">至此，我們已將 `GetDiscontinuedProducts` 和 `GetProductsWithPriceLessThan` managed 預存程式新增至 `ManagedDatabaseConstructs` 專案，並已向 Northwind SQL Server 資料庫註冊它們。</span><span class="sxs-lookup"><span data-stu-id="2f04f-303">At this point we have added the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures to the `ManagedDatabaseConstructs` project and have registered them with the Northwind SQL Server database.</span></span> <span data-ttu-id="2f04f-304">我們也從 SQL Server Management Studio 叫用這些 managed 預存程式 (請參閱圖 s 13 和 14) 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-304">We also invoked these managed stored procedures from SQL Server Management Studio (see Figure s 13 and 14).</span></span> <span data-ttu-id="2f04f-305">不過，為了讓我們的 ASP.NET 應用程式使用這些 managed 預存程式，我們需要將它們新增至架構中的資料存取和商務邏輯層。</span><span class="sxs-lookup"><span data-stu-id="2f04f-305">In order for our ASP.NET application to use these managed stored procedures, however, we need to add them to the Data Access and Business Logic Layers in the architecture.</span></span> <span data-ttu-id="2f04f-306">在這個步驟中，我們會在具型別資料集的中加入兩個新方法 `ProductsTableAdapter` `NorthwindWithSprocs` ，這一開始是在為具型別 [資料集 Tableadapter 教學課程建立新的預存程式](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) 中建立的。</span><span class="sxs-lookup"><span data-stu-id="2f04f-306">In this step we will add two new methods to the `ProductsTableAdapter` in the `NorthwindWithSprocs` Typed DataSet, which was initially created in the [Creating New Stored Procedures for the Typed DataSet s TableAdapters](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) tutorial.</span></span> <span data-ttu-id="2f04f-307">在步驟7中，我們會將對應的方法新增至 BLL。</span><span class="sxs-lookup"><span data-stu-id="2f04f-307">In Step 7 we will add corresponding methods to the BLL.</span></span>

<span data-ttu-id="2f04f-308">`NorthwindWithSprocs`在 Visual Studio 中開啟具類型的資料集，並從將新方法加入至 `ProductsTableAdapter` 名為的開始 `GetDiscontinuedProducts` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-308">Open the `NorthwindWithSprocs` Typed DataSet in Visual Studio and start by adding a new method to the `ProductsTableAdapter` named `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="2f04f-309">若要將新的方法加入至 TableAdapter，請在設計工具中以滑鼠右鍵按一下 TableAdapter s 名稱，然後從內容功能表中選擇 [加入查詢] 選項。</span><span class="sxs-lookup"><span data-stu-id="2f04f-309">To add a new method to a TableAdapter, right-click on the TableAdapter s name in the Designer and choose the Add Query option from the context menu.</span></span>

> [!NOTE]
> <span data-ttu-id="2f04f-310">由於我們已將 Northwind 資料庫從 `App_Data` 資料夾移至 SQL Server 2005 Express Edition 資料庫實例，因此 Web.config 中對應的連接字串必須更新以反映這項變更。</span><span class="sxs-lookup"><span data-stu-id="2f04f-310">Since we moved the Northwind database from the `App_Data` folder to the SQL Server 2005 Express Edition database instance, it is imperative that the corresponding connection string in Web.config be updated to reflect this change.</span></span> <span data-ttu-id="2f04f-311">在步驟2中，我們討論了更新 `NORTHWNDConnectionString` 中的值 `Web.config` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-311">In Step 2 we discussed updating the `NORTHWNDConnectionString` value in `Web.config`.</span></span> <span data-ttu-id="2f04f-312">如果您忘記進行此更新，則會看到錯誤訊息無法加入查詢。</span><span class="sxs-lookup"><span data-stu-id="2f04f-312">If you forgot to make this update, then you will see the error message Failed to add query.</span></span> <span data-ttu-id="2f04f-313">`NORTHWNDConnectionString` `Web.config` 嘗試將新方法加入 TableAdapter 時，找不到對話方塊中物件的連接。</span><span class="sxs-lookup"><span data-stu-id="2f04f-313">Unable to find connection `NORTHWNDConnectionString` for object `Web.config` in a dialog box when attempting to add a new method to the TableAdapter.</span></span> <span data-ttu-id="2f04f-314">若要解決此錯誤，請按一下 [確定]，然後依 `Web.config` 步驟2所述，移至並更新 `NORTHWNDConnectionString` 值。</span><span class="sxs-lookup"><span data-stu-id="2f04f-314">To resolve this error, click OK and then go to `Web.config` and update the `NORTHWNDConnectionString` value as discussed in Step 2.</span></span> <span data-ttu-id="2f04f-315">然後，嘗試將方法重新新增至 TableAdapter。</span><span class="sxs-lookup"><span data-stu-id="2f04f-315">Then try re-adding the method to the TableAdapter.</span></span> <span data-ttu-id="2f04f-316">這次它應該可以正常運作，而不會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="2f04f-316">This time it should work without error.</span></span>

<span data-ttu-id="2f04f-317">新增方法會啟動 [TableAdapter 查詢設定向導]，在過去的教學課程中，我們已使用許多次。</span><span class="sxs-lookup"><span data-stu-id="2f04f-317">Adding a new method launches the TableAdapter Query Configuration wizard, which we have used many times in past tutorials.</span></span> <span data-ttu-id="2f04f-318">第一個步驟會要求我們指定 TableAdapter 應如何存取資料庫：透過臨機操作 SQL 語句，或透過新的或現有的預存程式。</span><span class="sxs-lookup"><span data-stu-id="2f04f-318">The first step asks us to specify how the TableAdapter should access the database: through an ad-hoc SQL statement or via a new or existing stored procedure.</span></span> <span data-ttu-id="2f04f-319">由於我們已經使用資料庫建立並註冊 `GetDiscontinuedProducts` managed 預存程式，因此請選擇 [使用現有的預存程式] 選項，然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-319">Since we have already created and registered the `GetDiscontinuedProducts` managed stored procedure with the database, choose the Use existing stored procedure option and hit Next.</span></span>

<span data-ttu-id="2f04f-320">[![選擇 [使用現有的預存程式] 選項](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image30.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-320">[![Choose the Use existing stored procedure Option](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image30.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image29.png)</span></span>

<span data-ttu-id="2f04f-321">**圖 15**：選擇 [使用現有的預存程式] 選項 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image31.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-321">**Figure 15**: Choose the Use existing stored procedure Option ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image31.png))</span></span>

<span data-ttu-id="2f04f-322">下一個畫面會提示我們輸入方法將叫用的預存程式。</span><span class="sxs-lookup"><span data-stu-id="2f04f-322">The next screen prompts us for the stored procedure the method will invoke.</span></span> <span data-ttu-id="2f04f-323">`GetDiscontinuedProducts`從下拉式清單中選擇 managed 預存程式，然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-323">Choose the `GetDiscontinuedProducts` managed stored procedure from the drop-down list and hit Next.</span></span>

<span data-ttu-id="2f04f-324">[![選取 GetDiscontinuedProducts 受控預存程式](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image33.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image32.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-324">[![Select the GetDiscontinuedProducts Managed Stored Procedure](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image33.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image32.png)</span></span>

<span data-ttu-id="2f04f-325">**圖 16**：選取 `GetDiscontinuedProducts` Managed 預存程式 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image34.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-325">**Figure 16**: Select the `GetDiscontinuedProducts` Managed Stored Procedure ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image34.png))</span></span>

<span data-ttu-id="2f04f-326">然後，系統會要求您指定預存程式是要傳回資料列、單一值或 nothing。</span><span class="sxs-lookup"><span data-stu-id="2f04f-326">We are then asked to specify whether the stored procedure returns rows, a single value, or nothing.</span></span> <span data-ttu-id="2f04f-327">由於會傳回一 `GetDiscontinuedProducts` 組已停止的產品資料列，請選擇 ( 表格式資料 ) 的第一個選項，然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-327">Since `GetDiscontinuedProducts` returns the set of discontinued product rows, choose the first option ( Tabular data ) and click Next.</span></span>

<span data-ttu-id="2f04f-328">[![選取表格式資料選項](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image36.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-328">[![Select the Tabular Data Option](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image36.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image35.png)</span></span>

<span data-ttu-id="2f04f-329">**圖 17**：選取表格式資料選項 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image37.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-329">**Figure 17**: Select the Tabular Data Option ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image37.png))</span></span>

<span data-ttu-id="2f04f-330">最後的 wizard 畫面可讓我們指定所使用的資料存取模式，以及所產生方法的名稱。</span><span class="sxs-lookup"><span data-stu-id="2f04f-330">The final wizard screen allows us to specify the data access patterns used and the names of the resulting methods.</span></span> <span data-ttu-id="2f04f-331">將兩個核取方塊保持選取狀態，並將方法命名為 `FillByDiscontinued` 和 `GetDiscontinuedProducts` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-331">Leave both checkboxes checked and name the methods `FillByDiscontinued` and `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="2f04f-332">按一下 [完成] 以完成精靈。</span><span class="sxs-lookup"><span data-stu-id="2f04f-332">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="2f04f-333">[![將方法命名為 FillByDiscontinued 和 GetDiscontinuedProducts](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image39.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-333">[![Name the Methods FillByDiscontinued and GetDiscontinuedProducts](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image39.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image38.png)</span></span>

<span data-ttu-id="2f04f-334">**圖 18**：命名方法 `FillByDiscontinued` 並 `GetDiscontinuedProducts` ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image40.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-334">**Figure 18**: Name the Methods `FillByDiscontinued` and `GetDiscontinuedProducts` ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image40.png))</span></span>

<span data-ttu-id="2f04f-335">重複這些步驟， `FillByPriceLessThan` `GetProductsWithPriceLessThan` 在中 `ProductsTableAdapter` 針對 `GetProductsWithPriceLessThan` managed 預存程式建立名為和的方法。</span><span class="sxs-lookup"><span data-stu-id="2f04f-335">Repeat these steps to create methods named `FillByPriceLessThan` and `GetProductsWithPriceLessThan` in the `ProductsTableAdapter` for the `GetProductsWithPriceLessThan` managed stored procedure.</span></span>

<span data-ttu-id="2f04f-336">[圖 19] 顯示將的方法加入至的 `ProductsTableAdapter` `GetDiscontinuedProducts` 和 `GetProductsWithPriceLessThan` managed 預存程式之後，資料集設計工具的螢幕擷取畫面。</span><span class="sxs-lookup"><span data-stu-id="2f04f-336">Figure 19 shows a screenshot of the DataSet Designer after adding the methods to the `ProductsTableAdapter` for the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures.</span></span>

<span data-ttu-id="2f04f-337">[![此 ProductsTableAdapter 包含在此步驟中新增的方法](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image42.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-337">[![The ProductsTableAdapter Includes the New Methods Added in this Step](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image42.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image41.png)</span></span>

<span data-ttu-id="2f04f-338">**圖 19**： `ProductsTableAdapter` 包含這個步驟新增的方法 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image43.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-338">**Figure 19**: The `ProductsTableAdapter` Includes the New Methods Added in this Step ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image43.png))</span></span>

## <a name="step-7-adding-corresponding-methods-to-the-business-logic-layer"></a><span data-ttu-id="2f04f-339">步驟7：將對應的方法加入至商務邏輯層</span><span class="sxs-lookup"><span data-stu-id="2f04f-339">Step 7: Adding Corresponding Methods to the Business Logic Layer</span></span>

<span data-ttu-id="2f04f-340">既然我們已更新資料存取層，以包含呼叫步驟4和5中所加入之 managed 預存程式的方法，我們必須將對應的方法加入至商務邏輯層。</span><span class="sxs-lookup"><span data-stu-id="2f04f-340">Now that we have updated the Data Access Layer to include methods for calling the managed stored procedures added in Steps 4 and 5, we need to add corresponding methods to the Business Logic Layer.</span></span> <span data-ttu-id="2f04f-341">將下列兩個方法新增至 `ProductsBLLWithSprocs` 類別：</span><span class="sxs-lookup"><span data-stu-id="2f04f-341">Add the following two methods to the `ProductsBLLWithSprocs` class:</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample7.cs)]

<span data-ttu-id="2f04f-342">這兩種方法只會呼叫對應的 DAL 方法，並傳回 `ProductsDataTable` 實例。</span><span class="sxs-lookup"><span data-stu-id="2f04f-342">Both methods simply call the corresponding DAL method and return the `ProductsDataTable` instance.</span></span> <span data-ttu-id="2f04f-343">`DataObjectMethodAttribute`每個方法上方的標記都會讓這些方法包含在 ObjectDataSource 的 [設定資料來源] wizard 的 [選取] 索引標籤中的下拉式清單中。</span><span class="sxs-lookup"><span data-stu-id="2f04f-343">The `DataObjectMethodAttribute` markup above each method causes these methods to be included in the drop-down list in the SELECT tab of the ObjectDataSource s Configure Data Source wizard.</span></span>

## <a name="step-8-invoking-the-managed-stored-procedures-from-the-presentation-layer"></a><span data-ttu-id="2f04f-344">步驟8：從展示層叫用 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="2f04f-344">Step 8: Invoking the Managed Stored Procedures from the Presentation Layer</span></span>

<span data-ttu-id="2f04f-345">利用增強的商務邏輯和資料存取層來支援呼叫 `GetDiscontinuedProducts` 和 `GetProductsWithPriceLessThan` managed 預存程式，現在我們可以透過 ASP.NET 網頁顯示這些預存程式的結果。</span><span class="sxs-lookup"><span data-stu-id="2f04f-345">With the Business Logic and Data Access Layers augmented to include support for calling the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures, we can now display these stored procedures results through an ASP.NET page.</span></span>

<span data-ttu-id="2f04f-346">開啟 `ManagedFunctionsAndSprocs.aspx` 資料夾中的頁面， `AdvancedDAL` 然後從 [工具箱] 將 GridView 拖曳至設計工具。</span><span class="sxs-lookup"><span data-stu-id="2f04f-346">Open the `ManagedFunctionsAndSprocs.aspx` page in the `AdvancedDAL` folder and, from the Toolbox, drag a GridView onto the Designer.</span></span> <span data-ttu-id="2f04f-347">將 GridView 的 `ID` 屬性設定為 `DiscontinuedProducts` ，並從其智慧標籤將其系結至名為的新 ObjectDataSource `DiscontinuedProductsDataSource` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-347">Set the GridView s `ID` property to `DiscontinuedProducts` and, from its smart tag, bind it to a new ObjectDataSource named `DiscontinuedProductsDataSource`.</span></span> <span data-ttu-id="2f04f-348">設定 ObjectDataSource 從類別 s 方法提取其資料 `ProductsBLLWithSprocs` `GetDiscontinuedProducts` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-348">Configure the ObjectDataSource to pull its data from the `ProductsBLLWithSprocs` class s `GetDiscontinuedProducts` method.</span></span>

<span data-ttu-id="2f04f-349">[![設定 ObjectDataSource 以使用 ProductsBLLWithSprocs 類別](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image45.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-349">[![Configure the ObjectDataSource to Use the ProductsBLLWithSprocs Class](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image45.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image44.png)</span></span>

<span data-ttu-id="2f04f-350">**圖 20**：設定 ObjectDataSource 以使用 `ProductsBLLWithSprocs` 類別 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image46.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-350">**Figure 20**: Configure the ObjectDataSource to Use the `ProductsBLLWithSprocs` Class ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image46.png))</span></span>

<span data-ttu-id="2f04f-351">[![從選取索引標籤的下拉式清單中選擇 [GetDiscontinuedProducts] 方法](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image48.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-351">[![Choose the GetDiscontinuedProducts Method from the Drop-Down List in the SELECT Tab](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image48.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image47.png)</span></span>

<span data-ttu-id="2f04f-352">**圖 21**： `GetDiscontinuedProducts` 在 [選取] 索引標籤的下拉式清單中選擇方法 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image49.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-352">**Figure 21**: Choose the `GetDiscontinuedProducts` Method from the Drop-Down List in the SELECT Tab ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image49.png))</span></span>

<span data-ttu-id="2f04f-353">因為這個方格將用來只顯示產品資訊，所以請將 [更新]、[插入] 和 [刪除] 索引標籤中的下拉式清單設定為 [無] () 然後按一下 [完成]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-353">Since this grid will be used to just display product information, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and then click Finish.</span></span>

<span data-ttu-id="2f04f-354">完成嚮導之後，Visual Studio 會自動為中的每個資料欄位新增 BoundField 或 CheckBoxField `ProductsDataTable` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-354">Upon completing the wizard, Visual Studio will automatically add a BoundField or CheckBoxField for each data field in the `ProductsDataTable`.</span></span> <span data-ttu-id="2f04f-355">請花一些時間來移除除了和以外的所有 `ProductName` 欄位 `Discontinued` ，此時您的 GridView 和 ObjectDataSource 宣告式標記看起來應該會如下所示：</span><span class="sxs-lookup"><span data-stu-id="2f04f-355">Take a moment to remove all of these fields except for `ProductName` and `Discontinued`, at which point your GridView and ObjectDataSource s declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample8.aspx)]

<span data-ttu-id="2f04f-356">花點時間透過瀏覽器來觀看此頁面。</span><span class="sxs-lookup"><span data-stu-id="2f04f-356">Take a moment to view this page through a browser.</span></span> <span data-ttu-id="2f04f-357">造訪頁面時，ObjectDataSource 會呼叫 `ProductsBLLWithSprocs` 類別 s `GetDiscontinuedProducts` 方法。</span><span class="sxs-lookup"><span data-stu-id="2f04f-357">When the page is visited, the ObjectDataSource calls the `ProductsBLLWithSprocs` class s `GetDiscontinuedProducts` method.</span></span> <span data-ttu-id="2f04f-358">如我們在步驟7中所見，這個方法會向下呼叫 DAL s `ProductsDataTable` 類別的 `GetDiscontinuedProducts` 方法，此方法會叫用 `GetDiscontinuedProducts` 預存程式。</span><span class="sxs-lookup"><span data-stu-id="2f04f-358">As we saw in Step 7, this method calls down to the DAL s `ProductsDataTable` class s `GetDiscontinuedProducts` method, which invokes the `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="2f04f-359">這個預存程式是 managed 預存程式，會執行我們在步驟3中建立的程式碼，以傳回已停止的產品。</span><span class="sxs-lookup"><span data-stu-id="2f04f-359">This stored procedure is a managed stored procedure and executes the code we created in Step 3, returning the discontinued products.</span></span>

<span data-ttu-id="2f04f-360">Managed 預存程式所傳回的結果會由 DAL 封裝到中 `ProductsDataTable` ，然後傳回給 BLL，然後將它們傳回至展示層，並將其系結至 GridView 並顯示。</span><span class="sxs-lookup"><span data-stu-id="2f04f-360">The results returned by the managed stored procedure are packaged up into a `ProductsDataTable` by the DAL and then returned to the BLL, which then returns them to the Presentation Layer where they are bound to the GridView and displayed.</span></span> <span data-ttu-id="2f04f-361">如預期般，方格會列出已停止的產品。</span><span class="sxs-lookup"><span data-stu-id="2f04f-361">As expected, the grid lists those products that have been discontinued.</span></span>

<span data-ttu-id="2f04f-362">[![已停止的產品會列出](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image51.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-362">[![The Discontinued Products are Listed](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image51.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image50.png)</span></span>

<span data-ttu-id="2f04f-363">**圖 22**：已停止的產品會列出 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image52.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-363">**Figure 22**: The Discontinued Products are Listed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image52.png))</span></span>

<span data-ttu-id="2f04f-364">為了進一步練習，請在頁面中新增 TextBox 和另一個 GridView。</span><span class="sxs-lookup"><span data-stu-id="2f04f-364">For further practice, add a TextBox and another GridView to the page.</span></span> <span data-ttu-id="2f04f-365">讓這個 GridView 藉由呼叫類別 s 方法來顯示小於輸入文字方塊的產品 `ProductsBLLWithSprocs` `GetProductsWithPriceLessThan` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-365">Have this GridView display the products less than the amount entered into the TextBox by calling the `ProductsBLLWithSprocs` class s `GetProductsWithPriceLessThan` method.</span></span>

## <a name="step-9-creating-and-calling-t-sql-udfs"></a><span data-ttu-id="2f04f-366">步驟9：建立和呼叫 T-sql Udf</span><span class="sxs-lookup"><span data-stu-id="2f04f-366">Step 9: Creating and Calling T-SQL UDFs</span></span>

<span data-ttu-id="2f04f-367">使用者定義函式（或 Udf）是指在程式設計語言中密切模仿函式之語義的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-367">User-Defined Functions, or UDFs, are database objects the closely mimic the semantics of functions in programming languages.</span></span> <span data-ttu-id="2f04f-368">如同 c # 中的函式，Udf 可以包含可變數目的輸入參數，並傳回特定類型的值。</span><span class="sxs-lookup"><span data-stu-id="2f04f-368">Like a function in C#, UDFs can include a variable number of input parameters and return a value of a particular type.</span></span> <span data-ttu-id="2f04f-369">UDF 可以傳回純量資料，也就是字串、整數，依此類推或表格式資料。</span><span class="sxs-lookup"><span data-stu-id="2f04f-369">A UDF can return either scalar data - a string, an integer, and so forth - or tabular data.</span></span> <span data-ttu-id="2f04f-370">讓我們快速查看兩種類型的 Udf，從會傳回純量資料類型的 UDF 開始。</span><span class="sxs-lookup"><span data-stu-id="2f04f-370">Let s take a quick look at both types of UDFs, starting with a UDF that returns a scalar data type.</span></span>

<span data-ttu-id="2f04f-371">下列 UDF 會計算特定產品的清查預估值。</span><span class="sxs-lookup"><span data-stu-id="2f04f-371">The following UDF calculates the estimated value of the inventory for a particular product.</span></span> <span data-ttu-id="2f04f-372">它會採用三個輸入參數（ `UnitPrice` 特定產品的、 `UnitsInStock` 和值），並傳回類型的 `Discontinued` 值 `money` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-372">It does so by taking in three input parameters - the `UnitPrice`, `UnitsInStock`, and `Discontinued` values for a particular product - and returns a value of type `money`.</span></span> <span data-ttu-id="2f04f-373">它會藉由將乘以來計算清查的估計值 `UnitPrice` `UnitsInStock` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-373">It computes the estimated value of the inventory by multiplying the `UnitPrice` by the `UnitsInStock`.</span></span> <span data-ttu-id="2f04f-374">針對已停止的專案，此值會減半。</span><span class="sxs-lookup"><span data-stu-id="2f04f-374">For discontinued items, this value is halved.</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample9.sql)]

<span data-ttu-id="2f04f-375">一旦將此 UDF 新增至資料庫之後，就可以藉由展開 [可程式性] 資料夾、函式和純量值函式，在 Management Studio 中找到它。</span><span class="sxs-lookup"><span data-stu-id="2f04f-375">Once this UDF has been added to the database, it can be found through Management Studio by expanding the Programmability folder, then Functions, and then Scalar-value Functions.</span></span> <span data-ttu-id="2f04f-376">它可用於 `SELECT` 查詢中，如下所示：</span><span class="sxs-lookup"><span data-stu-id="2f04f-376">It can be used in a `SELECT` query like so:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample10.sql)]

<span data-ttu-id="2f04f-377">我已將 `udf_ComputeInventoryValue` UDF 新增至 Northwind 資料庫;[圖 23] 顯示 `SELECT` 透過 Management Studio 查看上述查詢的輸出。</span><span class="sxs-lookup"><span data-stu-id="2f04f-377">I have added the `udf_ComputeInventoryValue` UDF to the Northwind database; Figure 23 shows the output of the above `SELECT` query when viewed through Management Studio.</span></span> <span data-ttu-id="2f04f-378">另請注意，UDF 會列在物件總管的 [純量值函式] 資料夾底下。</span><span class="sxs-lookup"><span data-stu-id="2f04f-378">Also note that the UDF is listed under the Scalar-value Functions folder in the Object Explorer.</span></span>

<span data-ttu-id="2f04f-379">[![列出每個產品的清查值](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image54.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-379">[![Each Product s Inventory Values is Listed](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image54.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image53.png)</span></span>

<span data-ttu-id="2f04f-380">**圖 23**：每個產品的清查值都列出 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image55.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-380">**Figure 23**: Each Product s Inventory Values is Listed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image55.png))</span></span>

<span data-ttu-id="2f04f-381">Udf 也可以傳回表格式資料。</span><span class="sxs-lookup"><span data-stu-id="2f04f-381">UDFs can also return tabular data.</span></span> <span data-ttu-id="2f04f-382">例如，我們可以建立 UDF 來傳回屬於特定類別的產品：</span><span class="sxs-lookup"><span data-stu-id="2f04f-382">For example, we can create a UDF that returns products that belong to a particular category:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample11.sql)]

<span data-ttu-id="2f04f-383">`udf_GetProductsByCategoryID`UDF 接受 `@CategoryID` 輸入參數，並傳回指定之查詢的結果 `SELECT` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-383">The `udf_GetProductsByCategoryID` UDF accepts a `@CategoryID` input parameter and returns the results of the specified `SELECT` query.</span></span> <span data-ttu-id="2f04f-384">一旦建立之後，就可以在 `FROM` 查詢的 (或) 子句中參考此 UDF `JOIN` `SELECT` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-384">Once created, this UDF can be referenced in the `FROM` (or `JOIN`) clause of a `SELECT` query.</span></span> <span data-ttu-id="2f04f-385">下列範例會傳回 `ProductID` `ProductName` `CategoryID` 每個飲料的、和值。</span><span class="sxs-lookup"><span data-stu-id="2f04f-385">The following example would return the `ProductID`, `ProductName`, and `CategoryID` values for each of the beverages.</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample12.sql)]

<span data-ttu-id="2f04f-386">我已將 `udf_GetProductsByCategoryID` UDF 新增至 Northwind 資料庫;圖24顯示 `SELECT` 透過 Management Studio 查看上述查詢的輸出。</span><span class="sxs-lookup"><span data-stu-id="2f04f-386">I have added the `udf_GetProductsByCategoryID` UDF to the Northwind database; Figure 24 shows the output of the above `SELECT` query when viewed through Management Studio.</span></span> <span data-ttu-id="2f04f-387">傳回表格式資料的 Udf 可以在物件總管的資料表值函數資料夾中找到。</span><span class="sxs-lookup"><span data-stu-id="2f04f-387">UDFs that return tabular data can be found in the Object Explorer s Table-value Functions folder.</span></span>

<span data-ttu-id="2f04f-388">[![每個飲料都會列出 ProductID、ProductName 和類別名稱](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image57.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-388">[![The ProductID, ProductName, and CategoryID are Listed for Each Beverage](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image57.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image56.png)</span></span>

<span data-ttu-id="2f04f-389">**圖 24**： `ProductID` `ProductName` `CategoryID` 每個飲料都會列出、和， ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image58.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-389">**Figure 24**: The `ProductID`, `ProductName`, and `CategoryID` are Listed for Each Beverage ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image58.png))</span></span>

> [!NOTE]
> <span data-ttu-id="2f04f-390">如需有關建立和使用 Udf 的詳細資訊，請參閱 [使用者定義函數的簡介](http://www.sqlteam.com/item.asp?ItemID=1955)。</span><span class="sxs-lookup"><span data-stu-id="2f04f-390">For more information on creating and using UDFs, check out [Intro to User-Defined Functions](http://www.sqlteam.com/item.asp?ItemID=1955).</span></span> <span data-ttu-id="2f04f-391">另外也請查看 [使用者定義函數的優點和缺點](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1)。</span><span class="sxs-lookup"><span data-stu-id="2f04f-391">Also check out [Advantages and Drawbacks of User-Defined Functions](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1).</span></span>

## <a name="step-10-creating-a-managed-udf"></a><span data-ttu-id="2f04f-392">步驟10：建立受控 UDF</span><span class="sxs-lookup"><span data-stu-id="2f04f-392">Step 10: Creating a Managed UDF</span></span>

<span data-ttu-id="2f04f-393">`udf_ComputeInventoryValue` `udf_GetProductsByCategoryID` 在上述範例中建立的和 Udf 為 t-sql 資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-393">The `udf_ComputeInventoryValue` and `udf_GetProductsByCategoryID` UDFs created in the above examples are T-SQL database objects.</span></span> <span data-ttu-id="2f04f-394">SQL Server 2005 也支援受控 Udf，可新增至 `ManagedDatabaseConstructs` 專案，就像步驟3和5中的 managed 預存程式一樣。</span><span class="sxs-lookup"><span data-stu-id="2f04f-394">SQL Server 2005 also supports managed UDFs, which can be added to the `ManagedDatabaseConstructs` project just like the managed stored procedures from Steps 3 and 5.</span></span> <span data-ttu-id="2f04f-395">在這個步驟中，讓我們 `udf_ComputeInventoryValue` 在 managed 程式碼中執行 UDF。</span><span class="sxs-lookup"><span data-stu-id="2f04f-395">For this step, let s implement the `udf_ComputeInventoryValue` UDF in managed code.</span></span>

<span data-ttu-id="2f04f-396">若要將 managed UDF 新增至 `ManagedDatabaseConstructs` 專案，請在方案總管中的專案名稱上按一下滑鼠右鍵，然後加入宣告新專案。</span><span class="sxs-lookup"><span data-stu-id="2f04f-396">To add a managed UDF to the `ManagedDatabaseConstructs` project, right-click on the project name in Solution Explorer and choose to Add a New Item.</span></span> <span data-ttu-id="2f04f-397">從 [加入新專案] 對話方塊中選取 [使用者定義] 範本，並將新的 UDF 檔案命名為 `udf_ComputeInventoryValue_Managed.cs` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-397">Select the User-Defined Template from the Add New Item dialog box and name the new UDF file `udf_ComputeInventoryValue_Managed.cs`.</span></span>

<span data-ttu-id="2f04f-398">[![將新的受控 UDF 新增至 ManagedDatabaseConstructs 專案](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image60.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image59.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-398">[![Add a New Managed UDF to the ManagedDatabaseConstructs Project](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image60.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image59.png)</span></span>

<span data-ttu-id="2f04f-399">**圖 25**：在專案中加入新的受控 UDF `ManagedDatabaseConstructs` ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image61.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-399">**Figure 25**: Add a New Managed UDF to the `ManagedDatabaseConstructs` Project ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image61.png))</span></span>

<span data-ttu-id="2f04f-400">使用者定義函式範本會建立名為的 `partial` 類別， `UserDefinedFunctions` 其名稱與類別檔案的名稱相同 (`udf_ComputeInventoryValue_Managed` ，在此例中) 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-400">The User-Defined Function template creates a `partial` class named `UserDefinedFunctions` with a method whose name is the same as the class file s name (`udf_ComputeInventoryValue_Managed`, in this instance).</span></span> <span data-ttu-id="2f04f-401">這個方法會使用屬性裝飾，而此[ `SqlFunction` 屬性](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlfunctionattribute.aspx)會將方法標示為受管理的 UDF。</span><span class="sxs-lookup"><span data-stu-id="2f04f-401">This method is decorated using the [`SqlFunction` attribute](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlfunctionattribute.aspx), which flags the method as a managed UDF.</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample13.cs)]

<span data-ttu-id="2f04f-402">`udf_ComputeInventoryValue`方法目前會傳回[ `SqlString` 物件](https://msdn.microsoft.com/library/system.data.sqltypes.sqlstring.aspx)，但不接受任何輸入參數。</span><span class="sxs-lookup"><span data-stu-id="2f04f-402">The `udf_ComputeInventoryValue` method currently returns a [`SqlString` object](https://msdn.microsoft.com/library/system.data.sqltypes.sqlstring.aspx) and does not accept any input parameters.</span></span> <span data-ttu-id="2f04f-403">我們需要更新方法定義，讓它接受三個輸入參數- `UnitPrice` 、 `UnitsInStock` 和-， `Discontinued` 並傳回 `SqlMoney` 物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-403">We need to update the method definition so that it accepts three input parameters - `UnitPrice`, `UnitsInStock`, and `Discontinued` - and returns a `SqlMoney` object.</span></span> <span data-ttu-id="2f04f-404">計算清查值的邏輯與 T-sql UDF 中的邏輯相同 `udf_ComputeInventoryValue` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-404">The logic for calculating the inventory value is identical to that in the T-SQL `udf_ComputeInventoryValue` UDF.</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample14.cs)]

<span data-ttu-id="2f04f-405">請注意，UDF 方法的輸入參數是其對應的 SQL 類型： `SqlMoney` 適用于的 `UnitPrice` 欄位、 [`SqlInt16`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlint16.aspx) for 的 `UnitsInStock` 和 [`SqlBoolean`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlboolean.aspx) `Discontinued` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-405">Note that the UDF method s input parameters are of their corresponding SQL types: `SqlMoney` for the `UnitPrice` field, [`SqlInt16`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlint16.aspx) for `UnitsInStock`, and [`SqlBoolean`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlboolean.aspx) for `Discontinued`.</span></span> <span data-ttu-id="2f04f-406">這些資料類型會反映資料表中定義的類型 `Products` ：資料 `UnitPrice` 行的類型為 `money` 、類型的資料 `UnitsInStock` 行 `smallint` ，以及類型的資料 `Discontinued` 行 `bit` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-406">These data types reflect the types defined in the `Products` table: the `UnitPrice` column is of type `money`, the `UnitsInStock` column of type `smallint`, and the `Discontinued` column of type `bit`.</span></span>

<span data-ttu-id="2f04f-407">程式碼一開始會先建立 `SqlMoney` 名為 `inventoryValue` 的實例，並將值指派為0。</span><span class="sxs-lookup"><span data-stu-id="2f04f-407">The code starts by creating a `SqlMoney` instance named `inventoryValue` that is assigned a value of 0.</span></span> <span data-ttu-id="2f04f-408">`Products`資料表允許 `NULL` 和資料行中的資料庫 `UnitsInPrice` 值 `UnitsInStock` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-408">The `Products` table allows for database `NULL` values in the `UnitsInPrice` and `UnitsInStock` columns.</span></span> <span data-ttu-id="2f04f-409">因此，我們需要先檢查這些值是否包含 `NULL` s，我們會透過 `SqlMoney` 物件的[ `IsNull` 屬性](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.isnull.aspx)來進行。</span><span class="sxs-lookup"><span data-stu-id="2f04f-409">Therefore, we need to first check to see if these values contain `NULL` s, which we do through the `SqlMoney` object s [`IsNull` property](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.isnull.aspx).</span></span> <span data-ttu-id="2f04f-410">如果 `UnitPrice` 和都 `UnitsInStock` 包含非 `NULL` 值，則我們 `inventoryValue` 會計算為兩者的乘積。</span><span class="sxs-lookup"><span data-stu-id="2f04f-410">If both `UnitPrice` and `UnitsInStock` contain non-`NULL` values, then we compute the `inventoryValue` to be the product of the two.</span></span> <span data-ttu-id="2f04f-411">然後，如果 `Discontinued` 是 true，則會可以藉減半值。</span><span class="sxs-lookup"><span data-stu-id="2f04f-411">Then, if `Discontinued` is true, then we halve the value.</span></span>

> [!NOTE]
> <span data-ttu-id="2f04f-412">`SqlMoney`物件只允許將兩個 `SqlMoney` 實例相乘。</span><span class="sxs-lookup"><span data-stu-id="2f04f-412">The `SqlMoney` object only allows two `SqlMoney` instances to be multiplied together.</span></span> <span data-ttu-id="2f04f-413">它不允許將 `SqlMoney` 實例乘以常值浮點數。</span><span class="sxs-lookup"><span data-stu-id="2f04f-413">It does not allow a `SqlMoney` instance to be multiplied by a literal floating-point number.</span></span> <span data-ttu-id="2f04f-414">因此，若要可以藉減半， `inventoryValue` 我們會將它乘以值為0.5 的新 `SqlMoney` 實例。</span><span class="sxs-lookup"><span data-stu-id="2f04f-414">Therefore, to halve `inventoryValue` we multiply it by a new `SqlMoney` instance that has the value 0.5.</span></span>

## <a name="step-11-deploying-the-managed-udf"></a><span data-ttu-id="2f04f-415">步驟11：部署受控 UDF</span><span class="sxs-lookup"><span data-stu-id="2f04f-415">Step 11: Deploying the Managed UDF</span></span>

<span data-ttu-id="2f04f-416">現在已建立受控 UDF，我們已準備好將其部署至 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="2f04f-416">Now that the managed UDF has been created, we are ready to deploy it to the Northwind database.</span></span> <span data-ttu-id="2f04f-417">如我們在步驟4中所見，以滑鼠右鍵按一下方案總管中的專案名稱，然後從內容功能表中選擇 [部署] 選項，即可部署 SQL Server 專案中的 managed 物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-417">As we saw in Step 4, the managed objects in a SQL Server Project are deployed by right-clicking on the project name in the Solution Explorer and choosing the Deploy option from the context menu.</span></span>

<span data-ttu-id="2f04f-418">部署專案之後，請返回 SQL Server Management Studio 並重新整理純量值函式資料夾。</span><span class="sxs-lookup"><span data-stu-id="2f04f-418">Once you have deployed the project, return to SQL Server Management Studio and refresh the Scalar-valued Functions folder.</span></span> <span data-ttu-id="2f04f-419">您現在應該會看到兩個專案：</span><span class="sxs-lookup"><span data-stu-id="2f04f-419">You should now see two entries:</span></span>

- <span data-ttu-id="2f04f-420">`dbo.udf_ComputeInventoryValue` -在步驟9中建立的 T-sql UDF，以及</span><span class="sxs-lookup"><span data-stu-id="2f04f-420">`dbo.udf_ComputeInventoryValue` - the T-SQL UDF created in Step 9, and</span></span>
- <span data-ttu-id="2f04f-421">`dbo.udf ComputeInventoryValue_Managed` -剛部署的步驟10中建立的受控 UDF。</span><span class="sxs-lookup"><span data-stu-id="2f04f-421">`dbo.udf ComputeInventoryValue_Managed` - the managed UDF created in Step 10 that was just deployed.</span></span>

<span data-ttu-id="2f04f-422">若要測試此受控 UDF，請從 Management Studio 中執行下列查詢：</span><span class="sxs-lookup"><span data-stu-id="2f04f-422">To test this managed UDF, execute the following query from within Management Studio:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample15.sql)]

<span data-ttu-id="2f04f-423">此命令會使用 managed `udf ComputeInventoryValue_Managed` UDF 而非 T-sql `udf_ComputeInventoryValue` UDF，但輸出會相同。</span><span class="sxs-lookup"><span data-stu-id="2f04f-423">This command uses the managed `udf ComputeInventoryValue_Managed` UDF instead of the T-SQL `udf_ComputeInventoryValue` UDF, but the output is the same.</span></span> <span data-ttu-id="2f04f-424">返回 [圖 23] 以查看 UDF 輸出的螢幕擷取畫面。</span><span class="sxs-lookup"><span data-stu-id="2f04f-424">Refer back to Figure 23 to see a screenshot of the UDF s output.</span></span>

## <a name="step-12-debugging-the-managed-database-objects"></a><span data-ttu-id="2f04f-425">步驟12：調試 Managed 資料庫物件</span><span class="sxs-lookup"><span data-stu-id="2f04f-425">Step 12: Debugging the Managed Database Objects</span></span>

<span data-ttu-id="2f04f-426">在 [偵錯工具的偵錯工具](debugging-stored-procedures-cs.md) 教學課程中，我們討論了三個透過 Visual Studio 來進行 SQL Server 的偵錯工具選項：直接資料庫的偵錯工具、應用程式的偵錯工具，以及 SQL Server 專案的偵錯工具</span><span class="sxs-lookup"><span data-stu-id="2f04f-426">In the [Debugging Stored Procedures](debugging-stored-procedures-cs.md) tutorial we discussed the three options for debugging SQL Server through Visual Studio: Direct Database Debugging, Application Debugging, and Debugging from a SQL Server Project.</span></span> <span data-ttu-id="2f04f-427">受管理的資料庫物件無法透過直接資料庫的偵錯工具進行調試，但可以從用戶端應用程式和 SQL Server 專案直接進行調試。</span><span class="sxs-lookup"><span data-stu-id="2f04f-427">Managed database objects cannot be debugged via Direct Database Debugging, but can be debugged from a client application and directly from the SQL Server Project.</span></span> <span data-ttu-id="2f04f-428">不過，若要讓偵錯工具正常運作，SQL Server 2005 資料庫必須允許 SQL/CLR 的偵錯工具。</span><span class="sxs-lookup"><span data-stu-id="2f04f-428">In order for debugging to work, however, the SQL Server 2005 database must allow SQL/CLR debugging.</span></span> <span data-ttu-id="2f04f-429">回想一下，當我們第一次建立 `ManagedDatabaseConstructs` 專案時 Visual Studio 會詢問我們是否要啟用 SQL/CLR 偵錯工具 (請參閱步驟 2) 的圖6。</span><span class="sxs-lookup"><span data-stu-id="2f04f-429">Recall that when we first created the `ManagedDatabaseConstructs` project Visual Studio asked us whether we wanted to enable SQL/CLR debugging (see Figure 6 in Step 2).</span></span> <span data-ttu-id="2f04f-430">您可以用滑鼠右鍵按一下伺服器總管視窗中的資料庫，以修改此設定。</span><span class="sxs-lookup"><span data-stu-id="2f04f-430">This setting can be modified by right-clicking on the database from the Server Explorer window.</span></span>

![確定資料庫允許 SQL/CLR 偵錯工具](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image62.png)

<span data-ttu-id="2f04f-432">**圖 26**：確定資料庫允許 SQL/CLR 偵錯工具</span><span class="sxs-lookup"><span data-stu-id="2f04f-432">**Figure 26**: Ensure that the Database Allows SQL/CLR Debugging</span></span>

<span data-ttu-id="2f04f-433">假設我們想要對 `GetProductsWithPriceLessThan` managed 預存程式進行 debug。</span><span class="sxs-lookup"><span data-stu-id="2f04f-433">Imagine that we wanted to debug the `GetProductsWithPriceLessThan` managed stored procedure.</span></span> <span data-ttu-id="2f04f-434">我們首先會在方法的程式碼內設定中斷點 `GetProductsWithPriceLessThan` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-434">We would start by setting a breakpoint within the code of the `GetProductsWithPriceLessThan` method.</span></span>

<span data-ttu-id="2f04f-435">[![在 GetProductsWithPriceLessThan 方法中設定中斷點](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image64.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image63.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-435">[![Set a Breakpoint in the GetProductsWithPriceLessThan Method](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image64.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image63.png)</span></span>

<span data-ttu-id="2f04f-436">**圖 27**：在方法中設定中斷點 `GetProductsWithPriceLessThan` ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image65.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-436">**Figure 27**: Set a Breakpoint in the `GetProductsWithPriceLessThan` Method ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image65.png))</span></span>

<span data-ttu-id="2f04f-437">讓我們先從 SQL Server 專案中查看 managed 資料庫物件的調試。</span><span class="sxs-lookup"><span data-stu-id="2f04f-437">Let s first look at debugging the managed database objects from the SQL Server Project.</span></span> <span data-ttu-id="2f04f-438">由於我們的解決方案包含兩個專案（ `ManagedDatabaseConstructs` SQL Server 專案與我們的網站），因此，若要從 SQL Server 專案進行調試，我們必須指示 Visual Studio `ManagedDatabaseConstructs` 在開始進行調試時啟動 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="2f04f-438">Since our Solution includes two projects - the `ManagedDatabaseConstructs` SQL Server Project along with our website - in order to debug from the SQL Server Project we need to instruct Visual Studio to launch the `ManagedDatabaseConstructs` SQL Server Project when we start debugging.</span></span> <span data-ttu-id="2f04f-439">以滑鼠右鍵按一下 `ManagedDatabaseConstructs` 方案總管中的專案，然後從內容功能表中選擇 [設定為啟始專案] 選項。</span><span class="sxs-lookup"><span data-stu-id="2f04f-439">Right-click the `ManagedDatabaseConstructs` project in Solution Explorer and choose the Set as StartUp Project option from the context menu.</span></span>

<span data-ttu-id="2f04f-440">`ManagedDatabaseConstructs`從偵錯工具啟動專案時，它會執行檔案中的 SQL 語句 `Test.sql` ，該檔案位於 `Test Scripts` 資料夾中。</span><span class="sxs-lookup"><span data-stu-id="2f04f-440">When the `ManagedDatabaseConstructs` project is launched from the debugger it executes the SQL statements in the `Test.sql` file, which is located in the `Test Scripts` folder.</span></span> <span data-ttu-id="2f04f-441">例如，若要測試 `GetProductsWithPriceLessThan` managed 預存程式，請使用下列語句取代現有的檔案 `Test.sql` 內容，這會叫用 `GetProductsWithPriceLessThan` 傳入14.95 值的 managed 預存程式 `@CategoryID` ：</span><span class="sxs-lookup"><span data-stu-id="2f04f-441">For example, to test the `GetProductsWithPriceLessThan` managed stored procedure, replace the existing `Test.sql` file content with the following statement, which invokes the `GetProductsWithPriceLessThan` managed stored procedure passing in the `@CategoryID` value of 14.95:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample16.sql)]

<span data-ttu-id="2f04f-442">當您輸入上述腳本之後 `Test.sql` ，請前往 [偵錯工具] 功能表並選擇 [開始偵錯工具]，或按下工具列中的 F5 或綠色播放圖示來開始偵錯工具。</span><span class="sxs-lookup"><span data-stu-id="2f04f-442">Once you ve entered the above script into `Test.sql`, start debugging by going to the Debug menu and choosing Start Debugging or by hitting F5 or the green play icon in the Toolbar.</span></span> <span data-ttu-id="2f04f-443">這將會在方案中建立專案、將 managed 資料庫物件部署至 Northwind 資料庫，然後執行 `Test.sql` 腳本。</span><span class="sxs-lookup"><span data-stu-id="2f04f-443">This will build the projects within the Solution, deploy the managed database objects to the Northwind database, and then execute the `Test.sql` script.</span></span> <span data-ttu-id="2f04f-444">此時，將會叫用中斷點，而我們可以逐步執行 `GetProductsWithPriceLessThan` 方法，檢查輸入參數的值等等。</span><span class="sxs-lookup"><span data-stu-id="2f04f-444">At this point, the breakpoint will be hit and we can step through the `GetProductsWithPriceLessThan` method, examine the values of the input parameters, and so on.</span></span>

<span data-ttu-id="2f04f-445">[![遇到 GetProductsWithPriceLessThan 方法中的中斷點](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image67.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image66.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-445">[![The Breakpoint in the GetProductsWithPriceLessThan Method Was Hit](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image67.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image66.png)</span></span>

<span data-ttu-id="2f04f-446">**圖 28**：點擊方法中的中斷點 `GetProductsWithPriceLessThan` ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image68.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-446">**Figure 28**: The Breakpoint in the `GetProductsWithPriceLessThan` Method Was Hit ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image68.png))</span></span>

<span data-ttu-id="2f04f-447">為了讓 SQL database 物件可以透過用戶端應用程式進行調試，必須將資料庫設定為支援應用程式的偵錯工具。</span><span class="sxs-lookup"><span data-stu-id="2f04f-447">In order for a SQL database object to be debugged through a client application, it is imperative that the database be configured to support application debugging.</span></span> <span data-ttu-id="2f04f-448">以滑鼠右鍵按一下伺服器總管中的資料庫，並確定已核取 [應用程式偵錯工具] 選項。</span><span class="sxs-lookup"><span data-stu-id="2f04f-448">Right-click on the database in Server Explorer and ensure that the Application Debugging option is checked.</span></span> <span data-ttu-id="2f04f-449">此外，我們還需要將 ASP.NET 應用程式設定為與 SQL 偵錯工具整合，並停用連接共用。</span><span class="sxs-lookup"><span data-stu-id="2f04f-449">Furthermore, we need to configure the ASP.NET application to integrate with the SQL Debugger and to disable connection pooling.</span></span> <span data-ttu-id="2f04f-450">這些步驟已在 [調試預存程式](debugging-stored-procedures-cs.md) 教學課程的步驟2中詳細討論。</span><span class="sxs-lookup"><span data-stu-id="2f04f-450">These steps were discussed in detail in Step 2 of the [Debugging Stored Procedures](debugging-stored-procedures-cs.md) tutorial.</span></span>

<span data-ttu-id="2f04f-451">設定 ASP.NET 應用程式和資料庫之後，請將 ASP.NET 網站設定為啟始專案，並開始進行偵錯工具。</span><span class="sxs-lookup"><span data-stu-id="2f04f-451">Once you have configured the ASP.NET application and database, set the ASP.NET website as the startup project and start debugging.</span></span> <span data-ttu-id="2f04f-452">如果您造訪的頁面會呼叫其中一個具有中斷點的 managed 物件，應用程式將會停止，並將控制權轉換到偵錯工具，您可以在這裡逐步執行程式碼，如圖28所示。</span><span class="sxs-lookup"><span data-stu-id="2f04f-452">If you visit a page that calls one of the managed objects that has a breakpoint, the application will halt and control will be turned over to the debugger, where you can step through the code as shown in Figure 28.</span></span>

## <a name="step-13-manually-compiling-and-deploying-managed-database-objects"></a><span data-ttu-id="2f04f-453">步驟13：手動編譯和部署 Managed 資料庫物件</span><span class="sxs-lookup"><span data-stu-id="2f04f-453">Step 13: Manually Compiling and Deploying Managed Database Objects</span></span>

<span data-ttu-id="2f04f-454">SQL Server 專案可讓您輕鬆地建立、編譯和部署 managed 資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-454">SQL Server Projects make it easy to create, compile, and deploy managed database objects.</span></span> <span data-ttu-id="2f04f-455">可惜的是，SQL Server 專案只在 Visual Studio 的 Professional 和 Team Systems 版本中提供。</span><span class="sxs-lookup"><span data-stu-id="2f04f-455">Unfortunately, SQL Server Projects are only available in the Professional and Team Systems editions of Visual Studio.</span></span> <span data-ttu-id="2f04f-456">如果您使用的是 Visual Web Developer 或 Standard Edition 的 Visual Studio，而且想要使用受管理的資料庫物件，您必須手動建立並部署它們。</span><span class="sxs-lookup"><span data-stu-id="2f04f-456">If you are using Visual Web Developer or the Standard Edition of Visual Studio and want to use managed database objects, you will need to manually create and deploy them.</span></span> <span data-ttu-id="2f04f-457">這包含四個步驟：</span><span class="sxs-lookup"><span data-stu-id="2f04f-457">This involves four steps:</span></span>

1. <span data-ttu-id="2f04f-458">建立檔案，其中包含 managed 資料庫物件的原始程式碼。</span><span class="sxs-lookup"><span data-stu-id="2f04f-458">Create a file that contains the source code for the managed database object,</span></span>
2. <span data-ttu-id="2f04f-459">將物件編譯成元件，</span><span class="sxs-lookup"><span data-stu-id="2f04f-459">Compile the object into an assembly,</span></span>
3. <span data-ttu-id="2f04f-460">向 SQL Server 2005 資料庫註冊元件，並</span><span class="sxs-lookup"><span data-stu-id="2f04f-460">Register the assembly with the SQL Server 2005 database, and</span></span>
4. <span data-ttu-id="2f04f-461">在 SQL Server 中建立資料庫物件，以指向元件中的適當方法。</span><span class="sxs-lookup"><span data-stu-id="2f04f-461">Create a database object in SQL Server that points to the appropriate method in the assembly.</span></span>

<span data-ttu-id="2f04f-462">為了說明這些工作，讓我們建立一個新的 managed 預存程式，以傳回其 `UnitPrice` 大於指定值的產品。</span><span class="sxs-lookup"><span data-stu-id="2f04f-462">To illustrate these tasks, let s create a new managed stored procedure that returns those products whose `UnitPrice` is greater than a specified value.</span></span> <span data-ttu-id="2f04f-463">在您的電腦上建立名為的新檔案 `GetProductsWithPriceGreaterThan.cs` ，並在檔案中輸入下列程式碼 (您可以使用 Visual Studio、記事本或任何文字編輯器來完成這項) ：</span><span class="sxs-lookup"><span data-stu-id="2f04f-463">Create a new file on your computer named `GetProductsWithPriceGreaterThan.cs` and enter the following code into the file (you can use Visual Studio, Notepad, or any text editor to accomplish this):</span></span>

[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample17.cs)]

<span data-ttu-id="2f04f-464">這段程式碼與 `GetProductsWithPriceLessThan` 在步驟5中建立的方法幾乎完全相同。</span><span class="sxs-lookup"><span data-stu-id="2f04f-464">This code is nearly identical to that of the `GetProductsWithPriceLessThan` method created in Step 5.</span></span> <span data-ttu-id="2f04f-465">唯一的差異在於查詢中所使用的方法名稱、 `WHERE` 子句和參數名稱。</span><span class="sxs-lookup"><span data-stu-id="2f04f-465">The only differences are the method names, the `WHERE` clause, and the parameter name used in the query.</span></span> <span data-ttu-id="2f04f-466">回到 `GetProductsWithPriceLessThan` 方法， `WHERE` 子句 read： `WHERE UnitPrice < @MaxPrice` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-466">Back in the `GetProductsWithPriceLessThan` method, the `WHERE` clause read: `WHERE UnitPrice < @MaxPrice`.</span></span> <span data-ttu-id="2f04f-467">在這裡， `GetProductsWithPriceGreaterThan` 我們會使用： `WHERE UnitPrice > @MinPrice` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-467">Here, in `GetProductsWithPriceGreaterThan`, we use: `WHERE UnitPrice > @MinPrice` .</span></span>

<span data-ttu-id="2f04f-468">我們現在需要將此類別編譯為元件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-468">We now need to compile this class into an assembly.</span></span> <span data-ttu-id="2f04f-469">從命令列，流覽至您儲存檔案的目錄， `GetProductsWithPriceGreaterThan.cs` 並使用 c # 編譯器 (`csc.exe`) 將類別檔案編譯成元件：</span><span class="sxs-lookup"><span data-stu-id="2f04f-469">From the command line, navigate to the directory where you saved the `GetProductsWithPriceGreaterThan.cs` file and use the C# compiler (`csc.exe`) to compile the class file into an assembly:</span></span>

[!code-console[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample18.cmd)]

<span data-ttu-id="2f04f-470">如果 `csc.exe` 不在系統中的資料夾包含 `PATH` ，您將必須完整參考其路徑， `%WINDOWS%\Microsoft.NET\Framework\version\` 如下所示：</span><span class="sxs-lookup"><span data-stu-id="2f04f-470">If the folder containing `csc.exe` in not in the system s `PATH`, you will have to fully reference its path, `%WINDOWS%\Microsoft.NET\Framework\version\`, like so:</span></span>

[!code-console[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample19.cmd)]

<span data-ttu-id="2f04f-471">[![將 GetProductsWithPriceGreaterThan.cs 編譯成元件](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image70.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image69.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-471">[![Compile GetProductsWithPriceGreaterThan.cs Into an Assembly](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image70.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image69.png)</span></span>

<span data-ttu-id="2f04f-472">**圖 29**：編譯 `GetProductsWithPriceGreaterThan.cs` 成元件 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image71.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-472">**Figure 29**: Compile `GetProductsWithPriceGreaterThan.cs` Into an Assembly ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image71.png))</span></span>

<span data-ttu-id="2f04f-473">旗標會 `/t` 指定應該將 c # 類別檔案編譯成 DLL (而不是可執行檔) 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-473">The `/t` flag specifies that the C# class file should be compiled into a DLL (rather than an executable).</span></span> <span data-ttu-id="2f04f-474">旗標會 `/out` 指定產生的元件名稱。</span><span class="sxs-lookup"><span data-stu-id="2f04f-474">The `/out` flag specifies the name of the resulting assembly.</span></span>

> [!NOTE]
> <span data-ttu-id="2f04f-475">`GetProductsWithPriceGreaterThan.cs`您也可以使用[Visual c # Express edition](https://msdn.microsoft.com/vstudio/express/visualcsharp/)或在 Visual Studio Standard Edition 中建立個別的類別庫專案，而不是從命令列編譯類別檔案。</span><span class="sxs-lookup"><span data-stu-id="2f04f-475">Rather than compiling the `GetProductsWithPriceGreaterThan.cs` class file from the command line you could alternatively use [Visual C# Express Edition](https://msdn.microsoft.com/vstudio/express/visualcsharp/) or create a separate Class Library project in Visual Studio Standard Edition.</span></span> <span data-ttu-id="2f04f-476">S Jacob Lauritsen 已提供這類 Visual c # Express Edition 專案，其中包含 `GetProductsWithPriceGreaterThan` 預存程式的程式碼，以及在步驟3、5和10中建立的兩個 managed 預存程式和 UDF。</span><span class="sxs-lookup"><span data-stu-id="2f04f-476">S ren Jacob Lauritsen has kindly provided such a Visual C# Express Edition project with code for the `GetProductsWithPriceGreaterThan` stored procedure and the two managed stored procedures and UDF created in Steps 3, 5, and 10.</span></span> <span data-ttu-id="2f04f-477">S $ s 專案也包含加入對應的資料庫物件所需的 T-sql 命令。</span><span class="sxs-lookup"><span data-stu-id="2f04f-477">S ren s project also includes the T-SQL commands needed to add the corresponding database objects.</span></span>

<span data-ttu-id="2f04f-478">將程式碼編譯為元件之後，我們就可以在 SQL Server 2005 資料庫內註冊元件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-478">With the code compiled into an assembly, we are ready to register the assembly within the SQL Server 2005 database.</span></span> <span data-ttu-id="2f04f-479">您可以透過 T-sql、使用命令或 SQL Server Management Studio 來執行此作業 `CREATE ASSEMBLY` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-479">This can be performed through T-SQL, using the command `CREATE ASSEMBLY`, or through SQL Server Management Studio.</span></span> <span data-ttu-id="2f04f-480">讓我們將焦點放在使用 Management Studio。</span><span class="sxs-lookup"><span data-stu-id="2f04f-480">Let s focus on using Management Studio.</span></span>

<span data-ttu-id="2f04f-481">從 Management Studio 中，展開 Northwind 資料庫中的 [可程式性] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="2f04f-481">From Management Studio, expand the Programmability folder in the Northwind database.</span></span> <span data-ttu-id="2f04f-482">其中一個子資料夾是元件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-482">One of its subfolder is Assemblies.</span></span> <span data-ttu-id="2f04f-483">若要以手動方式將新元件加入至資料庫，請以滑鼠右鍵按一下 [元件] 資料夾，然後從內容功能表選擇 [新增元件]。</span><span class="sxs-lookup"><span data-stu-id="2f04f-483">To manually add a new Assembly to the database, right-click on the Assemblies folder and choose New Assembly from the context menu.</span></span> <span data-ttu-id="2f04f-484">這會顯示 [新增元件] 對話方塊 (請參閱圖 30) 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-484">This displays the New Assembly dialog box (see Figure 30).</span></span> <span data-ttu-id="2f04f-485">按一下 [流覽] 按鈕，選取 `ManuallyCreatedDBObjects.dll` 我們剛剛編譯的元件，然後按一下 [確定]，將元件加入至資料庫。</span><span class="sxs-lookup"><span data-stu-id="2f04f-485">Click on the Browse button, select the `ManuallyCreatedDBObjects.dll` assembly we just compiled, and then click OK to add the Assembly to the database.</span></span> <span data-ttu-id="2f04f-486">您 `ManuallyCreatedDBObjects.dll` 在物件總管中看不到元件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-486">You should not see the `ManuallyCreatedDBObjects.dll` assembly in the Object Explorer.</span></span>

<span data-ttu-id="2f04f-487">[![將 ManuallyCreatedDBObjects.dll 元件新增至資料庫](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image73.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image72.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-487">[![Add the ManuallyCreatedDBObjects.dll Assembly to the Database](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image73.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image72.png)</span></span>

<span data-ttu-id="2f04f-488">**圖 30**：將 `ManuallyCreatedDBObjects.dll` 元件新增至資料庫 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image74.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-488">**Figure 30**: Add the `ManuallyCreatedDBObjects.dll` Assembly to the Database ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image74.png))</span></span>

![ManuallyCreatedDBObjects.dll 列在物件總管](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image75.png)

<span data-ttu-id="2f04f-490">**圖 31**： `ManuallyCreatedDBObjects.dll` 列示于物件總管</span><span class="sxs-lookup"><span data-stu-id="2f04f-490">**Figure 31**: The `ManuallyCreatedDBObjects.dll` is Listed in the Object Explorer</span></span>

<span data-ttu-id="2f04f-491">雖然我們已將元件新增至 Northwind 資料庫，但我們尚未將預存程式與 `GetProductsWithPriceGreaterThan` 元件中的方法產生關聯。</span><span class="sxs-lookup"><span data-stu-id="2f04f-491">While we have added the assembly to the Northwind database, we have yet to associate a stored procedure with the `GetProductsWithPriceGreaterThan` method in the assembly.</span></span> <span data-ttu-id="2f04f-492">若要完成此動作，請開啟新的查詢視窗，然後執行下列腳本：</span><span class="sxs-lookup"><span data-stu-id="2f04f-492">To accomplish this, open a new query window and execute the following script:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample20.sql)]

<span data-ttu-id="2f04f-493">這會在名為的 Northwind 資料庫中建立新的預存程式 `GetProductsWithPriceGreaterThan` ，並將它與類別中的 managed 方法 (（位於 `GetProductsWithPriceGreaterThan` `StoredProcedures` 元件) 中）相關聯 `ManuallyCreatedDBObjects` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-493">This creates a new stored procedure in the Northwind database named `GetProductsWithPriceGreaterThan` and associates it with the managed method `GetProductsWithPriceGreaterThan` (which is in the class `StoredProcedures`, which is in the assembly `ManuallyCreatedDBObjects`).</span></span>

<span data-ttu-id="2f04f-494">執行上述腳本之後，請重新整理物件總管中的 [預存程式] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="2f04f-494">After executing the above script, refresh the Stored Procedures folder in the Object Explorer.</span></span> <span data-ttu-id="2f04f-495">您應該會看到新的預存程式專案，其 `GetProductsWithPriceGreaterThan` 旁邊有鎖定圖示。</span><span class="sxs-lookup"><span data-stu-id="2f04f-495">You should see a new stored procedure entry - `GetProductsWithPriceGreaterThan` - which has a lock icon next to it.</span></span> <span data-ttu-id="2f04f-496">若要測試此預存程式，請在查詢視窗中輸入並執行下列腳本：</span><span class="sxs-lookup"><span data-stu-id="2f04f-496">To test this stored procedure, enter and execute the following script in the query window:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample21.sql)]

<span data-ttu-id="2f04f-497">如圖32所示，上述命令會顯示大於 $24.95 之產品的資訊 `UnitPrice` 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-497">As Figure 32 shows, the above command displays information for those products with a `UnitPrice` greater than $24.95.</span></span>

<span data-ttu-id="2f04f-498">[![ManuallyCreatedDBObjects.dll 列在物件總管](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image77.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image76.png)</span><span class="sxs-lookup"><span data-stu-id="2f04f-498">[![The ManuallyCreatedDBObjects.dll is Listed in the Object Explorer](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image77.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image76.png)</span></span>

<span data-ttu-id="2f04f-499">**圖 32**： `ManuallyCreatedDBObjects.dll` 物件總管 ([按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image78.png)) </span><span class="sxs-lookup"><span data-stu-id="2f04f-499">**Figure 32**: The `ManuallyCreatedDBObjects.dll` is Listed in the Object Explorer ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image78.png))</span></span>

## <a name="summary"></a><span data-ttu-id="2f04f-500">摘要</span><span class="sxs-lookup"><span data-stu-id="2f04f-500">Summary</span></span>

<span data-ttu-id="2f04f-501">Microsoft SQL Server 2005 提供與 Common Language Runtime (CLR) 的整合，可讓您使用 managed 程式碼來建立資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-501">Microsoft SQL Server 2005 provides integration with the Common Language Runtime (CLR), which allows database objects to be created using managed code.</span></span> <span data-ttu-id="2f04f-502">之前，這些資料庫物件只能使用 T-sql 建立，但現在我們可以使用 c # 之類的 .NET 程式設計語言來建立這些物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-502">Previously, these database objects could only be created using T-SQL, but now we can create these objects using .NET programming languages like C#.</span></span> <span data-ttu-id="2f04f-503">在本教學課程中，我們建立了兩個 managed 預存程式和一個受管理的使用者定義函數。</span><span class="sxs-lookup"><span data-stu-id="2f04f-503">In this tutorial we created two managed stored procedures and a managed User-Defined Function.</span></span>

<span data-ttu-id="2f04f-504">Visual Studio 的 SQL Server 專案類型有助於建立、編譯和部署 managed 資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-504">Visual Studio s SQL Server Project type facilitates creating, compiling, and deploying managed database objects.</span></span> <span data-ttu-id="2f04f-505">此外，它還提供豐富的調試支援。</span><span class="sxs-lookup"><span data-stu-id="2f04f-505">Moreover, it offers rich debugging support.</span></span> <span data-ttu-id="2f04f-506">不過，SQL Server 的專案類型只適用于 Visual Studio 的 Professional 和 Team Systems 版。</span><span class="sxs-lookup"><span data-stu-id="2f04f-506">However, SQL Server Project types are only available in the Professional and Team Systems editions of Visual Studio.</span></span> <span data-ttu-id="2f04f-507">若使用 Visual Web Developer 或 Standard Edition 的 Visual Studio，就必須手動執行建立、編譯和部署步驟，如我們在步驟13中所見。</span><span class="sxs-lookup"><span data-stu-id="2f04f-507">For those using Visual Web Developer or the Standard Edition of Visual Studio, the creation, compilation, and deployment steps must be performed manually, as we saw in Step 13.</span></span>

<span data-ttu-id="2f04f-508">快樂程式設計！</span><span class="sxs-lookup"><span data-stu-id="2f04f-508">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="2f04f-509">深入閱讀</span><span class="sxs-lookup"><span data-stu-id="2f04f-509">Further Reading</span></span>

<span data-ttu-id="2f04f-510">如需本教學課程中所討論之主題的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="2f04f-510">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="2f04f-511">使用者定義函數的優點和缺點</span><span class="sxs-lookup"><span data-stu-id="2f04f-511">Advantages and Drawbacks of User-Defined Functions</span></span>](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1)
- [<span data-ttu-id="2f04f-512">在 Managed 程式碼中建立 SQL Server 2005 物件</span><span class="sxs-lookup"><span data-stu-id="2f04f-512">Creating SQL Server 2005 Objects in Managed Code</span></span>](https://channel9.msdn.com/Showpost.aspx?postid=142413)
- [<span data-ttu-id="2f04f-513">使用 SQL Server 2005 中的 Managed 程式碼建立觸發程式</span><span class="sxs-lookup"><span data-stu-id="2f04f-513">Creating Triggers Using Managed Code in SQL Server 2005</span></span>](http://www.15seconds.com/issue/041006.htm)
- <span data-ttu-id="2f04f-514">[如何：建立和執行 CLR SQL Server 預存程式](https://msdn.microsoft.com/library/5czye81z(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2f04f-514">[How To: Create and Run a CLR SQL Server Stored Procedure](https://msdn.microsoft.com/library/5czye81z(VS.80).aspx)</span></span>
- <span data-ttu-id="2f04f-515">[如何：建立和執行 CLR SQL Server 使用者定義函數](https://msdn.microsoft.com/library/w2kae45k(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2f04f-515">[How To: Create and Run a CLR SQL Server User-Defined Function](https://msdn.microsoft.com/library/w2kae45k(VS.80).aspx)</span></span>
- <span data-ttu-id="2f04f-516">[如何：編輯 `Test.sql` 腳本以執行 SQL 物件](https://msdn.microsoft.com/library/ms233682(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2f04f-516">[How To: Edit the `Test.sql` Script to Run SQL Objects](https://msdn.microsoft.com/library/ms233682(VS.80).aspx)</span></span>
- [<span data-ttu-id="2f04f-517">使用者定義函數簡介</span><span class="sxs-lookup"><span data-stu-id="2f04f-517">Intro to User Defined Functions</span></span>](http://www.sqlteam.com/item.asp?ItemID=1955)
- [<span data-ttu-id="2f04f-518">Managed 程式碼和 SQL Server 2005 (影片) </span><span class="sxs-lookup"><span data-stu-id="2f04f-518">Managed Code and SQL Server 2005 (Video)</span></span>](https://channel9.msdn.com/Showpost.aspx?postid=142413)
- <span data-ttu-id="2f04f-519">[Transact-SQL 參考](https://msdn.microsoft.com/library/aa299742(SQL.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2f04f-519">[Transact-SQL Reference](https://msdn.microsoft.com/library/aa299742(SQL.80).aspx)</span></span>
- <span data-ttu-id="2f04f-520">[逐步解說：在 Managed 程式碼中建立預存程式](https://msdn.microsoft.com/library/zxsa8hkf(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="2f04f-520">[Walkthrough: Creating a Stored Procedure in Managed Code](https://msdn.microsoft.com/library/zxsa8hkf(VS.80).aspx)</span></span>

## <a name="about-the-author"></a><span data-ttu-id="2f04f-521">關於作者</span><span class="sxs-lookup"><span data-stu-id="2f04f-521">About the Author</span></span>

<span data-ttu-id="2f04f-522">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，作者是七個 ASP/ASP. NET 書籍和創辦人 of [4GuysFromRolla.com](http://www.4guysfromrolla.com)，自1998起一直都在使用 Microsoft Web 技術。</span><span class="sxs-lookup"><span data-stu-id="2f04f-522">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="2f04f-523">Scott 以獨立顧問、訓練員和作者的形式運作。</span><span class="sxs-lookup"><span data-stu-id="2f04f-523">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="2f04f-524">他的最新書籍是 [*在24小時內 ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="2f04f-524">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="2f04f-525">您可以在此聯繫[ mitchell@4GuysFromRolla.com 。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="2f04f-525">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="2f04f-526">或者透過他的 blog （可在中找到） [http://ScottOnWriting.NET](http://ScottOnWriting.NET) 。</span><span class="sxs-lookup"><span data-stu-id="2f04f-526">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="2f04f-527">特別感謝</span><span class="sxs-lookup"><span data-stu-id="2f04f-527">Special Thanks To</span></span>

<span data-ttu-id="2f04f-528">本教學課程系列是由許多有用的審核者所審核。</span><span class="sxs-lookup"><span data-stu-id="2f04f-528">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="2f04f-529">本教學課程的潛在客戶審核者為 < ren Jacob Lauritsen。</span><span class="sxs-lookup"><span data-stu-id="2f04f-529">Lead reviewer for this tutorial was S ren Jacob Lauritsen.</span></span> <span data-ttu-id="2f04f-530">除了複習本文之外，也建立了本文中的 Visual c # Express Edition 專案，以手動編譯 managed 資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="2f04f-530">In addition to reviewing this article, S ren also created the Visual C# Express Edition project included in this article s download for manually compiling the managed database objects.</span></span> <span data-ttu-id="2f04f-531">有興趣複習我即將推出的 MSDN 文章嗎？</span><span class="sxs-lookup"><span data-stu-id="2f04f-531">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="2f04f-532">如果是的話，請在這裡放置一行[ mitchell@4GuysFromRolla.com 。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="2f04f-532">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="2f04f-533">[上一個](debugging-stored-procedures-cs.md) 
> [下一步](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md)</span><span class="sxs-lookup"><span data-stu-id="2f04f-533">[Previous](debugging-stored-procedures-cs.md)
[Next](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md)</span></span>
