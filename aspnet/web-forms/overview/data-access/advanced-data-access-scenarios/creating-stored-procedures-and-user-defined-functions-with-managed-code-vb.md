---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/creating-stored-procedures-and-user-defined-functions-with-managed-code-vb
title: 使用受控碼建立預存程式和使用者定義函式（VB） |Microsoft Docs
author: rick-anderson
description: Microsoft SQL Server 2005 與 .NET Common Language Runtime 整合，可讓開發人員透過 managed 程式碼建立資料庫物件。 本教學課程 。
ms.author: riande
ms.date: 08/03/2007
ms.assetid: 8be9a51b-ea6b-46c7-bfa2-476d9b14c24c
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/creating-stored-procedures-and-user-defined-functions-with-managed-code-vb
msc.type: authoredcontent
ms.openlocfilehash: 0ac5f71d519689a9dc84fb82a04196d520cca6e1
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78551300"
---
# <a name="creating-stored-procedures-and-user-defined-functions-with-managed-code-vb"></a><span data-ttu-id="fe219-104">使用受控碼建立預存程序和使用者定義函式 (VB)</span><span class="sxs-lookup"><span data-stu-id="fe219-104">Creating Stored Procedures and User-Defined Functions with Managed Code (VB)</span></span>

<span data-ttu-id="fe219-105">由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="fe219-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="fe219-106">[下載程式代碼](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_75_VB.zip)或[下載 PDF](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/datatutorial75vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="fe219-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_75_VB.zip) or [Download PDF](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/datatutorial75vb1.pdf)</span></span>

> <span data-ttu-id="fe219-107">Microsoft SQL Server 2005 與 .NET Common Language Runtime 整合，可讓開發人員透過 managed 程式碼建立資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-107">Microsoft SQL Server 2005 integrates with the .NET Common Language Runtime to allow developers to create database objects through managed code.</span></span> <span data-ttu-id="fe219-108">本教學課程示範如何使用您的 Visual Basic 或C#程式碼，建立 managed 預存程式和受管理的使用者定義函數。</span><span class="sxs-lookup"><span data-stu-id="fe219-108">This tutorial shows how to create managed stored procedures and managed user-defined functions with your Visual Basic or C# code.</span></span> <span data-ttu-id="fe219-109">我們也會看到這些版本的 Visual Studio 如何讓您進行這類的 managed 資料庫物件的調試。</span><span class="sxs-lookup"><span data-stu-id="fe219-109">We also see how these editions of Visual Studio allow you to debug such managed database objects.</span></span>

## <a name="introduction"></a><span data-ttu-id="fe219-110">簡介</span><span class="sxs-lookup"><span data-stu-id="fe219-110">Introduction</span></span>

<span data-ttu-id="fe219-111">Microsoft SQL Server 2005 這類資料庫使用[結構化查詢語言 (SQL) transact-sql](http://en.wikipedia.org/wiki/Transact-SQL)來插入、修改和抓取資料。</span><span class="sxs-lookup"><span data-stu-id="fe219-111">Databases like Microsoft s SQL Server 2005 use the [Transact-Structured Query Language (T-SQL)](http://en.wikipedia.org/wiki/Transact-SQL) for inserting, modifying, and retrieving data.</span></span> <span data-ttu-id="fe219-112">大部分的資料庫系統都包含組成一系列 SQL 語句的結構，這些語句可以做為單一、可重複使用的單位來執行。</span><span class="sxs-lookup"><span data-stu-id="fe219-112">Most database systems include constructs for grouping a series of SQL statements that can then be executed as a single, reusable unit.</span></span> <span data-ttu-id="fe219-113">預存程式是其中一個範例。</span><span class="sxs-lookup"><span data-stu-id="fe219-113">Stored procedures are one example.</span></span> <span data-ttu-id="fe219-114">另一個是*使用者定義函數*（udf），這是我們將在步驟9中更詳細地檢查的結構。</span><span class="sxs-lookup"><span data-stu-id="fe219-114">Another is *User-Defined Functions*(UDFs), a construct that we will examine in greater detail in Step 9.</span></span>

<span data-ttu-id="fe219-115">就核心而言，SQL 是針對使用資料集而設計的。</span><span class="sxs-lookup"><span data-stu-id="fe219-115">At its core, SQL is designed for working with sets of data.</span></span> <span data-ttu-id="fe219-116">`SELECT`、`UPDATE`和 `DELETE` 語句原本就適用于對應資料表中的所有記錄，而且只受其 `WHERE` 子句的限制。</span><span class="sxs-lookup"><span data-stu-id="fe219-116">The `SELECT`, `UPDATE`, and `DELETE` statements inherently apply to all records in the corresponding table and are only limited by their `WHERE` clauses.</span></span> <span data-ttu-id="fe219-117">但有許多語言功能是設計用來一次處理一筆記錄，以及用來操作純量資料。</span><span class="sxs-lookup"><span data-stu-id="fe219-117">Yet there are many language features designed for working with one record at a time and for manipulating scalar data.</span></span> <span data-ttu-id="fe219-118">[`CURSOR` s](http://www.sqlteam.com/item.asp?ItemID=553)允許一組記錄一次迴圈一筆。</span><span class="sxs-lookup"><span data-stu-id="fe219-118">[`CURSOR` s](http://www.sqlteam.com/item.asp?ItemID=553) allow for a set of records to be looped through one at a time.</span></span> <span data-ttu-id="fe219-119">`LEFT`、`CHARINDEX`和 `PATINDEX` 等字串操作函式可處理純量資料。</span><span class="sxs-lookup"><span data-stu-id="fe219-119">String manipulation functions like `LEFT`, `CHARINDEX`, and `PATINDEX` work with scalar data.</span></span> <span data-ttu-id="fe219-120">SQL 也包含控制流程語句，例如 `IF` 和 `WHILE`。</span><span class="sxs-lookup"><span data-stu-id="fe219-120">SQL also includes control flow statements like `IF` and `WHILE`.</span></span>

<span data-ttu-id="fe219-121">在 Microsoft SQL Server 2005 之前，預存程式和 Udf 只能定義為 T-sql 語句的集合。</span><span class="sxs-lookup"><span data-stu-id="fe219-121">Prior to Microsoft SQL Server 2005, stored procedures and UDFs could only be defined as a collection of T-SQL statements.</span></span> <span data-ttu-id="fe219-122">不過，SQL Server 2005 是設計用來提供與[Common Language Runtime （CLR）](https://msdn.microsoft.com/netframework/aa497266.aspx)的整合，這是所有 .net 元件所使用的執行時間。</span><span class="sxs-lookup"><span data-stu-id="fe219-122">SQL Server 2005, however, was designed to provide integration with the [Common Language Runtime (CLR)](https://msdn.microsoft.com/netframework/aa497266.aspx), which is the runtime used by all .NET assemblies.</span></span> <span data-ttu-id="fe219-123">因此，可以使用 managed 程式碼來建立 SQL Server 2005 資料庫中的預存程式和 Udf。</span><span class="sxs-lookup"><span data-stu-id="fe219-123">Consequently, the stored procedures and UDFs in a SQL Server 2005 database can be created using managed code.</span></span> <span data-ttu-id="fe219-124">也就是說，您可以建立預存程式或 UDF，做為 Visual Basic 類別中的方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-124">That is, you can create a stored procedure or UDF as a method in a Visual Basic class.</span></span> <span data-ttu-id="fe219-125">這可讓這些預存程式和 Udf 利用 .NET Framework 中的功能，以及自訂的類別。</span><span class="sxs-lookup"><span data-stu-id="fe219-125">This enables these stored procedures and UDFs to utilize functionality in the .NET Framework and from your own custom classes.</span></span>

<span data-ttu-id="fe219-126">在本教學課程中，我們將探討如何建立 managed 預存程式和使用者定義函數，以及如何將它們整合到 Northwind 資料庫中。</span><span class="sxs-lookup"><span data-stu-id="fe219-126">In this tutorial we will examine how to create managed stored procedures and User-Defined Functions and how to integrate them into our Northwind database.</span></span> <span data-ttu-id="fe219-127">讓我們開始吧！</span><span class="sxs-lookup"><span data-stu-id="fe219-127">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="fe219-128">受管理的資料庫物件在 SQL 對應專案方面提供了一些優點。</span><span class="sxs-lookup"><span data-stu-id="fe219-128">Managed database objects offer some advantages over their SQL counterparts.</span></span> <span data-ttu-id="fe219-129">語言豐富、熟悉，以及重複使用現有程式碼和邏輯的能力，都是主要的優點。</span><span class="sxs-lookup"><span data-stu-id="fe219-129">Language richness and familiarity and the ability to reuse existing code and logic are the main advantages.</span></span> <span data-ttu-id="fe219-130">但是，當使用的資料集不牽涉到許多程式邏輯時，managed 資料庫物件的效率可能較低。</span><span class="sxs-lookup"><span data-stu-id="fe219-130">But managed database objects are likely to be less efficient when working with sets of data that do not involve much procedural logic.</span></span> <span data-ttu-id="fe219-131">如需使用 managed 程式碼與 T-sql 之優點的詳細討論，請參閱[使用 managed 程式碼建立資料庫物件的優點](https://msdn.microsoft.com/library/k2e1fb36(VS.80).aspx)。</span><span class="sxs-lookup"><span data-stu-id="fe219-131">For a more thorough discussion on the advantages of using managed code versus T-SQL, check out the [Advantages of Using Managed Code to Create Database Objects](https://msdn.microsoft.com/library/k2e1fb36(VS.80).aspx).</span></span>

## <a name="step-1-moving-the-northwind-database-out-ofapp_data"></a><span data-ttu-id="fe219-132">步驟1：將 Northwind 資料庫移出`App_Data`</span><span class="sxs-lookup"><span data-stu-id="fe219-132">Step 1: Moving the Northwind Database Out of`App_Data`</span></span>

<span data-ttu-id="fe219-133">到目前為止，我們所有的教學課程都已使用 web 應用程式 `App_Data` 資料夾中的 Microsoft SQL Server 2005 Express Edition 資料庫檔案。</span><span class="sxs-lookup"><span data-stu-id="fe219-133">All of our tutorials thus far have used a Microsoft SQL Server 2005 Express Edition database file in the web application s `App_Data` folder.</span></span> <span data-ttu-id="fe219-134">將資料庫放在 `App_Data` 簡化散發和執行這些教學課程，因為所有檔案都位於一個目錄中，而且不需要額外的設定步驟來測試教學課程。</span><span class="sxs-lookup"><span data-stu-id="fe219-134">Placing the database in `App_Data` simplified distributing and running these tutorials as all of the files were located within one directory and required no additional configuration steps to test the tutorial.</span></span>

<span data-ttu-id="fe219-135">不過，在本教學課程中，我們會將 Northwind 資料庫移出 `App_Data`，並明確地向 SQL Server 2005 Express Edition 資料庫實例註冊它。</span><span class="sxs-lookup"><span data-stu-id="fe219-135">For this tutorial, however, let s move the Northwind database out of `App_Data` and explicitly register it with the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="fe219-136">雖然我們可以使用 `App_Data` 資料夾中的資料庫來執行本教學課程的步驟，但透過 SQL Server 2005 Express Edition 資料庫實例明確註冊資料庫，有幾個步驟會變得更簡單。</span><span class="sxs-lookup"><span data-stu-id="fe219-136">While we can perform the steps for this tutorial with the database in the `App_Data` folder, a number of the steps are made much simpler by explicitly registering the database with the SQL Server 2005 Express Edition database instance.</span></span>

<span data-ttu-id="fe219-137">本教學課程的下載包含兩個資料庫檔案-`NORTHWND.MDF`，並 `NORTHWND_log.LDF` 放在名為 `DataFiles`的資料夾中。</span><span class="sxs-lookup"><span data-stu-id="fe219-137">The download for this tutorial has the two database files - `NORTHWND.MDF` and `NORTHWND_log.LDF` - placed in a folder named `DataFiles`.</span></span> <span data-ttu-id="fe219-138">如果您遵循自己的教學課程執行，請關閉 Visual Studio，並將 `NORTHWND.MDF` 和 `NORTHWND_log.LDF` 網站 `App_Data` 資料夾中的檔案移至網站以外的資料夾。</span><span class="sxs-lookup"><span data-stu-id="fe219-138">If you are following along with your own implementation of the tutorials, close Visual Studio and move the `NORTHWND.MDF` and `NORTHWND_log.LDF` files from the website s `App_Data` folder to a folder outside of the website.</span></span> <span data-ttu-id="fe219-139">資料庫檔案一旦移至另一個資料夾，就必須向 SQL Server 2005 Express Edition 資料庫實例註冊 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="fe219-139">Once the database files have been moved to another folder we need to register the Northwind database with the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="fe219-140">這可以從 SQL Server Management Studio 完成。</span><span class="sxs-lookup"><span data-stu-id="fe219-140">This can be done from SQL Server Management Studio.</span></span> <span data-ttu-id="fe219-141">如果您的電腦上已安裝非 Express Edition 的 SQL Server 2005，表示您可能已經安裝 Management Studio。</span><span class="sxs-lookup"><span data-stu-id="fe219-141">If you have a non-Express Edition of SQL Server 2005 installed on your computer then you likely already have Management Studio installed.</span></span> <span data-ttu-id="fe219-142">如果您的電腦上只有 SQL Server 2005 Express Edition，請花一點時間下載並安裝[Microsoft SQL Server Management Studio Express](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796)。</span><span class="sxs-lookup"><span data-stu-id="fe219-142">If you only have SQL Server 2005 Express Edition on your computer then take a moment to download and install [Microsoft SQL Server Management Studio Express](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="fe219-143">啟動 SQL Server Management Studio。</span><span class="sxs-lookup"><span data-stu-id="fe219-143">Launch SQL Server Management Studio.</span></span> <span data-ttu-id="fe219-144">如 [圖 1] 所示，Management Studio 一開始會詢問要連接的伺服器。</span><span class="sxs-lookup"><span data-stu-id="fe219-144">As Figure 1 shows, Management Studio starts by asking what server to connect to.</span></span> <span data-ttu-id="fe219-145">在 [伺服器名稱] 中輸入 localhost\SQLExpress，選擇 [驗證] 下拉式清單中的 [Windows 驗證]，然後按一下 [連接]。</span><span class="sxs-lookup"><span data-stu-id="fe219-145">Enter localhost\SQLExpress for the server name, choose Windows Authentication in the Authentication drop-down list, and click Connect.</span></span>

![連接到適當的資料庫實例](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image1.png)

<span data-ttu-id="fe219-147">**圖 1**：連接到適當的資料庫實例</span><span class="sxs-lookup"><span data-stu-id="fe219-147">**Figure 1**: Connect to the Appropriate Database Instance</span></span>

<span data-ttu-id="fe219-148">連接之後，[物件總管] 視窗會列出 SQL Server 2005 Express Edition 資料庫實例的相關資訊，包括資料庫、安全性資訊、管理選項等等。</span><span class="sxs-lookup"><span data-stu-id="fe219-148">Once you ve connected, the Object Explorer window will list information about the SQL Server 2005 Express Edition database instance, including its databases, security information, management options, and so forth.</span></span>

<span data-ttu-id="fe219-149">我們需要將 Northwind 資料庫附加到 `DataFiles` 資料夾中（或您可能已將它移到其中的任何位置）至 SQL Server 2005 Express Edition 資料庫實例。</span><span class="sxs-lookup"><span data-stu-id="fe219-149">We need to attach the Northwind database in the `DataFiles` folder (or wherever you may have moved it) to the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="fe219-150">以滑鼠右鍵按一下 [資料庫] 資料夾，然後從內容功能表選擇 [附加] 選項。</span><span class="sxs-lookup"><span data-stu-id="fe219-150">Right-click on the Databases folder and choose the Attach option from the context menu.</span></span> <span data-ttu-id="fe219-151">這會顯示 [附加資料庫] 對話方塊。</span><span class="sxs-lookup"><span data-stu-id="fe219-151">This will bring up the Attach Databases dialog box.</span></span> <span data-ttu-id="fe219-152">按一下 [新增] 按鈕，向下切入至適當的 `NORTHWND.MDF` 檔案，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="fe219-152">Click the Add button, drill down to the appropriate `NORTHWND.MDF` file, and click OK.</span></span> <span data-ttu-id="fe219-153">此時，您的畫面看起來應該像 [圖 2]。</span><span class="sxs-lookup"><span data-stu-id="fe219-153">At this point your screen should look similar to Figure 2.</span></span>

<span data-ttu-id="fe219-154">[![連接到適當的資料庫實例](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image3.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image2.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-154">[![Connect to the Appropriate Database Instance](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image3.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image2.png)</span></span>

<span data-ttu-id="fe219-155">**圖 2**：連接到適當的資料庫實例（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image4.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-155">**Figure 2**: Connect to the Appropriate Database Instance ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image4.png))</span></span>

> [!NOTE]
> <span data-ttu-id="fe219-156">透過連接到 SQL Server 2005 Express Edition 實例時 Management Studio [附加資料庫] 對話方塊不允許您向下切入到使用者設定檔目錄，例如 [我的文件]。</span><span class="sxs-lookup"><span data-stu-id="fe219-156">When connecting to the SQL Server 2005 Express Edition instance through Management Studio the Attach Databases dialog box does not allow you to drill down into user profile directories, such as My Documents.</span></span> <span data-ttu-id="fe219-157">因此，請務必將 `NORTHWND.MDF` 和 `NORTHWND_log.LDF` 檔案放在非使用者設定檔目錄中。</span><span class="sxs-lookup"><span data-stu-id="fe219-157">Therefore, make sure to place the `NORTHWND.MDF` and `NORTHWND_log.LDF` files in a non-user profile directory.</span></span>

<span data-ttu-id="fe219-158">按一下 [確定] 按鈕以附加資料庫。</span><span class="sxs-lookup"><span data-stu-id="fe219-158">Click the OK button to attach the database.</span></span> <span data-ttu-id="fe219-159">[附加資料庫] 對話方塊將會關閉，而物件總管現在應該會列出剛附加的資料庫。</span><span class="sxs-lookup"><span data-stu-id="fe219-159">The Attach Databases dialog box will close and the Object Explorer should now list the just-attached database.</span></span> <span data-ttu-id="fe219-160">Northwind 資料庫的名稱可能如 `9FE54661B32FDD967F51D71D0D5145CC_LINE ARTICLES\DATATUTORIALS\VOLUME 3\CSHARP\73\ASPNET_DATA_TUTORIAL_75_CS\APP_DATA\NORTHWND.MDF`。</span><span class="sxs-lookup"><span data-stu-id="fe219-160">Chances are the Northwind database has a name like `9FE54661B32FDD967F51D71D0D5145CC_LINE ARTICLES\DATATUTORIALS\VOLUME 3\CSHARP\73\ASPNET_DATA_TUTORIAL_75_CS\APP_DATA\NORTHWND.MDF`.</span></span> <span data-ttu-id="fe219-161">以滑鼠右鍵按一下資料庫，然後選擇 [重新命名]，將資料庫重新命名為 Northwind。</span><span class="sxs-lookup"><span data-stu-id="fe219-161">Rename the database to Northwind by right-clicking on the database and choosing Rename.</span></span>

![將資料庫重新命名為 Northwind](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image5.png)

<span data-ttu-id="fe219-163">**圖 3**：將資料庫重新命名為 Northwind</span><span class="sxs-lookup"><span data-stu-id="fe219-163">**Figure 3**: Rename the Database to Northwind</span></span>

## <a name="step-2-creating-a-new-solution-and-sql-server-project-in-visual-studio"></a><span data-ttu-id="fe219-164">步驟2：在 Visual Studio 中建立新的方案和 SQL Server 專案</span><span class="sxs-lookup"><span data-stu-id="fe219-164">Step 2: Creating a New Solution and SQL Server Project in Visual Studio</span></span>

<span data-ttu-id="fe219-165">為了在 SQL Server 2005 中建立 managed 預存程式或 Udf，我們會將預存程式和 UDF 邏輯撰寫為類別中 Visual Basic 程式碼。</span><span class="sxs-lookup"><span data-stu-id="fe219-165">To create managed stored procedures or UDFs in SQL Server 2005 we will write the stored procedure and UDF logic as Visual Basic code in a class.</span></span> <span data-ttu-id="fe219-166">撰寫程式碼之後，我們必須將此類別編譯成元件（`.dll` 檔案）、向 SQL Server 資料庫註冊元件，然後在資料庫中建立指向元件中對應方法的預存程式或 UDF 物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-166">Once the code has been written, we will need to compile this class into an assembly (a `.dll` file), register the assembly with the SQL Server database, and then create a stored procedure or UDF object in the database that points to the corresponding method in the assembly.</span></span> <span data-ttu-id="fe219-167">這些步驟都可以手動執行。</span><span class="sxs-lookup"><span data-stu-id="fe219-167">These steps can all be performed manually.</span></span> <span data-ttu-id="fe219-168">我們可以在任何文字編輯器中建立程式碼、使用 Visual Basic 編譯器（`vbc.exe`）從命令列進行編譯、使用[`CREATE ASSEMBLY`](https://msdn.microsoft.com/library/ms189524.aspx)命令或從 Management Studio 向資料庫註冊，以及透過類似的方式新增預存程式或 UDF 物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-168">We can create the code in any text editor, compile it from the command line using the Visual Basic compiler (`vbc.exe`), register it with the database using the [`CREATE ASSEMBLY`](https://msdn.microsoft.com/library/ms189524.aspx) command or from Management Studio, and add the stored procedure or UDF object through similar means.</span></span> <span data-ttu-id="fe219-169">幸運的是，Professional 和 Team 系統的 Visual Studio 版本包括可自動執行這些工作的 SQL Server 專案類型。</span><span class="sxs-lookup"><span data-stu-id="fe219-169">Fortunately, the Professional and Team Systems versions of Visual Studio include a SQL Server Project type that automates these tasks.</span></span> <span data-ttu-id="fe219-170">在本教學課程中，我們將逐步解說如何使用 SQL Server 專案類型來建立 managed 預存程式和 UDF。</span><span class="sxs-lookup"><span data-stu-id="fe219-170">In this tutorial we will walk through using the SQL Server Project type to create a managed stored procedure and UDF.</span></span>

> [!NOTE]
> <span data-ttu-id="fe219-171">如果您使用的是 Visual Web Developer 或 Standard edition 的 Visual Studio，就必須改為使用手動方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-171">If you are using Visual Web Developer or the Standard edition of Visual Studio, then you will have to use the manual approach instead.</span></span> <span data-ttu-id="fe219-172">步驟13提供手動執行這些步驟的詳細指示。</span><span class="sxs-lookup"><span data-stu-id="fe219-172">Step 13 provides detailed instructions for performing these steps manually.</span></span> <span data-ttu-id="fe219-173">在閱讀步驟13之前，我建議您先閱讀步驟2到12，因為這些步驟包含重要的 SQL Server 設定指示，不論您使用的是哪一個版本的 Visual Studio 都必須套用。</span><span class="sxs-lookup"><span data-stu-id="fe219-173">I encourage you to read Steps 2 through 12 before reading Step 13 since these steps include important SQL Server configuration instructions that must be applied regardless of what version of Visual Studio you are using.</span></span>

<span data-ttu-id="fe219-174">從開啟 Visual Studio 開始。</span><span class="sxs-lookup"><span data-stu-id="fe219-174">Start by opening Visual Studio.</span></span> <span data-ttu-id="fe219-175">從 [檔案] 功能表中，選擇 [新增專案] 以顯示 [新增專案] 對話方塊（請參閱 [圖 4]）。</span><span class="sxs-lookup"><span data-stu-id="fe219-175">From the File menu, choose New Project to display the New Project dialog box (see Figure 4).</span></span> <span data-ttu-id="fe219-176">向下切入到資料庫專案類型，然後從右邊列出的範本中，選擇建立新的 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="fe219-176">Drill down to the Database project type and then, from the Templates listed on the right, choose to create a new SQL Server Project.</span></span> <span data-ttu-id="fe219-177">我選擇將此專案命名為 `ManagedDatabaseConstructs` 並放在名為 `Tutorial75`的方案中。</span><span class="sxs-lookup"><span data-stu-id="fe219-177">I have chosen to name this project `ManagedDatabaseConstructs` and placed it within a Solution named `Tutorial75`.</span></span>

<span data-ttu-id="fe219-178">[![建立新的 SQL Server 專案](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image7.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image6.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-178">[![Create a New SQL Server Project](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image7.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image6.png)</span></span>

<span data-ttu-id="fe219-179">**圖 4**：建立新的 SQL Server 專案（[按一下以觀看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image8.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-179">**Figure 4**: Create a New SQL Server Project ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image8.png))</span></span>

<span data-ttu-id="fe219-180">按一下 [新增專案] 對話方塊中的 [確定] 按鈕，以建立方案並 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="fe219-180">Click the OK button in the New Project dialog box to create the Solution and SQL Server Project.</span></span>

<span data-ttu-id="fe219-181">SQL Server 專案會系結至特定的資料庫。</span><span class="sxs-lookup"><span data-stu-id="fe219-181">A SQL Server Project is tied to a particular database.</span></span> <span data-ttu-id="fe219-182">因此，在建立新的 SQL Server 專案之後，系統會立即要求您指定此資訊。</span><span class="sxs-lookup"><span data-stu-id="fe219-182">Consequently, after creating the new SQL Server Project we are immediately asked to specify this information.</span></span> <span data-ttu-id="fe219-183">[圖 5] 顯示 [新增資料庫參考] 對話方塊，其中已填入以指向我們在步驟1中向 SQL Server 2005 Express Edition 資料庫實例註冊的 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="fe219-183">Figure 5 shows the New Database Reference dialog box that has been filled out to point to the Northwind database we registered in the SQL Server 2005 Express Edition database instance back in Step 1.</span></span>

![建立 SQL Server 專案與 Northwind 資料庫的關聯](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image9.png)

<span data-ttu-id="fe219-185">**圖 5**：將 SQL Server 專案與 Northwind 資料庫產生關聯</span><span class="sxs-lookup"><span data-stu-id="fe219-185">**Figure 5**: Associate the SQL Server Project with the Northwind Database</span></span>

<span data-ttu-id="fe219-186">為了要在此專案中建立 managed 預存程式和 Udf，我們必須啟用連接的 SQL/CLR 偵錯工具支援。</span><span class="sxs-lookup"><span data-stu-id="fe219-186">In order to debug the managed stored procedures and UDFs we will create within this project, we need to enable SQL/CLR debugging support for the connection.</span></span> <span data-ttu-id="fe219-187">每當 SQL Server 專案與新的資料庫產生關聯時（如 [圖 5] 所示），Visual Studio 會詢問我們是否要在連接上啟用 SQL/CLR 調試（請參閱 [圖 6]）。</span><span class="sxs-lookup"><span data-stu-id="fe219-187">Whenever associating a SQL Server Project with a new database (as we did in Figure 5), Visual Studio asks us if we want to enable SQL/CLR debugging on the connection (see Figure 6).</span></span> <span data-ttu-id="fe219-188">按一下 [是]。</span><span class="sxs-lookup"><span data-stu-id="fe219-188">Click Yes.</span></span>

![啟用 SQL/CLR 調試](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image10.png)

<span data-ttu-id="fe219-190">**圖 6**：啟用 SQL/CLR 調試</span><span class="sxs-lookup"><span data-stu-id="fe219-190">**Figure 6**: Enable SQL/CLR Debugging</span></span>

<span data-ttu-id="fe219-191">此時，新的 SQL Server 專案已加入至方案中。</span><span class="sxs-lookup"><span data-stu-id="fe219-191">At this point the new SQL Server Project has been added to the Solution.</span></span> <span data-ttu-id="fe219-192">它包含名為 `Test Scripts` 的資料夾，其中含有名為 `Test.sql`的檔案，可用來對在專案中建立的 managed 資料庫物件進行偵錯工具。</span><span class="sxs-lookup"><span data-stu-id="fe219-192">It contains a folder named `Test Scripts` with a file named `Test.sql`, which is used for debugging the managed database objects created in the project.</span></span> <span data-ttu-id="fe219-193">我們將在步驟12中探討調試。</span><span class="sxs-lookup"><span data-stu-id="fe219-193">We will look at debugging in Step 12.</span></span>

<span data-ttu-id="fe219-194">我們現在可以在這個專案中加入新的 managed 預存程式和 Udf，但是在我們開始之前，我們先在解決方案中加入現有的 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-194">We can now add new managed stored procedures and UDFs to this project, but before we do let s first include our existing web application in the Solution.</span></span> <span data-ttu-id="fe219-195">從 [檔案] 功能表選取 [新增] 選項，然後選擇 [現有的網站]。</span><span class="sxs-lookup"><span data-stu-id="fe219-195">From the File menu select the Add option and choose Existing Web Site.</span></span> <span data-ttu-id="fe219-196">流覽至適當的網站資料夾，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="fe219-196">Browse to the appropriate website folder and click OK.</span></span> <span data-ttu-id="fe219-197">如 [圖 7] 所示，這會更新方案以包含兩個專案：網站和 `ManagedDatabaseConstructs` SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="fe219-197">As Figure 7 shows, this will update the Solution to include two projects: the website and the `ManagedDatabaseConstructs` SQL Server Project.</span></span>

![方案總管現在包含兩個專案](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image11.png)

<span data-ttu-id="fe219-199">**圖 7**：方案總管現在包含兩個專案</span><span class="sxs-lookup"><span data-stu-id="fe219-199">**Figure 7**: The Solution Explorer Now Includes Two Projects</span></span>

<span data-ttu-id="fe219-200">`Web.config` 中的 `NORTHWNDConnectionString` 值目前參考 `App_Data` 資料夾中的 `NORTHWND.MDF` 檔案。</span><span class="sxs-lookup"><span data-stu-id="fe219-200">The `NORTHWNDConnectionString` value in `Web.config` currently references the `NORTHWND.MDF` file in the `App_Data` folder.</span></span> <span data-ttu-id="fe219-201">因為我們已從 `App_Data` 中移除此資料庫，並在 SQL Server 2005 Express Edition 資料庫實例中明確註冊它，所以我們需要相應更新 `NORTHWNDConnectionString` 值。</span><span class="sxs-lookup"><span data-stu-id="fe219-201">Since we removed this database from `App_Data` and explicitly registered it in the SQL Server 2005 Express Edition database instance, we need to correspondingly update the `NORTHWNDConnectionString` value.</span></span> <span data-ttu-id="fe219-202">開啟網站中的 `Web.config` 檔案，然後變更 `NORTHWNDConnectionString` 值，讓連接字串讀取： `Data Source=localhost\SQLExpress;Initial Catalog=Northwind;Integrated Security=True`。</span><span class="sxs-lookup"><span data-stu-id="fe219-202">Open the `Web.config` file in the website and change the `NORTHWNDConnectionString` value so that the connection string reads: `Data Source=localhost\SQLExpress;Initial Catalog=Northwind;Integrated Security=True`.</span></span> <span data-ttu-id="fe219-203">在這項變更之後，`Web.config` 中的 `<connectionStrings>` 區段看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="fe219-203">After this change, your `<connectionStrings>` section in `Web.config` should look similar to the following:</span></span>

[!code-xml[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample1.xml)]

> [!NOTE]
> <span data-ttu-id="fe219-204">如[先前的教學](debugging-stored-procedures-vb.md)課程中所述，從用戶端應用程式（例如 ASP.NET 網站）進行 SQL Server 物件的調試時，我們需要停用連接共用。</span><span class="sxs-lookup"><span data-stu-id="fe219-204">As discussed in the [preceding tutorial](debugging-stored-procedures-vb.md), when debugging a SQL Server object from a client application, such as an ASP.NET website, we need to disable connection pooling.</span></span> <span data-ttu-id="fe219-205">如上所示的連接字串會停用連接共用（`Pooling=false`）。</span><span class="sxs-lookup"><span data-stu-id="fe219-205">The connection string shown above disables connection pooling ( `Pooling=false` ).</span></span> <span data-ttu-id="fe219-206">如果您不打算從 ASP.NET 網站對 managed 預存程式和 Udf 進行程式設計，請啟用連接共用。</span><span class="sxs-lookup"><span data-stu-id="fe219-206">If you do not plan on debugging the managed stored procedures and UDFs from the ASP.NET website, enable connection pooling.</span></span>

## <a name="step-3-creating-a-managed-stored-procedure"></a><span data-ttu-id="fe219-207">步驟3：建立 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="fe219-207">Step 3: Creating a Managed Stored Procedure</span></span>

<span data-ttu-id="fe219-208">若要將 managed 預存程式加入至 Northwind 資料庫，我們必須先在 SQL Server 專案中建立預存程式做為方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-208">To add a managed stored procedure to the Northwind database we first need to create the stored procedure as a method in the SQL Server Project.</span></span> <span data-ttu-id="fe219-209">在 方案總管中，以滑鼠右鍵按一下 `ManagedDatabaseConstructs` 專案名稱，然後加入宣告新專案。</span><span class="sxs-lookup"><span data-stu-id="fe219-209">From the Solution Explorer, right-click on the `ManagedDatabaseConstructs` project name and choose to add a new item.</span></span> <span data-ttu-id="fe219-210">這會顯示 [加入新專案] 對話方塊，其中會列出可加入至專案的 managed 資料庫物件類型。</span><span class="sxs-lookup"><span data-stu-id="fe219-210">This will display the Add New Item dialog box, which lists the types of managed database objects that can be added to the project.</span></span> <span data-ttu-id="fe219-211">如 [圖 8] 所示，這包括預存程式和使用者定義函式，還有其他函數。</span><span class="sxs-lookup"><span data-stu-id="fe219-211">As Figure 8 shows, this includes stored procedures and User-Defined Functions, among others.</span></span>

<span data-ttu-id="fe219-212">首先，我們要加入一個預存程式，只傳回所有已中止的產品。</span><span class="sxs-lookup"><span data-stu-id="fe219-212">Let s start by adding a stored procedure that simply returns all of the products that have been discontinued.</span></span> <span data-ttu-id="fe219-213">將新的預存程式檔案命名為 `GetDiscontinuedProducts.vb`。</span><span class="sxs-lookup"><span data-stu-id="fe219-213">Name the new stored procedure file `GetDiscontinuedProducts.vb`.</span></span>

<span data-ttu-id="fe219-214">[![新增名為 GetDiscontinuedProducts 的預存程式](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image13.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image12.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-214">[![Add a New Stored Procedure Named GetDiscontinuedProducts.vb](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image13.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image12.png)</span></span>

<span data-ttu-id="fe219-215">**圖 8**：加入名為 `GetDiscontinuedProducts.vb` 的新預存程式（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image14.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-215">**Figure 8**: Add a New Stored Procedure Named `GetDiscontinuedProducts.vb` ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image14.png))</span></span>

<span data-ttu-id="fe219-216">這會建立新的 Visual Basic 類別檔案，其中包含下列內容：</span><span class="sxs-lookup"><span data-stu-id="fe219-216">This will create a new Visual Basic class file with the following content:</span></span>

[!code-vb[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample2.vb)]

<span data-ttu-id="fe219-217">請注意，預存程式會實作為 `Partial` 類別檔案中名為 `StoredProcedures`的 `Shared` 方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-217">Note that the stored procedure is implemented as a `Shared` method within a `Partial` class file named `StoredProcedures`.</span></span> <span data-ttu-id="fe219-218">此外，`GetDiscontinuedProducts` 方法會使用[`SqlProcedure` 屬性](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlprocedureattribute.aspx)裝飾，這會將方法標記為預存程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-218">Moreover, the `GetDiscontinuedProducts` method is decorated with the [`SqlProcedure` attribute](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlprocedureattribute.aspx), which marks the method as a stored procedure.</span></span>

<span data-ttu-id="fe219-219">下列程式碼會建立 `SqlCommand` 物件，並將其 `CommandText` 設定為 `SELECT` 查詢，以傳回 `Discontinued` 欄位等於1之產品的 `Products` 資料表中的所有資料行。</span><span class="sxs-lookup"><span data-stu-id="fe219-219">The following code creates a `SqlCommand` object and sets its `CommandText` to a `SELECT` query that returns all of the columns from the `Products` table for products whose `Discontinued` field equals 1.</span></span> <span data-ttu-id="fe219-220">然後，它會執行命令，並將結果傳回用戶端應用程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-220">It then executes the command and sends the results back to the client application.</span></span> <span data-ttu-id="fe219-221">將此程式碼新增至 `GetDiscontinuedProducts` 方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-221">Add this code to the `GetDiscontinuedProducts` method.</span></span>

[!code-vb[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample3.vb)]

<span data-ttu-id="fe219-222">所有的 managed 資料庫物件都可以存取代表呼叫端內容的[`SqlContext` 物件](https://msdn.microsoft.com/library/ms131108.aspx)。</span><span class="sxs-lookup"><span data-stu-id="fe219-222">All managed database objects have access to a [`SqlContext` object](https://msdn.microsoft.com/library/ms131108.aspx) that represents the context of the caller.</span></span> <span data-ttu-id="fe219-223">`SqlContext` 透過其[`Pipe` 屬性](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlcontext.pipe.aspx)來提供[`SqlPipe` 物件](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.aspx)的存取權。</span><span class="sxs-lookup"><span data-stu-id="fe219-223">The `SqlContext` provides access to a [`SqlPipe` object](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.aspx) via its [`Pipe` property](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlcontext.pipe.aspx).</span></span> <span data-ttu-id="fe219-224">這個 `SqlPipe` 物件是用來 ferry SQL Server 資料庫與呼叫應用程式之間的資訊。</span><span class="sxs-lookup"><span data-stu-id="fe219-224">This `SqlPipe` object is used to ferry information between the SQL Server database and the calling application.</span></span> <span data-ttu-id="fe219-225">正如其名， [`ExecuteAndSend` 方法](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.executeandsend.aspx)會執行傳入的 `SqlCommand` 物件，並將結果傳回用戶端應用程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-225">As its name implies, the [`ExecuteAndSend` method](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.executeandsend.aspx) executes a passed-in `SqlCommand` object and sends the results back to the client application.</span></span>

> [!NOTE]
> <span data-ttu-id="fe219-226">受控資料庫物件最適用于使用程式邏輯的預存程式和 Udf，而不是以集合為基礎的邏輯。</span><span class="sxs-lookup"><span data-stu-id="fe219-226">Managed database objects are best suited for stored procedures and UDFs that use procedural logic rather than set-based logic.</span></span> <span data-ttu-id="fe219-227">程式邏輯牽涉到以逐列方式使用資料集，或處理純量資料。</span><span class="sxs-lookup"><span data-stu-id="fe219-227">Procedural logic involves working with sets of data on a row-by-row basis or working with scalar data.</span></span> <span data-ttu-id="fe219-228">不過，我們剛才建立的 `GetDiscontinuedProducts` 方法不包含程式邏輯。</span><span class="sxs-lookup"><span data-stu-id="fe219-228">The `GetDiscontinuedProducts` method we just created, however, involves no procedural logic.</span></span> <span data-ttu-id="fe219-229">因此，最理想的做法是將它實作為 T-sql 預存程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-229">Therefore, it would ideally be implemented as a T-SQL stored procedure.</span></span> <span data-ttu-id="fe219-230">它會實作為 managed 預存程式，以示範建立和部署 managed 預存程式所需的步驟。</span><span class="sxs-lookup"><span data-stu-id="fe219-230">It is implemented as a managed stored procedure to demonstrate the steps necessary for creating and deploying managed stored procedures.</span></span>

## <a name="step-4-deploying-the-managed-stored-procedure"></a><span data-ttu-id="fe219-231">步驟4：部署 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="fe219-231">Step 4: Deploying the Managed Stored Procedure</span></span>

<span data-ttu-id="fe219-232">完成此程式碼後，我們即可將它部署至 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="fe219-232">With this code complete, we are ready to deploy it to the Northwind database.</span></span> <span data-ttu-id="fe219-233">部署 SQL Server 專案會將程式碼編譯成元件、向資料庫註冊元件，並在資料庫中建立對應的物件，並將它們連結至元件中的適當方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-233">Deploying a SQL Server Project compiles the code into an assembly, registers the assembly with the database, and creates the corresponding objects in the database, linking them to the appropriate methods in the assembly.</span></span> <span data-ttu-id="fe219-234">[部署] 選項所執行的一組確切工作，在步驟13中更精確。</span><span class="sxs-lookup"><span data-stu-id="fe219-234">The exact set of tasks performed by the Deploy option is more precisely spelled out in Step 13.</span></span> <span data-ttu-id="fe219-235">以滑鼠右鍵按一下 方案總管中的 `ManagedDatabaseConstructs` 專案名稱，然後選擇 部署 選項。</span><span class="sxs-lookup"><span data-stu-id="fe219-235">Right-click on the `ManagedDatabaseConstructs` project name in the Solution Explorer and choose the Deploy option.</span></span> <span data-ttu-id="fe219-236">不過，部署因下列錯誤而失敗： ' EXTERNAL ' 附近的語法不正確。</span><span class="sxs-lookup"><span data-stu-id="fe219-236">However, deployment fails with the following error: Incorrect syntax near 'EXTERNAL'.</span></span> <span data-ttu-id="fe219-237">您可能要將目前資料庫的相容性層級設成高一點的值，以啟用這項功能。</span><span class="sxs-lookup"><span data-stu-id="fe219-237">You may need to set the compatibility level of the current database to a higher value to enable this feature.</span></span> <span data-ttu-id="fe219-238">請參閱預存程式 `sp_dbcmptlevel`的說明。</span><span class="sxs-lookup"><span data-stu-id="fe219-238">See help for the stored procedure `sp_dbcmptlevel`.</span></span>

<span data-ttu-id="fe219-239">嘗試在 Northwind 資料庫中註冊元件時，會出現這個錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="fe219-239">This error message occurs when attempting to register the assembly with the Northwind database.</span></span> <span data-ttu-id="fe219-240">為了向 SQL Server 2005 資料庫註冊元件，資料庫的相容性層級必須設定為90。</span><span class="sxs-lookup"><span data-stu-id="fe219-240">In order to register an assembly with a SQL Server 2005 database, the database s compatibility level must be set to 90.</span></span> <span data-ttu-id="fe219-241">根據預設，新的 SQL Server 2005 資料庫的相容性層級為90。</span><span class="sxs-lookup"><span data-stu-id="fe219-241">By default, new SQL Server 2005 databases have a compatibility level of 90.</span></span> <span data-ttu-id="fe219-242">不過，使用 Microsoft SQL Server 2000 建立的資料庫具有預設的相容性層級80。</span><span class="sxs-lookup"><span data-stu-id="fe219-242">However, databases created using Microsoft SQL Server 2000 have a default compatibility level of 80.</span></span> <span data-ttu-id="fe219-243">由於 Northwind 資料庫最初是 Microsoft SQL Server 2000 資料庫，因此其相容性層級目前設定為80，因此必須增加至90，才能註冊 managed 資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-243">Since the Northwind database was initially a Microsoft SQL Server 2000 database, its compatibility level is currently set to 80 and therefore needs to be increased to 90 in order to register managed database objects.</span></span>

<span data-ttu-id="fe219-244">若要更新資料庫的相容性層級，請在 Management Studio 中開啟新的查詢視窗，然後輸入：</span><span class="sxs-lookup"><span data-stu-id="fe219-244">To update the database s compatibility level, open a New Query window in Management Studio and enter:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample4.sql)]

<span data-ttu-id="fe219-245">按一下工具列中的 [執行] 圖示，以執行上述查詢。</span><span class="sxs-lookup"><span data-stu-id="fe219-245">Click the Execute icon in the Toolbar to run the above query.</span></span>

<span data-ttu-id="fe219-246">[![更新 Northwind 資料庫的相容性層級](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image16.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-246">[![Update the Northwind Database s Compatibility Level](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image16.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image15.png)</span></span>

<span data-ttu-id="fe219-247">**圖 9**：更新 Northwind 資料庫的相容性層級（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image17.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-247">**Figure 9**: Update the Northwind Database s Compatibility Level ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image17.png))</span></span>

<span data-ttu-id="fe219-248">更新相容性層級之後，請重新部署 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="fe219-248">After updating the compatibility level, redeploy the SQL Server Project.</span></span> <span data-ttu-id="fe219-249">此時，部署應該會完成，而不會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="fe219-249">This time the deployment should complete without error.</span></span>

<span data-ttu-id="fe219-250">返回 SQL Server Management Studio，以滑鼠右鍵按一下物件總管中的 Northwind 資料庫，然後選擇 [重新整理]。</span><span class="sxs-lookup"><span data-stu-id="fe219-250">Return to SQL Server Management Studio, right-click on the Northwind database in the Object Explorer, and choose Refresh.</span></span> <span data-ttu-id="fe219-251">接下來，向下切入至 [可程式性] 資料夾，然後展開 [元件] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="fe219-251">Next, drill down into the Programmability folder and then expand the Assemblies folder.</span></span> <span data-ttu-id="fe219-252">如 [圖 10] 所示，Northwind 資料庫現在包含了 `ManagedDatabaseConstructs` 專案所產生的元件。</span><span class="sxs-lookup"><span data-stu-id="fe219-252">As Figure 10 shows, the Northwind database now includes the assembly generated by the `ManagedDatabaseConstructs` project.</span></span>

![ManagedDatabaseConstructs 元件現在已向 Northwind 資料庫註冊](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image18.png)

<span data-ttu-id="fe219-254">**圖 10**： `ManagedDatabaseConstructs` 元件現在已向 Northwind 資料庫註冊</span><span class="sxs-lookup"><span data-stu-id="fe219-254">**Figure 10**: The `ManagedDatabaseConstructs` Assembly is Now Registered with the Northwind Database</span></span>

<span data-ttu-id="fe219-255">同時展開 [預存程式] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="fe219-255">Also expand the Stored Procedures folder.</span></span> <span data-ttu-id="fe219-256">您會看到名為 `GetDiscontinuedProducts`的預存程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-256">There you will see a stored procedure named `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="fe219-257">這個預存程式是由部署進程所建立，並指向 `ManagedDatabaseConstructs` 元件中的 `GetDiscontinuedProducts` 方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-257">This stored procedure was created by the deployment process and points to the `GetDiscontinuedProducts` method in the `ManagedDatabaseConstructs` assembly.</span></span> <span data-ttu-id="fe219-258">執行 `GetDiscontinuedProducts` 預存程式時，它會接著執行 `GetDiscontinuedProducts` 方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-258">When the `GetDiscontinuedProducts` stored procedure is executed, it, in turn, executes the `GetDiscontinuedProducts` method.</span></span> <span data-ttu-id="fe219-259">由於這是 managed 預存程式，因此無法透過 Management Studio 編輯（因此，預存程式名稱旁邊的鎖定圖示）。</span><span class="sxs-lookup"><span data-stu-id="fe219-259">Since this is a managed stored procedure it cannot be edited through Management Studio (hence the lock icon next to the stored procedure name).</span></span>

![GetDiscontinuedProducts 預存程式會列在 [預存程式] 資料夾中](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image19.png)

<span data-ttu-id="fe219-261">**圖 11**： `GetDiscontinuedProducts` 預存程式會列在 [預存程式] 資料夾中</span><span class="sxs-lookup"><span data-stu-id="fe219-261">**Figure 11**: The `GetDiscontinuedProducts` Stored Procedure is Listed in the Stored Procedures Folder</span></span>

<span data-ttu-id="fe219-262">在呼叫 managed 預存程式之前，我們必須先克服一項障礙：資料庫已設定為防止執行 managed 程式碼。</span><span class="sxs-lookup"><span data-stu-id="fe219-262">There is still one more hurdle we have to overcome before we can call the managed stored procedure: the database is configured to prevent execution of managed code.</span></span> <span data-ttu-id="fe219-263">請開啟新的查詢視窗，並執行 `GetDiscontinuedProducts` 預存程式，以確認這項操作。</span><span class="sxs-lookup"><span data-stu-id="fe219-263">Verify this by opening a new query window and executing the `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="fe219-264">您會收到下列錯誤訊息：已停用 .NET Framework 中的使用者程式碼執行。</span><span class="sxs-lookup"><span data-stu-id="fe219-264">You will receive the following error message: Execution of user code in the .NET Framework is disabled.</span></span> <span data-ttu-id="fe219-265">[啟用 clr 已啟用] 設定選項。</span><span class="sxs-lookup"><span data-stu-id="fe219-265">Enable �clr enabled configuration option.</span></span>

<span data-ttu-id="fe219-266">若要檢查 Northwind 資料庫的設定資訊，請在查詢視窗中輸入並執行命令 `exec sp_configure`。</span><span class="sxs-lookup"><span data-stu-id="fe219-266">To examine the Northwind database s configuration information, enter and execute the command `exec sp_configure` in the query window.</span></span> <span data-ttu-id="fe219-267">這會顯示 [clr 已啟用] 設定目前設定為0。</span><span class="sxs-lookup"><span data-stu-id="fe219-267">This shows that the clr enabled setting is currently set to 0.</span></span>

<span data-ttu-id="fe219-268">[![[clr 已啟用] 設定目前設定為0](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image21.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image20.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-268">[![The clr enabled Setting is Currently Set to 0](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image21.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image20.png)</span></span>

<span data-ttu-id="fe219-269">**圖 12**： [clr 已啟用] 設定目前設定為0（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image22.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-269">**Figure 12**: The clr enabled Setting is Currently Set to 0 ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image22.png))</span></span>

<span data-ttu-id="fe219-270">請注意，[圖 12] 中的每個設定都有四個與它一起列出的值：最小值和最大值，以及 config 和 run 值。</span><span class="sxs-lookup"><span data-stu-id="fe219-270">Note that each configuration setting in Figure 12 has four values listed with it: the minimum and maximum values and the config and run values.</span></span> <span data-ttu-id="fe219-271">若要更新已啟用 clr 設定的 config 值，請執行下列命令：</span><span class="sxs-lookup"><span data-stu-id="fe219-271">To update the config value for the clr enabled setting, execute the following command:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample5.sql)]

<span data-ttu-id="fe219-272">如果您重新執行 `exec sp_configure` 您會看到上述語句將 clr enabled 設定值更新為1，但執行值仍設為0。</span><span class="sxs-lookup"><span data-stu-id="fe219-272">If you re-run the `exec sp_configure` you will see that the above statement updated the clr enabled setting s config value to 1, but that the run value is still set to 0.</span></span> <span data-ttu-id="fe219-273">為了讓此設定變更生效，我們需要執行[`RECONFIGURE` 命令](https://msdn.microsoft.com/library/ms176069.aspx)，這會將執行值設為目前的設定值。</span><span class="sxs-lookup"><span data-stu-id="fe219-273">For this configuration change to take affect we need to execute the [`RECONFIGURE` command](https://msdn.microsoft.com/library/ms176069.aspx), which will set the run value to the current config value.</span></span> <span data-ttu-id="fe219-274">直接在查詢視窗中輸入 `RECONFIGURE`，然後按一下工具列中的 [執行] 圖示。</span><span class="sxs-lookup"><span data-stu-id="fe219-274">Simply enter `RECONFIGURE` in the query window and click the Execute icon in the Toolbar.</span></span> <span data-ttu-id="fe219-275">如果您執行 `exec sp_configure` 現在您應該會看到 [已啟用 clr] 設定的值為1，並執行 [值]。</span><span class="sxs-lookup"><span data-stu-id="fe219-275">If you run `exec sp_configure` now you should see a value of 1 for the clr enabled setting s config and run values.</span></span>

<span data-ttu-id="fe219-276">在啟用 clr 的設定完成後，我們就可以開始執行 managed `GetDiscontinuedProducts` 預存程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-276">With the clr enabled configuration complete, we are ready to run the managed `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="fe219-277">在查詢視窗中，輸入並執行命令 `exec` `GetDiscontinuedProducts`。</span><span class="sxs-lookup"><span data-stu-id="fe219-277">In the query window enter and execute the command `exec` `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="fe219-278">叫用預存程式會導致 `GetDiscontinuedProducts` 方法中的對應 managed 程式碼執行。</span><span class="sxs-lookup"><span data-stu-id="fe219-278">Invoking the stored procedure causes the corresponding managed code in the `GetDiscontinuedProducts` method to execute.</span></span> <span data-ttu-id="fe219-279">此程式碼會發出 `SELECT` 查詢，以傳回已停止的所有產品，並將此資料傳回給呼叫應用程式，這在此實例中 SQL Server Management Studio。</span><span class="sxs-lookup"><span data-stu-id="fe219-279">This code issues a `SELECT` query to return all products that are discontinued and returns this data to the calling application, which is SQL Server Management Studio in this instance.</span></span> <span data-ttu-id="fe219-280">Management Studio 接收這些結果，並將它們顯示在 [結果] 視窗中。</span><span class="sxs-lookup"><span data-stu-id="fe219-280">Management Studio receives these results and displays them in the Results window.</span></span>

<span data-ttu-id="fe219-281">[![GetDiscontinuedProducts 預存程式傳回所有已停止的產品](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image24.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-281">[![The GetDiscontinuedProducts Stored Procedure Returns All Discontinued Products](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image24.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image23.png)</span></span>

<span data-ttu-id="fe219-282">**圖 13**： `GetDiscontinuedProducts` 預存程式會傳回所有已停止[的產品（按一下以觀看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image25.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-282">**Figure 13**: The `GetDiscontinuedProducts` Stored Procedure Returns All Discontinued Products ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image25.png))</span></span>

## <a name="step-5-creating-managed-stored-procedures-that-accept-input-parameters"></a><span data-ttu-id="fe219-283">步驟5：建立接受輸入參數的 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="fe219-283">Step 5: Creating Managed Stored Procedures that Accept Input Parameters</span></span>

<span data-ttu-id="fe219-284">我們在這些教學課程中建立的許多查詢和預存程式都已使用*參數*。</span><span class="sxs-lookup"><span data-stu-id="fe219-284">Many of the queries and stored procedures we have created throughout these tutorials have used *parameters*.</span></span> <span data-ttu-id="fe219-285">例如，在為具[類型資料集的 Tableadapter 建立新的預存程式](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md)教學課程中，我們建立了名為 `GetProductsByCategoryID` 的預存程式，接受名為 `@CategoryID`的輸入參數。</span><span class="sxs-lookup"><span data-stu-id="fe219-285">For example, in the [Creating New Stored Procedures for the Typed DataSet s TableAdapters](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md) tutorial we created a stored procedure named `GetProductsByCategoryID` that accepted an input parameter named `@CategoryID`.</span></span> <span data-ttu-id="fe219-286">然後，預存程式會傳回其 `CategoryID` 欄位符合所提供 `@CategoryID` 參數值的所有產品。</span><span class="sxs-lookup"><span data-stu-id="fe219-286">The stored procedure then returned all products whose `CategoryID` field matched the value of the supplied `@CategoryID` parameter.</span></span>

<span data-ttu-id="fe219-287">若要建立可接受輸入參數的 managed 預存程式，只要在方法 s 定義中指定這些參數即可。</span><span class="sxs-lookup"><span data-stu-id="fe219-287">To create a managed stored procedure that accepts input parameters, simply specify those parameters in the method s definition.</span></span> <span data-ttu-id="fe219-288">為了說明這一點，讓我們將另一個 managed 預存程式新增至名為 `GetProductsWithPriceLessThan`的 `ManagedDatabaseConstructs` 專案。</span><span class="sxs-lookup"><span data-stu-id="fe219-288">To illustrate this, let s add another managed stored procedure to the `ManagedDatabaseConstructs` project named `GetProductsWithPriceLessThan`.</span></span> <span data-ttu-id="fe219-289">此 managed 預存程式將會接受指定價格的輸入參數，並傳回其 `UnitPrice` 欄位小於參數 s 值的所有產品。</span><span class="sxs-lookup"><span data-stu-id="fe219-289">This managed stored procedure will accept an input parameter specifying a price and will return all products whose `UnitPrice` field is less than the parameter s value.</span></span>

<span data-ttu-id="fe219-290">若要將新的預存程式加入至專案，請以滑鼠右鍵按一下 `ManagedDatabaseConstructs` 專案名稱，然後加入宣告新的預存程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-290">To add a new stored procedure to the project, right-click on the `ManagedDatabaseConstructs` project name and choose to add a new stored procedure.</span></span> <span data-ttu-id="fe219-291">開啟 `GetProductsWithPriceLessThan.vb` 檔案。</span><span class="sxs-lookup"><span data-stu-id="fe219-291">Name the file `GetProductsWithPriceLessThan.vb`.</span></span> <span data-ttu-id="fe219-292">如我們在步驟3中所見，這會建立新的 Visual Basic 類別檔案，其中包含名為的方法 `GetProductsWithPriceLessThan` 放在 `Partial` 類別 `StoredProcedures`中。</span><span class="sxs-lookup"><span data-stu-id="fe219-292">As we saw in Step 3, this will create a new Visual Basic class file with a method named `GetProductsWithPriceLessThan` placed within the `Partial` class `StoredProcedures`.</span></span>

<span data-ttu-id="fe219-293">更新 `GetProductsWithPriceLessThan` 方法的定義，使其接受名為 `price` 的[`SqlMoney`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.aspx)輸入參數，並撰寫程式碼以執行並傳回查詢結果：</span><span class="sxs-lookup"><span data-stu-id="fe219-293">Update the `GetProductsWithPriceLessThan` method s definition so that it accepts a [`SqlMoney`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.aspx) input parameter named `price` and write the code to execute and return the query results:</span></span>

[!code-vb[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample6.vb)]

<span data-ttu-id="fe219-294">`GetProductsWithPriceLessThan` 方法的定義和程式碼，與步驟3中所建立之 `GetDiscontinuedProducts` 方法的定義和程式碼十分相似。</span><span class="sxs-lookup"><span data-stu-id="fe219-294">The `GetProductsWithPriceLessThan` method s definition and code closely resembles the definition and code of the `GetDiscontinuedProducts` method created in Step 3.</span></span> <span data-ttu-id="fe219-295">唯一的差異在於 `GetProductsWithPriceLessThan` 方法會接受做為輸入參數（`price`），`SqlCommand` s 查詢包含參數（`@MaxPrice`），而將參數新增至 `SqlCommand` s `Parameters` 集合，並指派 `price` 變數的值。</span><span class="sxs-lookup"><span data-stu-id="fe219-295">The only differences are that the `GetProductsWithPriceLessThan` method accepts as input parameter (`price`), the `SqlCommand` s query includes a parameter (`@MaxPrice`), and a parameter is added to the `SqlCommand` s `Parameters` collection is and assigned the value of the `price` variable.</span></span>

<span data-ttu-id="fe219-296">加入此程式碼之後，請重新部署 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="fe219-296">After adding this code, redeploy the SQL Server Project.</span></span> <span data-ttu-id="fe219-297">接下來，返回 SQL Server Management Studio 並重新整理 [預存程式] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="fe219-297">Next, return to SQL Server Management Studio and Refresh the Stored Procedures folder.</span></span> <span data-ttu-id="fe219-298">您應該會看到新的專案，`GetProductsWithPriceLessThan`。</span><span class="sxs-lookup"><span data-stu-id="fe219-298">You should see a new entry, `GetProductsWithPriceLessThan`.</span></span> <span data-ttu-id="fe219-299">從查詢視窗中，輸入並執行命令 `exec GetProductsWithPriceLessThan 25`，這會列出小於 $25 的所有產品，如 [圖 14] 所示。</span><span class="sxs-lookup"><span data-stu-id="fe219-299">From a query window, enter and execute the command `exec GetProductsWithPriceLessThan 25`, which will list all products less than $25, as Figure 14 shows.</span></span>

<span data-ttu-id="fe219-300">[顯示 $25 底下的 ![產品](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image27.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-300">[![Products Under $25 are Displayed](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image27.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image26.png)</span></span>

<span data-ttu-id="fe219-301">**圖 14**：顯示 $25 底下的產品（[按一下以觀看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image28.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-301">**Figure 14**: Products Under $25 are Displayed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image28.png))</span></span>

## <a name="step-6-calling-the-managed-stored-procedure-from-the-data-access-layer"></a><span data-ttu-id="fe219-302">步驟6：從資料存取層呼叫 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="fe219-302">Step 6: Calling the Managed Stored Procedure from the Data Access Layer</span></span>

<span data-ttu-id="fe219-303">此時，我們已將 `GetDiscontinuedProducts` 和 `GetProductsWithPriceLessThan` managed 預存程式新增至 `ManagedDatabaseConstructs` 專案，並使用 Northwind SQL Server 資料庫來註冊它們。</span><span class="sxs-lookup"><span data-stu-id="fe219-303">At this point we have added the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures to the `ManagedDatabaseConstructs` project and have registered them with the Northwind SQL Server database.</span></span> <span data-ttu-id="fe219-304">我們也從 SQL Server Management Studio 叫用這些 managed 預存程式（請參閱 [圖 13] 和 [14]）。</span><span class="sxs-lookup"><span data-stu-id="fe219-304">We also invoked these managed stored procedures from SQL Server Management Studio (see Figures 13 and 14).</span></span> <span data-ttu-id="fe219-305">不過，為了讓 ASP.NET 應用程式使用這些 managed 預存程式，我們需要將它們新增至架構中的資料存取和商務邏輯層。</span><span class="sxs-lookup"><span data-stu-id="fe219-305">In order for our ASP.NET application to use these managed stored procedures, however, we need to add them to the Data Access and Business Logic Layers in the architecture.</span></span> <span data-ttu-id="fe219-306">在此步驟中，我們會將兩個新方法加入 `NorthwindWithSprocs` 型別資料集的 `ProductsTableAdapter` 中，一開始是在針對具型別[資料集 tableadapter 教學課程建立新的預存程式](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md)中建立的。</span><span class="sxs-lookup"><span data-stu-id="fe219-306">In this step we will add two new methods to the `ProductsTableAdapter` in the `NorthwindWithSprocs` Typed DataSet, which was initially created in the [Creating New Stored Procedures for the Typed DataSet s TableAdapters](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md) tutorial.</span></span> <span data-ttu-id="fe219-307">在步驟7中，我們會將對應的方法新增到 BLL。</span><span class="sxs-lookup"><span data-stu-id="fe219-307">In Step 7 we will add corresponding methods to the BLL.</span></span>

<span data-ttu-id="fe219-308">在 Visual Studio 中開啟 `NorthwindWithSprocs` 類型資料集，並從將新方法新增至名為 `GetDiscontinuedProducts`的 `ProductsTableAdapter` 開始。</span><span class="sxs-lookup"><span data-stu-id="fe219-308">Open the `NorthwindWithSprocs` Typed DataSet in Visual Studio and start by adding a new method to the `ProductsTableAdapter` named `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="fe219-309">若要將新的方法加入至 TableAdapter，請以滑鼠右鍵按一下設計工具中的 TableAdapter 名稱，然後從內容功能表中選擇 [加入查詢] 選項。</span><span class="sxs-lookup"><span data-stu-id="fe219-309">To add a new method to a TableAdapter, right-click on the TableAdapter s name in the Designer and choose the Add Query option from the context menu.</span></span>

> [!NOTE]
> <span data-ttu-id="fe219-310">因為我們已將 Northwind 資料庫從 `App_Data` 資料夾移至 SQL Server 2005 Express Edition 資料庫實例，所以 Web.config 中對應的連接字串必須更新以反映這項變更。</span><span class="sxs-lookup"><span data-stu-id="fe219-310">Since we moved the Northwind database from the `App_Data` folder to the SQL Server 2005 Express Edition database instance, it is imperative that the corresponding connection string in Web.config be updated to reflect this change.</span></span> <span data-ttu-id="fe219-311">在步驟2中，我們討論了更新 `Web.config`中的 `NORTHWNDConnectionString` 值。</span><span class="sxs-lookup"><span data-stu-id="fe219-311">In Step 2 we discussed updating the `NORTHWNDConnectionString` value in `Web.config`.</span></span> <span data-ttu-id="fe219-312">如果您忘記進行此更新，您會看到錯誤訊息 [無法加入查詢]。</span><span class="sxs-lookup"><span data-stu-id="fe219-312">If you forgot to make this update, then you will see the error message Failed to add query.</span></span> <span data-ttu-id="fe219-313">嘗試將新方法加入至 TableAdapter 時，在對話方塊中找不到物件 `Web.config` 的連接 `NORTHWNDConnectionString`。</span><span class="sxs-lookup"><span data-stu-id="fe219-313">Unable to find connection `NORTHWNDConnectionString` for object `Web.config` in a dialog box when attempting to add a new method to the TableAdapter.</span></span> <span data-ttu-id="fe219-314">若要解決此錯誤，請按一下 [確定]，然後移至 `Web.config` 並更新 `NORTHWNDConnectionString` 值，如步驟2中所述。</span><span class="sxs-lookup"><span data-stu-id="fe219-314">To resolve this error, click OK and then go to `Web.config` and update the `NORTHWNDConnectionString` value as discussed in Step 2.</span></span> <span data-ttu-id="fe219-315">然後嘗試將方法重新加入至 TableAdapter。</span><span class="sxs-lookup"><span data-stu-id="fe219-315">Then try re-adding the method to the TableAdapter.</span></span> <span data-ttu-id="fe219-316">這次它應該會正常執行，而不會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="fe219-316">This time it should work without error.</span></span>

<span data-ttu-id="fe219-317">新增方法會啟動 [TableAdapter 查詢設定向導]，我們在過去的教學課程中已使用過多次。</span><span class="sxs-lookup"><span data-stu-id="fe219-317">Adding a new method launches the TableAdapter Query Configuration wizard, which we have used many times in past tutorials.</span></span> <span data-ttu-id="fe219-318">第一個步驟會要求我們指定 TableAdapter 應如何存取資料庫：透過臨機操作 SQL 語句，或經由新的或現有的預存程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-318">The first step asks us to specify how the TableAdapter should access the database: through an ad-hoc SQL statement or via a new or existing stored procedure.</span></span> <span data-ttu-id="fe219-319">因為我們已經使用資料庫建立並註冊 `GetDiscontinuedProducts` 的 managed 預存程式，所以請選擇 [使用現有的預存程式] 選項，然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="fe219-319">Since we have already created and registered the `GetDiscontinuedProducts` managed stored procedure with the database, choose the Use existing stored procedure option and hit Next.</span></span>

<span data-ttu-id="fe219-320">[![選擇 [使用現有的預存程式] 選項](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image30.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-320">[![Choose the Use existing stored procedure Option](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image30.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image29.png)</span></span>

<span data-ttu-id="fe219-321">**圖 15**：選擇 [使用現有的預存程式] 選項（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image31.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-321">**Figure 15**: Choose the Use existing stored procedure Option ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image31.png))</span></span>

<span data-ttu-id="fe219-322">下一個畫面會提示我們輸入方法將叫用的預存程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-322">The next screen prompts us for the stored procedure the method will invoke.</span></span> <span data-ttu-id="fe219-323">從下拉式清單中選擇 [`GetDiscontinuedProducts` managed 預存程式]，然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="fe219-323">Choose the `GetDiscontinuedProducts` managed stored procedure from the drop-down list and hit Next.</span></span>

<span data-ttu-id="fe219-324">[![選取 GetDiscontinuedProducts Managed 預存程式](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image33.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image32.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-324">[![Select the GetDiscontinuedProducts Managed Stored Procedure](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image33.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image32.png)</span></span>

<span data-ttu-id="fe219-325">**圖 16**：選取 `GetDiscontinuedProducts` Managed 預存程式（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image34.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-325">**Figure 16**: Select the `GetDiscontinuedProducts` Managed Stored Procedure ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image34.png))</span></span>

<span data-ttu-id="fe219-326">接著，我們會要求您指定預存程式是否會傳回資料列、單一值或不傳回任何資料。</span><span class="sxs-lookup"><span data-stu-id="fe219-326">We are then asked to specify whether the stored procedure returns rows, a single value, or nothing.</span></span> <span data-ttu-id="fe219-327">由於 `GetDiscontinuedProducts` 會傳回已停止的產品資料列集，請選擇第一個選項（表格式資料），然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="fe219-327">Since `GetDiscontinuedProducts` returns the set of discontinued product rows, choose the first option ( Tabular data ) and click Next.</span></span>

<span data-ttu-id="fe219-328">[![選取表格式資料選項](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image36.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-328">[![Select the Tabular Data Option](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image36.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image35.png)</span></span>

<span data-ttu-id="fe219-329">**圖 17**：選取表格式資料選項（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image37.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-329">**Figure 17**: Select the Tabular Data Option ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image37.png))</span></span>

<span data-ttu-id="fe219-330">最後的 wizard 畫面可讓我們指定所使用的資料存取模式，以及所產生之方法的名稱。</span><span class="sxs-lookup"><span data-stu-id="fe219-330">The final wizard screen allows us to specify the data access patterns used and the names of the resulting methods.</span></span> <span data-ttu-id="fe219-331">將兩個核取方塊保持為已核取，並將方法命名為 `FillByDiscontinued` 和 `GetDiscontinuedProducts`。</span><span class="sxs-lookup"><span data-stu-id="fe219-331">Leave both checkboxes checked and name the methods `FillByDiscontinued` and `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="fe219-332">按一下 [完成] 完成精靈。</span><span class="sxs-lookup"><span data-stu-id="fe219-332">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="fe219-333">[![將方法命名為 FillByDiscontinued 和 GetDiscontinuedProducts](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image39.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-333">[![Name the Methods FillByDiscontinued and GetDiscontinuedProducts](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image39.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image38.png)</span></span>

<span data-ttu-id="fe219-334">**圖 18**：命名方法 `FillByDiscontinued` 和 `GetDiscontinuedProducts` （[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image40.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-334">**Figure 18**: Name the Methods `FillByDiscontinued` and `GetDiscontinuedProducts` ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image40.png))</span></span>

<span data-ttu-id="fe219-335">重複這些步驟，以建立名為 `FillByPriceLessThan` 的方法，並在 `GetProductsWithPriceLessThan` managed 預存程式的 `ProductsTableAdapter` 中 `GetProductsWithPriceLessThan`。</span><span class="sxs-lookup"><span data-stu-id="fe219-335">Repeat these steps to create methods named `FillByPriceLessThan` and `GetProductsWithPriceLessThan` in the `ProductsTableAdapter` for the `GetProductsWithPriceLessThan` managed stored procedure.</span></span>

<span data-ttu-id="fe219-336">[圖 19] 顯示在將方法加入至 `GetDiscontinuedProducts` 和 `GetProductsWithPriceLessThan` managed 預存程式的 `ProductsTableAdapter` 之後，DataSet 設計工具的螢幕擷取畫面。</span><span class="sxs-lookup"><span data-stu-id="fe219-336">Figure 19 shows a screenshot of the DataSet Designer after adding the methods to the `ProductsTableAdapter` for the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures.</span></span>

<span data-ttu-id="fe219-337">[![ProductsTableAdapter 包含在此步驟中新增的方法](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image42.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-337">[![The ProductsTableAdapter Includes the New Methods Added in this Step](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image42.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image41.png)</span></span>

<span data-ttu-id="fe219-338">**圖 19**： `ProductsTableAdapter` 包含在此步驟中新增的方法（[按一下以觀看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image43.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-338">**Figure 19**: The `ProductsTableAdapter` Includes the New Methods Added in this Step ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image43.png))</span></span>

## <a name="step-7-adding-corresponding-methods-to-the-business-logic-layer"></a><span data-ttu-id="fe219-339">步驟7：將對應的方法加入至商務邏輯層</span><span class="sxs-lookup"><span data-stu-id="fe219-339">Step 7: Adding Corresponding Methods to the Business Logic Layer</span></span>

<span data-ttu-id="fe219-340">既然我們已將資料存取層更新為包含呼叫步驟4和5中所新增之 managed 預存程式的方法，我們必須將對應的方法加入至商務邏輯層。</span><span class="sxs-lookup"><span data-stu-id="fe219-340">Now that we have updated the Data Access Layer to include methods for calling the managed stored procedures added in Steps 4 and 5, we need to add corresponding methods to the Business Logic Layer.</span></span> <span data-ttu-id="fe219-341">將下列兩個方法新增至 `ProductsBLLWithSprocs` 類別：</span><span class="sxs-lookup"><span data-stu-id="fe219-341">Add the following two methods to the `ProductsBLLWithSprocs` class:</span></span>

[!code-vb[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample7.vb)]

<span data-ttu-id="fe219-342">這兩種方法只會呼叫對應的 DAL 方法，並傳回 `ProductsDataTable` 實例。</span><span class="sxs-lookup"><span data-stu-id="fe219-342">Both methods simply call the corresponding DAL method and return the `ProductsDataTable` instance.</span></span> <span data-ttu-id="fe219-343">每個方法上方的 `DataObjectMethodAttribute` 標記會使這些方法包含在 [ObjectDataSource] [設定資料來源] 嚮導的 [選取] 索引標籤的下拉式清單中。</span><span class="sxs-lookup"><span data-stu-id="fe219-343">The `DataObjectMethodAttribute` markup above each method causes these methods to be included in the drop-down list in the SELECT tab of the ObjectDataSource s Configure Data Source wizard.</span></span>

## <a name="step-8-invoking-the-managed-stored-procedures-from-the-presentation-layer"></a><span data-ttu-id="fe219-344">步驟8：從展示層叫用 Managed 預存程式</span><span class="sxs-lookup"><span data-stu-id="fe219-344">Step 8: Invoking the Managed Stored Procedures from the Presentation Layer</span></span>

<span data-ttu-id="fe219-345">藉由增強商務邏輯和資料存取層，以包含呼叫 `GetDiscontinuedProducts` 和 `GetProductsWithPriceLessThan` managed 預存程式的支援，我們現在可以透過 ASP.NET 網頁顯示這些預存程式結果。</span><span class="sxs-lookup"><span data-stu-id="fe219-345">With the Business Logic and Data Access Layers augmented to include support for calling the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures, we can now display these stored procedures results through an ASP.NET page.</span></span>

<span data-ttu-id="fe219-346">開啟 [`AdvancedDAL`] 資料夾中的 [`ManagedFunctionsAndSprocs.aspx`] 頁面，然後從 [工具箱] 將 GridView 拖曳至設計工具。</span><span class="sxs-lookup"><span data-stu-id="fe219-346">Open the `ManagedFunctionsAndSprocs.aspx` page in the `AdvancedDAL` folder and, from the Toolbox, drag a GridView onto the Designer.</span></span> <span data-ttu-id="fe219-347">將 GridView 的 `ID` 屬性設定為 `DiscontinuedProducts`，並將其從智慧標籤系結至名為 `DiscontinuedProductsDataSource`的新 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="fe219-347">Set the GridView s `ID` property to `DiscontinuedProducts` and, from its smart tag, bind it to a new ObjectDataSource named `DiscontinuedProductsDataSource`.</span></span> <span data-ttu-id="fe219-348">設定 ObjectDataSource 以從 `ProductsBLLWithSprocs` 類別的 `GetDiscontinuedProducts` 方法提取其資料。</span><span class="sxs-lookup"><span data-stu-id="fe219-348">Configure the ObjectDataSource to pull its data from the `ProductsBLLWithSprocs` class s `GetDiscontinuedProducts` method.</span></span>

<span data-ttu-id="fe219-349">[![將 ObjectDataSource 設定為使用 ProductsBLLWithSprocs 類別](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image45.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-349">[![Configure the ObjectDataSource to Use the ProductsBLLWithSprocs Class](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image45.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image44.png)</span></span>

<span data-ttu-id="fe219-350">**圖 20**：設定 ObjectDataSource 使用 `ProductsBLLWithSprocs` 類別（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image46.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-350">**Figure 20**: Configure the ObjectDataSource to Use the `ProductsBLLWithSprocs` Class ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image46.png))</span></span>

<span data-ttu-id="fe219-351">[![從 [選取] 索引標籤的下拉式清單中選擇 [GetDiscontinuedProducts] 方法](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image48.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-351">[![Choose the GetDiscontinuedProducts Method from the Drop-Down List in the SELECT Tab](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image48.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image47.png)</span></span>

<span data-ttu-id="fe219-352">**圖 21**：從 [選取] 索引標籤的下拉式清單中選擇 [`GetDiscontinuedProducts`] 方法（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image49.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-352">**Figure 21**: Choose the `GetDiscontinuedProducts` Method from the Drop-Down List in the SELECT Tab ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image49.png))</span></span>

<span data-ttu-id="fe219-353">由於此方格只會用來顯示產品資訊，因此請將 [更新]、[插入] 和 [刪除] 索引標籤中的下拉式清單設定為 [（無）]，然後按一下 [完成]。</span><span class="sxs-lookup"><span data-stu-id="fe219-353">Since this grid will be used to just display product information, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and then click Finish.</span></span>

<span data-ttu-id="fe219-354">完成嚮導後，Visual Studio 會自動為 `ProductsDataTable`中的每個資料欄位新增 BoundField 或 CheckBoxField。</span><span class="sxs-lookup"><span data-stu-id="fe219-354">Upon completing the wizard, Visual Studio will automatically add a BoundField or CheckBoxField for each data field in the `ProductsDataTable`.</span></span> <span data-ttu-id="fe219-355">請花一些時間移除除了 `ProductName` 和 `Discontinued`以外的所有欄位，此時您的 GridView 和 ObjectDataSource 宣告標記看起來應該像下面這樣：</span><span class="sxs-lookup"><span data-stu-id="fe219-355">Take a moment to remove all of these fields except for `ProductName` and `Discontinued`, at which point your GridView and ObjectDataSource s declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample8.aspx)]

<span data-ttu-id="fe219-356">請花點時間透過瀏覽器觀看此頁面。</span><span class="sxs-lookup"><span data-stu-id="fe219-356">Take a moment to view this page through a browser.</span></span> <span data-ttu-id="fe219-357">流覽頁面時，ObjectDataSource 會呼叫 `ProductsBLLWithSprocs` 類別 s `GetDiscontinuedProducts` 方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-357">When the page is visited, the ObjectDataSource calls the `ProductsBLLWithSprocs` class s `GetDiscontinuedProducts` method.</span></span> <span data-ttu-id="fe219-358">如我們在步驟7中所見，這個方法會向下呼叫 DAL s `ProductsDataTable` 類別的 `GetDiscontinuedProducts` 方法，它會叫用 `GetDiscontinuedProducts` 的預存程式。</span><span class="sxs-lookup"><span data-stu-id="fe219-358">As we saw in Step 7, this method calls down to the DAL s `ProductsDataTable` class s `GetDiscontinuedProducts` method, which invokes the `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="fe219-359">這個預存程式是 managed 預存程式，會執行我們在步驟3中建立的程式碼，傳回已停止的產品。</span><span class="sxs-lookup"><span data-stu-id="fe219-359">This stored procedure is a managed stored procedure and executes the code we created in Step 3, returning the discontinued products.</span></span>

<span data-ttu-id="fe219-360">Managed 預存程式所傳回的結果會封裝到 DAL 的 `ProductsDataTable` 中，然後傳回給 BLL，然後將它們傳給其系結至 GridView 並顯示的展示層。</span><span class="sxs-lookup"><span data-stu-id="fe219-360">The results returned by the managed stored procedure are packaged up into a `ProductsDataTable` by the DAL and then returned to the BLL, which then returns them to the Presentation Layer where they are bound to the GridView and displayed.</span></span> <span data-ttu-id="fe219-361">如預期般，方格會列出已停止的產品。</span><span class="sxs-lookup"><span data-stu-id="fe219-361">As expected, the grid lists those products that have been discontinued.</span></span>

<span data-ttu-id="fe219-362">[列出已停止的產品 ![](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image51.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-362">[![The Discontinued Products are Listed](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image51.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image50.png)</span></span>

<span data-ttu-id="fe219-363">**圖 22**：已停止的產品會列出（[按一下以觀看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image52.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-363">**Figure 22**: The Discontinued Products are Listed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image52.png))</span></span>

<span data-ttu-id="fe219-364">如需進一步的作法，請在頁面中新增 TextBox 和另一個 GridView。</span><span class="sxs-lookup"><span data-stu-id="fe219-364">For further practice, add a TextBox and another GridView to the page.</span></span> <span data-ttu-id="fe219-365">讓此 GridView 藉由呼叫 `ProductsBLLWithSprocs` 類別的 `GetProductsWithPriceLessThan` 方法，來顯示小於文字方塊中輸入的產品數量。</span><span class="sxs-lookup"><span data-stu-id="fe219-365">Have this GridView display the products less than the amount entered into the TextBox by calling the `ProductsBLLWithSprocs` class s `GetProductsWithPriceLessThan` method.</span></span>

## <a name="step-9-creating-and-calling-t-sql-udfs"></a><span data-ttu-id="fe219-366">步驟9：建立和呼叫 T-sql Udf</span><span class="sxs-lookup"><span data-stu-id="fe219-366">Step 9: Creating and Calling T-SQL UDFs</span></span>

<span data-ttu-id="fe219-367">使用者定義函式（或 Udf）是資料庫物件，可在程式設計語言中密切模擬函式的語法。</span><span class="sxs-lookup"><span data-stu-id="fe219-367">User-Defined Functions, or UDFs, are database objects the closely mimic the semantics of functions in programming languages.</span></span> <span data-ttu-id="fe219-368">如同 Visual Basic 中的函式，Udf 可以包含可變數目的輸入參數，並傳回特定類型的值。</span><span class="sxs-lookup"><span data-stu-id="fe219-368">Like a function in Visual Basic, UDFs can include a variable number of input parameters and return a value of a particular type.</span></span> <span data-ttu-id="fe219-369">UDF 可以傳回純量資料（字串、整數，依此類推或表格式資料）。</span><span class="sxs-lookup"><span data-stu-id="fe219-369">A UDF can return either scalar data - a string, an integer, and so forth - or tabular data.</span></span> <span data-ttu-id="fe219-370">讓我們快速查看這兩種類型的 Udf，從會傳回純量資料類型的 UDF 開始。</span><span class="sxs-lookup"><span data-stu-id="fe219-370">Let s take a quick look at both types of UDFs, starting with a UDF that returns a scalar data type.</span></span>

<span data-ttu-id="fe219-371">下列 UDF 會計算特定產品清查的預估值。</span><span class="sxs-lookup"><span data-stu-id="fe219-371">The following UDF calculates the estimated value of the inventory for a particular product.</span></span> <span data-ttu-id="fe219-372">它會採用三個輸入參數，也就是特定產品的 `UnitPrice`、`UnitsInStock`和 `Discontinued` 值，並傳回 `money`類型的值。</span><span class="sxs-lookup"><span data-stu-id="fe219-372">It does so by taking in three input parameters - the `UnitPrice`, `UnitsInStock`, and `Discontinued` values for a particular product - and returns a value of type `money`.</span></span> <span data-ttu-id="fe219-373">它會藉由將 `UnitPrice` 乘以 `UnitsInStock`，來計算清查的預估值。</span><span class="sxs-lookup"><span data-stu-id="fe219-373">It computes the estimated value of the inventory by multiplying the `UnitPrice` by the `UnitsInStock`.</span></span> <span data-ttu-id="fe219-374">若為已停止的專案，此值為減半。</span><span class="sxs-lookup"><span data-stu-id="fe219-374">For discontinued items, this value is halved.</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample9.sql)]

<span data-ttu-id="fe219-375">一旦將此 UDF 新增至資料庫之後，就可以藉由展開 [可程式性] 資料夾、[函數] 和 [純量值函式]，透過 Management Studio 來找到它。</span><span class="sxs-lookup"><span data-stu-id="fe219-375">Once this UDF has been added to the database, it can be found through Management Studio by expanding the Programmability folder, then Functions, and then Scalar-value Functions.</span></span> <span data-ttu-id="fe219-376">它可以用在 `SELECT` 查詢中，如下所示：</span><span class="sxs-lookup"><span data-stu-id="fe219-376">It can be used in a `SELECT` query like so:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample10.sql)]

<span data-ttu-id="fe219-377">我已將 `udf_ComputeInventoryValue` UDF 新增至 Northwind 資料庫;[圖 23] 顯示透過 Management Studio 觀看時，上述 `SELECT` 查詢的輸出。</span><span class="sxs-lookup"><span data-stu-id="fe219-377">I have added the `udf_ComputeInventoryValue` UDF to the Northwind database; Figure 23 shows the output of the above `SELECT` query when viewed through Management Studio.</span></span> <span data-ttu-id="fe219-378">另請注意，UDF 會列在物件總管中的 [純量值函式] 資料夾底下。</span><span class="sxs-lookup"><span data-stu-id="fe219-378">Also note that the UDF is listed under the Scalar-value Functions folder in the Object Explorer.</span></span>

<span data-ttu-id="fe219-379">[列出每個產品的清查值 ![](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image54.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-379">[![Each Product s Inventory Values is Listed](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image54.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image53.png)</span></span>

<span data-ttu-id="fe219-380">**圖 23**：列出每個產品的清查值（[按一下以觀看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image55.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-380">**Figure 23**: Each Product s Inventory Values is Listed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image55.png))</span></span>

<span data-ttu-id="fe219-381">Udf 也可以傳回表格式資料。</span><span class="sxs-lookup"><span data-stu-id="fe219-381">UDFs can also return tabular data.</span></span> <span data-ttu-id="fe219-382">例如，我們可以建立一個 UDF，以傳回屬於特定類別的產品：</span><span class="sxs-lookup"><span data-stu-id="fe219-382">For example, we can create a UDF that returns products that belong to a particular category:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample11.sql)]

<span data-ttu-id="fe219-383">`udf_GetProductsByCategoryID` UDF 會接受 `@CategoryID` 輸入參數，並傳回指定之 `SELECT` 查詢的結果。</span><span class="sxs-lookup"><span data-stu-id="fe219-383">The `udf_GetProductsByCategoryID` UDF accepts a `@CategoryID` input parameter and returns the results of the specified `SELECT` query.</span></span> <span data-ttu-id="fe219-384">建立之後，就可以在 `SELECT` 查詢的 `FROM` （或 `JOIN`）子句中參考此 UDF。</span><span class="sxs-lookup"><span data-stu-id="fe219-384">Once created, this UDF can be referenced in the `FROM` (or `JOIN`) clause of a `SELECT` query.</span></span> <span data-ttu-id="fe219-385">下列範例會傳回每個飲料的 `ProductID`、`ProductName`和 `CategoryID` 值。</span><span class="sxs-lookup"><span data-stu-id="fe219-385">The following example would return the `ProductID`, `ProductName`, and `CategoryID` values for each of the beverages.</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample12.sql)]

<span data-ttu-id="fe219-386">我已將 `udf_GetProductsByCategoryID` UDF 新增至 Northwind 資料庫;[圖 24] 顯示透過 Management Studio 觀看時，上述 `SELECT` 查詢的輸出。</span><span class="sxs-lookup"><span data-stu-id="fe219-386">I have added the `udf_GetProductsByCategoryID` UDF to the Northwind database; Figure 24 shows the output of the above `SELECT` query when viewed through Management Studio.</span></span> <span data-ttu-id="fe219-387">傳回表格式資料的 Udf 可以在物件總管 s 資料表值函式資料夾中找到。</span><span class="sxs-lookup"><span data-stu-id="fe219-387">UDFs that return tabular data can be found in the Object Explorer s Table-value Functions folder.</span></span>

<span data-ttu-id="fe219-388">[![會針對每個飲料列出 ProductID、ProductName 和類別名稱](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image57.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-388">[![The ProductID, ProductName, and CategoryID are Listed for Each Beverage](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image57.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image56.png)</span></span>

<span data-ttu-id="fe219-389">**圖 24**：每個飲料都會列出 `ProductID`、`ProductName`和 `CategoryID` （[按一下以觀看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image58.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-389">**Figure 24**: The `ProductID`, `ProductName`, and `CategoryID` are Listed for Each Beverage ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image58.png))</span></span>

> [!NOTE]
> <span data-ttu-id="fe219-390">如需建立和使用 Udf 的詳細資訊，請參閱[使用者定義函數簡介](http://www.sqlteam.com/item.asp?ItemID=1955)。</span><span class="sxs-lookup"><span data-stu-id="fe219-390">For more information on creating and using UDFs, check out [Intro to User-Defined Functions](http://www.sqlteam.com/item.asp?ItemID=1955).</span></span> <span data-ttu-id="fe219-391">另請參閱[使用者定義函數的優點和缺點](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1)。</span><span class="sxs-lookup"><span data-stu-id="fe219-391">Also check out [Advantages and Drawbacks of User-Defined Functions](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1).</span></span>

## <a name="step-10-creating-a-managed-udf"></a><span data-ttu-id="fe219-392">步驟10：建立受控 UDF</span><span class="sxs-lookup"><span data-stu-id="fe219-392">Step 10: Creating a Managed UDF</span></span>

<span data-ttu-id="fe219-393">在上述範例中建立的 `udf_ComputeInventoryValue` 和 `udf_GetProductsByCategoryID` Udf 是 T-sql 資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-393">The `udf_ComputeInventoryValue` and `udf_GetProductsByCategoryID` UDFs created in the above examples are T-SQL database objects.</span></span> <span data-ttu-id="fe219-394">SQL Server 2005 也支援受控 Udf，可以加入至 `ManagedDatabaseConstructs` 專案，就像步驟3和5中的 managed 預存程式一樣。</span><span class="sxs-lookup"><span data-stu-id="fe219-394">SQL Server 2005 also supports managed UDFs, which can be added to the `ManagedDatabaseConstructs` project just like the managed stored procedures from Steps 3 and 5.</span></span> <span data-ttu-id="fe219-395">在此步驟中，讓 s 在受控碼中執行 `udf_ComputeInventoryValue` UDF。</span><span class="sxs-lookup"><span data-stu-id="fe219-395">For this step, let s implement the `udf_ComputeInventoryValue` UDF in managed code.</span></span>

<span data-ttu-id="fe219-396">若要將受控 UDF 新增至 `ManagedDatabaseConstructs` 專案，請在方案總管中的專案名稱上按一下滑鼠右鍵，然後加入宣告新的專案。</span><span class="sxs-lookup"><span data-stu-id="fe219-396">To add a managed UDF to the `ManagedDatabaseConstructs` project, right-click on the project name in Solution Explorer and choose to Add a New Item.</span></span> <span data-ttu-id="fe219-397">從 [加入新專案] 對話方塊中選取使用者定義的範本，並將新的 UDF 檔案命名為 `udf_ComputeInventoryValue_Managed.vb`。</span><span class="sxs-lookup"><span data-stu-id="fe219-397">Select the User-Defined Template from the Add New Item dialog box and name the new UDF file `udf_ComputeInventoryValue_Managed.vb`.</span></span>

<span data-ttu-id="fe219-398">[![將新的受控 UDF 新增至 ManagedDatabaseConstructs 專案](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image60.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image59.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-398">[![Add a New Managed UDF to the ManagedDatabaseConstructs Project](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image60.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image59.png)</span></span>

<span data-ttu-id="fe219-399">**圖 25**：將新的受控 UDF 新增至 `ManagedDatabaseConstructs` 專案（[按一下以觀看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image61.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-399">**Figure 25**: Add a New Managed UDF to the `ManagedDatabaseConstructs` Project ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image61.png))</span></span>

<span data-ttu-id="fe219-400">使用者定義函式範本會建立一個名為 `UserDefinedFunctions` 的 `Partial` 類別，其名稱與類別檔案的名稱（在此例中為`udf_ComputeInventoryValue_Managed`）相同。</span><span class="sxs-lookup"><span data-stu-id="fe219-400">The User-Defined Function template creates a `Partial` class named `UserDefinedFunctions` with a method whose name is the same as the class file s name (`udf_ComputeInventoryValue_Managed`, in this instance).</span></span> <span data-ttu-id="fe219-401">這個方法是使用[`SqlFunction` 屬性](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlfunctionattribute.aspx)裝飾的，它會將方法標記為受控 UDF。</span><span class="sxs-lookup"><span data-stu-id="fe219-401">This method is decorated using the [`SqlFunction` attribute](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlfunctionattribute.aspx), which flags the method as a managed UDF.</span></span>

[!code-vb[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample13.vb)]

<span data-ttu-id="fe219-402">`udf_ComputeInventoryValue` 方法目前會傳回[`SqlString` 物件](https://msdn.microsoft.com/library/system.data.sqltypes.sqlstring.aspx)，而且不接受任何輸入參數。</span><span class="sxs-lookup"><span data-stu-id="fe219-402">The `udf_ComputeInventoryValue` method currently returns a [`SqlString` object](https://msdn.microsoft.com/library/system.data.sqltypes.sqlstring.aspx) and does not accept any input parameters.</span></span> <span data-ttu-id="fe219-403">我們需要更新方法定義，使其接受三個輸入參數，`UnitPrice`、`UnitsInStock`和 `Discontinued`，並傳回 `SqlMoney` 物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-403">We need to update the method definition so that it accepts three input parameters - `UnitPrice`, `UnitsInStock`, and `Discontinued` - and returns a `SqlMoney` object.</span></span> <span data-ttu-id="fe219-404">用來計算清查值的邏輯與 T-sql `udf_ComputeInventoryValue` UDF 中的相同。</span><span class="sxs-lookup"><span data-stu-id="fe219-404">The logic for calculating the inventory value is identical to that in the T-SQL `udf_ComputeInventoryValue` UDF.</span></span>

[!code-vb[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample14.vb)]

<span data-ttu-id="fe219-405">請注意，UDF 方法的輸入參數是其對應的 SQL 類型： `SqlMoney` 用於 `UnitPrice` 欄位、 [`SqlInt16`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlint16.aspx)用於 `UnitsInStock`， [`SqlBoolean`用於 `Discontinued`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlboolean.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="fe219-405">Note that the UDF method s input parameters are of their corresponding SQL types: `SqlMoney` for the `UnitPrice` field, [`SqlInt16`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlint16.aspx) for `UnitsInStock`, and [`SqlBoolean`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlboolean.aspx) for `Discontinued`.</span></span> <span data-ttu-id="fe219-406">這些資料類型會反映 `Products` 資料表中所定義的類型： `UnitPrice` 資料行的類型是 `money`、類型 `smallint`的 `UnitsInStock` 資料行，以及 `Discontinued` 類型的 `bit`資料行。</span><span class="sxs-lookup"><span data-stu-id="fe219-406">These data types reflect the types defined in the `Products` table: the `UnitPrice` column is of type `money`, the `UnitsInStock` column of type `smallint`, and the `Discontinued` column of type `bit`.</span></span>

<span data-ttu-id="fe219-407">程式碼一開始會建立一個名為 `inventoryValue` 的 `SqlMoney` 實例，指派0的值。</span><span class="sxs-lookup"><span data-stu-id="fe219-407">The code starts by creating a `SqlMoney` instance named `inventoryValue` that is assigned a value of 0.</span></span> <span data-ttu-id="fe219-408">`Products` 資料表允許 `UnitsInPrice` 和 `UnitsInStock` 資料行中的資料庫 `NULL` 值。</span><span class="sxs-lookup"><span data-stu-id="fe219-408">The `Products` table allows for database `NULL` values in the `UnitsInPrice` and `UnitsInStock` columns.</span></span> <span data-ttu-id="fe219-409">因此，我們必須先檢查這些值是否包含 `NULL` s，我們會透過 `SqlMoney` 物件 s [`IsNull` 屬性](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.isnull.aspx)來執行此動作。</span><span class="sxs-lookup"><span data-stu-id="fe219-409">Therefore, we need to first check to see if these values contain `NULL` s, which we do through the `SqlMoney` object s [`IsNull` property](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.isnull.aspx).</span></span> <span data-ttu-id="fe219-410">如果 `UnitPrice` 和 `UnitsInStock` 都包含非`NULL` 的值，則我們會將 `inventoryValue` 計算為兩者的乘積。</span><span class="sxs-lookup"><span data-stu-id="fe219-410">If both `UnitPrice` and `UnitsInStock` contain non-`NULL` values, then we compute the `inventoryValue` to be the product of the two.</span></span> <span data-ttu-id="fe219-411">然後，如果 `Discontinued` 為 true，則會可以藉減半值。</span><span class="sxs-lookup"><span data-stu-id="fe219-411">Then, if `Discontinued` is true, then we halve the value.</span></span>

> [!NOTE]
> <span data-ttu-id="fe219-412">`SqlMoney` 物件只允許將兩個 `SqlMoney` 實例相乘在一起。</span><span class="sxs-lookup"><span data-stu-id="fe219-412">The `SqlMoney` object only allows two `SqlMoney` instances to be multiplied together.</span></span> <span data-ttu-id="fe219-413">它不允許 `SqlMoney` 實例乘以常值浮點數。</span><span class="sxs-lookup"><span data-stu-id="fe219-413">It does not allow a `SqlMoney` instance to be multiplied by a literal floating-point number.</span></span> <span data-ttu-id="fe219-414">因此，若要可以藉減半 `inventoryValue` 我們會將它乘以具有值0.5 的新 `SqlMoney` 實例。</span><span class="sxs-lookup"><span data-stu-id="fe219-414">Therefore, to halve `inventoryValue` we multiply it by a new `SqlMoney` instance that has the value 0.5.</span></span>

## <a name="step-11-deploying-the-managed-udf"></a><span data-ttu-id="fe219-415">步驟11：部署受控 UDF</span><span class="sxs-lookup"><span data-stu-id="fe219-415">Step 11: Deploying the Managed UDF</span></span>

<span data-ttu-id="fe219-416">現在已建立受控 UDF，我們已準備好將它部署至 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="fe219-416">Now that that the managed UDF has been created, we are ready to deploy it to the Northwind database.</span></span> <span data-ttu-id="fe219-417">如我們在步驟4中所見，在方案總管中的專案名稱上按一下滑鼠右鍵，然後從內容功能表中選擇 [部署] 選項，即可部署 SQL Server 專案中的 managed 物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-417">As we saw in Step 4, the managed objects in a SQL Server Project are deployed by right-clicking on the project name in the Solution Explorer and choosing the Deploy option from the context menu.</span></span>

<span data-ttu-id="fe219-418">部署專案之後，請返回 SQL Server Management Studio 並重新整理純量值函式資料夾。</span><span class="sxs-lookup"><span data-stu-id="fe219-418">Once you have deployed the project, return to SQL Server Management Studio and refresh the Scalar-valued Functions folder.</span></span> <span data-ttu-id="fe219-419">您現在應該會看到兩個專案：</span><span class="sxs-lookup"><span data-stu-id="fe219-419">You should now see two entries:</span></span>

- <span data-ttu-id="fe219-420">`dbo.udf_ComputeInventoryValue`-在步驟9中建立的 T-sql UDF，以及</span><span class="sxs-lookup"><span data-stu-id="fe219-420">`dbo.udf_ComputeInventoryValue` - the T-SQL UDF created in Step 9, and</span></span>
- <span data-ttu-id="fe219-421">`dbo.udf ComputeInventoryValue_Managed`-剛部署的步驟10中所建立的受控 UDF。</span><span class="sxs-lookup"><span data-stu-id="fe219-421">`dbo.udf ComputeInventoryValue_Managed` - the managed UDF created in Step 10 that was just deployed.</span></span>

<span data-ttu-id="fe219-422">若要測試此受管理的 UDF，請從 Management Studio 中執行下列查詢：</span><span class="sxs-lookup"><span data-stu-id="fe219-422">To test this managed UDF, execute the following query from within Management Studio:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample15.sql)]

<span data-ttu-id="fe219-423">此命令會使用 managed `udf ComputeInventoryValue_Managed` UDF，而不是 T-sql `udf_ComputeInventoryValue` UDF，但輸出會相同。</span><span class="sxs-lookup"><span data-stu-id="fe219-423">This command uses the managed `udf ComputeInventoryValue_Managed` UDF instead of the T-SQL `udf_ComputeInventoryValue` UDF, but the output is the same.</span></span> <span data-ttu-id="fe219-424">請回到 [圖 23] 查看 UDF 輸出的螢幕擷取畫面。</span><span class="sxs-lookup"><span data-stu-id="fe219-424">Refer back to Figure 23 to see a screenshot of the UDF s output.</span></span>

## <a name="step-12-debugging-the-managed-database-objects"></a><span data-ttu-id="fe219-425">步驟12：調試 Managed 資料庫物件</span><span class="sxs-lookup"><span data-stu-id="fe219-425">Step 12: Debugging the Managed Database Objects</span></span>

<span data-ttu-id="fe219-426">在[偵錯工具預存程式](debugging-stored-procedures-vb.md)教學課程中，我們討論了三個選項，可讓您透過 Visual Studio 進行 SQL Server 的偵錯工具：直接資料庫的偵測、應用程式的偵錯工具，以及從 SQL Server 專案</span><span class="sxs-lookup"><span data-stu-id="fe219-426">In the [Debugging Stored Procedures](debugging-stored-procedures-vb.md) tutorial we discussed the three options for debugging SQL Server through Visual Studio: Direct Database Debugging, Application Debugging, and Debugging from a SQL Server Project.</span></span> <span data-ttu-id="fe219-427">Managed 資料庫物件無法透過直接資料庫的偵錯工具來進行調試，但可以從用戶端應用程式以及直接從 SQL Server 專案進行調試。</span><span class="sxs-lookup"><span data-stu-id="fe219-427">Managed database objects cannot be debugged via Direct Database Debugging, but can be debugged from a client application and directly from the SQL Server Project.</span></span> <span data-ttu-id="fe219-428">不過，為了讓偵錯工具能夠正常執行，SQL Server 2005 資料庫必須允許 SQL/CLR 的偵錯工具。</span><span class="sxs-lookup"><span data-stu-id="fe219-428">In order for debugging to work, however, the SQL Server 2005 database must allow SQL/CLR debugging.</span></span> <span data-ttu-id="fe219-429">回想一下，當我們第一次建立 `ManagedDatabaseConstructs` 專案時 Visual Studio 詢問我們是否要啟用 SQL/CLR 偵錯工具（請參閱步驟2中的 [圖 6]）。</span><span class="sxs-lookup"><span data-stu-id="fe219-429">Recall that when we first created the `ManagedDatabaseConstructs` project Visual Studio asked us whether we wanted to enable SQL/CLR debugging (see Figure 6 in Step 2).</span></span> <span data-ttu-id="fe219-430">以滑鼠右鍵按一下 [伺服器總管] 視窗中的資料庫，即可修改此設定。</span><span class="sxs-lookup"><span data-stu-id="fe219-430">This setting can be modified by right-clicking on the database from the Server Explorer window.</span></span>

![確定資料庫允許 SQL/CLR 的偵錯工具](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image62.png)

<span data-ttu-id="fe219-432">**圖 26**：確定資料庫允許 SQL/CLR 的偵錯工具</span><span class="sxs-lookup"><span data-stu-id="fe219-432">**Figure 26**: Ensure that the Database Allows SQL/CLR Debugging</span></span>

<span data-ttu-id="fe219-433">想像一下，我們想要進行 `GetProductsWithPriceLessThan` managed 預存程式的偵錯工具。</span><span class="sxs-lookup"><span data-stu-id="fe219-433">Imagine that we wanted to debug the `GetProductsWithPriceLessThan` managed stored procedure.</span></span> <span data-ttu-id="fe219-434">我們會先在 `GetProductsWithPriceLessThan` 方法的程式碼內設定中斷點。</span><span class="sxs-lookup"><span data-stu-id="fe219-434">We would start by setting a breakpoint within the code of the `GetProductsWithPriceLessThan` method.</span></span>

<span data-ttu-id="fe219-435">[![在 GetProductsWithPriceLessThan 方法中設定中斷點](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image64.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image63.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-435">[![Set a Breakpoint in the GetProductsWithPriceLessThan Method](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image64.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image63.png)</span></span>

<span data-ttu-id="fe219-436">**圖 27**：在 `GetProductsWithPriceLessThan` 方法中設定中斷點（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image65.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-436">**Figure 27**: Set a Breakpoint in the `GetProductsWithPriceLessThan` Method ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image65.png))</span></span>

<span data-ttu-id="fe219-437">讓我們先從 SQL Server 專案中，查看 managed 資料庫物件的調試。</span><span class="sxs-lookup"><span data-stu-id="fe219-437">Let s first look at debugging the managed database objects from the SQL Server Project.</span></span> <span data-ttu-id="fe219-438">由於我們的解決方案包含兩個專案，因此 `ManagedDatabaseConstructs` SQL Server 專案和我們的網站-為了從 SQL Server 專案進行 debug，我們必須指示在開始進行調試時，Visual Studio 啟動 `ManagedDatabaseConstructs` SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="fe219-438">Since our Solution includes two projects - the `ManagedDatabaseConstructs` SQL Server Project along with our website - in order to debug from the SQL Server Project we need to instruct Visual Studio to launch the `ManagedDatabaseConstructs` SQL Server Project when we start debugging.</span></span> <span data-ttu-id="fe219-439">以滑鼠右鍵按一下方案總管中的 `ManagedDatabaseConstructs` 專案，然後從內容功能表選擇 [設定為啟始專案] 選項。</span><span class="sxs-lookup"><span data-stu-id="fe219-439">Right-click the `ManagedDatabaseConstructs` project in Solution Explorer and choose the Set as StartUp Project option from the context menu.</span></span>

<span data-ttu-id="fe219-440">從偵錯工具啟動 `ManagedDatabaseConstructs` 專案時，它會執行 `Test.sql` 檔案中的 SQL 語句，該檔案位於 `Test Scripts` 資料夾中。</span><span class="sxs-lookup"><span data-stu-id="fe219-440">When the `ManagedDatabaseConstructs` project is launched from the debugger it executes the SQL statements in the `Test.sql` file, which is located in the `Test Scripts` folder.</span></span> <span data-ttu-id="fe219-441">例如，若要測試 `GetProductsWithPriceLessThan` managed 預存程式，請將現有的 `Test.sql` 檔案內容取代為下列語句，這會叫用 `GetProductsWithPriceLessThan` managed 預存程式，並以14.95 的 `@CategoryID` 值進行傳遞：</span><span class="sxs-lookup"><span data-stu-id="fe219-441">For example, to test the `GetProductsWithPriceLessThan` managed stored procedure, replace the existing `Test.sql` file content with the following statement, which invokes the `GetProductsWithPriceLessThan` managed stored procedure passing in the `@CategoryID` value of 14.95:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample16.sql)]

<span data-ttu-id="fe219-442">在您將上述腳本輸入 `Test.sql`之後，請前往 [偵錯工具] 功能表，然後選擇 [開始偵測]，或在工具列中按下 F5 或綠色播放圖示來開始進行偵錯工具。</span><span class="sxs-lookup"><span data-stu-id="fe219-442">Once you ve entered the above script into `Test.sql`, start debugging by going to the Debug menu and choosing Start Debugging or by hitting F5 or the green play icon in the Toolbar.</span></span> <span data-ttu-id="fe219-443">這會在方案中建立專案、將 managed 資料庫物件部署到 Northwind 資料庫，然後執行 `Test.sql` 腳本。</span><span class="sxs-lookup"><span data-stu-id="fe219-443">This will build the projects within the Solution, deploy the managed database objects to the Northwind database, and then execute the `Test.sql` script.</span></span> <span data-ttu-id="fe219-444">此時會叫用中斷點，我們可以逐步執行 `GetProductsWithPriceLessThan` 方法，檢查輸入參數的值等等。</span><span class="sxs-lookup"><span data-stu-id="fe219-444">At this point, the breakpoint will be hit and we can step through the `GetProductsWithPriceLessThan` method, examine the values of the input parameters, and so on.</span></span>

<span data-ttu-id="fe219-445">[已達到 GetProductsWithPriceLessThan 方法中的中斷點 ![](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image67.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image66.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-445">[![The Breakpoint in the GetProductsWithPriceLessThan Method Was Hit](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image67.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image66.png)</span></span>

<span data-ttu-id="fe219-446">**圖 28**：已達到 `GetProductsWithPriceLessThan` 方法中的中斷點（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image68.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-446">**Figure 28**: The Breakpoint in the `GetProductsWithPriceLessThan` Method Was Hit ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image68.png))</span></span>

<span data-ttu-id="fe219-447">為了讓 SQL database 物件可以透過用戶端應用程式進行調試，必須將資料庫設定為支援應用程式的偵測。</span><span class="sxs-lookup"><span data-stu-id="fe219-447">In order for a SQL database object to be debugged through a client application, it is imperative that the database be configured to support application debugging.</span></span> <span data-ttu-id="fe219-448">以滑鼠右鍵按一下伺服器總管中的資料庫，並確定已核取 [應用程式偵錯工具] 選項。</span><span class="sxs-lookup"><span data-stu-id="fe219-448">Right-click on the database in Server Explorer and ensure that the Application Debugging option is checked.</span></span> <span data-ttu-id="fe219-449">此外，我們還需要設定 ASP.NET 應用程式，使其與 SQL 偵錯工具整合並停用連接共用。</span><span class="sxs-lookup"><span data-stu-id="fe219-449">Furthermore, we need to configure the ASP.NET application to integrate with the SQL Debugger and to disable connection pooling.</span></span> <span data-ttu-id="fe219-450">這些步驟已在「[偵錯工具預存程式](debugging-stored-procedures-vb.md)」教學課程的步驟2中詳細討論。</span><span class="sxs-lookup"><span data-stu-id="fe219-450">These steps were discussed in detail in Step 2 of the [Debugging Stored Procedures](debugging-stored-procedures-vb.md) tutorial.</span></span>

<span data-ttu-id="fe219-451">在您設定 ASP.NET 應用程式和資料庫之後，請將 ASP.NET 網站設為啟始專案，並開始進行偵錯工具。</span><span class="sxs-lookup"><span data-stu-id="fe219-451">Once you have configured the ASP.NET application and database, set the ASP.NET website as the startup project and start debugging.</span></span> <span data-ttu-id="fe219-452">如果您造訪的頁面會呼叫其中一個具有中斷點的 managed 物件，應用程式將會停止，並將控制權轉換成偵錯工具，您可以在其中逐步執行程式碼，如圖28所示。</span><span class="sxs-lookup"><span data-stu-id="fe219-452">If you visit a page that calls one of the managed objects that has a breakpoint, the application will halt and control will be turned over to the debugger, where you can step through the code as shown in Figure 28.</span></span>

## <a name="step-13-manually-compiling-and-deploying-managed-database-objects"></a><span data-ttu-id="fe219-453">步驟13：手動編譯和部署受管理的資料庫物件</span><span class="sxs-lookup"><span data-stu-id="fe219-453">Step 13: Manually Compiling and Deploying Managed Database Objects</span></span>

<span data-ttu-id="fe219-454">SQL Server 專案可讓您輕鬆地建立、編譯和部署受管理的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-454">SQL Server Projects make it easy to create, compile, and deploy managed database objects.</span></span> <span data-ttu-id="fe219-455">可惜的是，SQL Server 專案僅適用于 Visual Studio 的 Professional 和 Team 系統版本。</span><span class="sxs-lookup"><span data-stu-id="fe219-455">Unfortunately, SQL Server Projects are only available in the Professional and Team Systems editions of Visual Studio.</span></span> <span data-ttu-id="fe219-456">如果您使用的是 Visual Web Developer 或 Standard Edition 的 Visual Studio，而且想要使用受管理的資料庫物件，您必須手動建立及部署它們。</span><span class="sxs-lookup"><span data-stu-id="fe219-456">If you are using Visual Web Developer or the Standard Edition of Visual Studio and want to use managed database objects, you will need to manually create and deploy them.</span></span> <span data-ttu-id="fe219-457">這牽涉到四個步驟：</span><span class="sxs-lookup"><span data-stu-id="fe219-457">This involves four steps:</span></span>

1. <span data-ttu-id="fe219-458">建立檔案，其中包含 managed 資料庫物件的原始程式碼。</span><span class="sxs-lookup"><span data-stu-id="fe219-458">Create a file that contains the source code for the managed database object,</span></span>
2. <span data-ttu-id="fe219-459">將物件編譯成元件，</span><span class="sxs-lookup"><span data-stu-id="fe219-459">Compile the object into an assembly,</span></span>
3. <span data-ttu-id="fe219-460">向 SQL Server 2005 資料庫註冊元件，並</span><span class="sxs-lookup"><span data-stu-id="fe219-460">Register the assembly with the SQL Server 2005 database, and</span></span>
4. <span data-ttu-id="fe219-461">在 SQL Server 中建立資料庫物件，以指向元件中的適當方法。</span><span class="sxs-lookup"><span data-stu-id="fe219-461">Create a database object in SQL Server that points to the appropriate method in the assembly.</span></span>

<span data-ttu-id="fe219-462">為了說明這些工作，讓我們建立新的 managed 預存程式，以傳回 `UnitPrice` 大於指定值的產品。</span><span class="sxs-lookup"><span data-stu-id="fe219-462">To illustrate these tasks, let s create a new managed stored procedure that returns those products whose `UnitPrice` is greater than a specified value.</span></span> <span data-ttu-id="fe219-463">在電腦上建立名為 `GetProductsWithPriceGreaterThan.vb` 的新檔案，並在檔案中輸入下列程式碼（您可以使用 Visual Studio、記事本或任何文字編輯器來完成這項操作）：</span><span class="sxs-lookup"><span data-stu-id="fe219-463">Create a new file on your computer named `GetProductsWithPriceGreaterThan.vb` and enter the following code into the file (you can use Visual Studio, Notepad, or any text editor to accomplish this):</span></span>

[!code-vb[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample17.vb)]

<span data-ttu-id="fe219-464">這段程式碼與在步驟5中建立的 `GetProductsWithPriceLessThan` 方法完全相同。</span><span class="sxs-lookup"><span data-stu-id="fe219-464">This code is nearly identical to that of the `GetProductsWithPriceLessThan` method created in Step 5.</span></span> <span data-ttu-id="fe219-465">唯一的差異在於方法名稱、`WHERE` 子句，以及查詢中所使用的參數名稱。</span><span class="sxs-lookup"><span data-stu-id="fe219-465">The only differences are the method names, the `WHERE` clause, and the parameter name used in the query.</span></span> <span data-ttu-id="fe219-466">回到 `GetProductsWithPriceLessThan` 方法中，`WHERE` 子句會讀取： `WHERE UnitPrice < @MaxPrice`。</span><span class="sxs-lookup"><span data-stu-id="fe219-466">Back in the `GetProductsWithPriceLessThan` method, the `WHERE` clause read: `WHERE UnitPrice < @MaxPrice`.</span></span> <span data-ttu-id="fe219-467">在這裡，我們會在 `GetProductsWithPriceGreaterThan`中使用： `WHERE UnitPrice > @MinPrice`。</span><span class="sxs-lookup"><span data-stu-id="fe219-467">Here, in `GetProductsWithPriceGreaterThan`, we use: `WHERE UnitPrice > @MinPrice` .</span></span>

<span data-ttu-id="fe219-468">我們現在需要將此類別編譯成元件。</span><span class="sxs-lookup"><span data-stu-id="fe219-468">We now need to compile this class into an assembly.</span></span> <span data-ttu-id="fe219-469">從命令列中，流覽至您儲存 `GetProductsWithPriceGreaterThan.vb` 檔案的目錄，並使用C#編譯器（`csc.exe`）將類別檔案編譯成元件：</span><span class="sxs-lookup"><span data-stu-id="fe219-469">From the command line, navigate to the directory where you saved the `GetProductsWithPriceGreaterThan.vb` file and use the C# compiler (`csc.exe`) to compile the class file into an assembly:</span></span>

[!code-console[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample18.cmd)]

<span data-ttu-id="fe219-470">如果包含 v `bc.exe` 的資料夾不在系統 s `PATH`中，您就必須完整參考其路徑，`%WINDOWS%\Microsoft.NET\Framework\version\`，如下所示：</span><span class="sxs-lookup"><span data-stu-id="fe219-470">If the folder containing v `bc.exe` in not in the system s `PATH`, you will have to fully reference its path, `%WINDOWS%\Microsoft.NET\Framework\version\`, like so:</span></span>

[!code-console[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample19.cmd)]

<span data-ttu-id="fe219-471">[![將 GetProductsWithPriceGreaterThan 編譯成元件](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image70.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image69.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-471">[![Compile GetProductsWithPriceGreaterThan.vb Into an Assembly](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image70.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image69.png)</span></span>

<span data-ttu-id="fe219-472">**圖 29**：將 `GetProductsWithPriceGreaterThan.vb` 編譯成元件（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image71.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-472">**Figure 29**: Compile `GetProductsWithPriceGreaterThan.vb` Into an Assembly ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image71.png))</span></span>

<span data-ttu-id="fe219-473">`/t` 旗標會指定 Visual Basic 類別檔案應該編譯成 DLL （而不是可執行檔）。</span><span class="sxs-lookup"><span data-stu-id="fe219-473">The `/t` flag specifies that the Visual Basic class file should be compiled into a DLL (rather than an executable).</span></span> <span data-ttu-id="fe219-474">`/out` 旗標會指定所產生元件的名稱。</span><span class="sxs-lookup"><span data-stu-id="fe219-474">The `/out` flag specifies the name of the resulting assembly.</span></span>

> [!NOTE]
> <span data-ttu-id="fe219-475">您也可以使用[Visual Basic Express edition](https://msdn.microsoft.com/vstudio/express/vb/) ，或在 Visual Studio Standard Edition 中建立個別的類別庫專案，而不是從命令列編譯 `GetProductsWithPriceGreaterThan.vb` 類別檔案。</span><span class="sxs-lookup"><span data-stu-id="fe219-475">Rather than compiling the `GetProductsWithPriceGreaterThan.vb` class file from the command line you could alternatively use [Visual Basic Express Edition](https://msdn.microsoft.com/vstudio/express/vb/) or create a separate Class Library project in Visual Studio Standard Edition.</span></span> <span data-ttu-id="fe219-476">S ren Jacob Lauritsen 已提供這類 Visual Basic Express Edition 專案，其中包含適用于 `GetProductsWithPriceGreaterThan` 預存程式的程式碼，以及在步驟3、5和10中建立的兩個 managed 預存程式和 UDF。</span><span class="sxs-lookup"><span data-stu-id="fe219-476">S ren Jacob Lauritsen has kindly provided such a Visual Basic Express Edition project with code for the `GetProductsWithPriceGreaterThan` stored procedure and the two managed stored procedures and UDF created in Steps 3, 5, and 10.</span></span> <span data-ttu-id="fe219-477">S ren 專案也包含加入對應資料庫物件所需的 T-sql 命令。</span><span class="sxs-lookup"><span data-stu-id="fe219-477">S ren s project also includes the T-SQL commands needed to add the corresponding database objects.</span></span>

<span data-ttu-id="fe219-478">當程式碼編譯成元件時，我們就可以在 SQL Server 2005 資料庫內註冊元件。</span><span class="sxs-lookup"><span data-stu-id="fe219-478">With the code compiled into an assembly, we are ready to register the assembly within the SQL Server 2005 database.</span></span> <span data-ttu-id="fe219-479">這可以透過 T-sql、使用命令 `CREATE ASSEMBLY`，或透過 SQL Server Management Studio 來執行。</span><span class="sxs-lookup"><span data-stu-id="fe219-479">This can be performed through T-SQL, using the command `CREATE ASSEMBLY`, or through SQL Server Management Studio.</span></span> <span data-ttu-id="fe219-480">讓我們專注于使用 Management Studio。</span><span class="sxs-lookup"><span data-stu-id="fe219-480">Let s focus on using Management Studio.</span></span>

<span data-ttu-id="fe219-481">在 [Management Studio] 中，展開 Northwind 資料庫的 [可程式性] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="fe219-481">From Management Studio, expand the Programmability folder in the Northwind database.</span></span> <span data-ttu-id="fe219-482">其中一個子資料夾是元件。</span><span class="sxs-lookup"><span data-stu-id="fe219-482">One of its subfolder is Assemblies.</span></span> <span data-ttu-id="fe219-483">若要手動將新的元件加入至資料庫，請以滑鼠右鍵按一下 [元件] 資料夾，然後從內容功能表中選擇 [新增元件]。</span><span class="sxs-lookup"><span data-stu-id="fe219-483">To manually add a new Assembly to the database, right-click on the Assemblies folder and choose New Assembly from the context menu.</span></span> <span data-ttu-id="fe219-484">這會顯示 [新增元件] 對話方塊（請參閱 [圖 30]）。</span><span class="sxs-lookup"><span data-stu-id="fe219-484">This displays the New Assembly dialog box (see Figure 30).</span></span> <span data-ttu-id="fe219-485">按一下 [流覽] 按鈕，選取剛才編譯的 `ManuallyCreatedDBObjects.dll` 元件，然後按一下 [確定] 將元件加入至資料庫。</span><span class="sxs-lookup"><span data-stu-id="fe219-485">Click on the Browse button, select the `ManuallyCreatedDBObjects.dll` assembly we just compiled, and then click OK to add the Assembly to the database.</span></span> <span data-ttu-id="fe219-486">您不應該在物件總管中看到 `ManuallyCreatedDBObjects.dll` 元件。</span><span class="sxs-lookup"><span data-stu-id="fe219-486">You should not see the `ManuallyCreatedDBObjects.dll` assembly in the Object Explorer.</span></span>

<span data-ttu-id="fe219-487">[![將 ManuallyCreatedDBObjects 元件新增至資料庫](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image73.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image72.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-487">[![Add the ManuallyCreatedDBObjects.dll Assembly to the Database](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image73.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image72.png)</span></span>

<span data-ttu-id="fe219-488">**圖 30**：將 `ManuallyCreatedDBObjects.dll` 元件新增至資料庫（[按一下以查看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image74.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-488">**Figure 30**: Add the `ManuallyCreatedDBObjects.dll` Assembly to the Database ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image74.png))</span></span>

![ManuallyCreatedDBObjects 會列在物件總管](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image75.png)

<span data-ttu-id="fe219-490">**圖 31**： `ManuallyCreatedDBObjects.dll` 列在物件總管</span><span class="sxs-lookup"><span data-stu-id="fe219-490">**Figure 31**: The `ManuallyCreatedDBObjects.dll` is Listed in the Object Explorer</span></span>

<span data-ttu-id="fe219-491">雖然我們已將元件加入 Northwind 資料庫，但我們尚未將預存程式與元件中的 `GetProductsWithPriceGreaterThan` 方法建立關聯。</span><span class="sxs-lookup"><span data-stu-id="fe219-491">While we have added the assembly to the Northwind database, we have yet to associate a stored procedure with the `GetProductsWithPriceGreaterThan` method in the assembly.</span></span> <span data-ttu-id="fe219-492">若要完成這項操作，請開啟新的查詢視窗，並執行下列腳本：</span><span class="sxs-lookup"><span data-stu-id="fe219-492">To accomplish this, open a new query window and execute the following script:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample20.sql)]

<span data-ttu-id="fe219-493">這會在 Northwind 資料庫中建立名為 `GetProductsWithPriceGreaterThan` 的新預存程式，並將它與 managed `GetProductsWithPriceGreaterThan` 方法（位於元件 `ManuallyCreatedDBObjects`中的類別 `StoredProcedures`）產生關聯。</span><span class="sxs-lookup"><span data-stu-id="fe219-493">This creates a new stored procedure in the Northwind database named `GetProductsWithPriceGreaterThan` and associates it with the managed method `GetProductsWithPriceGreaterThan` (which is in the class `StoredProcedures`, which is in the assembly `ManuallyCreatedDBObjects`).</span></span>

<span data-ttu-id="fe219-494">執行上述腳本之後，請重新整理物件總管中的 [預存程式] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="fe219-494">After executing the above script, refresh the Stored Procedures folder in the Object Explorer.</span></span> <span data-ttu-id="fe219-495">您應該會看到新的預存程式專案-`GetProductsWithPriceGreaterThan`-它旁邊有一個鎖定圖示。</span><span class="sxs-lookup"><span data-stu-id="fe219-495">You should see a new stored procedure entry - `GetProductsWithPriceGreaterThan` - which has a lock icon next to it.</span></span> <span data-ttu-id="fe219-496">若要測試此預存程式，請在查詢視窗中輸入並執行下列腳本：</span><span class="sxs-lookup"><span data-stu-id="fe219-496">To test this stored procedure, enter and execute the following script in the query window:</span></span>

[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/samples/sample21.sql)]

<span data-ttu-id="fe219-497">如圖32所示，上述命令會顯示 `UnitPrice` 大於 $24.95 之產品的資訊。</span><span class="sxs-lookup"><span data-stu-id="fe219-497">As Figure 32 shows, the above command displays information for those products with a `UnitPrice` greater than $24.95.</span></span>

<span data-ttu-id="fe219-498">[![ManuallyCreatedDBObjects 列于物件總管](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image77.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image76.png)</span><span class="sxs-lookup"><span data-stu-id="fe219-498">[![The ManuallyCreatedDBObjects.dll is Listed in the Object Explorer](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image77.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image76.png)</span></span>

<span data-ttu-id="fe219-499">**圖 32**： `ManuallyCreatedDBObjects.dll` 列在物件總管（[按一下以觀看完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image78.png)）</span><span class="sxs-lookup"><span data-stu-id="fe219-499">**Figure 32**: The `ManuallyCreatedDBObjects.dll` is Listed in the Object Explorer ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-vb/_static/image78.png))</span></span>

## <a name="summary"></a><span data-ttu-id="fe219-500">總結</span><span class="sxs-lookup"><span data-stu-id="fe219-500">Summary</span></span>

<span data-ttu-id="fe219-501">Microsoft SQL Server 2005 提供與 Common Language Runtime （CLR）的整合，可讓您使用 managed 程式碼建立資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-501">Microsoft SQL Server 2005 provides integration with the Common Language Runtime (CLR), which allows database objects to be created using managed code.</span></span> <span data-ttu-id="fe219-502">先前，這些資料庫物件只能使用 T-sql 建立，但我們現在可以使用 .NET 程式設計語言（例如 Visual Basic）來建立這些物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-502">Previously, these database objects could only be created using T-SQL, but now we can create these objects using .NET programming languages like Visual Basic.</span></span> <span data-ttu-id="fe219-503">在本教學課程中，我們建立了兩個 managed 預存程式和一個受控的使用者定義函數。</span><span class="sxs-lookup"><span data-stu-id="fe219-503">In this tutorial we created two managed stored procedures and a managed User-Defined Function.</span></span>

<span data-ttu-id="fe219-504">Visual Studio 的 SQL Server 專案類型可協助建立、編譯和部署受管理的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-504">Visual Studio s SQL Server Project type facilitates creating, compiling, and deploying managed database objects.</span></span> <span data-ttu-id="fe219-505">此外，它還提供豐富的調試支援。</span><span class="sxs-lookup"><span data-stu-id="fe219-505">Moreover, it offers rich debugging support.</span></span> <span data-ttu-id="fe219-506">不過，SQL Server 專案類型僅適用于 Visual Studio 的 Professional 和 Team 系統版本。</span><span class="sxs-lookup"><span data-stu-id="fe219-506">However, SQL Server Project types are only available in the Professional and Team Systems editions of Visual Studio.</span></span> <span data-ttu-id="fe219-507">對於使用 Visual Web Developer 或 Standard Edition Visual Studio 的，必須手動執行建立、編譯和部署步驟，如我們在步驟13中所見。</span><span class="sxs-lookup"><span data-stu-id="fe219-507">For those using Visual Web Developer or the Standard Edition of Visual Studio, the creation, compilation, and deployment steps must be performed manually, as we saw in Step 13.</span></span>

<span data-ttu-id="fe219-508">快樂的程式設計！</span><span class="sxs-lookup"><span data-stu-id="fe219-508">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="fe219-509">進一步閱讀</span><span class="sxs-lookup"><span data-stu-id="fe219-509">Further Reading</span></span>

<span data-ttu-id="fe219-510">如需本教學課程中所討論之主題的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="fe219-510">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="fe219-511">使用者定義函數的優點和缺點</span><span class="sxs-lookup"><span data-stu-id="fe219-511">Advantages and Drawbacks of User-Defined Functions</span></span>](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1)
- [<span data-ttu-id="fe219-512">在 Managed 程式碼中建立 SQL Server 2005 物件</span><span class="sxs-lookup"><span data-stu-id="fe219-512">Creating SQL Server 2005 Objects in Managed Code</span></span>](https://channel9.msdn.com/Showpost.aspx?postid=142413)
- [<span data-ttu-id="fe219-513">在 SQL Server 2005 中使用 Managed 程式碼建立觸發程式</span><span class="sxs-lookup"><span data-stu-id="fe219-513">Creating Triggers Using Managed Code in SQL Server 2005</span></span>](http://www.15seconds.com/issue/041006.htm)
- <span data-ttu-id="fe219-514">[如何：建立和執行 CLR SQL Server 預存程式](https://msdn.microsoft.com/library/5czye81z(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="fe219-514">[How To: Create and Run a CLR SQL Server Stored Procedure](https://msdn.microsoft.com/library/5czye81z(VS.80).aspx)</span></span>
- <span data-ttu-id="fe219-515">[如何：建立和執行 CLR SQL Server 使用者定義函數](https://msdn.microsoft.com/library/w2kae45k(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="fe219-515">[How To: Create and Run a CLR SQL Server User-Defined Function](https://msdn.microsoft.com/library/w2kae45k(VS.80).aspx)</span></span>
- <span data-ttu-id="fe219-516">[如何：編輯 `Test.sql` 腳本以執行 SQL 物件](https://msdn.microsoft.com/library/ms233682(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="fe219-516">[How To: Edit the `Test.sql` Script to Run SQL Objects](https://msdn.microsoft.com/library/ms233682(VS.80).aspx)</span></span>
- [<span data-ttu-id="fe219-517">使用者定義函數簡介</span><span class="sxs-lookup"><span data-stu-id="fe219-517">Intro to User Defined Functions</span></span>](http://www.sqlteam.com/item.asp?ItemID=1955)
- [<span data-ttu-id="fe219-518">Managed 程式碼和 SQL Server 2005 （影片）</span><span class="sxs-lookup"><span data-stu-id="fe219-518">Managed Code and SQL Server 2005 (Video)</span></span>](https://channel9.msdn.com/Showpost.aspx?postid=142413)
- <span data-ttu-id="fe219-519">[Transact-SQL 參考](https://msdn.microsoft.com/library/aa299742(SQL.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="fe219-519">[Transact-SQL Reference](https://msdn.microsoft.com/library/aa299742(SQL.80).aspx)</span></span>
- <span data-ttu-id="fe219-520">[逐步解說：在 Managed 程式碼中建立預存程式](https://msdn.microsoft.com/library/zxsa8hkf(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="fe219-520">[Walkthrough: Creating a Stored Procedure in Managed Code](https://msdn.microsoft.com/library/zxsa8hkf(VS.80).aspx)</span></span>

## <a name="about-the-author"></a><span data-ttu-id="fe219-521">關於作者</span><span class="sxs-lookup"><span data-stu-id="fe219-521">About the Author</span></span>

<span data-ttu-id="fe219-522">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，自1998起，有七個 ASP/ASP. NET 書籍和創辦人的[4GuysFromRolla.com](http://www.4guysfromrolla.com)。</span><span class="sxs-lookup"><span data-stu-id="fe219-522">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="fe219-523">Scott 以獨立的顧問、訓練員和作者的身分運作。</span><span class="sxs-lookup"><span data-stu-id="fe219-523">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="fe219-524">他的最新著作是[*在24小時內讓自己的 ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="fe219-524">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="fe219-525">他可以在mitchell@4GuysFromRolla.com觸達[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="fe219-525">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="fe219-526">或者透過他的 blog，可以在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)找到。</span><span class="sxs-lookup"><span data-stu-id="fe219-526">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="fe219-527">特別感謝</span><span class="sxs-lookup"><span data-stu-id="fe219-527">Special Thanks To</span></span>

<span data-ttu-id="fe219-528">本教學課程系列已由許多有用的審核者所審查。</span><span class="sxs-lookup"><span data-stu-id="fe219-528">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="fe219-529">本教學課程的領導審查者為 Jacob Lauritsen。</span><span class="sxs-lookup"><span data-stu-id="fe219-529">Lead reviewer for this tutorial was S ren Jacob Lauritsen.</span></span> <span data-ttu-id="fe219-530">除了複習本文外，S ren 也會建立本文下載的C# Visual Express Edition 專案，以手動編譯受控資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="fe219-530">In addition to reviewing this article, S ren also created the Visual C# Express Edition project included in this article s download for manually compiling the managed database objects.</span></span> <span data-ttu-id="fe219-531">有興趣複習我即將發行的 MSDN 文章嗎？</span><span class="sxs-lookup"><span data-stu-id="fe219-531">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="fe219-532">若是如此，請在mitchell@4GuysFromRolla.com的那一行下拉式[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="fe219-532">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="fe219-533">上一篇</span><span class="sxs-lookup"><span data-stu-id="fe219-533">Previous</span></span>](debugging-stored-procedures-vb.md)
