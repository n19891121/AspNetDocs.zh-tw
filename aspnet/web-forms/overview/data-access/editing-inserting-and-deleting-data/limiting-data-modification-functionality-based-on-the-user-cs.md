---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/limiting-data-modification-functionality-based-on-the-user-cs
title: 根據使用者（C#）限制資料修改功能 |Microsoft Docs
author: rick-anderson
description: 在允許使用者編輯資料的 web 應用程式中，不同的使用者帳戶可能會有不同的資料編輯許可權。 在本教學課程中，我們將探討 t 。
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 2b251c82-77cf-4e36-baa9-b648eddaa394
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/limiting-data-modification-functionality-based-on-the-user-cs
msc.type: authoredcontent
ms.openlocfilehash: c3cacaddb7e9b493ba39718f41dcaab360d36fd9
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78591648"
---
# <a name="limiting-data-modification-functionality-based-on-the-user-c"></a><span data-ttu-id="1841a-104">根據使用者限制資料修改功能 (C#)</span><span class="sxs-lookup"><span data-stu-id="1841a-104">Limiting Data Modification Functionality Based on the User (C#)</span></span>

<span data-ttu-id="1841a-105">由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="1841a-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="1841a-106">[下載範例應用程式](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_23_CS.exe)或[下載 PDF](limiting-data-modification-functionality-based-on-the-user-cs/_static/datatutorial23cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="1841a-106">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_23_CS.exe) or [Download PDF](limiting-data-modification-functionality-based-on-the-user-cs/_static/datatutorial23cs1.pdf)</span></span>

> <span data-ttu-id="1841a-107">在允許使用者編輯資料的 web 應用程式中，不同的使用者帳戶可能會有不同的資料編輯許可權。</span><span class="sxs-lookup"><span data-stu-id="1841a-107">In a web application that allows users to edit data, different user accounts may have different data-editing privileges.</span></span> <span data-ttu-id="1841a-108">在本教學課程中，我們將探討如何根據造訪的使用者動態調整資料修改功能。</span><span class="sxs-lookup"><span data-stu-id="1841a-108">In this tutorial we'll examine how to dynamically adjust the data modification capabilities based on the visiting user.</span></span>

## <a name="introduction"></a><span data-ttu-id="1841a-109">簡介</span><span class="sxs-lookup"><span data-stu-id="1841a-109">Introduction</span></span>

<span data-ttu-id="1841a-110">有一些 web 應用程式支援使用者帳戶，並根據登入的使用者提供不同的選項、報表和功能。</span><span class="sxs-lookup"><span data-stu-id="1841a-110">A number of web applications support user accounts and provide different options, reports, and functionality based on the logged in user.</span></span> <span data-ttu-id="1841a-111">例如，在我們的教學課程中，我們可能會想要讓供應商公司的使用者能夠登入網站，並更新其產品的一般資訊-每個單位的名稱和數量，也許還有供應商資訊，例如公司名稱、位址、連絡人的資訊等等。</span><span class="sxs-lookup"><span data-stu-id="1841a-111">For example, with our tutorials we might want to allow users from the supplier companies to log on to the site and update general information about their products - their name and quantity per unit, perhaps - along with supplier information, such as their company name, address, the contact person s information, and so on.</span></span> <span data-ttu-id="1841a-112">此外，我們可能會想要為公司的人員加入一些使用者帳戶，讓他們可以登入並更新產品資訊，例如庫存的單位、重新排序層級等等。</span><span class="sxs-lookup"><span data-stu-id="1841a-112">Furthermore, we might want to include some user accounts for people from our company so that they can log on and update product information like units on stock, reorder level, and so forth.</span></span> <span data-ttu-id="1841a-113">我們的 web 應用程式可能也會允許匿名使用者流覽（未登入的人員），但會限制他們只能查看資料。</span><span class="sxs-lookup"><span data-stu-id="1841a-113">Our web application might also allow anonymous users to visit (people who have not logged on), but would limit them to just viewing data.</span></span> <span data-ttu-id="1841a-114">有了這類使用者帳戶系統之後，我們會希望 ASP.NET 網頁中的資料 Web 控制項提供適用于目前登入使用者的插入、編輯和刪除功能。</span><span class="sxs-lookup"><span data-stu-id="1841a-114">With such a user account system in place, we would want the data Web controls in our ASP.NET pages to offer the inserting, editing, and deleting capabilities appropriate for the currently logged on user.</span></span>

<span data-ttu-id="1841a-115">在本教學課程中，我們將探討如何根據造訪的使用者動態調整資料修改功能。</span><span class="sxs-lookup"><span data-stu-id="1841a-115">In this tutorial we'll examine how to dynamically adjust the data modification capabilities based on the visiting user.</span></span> <span data-ttu-id="1841a-116">特別是，我們將建立一個頁面，以可編輯的 DetailsView 顯示供應商資訊，以及一個 GridView，其中列出供應商所提供的產品。</span><span class="sxs-lookup"><span data-stu-id="1841a-116">In particular, we'll create a page that displays the suppliers information in an editable DetailsView along with a GridView that lists the products provided by the supplier.</span></span> <span data-ttu-id="1841a-117">如果造訪頁面的使用者是來自我們的公司，他們可以：查看任何供應商的資訊;編輯其位址;並編輯供應商所提供之任何產品的資訊。</span><span class="sxs-lookup"><span data-stu-id="1841a-117">If the user visiting the page is from our company, they can: view any supplier s information; edit their address; and edit the information for any product provided by the supplier.</span></span> <span data-ttu-id="1841a-118">不過，如果使用者是來自特定公司，他們只能查看和編輯自己的位址資訊，而且只能編輯尚未標示為已停止的產品。</span><span class="sxs-lookup"><span data-stu-id="1841a-118">If, however, the user is from a particular company, they can only view and edit their own address information and can only edit their products that have not been marked as discontinued.</span></span>

<span data-ttu-id="1841a-119">[![公司的使用者可以編輯任何供應商的資訊](limiting-data-modification-functionality-based-on-the-user-cs/_static/image2.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-119">[![A User from Our Company Can Edit Any Supplier s Information](limiting-data-modification-functionality-based-on-the-user-cs/_static/image2.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image1.png)</span></span>

<span data-ttu-id="1841a-120">**圖 1**：公司的使用者可以編輯任何供應商的資訊（[按一下以觀看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-120">**Figure 1**: A User from Our Company Can Edit Any Supplier s Information ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image3.png))</span></span>

<span data-ttu-id="1841a-121">[![特定供應商的使用者只能查看和編輯其資訊](limiting-data-modification-functionality-based-on-the-user-cs/_static/image5.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-121">[![A User from a Particular Supplier Can Only View and Edit their Information](limiting-data-modification-functionality-based-on-the-user-cs/_static/image5.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image4.png)</span></span>

<span data-ttu-id="1841a-122">**圖 2**：來自特定供應商的使用者只能查看和編輯其資訊（[按一下以觀看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-122">**Figure 2**: A User from a Particular Supplier Can Only View and Edit their Information ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image6.png))</span></span>

<span data-ttu-id="1841a-123">讓我們開始吧！</span><span class="sxs-lookup"><span data-stu-id="1841a-123">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="1841a-124">ASP.NET 2.0 s 成員資格系統提供標準化、可擴充的平臺，可用於建立、管理及驗證使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="1841a-124">ASP.NET 2.0 s membership system provides a standardized, extensible platform for creating, managing, and validating user accounts.</span></span> <span data-ttu-id="1841a-125">由於成員資格系統的檢查已超出這些教學課程的範圍，因此本教學課程會藉由允許匿名訪客選擇其是否來自特定供應商或公司，而改為「fakes」成員資格。</span><span class="sxs-lookup"><span data-stu-id="1841a-125">Since an examination of the membership system is beyond the scope of these tutorials, this tutorial instead "fakes" membership by allowing anonymous visitors to choose whether they are from a particular supplier or from our company.</span></span> <span data-ttu-id="1841a-126">如需成員資格的詳細資訊，請參閱我的[檢查 ASP.NET 2.0 s 成員資格、角色和設定檔](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)一文。</span><span class="sxs-lookup"><span data-stu-id="1841a-126">For more on membership, refer to my [Examining ASP.NET 2.0 s Membership, Roles, and Profile](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx) article series.</span></span>

## <a name="step-1-allowing-the-user-to-specify-their-access-rights"></a><span data-ttu-id="1841a-127">步驟1：允許使用者指定其存取權限</span><span class="sxs-lookup"><span data-stu-id="1841a-127">Step 1: Allowing the User to Specify their Access Rights</span></span>

<span data-ttu-id="1841a-128">在真實世界的 web 應用程式中，使用者的帳戶資訊會包括其是否適用于公司或特定供應商，而且當使用者登入網站之後，這項資訊就會從我們的 ASP.NET 網頁以程式設計方式存取。</span><span class="sxs-lookup"><span data-stu-id="1841a-128">In a real-world web application, a user s account information would include whether they worked for our company or for a particular supplier, and this information would be programmatically accessible from our ASP.NET pages once the user has logged on to the site.</span></span> <span data-ttu-id="1841a-129">透過 ASP.NET 2.0 s 角色系統，可以透過配置檔案系統中的使用者層級帳戶資訊，或透過一些自訂的方式來捕捉此資訊。</span><span class="sxs-lookup"><span data-stu-id="1841a-129">This information could be captured through ASP.NET 2.0 s roles system, as user-level account information through the profile system, or through some custom means.</span></span>

<span data-ttu-id="1841a-130">由於本教學課程的目的是要示範如何根據登入的使用者來調整資料修改功能，而不是為了展示 ASP.NET 2.0 s 成員資格、角色和配置檔案系統，因此我們將使用非常簡單的機制來判斷使用者造訪頁面的功能-使用者可以在其中指出是否應該能夠查看和編輯任何供應商資訊，或是他們可以查看和編輯之特定供應商資訊的 DropDownList。</span><span class="sxs-lookup"><span data-stu-id="1841a-130">Since the aim of this tutorial is to demonstrate adjusting the data modification capabilities based on the logged on user, and is not meant to showcase ASP.NET 2.0 s membership, roles, and profile systems, we'll use a very simply mechanism to determine the capabilities for the user visiting the page - a DropDownList from which the user can indicate if they should be able to view and edit any of the suppliers information or, alternatively, what particular supplier s information they can view and edit.</span></span> <span data-ttu-id="1841a-131">如果使用者指出她可以查看和編輯所有供應商資訊（預設值），她可以逐頁流覽所有供應商，編輯任何供應商的位址資訊，並針對所選供應商所提供的任何產品，編輯每個單位的名稱和數量。</span><span class="sxs-lookup"><span data-stu-id="1841a-131">If the user indicates that she can view and edit all supplier information (the default), she can page through all suppliers, edit any supplier s address information, and edit the name and quantity per unit for any product provided by the selected supplier.</span></span> <span data-ttu-id="1841a-132">不過，如果使用者指出她只能查看和編輯特定供應商，則她只能查看該供應商的詳細資料和產品，而且只能針對*未*中止的產品更新其名稱和數量。</span><span class="sxs-lookup"><span data-stu-id="1841a-132">If the user indicates that she can only view and edit a particular supplier, however, then she can only view the details and products for that one supplier and can only update the name and quantity per unit information for those products that are *not* discontinued.</span></span>

<span data-ttu-id="1841a-133">然後，我們在本教學課程中的第一個步驟是建立此 DropDownList，並在系統中填入供應商。</span><span class="sxs-lookup"><span data-stu-id="1841a-133">Our first step in this tutorial, then, is to create this DropDownList and populate it with the suppliers in the system.</span></span> <span data-ttu-id="1841a-134">開啟 [`EditInsertDelete`] 資料夾中的 [`UserLevelAccess.aspx`] 頁面，新增其 `ID` 屬性設定為 [`Suppliers`] 的 DropDownList，然後將此 DropDownList 系結至名為 `AllSuppliersDataSource`的新 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="1841a-134">Open the `UserLevelAccess.aspx` page in the `EditInsertDelete` folder, add a DropDownList whose `ID` property is set to `Suppliers`, and bind this DropDownList to a new ObjectDataSource named `AllSuppliersDataSource`.</span></span>

<span data-ttu-id="1841a-135">[![建立名為 AllSuppliersDataSource 的新 ObjectDataSource](limiting-data-modification-functionality-based-on-the-user-cs/_static/image8.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-135">[![Create a New ObjectDataSource Named AllSuppliersDataSource](limiting-data-modification-functionality-based-on-the-user-cs/_static/image8.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image7.png)</span></span>

<span data-ttu-id="1841a-136">**圖 3**：建立名為 `AllSuppliersDataSource` 的新 ObjectDataSource （[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-136">**Figure 3**: Create a New ObjectDataSource Named `AllSuppliersDataSource` ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image9.png))</span></span>

<span data-ttu-id="1841a-137">因為我們想要讓此 DropDownList 包含所有供應商，所以請設定 ObjectDataSource 來叫用 `SuppliersBLL` 類別的 `GetSuppliers()` 方法。</span><span class="sxs-lookup"><span data-stu-id="1841a-137">Since we want this DropDownList to include all suppliers, configure the ObjectDataSource to invoke the `SuppliersBLL` class s `GetSuppliers()` method.</span></span> <span data-ttu-id="1841a-138">此外，請確定 ObjectDataSource s `Update()` 方法已對應到 `SuppliersBLL` 類別 s `UpdateSupplierAddress` 方法，因為我們將在步驟2中新增的 DetailsView 也會使用這個 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="1841a-138">Also ensure that the ObjectDataSource s `Update()` method is mapped to the `SuppliersBLL` class s `UpdateSupplierAddress` method, as this ObjectDataSource will also be used by the DetailsView we'll be adding in Step 2.</span></span>

<span data-ttu-id="1841a-139">完成 ObjectDataSource wizard 之後，請設定 `Suppliers` DropDownList 來完成步驟，使其顯示 `CompanyName` 資料欄位，並使用 [`SupplierID` 資料] 欄位做為每個 `ListItem`的值。</span><span class="sxs-lookup"><span data-stu-id="1841a-139">After completing the ObjectDataSource wizard, complete the steps by configuring the `Suppliers` DropDownList such that it shows the `CompanyName` data field and uses the `SupplierID` data field as the value for each `ListItem`.</span></span>

<span data-ttu-id="1841a-140">[![將供應商 DropDownList 設定為使用 [公司名稱] 和 [已供應商] 資料欄位](limiting-data-modification-functionality-based-on-the-user-cs/_static/image11.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-140">[![Configure the Suppliers DropDownList to Use the CompanyName and SupplierID Data Fields](limiting-data-modification-functionality-based-on-the-user-cs/_static/image11.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image10.png)</span></span>

<span data-ttu-id="1841a-141">**圖 4**：設定 `Suppliers` DropDownList 使用 `CompanyName` 和 `SupplierID` 資料欄位（[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-141">**Figure 4**: Configure the `Suppliers` DropDownList to Use the `CompanyName` and `SupplierID` Data Fields ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image12.png))</span></span>

<span data-ttu-id="1841a-142">此時，DropDownList 會在資料庫中列出供應商的公司名稱。</span><span class="sxs-lookup"><span data-stu-id="1841a-142">At this point, the DropDownList lists the company names of the suppliers in the database.</span></span> <span data-ttu-id="1841a-143">不過，我們也需要在 DropDownList 中包含 [顯示/編輯所有供應商] 選項。</span><span class="sxs-lookup"><span data-stu-id="1841a-143">However, we also need to include a "Show/Edit ALL Suppliers" option to the DropDownList.</span></span> <span data-ttu-id="1841a-144">若要完成此動作，請將 `Suppliers` DropDownList s `AppendDataBoundItems` 屬性設定為 `true`，然後新增 `ListItem`，其 `Text` 屬性為「顯示/編輯所有供應商」，且其值為 `-1`。</span><span class="sxs-lookup"><span data-stu-id="1841a-144">To accomplish this, set the `Suppliers` DropDownList s `AppendDataBoundItems` property to `true` and then add a `ListItem` whose `Text` property is "Show/Edit ALL Suppliers" and whose value is `-1`.</span></span> <span data-ttu-id="1841a-145">您可以直接透過宣告式標記或透過設計工具新增這項功能，方法是前往屬性視窗，然後按一下 DropDownList s `Items` 屬性中的省略號。</span><span class="sxs-lookup"><span data-stu-id="1841a-145">This can be added directly through the declarative markup or through the Designer by going to the Properties window and clicking on the ellipses in the DropDownList s `Items` property.</span></span>

> [!NOTE]
> <span data-ttu-id="1841a-146">如需將 [全選] 專案新增至資料系結 DropDownList 的詳細討論，請參閱使用 DropDownList 教學課程的[*主要/詳細資料篩選*](../masterdetail/master-detail-filtering-with-a-dropdownlist-cs.md)。</span><span class="sxs-lookup"><span data-stu-id="1841a-146">Refer back to the [*Master/Detail Filtering With a DropDownList*](../masterdetail/master-detail-filtering-with-a-dropdownlist-cs.md) tutorial for a more detailed discussion on adding a Select All item to a databound DropDownList.</span></span>

<span data-ttu-id="1841a-147">設定 `AppendDataBoundItems` 屬性並新增 `ListItem` 之後，DropDownList 的宣告式標記看起來應該像這樣：</span><span class="sxs-lookup"><span data-stu-id="1841a-147">After the `AppendDataBoundItems` property has been set and the `ListItem` added, the DropDownList s declarative markup should look like:</span></span>

[!code-aspx[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample1.aspx)]

<span data-ttu-id="1841a-148">[圖 5] 顯示透過瀏覽器觀看時，目前進度的螢幕擷取畫面。</span><span class="sxs-lookup"><span data-stu-id="1841a-148">Figure 5 shows a screen shot of our current progress, when viewed through a browser.</span></span>

<span data-ttu-id="1841a-149">[![[供應商 DropDownList] 包含 [顯示所有] 的所有人，加上每個供應商一個](limiting-data-modification-functionality-based-on-the-user-cs/_static/image14.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-149">[![The Suppliers DropDownList Contains a Show ALL ListItem, Plus One for Each Supplier](limiting-data-modification-functionality-based-on-the-user-cs/_static/image14.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image13.png)</span></span>

<span data-ttu-id="1841a-150">**圖 5**： [`Suppliers`] DropDownList 包含 [顯示所有 `ListItem`]，加上每個供應商的一個（[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-150">**Figure 5**: The `Suppliers` DropDownList Contains a Show ALL `ListItem`, Plus One for Each Supplier ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image15.png))</span></span>

<span data-ttu-id="1841a-151">因為我們想要在使用者變更其選擇之後立即更新使用者介面，請將 `Suppliers` DropDownList s `AutoPostBack` 屬性設定為 [`true`]。</span><span class="sxs-lookup"><span data-stu-id="1841a-151">Since we want to update the user interface immediately after the user has changed their selection, set the `Suppliers` DropDownList s `AutoPostBack` property to `true`.</span></span> <span data-ttu-id="1841a-152">在步驟2中，我們將建立 DetailsView 控制項，它會根據選取的 DropDownList 顯示供應商的資訊。</span><span class="sxs-lookup"><span data-stu-id="1841a-152">In Step 2 we'll create a DetailsView control that will show the information for the supplier(s) based on the DropDownList selection.</span></span> <span data-ttu-id="1841a-153">然後，在步驟3中，我們將為這個 DropDownList 的 `SelectedIndexChanged` 事件建立事件處理常式，我們會根據選取的供應商，將適當供應商資訊系結至 DetailsView 的程式碼。</span><span class="sxs-lookup"><span data-stu-id="1841a-153">Then, in Step 3, we'll create an event handler for this DropDownList s `SelectedIndexChanged` event, in which we'll add code that binds the appropriate supplier information to the DetailsView based upon the selected supplier.</span></span>

## <a name="step-2-adding-a-detailsview-control"></a><span data-ttu-id="1841a-154">步驟2：新增 DetailsView 控制項</span><span class="sxs-lookup"><span data-stu-id="1841a-154">Step 2: Adding a DetailsView Control</span></span>

<span data-ttu-id="1841a-155">讓 s 使用 DetailsView 來顯示供應商資訊。</span><span class="sxs-lookup"><span data-stu-id="1841a-155">Let s use a DetailsView to show supplier information.</span></span> <span data-ttu-id="1841a-156">對於可以查看和編輯所有供應商的使用者，DetailsView 將支援分頁，讓使用者一次一筆記錄就能逐步執行供應商資訊。</span><span class="sxs-lookup"><span data-stu-id="1841a-156">For the user who can view and edit all suppliers, the DetailsView will support paging, allowing the user to step through the supplier information one record at a time.</span></span> <span data-ttu-id="1841a-157">不過，如果使用者適用于特定供應商，則 DetailsView 只會顯示該特定供應商的資訊，且不會包含分頁介面。</span><span class="sxs-lookup"><span data-stu-id="1841a-157">If the user works for a particular supplier, however, the DetailsView will show only that particular supplier s information and will not include a paging interface.</span></span> <span data-ttu-id="1841a-158">不論是哪一種情況，DetailsView 都必須允許使用者編輯供應商的位址、城市和國家（地區）欄位。</span><span class="sxs-lookup"><span data-stu-id="1841a-158">In either case, the DetailsView needs to allow the user to edit the supplier s address, city, and country fields.</span></span>

<span data-ttu-id="1841a-159">將 DetailsView 新增至 [`Suppliers`] DropDownList 底下的頁面，將其 [`ID`] 屬性設定為 [`SupplierDetails`]，並將它系結至在上一個步驟中建立的 `AllSuppliersDataSource` ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="1841a-159">Add a DetailsView to the page beneath the `Suppliers` DropDownList, set its `ID` property to `SupplierDetails`, and bind it to the `AllSuppliersDataSource` ObjectDataSource created in the previous step.</span></span> <span data-ttu-id="1841a-160">接下來，核取 [啟用分頁] 和 [啟用編輯] 核取方塊（來自 DetailsView s 智慧標籤）。</span><span class="sxs-lookup"><span data-stu-id="1841a-160">Next, check the Enable Paging and Enable Editing checkboxes from the DetailsView s smart tag.</span></span>

> [!NOTE]
> <span data-ttu-id="1841a-161">如果您沒有在 DetailsView s 智慧標籤中看到 [啟用編輯] 選項，因為您未將 ObjectDataSource s `Update()` 方法對應到 `SuppliersBLL` 類別 s `UpdateSupplierAddress` 方法。</span><span class="sxs-lookup"><span data-stu-id="1841a-161">If you don t see an Enable Editing option in the DetailsView s smart tag it s because you did not map the ObjectDataSource s `Update()` method to the `SuppliersBLL` class s `UpdateSupplierAddress` method.</span></span> <span data-ttu-id="1841a-162">請花點時間返回並進行這項設定變更，在這之後，[啟用編輯] 選項應該會出現在 DetailsView s 智慧標籤中。</span><span class="sxs-lookup"><span data-stu-id="1841a-162">Take a moment to go back and make this configuration change, after which the Enable Editing option should appear in the DetailsView s smart tag.</span></span>

<span data-ttu-id="1841a-163">由於 `SuppliersBLL` 類別的 `UpdateSupplierAddress` 方法只接受四個參數，`supplierID`、`address`、`city`和 `country` 修改 DetailsView s BoundFields，讓 `CompanyName` 和 `Phone` BoundFields 都是唯讀的。</span><span class="sxs-lookup"><span data-stu-id="1841a-163">Since the `SuppliersBLL` class s `UpdateSupplierAddress` method only accepts four parameters - `supplierID`, `address`, `city`, and `country` - modify the DetailsView s BoundFields so that the `CompanyName` and `Phone` BoundFields are read-only.</span></span> <span data-ttu-id="1841a-164">此外，請完全移除 `SupplierID` BoundField。</span><span class="sxs-lookup"><span data-stu-id="1841a-164">Additionally, remove the `SupplierID` BoundField altogether.</span></span> <span data-ttu-id="1841a-165">最後，`AllSuppliersDataSource` ObjectDataSource 目前的 `OldValuesParameterFormatString` 屬性設定為 `original_{0}`。</span><span class="sxs-lookup"><span data-stu-id="1841a-165">Finally, the `AllSuppliersDataSource` ObjectDataSource currently has its `OldValuesParameterFormatString` property set to `original_{0}`.</span></span> <span data-ttu-id="1841a-166">請花點時間從宣告式語法中移除此屬性設定，或將它設定為預設值 `{0}`。</span><span class="sxs-lookup"><span data-stu-id="1841a-166">Take a moment to remove this property setting from the declarative syntax altogether, or set it to the default value, `{0}`.</span></span>

<span data-ttu-id="1841a-167">設定 `SupplierDetails` DetailsView 並 `AllSuppliersDataSource` ObjectDataSource 之後，我們將會有下列宣告式標記：</span><span class="sxs-lookup"><span data-stu-id="1841a-167">After configuring the `SupplierDetails` DetailsView and `AllSuppliersDataSource` ObjectDataSource, we will have the following declarative markup:</span></span>

[!code-aspx[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample2.aspx)]

<span data-ttu-id="1841a-168">此時，DetailsView 可以進行分頁，而且選取的供應商位址資訊可以更新，而不論在 `Suppliers` DropDownList 中所做的選擇為何（請參閱 [圖 6]）。</span><span class="sxs-lookup"><span data-stu-id="1841a-168">At this point the DetailsView can be paged through and the selected supplier s address information can be updated, regardless of the selection made in the `Suppliers` DropDownList (see Figure 6).</span></span>

<span data-ttu-id="1841a-169">[![可以查看任何供應商資訊，並更新其位址](limiting-data-modification-functionality-based-on-the-user-cs/_static/image17.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-169">[![Any Suppliers Information Can Be Viewed, and Its Address Updated](limiting-data-modification-functionality-based-on-the-user-cs/_static/image17.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image16.png)</span></span>

<span data-ttu-id="1841a-170">**圖 6**：可以查看任何供應商資訊，並更新其位址（[按一下以觀看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-170">**Figure 6**: Any Suppliers Information Can Be Viewed, and Its Address Updated ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image18.png))</span></span>

## <a name="step-3-displaying-only-the-selected-supplier-s-information"></a><span data-ttu-id="1841a-171">步驟3：只顯示選取的供應商資訊</span><span class="sxs-lookup"><span data-stu-id="1841a-171">Step 3: Displaying Only the Selected Supplier s Information</span></span>

<span data-ttu-id="1841a-172">我們的頁面目前會顯示所有供應商的資訊，而不論是否已從 `Suppliers` DropDownList 中選取特定供應商。</span><span class="sxs-lookup"><span data-stu-id="1841a-172">Our page currently displays the information for all suppliers regardless of whether a particular supplier has been selected from the `Suppliers` DropDownList.</span></span> <span data-ttu-id="1841a-173">為了只顯示所選供應商的供應商資訊，我們需要在頁面中新增另一個 ObjectDataSource，以抓取特定供應商的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="1841a-173">In order to display just the supplier information for the selected supplier we need to add another ObjectDataSource to our page, one that retrieves information about a particular supplier.</span></span>

<span data-ttu-id="1841a-174">將新的 ObjectDataSource 加入至頁面，並將其命名為 `SingleSupplierDataSource`。</span><span class="sxs-lookup"><span data-stu-id="1841a-174">Add a new ObjectDataSource to the page, naming it `SingleSupplierDataSource`.</span></span> <span data-ttu-id="1841a-175">從其智慧標籤，按一下 [設定資料來源] 連結，並讓它使用 `SuppliersBLL` 類別的 `GetSupplierBySupplierID(supplierID)` 方法。</span><span class="sxs-lookup"><span data-stu-id="1841a-175">From its smart tag, click the Configure Data Source link and have it use the `SuppliersBLL` class s `GetSupplierBySupplierID(supplierID)` method.</span></span> <span data-ttu-id="1841a-176">如同 `AllSuppliersDataSource` ObjectDataSource，請將 `SingleSupplierDataSource` ObjectDataSource s `Update()` 方法對應到 `SuppliersBLL` 類別的 `UpdateSupplierAddress` 方法。</span><span class="sxs-lookup"><span data-stu-id="1841a-176">As with the `AllSuppliersDataSource` ObjectDataSource, have the `SingleSupplierDataSource` ObjectDataSource s `Update()` method mapped to the `SuppliersBLL` class s `UpdateSupplierAddress` method.</span></span>

<span data-ttu-id="1841a-177">[![將 SingleSupplierDataSource ObjectDataSource 設定為使用 GetSupplierBySupplierID （已加入供應商）方法](limiting-data-modification-functionality-based-on-the-user-cs/_static/image20.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-177">[![Configure the SingleSupplierDataSource ObjectDataSource to Use the GetSupplierBySupplierID(supplierID) Method](limiting-data-modification-functionality-based-on-the-user-cs/_static/image20.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image19.png)</span></span>

<span data-ttu-id="1841a-178">**圖 7**：將 `SingleSupplierDataSource` ObjectDataSource 設定為使用 `GetSupplierBySupplierID(supplierID)` 方法（[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-178">**Figure 7**: Configure the `SingleSupplierDataSource` ObjectDataSource to Use the `GetSupplierBySupplierID(supplierID)` Method ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image21.png))</span></span>

<span data-ttu-id="1841a-179">接下來，我們會提示您指定 `GetSupplierBySupplierID(supplierID)` 方法 s `supplierID` 輸入參數的參數來源。</span><span class="sxs-lookup"><span data-stu-id="1841a-179">Next, we re prompted to specify the parameter source for the `GetSupplierBySupplierID(supplierID)` method s `supplierID` input parameter.</span></span> <span data-ttu-id="1841a-180">因為我們想要顯示從 DropDownList 中選取之供應商的資訊，所以請使用 `Suppliers` DropDownList s `SelectedValue` 屬性作為參數來源。</span><span class="sxs-lookup"><span data-stu-id="1841a-180">Since we want to show the information for the supplier selected from the DropDownList, use the `Suppliers` DropDownList s `SelectedValue` property as the parameter source.</span></span>

<span data-ttu-id="1841a-181">[![使用供應商 DropDownList 作為廠商參數來源](limiting-data-modification-functionality-based-on-the-user-cs/_static/image23.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-181">[![Use the Suppliers DropDownList as the supplierID Parameter Source](limiting-data-modification-functionality-based-on-the-user-cs/_static/image23.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image22.png)</span></span>

<span data-ttu-id="1841a-182">**圖 8**：使用 `Suppliers` DropDownList 作為 `supplierID` 參數來源（[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image24.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-182">**Figure 8**: Use the `Suppliers` DropDownList as the `supplierID` Parameter Source ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image24.png))</span></span>

<span data-ttu-id="1841a-183">即使加入此第二個 ObjectDataSource，DetailsView 控制項目前已設定為一律使用 `AllSuppliersDataSource` ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="1841a-183">Even with this second ObjectDataSource added, the DetailsView control is currently configured to always use the `AllSuppliersDataSource` ObjectDataSource.</span></span> <span data-ttu-id="1841a-184">我們需要新增邏輯，以根據選取的 `Suppliers` DropDownList 專案，調整 DetailsView 所使用的資料來源。</span><span class="sxs-lookup"><span data-stu-id="1841a-184">We need to add logic to adjust the data source used by the DetailsView depending on the `Suppliers` DropDownList item selected.</span></span> <span data-ttu-id="1841a-185">若要完成此動作，請建立供應商 DropDownList 的 `SelectedIndexChanged` 事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="1841a-185">To accomplish this, create a `SelectedIndexChanged` event handler for the Suppliers DropDownList.</span></span> <span data-ttu-id="1841a-186">按兩下設計工具中的 DropDownList，即可輕鬆地建立此功能。</span><span class="sxs-lookup"><span data-stu-id="1841a-186">This can most easily be created by double-clicking the DropDownList in the Designer.</span></span> <span data-ttu-id="1841a-187">這個事件處理常式必須判斷要使用的資料來源，而且必須將資料重新系結至 DetailsView。</span><span class="sxs-lookup"><span data-stu-id="1841a-187">This event handler needs to determine what data source to use and must rebind the data to the DetailsView.</span></span> <span data-ttu-id="1841a-188">使用下列程式碼即可完成這項作業：</span><span class="sxs-lookup"><span data-stu-id="1841a-188">This is accomplished with the following code:</span></span>

[!code-csharp[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample3.cs)]

<span data-ttu-id="1841a-189">事件處理常式會從判斷是否已選取 [顯示/編輯所有供應商] 選項開始。</span><span class="sxs-lookup"><span data-stu-id="1841a-189">The event handler begins by determining whether the "Show/Edit ALL Suppliers" option was selected.</span></span> <span data-ttu-id="1841a-190">如果是，則會將 `SupplierDetails` DetailsView s `DataSourceID` 設定為 `AllSuppliersDataSource`，並藉由將 `PageIndex` 屬性設定為0，將使用者傳回給供應商集合中的第一筆記錄。</span><span class="sxs-lookup"><span data-stu-id="1841a-190">If it was, it sets the `SupplierDetails` DetailsView s `DataSourceID` to `AllSuppliersDataSource` and returns the user to the first record in the set of suppliers by setting the `PageIndex` property to 0.</span></span> <span data-ttu-id="1841a-191">不過，如果使用者已從 DropDownList 中選取特定供應商，則 DetailsView s `DataSourceID` 會指派給 `SingleSuppliersDataSource`。</span><span class="sxs-lookup"><span data-stu-id="1841a-191">If, however, the user has selected a particular supplier from the DropDownList, the DetailsView s `DataSourceID` is assigned to `SingleSuppliersDataSource`.</span></span> <span data-ttu-id="1841a-192">不論使用何種資料來源，`SuppliersDetails` 模式都會還原成隻讀模式，而資料會藉由呼叫 `SuppliersDetails` 控制項 s `DataBind()` 方法來重新系結至 DetailsView。</span><span class="sxs-lookup"><span data-stu-id="1841a-192">Regardless of what data source is used, the `SuppliersDetails` mode is reverted back to the read-only mode and the data is rebound to the DetailsView by a call to the `SuppliersDetails` control s `DataBind()` method.</span></span>

<span data-ttu-id="1841a-193">使用此事件處理常式時，除非選取了 [顯示/編輯所有供應商] 選項，否則 DetailsView 控制項現在會顯示選取的供應商，在此情況下，所有供應商都可以透過分頁介面來查看。</span><span class="sxs-lookup"><span data-stu-id="1841a-193">With this event handler in place, the DetailsView control now shows the selected supplier, unless the "Show/Edit ALL Suppliers" option was selected, in which case all of the suppliers can be viewed through the paging interface.</span></span> <span data-ttu-id="1841a-194">[圖 9] 顯示已選取 [顯示/編輯所有供應商] 選項的頁面;請注意，分頁介面存在，可讓使用者造訪和更新任何供應商。</span><span class="sxs-lookup"><span data-stu-id="1841a-194">Figure 9 shows the page with the "Show/Edit ALL Suppliers" option selected; note that the paging interface is present, allowing the user to visit and update any supplier.</span></span> <span data-ttu-id="1841a-195">[圖 10] 顯示已選取 Ma Maison 供應商的頁面。</span><span class="sxs-lookup"><span data-stu-id="1841a-195">Figure 10 shows the page with the Ma Maison supplier selected.</span></span> <span data-ttu-id="1841a-196">在此情況下，只能看到並編輯 Ma Maison 的資訊。</span><span class="sxs-lookup"><span data-stu-id="1841a-196">Only Ma Maison s information is viewable and editable in this case.</span></span>

<span data-ttu-id="1841a-197">[![可以查看和編輯所有供應商資訊](limiting-data-modification-functionality-based-on-the-user-cs/_static/image26.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-197">[![All of the Suppliers Information Can Be Viewed and Edited](limiting-data-modification-functionality-based-on-the-user-cs/_static/image26.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image25.png)</span></span>

<span data-ttu-id="1841a-198">**圖 9**：可以查看和編輯所有供應商資訊（[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image27.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-198">**Figure 9**: All of the Suppliers Information Can Be Viewed and Edited ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image27.png))</span></span>

<span data-ttu-id="1841a-199">[只能查看和編輯所選供應商的資訊 ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image29.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-199">[![Only the Selected Supplier s Information Can Be Viewed and Edited](limiting-data-modification-functionality-based-on-the-user-cs/_static/image29.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image28.png)</span></span>

<span data-ttu-id="1841a-200">**圖 10**：只能查看和編輯選取的供應商資訊（[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image30.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-200">**Figure 10**: Only the Selected Supplier s Information Can Be Viewed and Edited ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image30.png))</span></span>

> [!NOTE]
> <span data-ttu-id="1841a-201">在本教學課程中，DropDownList 和 DetailsView 控制項 `EnableViewState` 都必須設定為 `true` （預設值），因為 DropDownList s `SelectedIndex` 和 DetailsView s `DataSourceID` 屬性 s 變更必須在回傳之間記住。</span><span class="sxs-lookup"><span data-stu-id="1841a-201">For this tutorial, both the DropDownList and DetailsView control s `EnableViewState` must be set to `true` (the default) because the DropDownList s `SelectedIndex` and the DetailsView s `DataSourceID` property s changes must be remembered across postbacks.</span></span>

## <a name="step-4-listing-the-suppliers-products-in-an-editable-gridview"></a><span data-ttu-id="1841a-202">步驟4：在可編輯的 GridView 中列出供應商產品</span><span class="sxs-lookup"><span data-stu-id="1841a-202">Step 4: Listing the Suppliers Products in an Editable GridView</span></span>

<span data-ttu-id="1841a-203">完成 DetailsView 之後，我們的下一步是加入可編輯的 GridView，其中會列出所選供應商所提供的產品。</span><span class="sxs-lookup"><span data-stu-id="1841a-203">With the DetailsView complete, our next step is to include an editable GridView that lists those products provided by the selected supplier.</span></span> <span data-ttu-id="1841a-204">這個 GridView 應該只允許編輯 `ProductName` 和 `QuantityPerUnit` 欄位。</span><span class="sxs-lookup"><span data-stu-id="1841a-204">This GridView should allow edits to only the `ProductName` and `QuantityPerUnit` fields.</span></span> <span data-ttu-id="1841a-205">此外，如果造訪頁面的使用者是來自特定供應商，則只允許更新*未*中止的產品。</span><span class="sxs-lookup"><span data-stu-id="1841a-205">Moreover, if the user visiting the page is from a particular supplier, it should only allow updates to those products that are *not* discontinued.</span></span> <span data-ttu-id="1841a-206">若要完成這項工作，我們必須先加入 `ProductsBLL` 類別 s `UpdateProducts` 方法的多載，只接受 `ProductID`、`ProductName`和 `QuantityPerUnit` 欄位做為輸入。</span><span class="sxs-lookup"><span data-stu-id="1841a-206">To accomplish this we'll need to first add an overload of the `ProductsBLL` class s `UpdateProducts` method that takes in just the `ProductID`, `ProductName`, and `QuantityPerUnit` fields as inputs.</span></span> <span data-ttu-id="1841a-207">我們會在許多教學課程中事先逐步執行此程式，讓我們來看一下此處的程式碼，這應該新增至 `ProductsBLL`：</span><span class="sxs-lookup"><span data-stu-id="1841a-207">We ve stepped through this process beforehand in numerous tutorials, so let s just look at the code here, which should be added to `ProductsBLL`:</span></span>

[!code-csharp[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample4.cs)]

<span data-ttu-id="1841a-208">建立此多載之後，我們就可以準備加入 GridView 控制項及其相關聯的 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="1841a-208">With this overload created, we re ready to add the GridView control and its associated ObjectDataSource.</span></span> <span data-ttu-id="1841a-209">將新的 GridView 新增至頁面，將其 `ID` 屬性設為 `ProductsBySupplier`，並將其設定為使用名為 `ProductsBySupplierDataSource`的新 ObjectDataSource。</span><span class="sxs-lookup"><span data-stu-id="1841a-209">Add a new GridView to the page, set its `ID` property to `ProductsBySupplier`, and configure it to use a new ObjectDataSource named `ProductsBySupplierDataSource`.</span></span> <span data-ttu-id="1841a-210">因為我們想要讓此 GridView 依據選取的供應商列出這些產品，所以請使用 `ProductsBLL` 類別 `GetProductsBySupplierID(supplierID)` 方法。</span><span class="sxs-lookup"><span data-stu-id="1841a-210">Since we want this GridView to list those products by the selected supplier, use the `ProductsBLL` class s `GetProductsBySupplierID(supplierID)` method.</span></span> <span data-ttu-id="1841a-211">也會將 `Update()` 方法對應至我們剛才建立的新 `UpdateProduct` 多載。</span><span class="sxs-lookup"><span data-stu-id="1841a-211">Also map the `Update()` method to the new `UpdateProduct` overload we just created.</span></span>

<span data-ttu-id="1841a-212">[![將 ObjectDataSource 設定為使用剛建立的 UpdateProduct 多載](limiting-data-modification-functionality-based-on-the-user-cs/_static/image32.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-212">[![Configure the ObjectDataSource to Use the UpdateProduct Overload Just Created](limiting-data-modification-functionality-based-on-the-user-cs/_static/image32.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image31.png)</span></span>

<span data-ttu-id="1841a-213">**圖 11**：設定 ObjectDataSource 使用剛建立的 `UpdateProduct` 多載（[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image33.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-213">**Figure 11**: Configure the ObjectDataSource to Use the `UpdateProduct` Overload Just Created ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image33.png))</span></span>

<span data-ttu-id="1841a-214">系統會提示您選取 `GetProductsBySupplierID(supplierID)` 方法 s `supplierID` 輸入參數的參數來源。</span><span class="sxs-lookup"><span data-stu-id="1841a-214">We re prompted to select the parameter source for the `GetProductsBySupplierID(supplierID)` method s `supplierID` input parameter.</span></span> <span data-ttu-id="1841a-215">因為我們想要顯示在 DetailsView 中所選供應商的產品，所以請使用 [`SuppliersDetails` DetailsView 控制項] `SelectedValue` 屬性作為參數來源。</span><span class="sxs-lookup"><span data-stu-id="1841a-215">Since we want to show the products for the supplier selected in the DetailsView, use the `SuppliersDetails` DetailsView control s `SelectedValue` property as the parameter source.</span></span>

<span data-ttu-id="1841a-216">[![使用 SuppliersDetails DetailsView s SelectedValue 屬性作為參數來源](limiting-data-modification-functionality-based-on-the-user-cs/_static/image35.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image34.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-216">[![Use the SuppliersDetails DetailsView s SelectedValue Property as the Parameter Source](limiting-data-modification-functionality-based-on-the-user-cs/_static/image35.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image34.png)</span></span>

<span data-ttu-id="1841a-217">**圖 12**：使用 `SuppliersDetails` DetailsView s `SelectedValue` 屬性做為參數來源（[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image36.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-217">**Figure 12**: Use the `SuppliersDetails` DetailsView s `SelectedValue` Property as the Parameter Source ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image36.png))</span></span>

<span data-ttu-id="1841a-218">返回 GridView，移除 `ProductName`、`QuantityPerUnit`和 `Discontinued`以外的所有 GridView 欄位，並將 `Discontinued` CheckBoxField 標記為唯讀。</span><span class="sxs-lookup"><span data-stu-id="1841a-218">Returning to the GridView, remove all of the GridView fields except for `ProductName`, `QuantityPerUnit`, and `Discontinued`, marking the `Discontinued` CheckBoxField as read-only.</span></span> <span data-ttu-id="1841a-219">此外，請檢查 GridView s 智慧標籤的 [啟用編輯] 選項。</span><span class="sxs-lookup"><span data-stu-id="1841a-219">Also, check the Enable Editing option from the GridView s smart tag.</span></span> <span data-ttu-id="1841a-220">進行這些變更之後，GridView 和 ObjectDataSource 的宣告式標記看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="1841a-220">After these changes have been made, the declarative markup for the GridView and ObjectDataSource should look similar to the following:</span></span>

[!code-aspx[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample5.aspx)]

<span data-ttu-id="1841a-221">如同先前的 ObjectDataSources，這個 `OldValuesParameterFormatString` 屬性會設定為 `original_{0}`，這會在嘗試更新產品的名稱或每個單位的數量時造成問題。</span><span class="sxs-lookup"><span data-stu-id="1841a-221">As with our previous ObjectDataSources, this one s `OldValuesParameterFormatString` property is set to `original_{0}`, which will cause problems when attempting to update a product s name or quantity per unit.</span></span> <span data-ttu-id="1841a-222">請將此屬性從宣告式語法全部移除，或將它設定為預設值 `{0}`。</span><span class="sxs-lookup"><span data-stu-id="1841a-222">Remove this property from the declarative syntax altogether or set it to its default, `{0}`.</span></span>

<span data-ttu-id="1841a-223">完成此設定後，我們的頁面現在會列出 GridView 中所選供應商所提供的產品（請參閱 [圖 13]）。</span><span class="sxs-lookup"><span data-stu-id="1841a-223">With this configuration complete, our page now lists the products provided by the supplier selected in the GridView (see Figure 13).</span></span> <span data-ttu-id="1841a-224">目前，每個單位的*任何*產品名稱或數量都可以更新。</span><span class="sxs-lookup"><span data-stu-id="1841a-224">Currently *any* product s name or quantity per unit can be updated.</span></span> <span data-ttu-id="1841a-225">不過，我們需要更新頁面邏輯，讓與特定供應商相關聯之使用者的已停止產品可以使用這類功能。</span><span class="sxs-lookup"><span data-stu-id="1841a-225">However, we need to update our page logic so that such functionality is prohibited for discontinued products for users associated with a particular supplier.</span></span> <span data-ttu-id="1841a-226">我們會在步驟5中解決這最後這一件。</span><span class="sxs-lookup"><span data-stu-id="1841a-226">We'll tackle this final piece in Step 5.</span></span>

<span data-ttu-id="1841a-227">[顯示所選供應商所提供的產品 ![](limiting-data-modification-functionality-based-on-the-user-cs/_static/image38.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-227">[![The Products Provided by the Selected Supplier are Displayed](limiting-data-modification-functionality-based-on-the-user-cs/_static/image38.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image37.png)</span></span>

<span data-ttu-id="1841a-228">**圖 13**：顯示所選供應商所提供的產品（[按一下以觀看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image39.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-228">**Figure 13**: The Products Provided by the Selected Supplier are Displayed ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image39.png))</span></span>

> [!NOTE]
> <span data-ttu-id="1841a-229">加入這個可編輯的 GridView 之後，就應該更新 `Suppliers` DropDownList s `SelectedIndexChanged` 事件處理常式，使 GridView 回到唯讀狀態。</span><span class="sxs-lookup"><span data-stu-id="1841a-229">With the addition of this editable GridView the `Suppliers` DropDownList s `SelectedIndexChanged` event handler should be updated to return the GridView to a read-only state.</span></span> <span data-ttu-id="1841a-230">否則，如果在編輯產品資訊時選取不同的供應商，則在 GridView 中，新供應商的對應索引也會是可編輯的。</span><span class="sxs-lookup"><span data-stu-id="1841a-230">Otherwise, if a different supplier is selected while in the middle of editing product information, the corresponding index in the GridView for the new supplier will also be editable.</span></span> <span data-ttu-id="1841a-231">若要避免這種情況，只要將 GridView 的 `EditIndex` 屬性設定為 `SelectedIndexChanged` 事件處理常式中的 `-1` 即可。</span><span class="sxs-lookup"><span data-stu-id="1841a-231">To prevent this, simply set the GridView s `EditIndex` property to `-1` in the `SelectedIndexChanged` event handler.</span></span>

<span data-ttu-id="1841a-232">此外，請記得要啟用 GridView s 檢視狀態（預設行為）是很重要的。</span><span class="sxs-lookup"><span data-stu-id="1841a-232">Also, recall that it is important that the GridView s view state be enabled (the default behavior).</span></span> <span data-ttu-id="1841a-233">如果您將 GridView 的 `EnableViewState` 屬性設定為 `false`，就會面臨並行使用者不小心刪除或編輯記錄的風險。</span><span class="sxs-lookup"><span data-stu-id="1841a-233">If you set the GridView s `EnableViewState` property to `false`, you run the risk of having concurrent users unintentionally deleting or editing records.</span></span> <span data-ttu-id="1841a-234">如需詳細資訊，請參閱[警告： ASP.NET 2.0 gridview/DetailsView/FormViews 的並行問題，其支援編輯及/或刪除，且已停用檢視狀態](http://scottonwriting.net/sowblog/posts/10054.aspx)。</span><span class="sxs-lookup"><span data-stu-id="1841a-234">See [WARNING: Concurrency Issue with ASP.NET 2.0 GridViews/DetailsView/FormViews that Support Editing and/or Deleting and Whose View State is Disabled](http://scottonwriting.net/sowblog/posts/10054.aspx) for more information.</span></span>

## <a name="step-5-disallow-editing-for-discontinued-products-when-showedit-all-suppliers-is-not-selected"></a><span data-ttu-id="1841a-235">步驟5：未選取 [顯示/編輯所有供應商] 時，不允許編輯已停止的產品</span><span class="sxs-lookup"><span data-stu-id="1841a-235">Step 5: Disallow Editing for Discontinued Products When Show/Edit ALL Suppliers is Not Selected</span></span>

<span data-ttu-id="1841a-236">雖然 `ProductsBySupplier` GridView 完全正常運作，但它目前會授與來自特定供應商的使用者過多的存取權。</span><span class="sxs-lookup"><span data-stu-id="1841a-236">While the `ProductsBySupplier` GridView is fully functional, it currently grants too much access to those users who are from a particular supplier.</span></span> <span data-ttu-id="1841a-237">根據我們的商務規則，這類使用者應該無法更新已停止的產品。</span><span class="sxs-lookup"><span data-stu-id="1841a-237">Per our business rules, such users should not be able to update discontinued products.</span></span> <span data-ttu-id="1841a-238">若要強制執行這項工作，我們可以在使用者從供應商造訪頁面時，隱藏（或停用）那些 GridView 資料列中的 [編輯] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="1841a-238">To enforce this, we can hide (or disable) the Edit button in those GridView rows with discontinued products when the page is being visited by a user from a supplier.</span></span>

<span data-ttu-id="1841a-239">建立 GridView s `RowDataBound` 事件的事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="1841a-239">Create an event handler for the GridView s `RowDataBound` event.</span></span> <span data-ttu-id="1841a-240">在此事件處理常式中，我們需要判斷使用者是否與特定供應商相關聯，在本教學課程中，您可以藉由檢查供應商 DropDownList s `SelectedValue` 屬性（如果它不是-1）來決定是否要將使用者與特定供應商相關聯。</span><span class="sxs-lookup"><span data-stu-id="1841a-240">In this event handler we need to determine whether or not the user is associated with a particular supplier, which, for this tutorial, can be determined by checking the Suppliers DropDownList s `SelectedValue` property - if it s something other than -1, then the user is associated with a particular supplier.</span></span> <span data-ttu-id="1841a-241">針對這類使用者，我們必須判斷產品是否已停止。</span><span class="sxs-lookup"><span data-stu-id="1841a-241">For such users, we then need to determine whether or not the product is discontinued.</span></span> <span data-ttu-id="1841a-242">我們可以透過 `e.Row.DataItem` 屬性抓取與 GridView 資料列系結的實際 `ProductRow` 實例的參考，如在[*gridview 的頁尾中顯示摘要資訊*](../custom-formatting/displaying-summary-information-in-the-gridview-s-footer-cs.md)教學課程中所述。</span><span class="sxs-lookup"><span data-stu-id="1841a-242">We can grab a reference to the actual `ProductRow` instance bound to the GridView row via the `e.Row.DataItem` property, as discussed in the [*Displaying Summary Information in the GridView s Footer*](../custom-formatting/displaying-summary-information-in-the-gridview-s-footer-cs.md) tutorial.</span></span> <span data-ttu-id="1841a-243">如果產品已停產，我們可以使用上一個教學課程中所討論的技巧，在 GridView CommandField 中抓取 [編輯] 按鈕的程式設計參考，並在[*刪除時新增用戶端確認*](adding-client-side-confirmation-when-deleting-cs.md)。</span><span class="sxs-lookup"><span data-stu-id="1841a-243">If the product is discontinued, we can grab a programmatic reference to the Edit button in the GridView s CommandField using the techniques discussed in the previous tutorial, [*Adding Client-Side Confirmation When Deleting*](adding-client-side-confirmation-when-deleting-cs.md).</span></span> <span data-ttu-id="1841a-244">我們有了參考之後，就可以隱藏或停用按鈕。</span><span class="sxs-lookup"><span data-stu-id="1841a-244">Once we have a reference we can then hide or disable the button.</span></span>

[!code-csharp[Main](limiting-data-modification-functionality-based-on-the-user-cs/samples/sample6.cs)]

<span data-ttu-id="1841a-245">當此事件處理常式已就緒時，以特定供應商的使用者身分造訪此頁面時，將無法編輯已停止的產品，因為這些產品的 [編輯] 按鈕已隱藏。</span><span class="sxs-lookup"><span data-stu-id="1841a-245">With this event handler in place, when visiting this page as a user from a specific supplier those products that are discontinued are not editable, as the Edit button is hidden for these products.</span></span> <span data-ttu-id="1841a-246">例如，Chef Anton s Gumbo Mix 是新奧爾良 Cajun 樂趣供應商的已中止產品。</span><span class="sxs-lookup"><span data-stu-id="1841a-246">For example, Chef Anton s Gumbo Mix is a discontinued product for the New Orleans Cajun Delights supplier.</span></span> <span data-ttu-id="1841a-247">造訪此特定供應商的頁面時，會隱藏此產品的 [編輯] 按鈕（請參閱 [圖 14]）。</span><span class="sxs-lookup"><span data-stu-id="1841a-247">When visiting the page for this particular supplier, the Edit button for this product is hidden from sight (see Figure 14).</span></span> <span data-ttu-id="1841a-248">不過，當您使用 [顯示/編輯所有供應商] 進行流覽時，可以使用 [編輯] 按鈕（請參閱 [圖 15]）。</span><span class="sxs-lookup"><span data-stu-id="1841a-248">However, when visiting using the "Show/Edit ALL Suppliers," the Edit button is available (see Figure 15).</span></span>

<span data-ttu-id="1841a-249">[適用于供應商專屬使用者的 ![[Chef Anton s Gumbo Mix] 的 [編輯] 按鈕已隱藏](limiting-data-modification-functionality-based-on-the-user-cs/_static/image41.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image40.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-249">[![For Supplier-Specific Users the Edit Button for Chef Anton s Gumbo Mix is Hidden](limiting-data-modification-functionality-based-on-the-user-cs/_static/image41.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image40.png)</span></span>

<span data-ttu-id="1841a-250">**圖 14**：對於供應商專屬的使用者，[Chef Anton s Gumbo Mix] 的 [編輯] 按鈕是隱藏的（[按一下以觀看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image42.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-250">**Figure 14**: For Supplier-Specific Users the Edit Button for Chef Anton s Gumbo Mix is Hidden ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image42.png))</span></span>

<span data-ttu-id="1841a-251">[![顯示/編輯所有供應商使用者，會顯示 [Chef Anton s Gumbo Mix] 的 [編輯] 按鈕](limiting-data-modification-functionality-based-on-the-user-cs/_static/image44.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="1841a-251">[![For Show/Edit ALL Suppliers Users, the Edit Button for Chef Anton s Gumbo Mix is Displayed](limiting-data-modification-functionality-based-on-the-user-cs/_static/image44.png)](limiting-data-modification-functionality-based-on-the-user-cs/_static/image43.png)</span></span>

<span data-ttu-id="1841a-252">**圖 15**：針對 [顯示/編輯所有供應商使用者]，會顯示 [Chef Anton s Gumbo Mix] 的 [編輯] 按鈕（[按一下以查看完整大小的影像](limiting-data-modification-functionality-based-on-the-user-cs/_static/image45.png)）</span><span class="sxs-lookup"><span data-stu-id="1841a-252">**Figure 15**: For Show/Edit ALL Suppliers Users, the Edit Button for Chef Anton s Gumbo Mix is Displayed ([Click to view full-size image](limiting-data-modification-functionality-based-on-the-user-cs/_static/image45.png))</span></span>

## <a name="checking-for-access-rights-in-the-business-logic-layer"></a><span data-ttu-id="1841a-253">檢查商務邏輯層中的存取權限</span><span class="sxs-lookup"><span data-stu-id="1841a-253">Checking for Access Rights in the Business Logic Layer</span></span>

<span data-ttu-id="1841a-254">在本教學課程中，ASP.NET 網頁會處理有關使用者可以看到哪些資訊以及可以更新哪些產品的所有邏輯。</span><span class="sxs-lookup"><span data-stu-id="1841a-254">In this tutorial the ASP.NET page handles all logic with regards to what information the user can see and what products he can update.</span></span> <span data-ttu-id="1841a-255">在理想的情況下，此邏輯也會出現在商務邏輯層。</span><span class="sxs-lookup"><span data-stu-id="1841a-255">Ideally, this logic would also be present at the Business Logic Layer.</span></span> <span data-ttu-id="1841a-256">例如，`SuppliersBLL` 類別 `GetSuppliers()` 方法（傳回所有供應商）可能包括檢查，以確保目前登入的使用者*沒有*與特定供應商相關聯。</span><span class="sxs-lookup"><span data-stu-id="1841a-256">For example, the `SuppliersBLL` class s `GetSuppliers()` method (which returns all suppliers) might include a check to ensure that the currently logged on user is *not* associated with a specific supplier.</span></span> <span data-ttu-id="1841a-257">同樣地，`UpdateSupplierAddress` 方法可能會包含檢查，以確保目前登入的使用者可以在公司中運作（因此可以更新所有供應商位址資訊），或與資料正在更新的供應商相關聯。</span><span class="sxs-lookup"><span data-stu-id="1841a-257">Likewise, the `UpdateSupplierAddress` method could include a check to ensure that the currently logged on user either worked for our company (and therefore can update all suppliers address information) or is associated with the supplier whose data is being updated.</span></span>

<span data-ttu-id="1841a-258">我在本教學課程中並未包含這類 BLL 層檢查，因為在我們的教學課程中，使用者的權利是由頁面上的 DropDownList （BLL 類別無法存取）所決定。</span><span class="sxs-lookup"><span data-stu-id="1841a-258">I did not include such BLL-layer checks here because in our tutorial the user s rights are determined by a DropDownList on the page, which the BLL classes cannot access.</span></span> <span data-ttu-id="1841a-259">使用成員資格系統或 ASP.NET 提供的其中一種驗證配置（例如 Windows 驗證）時，可以從 BLL 存取目前登入的使用者資訊和角色資訊，進而進行這類存取在簡報和 BLL 層級都可以進行許可權檢查。</span><span class="sxs-lookup"><span data-stu-id="1841a-259">When using the membership system or one of the out-of-the box authentication schemes provided by ASP.NET (such as Windows authentication), the currently logged on user s information and roles information can be accessed from the BLL, thereby making such access rights checks possible at both the presentation and BLL layers.</span></span>

## <a name="summary"></a><span data-ttu-id="1841a-260">總結</span><span class="sxs-lookup"><span data-stu-id="1841a-260">Summary</span></span>

<span data-ttu-id="1841a-261">大部分提供使用者帳戶的網站，都必須根據登入的使用者自訂資料修改介面。</span><span class="sxs-lookup"><span data-stu-id="1841a-261">Most sites that provide user accounts need to customize the data modification interface based upon the logged in user.</span></span> <span data-ttu-id="1841a-262">系統管理使用者可能可以刪除和編輯任何記錄，而非系統管理使用者可能會受到限制，只能更新或刪除本身自行建立的記錄。</span><span class="sxs-lookup"><span data-stu-id="1841a-262">Administrative users may be able to delete and edit any record, whereas non-administrative users may be limited to only updating or deleting records they created themselves.</span></span> <span data-ttu-id="1841a-263">無論是哪種情況，都可以擴充資料 Web 控制項、ObjectDataSource 和商務邏輯層類別，以根據登入的使用者來新增或拒絕特定功能。</span><span class="sxs-lookup"><span data-stu-id="1841a-263">Whatever the scenario may be, the data Web controls, ObjectDataSource, and Business Logic Layer classes can be extended to add or deny certain functionality based on the logged on user.</span></span> <span data-ttu-id="1841a-264">在本教學課程中，我們已瞭解如何根據使用者是否與特定供應商相關聯，或是否適用于我們的公司，來限制可查看和可編輯的資料。</span><span class="sxs-lookup"><span data-stu-id="1841a-264">In this tutorial we saw how to limit the viewable and editable data depending on whether the user was associated with a particular supplier or if they worked for our company.</span></span>

<span data-ttu-id="1841a-265">本教學課程將說明如何使用 GridView、DetailsView 和 FormView 控制項來插入、更新和刪除資料。</span><span class="sxs-lookup"><span data-stu-id="1841a-265">This tutorial concludes our examination of inserting, updating, and deleting data using the GridView, DetailsView, and FormView controls.</span></span> <span data-ttu-id="1841a-266">從下一個教學課程開始，我們會將我們的注意力轉向新增分頁和排序支援。</span><span class="sxs-lookup"><span data-stu-id="1841a-266">Starting with the next tutorial, we'll turn our attention to adding paging and sorting support.</span></span>

<span data-ttu-id="1841a-267">快樂的程式設計！</span><span class="sxs-lookup"><span data-stu-id="1841a-267">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="1841a-268">關於作者</span><span class="sxs-lookup"><span data-stu-id="1841a-268">About the Author</span></span>

<span data-ttu-id="1841a-269">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，自1998起，有七個 ASP/ASP. NET 書籍和創辦人的[4GuysFromRolla.com](http://www.4guysfromrolla.com)。</span><span class="sxs-lookup"><span data-stu-id="1841a-269">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="1841a-270">Scott 以獨立的顧問、訓練員和作者的身分運作。</span><span class="sxs-lookup"><span data-stu-id="1841a-270">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="1841a-271">他的最新著作是[*在24小時內讓自己的 ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="1841a-271">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="1841a-272">他可以在mitchell@4GuysFromRolla.com觸達[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="1841a-272">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="1841a-273">或者透過他的 blog，可以在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)找到。</span><span class="sxs-lookup"><span data-stu-id="1841a-273">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="1841a-274">[上一頁](adding-client-side-confirmation-when-deleting-cs.md)
> [下一頁](an-overview-of-inserting-updating-and-deleting-data-vb.md)</span><span class="sxs-lookup"><span data-stu-id="1841a-274">[Previous](adding-client-side-confirmation-when-deleting-cs.md)
[Next](an-overview-of-inserting-updating-and-deleting-data-vb.md)</span></span>
