---
uid: web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-vb
title: 新增記錄時包含檔案上傳選項（VB） |Microsoft Docs
author: rick-anderson
description: 本教學課程說明如何建立 Web 介面，讓使用者可以輸入文字資料並上傳二進位檔案。 說明可用的選項 t 。
ms.author: riande
ms.date: 03/27/2007
ms.assetid: 5776281d-4637-4d1e-a65b-2621d2cade44
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-vb
msc.type: authoredcontent
ms.openlocfilehash: 8edaf1754eddd7b03f1c323d1bee13238582fc99
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/28/2019
ms.locfileid: "74597051"
---
# <a name="including-a-file-upload-option-when-adding-a-new-record-vb"></a><span data-ttu-id="9f0a1-104">新增記錄時包含檔案上傳選項 (VB)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-104">Including a File Upload Option When Adding a New Record (VB)</span></span>

<span data-ttu-id="9f0a1-105">由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="9f0a1-106">[下載範例應用程式](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_VB.exe)或[下載 PDF](including-a-file-upload-option-when-adding-a-new-record-vb/_static/datatutorial56vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-106">[Download Sample App](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_VB.exe) or [Download PDF](including-a-file-upload-option-when-adding-a-new-record-vb/_static/datatutorial56vb1.pdf)</span></span>

> <span data-ttu-id="9f0a1-107">本教學課程說明如何建立 Web 介面，讓使用者可以輸入文字資料並上傳二進位檔案。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-107">This tutorial shows how to create a Web interface that allows the user to both enter text data and upload binary files.</span></span> <span data-ttu-id="9f0a1-108">為了說明可用來儲存二進位資料的選項，其中一個檔案會儲存在資料庫中，而另一個檔案則儲存在檔案系統中。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-108">To illustrate the options available to store binary data, one file will be saved in the database while the other is stored in the file system.</span></span>

## <a name="introduction"></a><span data-ttu-id="9f0a1-109">簡介</span><span class="sxs-lookup"><span data-stu-id="9f0a1-109">Introduction</span></span>

<span data-ttu-id="9f0a1-110">在前兩個教學課程中，我們探討了用來儲存與應用程式資料模型相關聯之二進位資料的技巧，看看如何使用 FileUpload 控制項將檔案從用戶端傳送至 web 伺服器，並瞭解如何在資料中呈現此二進位資料（W）eb 控制項。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-110">In the previous two tutorials we explored techniques for storing binary data that is associated with the application s data model, looked at how to use the FileUpload control to send files from the client to the web server, and saw how to present this binary data in a data Web control.</span></span> <span data-ttu-id="9f0a1-111">不過，我們還在討論如何將上傳的資料與資料模型產生關聯。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-111">We ve yet to talk about how to associate uploaded data with the data model, though.</span></span>

<span data-ttu-id="9f0a1-112">在本教學課程中，我們將建立網頁來加入新的類別。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-112">In this tutorial we will create a web page to add a new category.</span></span> <span data-ttu-id="9f0a1-113">除了分類的 [名稱] 和 [描述] 文字方塊以外，此頁面還需要包含兩個 FileUpload 控制項，其中一個用於新的分類圖片，另一個用於手冊。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-113">In addition to TextBoxes for the category s name and description, this page will need to include two FileUpload controls one for the new category s picture and one for the brochure.</span></span> <span data-ttu-id="9f0a1-114">上傳的圖片會直接儲存在新的 [記錄] `Picture` 資料行中，而該手冊會儲存至 [`~/Brochures`] 資料夾，其中包含儲存在 [新記錄] `BrochurePath` 資料行中的檔案路徑。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-114">The uploaded picture will be stored directly in the new record s `Picture` column, whereas the brochure will be saved to the `~/Brochures` folder with the path to the file saved in the new record s `BrochurePath` column.</span></span>

<span data-ttu-id="9f0a1-115">建立這個新的網頁之前，我們必須先更新架構。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-115">Before creating this new web page, we'll need to update the architecture.</span></span> <span data-ttu-id="9f0a1-116">`CategoriesTableAdapter` s 的主要查詢不會抓取 `Picture` 資料行。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-116">The `CategoriesTableAdapter` s main query does not retrieve the `Picture` column.</span></span> <span data-ttu-id="9f0a1-117">因此，自動產生的 `Insert` 方法只會有 `CategoryName`、`Description`和 `BrochurePath` 欄位的輸入。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-117">Consequently, the auto-generated `Insert` method only has inputs for the `CategoryName`, `Description`, and `BrochurePath` fields.</span></span> <span data-ttu-id="9f0a1-118">因此，我們需要在 TableAdapter 中建立額外的方法，以提示所有四個 `Categories` 欄位。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-118">Therefore, we need to create an additional method in the TableAdapter that prompts for all four `Categories` fields.</span></span> <span data-ttu-id="9f0a1-119">商務邏輯層中的 `CategoriesBLL` 類別也需要更新。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-119">The `CategoriesBLL` class in the Business Logic Layer will also need to be updated.</span></span>

## <a name="step-1-adding-aninsertwithpicturemethod-to-thecategoriestableadapter"></a><span data-ttu-id="9f0a1-120">步驟1：將`InsertWithPicture`方法加入至`CategoriesTableAdapter`</span><span class="sxs-lookup"><span data-stu-id="9f0a1-120">Step 1: Adding an`InsertWithPicture`Method to the`CategoriesTableAdapter`</span></span>

<span data-ttu-id="9f0a1-121">當我們在[建立資料存取層](../introduction/creating-a-data-access-layer-vb.md)教學課程中建立了 `CategoriesTableAdapter` 時，我們已將它設定為根據主要查詢自動產生 `INSERT`、`UPDATE`和 `DELETE` 語句。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-121">When we created the `CategoriesTableAdapter` back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) tutorial, we configured it to automatically generate `INSERT`, `UPDATE`, and `DELETE` statements based on the main query.</span></span> <span data-ttu-id="9f0a1-122">此外，我們會指示 TableAdapter 採用 DB 直接方法，這會建立方法 `Insert`、`Update`和 `Delete`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-122">Moreover, we instructed the TableAdapter to employ the DB Direct approach, which created the methods `Insert`, `Update`, and `Delete`.</span></span> <span data-ttu-id="9f0a1-123">這些方法會執行自動產生的 `INSERT`、`UPDATE`和 `DELETE` 語句，因此，會根據主要查詢所傳回的資料行來接受輸入參數。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-123">These methods execute the auto-generated `INSERT`, `UPDATE`, and `DELETE` statements and, consequently, accept input parameters based on the columns returned by the main query.</span></span> <span data-ttu-id="9f0a1-124">在 [[上傳](uploading-files-vb.md)檔案] 教學課程中，我們增強了 `CategoriesTableAdapter` s 主查詢，以使用 [`BrochurePath`] 資料行。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-124">In the [Uploading Files](uploading-files-vb.md) tutorial we augmented the `CategoriesTableAdapter` s main query to use the `BrochurePath` column.</span></span>

<span data-ttu-id="9f0a1-125">由於 `CategoriesTableAdapter` s 主查詢不會參考 `Picture` 的資料行，因此我們不可以加入新的記錄，也不會使用 [`Picture`] 資料行的值來更新現有的記錄。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-125">Since the `CategoriesTableAdapter` s main query does not reference the `Picture` column, we can neither add a new record nor update an existing record with a value for the `Picture` column.</span></span> <span data-ttu-id="9f0a1-126">為了捕捉這項資訊，我們可以在 TableAdapter 中建立新的方法，專門用來插入含有二進位資料的記錄，或者我們可以自訂自動產生的 `INSERT` 語句。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-126">In order to capture this information, we can either create a new method in the TableAdapter that is used specifically to insert a record with binary data or we can customize the auto-generated `INSERT` statement.</span></span> <span data-ttu-id="9f0a1-127">自訂自動產生的 `INSERT` 語句的問題是，我們會在嚮導覆寫我們的自訂時有風險。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-127">The problem with customizing the auto-generated `INSERT` statement is that we risk having our customizations overwritten by the wizard.</span></span> <span data-ttu-id="9f0a1-128">例如，假設我們已自訂 `INSERT` 語句，以包含 `Picture` 資料行的使用。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-128">For example, imagine that we customized the `INSERT` statement to include use of the `Picture` column.</span></span> <span data-ttu-id="9f0a1-129">這會更新 TableAdapter 的 `Insert` 方法，使其包含分類 s 圖片的二進位資料的額外輸入參數。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-129">This would update the TableAdapter s `Insert` method to include an additional input parameter for the category s picture s binary data.</span></span> <span data-ttu-id="9f0a1-130">然後，我們可以在商務邏輯層中建立方法，以使用此 DAL 方法，並透過展示層叫用這個 BLL 方法，而所有作業都 wonderfully。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-130">We could then create a method in the Business Logic Layer to use this DAL method and invoke this BLL method through the Presentation Layer, and everything would work wonderfully.</span></span> <span data-ttu-id="9f0a1-131">也就是，直到下一次透過 [TableAdapter 設定] [嚮導] 設定 TableAdapter 為止。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-131">That is, until the next time we configured the TableAdapter through the TableAdapter Configuration wizard.</span></span> <span data-ttu-id="9f0a1-132">當 wizard 完成時，就會覆寫 `INSERT` 語句的自訂，`Insert` 方法會還原成舊的表單，而我們的程式碼將不再編譯！</span><span class="sxs-lookup"><span data-stu-id="9f0a1-132">As soon as the wizard completed, our customizations to the `INSERT` statement would be overwritten, the `Insert` method would revert to its old form, and our code would no longer compile!</span></span>

> [!NOTE]
> <span data-ttu-id="9f0a1-133">當您使用預存程式而非臨機操作 SQL 語句時，這項干擾不會發生問題。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-133">This annoyance is a non-issue when using stored procedures instead of ad-hoc SQL statements.</span></span> <span data-ttu-id="9f0a1-134">未來的教學課程將探索如何使用預存程式代替資料存取層中的臨機操作 SQL 語句。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-134">A future tutorial will explore using stored procedures in lieu of ad-hoc SQL statements in the Data Access Layer.</span></span>

<span data-ttu-id="9f0a1-135">若要避免這種可能的麻煩，而不是自訂自動產生的 SQL 語句，請改為建立 TableAdapter 的新方法。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-135">To avoid this potential headache, rather than customizing the auto-generated SQL statements let s instead create a new method for the TableAdapter.</span></span> <span data-ttu-id="9f0a1-136">這個名為 `InsertWithPicture`的方法會接受 `CategoryName`、`Description`、`BrochurePath`和 `Picture` 資料行的值，並執行 `INSERT` 語句，將全部四個值儲存在新的記錄中。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-136">This method, named `InsertWithPicture`, will accept values for the `CategoryName`, `Description`, `BrochurePath`, and `Picture` columns and execute an `INSERT` statement that stores all four values in a new record.</span></span>

<span data-ttu-id="9f0a1-137">開啟具類型的資料集，然後從設計工具中，以滑鼠右鍵按一下 [`CategoriesTableAdapter`] 標頭，然後從內容功能表選擇 [加入查詢]。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-137">Open the Typed DataSet and, from the Designer, right-click on the `CategoriesTableAdapter` s header and choose Add Query from the context menu.</span></span> <span data-ttu-id="9f0a1-138">這會啟動 [TableAdapter 查詢設定] Wizard，其一開始會詢問 TableAdapter 查詢應該如何存取資料庫。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-138">This launches the TableAdapter Query Configuration Wizard, which begins by asking us how the TableAdapter query should access the database.</span></span> <span data-ttu-id="9f0a1-139">選擇 [使用 SQL 語句]，然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-139">Choose Use SQL statements and click Next.</span></span> <span data-ttu-id="9f0a1-140">下一個步驟會提示您輸入要產生的查詢類型。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-140">The next step prompts for the type of query to be generated.</span></span> <span data-ttu-id="9f0a1-141">因為我們會重新建立查詢，以便將新記錄加入 `Categories` 資料表中，請選擇 [插入]，然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-141">Since we re creating a query to add a new record to the `Categories` table, choose INSERT and click Next.</span></span>

<span data-ttu-id="9f0a1-142">[![選取 [插入] 選項](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-142">[![Select the INSERT Option](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.png)</span></span>

<span data-ttu-id="9f0a1-143">**圖 1**：選取 [插入] 選項（[按一下以查看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-143">**Figure 1**: Select the INSERT Option ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.png))</span></span>

<span data-ttu-id="9f0a1-144">我們現在需要指定 `INSERT` SQL 語句。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-144">We now need to specify the `INSERT` SQL statement.</span></span> <span data-ttu-id="9f0a1-145">Wizard 會自動建議與 TableAdapter s 主查詢對應的 `INSERT` 語句。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-145">The wizard automatically suggests an `INSERT` statement corresponding to the TableAdapter s main query.</span></span> <span data-ttu-id="9f0a1-146">在此情況下，它是插入 `CategoryName`、`Description`和 `BrochurePath` 值的 `INSERT` 語句。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-146">In this case, it s an `INSERT` statement that inserts the `CategoryName`, `Description`, and `BrochurePath` values.</span></span> <span data-ttu-id="9f0a1-147">更新語句，讓 `Picture` 資料行連同 `@Picture` 參數一起包含，如下所示：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-147">Update the statement so that the `Picture` column is included along with a `@Picture` parameter, like so:</span></span>

[!code-sql[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample1.sql)]

<span data-ttu-id="9f0a1-148">Wizard 的最後一個畫面會要求我們將新的 TableAdapter 方法命名為。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-148">The final screen of the wizard asks us to name the new TableAdapter method.</span></span> <span data-ttu-id="9f0a1-149">輸入 `InsertWithPicture`，然後按一下 [完成]。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-149">Enter `InsertWithPicture` and click Finish.</span></span>

<span data-ttu-id="9f0a1-150">[![命名新的 TableAdapter 方法 InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-150">[![Name the New TableAdapter Method InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.png)</span></span>

<span data-ttu-id="9f0a1-151">**圖 2**：將新的 TableAdapter 方法命名 `InsertWithPicture` （[按一下以查看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-151">**Figure 2**: Name the New TableAdapter Method `InsertWithPicture` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.png))</span></span>

## <a name="step-2-updating-the-business-logic-layer"></a><span data-ttu-id="9f0a1-152">步驟2：更新商務邏輯層</span><span class="sxs-lookup"><span data-stu-id="9f0a1-152">Step 2: Updating the Business Logic Layer</span></span>

<span data-ttu-id="9f0a1-153">因為展示層應該只與商務邏輯層互動，而不是略過它直接進入資料存取層，所以我們需要建立一個會叫用剛才建立之 DAL 方法的 BLL 方法（`InsertWithPicture`）。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-153">Since the Presentation Layer should only interface with the Business Logic Layer rather than bypassing it to go directly to the Data Access Layer, we need to create a BLL method that invokes the DAL method we just created (`InsertWithPicture`).</span></span> <span data-ttu-id="9f0a1-154">在本教學課程中，請在名為 `InsertWithPicture` 的 `CategoriesBLL` 類別中建立方法，以接受做為輸入三 `String` s 和 `Byte` 陣列。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-154">For this tutorial, create a method in the `CategoriesBLL` class named `InsertWithPicture` that accepts as input three `String` s and a `Byte` array.</span></span> <span data-ttu-id="9f0a1-155">`String` 輸入參數適用于類別目錄的名稱、描述和手冊檔案路徑，而 `Byte` 陣列則適用于類別目錄圖片的二進位內容。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-155">The `String` input parameters are for the category s name, description, and brochure file path, while the `Byte` array is for the binary contents of the category s picture.</span></span> <span data-ttu-id="9f0a1-156">如下列程式碼所示，這個 BLL 方法會叫用對應的 DAL 方法：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-156">As the following code shows, this BLL method invokes the corresponding DAL method:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample2.vb)]

> [!NOTE]
> <span data-ttu-id="9f0a1-157">將 `InsertWithPicture` 方法加入至 BLL 之前，請確定您已儲存具類型的資料集。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-157">Make sure that you have saved the Typed DataSet before adding the `InsertWithPicture` method to the BLL.</span></span> <span data-ttu-id="9f0a1-158">由於會根據具類型的資料集自動產生 `CategoriesTableAdapter` 類別程式碼，因此，如果您不先將變更儲存至具類型的資料集，`Adapter` 屬性就不會知道 `InsertWithPicture` 方法的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-158">Since the `CategoriesTableAdapter` class code is auto-generated based on the Typed DataSet, if you don t first save your changes to the Typed DataSet the `Adapter` property won't know about the `InsertWithPicture` method.</span></span>

## <a name="step-3-listing-the-existing-categories-and-their-binary-data"></a><span data-ttu-id="9f0a1-159">步驟3：列出現有的類別及其二進位資料</span><span class="sxs-lookup"><span data-stu-id="9f0a1-159">Step 3: Listing the Existing Categories and their Binary Data</span></span>

<span data-ttu-id="9f0a1-160">在本教學課程中，我們將建立可讓使用者將新類別新增至系統的頁面，並為新的類別提供圖片和手冊。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-160">In this tutorial we will create a page that allows an end user to add a new category to the system, providing a picture and brochure for the new category.</span></span> <span data-ttu-id="9f0a1-161">在[先前的教學](displaying-binary-data-in-the-data-web-controls-vb.md)課程中，我們使用了 GridView 搭配 TemplateField 和 ImageField 來顯示每個類別目錄的名稱、描述、圖片，以及下載其手冊的連結。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-161">In the [preceding tutorial](displaying-binary-data-in-the-data-web-controls-vb.md) we used a GridView with a TemplateField and ImageField to display each category s name, description, picture, and a link to download its brochure.</span></span> <span data-ttu-id="9f0a1-162">讓我們在本教學課程中複寫該功能，建立同時列出所有現有分類並允許建立新類別的頁面。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-162">Let s replicate that functionality for this tutorial, creating a page that both lists all existing categories and allows for new ones to be created.</span></span>

<span data-ttu-id="9f0a1-163">從 [`BinaryData`] 資料夾開啟 [`DisplayOrDownload.aspx`] 頁面開始。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-163">Start by opening the `DisplayOrDownload.aspx` page from the `BinaryData` folder.</span></span> <span data-ttu-id="9f0a1-164">移至來源視圖並複製 GridView 和 ObjectDataSource 的宣告式語法，並將其貼入 `UploadInDetailsView.aspx`的 `<asp:Content>` 元素中。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-164">Go to the Source view and copy the GridView and ObjectDataSource s declarative syntax, pasting it within the `<asp:Content>` element in `UploadInDetailsView.aspx`.</span></span> <span data-ttu-id="9f0a1-165">此外，別忘了將 `GenerateBrochureLink` 方法從 `DisplayOrDownload.aspx` 的程式碼後置類別複製到 `UploadInDetailsView.aspx`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-165">Also, don t forget to copy over the `GenerateBrochureLink` method from the code-behind class of `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx`.</span></span>

<span data-ttu-id="9f0a1-166">[![複製 DisplayOrDownload 中的宣告式語法，並將其貼入 UploadInDetailsView](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-166">[![Copy and Paste the Declarative Syntax from DisplayOrDownload.aspx to UploadInDetailsView.aspx](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.png)</span></span>

<span data-ttu-id="9f0a1-167">**圖 3**：從 `DisplayOrDownload.aspx` 複製並貼上宣告式語法至 `UploadInDetailsView.aspx` （[按一下以查看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-167">**Figure 3**: Copy and Paste the Declarative Syntax from `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.png))</span></span>

<span data-ttu-id="9f0a1-168">將宣告式語法和 `GenerateBrochureLink` 方法複製到 `UploadInDetailsView.aspx` 頁面之後，請透過瀏覽器查看頁面，以確保所有專案都已正確複製。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-168">After copying the declarative syntax and `GenerateBrochureLink` method over to the `UploadInDetailsView.aspx` page, view the page through a browser to ensure that everything was copied over correctly.</span></span> <span data-ttu-id="9f0a1-169">您應該會看到 GridView 列出八個類別，其中包含可下載手冊的連結，以及類別目錄的圖片。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-169">You should see a GridView listing the eight categories that includes a link to download the brochure as well as the category s picture.</span></span>

<span data-ttu-id="9f0a1-170">[![您現在應該會看到每個類別及其二進位資料](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-170">[![You Should Now See Each Category Along with Its Binary Data](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.png)</span></span>

<span data-ttu-id="9f0a1-171">**圖 4**：您現在應該會看到每個類別及其二進位資料（[按一下以查看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-171">**Figure 4**: You Should Now See Each Category Along with Its Binary Data ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.png))</span></span>

## <a name="step-4-configuring-thecategoriesdatasourceto-support-inserting"></a><span data-ttu-id="9f0a1-172">步驟4：設定`CategoriesDataSource`以支援插入</span><span class="sxs-lookup"><span data-stu-id="9f0a1-172">Step 4: Configuring the`CategoriesDataSource`to Support Inserting</span></span>

<span data-ttu-id="9f0a1-173">`Categories` GridView 使用的 `CategoriesDataSource` ObjectDataSource 目前不提供插入資料的能力。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-173">The `CategoriesDataSource` ObjectDataSource used by the `Categories` GridView currently does not provide the ability to insert data.</span></span> <span data-ttu-id="9f0a1-174">為了支援透過這個資料來源控制項插入，我們必須將其 `Insert` 方法對應到其基礎物件中的方法，`CategoriesBLL`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-174">In order to support inserting through this data source control, we need to map its `Insert` method to a method in its underlying object, `CategoriesBLL`.</span></span> <span data-ttu-id="9f0a1-175">特別是，我們想要將它對應至我們在步驟 2 `InsertWithPicture`中新增的 `CategoriesBLL` 方法。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-175">In particular, we want to map it to the `CategoriesBLL` method we added back in Step 2, `InsertWithPicture`.</span></span>

<span data-ttu-id="9f0a1-176">從 [ObjectDataSource s] 智慧標籤按一下 [設定資料來源] 連結開始。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-176">Start by clicking the Configure Data Source link from the ObjectDataSource s smart tag.</span></span> <span data-ttu-id="9f0a1-177">第一個畫面會顯示資料來源已設定為使用的物件，`CategoriesBLL`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-177">The first screen shows the object the data source is configured to work with, `CategoriesBLL`.</span></span> <span data-ttu-id="9f0a1-178">將此設定保持原狀，然後按 [下一步] 進入 [定義資料方法] 畫面。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-178">Leave this setting as-is and click Next to advance to the Define Data Methods screen.</span></span> <span data-ttu-id="9f0a1-179">移至 [插入] 索引標籤，然後從下拉式清單中挑選 `InsertWithPicture` 方法。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-179">Move to the INSERT tab and pick the `InsertWithPicture` method from the drop-down list.</span></span> <span data-ttu-id="9f0a1-180">按一下 [完成] 以完成精靈。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-180">Click Finish to complete the wizard.</span></span>

<span data-ttu-id="9f0a1-181">[![將 ObjectDataSource 設定為使用 InsertWithPicture 方法](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-181">[![Configure the ObjectDataSource to use the InsertWithPicture Method](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.png)</span></span>

<span data-ttu-id="9f0a1-182">**圖 5**：設定 ObjectDataSource 以使用 `InsertWithPicture` 方法（[按一下以查看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-182">**Figure 5**: Configure the ObjectDataSource to use the `InsertWithPicture` Method ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.png))</span></span>

> [!NOTE]
> <span data-ttu-id="9f0a1-183">完成此嚮導之後，Visual Studio 可能會詢問您是否要重新整理欄位和金鑰，這會重新產生資料 Web 控制項欄位。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-183">Upon completing the wizard, Visual Studio may ask if you want to Refresh Fields and Keys, which will regenerate the data Web controls fields.</span></span> <span data-ttu-id="9f0a1-184">選擇 [否]，因為選擇 [是] 將會覆寫您所做的任何欄位自訂。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-184">Choose No, because choosing Yes will overwrite any field customizations you may have made.</span></span>

<span data-ttu-id="9f0a1-185">完成 wizard 之後，ObjectDataSource 現在會包含其 `InsertMethod` 屬性的值，以及四個類別資料行的 `InsertParameters`，如下列宣告式標記所示：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-185">After completing the wizard, the ObjectDataSource will now include a value for its `InsertMethod` property as well as `InsertParameters` for the four category columns, as the following declarative markup illustrates:</span></span>

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample3.aspx)]

## <a name="step-5-creating-the-inserting-interface"></a><span data-ttu-id="9f0a1-186">步驟5：建立插入介面</span><span class="sxs-lookup"><span data-stu-id="9f0a1-186">Step 5: Creating the Inserting Interface</span></span>

<span data-ttu-id="9f0a1-187">第一次[探討插入、更新和刪除資料](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md)時，DetailsView 控制項提供內建的插入介面，可在使用支援插入的資料來源控制項時使用。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-187">As first covered in the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md), the DetailsView control provides a built-in inserting interface that can be utilized when working with a data source control that supports inserting.</span></span> <span data-ttu-id="9f0a1-188">讓我們將 DetailsView 控制項新增至 GridView 上方的這個頁面，以永久轉譯其插入介面，讓使用者可以快速地加入新的類別。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-188">Let s add a DetailsView control to this page above the GridView that will permanently render its inserting interface, allowing a user to quickly add a new category.</span></span> <span data-ttu-id="9f0a1-189">在 DetailsView 中加入新的類別時，其底下的 GridView 會自動重新整理並顯示新的類別。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-189">Upon adding a new category in the DetailsView, the GridView beneath it will automatically refresh and display the new category.</span></span>

<span data-ttu-id="9f0a1-190">首先，從 [工具箱] 將 [DetailsView] 拖曳至 GridView 上方的設計工具，將其 [`ID`] 屬性設定為 `NewCategory`，並清除 `Height` 和 `Width` 屬性值。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-190">Start by dragging a DetailsView from the Toolbox onto the Designer above the GridView, setting its `ID` property to `NewCategory` and clearing out the `Height` and `Width` property values.</span></span> <span data-ttu-id="9f0a1-191">從 DetailsView s 智慧標籤，將它系結至現有的 `CategoriesDataSource`，然後勾選 [啟用插入] 核取方塊。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-191">From the DetailsView s smart tag, bind it to the existing `CategoriesDataSource` and then check the Enable Inserting checkbox.</span></span>

<span data-ttu-id="9f0a1-192">[![將 DetailsView 系結至 CategoriesDataSource 並啟用插入](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-192">[![Bind the DetailsView to the CategoriesDataSource and Enable Inserting](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.png)</span></span>

<span data-ttu-id="9f0a1-193">**圖 6**：將 DetailsView 系結至 `CategoriesDataSource` 並啟用插入（[按一下以觀看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-193">**Figure 6**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image12.png))</span></span>

<span data-ttu-id="9f0a1-194">若要在其插入介面中永久轉譯 DetailsView，請將其 [`DefaultMode`] 屬性設定為 [`Insert`]。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-194">To permanently render the DetailsView in its inserting interface, set its `DefaultMode` property to `Insert`.</span></span>

<span data-ttu-id="9f0a1-195">請注意，DetailsView 有五個 BoundFields `CategoryID`、`CategoryName`、`Description`、`NumberOfProducts`和 `BrochurePath`，雖然 `CategoryID` 的 BoundField 不會在插入介面中轉譯，因為它的 `InsertVisible` 屬性會設定為 [`False`]。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-195">Note that the DetailsView has five BoundFields `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath` although the `CategoryID` BoundField is not rendered in the inserting interface because its `InsertVisible` property is set to `False`.</span></span> <span data-ttu-id="9f0a1-196">這些 BoundFields 已存在，因為它們是 `GetCategories()` 方法所傳回的資料行，而 ObjectDataSource 會叫用它來抓取其資料。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-196">These BoundFields exists because they are the columns returned by the `GetCategories()` method, which is what the ObjectDataSource invokes to retrieve its data.</span></span> <span data-ttu-id="9f0a1-197">不過，在插入時，我們不想讓使用者指定 `NumberOfProducts`的值。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-197">For inserting, however, we don t want to let the user specify a value for `NumberOfProducts`.</span></span> <span data-ttu-id="9f0a1-198">此外，我們還必須允許它們上傳新類別的圖片，以及上傳手冊的 PDF。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-198">Moreover, we need to allow them to upload a picture for the new category as well as upload a PDF for the brochure.</span></span>

<span data-ttu-id="9f0a1-199">完全移除 DetailsView 中的 `NumberOfProducts` BoundField，然後將 `CategoryName` 的 `HeaderText` 屬性和 `BrochurePath` BoundFields 分別更新為 Category 和手冊。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-199">Remove the `NumberOfProducts` BoundField from the DetailsView altogether and then update the `HeaderText` properties of the `CategoryName` and `BrochurePath` BoundFields to Category and Brochure, respectively.</span></span> <span data-ttu-id="9f0a1-200">接下來，將 `BrochurePath` BoundField 轉換成 TemplateField，並為圖片新增新的 TemplateField，讓這個新 TemplateField 成為 `HeaderText` 的圖片值。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-200">Next, convert the `BrochurePath` BoundField into a TemplateField and add a new TemplateField for the picture, giving this new TemplateField a `HeaderText` value of Picture.</span></span> <span data-ttu-id="9f0a1-201">移動 `Picture` TemplateField，使其介於 `BrochurePath` TemplateField 和 CommandField 之間。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-201">Move the `Picture` TemplateField so that it is between the `BrochurePath` TemplateField and CommandField.</span></span>

![將 DetailsView 系結至 CategoriesDataSource 並啟用插入](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.gif)

<span data-ttu-id="9f0a1-203">**圖 7**：將 DetailsView 系結至 `CategoriesDataSource` 並啟用插入</span><span class="sxs-lookup"><span data-stu-id="9f0a1-203">**Figure 7**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting</span></span>

<span data-ttu-id="9f0a1-204">如果您透過 [編輯欄位] 對話方塊，將 `BrochurePath` BoundField 轉換為 TemplateField，則 TemplateField 會包含 `ItemTemplate`、`EditItemTemplate`和 `InsertItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-204">If you converted the `BrochurePath` BoundField into a TemplateField through the Edit Fields dialog box, the TemplateField includes an `ItemTemplate`, `EditItemTemplate`, and `InsertItemTemplate`.</span></span> <span data-ttu-id="9f0a1-205">不過，只需要 `InsertItemTemplate`，因此，您可以隨意移除其他兩個範本。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-205">Only the `InsertItemTemplate` is needed, however, so feel free to remove the other two templates.</span></span> <span data-ttu-id="9f0a1-206">此時，DetailsView 的宣告式語法應如下所示：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-206">At this point your DetailsView s declarative syntax should look like the following:</span></span>

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample4.aspx)]

## <a name="adding-fileupload-controls-for-the-brochure-and-picture-fields"></a><span data-ttu-id="9f0a1-207">新增 [手冊] 和 [圖片] 欄位的 FileUpload 控制項</span><span class="sxs-lookup"><span data-stu-id="9f0a1-207">Adding FileUpload Controls for the Brochure and Picture Fields</span></span>

<span data-ttu-id="9f0a1-208">目前，`BrochurePath` TemplateField s `InsertItemTemplate` 包含 TextBox，而 `Picture` TemplateField 不包含任何範本。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-208">Presently, the `BrochurePath` TemplateField s `InsertItemTemplate` contains a TextBox, while the `Picture` TemplateField does not contain any templates.</span></span> <span data-ttu-id="9f0a1-209">我們需要更新這兩個 TemplateField `InsertItemTemplate` s，才能使用 FileUpload 控制項。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-209">We need to update these two TemplateField s `InsertItemTemplate` s to use FileUpload controls.</span></span>

<span data-ttu-id="9f0a1-210">從 DetailsView s 智慧標籤中，選擇 [編輯範本] 選項，然後從下拉式清單中選取 `BrochurePath` TemplateField s `InsertItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-210">From the DetailsView s smart tag, choose the Edit Templates option and then select the `BrochurePath` TemplateField s `InsertItemTemplate` from the drop-down list.</span></span> <span data-ttu-id="9f0a1-211">移除文字方塊，然後將 [FileUpload] 控制項從 [工具箱] 拖曳到範本中。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-211">Remove the TextBox and then drag a FileUpload control from the Toolbox into the template.</span></span> <span data-ttu-id="9f0a1-212">將 FileUpload 控制項 s `ID` 設定為 `BrochureUpload`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-212">Set the FileUpload control s `ID` to `BrochureUpload`.</span></span> <span data-ttu-id="9f0a1-213">同樣地，將 FileUpload 控制項新增至 `Picture` TemplateField s `InsertItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-213">Similarly, add a FileUpload control to the `Picture` TemplateField s `InsertItemTemplate`.</span></span> <span data-ttu-id="9f0a1-214">將此 FileUpload 控制項 s `ID` 設定為 `PictureUpload`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-214">Set this FileUpload control s `ID` to `PictureUpload`.</span></span>

<span data-ttu-id="9f0a1-215">[![將 FileUpload 控制項新增至 InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-215">[![Add a FileUpload Control to the InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image13.png)</span></span>

<span data-ttu-id="9f0a1-216">**圖 8**：將 FileUpload 控制項新增至 `InsertItemTemplate` （[按一下以查看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image14.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-216">**Figure 8**: Add a FileUpload Control to the `InsertItemTemplate` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image14.png))</span></span>

<span data-ttu-id="9f0a1-217">進行這些新增動作之後，兩個 TemplateField 的宣告式語法會是：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-217">After making these additions, the two TemplateField s declarative syntax will be:</span></span>

[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample5.aspx)]

<span data-ttu-id="9f0a1-218">當使用者加入新的類別時，我們想要確保手冊和圖片的檔案類型正確無誤。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-218">When a user adds a new category, we want to ensure that the brochure and picture are of the correct file type.</span></span> <span data-ttu-id="9f0a1-219">針對手冊，使用者必須提供 PDF。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-219">For the brochure, the user must supply a PDF.</span></span> <span data-ttu-id="9f0a1-220">在此圖片中，我們需要使用者上傳影像檔案，但我們允許*任何*影像檔案，或是只有特定類型的影像檔案，例如 Gif 或 jpg？</span><span class="sxs-lookup"><span data-stu-id="9f0a1-220">For the picture, we need the user to upload an image file, but do we allow *any* image file or only image files of a particular type, such as GIFs or JPGs?</span></span> <span data-ttu-id="9f0a1-221">為了允許不同的檔案類型，我們必須擴充 `Categories` 架構，使其包含可捕捉檔案類型的資料行，以便透過 `DisplayCategoryPicture.aspx`中的 `Response.ContentType`，將此類型傳送至用戶端。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-221">In order to allow for different file types, we d need to extend the `Categories` schema to include a column that captures the file type so that this type can be sent to the client through `Response.ContentType` in `DisplayCategoryPicture.aspx`.</span></span> <span data-ttu-id="9f0a1-222">因為我們沒有這類資料行，所以要限制使用者只能提供特定的影像檔案類型，是非常謹慎的。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-222">Since we don t have such a column, it would be prudent to restrict users to only providing a specific image file type.</span></span> <span data-ttu-id="9f0a1-223">`Categories` 資料表的現有影像是點陣圖，但 Jpg 是更適合透過 web 提供之影像的檔案格式。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-223">The `Categories` table s existing images are bitmaps, but JPGs are a more appropriate file format for images served over the web.</span></span>

<span data-ttu-id="9f0a1-224">如果使用者上傳的檔案類型不正確，我們必須取消插入，並顯示指出問題的訊息。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-224">If a user uploads an incorrect file type, we need to cancel the insert and display a message indicating the problem.</span></span> <span data-ttu-id="9f0a1-225">在 DetailsView 底下新增標籤 Web 控制項。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-225">Add a Label Web control beneath the DetailsView.</span></span> <span data-ttu-id="9f0a1-226">將其 [`ID`] 屬性設定為 [`UploadWarning`]，清除其 `Text` 屬性，將 [`CssClass`] 屬性設為 [警告]，並將 [`Visible`] 和 [`EnableViewState`] 屬性設定為 `False`</span><span class="sxs-lookup"><span data-stu-id="9f0a1-226">Set its `ID` property to `UploadWarning`, clear out its `Text` property, set the `CssClass` property to Warning, and the `Visible` and `EnableViewState` properties to `False`.</span></span> <span data-ttu-id="9f0a1-227">`Warning` CSS 類別是在 `Styles.css` 中定義，並以大、紅色、斜體、粗體字型呈現文字。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-227">The `Warning` CSS class is defined in `Styles.css` and renders the text in a large, red, italicized, bold font.</span></span>

> [!NOTE]
> <span data-ttu-id="9f0a1-228">在理想的情況下，`CategoryName` 和 `Description` BoundFields 會轉換成 TemplateFields，並自訂其插入介面。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-228">Ideally, the `CategoryName` and `Description` BoundFields would be converted to TemplateFields and their inserting interfaces customized.</span></span> <span data-ttu-id="9f0a1-229">例如，插入介面的 `Description` 可能較適合透過多行文字方塊。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-229">The `Description` inserting interface, for example, would likely be better suited through a multi-line textbox.</span></span> <span data-ttu-id="9f0a1-230">而且由於 `CategoryName` 資料行不接受 `NULL` 值，因此應新增 RequiredFieldValidator，以確保使用者提供新類別目錄名稱的值。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-230">And since the `CategoryName` column does not accept `NULL` values, a RequiredFieldValidator should be added to ensure the user provides a value for the new category s name.</span></span> <span data-ttu-id="9f0a1-231">這些步驟會保留為讀者的練習。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-231">These steps are left as an exercise to the reader.</span></span> <span data-ttu-id="9f0a1-232">請回頭[自訂資料修改介面](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md)，以深入瞭解如何擴充資料修改介面。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-232">Refer back to [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md) for an in-depth look at augmenting the data modification interfaces.</span></span>

## <a name="step-6-saving-the-uploaded-brochure-to-the-web-server-s-file-system"></a><span data-ttu-id="9f0a1-233">步驟6：將上傳的手冊儲存至 Web 服務器 s 檔案系統</span><span class="sxs-lookup"><span data-stu-id="9f0a1-233">Step 6: Saving the Uploaded Brochure to the Web Server s File System</span></span>

<span data-ttu-id="9f0a1-234">當使用者輸入新類別的值，並按一下 [插入] 按鈕時，就會發生回傳並插入工作流程色彩。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-234">When the user enters the values for a new category and clicks the Insert button, a postback occurs and the inserting workflow unfolds.</span></span> <span data-ttu-id="9f0a1-235">首先，會引發 DetailsView s [`ItemInserting` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-235">First, the DetailsView s [`ItemInserting` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) fires.</span></span> <span data-ttu-id="9f0a1-236">接下來，會叫用 ObjectDataSource s `Insert()` 方法，這會導致新的記錄新增至 `Categories` 資料表。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-236">Next, the ObjectDataSource s `Insert()` method is invoked, which results in a new record being added to the `Categories` table.</span></span> <span data-ttu-id="9f0a1-237">之後，會引發 DetailsView s [`ItemInserted` 事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-237">After that, the DetailsView s [`ItemInserted` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) fires.</span></span>

<span data-ttu-id="9f0a1-238">叫用 ObjectDataSource s `Insert()` 方法之前，我們必須先確定使用者已上傳適當的檔案類型，然後將手冊 PDF 儲存至 web 伺服器的檔案系統。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-238">Before the ObjectDataSource s `Insert()` method is invoked, we must first ensure that the appropriate file types were uploaded by the user and then save the brochure PDF to the web server s file system.</span></span> <span data-ttu-id="9f0a1-239">建立 DetailsView s `ItemInserting` 事件的事件處理常式，並新增下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-239">Create an event handler for the DetailsView s `ItemInserting` event and add the following code:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample6.vb)]

<span data-ttu-id="9f0a1-240">事件處理常式一開始會從 DetailsView 的範本中參考 `BrochureUpload` FileUpload 控制項。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-240">The event handler starts by referencing the `BrochureUpload` FileUpload control from the DetailsView s templates.</span></span> <span data-ttu-id="9f0a1-241">然後，如果已上傳手冊，則會檢查上傳的檔案 s 延伸模組。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-241">Then, if a brochure has been uploaded, the uploaded file s extension is examined.</span></span> <span data-ttu-id="9f0a1-242">如果擴充功能不是，則為。PDF，則會顯示警告、插入已取消，以及事件處理常式的執行結束。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-242">If the extension is not .PDF, then a warning is displayed, the insert is cancelled, and the execution of the event handler ends.</span></span>

> [!NOTE]
> <span data-ttu-id="9f0a1-243">依賴已上傳的檔案的延伸模組並不是確保上傳的檔案是 PDF 檔的一種不確定的方法。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-243">Relying on the uploaded file s extension is not a sure-fire technique for ensuring that the uploaded file is a PDF document.</span></span> <span data-ttu-id="9f0a1-244">使用者可以擁有副檔名為 `.Brochure`的有效 PDF 檔，或可能已取得非 PDF 檔，並將其指定為 `.pdf` 延伸模組。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-244">The user could have a valid PDF document with the extension `.Brochure`, or could have taken a non-PDF document and given it a `.pdf` extension.</span></span> <span data-ttu-id="9f0a1-245">必須以程式設計方式檢查檔案的二進位內容，才能更最終驗證檔案類型。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-245">The file s binary content would need to be programmatically examined in order to more conclusively verify the file type.</span></span> <span data-ttu-id="9f0a1-246">不過，這種徹底的方法通常是大材小用;檢查延伸模組就足以應付大部分的情況。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-246">Such thorough approaches, though, are often overkill; checking the extension is sufficient for most scenarios.</span></span>

<span data-ttu-id="9f0a1-247">如[上傳](uploading-files-vb.md)檔案教學課程中所述，將檔案儲存到檔案系統時必須特別小心，讓一個使用者上傳不會覆寫另一個。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-247">As discussed in the [Uploading Files](uploading-files-vb.md) tutorial, care must be taken when saving files to the file system so that one user s upload does not overwrite another s.</span></span> <span data-ttu-id="9f0a1-248">在本教學課程中，我們會嘗試使用與上傳檔案相同的名稱。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-248">For this tutorial we will attempt to use the same name as the uploaded file.</span></span> <span data-ttu-id="9f0a1-249">不過，如果 `~/Brochures` 目錄中已經有同名的檔案，我們會在結尾附加一個數位，直到找到唯一的名稱為止。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-249">If there already exists a file in the `~/Brochures` directory with that same file name, however, we'll append a number at the end until a unique name is found.</span></span> <span data-ttu-id="9f0a1-250">例如，如果使用者上傳名為 `Meats.pdf`的手冊檔案，但 `~/Brochures` 資料夾中已經有名為 `Meats.pdf` 的檔案，我們會將儲存的檔案名變更為 `Meats-1.pdf`。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-250">For example, if the user uploads a brochure file named `Meats.pdf`, but there is already a file named `Meats.pdf` in the `~/Brochures` folder, we'll change the saved file name to `Meats-1.pdf`.</span></span> <span data-ttu-id="9f0a1-251">如果存在，我們會嘗試 `Meats-2.pdf`，依此類推，直到找到唯一的檔案名為止。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-251">If that exists, we'll try `Meats-2.pdf`, and so on, until a unique file name is found.</span></span>

<span data-ttu-id="9f0a1-252">下列程式碼會使用[`File.Exists(path)` 方法](https://msdn.microsoft.com/library/system.io.file.exists.aspx)來判斷檔案是否已存在，並具有指定的檔案名。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-252">The following code uses the [`File.Exists(path)` method](https://msdn.microsoft.com/library/system.io.file.exists.aspx) to determine if a file already exists with the specified file name.</span></span> <span data-ttu-id="9f0a1-253">若是如此，它會繼續嘗試手冊的新檔案名，直到找不到任何衝突為止。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-253">If so, it continues to try new file names for the brochure until no conflict is found.</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample7.vb)]

<span data-ttu-id="9f0a1-254">一旦找到有效的檔案名，就必須將檔案儲存到檔案系統，而且必須更新 ObjectDataSource s `brochurePath``InsertParameter` 值，才能將此檔案名寫入資料庫中。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-254">Once a valid file name has been found, the file needs to be saved to the file system and the ObjectDataSource s `brochurePath``InsertParameter` value needs to be updated so that this file name is written to the database.</span></span> <span data-ttu-id="9f0a1-255">如我們在*上傳*檔案教學課程中所見，您可以使用 FileUpload 控制項 `SaveAs(path)` 方法來儲存檔案。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-255">As we saw back in the *Uploading Files* tutorial, the file can be saved using the FileUpload control s `SaveAs(path)` method.</span></span> <span data-ttu-id="9f0a1-256">若要更新 ObjectDataSource s `brochurePath` 參數，請使用 `e.Values` 集合。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-256">To update the ObjectDataSource s `brochurePath` parameter, use the `e.Values` collection.</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample8.vb)]

## <a name="step-7-saving-the-uploaded-picture-to-the-database"></a><span data-ttu-id="9f0a1-257">步驟7：將上傳的圖片儲存到資料庫</span><span class="sxs-lookup"><span data-stu-id="9f0a1-257">Step 7: Saving the Uploaded Picture to the Database</span></span>

<span data-ttu-id="9f0a1-258">若要將上傳的圖片儲存在新的 `Categories` 記錄中，我們必須將已上傳的二進位內容指派給 DetailsView s `ItemInserting` 事件中的 ObjectDataSource s `picture` 參數。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-258">To store the uploaded picture in the new `Categories` record, we need to assign the uploaded binary content to the ObjectDataSource s `picture` parameter in the DetailsView s `ItemInserting` event.</span></span> <span data-ttu-id="9f0a1-259">不過，在進行此指派之前，我們必須先確定上傳的圖片是 JPG，而不是其他影像類型。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-259">Before we make this assignment, however, we need to first make sure that the uploaded picture is a JPG and not some other image type.</span></span> <span data-ttu-id="9f0a1-260">如步驟6所示，讓 s 使用上傳的圖片的副檔名來確定其類型。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-260">As in Step 6, let s use the uploaded picture s file extension to ascertain its type.</span></span>

<span data-ttu-id="9f0a1-261">雖然 `Categories` 資料表允許 `NULL` `Picture` 資料行的值，但所有的分類目前都有一張圖片。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-261">While the `Categories` table allows `NULL` values for the `Picture` column, all categories currently have a picture.</span></span> <span data-ttu-id="9f0a1-262">讓使用者在透過此頁面新增類別時，強制提供圖片。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-262">Let s force the user to provide a picture when adding a new category through this page.</span></span> <span data-ttu-id="9f0a1-263">下列程式碼會檢查並確定圖片已上傳，而且它具有適當的延伸模組。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-263">The following code checks to ensure that a picture has been uploaded and that it has an appropriate extension.</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample9.vb)]

<span data-ttu-id="9f0a1-264">這個程式碼應該放在步驟6的程式碼*之前*，如此一來，如果圖片上傳發生問題，則在將手冊檔案儲存到檔案系統之前，事件處理常式會終止。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-264">This code should be placed *before* the code from Step 6 so that if there is a problem with the picture upload, the event handler will terminate before the brochure file is saved to the file system.</span></span>

<span data-ttu-id="9f0a1-265">假設已上傳適當的檔案，請使用下列程式程式碼，將已上傳的二進位內容指派給圖片參數 s 值：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-265">Assuming that an appropriate file has been uploaded, assign the uploaded binary content to the picture parameter s value with the following line of code:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample10.vb)]

## <a name="the-completeiteminsertingevent-handler"></a><span data-ttu-id="9f0a1-266">完整的`ItemInserting`事件處理常式</span><span class="sxs-lookup"><span data-stu-id="9f0a1-266">The Complete`ItemInserting`Event Handler</span></span>

<span data-ttu-id="9f0a1-267">為求完整性，以下是完整的 `ItemInserting` 事件處理常式：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-267">For completeness, here is the `ItemInserting` event handler in its entirety:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample11.vb)]

## <a name="step-8-fixing-thedisplaycategorypictureaspxpage"></a><span data-ttu-id="9f0a1-268">步驟8：修正`DisplayCategoryPicture.aspx`頁面</span><span class="sxs-lookup"><span data-stu-id="9f0a1-268">Step 8: Fixing the`DisplayCategoryPicture.aspx`Page</span></span>

<span data-ttu-id="9f0a1-269">讓我們花點時間測試在最後幾個步驟所建立的插入介面和 `ItemInserting` 事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-269">Let s take a moment to test out the inserting interface and `ItemInserting` event handler that was created over the last few steps.</span></span> <span data-ttu-id="9f0a1-270">透過瀏覽器造訪 [`UploadInDetailsView.aspx`] 頁面並嘗試新增類別，但省略圖片，或指定非 JPG 圖片或非 PDF 手冊。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-270">Visit the `UploadInDetailsView.aspx` page through a browser and attempt to add a category, but omit the picture, or specify a non-JPG picture or a non-PDF brochure.</span></span> <span data-ttu-id="9f0a1-271">在上述任一情況下，將會顯示錯誤訊息，並取消插入工作流程。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-271">In any of these cases, an error message will be displayed and the insert workflow cancelled.</span></span>

<span data-ttu-id="9f0a1-272">[如果上傳的檔案類型無效，就會顯示 ![警告訊息](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-272">[![A Warning Message is Displayed If an Invalid File Type is Uploaded](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image15.png)</span></span>

<span data-ttu-id="9f0a1-273">**圖 9**：如果上傳了不正確檔案類型，就會顯示警告訊息（[按一下以查看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image16.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-273">**Figure 9**: A Warning Message is Displayed If an Invalid File Type is Uploaded ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image16.png))</span></span>

<span data-ttu-id="9f0a1-274">一旦您確認頁面需要上傳圖片，而且不接受非 PDF 或非 JPG 檔案，請加入具有有效 JPG 圖片的新類別，並將 [摺頁冊] 欄位保留空白。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-274">Once you have verified that the page requires a picture to be uploaded and won't accept non-PDF or non-JPG files, add a new category with a valid JPG picture, leaving the Brochure field empty.</span></span> <span data-ttu-id="9f0a1-275">按一下 [插入] 按鈕之後，頁面將回傳，而新的記錄將會加入至 [`Categories`] 資料表中，並將已上傳的影像 s 二進位內容直接儲存在資料庫中。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-275">After clicking the Insert button, the page will postback and a new record will be added to the `Categories` table with the uploaded image s binary contents stored directly in the database.</span></span> <span data-ttu-id="9f0a1-276">GridView 會更新，並顯示新加入之類別目錄的資料列，但如 [圖 10] 所示，新的分類圖片並未正確轉譯。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-276">The GridView is updated and shows a row for the newly added category, but, as Figure 10 shows, the new category s picture is not rendered correctly.</span></span>

<span data-ttu-id="9f0a1-277">[![不會顯示新的分類圖片](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-277">[![The New Category s Picture is not Displayed](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image17.png)</span></span>

<span data-ttu-id="9f0a1-278">**圖 10**：不會顯示新的分類圖片（[按一下以觀看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-278">**Figure 10**: The New Category s Picture is not Displayed ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image18.png))</span></span>

<span data-ttu-id="9f0a1-279">新圖片未顯示的原因是，會將傳回指定分類圖片的 `DisplayCategoryPicture.aspx` 頁面設定為處理具有 OLE 標頭的點陣圖。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-279">The reason the new picture is not displayed is because the `DisplayCategoryPicture.aspx` page that returns a specified category s picture is configured to process bitmaps that have an OLE header.</span></span> <span data-ttu-id="9f0a1-280">這個78位元組標頭會從 `Picture` 資料行的二進位內容中移除，然後再傳送回用戶端。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-280">This 78 byte header is stripped from the `Picture` column s binary contents before they are sent back to the client.</span></span> <span data-ttu-id="9f0a1-281">但我們剛剛為新類別上傳的 JPG 檔案沒有此 OLE 標頭;因此，從影像的二進位資料中移除有效的必要位元組。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-281">But the JPG file we just uploaded for the new category does not have this OLE header; therefore, valid, necessary bytes are being removed from the image s binary data.</span></span>

<span data-ttu-id="9f0a1-282">因為現在 `Categories` 資料表中有兩個位圖具有 OLE 標頭和 Jpg，所以我們需要更新 `DisplayCategoryPicture.aspx`，讓它針對原始八個類別進行 OLE 標頭的去除，並略過較新類別記錄的去除。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-282">Since there are now both bitmaps with OLE headers and JPGs in the `Categories` table, we need to update `DisplayCategoryPicture.aspx` so that it does the OLE header stripping for the original eight categories and bypasses this stripping for the newer category records.</span></span> <span data-ttu-id="9f0a1-283">在下一個教學課程中，我們將探討如何更新現有的記錄影像，並更新所有舊的類別圖片，使其 Jpg。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-283">In our next tutorial we'll examine how to update an existing record s image, and we'll update all of the old category pictures so that they are JPGs.</span></span> <span data-ttu-id="9f0a1-284">不過，現在，請在 `DisplayCategoryPicture.aspx` 中使用下列程式碼，只針對那些原始八個類別來去除 OLE 標頭：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-284">For now, though, use the following code in `DisplayCategoryPicture.aspx` to strip the OLE headers only for those original eight categories:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample12.vb)]

<span data-ttu-id="9f0a1-285">透過這項變更，JPG 影像現在會在 GridView 中正確轉譯。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-285">With this change, the JPG image is now rendered correctly in the GridView.</span></span>

<span data-ttu-id="9f0a1-286">[已正確轉譯新類別的 JPG 影像 ![](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-286">[![The JPG Images for New Categories are Correctly Rendered](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image19.png)</span></span>

<span data-ttu-id="9f0a1-287">**圖 11**：已正確轉譯新類別的 JPG 影像（[按一下以觀看完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image20.png)）</span><span class="sxs-lookup"><span data-stu-id="9f0a1-287">**Figure 11**: The JPG Images for New Categories are Correctly Rendered ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image20.png))</span></span>

## <a name="step-9-deleting-the-brochure-in-the-face-of-an-exception"></a><span data-ttu-id="9f0a1-288">步驟9：在遇到例外狀況時刪除手冊</span><span class="sxs-lookup"><span data-stu-id="9f0a1-288">Step 9: Deleting the Brochure in the Face of an Exception</span></span>

<span data-ttu-id="9f0a1-289">將二進位資料儲存在 web 伺服器的檔案系統上的其中一項挑戰，就是它會在資料模型及其二進位資料之間引進中斷連接。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-289">One of the challenges of storing binary data on the web server s file system is that it introduces a disconnect between the data model and its binary data.</span></span> <span data-ttu-id="9f0a1-290">因此，每當刪除記錄時，也必須移除檔案系統上對應的二進位資料。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-290">Therefore, whenever a record is deleted, the corresponding binary data on the file system must also be removed.</span></span> <span data-ttu-id="9f0a1-291">這也可以在插入時播放。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-291">This can come into play when inserting, as well.</span></span> <span data-ttu-id="9f0a1-292">請考慮下列案例：使用者新增了新的類別，並指定有效的圖片和手冊。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-292">Consider the following scenario: a user adds a new category, specifying a valid picture and brochure.</span></span> <span data-ttu-id="9f0a1-293">按一下 [插入] 按鈕時，會發生回傳並引發 DetailsView s `ItemInserting` 事件，將手冊儲存至 web 伺服器 s 檔案系統。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-293">Upon clicking the Insert button, a postback occurs and the DetailsView s `ItemInserting` event fires, saving the brochure to the web server s file system.</span></span> <span data-ttu-id="9f0a1-294">接下來，會叫用 ObjectDataSource s `Insert()` 方法，這會呼叫 `CategoriesBLL` 類別 s `InsertWithPicture` 方法，以呼叫 `CategoriesTableAdapter` s `InsertWithPicture` 方法。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-294">Next, the ObjectDataSource s `Insert()` method is invoked, which calls the `CategoriesBLL` class s `InsertWithPicture` method, which calls the `CategoriesTableAdapter` s `InsertWithPicture` method.</span></span>

<span data-ttu-id="9f0a1-295">現在，如果資料庫離線，或 `INSERT` SQL 語句中有錯誤，會發生什麼事？</span><span class="sxs-lookup"><span data-stu-id="9f0a1-295">Now, what happens if the database is offline, or if there is an error in the `INSERT` SQL statement?</span></span> <span data-ttu-id="9f0a1-296">很明顯地，插入將會失敗，因此不會將新的類別資料列新增至資料庫。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-296">Clearly the INSERT will fail, so no new category row will be added to the database.</span></span> <span data-ttu-id="9f0a1-297">但是我們還是把上傳的摺頁冊檔案放在 web 伺服器的檔案系統上！</span><span class="sxs-lookup"><span data-stu-id="9f0a1-297">But we still have the uploaded brochure file sitting on the web server s file system!</span></span> <span data-ttu-id="9f0a1-298">在插入工作流程期間，如果發生例外狀況，則需要刪除此檔案。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-298">This file needs to be deleted in the face of an exception during the inserting workflow.</span></span>

<span data-ttu-id="9f0a1-299">如先前在[ASP.NET 網頁中處理 BLL 和 DAL 層級的例外](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md)狀況教學課程中所述，當從架構的深度中擲回例外狀況時，它會透過各種層級向上展開。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-299">As discussed previously in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md) tutorial, when an exception is thrown from within the depths of the architecture it is bubbled up through the various layers.</span></span> <span data-ttu-id="9f0a1-300">在展示層中，我們可以判斷 DetailsView s `ItemInserted` 事件是否發生例外狀況。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-300">At the Presentation Layer, we can determine if an exception has occurred from the DetailsView s `ItemInserted` event.</span></span> <span data-ttu-id="9f0a1-301">這個事件處理常式也會提供 ObjectDataSource s `InsertParameters`的值。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-301">This event handler also provides the values of the ObjectDataSource s `InsertParameters`.</span></span> <span data-ttu-id="9f0a1-302">因此，我們可以建立 `ItemInserted` 事件的事件處理常式，以檢查是否發生例外狀況，如果是的話，則會刪除 ObjectDataSource s `brochurePath` 參數所指定的檔案：</span><span class="sxs-lookup"><span data-stu-id="9f0a1-302">Therefore, we can create an event handler for the `ItemInserted` event that checks if there was an exception and, if so, deletes the file specified by the ObjectDataSource s `brochurePath` parameter:</span></span>

[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample13.vb)]

## <a name="summary"></a><span data-ttu-id="9f0a1-303">總結</span><span class="sxs-lookup"><span data-stu-id="9f0a1-303">Summary</span></span>

<span data-ttu-id="9f0a1-304">為了提供以 web 為基礎的介面來新增包含二進位資料的記錄，必須執行幾個步驟。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-304">There are a number of steps that must be performed in order to provide a web-based interface for adding records that include binary data.</span></span> <span data-ttu-id="9f0a1-305">如果二進位資料直接儲存到資料庫中，您可能需要更新架構，並加入特定方法來處理插入二進位資料的情況。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-305">If the binary data is being stored directly into the database, chances are you'll need to update the architecture, adding specific methods to handle the case where binary data is being inserted.</span></span> <span data-ttu-id="9f0a1-306">一旦架構更新之後，下一步就是建立插入介面，使用已自訂為包含每個二進位資料欄位之 FileUpload 控制項的 DetailsView 即可完成。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-306">Once the architecture has been updated, the next step is creating the inserting interface, which can be accomplished using a DetailsView that has been customized to include a FileUpload control for each binary data field.</span></span> <span data-ttu-id="9f0a1-307">然後，可以將上傳的資料儲存至 web 伺服器的檔案系統，或指派給 DetailsView s `ItemInserting` 事件處理常式中的資料來源參數。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-307">The uploaded data can then be saved to the web server s file system or assigned to a data source parameter in the DetailsView s `ItemInserting` event handler.</span></span>

<span data-ttu-id="9f0a1-308">將二進位資料儲存到檔案系統需要比直接將資料儲存到資料庫更多的規劃。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-308">Saving binary data to the file system requires more planning than saving data directly into the database.</span></span> <span data-ttu-id="9f0a1-309">必須選擇命名配置，才能避免一個使用者上傳覆寫另一個。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-309">A naming scheme must be chosen in order to avoid one user s upload overwriting another s.</span></span> <span data-ttu-id="9f0a1-310">此外，如果資料庫插入失敗，則必須採取額外的步驟來刪除已上傳的檔案。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-310">Also, extra steps must be taken to delete the uploaded file if the database insert fails.</span></span>

<span data-ttu-id="9f0a1-311">我們現在可以在系統中加入新的類別，其中包含手冊和圖片，但我們尚未探討如何更新現有的類別二進位資料，或如何正確地移除已刪除之類別的二進位資料。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-311">We now have the ability to add new categories to the system with a brochure and picture, but we ve yet to look at how to update an existing category s binary data or how to correctly remove the binary data for a deleted category.</span></span> <span data-ttu-id="9f0a1-312">我們將在下一個教學課程中探索這兩個主題。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-312">We'll explore these two topics in the next tutorial.</span></span>

<span data-ttu-id="9f0a1-313">快樂的程式設計！</span><span class="sxs-lookup"><span data-stu-id="9f0a1-313">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="9f0a1-314">關於作者</span><span class="sxs-lookup"><span data-stu-id="9f0a1-314">About the Author</span></span>

<span data-ttu-id="9f0a1-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，自1998起，有七個 ASP/ASP. NET 書籍和創辦人的[4GuysFromRolla.com](http://www.4guysfromrolla.com)。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="9f0a1-316">Scott 以獨立的顧問、訓練員和作者的身分運作。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-316">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="9f0a1-317">他的最新著作是[*在24小時內讓自己的 ASP.NET 2.0*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-317">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="9f0a1-318">他可以在mitchell@4GuysFromRolla.com觸達[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-318">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="9f0a1-319">或者透過他的 blog，可以在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)找到。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-319">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="9f0a1-320">特別感謝</span><span class="sxs-lookup"><span data-stu-id="9f0a1-320">Special Thanks To</span></span>

<span data-ttu-id="9f0a1-321">本教學課程系列已由許多有用的審核者所審查。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-321">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="9f0a1-322">本教學課程的領導審查者為 Dave Gardner、Teresa Murphy 和 Bernadette Leigh。</span><span class="sxs-lookup"><span data-stu-id="9f0a1-322">Lead reviewers for this tutorial were Dave Gardner, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="9f0a1-323">有興趣複習我即將發行的 MSDN 文章嗎？</span><span class="sxs-lookup"><span data-stu-id="9f0a1-323">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="9f0a1-324">若是如此，請在mitchell@4GuysFromRolla.com的那一行下拉式[。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-324">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="9f0a1-325">[上一頁](displaying-binary-data-in-the-data-web-controls-vb.md)
> [下一頁](updating-and-deleting-existing-binary-data-vb.md)</span><span class="sxs-lookup"><span data-stu-id="9f0a1-325">[Previous](displaying-binary-data-in-the-data-web-controls-vb.md)
[Next](updating-and-deleting-existing-binary-data-vb.md)</span></span>
