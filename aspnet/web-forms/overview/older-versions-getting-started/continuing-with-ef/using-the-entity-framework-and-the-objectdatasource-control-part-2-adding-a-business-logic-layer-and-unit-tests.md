---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: 使用 Entity Framework 4.0 和 ObjectDataSource 控制項，第 2 部分：新增商務邏輯層和單元測試 |Microsoft Docs
author: tdykstra
description: 本教學課程系列由開始使用 Entity Framework 4.0 的教學課程系列的 Contoso 大學 web 應用程式為基礎。 我...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: 4d436b0e5d605027cfcf5243f615f9ac167c5888
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/17/2019
ms.locfileid: "59388045"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="12c5b-104">使用 Entity Framework 4.0 和 ObjectDataSource 控制項，第 2 部分：新增商務邏輯層與單元測試</span><span class="sxs-lookup"><span data-stu-id="12c5b-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>

<span data-ttu-id="12c5b-105">藉由[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="12c5b-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="12c5b-106">本教學課程系列是根據所建立的 Contoso 大學 web 應用程式[Getting Started with Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started)教學課程系列。</span><span class="sxs-lookup"><span data-stu-id="12c5b-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="12c5b-107">如果您未完成先前的教學課程，為本教學課程的起始點即可[下載應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)您會建立。</span><span class="sxs-lookup"><span data-stu-id="12c5b-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="12c5b-108">您也可以[下載應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)，它由完整的教學課程系列。</span><span class="sxs-lookup"><span data-stu-id="12c5b-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="12c5b-109">如果您有疑問的教學課程，您可以張貼他們[ASP.NET Entity Framework 論壇](https://forums.asp.net/1227.aspx)。</span><span class="sxs-lookup"><span data-stu-id="12c5b-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="12c5b-110">在上一個教學課程中，您建立使用 Entity Framework 的多層式架構 web 應用程式和`ObjectDataSource`控制項。</span><span class="sxs-lookup"><span data-stu-id="12c5b-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="12c5b-111">本教學課程示範如何將商務邏輯加入時將商務邏輯層 (BLL) 和資料存取層 (DAL) 分開的並示範如何建立 BLL 自動化的單元測試。</span><span class="sxs-lookup"><span data-stu-id="12c5b-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="12c5b-112">在本教學課程中，您將完成下列工作：</span><span class="sxs-lookup"><span data-stu-id="12c5b-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="12c5b-113">建立儲存機制介面會宣告您所需的資料存取方法。</span><span class="sxs-lookup"><span data-stu-id="12c5b-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="12c5b-114">儲存機制類別中實作存放庫的介面。</span><span class="sxs-lookup"><span data-stu-id="12c5b-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="12c5b-115">建立呼叫儲存機制類別來執行資料存取功能的商務邏輯類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="12c5b-116">連接`ObjectDataSource`控制項至儲存機制類別而不是商務邏輯類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="12c5b-117">建立單元測試專案和其資料存放區中使用記憶體中集合的儲存機制類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="12c5b-118">建立您想要新增至商務邏輯的類別，然後執行測試，並觀察它失敗的商務邏輯的單元測試。</span><span class="sxs-lookup"><span data-stu-id="12c5b-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="12c5b-119">商務邏輯類別中實作商務邏輯，然後重新執行單元測試，並查看它傳遞。</span><span class="sxs-lookup"><span data-stu-id="12c5b-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="12c5b-120">您將使用*Departments.aspx*並*DepartmentsAdd.aspx*您在上一個教學課程中建立的頁面。</span><span class="sxs-lookup"><span data-stu-id="12c5b-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="12c5b-121">建立儲存機制介面</span><span class="sxs-lookup"><span data-stu-id="12c5b-121">Creating a Repository Interface</span></span>

<span data-ttu-id="12c5b-122">您一開始先建立儲存機制介面。</span><span class="sxs-lookup"><span data-stu-id="12c5b-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="12c5b-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="12c5b-124">在  *DAL*資料夾中，建立新的類別檔案，將其命名*ISchoolRepository.cs*，並以下列程式碼取代現有的程式碼：</span><span class="sxs-lookup"><span data-stu-id="12c5b-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="12c5b-125">介面會定義一種方法，針對每個 CRUD （建立、 讀取、 更新、 刪除） 在儲存機制類別中所建立的方法。</span><span class="sxs-lookup"><span data-stu-id="12c5b-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="12c5b-126">在 `SchoolRepository`類別內*SchoolRepository.cs*，表示這個類別會實作`ISchoolRepository`介面：</span><span class="sxs-lookup"><span data-stu-id="12c5b-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="12c5b-127">建立商業邏輯類別</span><span class="sxs-lookup"><span data-stu-id="12c5b-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="12c5b-128">接下來，您將建立商業邏輯類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="12c5b-129">您執行這項操作，讓您可以新增將執行的商務邏輯`ObjectDataSource`控制項，雖然您不會尚未。</span><span class="sxs-lookup"><span data-stu-id="12c5b-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="12c5b-130">現在，新的商務邏輯類別只會執行相同的 CRUD 作業的儲存機制。</span><span class="sxs-lookup"><span data-stu-id="12c5b-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="12c5b-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="12c5b-132">建立新的資料夾並將它命名*BLL*。</span><span class="sxs-lookup"><span data-stu-id="12c5b-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="12c5b-133">(在真實世界應用程式中，商務邏輯層會通常實作為類別程式庫 — 個別的專案，但為了簡化本教學課程中，BLL 類別將會保留在專案資料夾中。)</span><span class="sxs-lookup"><span data-stu-id="12c5b-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="12c5b-134">在  *BLL*資料夾中，建立新的類別檔案，將其命名*SchoolBL.cs*，並以下列程式碼取代現有的程式碼：</span><span class="sxs-lookup"><span data-stu-id="12c5b-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="12c5b-135">此程式碼會建立您所見相同的 CRUD 方法稍早在儲存機制類別中，但而不是直接存取 Entity Framework 方法，它會呼叫儲存機制類別方法。</span><span class="sxs-lookup"><span data-stu-id="12c5b-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="12c5b-136">保存至儲存機制類別的參考類別變數定義為介面類型，而且儲存機制類別會具現化的程式碼會包含在兩個建構函式。</span><span class="sxs-lookup"><span data-stu-id="12c5b-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="12c5b-137">無參數建構函式將會使用`ObjectDataSource`控制項。</span><span class="sxs-lookup"><span data-stu-id="12c5b-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="12c5b-138">它會建立的執行個體`SchoolRepository`您稍早建立的類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="12c5b-139">其他建構函式允許任何商業邏輯類別，以在任何實作存放庫介面的物件具現化的程式碼。</span><span class="sxs-lookup"><span data-stu-id="12c5b-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="12c5b-140">呼叫儲存機制類別和兩個建構函式的 CRUD 方法可使您能夠使用您選擇的任何後端資料存放區中的商務邏輯類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="12c5b-141">商務邏輯的類別不會不需要知道如何呼叫的類別會保存資料。</span><span class="sxs-lookup"><span data-stu-id="12c5b-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="12c5b-142">(這通常稱為*永續性無知*。)這有助於進行單元測試，因為您可以連接的項目做為簡單的儲存機制實作商務邏輯的類別為記憶體中`List`來儲存資料的集合。</span><span class="sxs-lookup"><span data-stu-id="12c5b-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="12c5b-143">實體物件技術上來說，是仍不非持續，因為它們從具現化類別繼承自 Entity Framework 的`EntityObject`類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="12c5b-144">您可以使用完整的持續性無知*純舊 CLR 物件*，或*Poco*，來取代繼承的物件`EntityObject`類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="12c5b-145">使用 Poco 已超出本教學課程的範圍。</span><span class="sxs-lookup"><span data-stu-id="12c5b-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="12c5b-146">如需詳細資訊，請參閱 <<c0> [ 可測試性和 Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) MSDN 網站上。)</span><span class="sxs-lookup"><span data-stu-id="12c5b-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>


<span data-ttu-id="12c5b-147">現在您可以連接`ObjectDataSource`商務邏輯的控制項類別，而不是存放庫，並確認一切運作與以前一樣。</span><span class="sxs-lookup"><span data-stu-id="12c5b-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="12c5b-148">在*Departments.aspx*並*DepartmentsAdd.aspx*，變更出現的每個`TypeName="ContosoUniversity.DAL.SchoolRepository"`至`TypeName="ContosoUniversity.BLL.SchoolBL`"。</span><span class="sxs-lookup"><span data-stu-id="12c5b-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="12c5b-149">（有四個執行個體中所有。）</span><span class="sxs-lookup"><span data-stu-id="12c5b-149">(There are four instances in all.)</span></span>

<span data-ttu-id="12c5b-150">執行*Departments.aspx*並*DepartmentsAdd.aspx*頁面，以確認它們仍可如之前一樣。</span><span class="sxs-lookup"><span data-stu-id="12c5b-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="12c5b-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="12c5b-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="12c5b-153">建立單元測試專案和儲存機制實作</span><span class="sxs-lookup"><span data-stu-id="12c5b-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="12c5b-154">將新的專案加入方案使用**測試專案**範本，並將它命名`ContosoUniversity.Tests`。</span><span class="sxs-lookup"><span data-stu-id="12c5b-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="12c5b-155">在 test 專案中加入參考`System.Data.Entity`並加入專案參考`ContosoUniversity`專案。</span><span class="sxs-lookup"><span data-stu-id="12c5b-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="12c5b-156">您現在可以建立包含單元測試，您將使用此儲存機制類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="12c5b-157">此存放庫的資料存放區會在類別中。</span><span class="sxs-lookup"><span data-stu-id="12c5b-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="12c5b-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="12c5b-159">在測試專案中，建立新的類別檔案，將其命名*MockSchoolRepository.cs*，並以下列程式碼取代現有的程式碼：</span><span class="sxs-lookup"><span data-stu-id="12c5b-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="12c5b-160">此儲存機制類別具有相同的 CRUD 方法的直接存取 Entity Framework，但其使用`List`而不是與資料庫的記憶體中的集合。</span><span class="sxs-lookup"><span data-stu-id="12c5b-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="12c5b-161">這可讓您更容易設定和驗證商務邏輯類別的單元測試的測試類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="12c5b-162">建立單元測試</span><span class="sxs-lookup"><span data-stu-id="12c5b-162">Creating Unit Tests</span></span>

<span data-ttu-id="12c5b-163">**測試**專案範本建立虛設常式單元測試類別，和您的下一個工作是針對您想要加入商務邏輯類別的商務邏輯，加入單元測試方法來修改此類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="12c5b-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="12c5b-165">Contoso 大學任何個別的 instructor 只能是單一部門的系統管理員，而且您需要新增商務邏輯，以強制執行此規則。</span><span class="sxs-lookup"><span data-stu-id="12c5b-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="12c5b-166">您會開始將測試加入並執行測試以查看它們會失敗。</span><span class="sxs-lookup"><span data-stu-id="12c5b-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="12c5b-167">您將加入程式碼，然後重新執行測試，以查看其通過預期。</span><span class="sxs-lookup"><span data-stu-id="12c5b-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="12c5b-168">開啟*UnitTest1.cs*檔案，並新增`using`您 ContosoUniversity 專案中建立商業邏輯和資料存取層級的陳述式：</span><span class="sxs-lookup"><span data-stu-id="12c5b-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="12c5b-169">取代`TestMethod1`方法，使用下列方法：</span><span class="sxs-lookup"><span data-stu-id="12c5b-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="12c5b-170">`CreateSchoolBL`方法會建立您所建立的單元測試專案，然後將傳遞至商業邏輯類別的新執行個體的儲存機制類別的執行個體。</span><span class="sxs-lookup"><span data-stu-id="12c5b-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="12c5b-171">然後，該方法會將測試方法中，您可以使用三個部門使用的商務邏輯的類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="12c5b-172">測試方法確認商務邏輯的類別將會發生例外狀況，如果有人嘗試插入具有相同的系統管理員為現有的部門，新科系，或如果有人嘗試更新部門的系統管理員將它設定為 人員識別碼誰已是另一個科系的管理員。</span><span class="sxs-lookup"><span data-stu-id="12c5b-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="12c5b-173">您未建立例外狀況類別，因此將不會編譯此程式碼。</span><span class="sxs-lookup"><span data-stu-id="12c5b-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="12c5b-174">若要取得其進行編譯，以滑鼠右鍵按一下`DuplicateAdministratorException`，然後選取**產生**，然後**類別**。</span><span class="sxs-lookup"><span data-stu-id="12c5b-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="12c5b-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="12c5b-176">這會建立類別在測試專案中，您可以刪除其主專案中建立例外狀況類別之後。</span><span class="sxs-lookup"><span data-stu-id="12c5b-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="12c5b-177">和實作商務邏輯。</span><span class="sxs-lookup"><span data-stu-id="12c5b-177">and implemented the business logic.</span></span>

<span data-ttu-id="12c5b-178">執行測試專案。</span><span class="sxs-lookup"><span data-stu-id="12c5b-178">Run the test project.</span></span> <span data-ttu-id="12c5b-179">如預期般運作，測試就會失敗。</span><span class="sxs-lookup"><span data-stu-id="12c5b-179">As expected, the tests fail.</span></span>

<span data-ttu-id="12c5b-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="12c5b-181">新增商務邏輯，以進行測試</span><span class="sxs-lookup"><span data-stu-id="12c5b-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="12c5b-182">接下來，您將實作商務邏輯，可讓您更不可能將設定為部門的系統管理員已經是另一個科系的系統管理員的人。</span><span class="sxs-lookup"><span data-stu-id="12c5b-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="12c5b-183">您將會擲回的例外狀況，從商務邏輯層，並再攔截展示層中如果使用者編輯一個部門，並按**更新**之後選取已經是系統管理員的人。</span><span class="sxs-lookup"><span data-stu-id="12c5b-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="12c5b-184">（您也可以從下拉式清單中已經具有系統管理員身分先轉譯頁面上，移除講師，但這裡的目的是要使用商務邏輯層）。</span><span class="sxs-lookup"><span data-stu-id="12c5b-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="12c5b-185">開始建立當使用者嘗試進行講師的多個部門系統管理員，將會擲回的例外狀況類別。</span><span class="sxs-lookup"><span data-stu-id="12c5b-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="12c5b-186">在主專案中，建立新的類別檔案中*BLL*資料夾，其命名*DuplicateAdministratorException.cs*，並以下列程式碼取代現有的程式碼：</span><span class="sxs-lookup"><span data-stu-id="12c5b-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="12c5b-187">現在刪除暫存*DuplicateAdministratorException.cs*您稍早建立的測試專案中，才能夠編譯的檔案。</span><span class="sxs-lookup"><span data-stu-id="12c5b-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="12c5b-188">在主專案中，開啟*SchoolBL.cs*檔案，並新增下列方法，其中包含驗證邏輯。</span><span class="sxs-lookup"><span data-stu-id="12c5b-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="12c5b-189">（程式碼是指您稍後將建立的方法）。</span><span class="sxs-lookup"><span data-stu-id="12c5b-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="12c5b-190">您會呼叫這個方法，當您插入或更新`Department`以檢查另一個部門是否已經有相同的系統管理員的實體。</span><span class="sxs-lookup"><span data-stu-id="12c5b-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="12c5b-191">程式碼會呼叫方法來搜尋的資料庫`Department`具有相同的實體`Administrator`做為實體的屬性值所插入或更新。</span><span class="sxs-lookup"><span data-stu-id="12c5b-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="12c5b-192">如果有，程式碼會擲回例外狀況。</span><span class="sxs-lookup"><span data-stu-id="12c5b-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="12c5b-193">如果正在插入或更新的實體沒有，則需要任何驗證檢查`Administrator`如果在更新期間呼叫這個方法擲回值和任何例外狀況和`Department`找到相符項目實體`Department`正在更新實體。</span><span class="sxs-lookup"><span data-stu-id="12c5b-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="12c5b-194">呼叫新方法，從`Insert`和`Update`方法：</span><span class="sxs-lookup"><span data-stu-id="12c5b-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="12c5b-195">在  *ISchoolRepository.cs*，加入新的資料存取方法的下列宣告：</span><span class="sxs-lookup"><span data-stu-id="12c5b-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="12c5b-196">在  *SchoolRepository.cs*，新增下列`using`陳述式：</span><span class="sxs-lookup"><span data-stu-id="12c5b-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="12c5b-197">在  *SchoolRepository.cs*，新增下列新的資料存取方法：</span><span class="sxs-lookup"><span data-stu-id="12c5b-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="12c5b-198">此程式碼會擷取`Department`有指定的系統管理員的實體。</span><span class="sxs-lookup"><span data-stu-id="12c5b-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="12c5b-199">只有一個部門應該找 （如果有的話）。</span><span class="sxs-lookup"><span data-stu-id="12c5b-199">Only one department should be found (if any).</span></span> <span data-ttu-id="12c5b-200">不過，因為沒有條件約束內建資料庫，傳回的型別是集合萬一發現多個部門。</span><span class="sxs-lookup"><span data-stu-id="12c5b-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="12c5b-201">根據預設，物件內容從資料庫擷取實體時，它會追蹤的它們在其物件狀態管理員中。</span><span class="sxs-lookup"><span data-stu-id="12c5b-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="12c5b-202">`MergeOption.NoTracking`參數會指定此追蹤不會完成此查詢。</span><span class="sxs-lookup"><span data-stu-id="12c5b-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="12c5b-203">這是必要的因為查詢可能會傳回您想要更新的實際實體，然後您就無法將該實體。</span><span class="sxs-lookup"><span data-stu-id="12c5b-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="12c5b-204">例如，如果您編輯中的歷程記錄部門*Departments.aspx*頁面並保持不變的系統管理員，此查詢會傳回記錄部門。</span><span class="sxs-lookup"><span data-stu-id="12c5b-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="12c5b-205">如果`NoTracking`未設定，物件內容會在它的物件狀態管理員中已經有記錄 department 實體。</span><span class="sxs-lookup"><span data-stu-id="12c5b-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="12c5b-206">然後當您附加記錄 department 實體，就會重新建立從檢視狀態時，物件內容會擲回例外狀況指出`"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`。</span><span class="sxs-lookup"><span data-stu-id="12c5b-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="12c5b-207">(指定的替代方式為`MergeOption.NoTracking`，您可以建立新的物件內容，只針對此查詢。</span><span class="sxs-lookup"><span data-stu-id="12c5b-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="12c5b-208">因為新的物件內容會有它自己的物件狀態管理員，會有任何衝突時您呼叫`Attach`方法。</span><span class="sxs-lookup"><span data-stu-id="12c5b-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="12c5b-209">新的物件內容會與原始的物件內容中，共用中繼資料和資料庫的連線，因此此替代方法對效能造成負面影響會最少。</span><span class="sxs-lookup"><span data-stu-id="12c5b-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="12c5b-210">不過，引進了這裡所顯示的方式`NoTracking`選項，您會找到其他內容中很有用。</span><span class="sxs-lookup"><span data-stu-id="12c5b-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="12c5b-211">`NoTracking`選項將會討論在本系列稍後的教學課程中進一步。)</span><span class="sxs-lookup"><span data-stu-id="12c5b-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="12c5b-212">在測試專案中加入新的資料存取方法，來*MockSchoolRepository.cs*:</span><span class="sxs-lookup"><span data-stu-id="12c5b-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="12c5b-213">此程式碼使用 LINQ 執行相同的資料選取範圍，`ContosoUniversity`專案存放庫會使用 LINQ to Entities 的。</span><span class="sxs-lookup"><span data-stu-id="12c5b-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="12c5b-214">再次執行測試專案。</span><span class="sxs-lookup"><span data-stu-id="12c5b-214">Run the test project again.</span></span> <span data-ttu-id="12c5b-215">測試這一次會成功。</span><span class="sxs-lookup"><span data-stu-id="12c5b-215">This time the tests pass.</span></span>

<span data-ttu-id="12c5b-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="12c5b-217">ObjectDataSource 例外狀況處理</span><span class="sxs-lookup"><span data-stu-id="12c5b-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="12c5b-218">在 `ContosoUniversity`專案中，執行*Departments.aspx*頁面上，並嘗試變更某部門的系統管理員已為另一個部門的系統管理員的人。</span><span class="sxs-lookup"><span data-stu-id="12c5b-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="12c5b-219">（請記住因為資料庫已預先載入含無效資料，您只能編輯您在本教學課程中，新增的部門）。您會取得下列的 [伺服器] 錯誤頁面：</span><span class="sxs-lookup"><span data-stu-id="12c5b-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="12c5b-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="12c5b-221">您不想要查看這種錯誤頁面，因此，您需要新增錯誤處理程式碼的使用者。</span><span class="sxs-lookup"><span data-stu-id="12c5b-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="12c5b-222">開啟*Departments.aspx*並指定的處理常式`OnUpdated`事件的`DepartmentsObjectDataSource`。</span><span class="sxs-lookup"><span data-stu-id="12c5b-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="12c5b-223">`ObjectDataSource`開頭標記，現在類似下列範例。</span><span class="sxs-lookup"><span data-stu-id="12c5b-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="12c5b-224">在  *Departments.aspx.cs*，新增下列`using`陳述式：</span><span class="sxs-lookup"><span data-stu-id="12c5b-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="12c5b-225">新增下列處理常式`Updated`事件：</span><span class="sxs-lookup"><span data-stu-id="12c5b-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="12c5b-226">如果`ObjectDataSource`嘗試執行更新時，控制會攔截到例外狀況，它就會傳遞例外狀況的事件引數 (`e`) 給這個處理常式。</span><span class="sxs-lookup"><span data-stu-id="12c5b-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="12c5b-227">在處理常式的程式碼會檢查例外狀況是否為重複的系統管理員的例外狀況。</span><span class="sxs-lookup"><span data-stu-id="12c5b-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="12c5b-228">如果是，程式碼會建立包含錯誤訊息的驗證程式控制項`ValidationSummary`控制項來顯示。</span><span class="sxs-lookup"><span data-stu-id="12c5b-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="12c5b-229">執行此頁面，並嘗試讓某位使用者的兩個部門系統管理員一次。</span><span class="sxs-lookup"><span data-stu-id="12c5b-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="12c5b-230">這次`ValidationSummary`控制項會顯示一則錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="12c5b-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="12c5b-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="12c5b-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="12c5b-232">進行類似變更*DepartmentsAdd.aspx*頁面。</span><span class="sxs-lookup"><span data-stu-id="12c5b-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="12c5b-233">在  *DepartmentsAdd.aspx*，指定的處理常式`OnInserted`事件的`DepartmentsObjectDataSource`。</span><span class="sxs-lookup"><span data-stu-id="12c5b-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="12c5b-234">產生的標記將類似下列的範例。</span><span class="sxs-lookup"><span data-stu-id="12c5b-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="12c5b-235">在  *DepartmentsAdd.aspx.cs*，將相同`using`陳述式：</span><span class="sxs-lookup"><span data-stu-id="12c5b-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="12c5b-236">新增下列事件處理常式：</span><span class="sxs-lookup"><span data-stu-id="12c5b-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="12c5b-237">您現在可以測試*DepartmentsAdd.aspx.cs*頁面，確認它也可正確地處理嘗試讓一人以上一個部門的系統管理員。</span><span class="sxs-lookup"><span data-stu-id="12c5b-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="12c5b-238">如此即完成實作使用的儲存機制模式的簡介`ObjectDataSource`與 Entity Framework 的控制項。</span><span class="sxs-lookup"><span data-stu-id="12c5b-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="12c5b-239">如需儲存機制模式和可測試性的詳細資訊，請參閱 MSDN 白皮書[可測試性和 Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx)。</span><span class="sxs-lookup"><span data-stu-id="12c5b-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="12c5b-240">在下列教學課程中，您會看到如何將排序和篩選功能給應用程式。</span><span class="sxs-lookup"><span data-stu-id="12c5b-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="12c5b-241">[上一頁](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
> [下一頁](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="12c5b-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
