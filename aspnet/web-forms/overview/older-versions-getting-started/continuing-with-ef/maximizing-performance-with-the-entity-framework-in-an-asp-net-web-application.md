---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
title: 在 ASP.NET 4 Web 應用程式中使用 Entity Framework 4.0 將效能最大化 |Microsoft Docs
author: tdykstra
description: 本教學課程系列是以 Entity Framework 4.0 教學課程系列的消費者入門所建立的 Contoso 大學 web 應用程式為基礎。 I...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: 4e43455e-dfa1-42db-83cb-c987703f04b5
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 5630200a1ad1d30f6d89b38e15179f15b699fa9f
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78545959"
---
# <a name="maximizing-performance-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="535e8-104">在 ASP.NET 4 Web 應用程式中使用 Entity Framework 4.0 將效能最大化</span><span class="sxs-lookup"><span data-stu-id="535e8-104">Maximizing Performance with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="535e8-105">由[Tom 作者: dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="535e8-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="535e8-106">本教學課程系列是[以 Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started)教學課程系列的消費者入門所建立的 Contoso 大學 web 應用程式為基礎。</span><span class="sxs-lookup"><span data-stu-id="535e8-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="535e8-107">如果您未完成先前的教學課程，做為本教學課程的起點，您可以下載您所建立[的應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)。</span><span class="sxs-lookup"><span data-stu-id="535e8-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="535e8-108">您也可以下載完整的教學課程系列所建立[的應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)。</span><span class="sxs-lookup"><span data-stu-id="535e8-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="535e8-109">如果您有關于教學課程的問題，可以將其張貼到[ASP.NET Entity Framework 論壇](https://forums.asp.net/1227.aspx)。</span><span class="sxs-lookup"><span data-stu-id="535e8-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="535e8-110">在上一個教學課程中，您已瞭解如何處理並行衝突。</span><span class="sxs-lookup"><span data-stu-id="535e8-110">In the previous tutorial, you saw how to handle concurrency conflicts.</span></span> <span data-ttu-id="535e8-111">本教學課程會示範用來改善使用 Entity Framework 之 ASP.NET web 應用程式效能的選項。</span><span class="sxs-lookup"><span data-stu-id="535e8-111">This tutorial shows options for improving the performance of an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="535e8-112">您將瞭解幾種可將效能最大化的方法，或是用來診斷效能問題的方法。</span><span class="sxs-lookup"><span data-stu-id="535e8-112">You'll learn several methods for maximizing performance or for diagnosing performance problems.</span></span>

<span data-ttu-id="535e8-113">下列各節所提供的資訊，可能會在各種不同的案例中很有用：</span><span class="sxs-lookup"><span data-stu-id="535e8-113">Information presented in the following sections is likely to be useful in a broad variety of scenarios:</span></span>

- <span data-ttu-id="535e8-114">有效率地載入相關資料。</span><span class="sxs-lookup"><span data-stu-id="535e8-114">Efficiently load related data.</span></span>
- <span data-ttu-id="535e8-115">管理檢視狀態。</span><span class="sxs-lookup"><span data-stu-id="535e8-115">Manage view state.</span></span>

<span data-ttu-id="535e8-116">如果您有顯示效能問題的個別查詢，下列各節所提供的資訊可能會很有用：</span><span class="sxs-lookup"><span data-stu-id="535e8-116">Information presented in the following sections might be useful if you have individual queries that present performance problems:</span></span>

- <span data-ttu-id="535e8-117">使用 [`NoTracking` 合併] 選項。</span><span class="sxs-lookup"><span data-stu-id="535e8-117">Use the `NoTracking` merge option.</span></span>
- <span data-ttu-id="535e8-118">預先編譯 LINQ 查詢。</span><span class="sxs-lookup"><span data-stu-id="535e8-118">Pre-compile LINQ queries.</span></span>
- <span data-ttu-id="535e8-119">檢查傳送至資料庫的查詢命令。</span><span class="sxs-lookup"><span data-stu-id="535e8-119">Examine query commands sent to the database.</span></span>

<span data-ttu-id="535e8-120">在下一節中提供的資訊，對於具有極大資料模型的應用程式可能很有用：</span><span class="sxs-lookup"><span data-stu-id="535e8-120">Information presented in the following section is potentially useful for applications that have extremely large data models:</span></span>

- <span data-ttu-id="535e8-121">預先產生的視圖。</span><span class="sxs-lookup"><span data-stu-id="535e8-121">Pre-generate views.</span></span>

> [!NOTE]
> <span data-ttu-id="535e8-122">Web 應用程式效能會受到許多因素的影響，包括要求和回應資料的大小、資料庫查詢的速度、伺服器可以佇列的要求數，以及服務的效能，甚至是任何專案的效率。您可能使用的用戶端腳本程式庫。</span><span class="sxs-lookup"><span data-stu-id="535e8-122">Web application performance is affected by many factors, including things like the size of request and response data, the speed of database queries, how many requests the server can queue and how quickly it can service them, and even the efficiency of any client-script libraries you might be using.</span></span> <span data-ttu-id="535e8-123">如果您的應用程式中的效能非常重要，或測試或經驗顯示應用程式效能並不令人滿意，您應該遵循正常的通訊協定來進行效能調整。</span><span class="sxs-lookup"><span data-stu-id="535e8-123">If performance is critical in your application, or if testing or experience shows that application performance isn't satisfactory, you should follow normal protocol for performance tuning.</span></span> <span data-ttu-id="535e8-124">測量以判斷效能瓶頸發生的位置，然後解決將對整體應用程式效能造成最大影響的區域。</span><span class="sxs-lookup"><span data-stu-id="535e8-124">Measure to determine where performance bottlenecks are occurring, and then address the areas that will have the greatest impact on overall application performance.</span></span>
> 
> <span data-ttu-id="535e8-125">本主題主要著重于您可以在 ASP.NET 中特別改善 Entity Framework 效能的方式。</span><span class="sxs-lookup"><span data-stu-id="535e8-125">This topic focuses mainly on ways in which you can potentially improve the performance specifically of the Entity Framework in ASP.NET.</span></span> <span data-ttu-id="535e8-126">如果您判斷資料存取是應用程式中的其中一個效能瓶頸，這裡的建議很有用。</span><span class="sxs-lookup"><span data-stu-id="535e8-126">The suggestions here are useful if you determine that data access is one of the performance bottlenecks in your application.</span></span> <span data-ttu-id="535e8-127">除非特別說明，否則此處所述的方法不應視為 &quot;最佳作法&quot;，其中有許多僅適用于例外狀況，或因應特定類型的效能瓶頸。</span><span class="sxs-lookup"><span data-stu-id="535e8-127">Except as noted, the methods explained here shouldn't be considered &quot;best practices&quot; in general — many of them are appropriate only in exceptional situations or to address very specific kinds of performance bottlenecks.</span></span>

<span data-ttu-id="535e8-128">若要開始本教學課程，請啟動 Visual Studio，並開啟您在上一個教學課程中使用的 Contoso 大學 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="535e8-128">To start the tutorial, start Visual Studio and open the Contoso University web application that you were working with in the previous tutorial.</span></span>

## <a name="efficiently-loading-related-data"></a><span data-ttu-id="535e8-129">有效率地載入相關資料</span><span class="sxs-lookup"><span data-stu-id="535e8-129">Efficiently Loading Related Data</span></span>

<span data-ttu-id="535e8-130">Entity Framework 可以透過數種方式將相關資料載入至實體的導覽屬性：</span><span class="sxs-lookup"><span data-stu-id="535e8-130">There are several ways that the Entity Framework can load related data into the navigation properties of an entity:</span></span>

- <span data-ttu-id="535e8-131">*消極式載入*。</span><span class="sxs-lookup"><span data-stu-id="535e8-131">*Lazy loading*.</span></span> <span data-ttu-id="535e8-132">第一次讀取實體時，不會擷取相關資料。</span><span class="sxs-lookup"><span data-stu-id="535e8-132">When the entity is first read, related data isn't retrieved.</span></span> <span data-ttu-id="535e8-133">不過，第一次嘗試存取導覽屬性時，將會自動擷取該導覽屬性所需的資料。</span><span class="sxs-lookup"><span data-stu-id="535e8-133">However, the first time you attempt to access a navigation property, the data required for that navigation property is automatically retrieved.</span></span> <span data-ttu-id="535e8-134">這會導致多個查詢傳送至資料庫，一個用於實體本身，而每次必須取得實體的相關資料。</span><span class="sxs-lookup"><span data-stu-id="535e8-134">This results in multiple queries sent to the database — one for the entity itself and one each time that related data for the entity must be retrieved.</span></span> 

    <span data-ttu-id="535e8-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="535e8-136">*積極式載入*。</span><span class="sxs-lookup"><span data-stu-id="535e8-136">*Eager loading*.</span></span> <span data-ttu-id="535e8-137">讀取實體時，將會同時擷取其相關資料。</span><span class="sxs-lookup"><span data-stu-id="535e8-137">When the entity is read, related data is retrieved along with it.</span></span> <span data-ttu-id="535e8-138">這通常會導致單一聯結查詢，其可擷取所有需要的資料。</span><span class="sxs-lookup"><span data-stu-id="535e8-138">This typically results in a single join query that retrieves all of the data that's needed.</span></span> <span data-ttu-id="535e8-139">您可以使用 `Include` 方法來指定積極式載入，如同您已在這些教學課程中所見。</span><span class="sxs-lookup"><span data-stu-id="535e8-139">You specify eager loading by using the `Include` method, as you've seen already in these tutorials.</span></span>

<span data-ttu-id="535e8-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

- <span data-ttu-id="535e8-141">*明確式載入*。</span><span class="sxs-lookup"><span data-stu-id="535e8-141">*Explicit loading*.</span></span> <span data-ttu-id="535e8-142">這類似于消極式載入，不同之處在于您在程式碼中明確地取得相關資料。當您存取導覽屬性時，不會自動進行此動作。</span><span class="sxs-lookup"><span data-stu-id="535e8-142">This is similar to lazy loading, except that you explicitly retrieve the related data in code; it doesn't happen automatically when you access a navigation property.</span></span> <span data-ttu-id="535e8-143">您可以使用集合之導覽屬性的 `Load` 方法手動載入相關資料，或使用參考屬性的 `Load` 方法來保存單一物件的屬性。</span><span class="sxs-lookup"><span data-stu-id="535e8-143">You load related data manually using the `Load` method of the navigation property for collections, or you use the `Load` method of the reference property for properties that hold a single object.</span></span> <span data-ttu-id="535e8-144">（例如，您可以呼叫 `PersonReference.Load` 方法，載入 `Department` 實體的 `Person` 導覽屬性）。</span><span class="sxs-lookup"><span data-stu-id="535e8-144">(For example, you call the `PersonReference.Load` method to load the `Person` navigation property of a `Department` entity.)</span></span>

    <span data-ttu-id="535e8-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="535e8-146">因為它們不會立即取得屬性值，所以消極式載入和明確載入也稱為*延後載入*。</span><span class="sxs-lookup"><span data-stu-id="535e8-146">Because they don't immediately retrieve the property values, lazy loading and explicit loading are also both known as *deferred loading*.</span></span>

<span data-ttu-id="535e8-147">消極式載入是設計工具所產生之物件內容的預設行為。</span><span class="sxs-lookup"><span data-stu-id="535e8-147">Lazy loading is the default behavior for an object context that has been generated by the designer.</span></span> <span data-ttu-id="535e8-148">如果您開啟定義物件內容類別的*SchoolModel.Designer.cs*檔案，您會發現三個方法，其中每一個都包含下列語句：</span><span class="sxs-lookup"><span data-stu-id="535e8-148">If you open the *SchoolModel.Designer.cs* file that defines the object context class, you'll find three constructor methods, and each of them includes the following statement:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="535e8-149">一般來說，如果您知道每個抓取的實體都需要相關資料，積極式載入會提供最佳效能，因為傳送至資料庫的單一查詢通常比每個所抓取之實體的個別查詢更有效率。</span><span class="sxs-lookup"><span data-stu-id="535e8-149">In general, if you know you need related data for every entity retrieved, eager loading offers the best performance, because a single query sent to the database is typically more efficient than separate queries for each entity retrieved.</span></span> <span data-ttu-id="535e8-150">另一方面，如果您只需要針對一小部分實體存取實體的導覽屬性，則消極式載入或明確載入可能會更有效率，因為積極式載入會抓取比您所需更多的資料。</span><span class="sxs-lookup"><span data-stu-id="535e8-150">On the other hand, if you need to access an entity's navigation properties only infrequently or only for a small set of the entities, lazy loading or explicit loading may be more efficient, because eager loading would retrieve more data than you need.</span></span>

<span data-ttu-id="535e8-151">在 web 應用程式中，消極式載入的值仍然可能相對較小，因為影響相關資料需求的使用者動作會在瀏覽器中進行，而這與轉譯頁面的物件內容沒有任何連接。</span><span class="sxs-lookup"><span data-stu-id="535e8-151">In a web application, lazy loading may be of relatively little value anyway, because user actions that affect the need for related data take place in the browser, which has no connection to the object context that rendered the page.</span></span> <span data-ttu-id="535e8-152">相反地，當您將控制項進行資料繫結時，通常會知道您需要什麼資料，因此通常最好是根據每個案例的適當程度來選擇積極式載入或延後載入。</span><span class="sxs-lookup"><span data-stu-id="535e8-152">On the other hand, when you databind a control, you typically know what data you need, and so it's generally best to choose eager loading or deferred loading based on what's appropriate in each scenario.</span></span>

<span data-ttu-id="535e8-153">此外，在處置物件內容之後，資料系結控制項可能會使用實體物件。</span><span class="sxs-lookup"><span data-stu-id="535e8-153">In addition, a databound control might use an entity object after the object context is disposed.</span></span> <span data-ttu-id="535e8-154">在這種情況下，嘗試延遲載入導覽屬性會失敗。</span><span class="sxs-lookup"><span data-stu-id="535e8-154">In that case, an attempt to lazy-load a navigation property would fail.</span></span> <span data-ttu-id="535e8-155">您收到的錯誤訊息很明確： &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span><span class="sxs-lookup"><span data-stu-id="535e8-155">The error message you receive is clear: &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span></span>

<span data-ttu-id="535e8-156">`EntityDataSource` 控制項預設會停用延遲載入。</span><span class="sxs-lookup"><span data-stu-id="535e8-156">The `EntityDataSource` control disables lazy loading by default.</span></span> <span data-ttu-id="535e8-157">針對目前教學課程所使用的 `ObjectDataSource` 控制項（或者，如果您從頁面程式碼存取物件內容），有幾種方式可以讓延遲載入預設為停用。</span><span class="sxs-lookup"><span data-stu-id="535e8-157">For the `ObjectDataSource` control that you're using for the current tutorial (or if you access the object context from page code), there are several ways you can make lazy loading disabled by default.</span></span> <span data-ttu-id="535e8-158">當您具現化物件內容時，可以將它停用。</span><span class="sxs-lookup"><span data-stu-id="535e8-158">You can disable it when you instantiate an object context.</span></span> <span data-ttu-id="535e8-159">例如，您可以將下列程式程式碼新增至 `SchoolRepository` 類別的「函式」方法：</span><span class="sxs-lookup"><span data-stu-id="535e8-159">For example, you can add the following line to the constructor method of the `SchoolRepository` class:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="535e8-160">針對 Contoso 大學應用程式，您會讓物件內容自動停用消極式載入，如此一來，每當內容具現化時，就不需要設定此屬性。</span><span class="sxs-lookup"><span data-stu-id="535e8-160">For the Contoso University application, you'll make the object context automatically disable lazy loading so that this property doesn't have to be set whenever a context is instantiated.</span></span>

<span data-ttu-id="535e8-161">開啟 [ *SchoolModel* ] 資料模型，按一下設計介面，然後在 [屬性] 窗格中，將 [**已啟用的延遲載入**] 屬性設定為 [`False`]。</span><span class="sxs-lookup"><span data-stu-id="535e8-161">Open the *SchoolModel.edmx* data model, click the design surface, and then in the properties pane set the **Lazy Loading Enabled** property to `False`.</span></span> <span data-ttu-id="535e8-162">儲存並關閉資料模型。</span><span class="sxs-lookup"><span data-stu-id="535e8-162">Save and close the data model.</span></span>

<span data-ttu-id="535e8-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

## <a name="managing-view-state"></a><span data-ttu-id="535e8-164">管理檢視狀態</span><span class="sxs-lookup"><span data-stu-id="535e8-164">Managing View State</span></span>

<span data-ttu-id="535e8-165">為了提供更新功能，ASP.NET 網頁必須在呈現頁面時儲存實體的原始屬性值。</span><span class="sxs-lookup"><span data-stu-id="535e8-165">In order to provide update functionality, an ASP.NET web page must store the original property values of an entity when a page is rendered.</span></span> <span data-ttu-id="535e8-166">在回傳處理期間，控制項可以重新建立實體的原始狀態，並在套用變更並呼叫 `SaveChanges` 方法之前，先呼叫實體的 `Attach` 方法。</span><span class="sxs-lookup"><span data-stu-id="535e8-166">During postback processing the control can re-create the original state of the entity and call the entity's `Attach` method before applying changes and calling the `SaveChanges` method.</span></span> <span data-ttu-id="535e8-167">根據預設，ASP.NET Web Forms 資料控制項會使用 view 狀態來儲存原始值。</span><span class="sxs-lookup"><span data-stu-id="535e8-167">By default, ASP.NET Web Forms data controls use view state to store the original values.</span></span> <span data-ttu-id="535e8-168">不過，檢視狀態會影響效能，因為它會儲存在隱藏欄位中，大幅增加與瀏覽器之間傳送的頁面大小。</span><span class="sxs-lookup"><span data-stu-id="535e8-168">However, view state can affect performance, because it's stored in hidden fields that can substantially increase the size of the page that's sent to and from the browser.</span></span>

<span data-ttu-id="535e8-169">管理檢視狀態的技術，或會話狀態之類的替代方法，對 Entity Framework 而言並不獨特，因此本教學課程不會詳細說明此主題。</span><span class="sxs-lookup"><span data-stu-id="535e8-169">Techniques for managing view state, or alternatives such as session state, aren't unique to the Entity Framework, so this tutorial doesn't go into this topic in detail.</span></span> <span data-ttu-id="535e8-170">如需詳細資訊，請參閱本教學課程結尾處的連結。</span><span class="sxs-lookup"><span data-stu-id="535e8-170">For more information see the links at the end of the tutorial.</span></span>

<span data-ttu-id="535e8-171">不過，ASP.NET 的第4版提供了一種新的方式來使用 view 狀態，Web Forms 應用程式的每個 ASP.NET 開發人員都應該知道： `ViewStateMode` 屬性。</span><span class="sxs-lookup"><span data-stu-id="535e8-171">However, version 4 of ASP.NET provides a new way of working with view state that every ASP.NET developer of Web Forms applications should be aware of: the `ViewStateMode` property.</span></span> <span data-ttu-id="535e8-172">這個新屬性可以在頁面或控制項層級設定，而且它可以讓您停用頁面的預設檢視狀態，並僅針對需要它的控制項加以啟用。</span><span class="sxs-lookup"><span data-stu-id="535e8-172">This new property can be set at the page or control level, and it enables you to disable view state by default for a page and enable it only for controls that need it.</span></span>

<span data-ttu-id="535e8-173">對於效能非常重要的應用程式，最好一律停用頁面層級的 view state，並只針對需要它的控制項加以啟用。</span><span class="sxs-lookup"><span data-stu-id="535e8-173">For applications where performance is critical, a good practice is to always disable view state at the page level and enable it only for controls that require it.</span></span> <span data-ttu-id="535e8-174">這種方法不會大幅減少 Contoso 大學頁面中的檢視狀態大小，但若要查看其運作方式，請在 [ *default.aspx* ] 頁面上執行此動作。</span><span class="sxs-lookup"><span data-stu-id="535e8-174">The size of view state in the Contoso University pages wouldn't be substantially decreased by this method, but to see how it works, you'll do it for the *Instructors.aspx* page.</span></span> <span data-ttu-id="535e8-175">該頁面包含許多控制項，包括已停用檢視狀態的 `Label` 控制項。</span><span class="sxs-lookup"><span data-stu-id="535e8-175">That page contains many controls, including a `Label` control that has view state disabled.</span></span> <span data-ttu-id="535e8-176">此頁面上的控制項都不需要啟用檢視狀態。</span><span class="sxs-lookup"><span data-stu-id="535e8-176">None of the controls on this page actually need to have view state enabled.</span></span> <span data-ttu-id="535e8-177">（`GridView` 控制項的 `DataKeyNames` 屬性會指定必須在回傳之間維護的狀態，但這些值會保留在控制項狀態中，而不會受到 `ViewStateMode` 屬性的影響）。</span><span class="sxs-lookup"><span data-stu-id="535e8-177">(The `DataKeyNames` property of the `GridView` control specifies state that must be maintained between postbacks, but these values are kept in control state, which isn't affected by the `ViewStateMode` property.)</span></span>

<span data-ttu-id="535e8-178">`Page` 指示詞和 `Label` 控制項標記目前與下列範例類似：</span><span class="sxs-lookup"><span data-stu-id="535e8-178">The `Page` directive and `Label` control markup currently resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="535e8-179">進行下列變更：</span><span class="sxs-lookup"><span data-stu-id="535e8-179">Make the following changes:</span></span>

- <span data-ttu-id="535e8-180">將 `ViewStateMode="Disabled"` 新增至 `Page` 指示詞。</span><span class="sxs-lookup"><span data-stu-id="535e8-180">Add `ViewStateMode="Disabled"` to the `Page` directive.</span></span>
- <span data-ttu-id="535e8-181">從 `Label` 控制項移除 `ViewStateMode="Disabled"`。</span><span class="sxs-lookup"><span data-stu-id="535e8-181">Remove `ViewStateMode="Disabled"` from the `Label` control.</span></span>

<span data-ttu-id="535e8-182">標記現在與下列範例類似：</span><span class="sxs-lookup"><span data-stu-id="535e8-182">The markup now resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="535e8-183">所有控制項的檢視狀態現在已停用。</span><span class="sxs-lookup"><span data-stu-id="535e8-183">View state is now disabled for all controls.</span></span> <span data-ttu-id="535e8-184">如果您稍後新增的控制項需要使用檢視狀態，您只需要包含該控制項的 `ViewStateMode="Enabled"` 屬性。</span><span class="sxs-lookup"><span data-stu-id="535e8-184">If you later add a control that does need to use view state, all you need to do is include the `ViewStateMode="Enabled"` attribute for that control.</span></span>

## <a name="using-the-notracking-merge-option"></a><span data-ttu-id="535e8-185">使用 NoTracking 合併選項</span><span class="sxs-lookup"><span data-stu-id="535e8-185">Using The NoTracking Merge Option</span></span>

<span data-ttu-id="535e8-186">當物件內容抓取資料庫資料列並建立代表它們的實體物件時，預設也會使用物件狀態管理員來追蹤這些實體物件。</span><span class="sxs-lookup"><span data-stu-id="535e8-186">When an object context retrieves database rows and creates entity objects that represent them, by default it also tracks those entity objects using its object state manager.</span></span> <span data-ttu-id="535e8-187">此追蹤資料會作為快取，並在您更新實體時使用。</span><span class="sxs-lookup"><span data-stu-id="535e8-187">This tracking data acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="535e8-188">由於 web 應用程式通常會有存留期較短的物件內容實例，因此查詢通常會傳回不需要追蹤的資料，因為讀取它們的物件內容將會在其讀取的任何實體再次使用或更新之前進行處置。</span><span class="sxs-lookup"><span data-stu-id="535e8-188">Because a web application typically has short-lived object context instances, queries often return data that doesn't need to be tracked, because the object context that reads them will be disposed before any of the entities it reads are used again or updated.</span></span>

<span data-ttu-id="535e8-189">在 Entity Framework 中，您可以藉由設定*合併選項*來指定物件內容是否追蹤實體物件。</span><span class="sxs-lookup"><span data-stu-id="535e8-189">In the Entity Framework, you can specify whether the object context tracks entity objects by setting a *merge option*.</span></span> <span data-ttu-id="535e8-190">您可以設定個別查詢或實體集的合併選項。</span><span class="sxs-lookup"><span data-stu-id="535e8-190">You can set the merge option for individual queries or for entity sets.</span></span> <span data-ttu-id="535e8-191">如果您針對實體集設定它，這表示您正在針對針對該實體集所建立的所有查詢設定預設的合併選項。</span><span class="sxs-lookup"><span data-stu-id="535e8-191">If you set it for an entity set, that means that you're setting the default merge option for all queries that are created for that entity set.</span></span>

<span data-ttu-id="535e8-192">針對 Contoso 大學應用程式，您從儲存機制存取的任何實體集都不需要追蹤，因此您可以在將存放庫類別中的物件內容具現化時，將合併選項設定為針對這些實體集 `NoTracking`。</span><span class="sxs-lookup"><span data-stu-id="535e8-192">For the Contoso University application, tracking isn't needed for any of the entity sets that you access from the repository, so you can set the merge option to `NoTracking` for those entity sets when you instantiate the object context in the repository class.</span></span> <span data-ttu-id="535e8-193">（請注意，在本教學課程中，設定 [合併] 選項不會對應用程式的效能造成顯著的影響。</span><span class="sxs-lookup"><span data-stu-id="535e8-193">(Note that in this tutorial, setting the merge option won't have a noticeable effect on the application's performance.</span></span> <span data-ttu-id="535e8-194">`NoTracking` 選項在某些高資料量的情況下，可能只會使效能改進。）</span><span class="sxs-lookup"><span data-stu-id="535e8-194">The `NoTracking` option is likely to make an observable performance improvement only in certain high-data-volume scenarios.)</span></span>

<span data-ttu-id="535e8-195">在 DAL 資料夾中，開啟*SchoolRepository.cs*檔案，並新增可為存放庫所存取之實體集設定合併選項的函式方法：</span><span class="sxs-lookup"><span data-stu-id="535e8-195">In the DAL folder, open the *SchoolRepository.cs* file and add a constructor method that sets the merge option for the entity sets that the repository accesses:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

## <a name="pre-compiling-linq-queries"></a><span data-ttu-id="535e8-196">預先編譯 LINQ 查詢</span><span class="sxs-lookup"><span data-stu-id="535e8-196">Pre-Compiling LINQ Queries</span></span>

<span data-ttu-id="535e8-197">第一次 Entity Framework 在給定 `ObjectContext` 實例的生命週期內執行 Entity SQL 查詢時，需要一些時間來編譯查詢。</span><span class="sxs-lookup"><span data-stu-id="535e8-197">The first time that the Entity Framework executes an Entity SQL query within the life of a given `ObjectContext` instance, it takes some time to compile the query.</span></span> <span data-ttu-id="535e8-198">系統會快取編譯的結果，這表示後續執行查詢的速度會更快。</span><span class="sxs-lookup"><span data-stu-id="535e8-198">The result of compilation is cached, which means that subsequent executions of the query are much quicker.</span></span> <span data-ttu-id="535e8-199">LINQ 查詢會遵循類似的模式，但編譯查詢所需的部分工作會在每次執行查詢時完成。</span><span class="sxs-lookup"><span data-stu-id="535e8-199">LINQ queries follow a similar pattern, except that some of the work required to compile the query is done every time the query is executed.</span></span> <span data-ttu-id="535e8-200">換句話說，針對 LINQ 查詢，預設不會快取編譯的所有結果。</span><span class="sxs-lookup"><span data-stu-id="535e8-200">In other words, for LINQ queries, by default not all of the results of compilation are cached.</span></span>

<span data-ttu-id="535e8-201">如果您有預期會在物件內容的生命週期中重複執行的 LINQ 查詢，您可以撰寫程式碼，在第一次執行 LINQ 查詢時，快取所有編譯結果。</span><span class="sxs-lookup"><span data-stu-id="535e8-201">If you have a LINQ query that you expect to run repeatedly in the life of an object context, you can write code that causes all of the results of compilation to be cached the first time the LINQ query is run.</span></span>

<span data-ttu-id="535e8-202">如圖所示，您會在 `SchoolRepository` 類別中的兩個 `Get` 方法中執行此動作，其中一個不接受任何參數（`GetInstructorNames` 方法），而另一個則需要參數（`GetDepartmentsByAdministrator` 方法）。</span><span class="sxs-lookup"><span data-stu-id="535e8-202">As an illustration, you'll do this for two `Get` methods in the `SchoolRepository` class, one of which doesn't take any parameters (the `GetInstructorNames` method), and one that does require a parameter (the `GetDepartmentsByAdministrator` method).</span></span> <span data-ttu-id="535e8-203">這些方法現在實際上不需要編譯，因為它們不是 LINQ 查詢：</span><span class="sxs-lookup"><span data-stu-id="535e8-203">These methods as they stand now actually don't need to be compiled because they aren't LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

<span data-ttu-id="535e8-204">不過，您可以試用已編譯的查詢，如同這些查詢已撰寫為下列 LINQ 查詢一樣繼續進行：</span><span class="sxs-lookup"><span data-stu-id="535e8-204">However, so that you can try out compiled queries, you'll proceed as if these had been written as the following LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="535e8-205">您可以將這些方法中的程式碼變更為上面顯示的內容，並執行應用程式以確認它可正常運作，然後再繼續進行。</span><span class="sxs-lookup"><span data-stu-id="535e8-205">You could change the code in these methods to what's shown above and run the application to verify that it works before continuing.</span></span> <span data-ttu-id="535e8-206">但下列指示直接帶您建立預先編譯的版本。</span><span class="sxs-lookup"><span data-stu-id="535e8-206">But the following instructions jump right into creating pre-compiled versions of them.</span></span>

<span data-ttu-id="535e8-207">在*DAL*資料夾中建立類別檔案，將其命名為*SchoolEntities.cs*，並以下列程式碼取代現有的程式碼：</span><span class="sxs-lookup"><span data-stu-id="535e8-207">Create a class file in the *DAL* folder, name it *SchoolEntities.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="535e8-208">此程式碼會建立部分類別，以擴充自動產生的物件內容類別。</span><span class="sxs-lookup"><span data-stu-id="535e8-208">This code creates a partial class that extends the automatically generated object context class.</span></span> <span data-ttu-id="535e8-209">部分類別包含兩個使用 `CompiledQuery` 類別的 `Compile` 方法編譯的 LINQ 查詢。</span><span class="sxs-lookup"><span data-stu-id="535e8-209">The partial class includes two compiled LINQ queries using the `Compile` method of the `CompiledQuery` class.</span></span> <span data-ttu-id="535e8-210">它也會建立可供您用來呼叫查詢的方法。</span><span class="sxs-lookup"><span data-stu-id="535e8-210">It also creates methods that you can use to call the queries.</span></span> <span data-ttu-id="535e8-211">儲存並關閉此檔案。</span><span class="sxs-lookup"><span data-stu-id="535e8-211">Save and close this file.</span></span>

<span data-ttu-id="535e8-212">接下來，在*SchoolRepository.cs*中，變更存放庫類別中現有的 `GetInstructorNames` 和 `GetDepartmentsByAdministrator` 方法，使其呼叫已編譯的查詢：</span><span class="sxs-lookup"><span data-stu-id="535e8-212">Next, in *SchoolRepository.cs*, change the existing `GetInstructorNames` and `GetDepartmentsByAdministrator` methods in the repository class so that they call the compiled queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

<span data-ttu-id="535e8-213">執行 [*部門 .aspx* ] 頁面，確認它的運作方式與之前相同。</span><span class="sxs-lookup"><span data-stu-id="535e8-213">Run the *Departments.aspx* page to verify that it works as it did before.</span></span> <span data-ttu-id="535e8-214">呼叫 `GetInstructorNames` 方法以填入 [系統管理員] 下拉式清單，並在您按一下 [**更新**] 時呼叫 `GetDepartmentsByAdministrator` 方法，以確認講師不是一個以上部門的系統管理員。</span><span class="sxs-lookup"><span data-stu-id="535e8-214">The `GetInstructorNames` method is called in order to populate the administrator drop-down list, and the `GetDepartmentsByAdministrator` method is called when you click **Update** in order to verify that no instructor is an administrator of more than one department.</span></span>

<span data-ttu-id="535e8-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

<span data-ttu-id="535e8-216">您已在 Contoso 大學應用程式中預先編譯查詢，只是為了瞭解如何執行，而不是因為它會顯著提升改善效能。</span><span class="sxs-lookup"><span data-stu-id="535e8-216">You've pre-compiled queries in the Contoso University application only to see how to do it, not because it would measurably improve performance.</span></span> <span data-ttu-id="535e8-217">預先編譯 LINQ 查詢會在您的程式碼中增加複雜度層級，因此請確定您只針對實際代表應用程式效能瓶頸的查詢執行此動作。</span><span class="sxs-lookup"><span data-stu-id="535e8-217">Pre-compiling LINQ queries does add a level of complexity to your code, so make sure you do it only for queries that actually represent performance bottlenecks in your application.</span></span>

## <a name="examining-queries-sent-to-the-database"></a><span data-ttu-id="535e8-218">檢查傳送至資料庫的查詢</span><span class="sxs-lookup"><span data-stu-id="535e8-218">Examining Queries Sent to the Database</span></span>

<span data-ttu-id="535e8-219">當您調查效能問題時，有時候知道 Entity Framework 傳送至資料庫的確切 SQL 命令會很有説明。</span><span class="sxs-lookup"><span data-stu-id="535e8-219">When you're investigating performance issues, sometimes it's helpful to know the exact SQL commands that the Entity Framework is sending to the database.</span></span> <span data-ttu-id="535e8-220">如果您要使用 `IQueryable` 物件，其中一種方法是使用 `ToTraceString` 方法。</span><span class="sxs-lookup"><span data-stu-id="535e8-220">If you're working with an `IQueryable` object, one way to do this is to use the `ToTraceString` method.</span></span>

<span data-ttu-id="535e8-221">在*SchoolRepository.cs*中，變更 `GetDepartmentsByName` 方法中的程式碼，以符合下列範例：</span><span class="sxs-lookup"><span data-stu-id="535e8-221">In *SchoolRepository.cs*, change the code in the `GetDepartmentsByName` method to match the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.cs)]

<span data-ttu-id="535e8-222">`departments` 變數必須轉換成 `ObjectQuery` 型別，因為上一行結尾的 `Where` 方法會建立 `IQueryable` 物件;如果沒有 `Where` 方法，就不需要轉換。</span><span class="sxs-lookup"><span data-stu-id="535e8-222">The `departments` variable must be cast to an `ObjectQuery` type only because the `Where` method at the end of the preceding line creates an `IQueryable` object; without the `Where` method, the cast would not be necessary.</span></span>

<span data-ttu-id="535e8-223">在 `return` 行上設定中斷點，然後在偵錯工具中執行 [*部門 .aspx* ] 頁面。</span><span class="sxs-lookup"><span data-stu-id="535e8-223">Set a breakpoint on the `return` line, and then run the *Departments.aspx* page in the debugger.</span></span> <span data-ttu-id="535e8-224">當您點擊中斷點時，請檢查 [**區域變數**] 視窗中的 `commandText` 變數，並使用文字視覺化效果（[**值**] 資料行中的放大鏡），在 [**文字視覺化檢視**] 視窗中顯示其值。</span><span class="sxs-lookup"><span data-stu-id="535e8-224">When you hit the breakpoint, examine the `commandText` variable in the **Locals** window and use the text visualizer (the magnifying glass in the **Value** column) to display its value in the **Text Visualizer** window.</span></span> <span data-ttu-id="535e8-225">您可以看到此程式碼所產生的整個 SQL 命令：</span><span class="sxs-lookup"><span data-stu-id="535e8-225">You can see the entire SQL command that results from this code:</span></span>

<span data-ttu-id="535e8-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="535e8-227">或者，Visual Studio Ultimate 中的 IntelliTrace 功能提供一種方式來查看 Entity Framework 所產生的 SQL 命令，而不需要變更您的程式碼，甚至是設定中斷點。</span><span class="sxs-lookup"><span data-stu-id="535e8-227">As an alternative, the IntelliTrace feature in Visual Studio Ultimate provides a way to view SQL commands generated by the Entity Framework that doesn't require you to change your code or even set a breakpoint.</span></span>

> [!NOTE]
> <span data-ttu-id="535e8-228">只有在您有 Visual Studio Ultimate 時，才可以執行下列程式。</span><span class="sxs-lookup"><span data-stu-id="535e8-228">You can perform the following procedures only if you have Visual Studio Ultimate.</span></span>

<span data-ttu-id="535e8-229">還原 `GetDepartmentsByName` 方法中的原始程式碼，然後在偵錯工具中執行 [*部門 .aspx* ] 頁面。</span><span class="sxs-lookup"><span data-stu-id="535e8-229">Restore the original code in the `GetDepartmentsByName` method, and then run the *Departments.aspx* page in the debugger.</span></span>

<span data-ttu-id="535e8-230">在 Visual Studio 中，依序選取 [**調試**] 功能表、[ **intellitrace**] 和 [ **intellitrace 事件**]。</span><span class="sxs-lookup"><span data-stu-id="535e8-230">In Visual Studio, select the **Debug** menu, then **IntelliTrace**, and then **IntelliTrace Events**.</span></span>

<span data-ttu-id="535e8-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="535e8-232">在 [ **IntelliTrace** ] 視窗中，按一下 [**全部中斷**]。</span><span class="sxs-lookup"><span data-stu-id="535e8-232">In the **IntelliTrace** window, click **Break All**.</span></span>

<span data-ttu-id="535e8-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="535e8-234">[ **IntelliTrace** ] 視窗會顯示最近的事件清單：</span><span class="sxs-lookup"><span data-stu-id="535e8-234">The **IntelliTrace** window displays a list of recent events:</span></span>

<span data-ttu-id="535e8-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="535e8-236">按一下 [ **ADO.NET** ] 行。</span><span class="sxs-lookup"><span data-stu-id="535e8-236">Click the **ADO.NET** line.</span></span> <span data-ttu-id="535e8-237">它會展開以顯示命令文字：</span><span class="sxs-lookup"><span data-stu-id="535e8-237">It expands to show you the command text:</span></span>

<span data-ttu-id="535e8-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="535e8-239">您可以從 [**區域變數**] 視窗，將整個命令文字字串複製到剪貼簿。</span><span class="sxs-lookup"><span data-stu-id="535e8-239">You can copy the entire command text string to the clipboard from the **Locals** window.</span></span>

<span data-ttu-id="535e8-240">假設您使用的資料庫具有比簡單 `School` 資料庫更多的資料表、關聯性和資料行。</span><span class="sxs-lookup"><span data-stu-id="535e8-240">Suppose you were working with a database with more tables, relationships, and columns than the simple `School` database.</span></span> <span data-ttu-id="535e8-241">您可能會發現，在包含多個 `Join` 子句的單一 `Select` 語句中收集您所需之所有資訊的查詢，會變得太複雜而無法有效率地運作。</span><span class="sxs-lookup"><span data-stu-id="535e8-241">You might find that a query that gathers all the information you need in a single `Select` statement containing multiple `Join` clauses becomes too complex to work efficiently.</span></span> <span data-ttu-id="535e8-242">在此情況下，您可以從積極式載入切換到明確的載入，以簡化查詢。</span><span class="sxs-lookup"><span data-stu-id="535e8-242">In that case you can switch from eager loading to explicit loading to simplify the query.</span></span>

<span data-ttu-id="535e8-243">例如，請嘗試在*SchoolRepository.cs*中變更 `GetDepartmentsByName` 方法中的程式碼。</span><span class="sxs-lookup"><span data-stu-id="535e8-243">For example, try changing the code in the `GetDepartmentsByName` method in *SchoolRepository.cs*.</span></span> <span data-ttu-id="535e8-244">目前在該方法中，您有一個物件查詢，其中具有 `Person` 和 `Courses` 導覽屬性的 `Include` 方法。</span><span class="sxs-lookup"><span data-stu-id="535e8-244">Currently in that method you have an object query that has `Include` methods for the `Person` and `Courses` navigation properties.</span></span> <span data-ttu-id="535e8-245">以執行明確載入的程式碼取代 `return` 語句，如下列範例所示：</span><span class="sxs-lookup"><span data-stu-id="535e8-245">Replace the `return` statement with code that performs explicit loading, as shown in the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="535e8-246">執行偵錯工具中的 [*部門 .aspx* ] 頁面，然後再次檢查 [ **IntelliTrace** ] 視窗，如同之前一樣。</span><span class="sxs-lookup"><span data-stu-id="535e8-246">Run the *Departments.aspx* page in the debugger and check the **IntelliTrace** window again as you did before.</span></span> <span data-ttu-id="535e8-247">現在，在之前有單一查詢，您會看到一長串的順序。</span><span class="sxs-lookup"><span data-stu-id="535e8-247">Now, where there was a single query before, you see a long sequence of them.</span></span>

<span data-ttu-id="535e8-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="535e8-249">按一下第一個**ADO.NET**行，以查看您稍早查看的複雜查詢發生了什麼狀況。</span><span class="sxs-lookup"><span data-stu-id="535e8-249">Click the first **ADO.NET** line to see what has happened to the complex query you viewed earlier.</span></span>

<span data-ttu-id="535e8-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

<span data-ttu-id="535e8-251">來自部門的查詢已變成簡單的 `Select` 查詢，沒有 `Join` 子句，但後面接著的個別查詢，會針對原始查詢所傳回的每個部門，使用一組兩個查詢來抓取相關課程和系統管理員。</span><span class="sxs-lookup"><span data-stu-id="535e8-251">The query from Departments has become a simple `Select` query with no `Join` clause, but it's followed by separate queries that retrieve related courses and an administrator, using a set of two queries for each department returned by the original query.</span></span>

> [!NOTE]
> <span data-ttu-id="535e8-252">如果您讓消極式載入啟用，則在這裡看到的模式重複多次，可能是因為消極式載入所導致。</span><span class="sxs-lookup"><span data-stu-id="535e8-252">If you leave lazy loading enabled, the pattern you see here, with the same query repeated many times, might result from lazy loading.</span></span> <span data-ttu-id="535e8-253">您通常會想要避免的模式，是主資料表中每個資料列的延遲載入相關資料。</span><span class="sxs-lookup"><span data-stu-id="535e8-253">A pattern that you typically want to avoid is lazy-loading related data for every row of the primary table.</span></span> <span data-ttu-id="535e8-254">除非您已確認單一聯結查詢太複雜而無法有效率，否則在這種情況下，您通常可以藉由變更主要查詢來使用積極式載入，來改善效能。</span><span class="sxs-lookup"><span data-stu-id="535e8-254">Unless you've verified that a single join query is too complex to be efficient, you'd typically be able to improve performance in such cases by changing the primary query to use eager loading.</span></span>

## <a name="pre-generating-views"></a><span data-ttu-id="535e8-255">預先產生的視圖</span><span class="sxs-lookup"><span data-stu-id="535e8-255">Pre-Generating Views</span></span>

<span data-ttu-id="535e8-256">第一次在新的應用程式域中建立 `ObjectContext` 物件時，Entity Framework 會產生一組用來存取資料庫的類別。</span><span class="sxs-lookup"><span data-stu-id="535e8-256">When an `ObjectContext` object is first created in a new application domain, the Entity Framework generates a set of classes that it uses to access the database.</span></span> <span data-ttu-id="535e8-257">這些類別稱為*views*，如果您有非常大的資料模型，則產生這些視圖可能會在新的應用程式域初始化之後，延遲網站對第一個要求的回應。</span><span class="sxs-lookup"><span data-stu-id="535e8-257">These classes are called *views*, and if you have a very large data model, generating these views can delay the web site's response to the first request for a page after a new application domain is initialized.</span></span> <span data-ttu-id="535e8-258">您可以在編譯時期（而不是在執行時間）建立視圖，藉此減少第一個要求延遲。</span><span class="sxs-lookup"><span data-stu-id="535e8-258">You can reduce this first-request delay by creating the views at compile time rather than at run time.</span></span>

> [!NOTE]
> <span data-ttu-id="535e8-259">如果您的應用程式沒有非常大型的資料模型，或如果它有大型資料模型，但您不在意只有在回收 IIS 後才會影響到第一頁要求的效能問題，您可以略過本節。</span><span class="sxs-lookup"><span data-stu-id="535e8-259">If your application doesn't have an extremely large data model, or if it does have a large data model but you aren't concerned about a performance problem that affects only the very first page request after IIS is recycled, you can skip this section.</span></span> <span data-ttu-id="535e8-260">當您具現化 `ObjectContext` 物件時，不會發生視圖建立，因為這些視圖會在應用程式域中快取。</span><span class="sxs-lookup"><span data-stu-id="535e8-260">View creation doesn't happen every time you instantiate an `ObjectContext` object, because the views are cached in the application domain.</span></span> <span data-ttu-id="535e8-261">因此，除非您經常在 IIS 中回收應用程式，否則只有預先產生的視圖可以受益于極少的頁面要求。</span><span class="sxs-lookup"><span data-stu-id="535e8-261">Therefore, unless you're frequently recycling your application in IIS, very few page requests would benefit from pre-generated views.</span></span>

<span data-ttu-id="535e8-262">您可以使用*edmgen.exe*命令列工具，或使用「*文字模板轉換*工具組」（T4）範本來預先產生視圖。</span><span class="sxs-lookup"><span data-stu-id="535e8-262">You can pre-generate views using the *EdmGen.exe* command-line tool or by using a *Text Template Transformation Toolkit* (T4) template.</span></span> <span data-ttu-id="535e8-263">在本教學課程中，您將使用 T4 範本。</span><span class="sxs-lookup"><span data-stu-id="535e8-263">In this tutorial you'll use a T4 template.</span></span>

<span data-ttu-id="535e8-264">在*DAL*資料夾中，使用**文字模板**範本來新增檔案（它位於 [**已安裝的範本**] 清單中的 [**一般**] 節點底下），並將它命名為*SchoolModel.Views.tt*。</span><span class="sxs-lookup"><span data-stu-id="535e8-264">In the *DAL* folder, add a file using the **Text Template** template (it's under the **General** node in the **Installed Templates** list), and name it *SchoolModel.Views.tt*.</span></span> <span data-ttu-id="535e8-265">將檔案中的現有程式碼取代為下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="535e8-265">Replace the existing code in the file with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

<span data-ttu-id="535e8-266">此程式碼會產生 *.edmx*檔案的視圖，此檔案位於與範本相同的資料夾中，而且名稱與範本檔案相同。</span><span class="sxs-lookup"><span data-stu-id="535e8-266">This code generates views for an *.edmx* file that's located in the same folder as the template and that has the same name as the template file.</span></span> <span data-ttu-id="535e8-267">例如，如果您的範本檔案命名為*SchoolModel.Views.tt*，它會尋找名為*SchoolModel*的資料模型檔案。</span><span class="sxs-lookup"><span data-stu-id="535e8-267">For example, if your template file is named *SchoolModel.Views.tt*, it will look for a data model file named *SchoolModel.edmx*.</span></span>

<span data-ttu-id="535e8-268">儲存檔案，然後以滑鼠右鍵按一下**方案總管**中的檔案，然後選取 [**執行自訂工具**]。</span><span class="sxs-lookup"><span data-stu-id="535e8-268">Save the file, then right-click the file in **Solution Explorer** and select **Run Custom Tool**.</span></span>

<span data-ttu-id="535e8-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="535e8-270">Visual Studio 會產生程式碼檔案，該檔案會根據範本建立名為*SchoolModel.Views.cs*的視圖。</span><span class="sxs-lookup"><span data-stu-id="535e8-270">Visual Studio generates a code file that creates the views, which is named *SchoolModel.Views.cs* based on the template.</span></span> <span data-ttu-id="535e8-271">（您可能已注意到，即使在您選取 [**執行自訂工具**] 之後，您也會在儲存範本檔案之後，才會產生程式碼檔案）。</span><span class="sxs-lookup"><span data-stu-id="535e8-271">(You might have noticed that the code file is generated even before you select **Run Custom Tool**, as soon as you save the template file.)</span></span>

<span data-ttu-id="535e8-272">[![Image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="535e8-272">[![Image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="535e8-273">您現在可以執行應用程式，並確認它的運作方式與之前相同。</span><span class="sxs-lookup"><span data-stu-id="535e8-273">You can now run the application and verify that it works as it did before.</span></span>

<span data-ttu-id="535e8-274">如需預先產生之視圖的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="535e8-274">For more information about pre-generated views, see the following resources:</span></span>

- <span data-ttu-id="535e8-275">如何：在 MSDN 網站上[預先產生視圖以改善查詢效能](https://msdn.microsoft.com/library/bb896240.aspx)。</span><span class="sxs-lookup"><span data-stu-id="535e8-275">[How to: Pre-Generate Views to Improve Query Performance](https://msdn.microsoft.com/library/bb896240.aspx) on the MSDN web site.</span></span> <span data-ttu-id="535e8-276">說明如何使用 `EdmGen.exe` 命令列工具來預先產生 views。</span><span class="sxs-lookup"><span data-stu-id="535e8-276">Explains how to use the `EdmGen.exe` command-line tool to pre-generate views.</span></span>
- <span data-ttu-id="535e8-277">在 Windows Server AppFabric 客戶諮詢小組的 blog 中，以[Entity Framework 4 的先行編譯/預先產生的觀點來隔離效能](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx)。</span><span class="sxs-lookup"><span data-stu-id="535e8-277">[Isolating Performance with Precompiled/Pre-generated Views in the Entity Framework 4](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx) on the Windows Server AppFabric Customer Advisory Team blog.</span></span>

<span data-ttu-id="535e8-278">這會完成介紹，以在使用 Entity Framework 的 ASP.NET web 應用程式中改善效能。</span><span class="sxs-lookup"><span data-stu-id="535e8-278">This completes the introduction to improving performance in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="535e8-279">如需詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="535e8-279">For more information, see the following resources:</span></span>

- <span data-ttu-id="535e8-280">MSDN 網站上的[效能考慮（Entity Framework）](https://msdn.microsoft.com/library/cc853327.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="535e8-280">[Performance Considerations (Entity Framework)](https://msdn.microsoft.com/library/cc853327.aspx) on the MSDN web site.</span></span>
- <span data-ttu-id="535e8-281">[Entity Framework 小組 blog 上的效能相關文章](https://blogs.msdn.com/b/adonet/archive/tags/performance/)。</span><span class="sxs-lookup"><span data-stu-id="535e8-281">[Performance-related posts on the Entity Framework Team blog](https://blogs.msdn.com/b/adonet/archive/tags/performance/).</span></span>
- <span data-ttu-id="535e8-282">[EF Merge 選項和已編譯的查詢](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx)。</span><span class="sxs-lookup"><span data-stu-id="535e8-282">[EF Merge Options and Compiled Queries](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx).</span></span> <span data-ttu-id="535e8-283">說明已編譯查詢和合併選項（如 `NoTracking`）之非預期行為的 Blog 文章。</span><span class="sxs-lookup"><span data-stu-id="535e8-283">Blog post that explains unexpected behaviors of compiled queries and merge options such as `NoTracking`.</span></span> <span data-ttu-id="535e8-284">如果您打算在應用程式中使用已編譯的查詢或操作合併選項設定，請先閱讀這項功能。</span><span class="sxs-lookup"><span data-stu-id="535e8-284">If you plan to use compiled queries or manipulate merge option settings in your application, read this first.</span></span>
- <span data-ttu-id="535e8-285">[資料和模型化客戶諮詢小組 blog 中的 Entity Framework 相關文章](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/)。</span><span class="sxs-lookup"><span data-stu-id="535e8-285">[Entity Framework-related posts in the Data and Modeling Customer Advisory Team blog](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/).</span></span> <span data-ttu-id="535e8-286">包含已編譯查詢的貼文，並使用 Visual Studio 2010 Profiler 探索效能問題。</span><span class="sxs-lookup"><span data-stu-id="535e8-286">Includes posts on compiled queries and using the Visual Studio 2010 Profiler to discover performance issues.</span></span>
- <span data-ttu-id="535e8-287">[Entity Framework 論壇往來文章，並提供改善高度複雜查詢效能的建議](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6)。</span><span class="sxs-lookup"><span data-stu-id="535e8-287">[Entity Framework forum thread with advice on improving performance of highly complex queries](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6).</span></span>
- <span data-ttu-id="535e8-288">[ASP.NET 狀態管理建議](https://msdn.microsoft.com/library/z1hkazw7.aspx)。</span><span class="sxs-lookup"><span data-stu-id="535e8-288">[ASP.NET State Management Recommendations](https://msdn.microsoft.com/library/z1hkazw7.aspx).</span></span>
- <span data-ttu-id="535e8-289">[使用 Entity Framework 和 ObjectDataSource：自訂分頁](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx)。</span><span class="sxs-lookup"><span data-stu-id="535e8-289">[Using the Entity Framework and the ObjectDataSource: Custom Paging](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx).</span></span> <span data-ttu-id="535e8-290">以在這些教學課程中建立的 ContosoUniversity 應用程式為基礎的 Blog 文章，說明如何在 *[node.js* ] 頁面中執行分頁。</span><span class="sxs-lookup"><span data-stu-id="535e8-290">Blog post that builds on the ContosoUniversity application created in these tutorials to explain how to implement paging in the *Departments.aspx* page.</span></span>

<span data-ttu-id="535e8-291">下一個教學課程會針對第4版中的新 Entity Framework，回顧一些重要的增強功能。</span><span class="sxs-lookup"><span data-stu-id="535e8-291">The next tutorial reviews some of the important enhancements to the Entity Framework that are new in version 4.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="535e8-292">[上一頁](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
> [下一頁](what-s-new-in-the-entity-framework-4.md)</span><span class="sxs-lookup"><span data-stu-id="535e8-292">[Previous](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
[Next](what-s-new-in-the-entity-framework-4.md)</span></span>
