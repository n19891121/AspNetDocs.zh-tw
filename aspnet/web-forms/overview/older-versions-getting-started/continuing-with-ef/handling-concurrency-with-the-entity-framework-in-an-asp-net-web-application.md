---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: 使用 ASP.NET 4 Web 應用程式中的 Entity Framework 4.0 來處理平行存取 |Microsoft Docs
author: tdykstra
description: 本教學課程系列是以 Entity Framework 4.0 教學課程系列的消費者入門所建立的 Contoso 大學 web 應用程式為基礎。 I...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 3df5f7d9c8fb22e1ea34fe16560bdb9a1309bb56
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78632584"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="4effb-104">使用 ASP.NET 4 Web 應用程式中的 Entity Framework 4.0 來處理平行存取</span><span class="sxs-lookup"><span data-stu-id="4effb-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="4effb-105">由[Tom 作者: dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="4effb-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="4effb-106">本教學課程系列是[以 Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started)教學課程系列的消費者入門所建立的 Contoso 大學 web 應用程式為基礎。</span><span class="sxs-lookup"><span data-stu-id="4effb-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="4effb-107">如果您未完成先前的教學課程，做為本教學課程的起點，您可以下載您所建立[的應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)。</span><span class="sxs-lookup"><span data-stu-id="4effb-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="4effb-108">您也可以下載完整的教學課程系列所建立[的應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)。</span><span class="sxs-lookup"><span data-stu-id="4effb-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="4effb-109">如果您有關于教學課程的問題，可以將其張貼到[ASP.NET Entity Framework 論壇](https://forums.asp.net/1227.aspx)。</span><span class="sxs-lookup"><span data-stu-id="4effb-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="4effb-110">在上一個教學課程中，您已瞭解如何使用 `ObjectDataSource` 控制項和 Entity Framework 來排序和篩選資料。</span><span class="sxs-lookup"><span data-stu-id="4effb-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="4effb-111">本教學課程會顯示在使用 Entity Framework 的 ASP.NET web 應用程式中處理並行的選項。</span><span class="sxs-lookup"><span data-stu-id="4effb-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="4effb-112">您將會建立專門用來更新講師辦公室指派的新網頁。</span><span class="sxs-lookup"><span data-stu-id="4effb-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="4effb-113">您將會在該頁面和您稍早建立的 [部門] 頁面中處理並行問題。</span><span class="sxs-lookup"><span data-stu-id="4effb-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="4effb-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="4effb-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="4effb-116">並行衝突</span><span class="sxs-lookup"><span data-stu-id="4effb-116">Concurrency Conflicts</span></span>

<span data-ttu-id="4effb-117">當使用者編輯記錄，而另一個使用者在第一次使用者的變更寫入資料庫之前，編輯相同的記錄時，就會發生並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4effb-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="4effb-118">如果您未設定 Entity Framework 來偵測這類衝突，則更新資料庫的人員會最後覆寫其他使用者的變更。</span><span class="sxs-lookup"><span data-stu-id="4effb-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="4effb-119">在許多應用程式中，這是可接受的風險，而且您不需要設定應用程式來處理可能的並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4effb-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="4effb-120">（如果有少數幾個使用者或幾個更新，或如果某些變更遭到覆寫，如果不是真的很重要，則並行處理的程式設計成本可能會超過此權益）。如果您不需要擔心並行衝突，可以略過此教學課程;系列中的其餘兩個教學課程不會取決於您在此版本中建立的任何專案。</span><span class="sxs-lookup"><span data-stu-id="4effb-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="4effb-121">封閉式平行存取（鎖定）</span><span class="sxs-lookup"><span data-stu-id="4effb-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="4effb-122">若您的應用程式確實需要防止在並行案例下發生的意外資料遺失，其中一個方法便是使用資料庫鎖定。</span><span class="sxs-lookup"><span data-stu-id="4effb-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="4effb-123">這稱為「封閉式*並行*存取」。</span><span class="sxs-lookup"><span data-stu-id="4effb-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="4effb-124">例如，在您從資料庫讀取一個資料列之前，您會要求唯讀鎖定或更新存取鎖定。</span><span class="sxs-lookup"><span data-stu-id="4effb-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="4effb-125">若您鎖定了一個資料列以進行更新存取，其他使用者便無法為了唯讀或更新存取而鎖定該資料列，因為他們會取得一個正在進行變更之資料的複本。</span><span class="sxs-lookup"><span data-stu-id="4effb-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="4effb-126">若您鎖定資料列以進行唯讀存取，其他使用者也可以為了唯讀存取將其鎖定，但無法進行更新。</span><span class="sxs-lookup"><span data-stu-id="4effb-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="4effb-127">管理鎖定有一些缺點。</span><span class="sxs-lookup"><span data-stu-id="4effb-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="4effb-128">其程式可能相當複雜。</span><span class="sxs-lookup"><span data-stu-id="4effb-128">It can be complex to program.</span></span> <span data-ttu-id="4effb-129">它需要大量的資料庫管理資源，而且可能會造成效能問題，因為應用程式的使用者數目增加（亦即，它無法妥善調整）。</span><span class="sxs-lookup"><span data-stu-id="4effb-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="4effb-130">基於這些理由，不是所有的資料庫管理系統都支援封閉式並行存取。</span><span class="sxs-lookup"><span data-stu-id="4effb-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="4effb-131">Entity Framework 不會提供內建的支援，本教學課程不會示範如何執行此功能。</span><span class="sxs-lookup"><span data-stu-id="4effb-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="4effb-132">開放式並行存取</span><span class="sxs-lookup"><span data-stu-id="4effb-132">Optimistic Concurrency</span></span>

<span data-ttu-id="4effb-133">封閉式平行存取的替代方法是*開放式並行*存取。</span><span class="sxs-lookup"><span data-stu-id="4effb-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="4effb-134">開放式並行存取表示允許並行衝突發生，然後在衝突發生時適當的做出反應。</span><span class="sxs-lookup"><span data-stu-id="4effb-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="4effb-135">例如，John 執行 [*部門 .aspx* ] 頁面，按一下 [歷程記錄] 部門的 [**編輯**] 連結，並將**預算**量從 $1000000.00 縮減為 $125000.00。</span><span class="sxs-lookup"><span data-stu-id="4effb-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="4effb-136">（John 負責管理競爭部門，而且想要釋出自己的部門的金錢）。</span><span class="sxs-lookup"><span data-stu-id="4effb-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="4effb-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="4effb-138">John 按一下**更新**之前，Jane 執行相同的頁面，按一下歷程記錄部門的 [**編輯**] 連結，然後將 [**開始日期**] 欄位從1/10/2011 變更為1/1/1999。</span><span class="sxs-lookup"><span data-stu-id="4effb-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="4effb-139">（Jane 管理歷程記錄部門，想要讓它更多資歷）。</span><span class="sxs-lookup"><span data-stu-id="4effb-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="4effb-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="4effb-141">John 按一下 [**更新**]，然後按一下 [**更新**]。</span><span class="sxs-lookup"><span data-stu-id="4effb-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="4effb-142">Jane 的瀏覽器現在會將**預算**金額列為 $1000000.00，但這不正確，因為 John 已將金額變更為 $125000.00。</span><span class="sxs-lookup"><span data-stu-id="4effb-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="4effb-143">您可以在此案例中採取的一些動作包括下列各項：</span><span class="sxs-lookup"><span data-stu-id="4effb-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="4effb-144">您可以追蹤使用者修改的屬性，然後僅在資料庫中更新相對應的資料行。</span><span class="sxs-lookup"><span data-stu-id="4effb-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="4effb-145">在範例案例中，將不會發生資料遺失，因為兩名使用者更新的屬性不同。</span><span class="sxs-lookup"><span data-stu-id="4effb-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="4effb-146">下次有人流覽歷程記錄部門時，將會看到1/1/1999 和 $125000.00。</span><span class="sxs-lookup"><span data-stu-id="4effb-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="4effb-147">這是 Entity Framework 中的預設行為，它可以大幅減少可能導致資料遺失的衝突數目。</span><span class="sxs-lookup"><span data-stu-id="4effb-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="4effb-148">不過，如果對實體的相同屬性進行競爭變更，此行為並不會避免資料遺失。</span><span class="sxs-lookup"><span data-stu-id="4effb-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="4effb-149">此外，這種行為不一定是可行的;當您將預存程式對應至實體類型時，會在資料庫中對實體進行任何變更時，更新所有實體的屬性。</span><span class="sxs-lookup"><span data-stu-id="4effb-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="4effb-150">您可以讓 Jane 的變更覆寫 John 的變更。</span><span class="sxs-lookup"><span data-stu-id="4effb-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="4effb-151">Jane 按一下 [**更新**] 之後，**預算**量會回到 $1000000.00。</span><span class="sxs-lookup"><span data-stu-id="4effb-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="4effb-152">這稱之為「用戶端獲勝 (Client Wins)」或「最後寫入為準 (Last in Wins)」案例。</span><span class="sxs-lookup"><span data-stu-id="4effb-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="4effb-153">（用戶端的值會優先于資料存放區中的內容）。</span><span class="sxs-lookup"><span data-stu-id="4effb-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="4effb-154">您可以防止 Jane 的變更在資料庫中更新。</span><span class="sxs-lookup"><span data-stu-id="4effb-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="4effb-155">一般來說，您會顯示錯誤訊息、顯示資料的目前狀態，並允許她重新輸入變更（如果她仍然想要的話）。</span><span class="sxs-lookup"><span data-stu-id="4effb-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="4effb-156">您可以藉由儲存輸入來進一步將程式自動化，讓她有機會重新套用它，而不必重新輸入。</span><span class="sxs-lookup"><span data-stu-id="4effb-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="4effb-157">這稱之為「存放區獲勝 (Store Wins)」案例。</span><span class="sxs-lookup"><span data-stu-id="4effb-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="4effb-158">(資料存放區的值會優先於用戶端所提交的值。)</span><span class="sxs-lookup"><span data-stu-id="4effb-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="4effb-159">偵測並行衝突</span><span class="sxs-lookup"><span data-stu-id="4effb-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="4effb-160">在 Entity Framework 中，您可以藉由處理 Entity Framework 所擲回的 `OptimisticConcurrencyException` 例外狀況來解決衝突。</span><span class="sxs-lookup"><span data-stu-id="4effb-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="4effb-161">若要得知何時應擲回這些例外狀況，Entity Framework 必須能夠偵測衝突。</span><span class="sxs-lookup"><span data-stu-id="4effb-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="4effb-162">因此，您必須適當的設定資料庫及資料模型。</span><span class="sxs-lookup"><span data-stu-id="4effb-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="4effb-163">一部分啟用衝突偵測的選項包括下列選項：</span><span class="sxs-lookup"><span data-stu-id="4effb-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="4effb-164">在資料庫中，包含可用來判斷資料列何時變更的資料表資料行。</span><span class="sxs-lookup"><span data-stu-id="4effb-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="4effb-165">接著，您可以設定 Entity Framework 在 SQL `Update` 的 `Where` 子句或 `Delete` 命令中包含該資料行。</span><span class="sxs-lookup"><span data-stu-id="4effb-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="4effb-166">這就是 `OfficeAssignment` 資料表中 `Timestamp` 資料行的用途。</span><span class="sxs-lookup"><span data-stu-id="4effb-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="4effb-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="4effb-168">`Timestamp` 資料行的資料類型也稱為 `Timestamp`。</span><span class="sxs-lookup"><span data-stu-id="4effb-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="4effb-169">不過，資料行實際上不會包含日期或時間值。</span><span class="sxs-lookup"><span data-stu-id="4effb-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="4effb-170">相反地，此值是每次更新資料列時都會遞增的連續數位。</span><span class="sxs-lookup"><span data-stu-id="4effb-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="4effb-171">在 `Update` 或 `Delete` 命令中，`Where` 子句會包含原始 `Timestamp` 值。</span><span class="sxs-lookup"><span data-stu-id="4effb-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="4effb-172">如果正在更新的資料列已由另一位使用者變更，`Timestamp` 中的值會與原始值不同，因此 `Where` 子句不會傳回任何要更新的資料列。</span><span class="sxs-lookup"><span data-stu-id="4effb-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="4effb-173">當 Entity Framework 發現目前的 `Update` 或 `Delete` 命令未更新任何資料列（也就是說，當受影響的資料列數目為零時），它會將它解釋為並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4effb-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="4effb-174">設定 Entity Framework 在 `Update` 和 `Delete` 命令的 `Where` 子句中，包含資料表中每個資料行的原始值。</span><span class="sxs-lookup"><span data-stu-id="4effb-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="4effb-175">如同第一個選項，如果資料列中的任何專案在第一次讀取之後已變更，則 `Where` 子句不會傳回要更新的資料列，而 Entity Framework 會將它解釋為並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4effb-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="4effb-176">這個方法與使用 `Timestamp` 欄位一樣有效率，但可能沒有效率。</span><span class="sxs-lookup"><span data-stu-id="4effb-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="4effb-177">對於具有許多資料行的資料庫資料表，可能會產生非常大的 `Where` 子句，而且在 web 應用程式中，它可能會要求您維護大量的狀態。</span><span class="sxs-lookup"><span data-stu-id="4effb-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="4effb-178">維護大量的狀態可能會影響應用程式效能，因為它可能需要伺服器資源（例如會話狀態），或必須包含在網頁本身中（例如，檢視狀態）。</span><span class="sxs-lookup"><span data-stu-id="4effb-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="4effb-179">在本教學課程中，您將針對沒有追蹤屬性（`Department` 實體）的實體，以及具有追蹤屬性（`OfficeAssignment` 實體）之實體的開放式平行存取衝突，加入錯誤處理。</span><span class="sxs-lookup"><span data-stu-id="4effb-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="4effb-180">在沒有追蹤屬性的情況下處理開放式平行存取</span><span class="sxs-lookup"><span data-stu-id="4effb-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="4effb-181">若要針對沒有追蹤（`Timestamp`）屬性的 `Department` 實體執行開放式平行存取，您將完成下列工作：</span><span class="sxs-lookup"><span data-stu-id="4effb-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="4effb-182">變更資料模型，以啟用 `Department` 實體的並行追蹤。</span><span class="sxs-lookup"><span data-stu-id="4effb-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="4effb-183">在 `SchoolRepository` 類別中，處理 `SaveChanges` 方法中的平行存取例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4effb-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="4effb-184">在 [*部門 .aspx* ] 頁面中，向使用者顯示一則訊息，指出嘗試的變更失敗，以處理並行例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4effb-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="4effb-185">使用者接著可以查看目前的值，然後重試變更（如果仍然需要）。</span><span class="sxs-lookup"><span data-stu-id="4effb-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="4effb-186">在資料模型中啟用並行追蹤</span><span class="sxs-lookup"><span data-stu-id="4effb-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="4effb-187">在 Visual Studio 中，開啟您在本系列的上一個教學課程中使用的 Contoso 大學 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="4effb-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="4effb-188">開啟*SchoolModel*，然後在 [資料模型設計工具] 中，以滑鼠右鍵按一下 [`Department`] 實體中的 [`Name`] 屬性，然後按一下 [**屬性**]。</span><span class="sxs-lookup"><span data-stu-id="4effb-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="4effb-189">在 [**屬性**] 視窗中，將 [`ConcurrencyMode`] 屬性變更為 [`Fixed`]。</span><span class="sxs-lookup"><span data-stu-id="4effb-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="4effb-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="4effb-191">對其他非主要索引鍵純量屬性（`Budget`、`StartDate`和 `Administrator`執行相同的動作）。（您無法針對導覽屬性執行此動作）。這指定每當 Entity Framework 產生 `Update` 或 `Delete` SQL 命令以更新資料庫中的 `Department` 實體時，`Where` 子句中就必須包含這些資料行（含原始值）。</span><span class="sxs-lookup"><span data-stu-id="4effb-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="4effb-192">當 `Update` 或 `Delete` 命令執行時，如果找不到任何資料列，Entity Framework 將會擲回開放式平行存取例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4effb-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="4effb-193">儲存並關閉資料模型。</span><span class="sxs-lookup"><span data-stu-id="4effb-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="4effb-194">處理 DAL 中的平行存取例外狀況</span><span class="sxs-lookup"><span data-stu-id="4effb-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="4effb-195">開啟*SchoolRepository.cs* ，並為 `System.Data` 命名空間新增下列 `using` 語句：</span><span class="sxs-lookup"><span data-stu-id="4effb-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="4effb-196">新增下列新的 `SaveChanges` 方法，以處理開放式平行存取例外狀況：</span><span class="sxs-lookup"><span data-stu-id="4effb-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="4effb-197">如果呼叫這個方法時，發生並行錯誤，則記憶體中實體的屬性值會取代為目前在資料庫中的值。</span><span class="sxs-lookup"><span data-stu-id="4effb-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="4effb-198">平行存取例外狀況會重新擲回，讓網頁可以處理它。</span><span class="sxs-lookup"><span data-stu-id="4effb-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="4effb-199">在 `DeleteDepartment` 和 `UpdateDepartment` 方法中，以 `SaveChanges()` 的呼叫取代現有的 `context.SaveChanges()` 呼叫，以叫用新方法。</span><span class="sxs-lookup"><span data-stu-id="4effb-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="4effb-200">處理展示層中的平行存取例外狀況</span><span class="sxs-lookup"><span data-stu-id="4effb-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="4effb-201">開啟 [*部門 .aspx* ]，並將 `OnDeleted="DepartmentsObjectDataSource_Deleted"` 屬性加入至 [`DepartmentsObjectDataSource`] 控制項。</span><span class="sxs-lookup"><span data-stu-id="4effb-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="4effb-202">控制項的開頭標記現在會如下列範例所示。</span><span class="sxs-lookup"><span data-stu-id="4effb-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="4effb-203">在 `DepartmentsGridView` 控制項中，指定 `DataKeyNames` 屬性中的所有資料表資料行，如下列範例所示。</span><span class="sxs-lookup"><span data-stu-id="4effb-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="4effb-204">請注意，這將會建立非常大的檢視狀態欄位，這是為什麼使用追蹤欄位通常是追蹤並行衝突的慣用方式的原因之一。</span><span class="sxs-lookup"><span data-stu-id="4effb-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="4effb-205">開啟*Departments.aspx.cs* ，並為 `System.Data` 命名空間新增下列 `using` 語句：</span><span class="sxs-lookup"><span data-stu-id="4effb-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="4effb-206">加入下列新方法，您將從資料來源控制項的 `Updated` 呼叫，並 `Deleted` 事件處理常式來處理並行例外狀況：</span><span class="sxs-lookup"><span data-stu-id="4effb-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="4effb-207">此程式碼會檢查例外狀況類型，如果是並行例外狀況，程式碼會動態建立 `CustomValidator` 控制項，然後在 `ValidationSummary` 控制項中顯示訊息。</span><span class="sxs-lookup"><span data-stu-id="4effb-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="4effb-208">從您稍早新增的 `Updated` 事件處理常式呼叫新的方法。</span><span class="sxs-lookup"><span data-stu-id="4effb-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="4effb-209">此外，建立新的 `Deleted` 事件處理常式，以呼叫相同的方法（但不會執行任何其他動作）：</span><span class="sxs-lookup"><span data-stu-id="4effb-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="4effb-210">在 [部門] 頁面中測試開放式平行存取</span><span class="sxs-lookup"><span data-stu-id="4effb-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="4effb-211">執行 [*部門 .aspx* ] 頁面。</span><span class="sxs-lookup"><span data-stu-id="4effb-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="4effb-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="4effb-213">按一下資料列中的 [**編輯**]，然後變更 [**預算**] 資料行中的值。</span><span class="sxs-lookup"><span data-stu-id="4effb-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="4effb-214">（請記住，您只能編輯您在本教學課程中建立的記錄，因為現有的 `School` 資料庫記錄包含一些不正確資料。</span><span class="sxs-lookup"><span data-stu-id="4effb-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="4effb-215">經濟效益部門的記錄是一種可進行實驗的安全。）</span><span class="sxs-lookup"><span data-stu-id="4effb-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="4effb-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="4effb-217">開啟新的瀏覽器視窗，然後再次執行頁面（將 URL 從第一個瀏覽器視窗的 [位址] 方塊複製到第二個瀏覽器視窗）。</span><span class="sxs-lookup"><span data-stu-id="4effb-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="4effb-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="4effb-219">在您稍早編輯的相同資料列中按一下 [**編輯**]，並將**預算**值變更為不同的值。</span><span class="sxs-lookup"><span data-stu-id="4effb-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="4effb-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="4effb-221">在第二個瀏覽器視窗中，按一下 [**更新**]。</span><span class="sxs-lookup"><span data-stu-id="4effb-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="4effb-222">**預算**金額已成功變更為此新值。</span><span class="sxs-lookup"><span data-stu-id="4effb-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="4effb-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="4effb-224">在第一個瀏覽器視窗中，按一下 [**更新**]。</span><span class="sxs-lookup"><span data-stu-id="4effb-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="4effb-225">更新失敗。</span><span class="sxs-lookup"><span data-stu-id="4effb-225">The update fails.</span></span> <span data-ttu-id="4effb-226">**預算**金額會使用您在第二個瀏覽器視窗中設定的值重新顯示，而您會看到一則錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4effb-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="4effb-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="4effb-228">使用追蹤屬性處理開放式平行存取</span><span class="sxs-lookup"><span data-stu-id="4effb-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="4effb-229">若要處理具有追蹤屬性之實體的開放式平行存取，您將完成下列工作：</span><span class="sxs-lookup"><span data-stu-id="4effb-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="4effb-230">將預存程式加入至資料模型，以管理 `OfficeAssignment` 的實體。</span><span class="sxs-lookup"><span data-stu-id="4effb-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="4effb-231">（追蹤屬性和預存程式不一定要一起使用; 它們只會在這裡分組以進行說明）。</span><span class="sxs-lookup"><span data-stu-id="4effb-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="4effb-232">將 CRUD 方法新增至 DAL，並針對 `OfficeAssignment` 實體加入 BLL，包括用來處理 DAL 中開放式平行存取例外狀況的程式碼。</span><span class="sxs-lookup"><span data-stu-id="4effb-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="4effb-233">建立辦公室指派的網頁。</span><span class="sxs-lookup"><span data-stu-id="4effb-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="4effb-234">在新網頁中測試開放式平行存取。</span><span class="sxs-lookup"><span data-stu-id="4effb-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="4effb-235">將 OfficeAssignment 預存程式加入至資料模型</span><span class="sxs-lookup"><span data-stu-id="4effb-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="4effb-236">在模型設計師中開啟*SchoolModel* ，以滑鼠右鍵按一下設計介面，然後按一下 [**從資料庫更新模型**]。</span><span class="sxs-lookup"><span data-stu-id="4effb-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="4effb-237">在 [**選擇您的資料庫物件**] 對話方塊的 [**加入**] 索引標籤中，展開 [**預存程式**] 並選取三個 `OfficeAssignment` 預存程式（請參閱下列螢幕擷取畫面），然後按一下 **[完成]** 。</span><span class="sxs-lookup"><span data-stu-id="4effb-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="4effb-238">（當您使用腳本下載或建立預存程式時，它們已經在資料庫中）。</span><span class="sxs-lookup"><span data-stu-id="4effb-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="4effb-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="4effb-240">以滑鼠右鍵按一下 [`OfficeAssignment`] 實體，然後選取 [**預存程式對應**]。</span><span class="sxs-lookup"><span data-stu-id="4effb-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="4effb-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="4effb-242">將**Insert**、 **Update**和**Delete**函數設定為使用其對應的預存程式。</span><span class="sxs-lookup"><span data-stu-id="4effb-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="4effb-243">針對 `Update` 函數的 `OrigTimestamp` 參數，將**屬性**設定為 `Timestamp`，然後選取 [**使用原始值**] 選項。</span><span class="sxs-lookup"><span data-stu-id="4effb-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="4effb-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="4effb-245">當 Entity Framework 呼叫 `UpdateOfficeAssignment` 預存程式時，它會在 `OrigTimestamp` 參數中傳遞 `Timestamp` 資料行的原始值。</span><span class="sxs-lookup"><span data-stu-id="4effb-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="4effb-246">預存程式會在其 `Where` 子句中使用此參數：</span><span class="sxs-lookup"><span data-stu-id="4effb-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="4effb-247">預存程式也會在更新之後選取 `Timestamp` 資料行的新值，讓 Entity Framework 可以讓記憶體中的 `OfficeAssignment` 實體與對應的資料庫資料列同步。</span><span class="sxs-lookup"><span data-stu-id="4effb-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="4effb-248">（請注意，刪除 office 指派的預存程式沒有 `OrigTimestamp` 參數。</span><span class="sxs-lookup"><span data-stu-id="4effb-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="4effb-249">因此，Entity Framework 無法在刪除實體之前，先確認其是否已變更。）</span><span class="sxs-lookup"><span data-stu-id="4effb-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="4effb-250">儲存並關閉資料模型。</span><span class="sxs-lookup"><span data-stu-id="4effb-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="4effb-251">將 OfficeAssignment 方法新增至 DAL</span><span class="sxs-lookup"><span data-stu-id="4effb-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="4effb-252">開啟*ISchoolRepository.cs* ，並為 `OfficeAssignment` 實體集新增下列 CRUD 方法：</span><span class="sxs-lookup"><span data-stu-id="4effb-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="4effb-253">將下列新方法新增至*SchoolRepository.cs*。</span><span class="sxs-lookup"><span data-stu-id="4effb-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="4effb-254">在 `UpdateOfficeAssignment` 方法中，您可以呼叫本機 `SaveChanges` 方法，而不是 `context.SaveChanges`。</span><span class="sxs-lookup"><span data-stu-id="4effb-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="4effb-255">在測試專案中，開啟*MockSchoolRepository.cs* ，並將下列 `OfficeAssignment` 集合和 CRUD 方法加入其中。</span><span class="sxs-lookup"><span data-stu-id="4effb-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="4effb-256">（模擬存放庫必須執行存放庫介面，否則解決方案將不會編譯）。</span><span class="sxs-lookup"><span data-stu-id="4effb-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="4effb-257">將 OfficeAssignment 方法新增至 BLL</span><span class="sxs-lookup"><span data-stu-id="4effb-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="4effb-258">在主要專案中，開啟*SchoolBL.cs* ，然後將 `OfficeAssignment` 實體集的下列 CRUD 方法加入其中：</span><span class="sxs-lookup"><span data-stu-id="4effb-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="4effb-259">建立 OfficeAssignments 網頁</span><span class="sxs-lookup"><span data-stu-id="4effb-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="4effb-260">建立使用 [*網站*主要] 頁面的新網頁，並將其命名為*OfficeAssignments .aspx*。</span><span class="sxs-lookup"><span data-stu-id="4effb-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="4effb-261">將下列標記新增至名為 `Content2`的 `Content` 控制項：</span><span class="sxs-lookup"><span data-stu-id="4effb-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="4effb-262">請注意，在 `DataKeyNames` 屬性中，標記會指定 `Timestamp` 屬性以及記錄索引鍵（`InstructorID`）。</span><span class="sxs-lookup"><span data-stu-id="4effb-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="4effb-263">在 `DataKeyNames` 屬性中指定屬性，會使控制項將其儲存在控制項狀態中（類似于檢視狀態），以便在回傳處理期間使用原始值。</span><span class="sxs-lookup"><span data-stu-id="4effb-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="4effb-264">如果您未儲存 `Timestamp` 值，則 Entity Framework 不會將它用於 SQL `Update` 命令的 `Where` 子句。</span><span class="sxs-lookup"><span data-stu-id="4effb-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="4effb-265">因此，將不會有任何更新。</span><span class="sxs-lookup"><span data-stu-id="4effb-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="4effb-266">因此，每次更新 `OfficeAssignment` 實體時，Entity Framework 都會擲回開放式平行存取例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4effb-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="4effb-267">開啟*OfficeAssignments.aspx.cs* ，並為數據存取層新增下列 `using` 語句：</span><span class="sxs-lookup"><span data-stu-id="4effb-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="4effb-268">新增下列 `Page_Init` 方法，這會啟用動態資料功能。</span><span class="sxs-lookup"><span data-stu-id="4effb-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="4effb-269">此外，也請為 `ObjectDataSource` 控制項的 `Updated` 事件新增下列處理常式，以檢查並行錯誤：</span><span class="sxs-lookup"><span data-stu-id="4effb-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="4effb-270">在 [OfficeAssignments] 頁面中測試開放式平行存取</span><span class="sxs-lookup"><span data-stu-id="4effb-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="4effb-271">執行 [ *OfficeAssignments* ] 頁面。</span><span class="sxs-lookup"><span data-stu-id="4effb-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="4effb-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="4effb-273">按一下資料列中的 [**編輯**]，然後變更 [**位置**] 資料行中的值。</span><span class="sxs-lookup"><span data-stu-id="4effb-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="4effb-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="4effb-275">開啟新的瀏覽器視窗，然後再次執行頁面（將第一個瀏覽器視窗中的 URL 複製到第二個瀏覽器視窗）。</span><span class="sxs-lookup"><span data-stu-id="4effb-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="4effb-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="4effb-277">在您稍早編輯的相同資料列中按一下 [**編輯**]，然後將 [**位置**] 值變更為不同的。</span><span class="sxs-lookup"><span data-stu-id="4effb-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="4effb-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="4effb-279">在第二個瀏覽器視窗中，按一下 [**更新**]。</span><span class="sxs-lookup"><span data-stu-id="4effb-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="4effb-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="4effb-281">切換至第一個瀏覽器視窗，然後按一下 [**更新**]。</span><span class="sxs-lookup"><span data-stu-id="4effb-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="4effb-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="4effb-283">您會看到一則錯誤訊息，且 [**位置**] 值已更新，以顯示您在第二個瀏覽器視窗中變更的值。</span><span class="sxs-lookup"><span data-stu-id="4effb-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="4effb-284">使用 EntityDataSource 控制項處理平行存取</span><span class="sxs-lookup"><span data-stu-id="4effb-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="4effb-285">`EntityDataSource` 控制項包含內建邏輯，可辨識資料模型中的並行設定，並據此處理更新和刪除作業。</span><span class="sxs-lookup"><span data-stu-id="4effb-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="4effb-286">不過，如同所有例外狀況，您必須自行處理 `OptimisticConcurrencyException` 例外狀況，才能提供容易使用的錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4effb-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="4effb-287">接下來，您將設定 [*課程 .aspx* ] 頁面（使用 `EntityDataSource` 控制項）來允許更新和刪除作業，並在發生並行衝突時顯示錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4effb-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="4effb-288">`Course` 實體沒有並行追蹤資料行，因此您將使用與 `Department` 實體相同的方法：追蹤所有非索引鍵屬性的值。</span><span class="sxs-lookup"><span data-stu-id="4effb-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="4effb-289">開啟*SchoolModel .edmx*檔案。</span><span class="sxs-lookup"><span data-stu-id="4effb-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="4effb-290">針對 `Course` 實體（`Title`、`Credits`和 `DepartmentID`）的非索引鍵屬性，請將**並行模式**屬性設定為 [`Fixed`]。</span><span class="sxs-lookup"><span data-stu-id="4effb-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="4effb-291">然後儲存並關閉資料模型。</span><span class="sxs-lookup"><span data-stu-id="4effb-291">Then save and close the data model.</span></span>

<span data-ttu-id="4effb-292">開啟 [*課程 .aspx* ] 頁面，並進行下列變更：</span><span class="sxs-lookup"><span data-stu-id="4effb-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="4effb-293">在 `CoursesEntityDataSource` 控制項中，加入 `EnableUpdate="true"` 和 `EnableDelete="true"` 屬性。</span><span class="sxs-lookup"><span data-stu-id="4effb-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="4effb-294">該控制項的開頭標記現在與下列範例類似：</span><span class="sxs-lookup"><span data-stu-id="4effb-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="4effb-295">在 `CoursesGridView` 控制項中，將 `DataKeyNames` 屬性值變更為 [`"CourseID,Title,Credits,DepartmentID"`]。</span><span class="sxs-lookup"><span data-stu-id="4effb-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="4effb-296">然後將 `CommandField` 專案新增至顯示 [**編輯**] 和 [**刪除**] 按鈕（`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`）的 `Columns` 元素。</span><span class="sxs-lookup"><span data-stu-id="4effb-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="4effb-297">`GridView` 控制項現在與下列範例類似：</span><span class="sxs-lookup"><span data-stu-id="4effb-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="4effb-298">執行頁面，並在 [部門] 頁面中建立衝突狀況。</span><span class="sxs-lookup"><span data-stu-id="4effb-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="4effb-299">在兩個瀏覽器視窗中執行頁面，在每個視窗的同一行中按一下 [**編輯**]，然後在每一個視窗中進行不同的變更。</span><span class="sxs-lookup"><span data-stu-id="4effb-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="4effb-300">按一下一個視窗中的 [**更新**]，然後按一下另一個視窗中的 [**更新**]。</span><span class="sxs-lookup"><span data-stu-id="4effb-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="4effb-301">當您第二次按下 [**更新**] 時，您會看到錯誤頁面，這是因為未處理的平行存取例外狀況所造成。</span><span class="sxs-lookup"><span data-stu-id="4effb-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="4effb-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="4effb-303">您處理這個錯誤的方式與處理 `ObjectDataSource` 控制項的方式非常類似。</span><span class="sxs-lookup"><span data-stu-id="4effb-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="4effb-304">開啟 [*課程 .aspx* ] 頁面，然後在 [`CoursesEntityDataSource`] 控制項中，指定 `Deleted` 和 `Updated` 事件的處理常式。</span><span class="sxs-lookup"><span data-stu-id="4effb-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="4effb-305">控制項的開頭標記現在與下列範例類似：</span><span class="sxs-lookup"><span data-stu-id="4effb-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="4effb-306">在 `CoursesGridView` 控制項之前，新增下列 `ValidationSummary` 控制項：</span><span class="sxs-lookup"><span data-stu-id="4effb-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="4effb-307">在*Courses.aspx.cs*中，加入 `System.Data` 命名空間的 `using` 語句、加入一個檢查並行例外狀況的方法，以及為 `EntityDataSource` 控制項的 `Updated` 和 `Deleted` 處理常式新增處理常式。</span><span class="sxs-lookup"><span data-stu-id="4effb-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="4effb-308">程式碼看起來會像下面這樣：</span><span class="sxs-lookup"><span data-stu-id="4effb-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="4effb-309">這段程式碼與您在 `ObjectDataSource` 控制項中所做的唯一差異在於，在此情況下，並行例外狀況是在事件引數物件的 `Exception` 屬性中，而不是在該例外狀況的 `InnerException` 屬性中。</span><span class="sxs-lookup"><span data-stu-id="4effb-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="4effb-310">再次執行頁面，並再次建立並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4effb-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="4effb-311">這次您會看到錯誤訊息：</span><span class="sxs-lookup"><span data-stu-id="4effb-311">This time you see an error message:</span></span>

<span data-ttu-id="4effb-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="4effb-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="4effb-313">如此即完成了處理並行衝突的簡介。</span><span class="sxs-lookup"><span data-stu-id="4effb-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="4effb-314">下一個教學課程將提供如何在使用 Entity Framework 的 web 應用程式中改善效能的指引。</span><span class="sxs-lookup"><span data-stu-id="4effb-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="4effb-315">[上一頁](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [下一頁](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="4effb-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
