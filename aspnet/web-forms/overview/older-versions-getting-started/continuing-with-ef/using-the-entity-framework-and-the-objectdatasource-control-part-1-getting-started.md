---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
title: 使用 Entity Framework 4.0 和 ObjectDataSource 控制項，第1部分：消費者入門 |Microsoft Docs
author: tdykstra
description: 本教學課程系列是以 Entity Framework 教學課程系列的消費者入門所建立的 Contoso 大學 web 應用程式為基礎。 如果 yo 。
ms.author: riande
ms.date: 01/26/2011
ms.assetid: 244278c1-fec8-4255-8a8a-13bde491c4f5
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
msc.type: authoredcontent
ms.openlocfilehash: 2f14707eb058d438495dd2bc4c17b976c471fc97
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78547289"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-1-getting-started"></a><span data-ttu-id="7877b-104">使用 Entity Framework 4.0 和 ObjectDataSource 控制項，第1部分：消費者入門</span><span class="sxs-lookup"><span data-stu-id="7877b-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 1: Getting Started</span></span>

<span data-ttu-id="7877b-105">由[Tom 作者: dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="7877b-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="7877b-106">本教學課程系列是[以 Entity Framework 4.0](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)教學課程系列的消費者入門所建立的 Contoso 大學 web 應用程式為基礎。</span><span class="sxs-lookup"><span data-stu-id="7877b-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series.</span></span> <span data-ttu-id="7877b-107">如果您未完成先前的教學課程，做為本教學課程的起點，您可以下載您所建立[的應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)。</span><span class="sxs-lookup"><span data-stu-id="7877b-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="7877b-108">您也可以下載完整的教學課程系列所建立[的應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)。</span><span class="sxs-lookup"><span data-stu-id="7877b-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span>
> 
> <span data-ttu-id="7877b-109">Contoso 大學範例 web 應用程式示範如何使用 Entity Framework 4.0 和 Visual Studio 2010 來建立 ASP.NET Web Forms 應用程式。</span><span class="sxs-lookup"><span data-stu-id="7877b-109">The Contoso University sample web application demonstrates how to create ASP.NET Web Forms applications using the Entity Framework 4.0 and Visual Studio 2010.</span></span> <span data-ttu-id="7877b-110">範例應用程式是虛構 Contoso 大學的網站。</span><span class="sxs-lookup"><span data-stu-id="7877b-110">The sample application is a website for a fictional Contoso University.</span></span> <span data-ttu-id="7877b-111">其中包括的功能有學生入學許可、課程建立、教師指派。</span><span class="sxs-lookup"><span data-stu-id="7877b-111">It includes functionality such as student admission, course creation, and instructor assignments.</span></span>
> 
> <span data-ttu-id="7877b-112">本教學課程會顯示C#中的範例。</span><span class="sxs-lookup"><span data-stu-id="7877b-112">The tutorial shows examples in C#.</span></span> <span data-ttu-id="7877b-113">[可下載的範例](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)包含C#和 Visual Basic 中的程式碼。</span><span class="sxs-lookup"><span data-stu-id="7877b-113">The [downloadable sample](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) contains code in both C# and Visual Basic.</span></span>
> 
> ## <a name="database-first"></a><span data-ttu-id="7877b-114">Database First</span><span class="sxs-lookup"><span data-stu-id="7877b-114">Database First</span></span>
> 
> <span data-ttu-id="7877b-115">有三種方式可以使用 Entity Framework 中的資料： *Database First*、 *Model First*和*Code First*。</span><span class="sxs-lookup"><span data-stu-id="7877b-115">There are three ways you can work with data in the Entity Framework: *Database First*, *Model First*, and *Code First*.</span></span> <span data-ttu-id="7877b-116">本教學課程適用于 Database First。</span><span class="sxs-lookup"><span data-stu-id="7877b-116">This tutorial is for Database First.</span></span> <span data-ttu-id="7877b-117">如需這些工作流程之間的差異，以及如何為您的案例選擇最適合的指引的詳細資訊，請參閱[Entity Framework 開發工作流程](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf)。</span><span class="sxs-lookup"><span data-stu-id="7877b-117">For information about the differences between these workflows and guidance on how to choose the best one for your scenario, see [Entity Framework Development Workflows](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf).</span></span>
> 
> ## <a name="web-forms"></a><span data-ttu-id="7877b-118">Web Form</span><span class="sxs-lookup"><span data-stu-id="7877b-118">Web Forms</span></span>
> 
> <span data-ttu-id="7877b-119">就像消費者入門系列一樣，本教學課程系列會使用 ASP.NET Web form 模型，並假設您知道如何在 Visual Studio 中使用 ASP.NET Web Forms。</span><span class="sxs-lookup"><span data-stu-id="7877b-119">Like the Getting Started series, this tutorial series uses the ASP.NET Web Forms model and assumes you know how to work with ASP.NET Web Forms in Visual Studio.</span></span> <span data-ttu-id="7877b-120">如果您沒有，請參閱[使用 ASP.NET 4.5 Web Forms 消費者入門](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="7877b-120">If you don't, see [Getting Started with ASP.NET 4.5 Web Forms](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md).</span></span> <span data-ttu-id="7877b-121">如果您想要使用 ASP.NET MVC 架構，請參閱[使用 ASP.NET MVC 的 Entity Framework 消費者入門](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)。</span><span class="sxs-lookup"><span data-stu-id="7877b-121">If you prefer to work with the ASP.NET MVC framework, see [Getting Started with the Entity Framework using ASP.NET MVC](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span>
> 
> ## <a name="software-versions"></a><span data-ttu-id="7877b-122">軟體版本</span><span class="sxs-lookup"><span data-stu-id="7877b-122">Software versions</span></span>
> 
> | <span data-ttu-id="7877b-123">**教學課程中所示**</span><span class="sxs-lookup"><span data-stu-id="7877b-123">**Shown in the tutorial**</span></span> | <span data-ttu-id="7877b-124">**也適用于**</span><span class="sxs-lookup"><span data-stu-id="7877b-124">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="7877b-125">Windows 7</span><span class="sxs-lookup"><span data-stu-id="7877b-125">Windows 7</span></span> | <span data-ttu-id="7877b-126">Windows 8</span><span class="sxs-lookup"><span data-stu-id="7877b-126">Windows 8</span></span> |
> | <span data-ttu-id="7877b-127">Visual Studio 2010</span><span class="sxs-lookup"><span data-stu-id="7877b-127">Visual Studio 2010</span></span> | <span data-ttu-id="7877b-128">適用于 Web 的 Visual Studio 2010 Express。</span><span class="sxs-lookup"><span data-stu-id="7877b-128">Visual Studio 2010 Express for Web.</span></span> <span data-ttu-id="7877b-129">本教學課程尚未使用較新版本的 Visual Studio 進行測試。</span><span class="sxs-lookup"><span data-stu-id="7877b-129">The tutorial has not been tested with later versions of Visual Studio.</span></span> <span data-ttu-id="7877b-130">功能表選項、對話方塊和範本有許多差異。</span><span class="sxs-lookup"><span data-stu-id="7877b-130">There are many differences in menu selections, dialog boxes, and templates.</span></span> |
> | <span data-ttu-id="7877b-131">.NET 4</span><span class="sxs-lookup"><span data-stu-id="7877b-131">.NET 4</span></span> | <span data-ttu-id="7877b-132">.NET 4.5 與 .NET 4 回溯相容，但本教學課程尚未使用 .NET 4.5 進行測試。</span><span class="sxs-lookup"><span data-stu-id="7877b-132">.NET 4.5 is backward compatible with .NET 4, but the tutorial has not been tested with .NET 4.5.</span></span> |
> | <span data-ttu-id="7877b-133">Entity Framework 4</span><span class="sxs-lookup"><span data-stu-id="7877b-133">Entity Framework 4</span></span> | <span data-ttu-id="7877b-134">本教學課程尚未使用較新版本的 Entity Framework 進行測試。</span><span class="sxs-lookup"><span data-stu-id="7877b-134">The tutorial has not been tested with later versions of Entity Framework.</span></span> <span data-ttu-id="7877b-135">從 Entity Framework 5 開始，EF 預設會使用 EF 4.1 引進的 `DbContext API`。</span><span class="sxs-lookup"><span data-stu-id="7877b-135">Starting with Entity Framework 5, EF uses by default the `DbContext API` that was introduced with EF 4.1.</span></span> <span data-ttu-id="7877b-136">EntityDataSource 控制項的設計目的是要使用 `ObjectContext` API。</span><span class="sxs-lookup"><span data-stu-id="7877b-136">The EntityDataSource control was designed to use the `ObjectContext` API.</span></span> <span data-ttu-id="7877b-137">如需如何搭配 `DbContext` API 使用 EntityDataSource 控制項的相關資訊，請參閱[這篇 blog 文章](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx)。</span><span class="sxs-lookup"><span data-stu-id="7877b-137">For information about how to use the EntityDataSource control with the `DbContext` API, see [this blog post](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx).</span></span> |
> 
> ## <a name="questions"></a><span data-ttu-id="7877b-138">問題</span><span class="sxs-lookup"><span data-stu-id="7877b-138">Questions</span></span>
> 
> <span data-ttu-id="7877b-139">如果您有與本教學課程不直接相關的問題，您可以將其張貼到[ASP.NET Entity Framework 論壇](https://forums.asp.net/1227.aspx)、 [Entity Framework 和 LINQ to Entities 論壇](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/)，或[StackOverflow.com](http://stackoverflow.com/)。</span><span class="sxs-lookup"><span data-stu-id="7877b-139">If you have questions that are not directly related to the tutorial, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx), the [Entity Framework and LINQ to Entities forum](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/), or [StackOverflow.com](http://stackoverflow.com/).</span></span>

<span data-ttu-id="7877b-140">`EntityDataSource` 控制項可讓您快速建立應用程式，但通常會要求您在 *.aspx*頁面中保留大量的商務邏輯和資料存取邏輯。</span><span class="sxs-lookup"><span data-stu-id="7877b-140">The `EntityDataSource` control enables you to create an application very quickly, but it typically requires you to keep a significant amount of business logic and data-access logic in your *.aspx* pages.</span></span> <span data-ttu-id="7877b-141">如果您預期應用程式的複雜性日益增加，而且需要持續維護，您可以事先投入更多開發時間來建立多*層式*或*分層*的應用程式結構，以更容易維護。</span><span class="sxs-lookup"><span data-stu-id="7877b-141">If you expect your application to grow in complexity and to require ongoing maintenance, you can invest more development time up front in order to create an *n-tier* or *layered* application structure that's more maintainable.</span></span> <span data-ttu-id="7877b-142">若要執行此架構，您可以將展示層與商務邏輯層（BLL）和資料存取層（DAL）分開。</span><span class="sxs-lookup"><span data-stu-id="7877b-142">To implement this architecture, you separate the presentation layer from the business logic layer (BLL) and the data access layer (DAL).</span></span> <span data-ttu-id="7877b-143">執行此結構的其中一種方式是使用 `ObjectDataSource` 控制項，而不是 `EntityDataSource` 控制項。</span><span class="sxs-lookup"><span data-stu-id="7877b-143">One way to implement this structure is to use the `ObjectDataSource` control instead of the `EntityDataSource` control.</span></span> <span data-ttu-id="7877b-144">當您使用 `ObjectDataSource` 控制項時，您會執行自己的資料存取程式碼，然後在 *.aspx*頁面中使用與其他資料來源控制項有許多相同功能的控制項來叫用它。</span><span class="sxs-lookup"><span data-stu-id="7877b-144">When you use the `ObjectDataSource` control, you implement your own data-access code and then invoke it in *.aspx* pages using a control that has many of the same features as other data-source controls.</span></span> <span data-ttu-id="7877b-145">這可讓您結合多層式方法的優點與使用 Web form 控制項進行資料存取的優點。</span><span class="sxs-lookup"><span data-stu-id="7877b-145">This lets you combine the advantages of an n-tier approach with the benefits of using a Web Forms control for data access.</span></span>

<span data-ttu-id="7877b-146">`ObjectDataSource` 控制項也能讓您以其他方式提供更大的彈性。</span><span class="sxs-lookup"><span data-stu-id="7877b-146">The `ObjectDataSource` control gives you more flexibility in other ways as well.</span></span> <span data-ttu-id="7877b-147">由於您會撰寫自己的資料存取程式碼，因此比起讀取、插入、更新或刪除特定實體類型更為容易，這就是 `EntityDataSource` 控制項設計來執行的工作。</span><span class="sxs-lookup"><span data-stu-id="7877b-147">Because you write your own data-access code, it's easier to do more than just read, insert, update, or delete a specific entity type, which are the tasks that the `EntityDataSource` control is designed to perform.</span></span> <span data-ttu-id="7877b-148">例如，您可以在每次更新實體時執行記錄、在刪除實體時封存資料，或在插入具有外鍵值的資料列時，視需要自動檢查和更新相關的資料。</span><span class="sxs-lookup"><span data-stu-id="7877b-148">For example, you can perform logging every time an entity is updated, archive data whenever an entity is deleted, or automatically check and update related data as needed when inserting a row with a foreign key value.</span></span>

## <a name="business-logic-and-repository-classes"></a><span data-ttu-id="7877b-149">商務邏輯和存放庫類別</span><span class="sxs-lookup"><span data-stu-id="7877b-149">Business Logic and Repository Classes</span></span>

<span data-ttu-id="7877b-150">`ObjectDataSource` 控制項的運作方式是叫用您所建立的類別。</span><span class="sxs-lookup"><span data-stu-id="7877b-150">An `ObjectDataSource` control works by invoking a class that you create.</span></span> <span data-ttu-id="7877b-151">類別包含可抓取和更新資料的方法，而且您可以將這些方法的名稱提供給標記中的 `ObjectDataSource` 控制項。</span><span class="sxs-lookup"><span data-stu-id="7877b-151">The class includes methods that retrieve and update data, and you provide the names of those methods to the `ObjectDataSource` control in markup.</span></span> <span data-ttu-id="7877b-152">在呈現或回傳處理期間，`ObjectDataSource` 會呼叫您指定的方法。</span><span class="sxs-lookup"><span data-stu-id="7877b-152">During rendering or postback processing, the `ObjectDataSource` calls the methods that you've specified.</span></span>

<span data-ttu-id="7877b-153">除了基本 CRUD 作業以外，您建立來搭配 `ObjectDataSource` 控制項使用的類別，可能需要在 `ObjectDataSource` 讀取或更新資料時執行商務邏輯。</span><span class="sxs-lookup"><span data-stu-id="7877b-153">Besides basic CRUD operations, the class that you create to use with the `ObjectDataSource` control might need to execute business logic when the `ObjectDataSource` reads or updates data.</span></span> <span data-ttu-id="7877b-154">例如，當您更新部門時，您可能需要驗證沒有其他部門具有相同的系統管理員，因為一個人無法成為多個部門的系統管理員。</span><span class="sxs-lookup"><span data-stu-id="7877b-154">For example, when you update a department, you might need to validate that no other departments have the same administrator because one person cannot be administrator of more than one department.</span></span>

<span data-ttu-id="7877b-155">在某些 `ObjectDataSource` 檔（例如[ObjectDataSource 類別總覽](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx)）中，控制項會呼叫稱為*商務物件*的類別，其中包含商務邏輯和資料存取邏輯。</span><span class="sxs-lookup"><span data-stu-id="7877b-155">In some `ObjectDataSource` documentation, such as the [ObjectDataSource Class overview](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx), the control calls a class referred to as a *business object* that includes both business logic and data-access logic.</span></span> <span data-ttu-id="7877b-156">在本教學課程中，您將為商務邏輯和資料存取邏輯建立不同的類別。</span><span class="sxs-lookup"><span data-stu-id="7877b-156">In this tutorial you will create separate classes for business logic and for data-access logic.</span></span> <span data-ttu-id="7877b-157">封裝資料存取邏輯的類別稱為「*儲存*機制」。</span><span class="sxs-lookup"><span data-stu-id="7877b-157">The class that encapsulates data-access logic is called a *repository*.</span></span> <span data-ttu-id="7877b-158">商務邏輯類別同時包含商業邏輯方法和資料存取方法，但是資料存取方法會呼叫儲存機制來執行資料存取工作。</span><span class="sxs-lookup"><span data-stu-id="7877b-158">The business logic class includes both business-logic methods and data-access methods, but the data-access methods call the repository to perform data-access tasks.</span></span>

<span data-ttu-id="7877b-159">您也會在 BLL 和 DAL 之間建立抽象層，以促進 BLL 的自動化單元測試。</span><span class="sxs-lookup"><span data-stu-id="7877b-159">You will also create an abstraction layer between your BLL and DAL that facilitates automated unit testing of the BLL.</span></span> <span data-ttu-id="7877b-160">當您具現化商業邏輯類別中的存放庫時，會建立介面並使用介面來執行此抽象層。</span><span class="sxs-lookup"><span data-stu-id="7877b-160">This abstraction layer is implemented by creating an interface and using the interface when you instantiate the repository in the business-logic class.</span></span> <span data-ttu-id="7877b-161">如此一來，您就可以為商業邏輯類別提供任何可執行存放庫介面之物件的參考。</span><span class="sxs-lookup"><span data-stu-id="7877b-161">This makes it possible for you to provide the business-logic class with a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="7877b-162">若是正常作業，您會提供可與 Entity Framework 搭配運作的存放庫物件。</span><span class="sxs-lookup"><span data-stu-id="7877b-162">For normal operation, you provide a repository object that works with the Entity Framework.</span></span> <span data-ttu-id="7877b-163">若要進行測試，您可以提供一個儲存機制物件，以處理以輕鬆操作的方式儲存的資料，例如定義為集合的類別變數。</span><span class="sxs-lookup"><span data-stu-id="7877b-163">For testing, you provide a repository object that works with data stored in a way that you can easily manipulate, such as class variables defined as collections.</span></span>

<span data-ttu-id="7877b-164">下圖顯示商業邏輯類別之間的差異，其中包括不含存放庫的資料存取邏輯，以及使用儲存機制的。</span><span class="sxs-lookup"><span data-stu-id="7877b-164">The following illustration shows the difference between a business-logic class that includes data-access logic without a repository and one that uses a repository.</span></span>

<span data-ttu-id="7877b-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span></span>

<span data-ttu-id="7877b-166">首先，您會建立網頁，其中 `ObjectDataSource` 控制項直接系結至存放庫，因為它只會執行基本的資料存取工作。</span><span class="sxs-lookup"><span data-stu-id="7877b-166">You will begin by creating web pages in which the `ObjectDataSource` control is bound directly to a repository because it only performs basic data-access tasks.</span></span> <span data-ttu-id="7877b-167">在下一個教學課程中，您將使用驗證邏輯建立商務邏輯類別，並將 `ObjectDataSource` 控制項系結至該類別，而不是將其系結至儲存機制類別。</span><span class="sxs-lookup"><span data-stu-id="7877b-167">In the next tutorial you will create a business logic class with validation logic and bind the `ObjectDataSource` control to that class instead of to the repository class.</span></span> <span data-ttu-id="7877b-168">您也會建立驗證邏輯的單元測試。</span><span class="sxs-lookup"><span data-stu-id="7877b-168">You will also create unit tests for the validation logic.</span></span> <span data-ttu-id="7877b-169">在此系列的第三個教學課程中，您將會在應用程式中加入排序和篩選功能。</span><span class="sxs-lookup"><span data-stu-id="7877b-169">In the third tutorial in this series you will add sorting and filtering functionality to the application.</span></span>

<span data-ttu-id="7877b-170">您在本教學課程中建立的頁面會使用您在[消費者入門教學課程系列](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)中所建立之資料模型的 `Departments` 實體集。</span><span class="sxs-lookup"><span data-stu-id="7877b-170">The pages you create in this tutorial work with the `Departments` entity set of the data model that you created in the [Getting Started tutorial series](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md).</span></span>

<span data-ttu-id="7877b-171">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-171">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span></span>

<span data-ttu-id="7877b-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span></span>

## <a name="updating-the-database-and-the-data-model"></a><span data-ttu-id="7877b-173">更新資料庫和資料模型</span><span class="sxs-lookup"><span data-stu-id="7877b-173">Updating the Database and the Data Model</span></span>

<span data-ttu-id="7877b-174">您將開始進行此教學課程，方法是對資料庫進行兩個變更，這兩者都需要對您在[消費者入門中使用 Entity Framework 和 Web](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) form 教學課程所建立的資料模型進行相對應的變更。</span><span class="sxs-lookup"><span data-stu-id="7877b-174">You will begin this tutorial by making two changes to the database, both of which require corresponding changes to the data model that you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorials.</span></span> <span data-ttu-id="7877b-175">在其中一個教學課程中，您會以手動方式在設計工具中進行變更，以便在資料庫變更之後同步處理資料模型與資料庫。</span><span class="sxs-lookup"><span data-stu-id="7877b-175">In one of those tutorials, you made changes in the designer manually to synchronize the data model with the database after a database change.</span></span> <span data-ttu-id="7877b-176">在本教學課程中，您將使用來自資料庫工具的設計師**更新模型**，自動更新資料模型。</span><span class="sxs-lookup"><span data-stu-id="7877b-176">In this tutorial, you will use the designer's **Update Model From Database** tool to update the data model automatically.</span></span>

### <a name="adding-a-relationship-to-the-database"></a><span data-ttu-id="7877b-177">將關聯性加入至資料庫</span><span class="sxs-lookup"><span data-stu-id="7877b-177">Adding a Relationship to the Database</span></span>

<span data-ttu-id="7877b-178">在 Visual Studio 中，開啟您在[使用 Entity Framework 和 Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md)教學課程系列的消費者入門中建立的 Contoso 大學 web 應用程式，然後開啟 `SchoolDiagram` 資料庫關係圖。</span><span class="sxs-lookup"><span data-stu-id="7877b-178">In Visual Studio, open the Contoso University web application you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series, and then open the `SchoolDiagram` database diagram.</span></span>

<span data-ttu-id="7877b-179">如果您查看資料庫關係圖中的 [`Department`] 資料表，您會看到它有 [`Administrator`] 資料行。</span><span class="sxs-lookup"><span data-stu-id="7877b-179">If you look at the `Department` table in the database diagram, you will see that it has an `Administrator` column.</span></span> <span data-ttu-id="7877b-180">此資料行是 `Person` 資料表的外鍵，但在資料庫中沒有定義任何外鍵關聯性。</span><span class="sxs-lookup"><span data-stu-id="7877b-180">This column is a foreign key to the `Person` table, but no foreign key relationship is defined in the database.</span></span> <span data-ttu-id="7877b-181">您需要建立關聯性並更新資料模型，讓 Entity Framework 可以自動處理此關聯性。</span><span class="sxs-lookup"><span data-stu-id="7877b-181">You need to create the relationship and update the data model so that the Entity Framework can automatically handle this relationship.</span></span>

<span data-ttu-id="7877b-182">在資料庫關係圖中，以滑鼠右鍵按一下 [`Department`] 資料表，然後選取 [**關聯**性]。</span><span class="sxs-lookup"><span data-stu-id="7877b-182">In the database diagram, right-click the `Department` table, and select **Relationships**.</span></span>

<span data-ttu-id="7877b-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span></span>

<span data-ttu-id="7877b-184">在 [**外鍵關聯**性] 方塊中，按一下 [**加入**]，然後按一下 [**資料表和資料行規格]** 的省略號。</span><span class="sxs-lookup"><span data-stu-id="7877b-184">In the **Foreign Key Relationships** box click **Add**, then click the ellipsis for **Tables and Columns Specification**.</span></span>

<span data-ttu-id="7877b-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span></span>

<span data-ttu-id="7877b-186">在 [**資料表和資料行**] 對話方塊中，將主鍵資料表和欄位設定為 `Person` 並 `PersonID`，然後將外鍵資料表和欄位設定為 [`Department`] 和 [`Administrator`]。</span><span class="sxs-lookup"><span data-stu-id="7877b-186">In the **Tables and Columns** dialog box, set the primary key table and field to `Person` and `PersonID`, and set the foreign key table and field to `Department` and `Administrator`.</span></span> <span data-ttu-id="7877b-187">（當您這麼做時，關聯性名稱會從 `FK_Department_Department` 變更為 `FK_Department_Person`）。</span><span class="sxs-lookup"><span data-stu-id="7877b-187">(When you do this, the relationship name will change from `FK_Department_Department` to `FK_Department_Person`.)</span></span>

<span data-ttu-id="7877b-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span></span>

<span data-ttu-id="7877b-189">在 [**資料表和資料行**] 方塊中按一下 **[確定]** ，在 [**外鍵關聯**性] 方塊中按一下 [**關閉**]，然後儲存變更。</span><span class="sxs-lookup"><span data-stu-id="7877b-189">Click **OK** in the **Tables and Columns** box, click **Close** in the **Foreign Key Relationships** box, and save the changes.</span></span> <span data-ttu-id="7877b-190">如果系統詢問您是否要儲存 `Person` 並 `Department` 資料表，請按一下 **[是]** 。</span><span class="sxs-lookup"><span data-stu-id="7877b-190">If you're asked if you want to save the `Person` and `Department` tables, click **Yes**.</span></span>

> [!NOTE]
> <span data-ttu-id="7877b-191">如果您已刪除 `Person` 對應到已在 [`Administrator`] 資料行中之資料的資料列，您將無法儲存這項變更。</span><span class="sxs-lookup"><span data-stu-id="7877b-191">If you've deleted `Person` rows that correspond to data that's already in the `Administrator` column, you will not be able to save this change.</span></span> <span data-ttu-id="7877b-192">在這種情況下，請使用**伺服器總管**中的資料表編輯器，確保每個 `Department` 資料列中的 `Administrator` 值都包含實際存在於 `Person` 資料表中的記錄識別碼。</span><span class="sxs-lookup"><span data-stu-id="7877b-192">In that case, use the table editor in **Server Explorer** to make sure that the `Administrator` value in every `Department` row contains the ID of a record that actually exists in the `Person` table.</span></span>
> 
> <span data-ttu-id="7877b-193">儲存變更之後，如果該人員是部門系統管理員，就無法從 `Person` 資料表中刪除資料列。</span><span class="sxs-lookup"><span data-stu-id="7877b-193">After you save the change, you will not be able to delete a row from the `Person` table if that person is a department administrator.</span></span> <span data-ttu-id="7877b-194">在生產應用程式中，當資料庫條件約束防止刪除時，您會提供特定的錯誤訊息，或者您會指定串聯刪除。</span><span class="sxs-lookup"><span data-stu-id="7877b-194">In a production application, you would provide a specific error message when a database constraint prevents a deletion, or you would specify a cascading delete.</span></span> <span data-ttu-id="7877b-195">如需如何指定串聯刪除的範例，請參閱[Entity Framework 和 ASP.NET –消費者入門第2部分](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md)。</span><span class="sxs-lookup"><span data-stu-id="7877b-195">For an example of how to specify a cascading delete, see [The Entity Framework and ASP.NET – Getting Started Part 2](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md).</span></span>

### <a name="adding-a-view-to-the-database"></a><span data-ttu-id="7877b-196">將視圖加入至資料庫</span><span class="sxs-lookup"><span data-stu-id="7877b-196">Adding a View to the Database</span></span>

<span data-ttu-id="7877b-197">在您要建立的新 [*部門 .aspx* ] 頁面中，您想要提供一個下拉式清單，其中的名稱為「最後，第一次」格式，讓使用者可以選取部門系統管理員。</span><span class="sxs-lookup"><span data-stu-id="7877b-197">In the new *Departments.aspx* page that you will be creating, you want to provide a drop-down list of instructors, with names in "last, first" format so that users can select department administrators.</span></span> <span data-ttu-id="7877b-198">為了讓它更容易執行，您會在資料庫中建立一個視圖。</span><span class="sxs-lookup"><span data-stu-id="7877b-198">To make it easier to do that, you will create a view in the database.</span></span> <span data-ttu-id="7877b-199">此視圖只會包含下拉式清單所需的資料：完整名稱（格式正確）和記錄索引鍵。</span><span class="sxs-lookup"><span data-stu-id="7877b-199">The view will consist of just the data needed by the drop-down list: the full name (properly formatted) and the record key.</span></span>

<span data-ttu-id="7877b-200">在**伺服器總管**中，展開 [ *School*]，以滑鼠右鍵按一下 [ **Views** ] 資料夾，然後選取 [**加入新的視圖**]。</span><span class="sxs-lookup"><span data-stu-id="7877b-200">In **Server Explorer**, expand *School.mdf*, right-click the **Views** folder, and select **Add New View**.</span></span>

<span data-ttu-id="7877b-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span></span>

<span data-ttu-id="7877b-202">出現 [**加入資料表**] 對話方塊時，按一下 [**關閉**]，並將下列 SQL 語句貼入 [sql] 窗格中：</span><span class="sxs-lookup"><span data-stu-id="7877b-202">Click **Close** when the **Add Table** dialog box appears, and paste the following SQL statement into the SQL pane:</span></span>

[!code-sql[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample1.sql)]

<span data-ttu-id="7877b-203">將此視圖儲存為 `vInstructorName`。</span><span class="sxs-lookup"><span data-stu-id="7877b-203">Save the view as `vInstructorName`.</span></span>

### <a name="updating-the-data-model"></a><span data-ttu-id="7877b-204">更新資料模型</span><span class="sxs-lookup"><span data-stu-id="7877b-204">Updating the Data Model</span></span>

<span data-ttu-id="7877b-205">在*DAL*資料夾中，開啟*SchoolModel*檔案，以滑鼠右鍵按一下設計介面，然後選取 [**從資料庫更新模型**]。</span><span class="sxs-lookup"><span data-stu-id="7877b-205">In the *DAL* folder, open the *SchoolModel.edmx* file, right-click the design surface, and select **Update Model from Database**.</span></span>

<span data-ttu-id="7877b-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span></span>

<span data-ttu-id="7877b-207">在 [**選擇您的資料庫物件**] 對話方塊中，選取 [**新增**] 索引標籤，然後選取您剛才建立的視圖。</span><span class="sxs-lookup"><span data-stu-id="7877b-207">In the **Choose Your Database Objects** dialog box, select the **Add** tab and select the view you just created.</span></span>

<span data-ttu-id="7877b-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span></span>

<span data-ttu-id="7877b-209">按一下 [完成] **Walkthrough: Calling Code in an VSTO Add-in from VBA**。</span><span class="sxs-lookup"><span data-stu-id="7877b-209">Click **Finish**.</span></span>

<span data-ttu-id="7877b-210">在設計工具中，您會看到工具已建立 `vInstructorName` 實體，以及 `Department` 和 `Person` 實體之間的新關聯。</span><span class="sxs-lookup"><span data-stu-id="7877b-210">In the designer, you see that the tool created a `vInstructorName` entity and a new association between the `Department` and `Person` entities.</span></span>

<span data-ttu-id="7877b-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span></span>

> [!NOTE]
> <span data-ttu-id="7877b-212">在 [**輸出**] 和 [**錯誤清單**] 視窗中，您可能會看到一則警告訊息，通知您工具已自動建立新 `vInstructorName` 視圖的主要金鑰。</span><span class="sxs-lookup"><span data-stu-id="7877b-212">In the **Output** and **Error List** windows you might see a warning message informing you that the tool automatically created a primary key for the new `vInstructorName` view.</span></span> <span data-ttu-id="7877b-213">這是預期行為。</span><span class="sxs-lookup"><span data-stu-id="7877b-213">This is expected behavior.</span></span>

<span data-ttu-id="7877b-214">當您在程式碼中參考新的 `vInstructorName` 實體時，您不會想要在其前面加上小寫 "v" 的資料庫慣例。</span><span class="sxs-lookup"><span data-stu-id="7877b-214">When you refer to the new `vInstructorName` entity in code, you don't want to use the database convention of prefixing a lower-case "v" to it.</span></span> <span data-ttu-id="7877b-215">因此，您將重新命名模型中的實體和實體集。</span><span class="sxs-lookup"><span data-stu-id="7877b-215">Therefore, you will rename the entity and entity set in the model.</span></span>

<span data-ttu-id="7877b-216">開啟 [**模型瀏覽器**]。</span><span class="sxs-lookup"><span data-stu-id="7877b-216">Open the **Model Browser**.</span></span> <span data-ttu-id="7877b-217">您會看到 `vInstructorName` 列為實體類型和一個視圖。</span><span class="sxs-lookup"><span data-stu-id="7877b-217">You see `vInstructorName` listed as an entity type and a view.</span></span>

<span data-ttu-id="7877b-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span></span>

<span data-ttu-id="7877b-219">在 [ **SchoolModel** （不是**SchoolModel**）] 底下，以滑鼠右鍵按一下**VInstructorName** ，然後選取 [**屬性**]。</span><span class="sxs-lookup"><span data-stu-id="7877b-219">Under **SchoolModel** (not **SchoolModel.Store**), right-click **vInstructorName** and select **Properties**.</span></span> <span data-ttu-id="7877b-220">在 [**屬性**] 視窗中，將 [**名稱**] 屬性變更為 "InstructorName"，並將 [**實體集名稱**] 屬性變更為 "InstructorNames"。</span><span class="sxs-lookup"><span data-stu-id="7877b-220">In the **Properties** window, change the **Name** property to "InstructorName" and change the **Entity Set Name** property to "InstructorNames".</span></span>

<span data-ttu-id="7877b-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span></span>

<span data-ttu-id="7877b-222">儲存並關閉資料模型，然後重建專案。</span><span class="sxs-lookup"><span data-stu-id="7877b-222">Save and close the data model, and then rebuild the project.</span></span>

## <a name="using-a-repository-class-and-an-objectdatasource-control"></a><span data-ttu-id="7877b-223">使用儲存機制類別和 ObjectDataSource 控制項</span><span class="sxs-lookup"><span data-stu-id="7877b-223">Using a Repository Class and an ObjectDataSource Control</span></span>

<span data-ttu-id="7877b-224">在*DAL*資料夾中建立新的類別檔案，將其命名為*SchoolRepository.cs*，並以下列程式碼取代現有的程式碼：</span><span class="sxs-lookup"><span data-stu-id="7877b-224">Create a new class file in the *DAL* folder, name it *SchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample2.cs)]

<span data-ttu-id="7877b-225">這段程式碼會提供單一 `GetDepartments` 方法，以傳回 `Departments` 實體集中的所有實體。</span><span class="sxs-lookup"><span data-stu-id="7877b-225">This code provides a single `GetDepartments` method that returns all of the entities in the `Departments` entity set.</span></span> <span data-ttu-id="7877b-226">因為您知道將會存取每個傳回之資料列的 `Person` 導覽屬性，所以您可以使用 `Include` 方法指定該屬性的積極式載入。</span><span class="sxs-lookup"><span data-stu-id="7877b-226">Because you know that you will be accessing the `Person` navigation property for every row returned, you specify eager loading for that property by using the `Include` method.</span></span> <span data-ttu-id="7877b-227">類別也會執行 `IDisposable` 介面，以確保在處置物件時釋放資料庫連接。</span><span class="sxs-lookup"><span data-stu-id="7877b-227">The class also implements the `IDisposable` interface to ensure that the database connection is released when the object is disposed.</span></span>

> [!NOTE]
> <span data-ttu-id="7877b-228">常見的做法是為每個實體類型建立一個儲存機制類別。</span><span class="sxs-lookup"><span data-stu-id="7877b-228">A common practice is to create a repository class for each entity type.</span></span> <span data-ttu-id="7877b-229">在本教學課程中，會使用多個實體類型的一個儲存機制類別。</span><span class="sxs-lookup"><span data-stu-id="7877b-229">In this tutorial, one repository class for multiple entity types is used.</span></span> <span data-ttu-id="7877b-230">如需有關存放庫模式的詳細資訊，請參閱[Entity Framework 小組的 blog](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx)和[Julie Lerman 的 blog](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/)中的文章。</span><span class="sxs-lookup"><span data-stu-id="7877b-230">For more information about the repository pattern, see the posts in [the Entity Framework team's blog](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) and [Julie Lerman's blog](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/).</span></span>

<span data-ttu-id="7877b-231">`GetDepartments` 方法會傳回 `IEnumerable` 物件，而不是 `IQueryable` 物件，以確保即使在處置存放庫物件本身之後，傳回的集合仍可供使用。</span><span class="sxs-lookup"><span data-stu-id="7877b-231">The `GetDepartments` method returns an `IEnumerable` object rather than an `IQueryable` object in order to ensure that the returned collection is usable even after the repository object itself is disposed.</span></span> <span data-ttu-id="7877b-232">`IQueryable` 物件在存取時可能會導致資料庫存取，但是儲存機制物件可能會在資料系結控制項嘗試轉譯資料時處置。</span><span class="sxs-lookup"><span data-stu-id="7877b-232">An `IQueryable` object can cause database access whenever it's accessed, but the repository object might be disposed by the time a databound control attempts to render the data.</span></span> <span data-ttu-id="7877b-233">您可以傳回另一個集合類型，例如 `IList` 物件，而不是 `IEnumerable` 物件。</span><span class="sxs-lookup"><span data-stu-id="7877b-233">You could return another collection type, such as an `IList` object instead of an `IEnumerable` object.</span></span> <span data-ttu-id="7877b-234">不過，傳回 `IEnumerable` 物件可確保您可以執行一般唯讀清單處理工作，例如 `foreach` 迴圈和 LINQ 查詢，但是您無法加入或移除集合中的專案，這可能表示這類變更會保存到資料庫中。</span><span class="sxs-lookup"><span data-stu-id="7877b-234">However, returning an `IEnumerable` object ensures that you can perform typical read-only list processing tasks such as `foreach` loops and LINQ queries, but you cannot add to or remove items in the collection, which might imply that such changes would be persisted to the database.</span></span>

<span data-ttu-id="7877b-235">建立使用*網站*master 頁面的*部門 .aspx*頁面，並在名為 `Content2`的 `Content` 控制項中新增下列標記：</span><span class="sxs-lookup"><span data-stu-id="7877b-235">Create a *Departments.aspx* page that uses the *Site.Master* master page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample3.aspx)]

<span data-ttu-id="7877b-236">此標記會建立一個使用您剛才建立之儲存機制類別的 `ObjectDataSource` 控制項，以及一個 `GridView` 控制項來顯示資料。</span><span class="sxs-lookup"><span data-stu-id="7877b-236">This markup creates an `ObjectDataSource` control that uses the repository class you just created, and a `GridView` control to display the data.</span></span> <span data-ttu-id="7877b-237">`GridView` 控制項會指定**Edit**和**Delete**命令，但是您尚未加入程式碼來支援它們。</span><span class="sxs-lookup"><span data-stu-id="7877b-237">The `GridView` control specifies **Edit** and **Delete** commands, but you haven't added code to support them yet.</span></span>

<span data-ttu-id="7877b-238">有數個數據行使用 `DynamicField` 控制項，讓您可以利用自動格式化和驗證功能。</span><span class="sxs-lookup"><span data-stu-id="7877b-238">Several columns use `DynamicField` controls so that you can take advantage of automatic data formatting and validation functionality.</span></span> <span data-ttu-id="7877b-239">若要讓這些專案正常執行，您必須在 `Page_Init` 事件處理常式中呼叫 `EnableDynamicData` 方法。</span><span class="sxs-lookup"><span data-stu-id="7877b-239">For these to work, you will have to call the `EnableDynamicData` method in the `Page_Init` event handler.</span></span> <span data-ttu-id="7877b-240">（`DynamicControl` 控制項不會在 [`Administrator`] 欄位中使用，因為它們不適用於導覽屬性）。</span><span class="sxs-lookup"><span data-stu-id="7877b-240">(`DynamicControl` controls are not used in the `Administrator` field because they don't work with navigation properties.)</span></span>

<span data-ttu-id="7877b-241">稍後當您將具有嵌套 `GridView` 控制項的資料行加入至方格時，`Vertical-Align="Top"` 屬性將會變得很重要。</span><span class="sxs-lookup"><span data-stu-id="7877b-241">The `Vertical-Align="Top"` attributes will become important later when you add a column that has a nested `GridView` control to the grid.</span></span>

<span data-ttu-id="7877b-242">開啟*Departments.aspx.cs*檔案，並新增下列 `using` 語句：</span><span class="sxs-lookup"><span data-stu-id="7877b-242">Open the *Departments.aspx.cs* file and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample4.cs)]

<span data-ttu-id="7877b-243">然後，為頁面的 `Init` 事件新增下列處理常式：</span><span class="sxs-lookup"><span data-stu-id="7877b-243">Then add the following handler for the page's `Init` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample5.cs)]

<span data-ttu-id="7877b-244">在*DAL*資料夾中，建立名為*Department.cs*的新類別檔案，並以下列程式碼取代現有的程式碼：</span><span class="sxs-lookup"><span data-stu-id="7877b-244">In the *DAL* folder, create a new class file named *Department.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample6.cs)]

<span data-ttu-id="7877b-245">此程式碼會將中繼資料加入至資料模型。</span><span class="sxs-lookup"><span data-stu-id="7877b-245">This code adds metadata to the data model.</span></span> <span data-ttu-id="7877b-246">它會指定 `Department` 實體的 `Budget` 屬性實際上代表貨幣，雖然它的資料類型是 `Decimal`的，而且它會指定此值必須介於0到 $1000000.00 之間。</span><span class="sxs-lookup"><span data-stu-id="7877b-246">It specifies that the `Budget` property of the `Department` entity actually represents currency although its data type is `Decimal`, and it specifies that the value must be between 0 and $1,000,000.00.</span></span> <span data-ttu-id="7877b-247">它也會指定 `StartDate` 屬性應格式化為 mm/dd/yyyy 格式的日期。</span><span class="sxs-lookup"><span data-stu-id="7877b-247">It also specifies that the `StartDate` property should be formatted as a date in the format mm/dd/yyyy.</span></span>

<span data-ttu-id="7877b-248">執行 [*部門 .aspx* ] 頁面。</span><span class="sxs-lookup"><span data-stu-id="7877b-248">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="7877b-249">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-249">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span></span>

<span data-ttu-id="7877b-250">請注意，雖然您並未在 [**預算**] 或 [**開始日期] 資料**行的 [ *.aspx* ] 頁面標記中指定格式字串，`DynamicField` 控制項也會使用您在*Department.cs*檔案中提供的中繼資料來套用預設貨幣和日期格式。</span><span class="sxs-lookup"><span data-stu-id="7877b-250">Notice that although you did not specify a format string in the *Departments.aspx* page markup for the **Budget** or **Start Date** columns, default currency and date formatting has been applied to them by the `DynamicField` controls, using the metadata that you supplied in the *Department.cs* file.</span></span>

## <a name="adding-insert-and-delete-functionality"></a><span data-ttu-id="7877b-251">新增插入和刪除功能</span><span class="sxs-lookup"><span data-stu-id="7877b-251">Adding Insert and Delete Functionality</span></span>

<span data-ttu-id="7877b-252">開啟*SchoolRepository.cs*，加入下列程式碼，以建立 `Insert` 方法和 `Delete` 方法。</span><span class="sxs-lookup"><span data-stu-id="7877b-252">Open *SchoolRepository.cs*, add the following code in order to create an `Insert` method and a `Delete` method.</span></span> <span data-ttu-id="7877b-253">程式碼也包含名為 `GenerateDepartmentID` 的方法，其會計算下一個可用的記錄索引鍵值，供 `Insert` 方法使用。</span><span class="sxs-lookup"><span data-stu-id="7877b-253">The code also includes a method named `GenerateDepartmentID` that calculates the next available record key value for use by the `Insert` method.</span></span> <span data-ttu-id="7877b-254">這是必要的，因為資料庫未設定為自動為 `Department` 資料表計算這種情況。</span><span class="sxs-lookup"><span data-stu-id="7877b-254">This is required because the database is not configured to calculate this automatically for the `Department` table.</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample7.cs)]

### <a name="the-attach-method"></a><span data-ttu-id="7877b-255">Attach 方法</span><span class="sxs-lookup"><span data-stu-id="7877b-255">The Attach Method</span></span>

<span data-ttu-id="7877b-256">`DeleteDepartment` 方法會呼叫 `Attach` 方法，以便重新建立在物件內容的物件狀態管理員中，于記憶體中的實體與它所代表的資料庫資料列之間維護的連結。</span><span class="sxs-lookup"><span data-stu-id="7877b-256">The `DeleteDepartment` method calls the `Attach` method in order to re-establish the link that's maintained in the object context's object state manager between the entity in memory and the database row it represents.</span></span> <span data-ttu-id="7877b-257">這必須在方法呼叫 `SaveChanges` 方法之前發生。</span><span class="sxs-lookup"><span data-stu-id="7877b-257">This must occur before the method calls the `SaveChanges` method.</span></span>

<span data-ttu-id="7877b-258">「*物件內容*」一詞指的是衍生自您用來存取實體集和實體之 `ObjectContext` 類別的 Entity Framework 類別。</span><span class="sxs-lookup"><span data-stu-id="7877b-258">The term *object context* refers to the Entity Framework class that derives from the `ObjectContext` class that you use to access your entity sets and entities.</span></span> <span data-ttu-id="7877b-259">在此專案的程式碼中，類別會命名為 `SchoolEntities`，而且其實例一律會命名為 `context`。</span><span class="sxs-lookup"><span data-stu-id="7877b-259">In the code for this project, the class is named `SchoolEntities`, and an instance of it is always named `context`.</span></span> <span data-ttu-id="7877b-260">物件內容的*物件狀態管理員*是衍生自 `ObjectStateManager` 類別的類別。</span><span class="sxs-lookup"><span data-stu-id="7877b-260">The object context's *object state manager* is a class that derives from the `ObjectStateManager` class.</span></span> <span data-ttu-id="7877b-261">物件連絡人會使用物件狀態管理員來儲存實體物件，並追蹤每一個物件是否與資料庫中對應的資料表資料列或資料列同步。</span><span class="sxs-lookup"><span data-stu-id="7877b-261">The object contact uses the object state manager to store entity objects and to keep track of whether each one is in sync with its corresponding table row or rows in the database.</span></span>

<span data-ttu-id="7877b-262">當您讀取實體時，物件內容會將它儲存在物件狀態管理員中，並追蹤物件的表示是否與資料庫同步。</span><span class="sxs-lookup"><span data-stu-id="7877b-262">When you read an entity, the object context stores it in the object state manager and keeps track of whether that representation of the object is in sync with the database.</span></span> <span data-ttu-id="7877b-263">例如，如果您變更屬性值，則會設定旗標，表示您所變更的屬性已不再與資料庫同步。</span><span class="sxs-lookup"><span data-stu-id="7877b-263">For example, if you change a property value, a flag is set to indicate that the property you changed is no longer in sync with the database.</span></span> <span data-ttu-id="7877b-264">然後，當您呼叫 `SaveChanges` 方法時，物件內容會知道要在資料庫中執行的動作，因為物件狀態管理員知道實體的目前狀態與資料庫狀態之間的差異。</span><span class="sxs-lookup"><span data-stu-id="7877b-264">Then when you call the `SaveChanges` method, the object context knows what to do in the database because the object state manager knows exactly what's different between the current state of the entity and the state of the database.</span></span>

<span data-ttu-id="7877b-265">不過，這個進程通常無法在 web 應用程式中運作，因為在轉譯頁面之後，會處置讀取實體的物件內容實例，以及其物件狀態管理員中的所有專案。</span><span class="sxs-lookup"><span data-stu-id="7877b-265">However, this process typically does not work in a web application, because the object context instance that reads an entity, along with everything in its object state manager, is disposed after a page is rendered.</span></span> <span data-ttu-id="7877b-266">必須套用變更的物件內容實例，是針對回傳處理而具現化的一個新的。</span><span class="sxs-lookup"><span data-stu-id="7877b-266">The object context instance that must apply changes is a new one that's instantiated for postback processing.</span></span> <span data-ttu-id="7877b-267">在 `DeleteDepartment` 方法的情況下，`ObjectDataSource` 控制項會從 view 狀態中的值重新建立實體的原始版本，但此重新建立的 `Department` 實體並不存在於物件狀態管理員中。</span><span class="sxs-lookup"><span data-stu-id="7877b-267">In the case of the `DeleteDepartment` method, the `ObjectDataSource` control re-creates the original version of the entity for you from values in view state, but this re-created `Department` entity does not exist in the object state manager.</span></span> <span data-ttu-id="7877b-268">如果您在這個重新建立的實體上呼叫 `DeleteObject` 方法，呼叫將會失敗，因為物件內容並不知道實體是否與資料庫同步。</span><span class="sxs-lookup"><span data-stu-id="7877b-268">If you called the `DeleteObject` method on this re-created entity, the call would fail because the object context does not know whether the entity is in sync with the database.</span></span> <span data-ttu-id="7877b-269">不過，呼叫 `Attach` 方法會在重新建立的實體與資料庫中的值之間重建相同的追蹤，該實體是在讀取先前的物件內容實例中時自動完成。</span><span class="sxs-lookup"><span data-stu-id="7877b-269">However, calling the `Attach` method re-establishes the same tracking between the re-created entity and the values in the database that was originally done automatically when the entity was read in an earlier instance of the object context.</span></span>

<span data-ttu-id="7877b-270">有時候，您不希望物件內容追蹤物件狀態管理員中的實體，而且您可以設定旗標來防止它這麼做。</span><span class="sxs-lookup"><span data-stu-id="7877b-270">There are times when you don't want the object context to track entities in the object state manager, and you can set flags to prevent it from doing that.</span></span> <span data-ttu-id="7877b-271">本系列稍後的教學課程中會顯示這種情況的範例。</span><span class="sxs-lookup"><span data-stu-id="7877b-271">Examples of this are shown in later tutorials in this series.</span></span>

### <a name="the-savechanges-method"></a><span data-ttu-id="7877b-272">SaveChanges 方法</span><span class="sxs-lookup"><span data-stu-id="7877b-272">The SaveChanges Method</span></span>

<span data-ttu-id="7877b-273">這個簡單的存放庫類別說明如何執行 CRUD 作業的基本原則。</span><span class="sxs-lookup"><span data-stu-id="7877b-273">This simple repository class illustrates basic principles of how to perform CRUD operations.</span></span> <span data-ttu-id="7877b-274">在此範例中，會在每次更新之後立即呼叫 `SaveChanges` 方法。</span><span class="sxs-lookup"><span data-stu-id="7877b-274">In this example, the `SaveChanges` method is called immediately after each update.</span></span> <span data-ttu-id="7877b-275">在生產應用程式中，您可能會想要從不同的方法呼叫 `SaveChanges` 方法，讓您更充分掌控資料庫的更新時間。</span><span class="sxs-lookup"><span data-stu-id="7877b-275">In a production application you might want to call the `SaveChanges` method from a separate method to give you more control over when the database is updated.</span></span> <span data-ttu-id="7877b-276">（在下一個教學課程結束時，您會看到一份白皮書的連結，其中討論工作單位模式，這是協調相關更新的一種方法）。另請注意，在此範例中，`DeleteDepartment` 方法不包含處理並行衝突的程式碼;將在本系列稍後的教學課程中新增程式碼來執行此動作。</span><span class="sxs-lookup"><span data-stu-id="7877b-276">(At the end of the next tutorial you will find a link to a white paper that discusses the unit of work pattern which is one approach to coordinating related updates.) Notice also that in the example, the `DeleteDepartment` method does not include code for handling concurrency conflicts; code to do that will be added in a later tutorial in this series.</span></span>

### <a name="retrieving-instructor-names-to-select-when-inserting"></a><span data-ttu-id="7877b-277">在插入時，抓取要選取的講師名稱</span><span class="sxs-lookup"><span data-stu-id="7877b-277">Retrieving Instructor Names to Select When Inserting</span></span>

<span data-ttu-id="7877b-278">建立新部門時，使用者必須能夠在下拉式清單中選取一份講師清單中的系統管理員。</span><span class="sxs-lookup"><span data-stu-id="7877b-278">Users must be able to select an administrator from a list of instructors in a drop-down list when creating new departments.</span></span> <span data-ttu-id="7877b-279">因此，請將下列程式碼新增至*SchoolRepository.cs* ，以使用您稍早建立的視圖來建立方法來抓取講師清單：</span><span class="sxs-lookup"><span data-stu-id="7877b-279">Therefore, add the following code to *SchoolRepository.cs* to create a method to retrieve the list of instructors using the view that you created earlier:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample8.cs)]

### <a name="creating-a-page-for-inserting-departments"></a><span data-ttu-id="7877b-280">建立用於插入部門的頁面</span><span class="sxs-lookup"><span data-stu-id="7877b-280">Creating a Page for Inserting Departments</span></span>

<span data-ttu-id="7877b-281">建立*DepartmentsAdd* ，並使用 [*網站*] 頁面，並在名為 `Content2`的 `Content` 控制項中新增下列標記：</span><span class="sxs-lookup"><span data-stu-id="7877b-281">Create a *DepartmentsAdd.aspx* page that uses the *Site.Master* page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample9.aspx)]

<span data-ttu-id="7877b-282">此標記會建立兩個 `ObjectDataSource` 控制項，一個用於插入新的 `Department` 實體，另一個用於抓取用於選取部門系統管理員之 `DropDownList` 控制項的講師名稱。</span><span class="sxs-lookup"><span data-stu-id="7877b-282">This markup creates two `ObjectDataSource` controls, one for inserting new `Department` entities and one for retrieving instructor names for the `DropDownList` control that's used for selecting department administrators.</span></span> <span data-ttu-id="7877b-283">標記會建立一個用於輸入新部門的 `DetailsView` 控制項，並為控制項的 `ItemInserting` 事件指定處理常式，讓您可以設定 `Administrator` 的外鍵值。</span><span class="sxs-lookup"><span data-stu-id="7877b-283">The markup creates a `DetailsView` control for entering new departments, and it specifies a handler for the control's `ItemInserting` event so that you can set the `Administrator` foreign key value.</span></span> <span data-ttu-id="7877b-284">結尾是顯示錯誤訊息的 `ValidationSummary` 控制項。</span><span class="sxs-lookup"><span data-stu-id="7877b-284">At the end is a `ValidationSummary` control to display error messages.</span></span>

<span data-ttu-id="7877b-285">開啟*DepartmentsAdd.aspx.cs* ，並新增下列 `using` 語句：</span><span class="sxs-lookup"><span data-stu-id="7877b-285">Open *DepartmentsAdd.aspx.cs* and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample10.cs)]

<span data-ttu-id="7877b-286">新增下列類別變數和方法：</span><span class="sxs-lookup"><span data-stu-id="7877b-286">Add the following class variable and methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample11.cs)]

<span data-ttu-id="7877b-287">`Page_Init` 方法會啟用動態資料功能。</span><span class="sxs-lookup"><span data-stu-id="7877b-287">The `Page_Init` method enables Dynamic Data functionality.</span></span> <span data-ttu-id="7877b-288">`DropDownList` 控制項的 `Init` 事件的處理常式會儲存控制項的參考，而 `DetailsView` 控制項的 `Inserting` 事件的處理常式會使用該參考來取得所選講師的 `PersonID` 值，並更新 `Administrator` 實體的 `Department` 外鍵屬性。</span><span class="sxs-lookup"><span data-stu-id="7877b-288">The handler for the `DropDownList` control's `Init` event saves a reference to the control, and the handler for the `DetailsView` control's `Inserting` event uses that reference to get the `PersonID` value of the selected instructor and update the `Administrator` foreign key property of the `Department` entity.</span></span>

<span data-ttu-id="7877b-289">執行頁面，新增新部門的資訊，然後按一下 [**插入**] 連結。</span><span class="sxs-lookup"><span data-stu-id="7877b-289">Run the page, add information for a new department, and then click the **Insert** link.</span></span>

<span data-ttu-id="7877b-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span></span>

<span data-ttu-id="7877b-291">輸入另一個新部門的值。</span><span class="sxs-lookup"><span data-stu-id="7877b-291">Enter values for another new department.</span></span> <span data-ttu-id="7877b-292">在 [**預算**] 欄位中輸入大於1000000.00 的數位，並在下一個欄位上按 tab 鍵。</span><span class="sxs-lookup"><span data-stu-id="7877b-292">Enter a number greater than 1,000,000.00 in the **Budget** field and tab to the next field.</span></span> <span data-ttu-id="7877b-293">欄位中會出現一個星號，如果您將滑鼠指標停留在該欄位中，就會看到您在該欄位的中繼資料中輸入的錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="7877b-293">An asterisk appears in the field, and if you hold the mouse pointer over it, you can see the error message that you entered in the metadata for that field.</span></span>

<span data-ttu-id="7877b-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span></span>

<span data-ttu-id="7877b-295">按一下 [**插入**]，您會看到頁面底部的 [`ValidationSummary`] 控制項所顯示的錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="7877b-295">Click **Insert**, and you see the error message displayed by the `ValidationSummary` control at the bottom of the page.</span></span>

<span data-ttu-id="7877b-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span></span>

<span data-ttu-id="7877b-297">接下來，關閉瀏覽器並開啟 [*部門 .aspx* ] 頁面。</span><span class="sxs-lookup"><span data-stu-id="7877b-297">Next, close the browser and open the *Departments.aspx* page.</span></span> <span data-ttu-id="7877b-298">藉由將 `DeleteMethod` 屬性加入至 [`ObjectDataSource`] 控制項，並將 `DataKeyNames` 屬性加入至 `GridView` 控制項，將刪除功能新增至 [node.js *] 頁面。*</span><span class="sxs-lookup"><span data-stu-id="7877b-298">Add delete capability to the *Departments.aspx* page by adding a `DeleteMethod` attribute to the `ObjectDataSource` control, and a `DataKeyNames` attribute to the `GridView` control.</span></span> <span data-ttu-id="7877b-299">這些控制項的開頭標記現在會如下列範例所示：</span><span class="sxs-lookup"><span data-stu-id="7877b-299">The opening tags for these controls will now resemble the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample12.aspx)]

<span data-ttu-id="7877b-300">執行頁面。</span><span class="sxs-lookup"><span data-stu-id="7877b-300">Run the page.</span></span>

<span data-ttu-id="7877b-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span></span>

<span data-ttu-id="7877b-302">刪除您在執行*DepartmentsAdd*時所新增的部門。</span><span class="sxs-lookup"><span data-stu-id="7877b-302">Delete the department you added when you ran the *DepartmentsAdd.aspx* page.</span></span>

## <a name="adding-update-functionality"></a><span data-ttu-id="7877b-303">新增更新功能</span><span class="sxs-lookup"><span data-stu-id="7877b-303">Adding Update Functionality</span></span>

<span data-ttu-id="7877b-304">開啟*SchoolRepository.cs* ，並新增下列 `Update` 方法：</span><span class="sxs-lookup"><span data-stu-id="7877b-304">Open *SchoolRepository.cs* and add the following `Update` method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample13.cs)]

<span data-ttu-id="7877b-305">當您按一下 [*部門 .aspx* ] 頁面中的 [**更新**] 時，`ObjectDataSource` 控制項會建立兩個 `Department` 的實體，以傳遞至 `UpdateDepartment` 方法。</span><span class="sxs-lookup"><span data-stu-id="7877b-305">When you click **Update** in the *Departments.aspx* page, the `ObjectDataSource` control creates two `Department` entities to pass to the `UpdateDepartment` method.</span></span> <span data-ttu-id="7877b-306">其中一個包含已儲存在 view 狀態中的原始值，另一個則包含在 `GridView` 控制項中輸入的新值。</span><span class="sxs-lookup"><span data-stu-id="7877b-306">One contains the original values that have been stored in view state, and the other contains the new values that were entered in the `GridView` control.</span></span> <span data-ttu-id="7877b-307">`UpdateDepartment` 方法中的程式碼會將具有原始值的 `Department` 實體傳遞至 `Attach` 方法，以便在實體和資料庫中的專案之間建立追蹤。</span><span class="sxs-lookup"><span data-stu-id="7877b-307">The code in the `UpdateDepartment` method passes the `Department` entity that has the original values to the `Attach` method in order to establish the tracking between the entity and what's in the database.</span></span> <span data-ttu-id="7877b-308">然後，程式碼會將具有新值的 `Department` 實體傳遞至 `ApplyCurrentValues` 方法。</span><span class="sxs-lookup"><span data-stu-id="7877b-308">Then the code passes the `Department` entity that has the new values to the `ApplyCurrentValues` method.</span></span> <span data-ttu-id="7877b-309">物件內容會比較新舊值。</span><span class="sxs-lookup"><span data-stu-id="7877b-309">The object context compares the old and new values.</span></span> <span data-ttu-id="7877b-310">如果新的值與舊的值不同，則物件內容會變更屬性值。</span><span class="sxs-lookup"><span data-stu-id="7877b-310">If a new value is different from an old value, the object context changes the property value.</span></span> <span data-ttu-id="7877b-311">然後，`SaveChanges` 方法只會更新資料庫中已變更的資料行。</span><span class="sxs-lookup"><span data-stu-id="7877b-311">The `SaveChanges` method then updates only the changed columns in the database.</span></span> <span data-ttu-id="7877b-312">（不過，如果這個實體的 update 函式已對應至預存程式，則不論變更的資料行為何，都會更新整個資料列）。</span><span class="sxs-lookup"><span data-stu-id="7877b-312">(However, if the update function for this entity were mapped to a stored procedure, the entire row would be updated regardless of which columns were changed.)</span></span>

<span data-ttu-id="7877b-313">開啟 [*部門 .aspx*檔案]，並將下列屬性新增至 `DepartmentsObjectDataSource` 控制項：</span><span class="sxs-lookup"><span data-stu-id="7877b-313">Open the *Departments.aspx* file and add the following attributes to the `DepartmentsObjectDataSource` control:</span></span>

- `UpdateMethod="UpdateDepartment"`
- `ConflictDetection="CompareAllValues"`   
 <span data-ttu-id="7877b-314">這會導致舊值儲存在 view 狀態中，以便與 `Update` 方法中的新值進行比較。</span><span class="sxs-lookup"><span data-stu-id="7877b-314">This causes old values to be stored in view state so that they can be compared with the new values in the `Update` method.</span></span>
- `OldValuesParameterFormatString="orig{0}"`   
 <span data-ttu-id="7877b-315">這會通知控制項，原始值參數的名稱為 `origDepartment`。</span><span class="sxs-lookup"><span data-stu-id="7877b-315">This informs the control that the name of the original values parameter is `origDepartment` .</span></span>

<span data-ttu-id="7877b-316">`ObjectDataSource` 控制項之開頭標記的標記現在與下列範例類似：</span><span class="sxs-lookup"><span data-stu-id="7877b-316">The markup for the opening tag of the `ObjectDataSource` control now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample14.aspx)]

<span data-ttu-id="7877b-317">將 `OnRowUpdating="DepartmentsGridView_RowUpdating"` 屬性加入至 [`GridView`] 控制項。</span><span class="sxs-lookup"><span data-stu-id="7877b-317">Add an `OnRowUpdating="DepartmentsGridView_RowUpdating"` attribute to the `GridView` control.</span></span> <span data-ttu-id="7877b-318">您將使用這個值，根據使用者在下拉式清單中選取的資料列，來設定 `Administrator` 屬性值。</span><span class="sxs-lookup"><span data-stu-id="7877b-318">You will use this to set the `Administrator` property value based on the row the user selects in a drop-down list.</span></span> <span data-ttu-id="7877b-319">`GridView` 開頭標記現在與下列範例類似：</span><span class="sxs-lookup"><span data-stu-id="7877b-319">The `GridView` opening tag now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample15.aspx)]

<span data-ttu-id="7877b-320">將 [`Administrator`] 資料行的 `EditItemTemplate` 控制項加入至 [`GridView`] 控制項，緊接在該資料行的 `ItemTemplate` 控制項之後：</span><span class="sxs-lookup"><span data-stu-id="7877b-320">Add an `EditItemTemplate` control for the `Administrator` column to the `GridView` control, immediately after the `ItemTemplate` control for that column:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample16.aspx)]

<span data-ttu-id="7877b-321">這個 `EditItemTemplate` 控制項類似于*DepartmentsAdd .aspx*頁面中的 `InsertItemTemplate` 控制項。</span><span class="sxs-lookup"><span data-stu-id="7877b-321">This `EditItemTemplate` control is similar to the `InsertItemTemplate` control in the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="7877b-322">其差異在於，控制項的初始值是使用 `SelectedValue` 屬性來設定。</span><span class="sxs-lookup"><span data-stu-id="7877b-322">The difference is that the initial value of the control is set using the `SelectedValue` attribute.</span></span>

<span data-ttu-id="7877b-323">在 `GridView` 控制項之前，加入 `ValidationSummary` 控制項，如同您在*DepartmentsAdd .aspx*頁面中所做的一樣。</span><span class="sxs-lookup"><span data-stu-id="7877b-323">Before the `GridView` control, add a `ValidationSummary` control as you did in the *DepartmentsAdd.aspx* page.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample17.aspx)]

<span data-ttu-id="7877b-324">開啟*Departments.aspx.cs* ，並緊接在部分類別宣告之後，加入下列程式碼來建立私用欄位來參考 `DropDownList` 控制項：</span><span class="sxs-lookup"><span data-stu-id="7877b-324">Open *Departments.aspx.cs* and immediately after the partial-class declaration, add the following code to create a private field to reference the `DropDownList` control:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample18.cs)]

<span data-ttu-id="7877b-325">然後，為 `DropDownList` 控制項的 `Init` 事件和 `GridView` 控制項的 `RowUpdating` 事件新增處理常式：</span><span class="sxs-lookup"><span data-stu-id="7877b-325">Then add handlers for the `DropDownList` control's `Init` event and the `GridView` control's `RowUpdating` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample19.cs)]

<span data-ttu-id="7877b-326">`Init` 事件的處理常式會在 [類別] 欄位中儲存 `DropDownList` 控制項的參考。</span><span class="sxs-lookup"><span data-stu-id="7877b-326">The handler for the `Init` event saves a reference to the `DropDownList` control in the class field.</span></span> <span data-ttu-id="7877b-327">`RowUpdating` 事件的處理常式會使用參考來取得使用者輸入的值，並將它套用至 `Department` 實體的 `Administrator` 屬性。</span><span class="sxs-lookup"><span data-stu-id="7877b-327">The handler for the `RowUpdating` event uses the reference to get the value the user entered and apply it to the `Administrator` property of the `Department` entity.</span></span>

<span data-ttu-id="7877b-328">使用 [ *DepartmentsAdd* ] 頁面來新增部門，然後執行 [*部門 .aspx* ] 頁面，然後在您新增的資料列上按一下 [**編輯**]。</span><span class="sxs-lookup"><span data-stu-id="7877b-328">Use the *DepartmentsAdd.aspx* page to add a new department, then run the *Departments.aspx* page and click **Edit** on the row that you added.</span></span>

> [!NOTE]
> <span data-ttu-id="7877b-329">因為資料庫中的資料無效，所以您將無法編輯未加入的資料列（也就是已經在資料庫中）。使用資料庫所建立之資料列的系統管理員是學生。</span><span class="sxs-lookup"><span data-stu-id="7877b-329">You will not be able to edit rows that you did not add (that is, that were already in the database), because of invalid data in the database; the administrators for the rows that were created with the database are students.</span></span> <span data-ttu-id="7877b-330">如果您嘗試編輯其中一個，您會收到報告錯誤的錯誤頁面，例如 `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span><span class="sxs-lookup"><span data-stu-id="7877b-330">If you try to edit one of them, you will get an error page that reports an error like `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span></span>

<span data-ttu-id="7877b-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span></span>

<span data-ttu-id="7877b-332">如果您輸入不正確**預算**金額，然後按一下 [**更新**]，您會看到與您在 [*部門 .aspx* ] 頁面中看到的相同星號和錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="7877b-332">If you enter an invalid **Budget** amount and then click **Update**, you see the same asterisk and error message that you saw in the *Departments.aspx* page.</span></span>

<span data-ttu-id="7877b-333">變更域值或選取不同的系統管理員，然後按一下 [**更新**]。</span><span class="sxs-lookup"><span data-stu-id="7877b-333">Change a field value or select a different administrator and click **Update**.</span></span> <span data-ttu-id="7877b-334">隨即顯示變更。</span><span class="sxs-lookup"><span data-stu-id="7877b-334">The change is displayed.</span></span>

<span data-ttu-id="7877b-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="7877b-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span></span>

<span data-ttu-id="7877b-336">這會完成使用 Entity Framework 的基本 CRUD （建立、讀取、更新、刪除）作業的 `ObjectDataSource` 控制項簡介。</span><span class="sxs-lookup"><span data-stu-id="7877b-336">This completes the introduction to using the `ObjectDataSource` control for basic CRUD (create, read, update, delete) operations with the Entity Framework.</span></span> <span data-ttu-id="7877b-337">您已建立簡單的多層式應用程式，但商業邏輯層仍與資料存取層緊密結合，這會使自動化單元測試變得複雜。</span><span class="sxs-lookup"><span data-stu-id="7877b-337">You've built a simple n-tier application, but the business-logic layer is still tightly coupled to the data-access layer, which complicates automated unit testing.</span></span> <span data-ttu-id="7877b-338">在下列教學課程中，您將瞭解如何執行存放庫模式來加速單元測試。</span><span class="sxs-lookup"><span data-stu-id="7877b-338">In the following tutorial you'll see how to implement the repository pattern to facilitate unit testing.</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="7877b-339">下一個</span><span class="sxs-lookup"><span data-stu-id="7877b-339">Next</span></span>](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests.md)
