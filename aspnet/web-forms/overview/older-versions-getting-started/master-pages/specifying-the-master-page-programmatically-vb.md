---
uid: web-forms/overview/older-versions-getting-started/master-pages/specifying-the-master-page-programmatically-vb
title: 以程式設計方式指定主版頁面（VB） |Microsoft Docs
author: rick-anderson
description: 查看如何透過 PreInit 事件處理常式，以程式設計方式設定內容頁面的主版頁面。
ms.author: riande
ms.date: 07/28/2008
ms.assetid: 0edcd653-f24a-41aa-aef4-75f868fe5ac2
msc.legacyurl: /web-forms/overview/older-versions-getting-started/master-pages/specifying-the-master-page-programmatically-vb
msc.type: authoredcontent
ms.openlocfilehash: 3b039b22bef38ae6ebf80be070820dc1638f87f4
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/28/2019
ms.locfileid: "74618577"
---
# <a name="specifying-the-master-page-programmatically-vb"></a><span data-ttu-id="799e6-103">以程式設計方式指定主版頁面 (VB)</span><span class="sxs-lookup"><span data-stu-id="799e6-103">Specifying the Master Page Programmatically (VB)</span></span>

<span data-ttu-id="799e6-104">由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="799e6-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="799e6-105">[下載程式代碼](https://download.microsoft.com/download/d/6/6/d66ad554-afdd-409e-a5c3-201b774fbb31/ASPNET_MasterPages_Tutorial_09_VB.zip)或[下載 PDF](https://download.microsoft.com/download/d/6/6/d66ad554-afdd-409e-a5c3-201b774fbb31/ASPNET_MasterPages_Tutorial_09_VB.pdf)</span><span class="sxs-lookup"><span data-stu-id="799e6-105">[Download Code](https://download.microsoft.com/download/d/6/6/d66ad554-afdd-409e-a5c3-201b774fbb31/ASPNET_MasterPages_Tutorial_09_VB.zip) or [Download PDF](https://download.microsoft.com/download/d/6/6/d66ad554-afdd-409e-a5c3-201b774fbb31/ASPNET_MasterPages_Tutorial_09_VB.pdf)</span></span>

> <span data-ttu-id="799e6-106">查看如何透過 PreInit 事件處理常式，以程式設計方式設定內容頁面的主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-106">Looks at setting the content page's master page programmatically via the PreInit event handler.</span></span>

## <a name="introduction"></a><span data-ttu-id="799e6-107">簡介</span><span class="sxs-lookup"><span data-stu-id="799e6-107">Introduction</span></span>

<span data-ttu-id="799e6-108">由於[*使用主版頁面建立全網站版面*](creating-a-site-wide-layout-using-master-pages-vb.md)配置的執筆範例，所有內容頁面都已透過 `@Page` 指示詞中的 `MasterPageFile` 屬性，以宣告方式參考其主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-108">Since the inaugural example in [*Creating a Site-Wide Layout Using Master Pages*](creating-a-site-wide-layout-using-master-pages-vb.md), all content pages have referenced their master page declaratively via the `MasterPageFile` attribute in the `@Page` directive.</span></span> <span data-ttu-id="799e6-109">例如，下列 `@Page` 指示詞會將內容頁面連結至主版頁面 `Site.master`：</span><span class="sxs-lookup"><span data-stu-id="799e6-109">For example, the following `@Page` directive links the content page to the master page `Site.master`:</span></span>

[!code-aspx[Main](specifying-the-master-page-programmatically-vb/samples/sample1.aspx)]

<span data-ttu-id="799e6-110">`System.Web.UI` 命名空間中的[`Page` 類別](https://msdn.microsoft.com/library/system.web.ui.page.aspx)包含[`MasterPageFile` 屬性](https://msdn.microsoft.com/library/system.web.ui.page.masterpagefile.aspx)，可傳回內容頁面主版頁面的路徑;這是由 `@Page` 指示詞設定的這個屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-110">The [`Page` class](https://msdn.microsoft.com/library/system.web.ui.page.aspx) in the `System.Web.UI` namespace includes a [`MasterPageFile` property](https://msdn.microsoft.com/library/system.web.ui.page.masterpagefile.aspx) that returns the path to the content page's master page; it is this property that is set by the `@Page` directive.</span></span> <span data-ttu-id="799e6-111">這個屬性也可以用來以程式設計方式指定內容頁面的主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-111">This property can also be used to programmatically specify the content page's master page.</span></span> <span data-ttu-id="799e6-112">如果您想要根據外部因素（例如造訪頁面的使用者）動態指派主版頁面，這個方法就很有用。</span><span class="sxs-lookup"><span data-stu-id="799e6-112">This approach is useful if you want to dynamically assign the master page based on external factors, such as the user visiting the page.</span></span>

<span data-ttu-id="799e6-113">在本教學課程中，我們會在網站中新增第二個主版頁面，並以動態方式決定要在執行時間使用的主版頁面</span><span class="sxs-lookup"><span data-stu-id="799e6-113">In this tutorial we add a second master page to our website and dynamically decide which master page to use at runtime.</span></span>

## <a name="step-1-a-look-at-the-page-lifecycle"></a><span data-ttu-id="799e6-114">步驟1：查看頁面生命週期</span><span class="sxs-lookup"><span data-stu-id="799e6-114">Step 1: A Look at the Page Lifecycle</span></span>

<span data-ttu-id="799e6-115">每當要求抵達網頁伺服器做為內容頁面的 ASP.NET 網頁時，ASP.NET 引擎就必須將頁面的內容控制項保險絲到主版頁面的對應 ContentPlaceHolder 控制項。</span><span class="sxs-lookup"><span data-stu-id="799e6-115">Whenever a request arrives at the web server for an ASP.NET page that is a content page, the ASP.NET engine must fuse the page's Content controls into the master page's corresponding ContentPlaceHolder controls.</span></span> <span data-ttu-id="799e6-116">這種融合會建立單一控制階層，然後可以繼續進行一般的網頁生命週期。</span><span class="sxs-lookup"><span data-stu-id="799e6-116">This fusion creates a single control hierarchy that can then proceed through the typical page lifecycle.</span></span>

<span data-ttu-id="799e6-117">[圖 1] 說明這種融合。</span><span class="sxs-lookup"><span data-stu-id="799e6-117">Figure 1 illustrates this fusion.</span></span> <span data-ttu-id="799e6-118">[圖 1] 中的步驟1顯示初始內容和主版頁面控制項階層。</span><span class="sxs-lookup"><span data-stu-id="799e6-118">Step 1 in Figure 1 shows the initial content and master page control hierarchies.</span></span> <span data-ttu-id="799e6-119">在 PreInit 階段的結尾處，頁面中的內容控制項會加入至主版頁面中對應的 ContentPlaceHolders （步驟2）。</span><span class="sxs-lookup"><span data-stu-id="799e6-119">At the tail end of the PreInit stage the Content controls in the page are added to the corresponding ContentPlaceHolders in the master page (Step 2).</span></span> <span data-ttu-id="799e6-120">在此融合之後，主版頁面會作為融合控制項階層的根。</span><span class="sxs-lookup"><span data-stu-id="799e6-120">After this fusion, the master page serves as the root of the fused control hierarchy.</span></span> <span data-ttu-id="799e6-121">這個已融合的控制項階層會接著加入至頁面，以產生完成的控制項階層（步驟3）。</span><span class="sxs-lookup"><span data-stu-id="799e6-121">This fused control hierarchy is then added to the page to produce the finalized control hierarchy (Step 3).</span></span> <span data-ttu-id="799e6-122">最後結果是頁面的控制項階層會包含已融合的控制項階層。</span><span class="sxs-lookup"><span data-stu-id="799e6-122">The net result is that the page's control hierarchy includes the fused control hierarchy.</span></span>

<span data-ttu-id="799e6-123">[![主版頁面和內容頁面的控制階層會在 PreInit 階段一起合併在一起](specifying-the-master-page-programmatically-vb/_static/image2.png)](specifying-the-master-page-programmatically-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="799e6-123">[![The Master Page and Content Page's Control Hierarchies are Fused Together during the PreInit Stage](specifying-the-master-page-programmatically-vb/_static/image2.png)](specifying-the-master-page-programmatically-vb/_static/image1.png)</span></span>

<span data-ttu-id="799e6-124">**圖 01**：主版頁面和內容頁面的控制階層會在 PreInit 階段合在一起（[按一下以觀看完整大小的影像](specifying-the-master-page-programmatically-vb/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="799e6-124">**Figure 01**: The Master Page and Content Page's Control Hierarchies are Fused Together during the PreInit Stage ([Click to view full-size image](specifying-the-master-page-programmatically-vb/_static/image3.png))</span></span>

## <a name="step-2-setting-themasterpagefileproperty-from-code"></a><span data-ttu-id="799e6-125">步驟2：從程式碼設定`MasterPageFile`屬性</span><span class="sxs-lookup"><span data-stu-id="799e6-125">Step 2: Setting the`MasterPageFile`Property from Code</span></span>

<span data-ttu-id="799e6-126">這個融合中的主版頁面 partakes 取決於 `Page` 物件的 `MasterPageFile` 屬性值。</span><span class="sxs-lookup"><span data-stu-id="799e6-126">What master page partakes in this fusion depends on the value of the `Page` object's `MasterPageFile` property.</span></span> <span data-ttu-id="799e6-127">在 `@Page` 指示詞中設定 `MasterPageFile` 屬性，會在初始化階段（也就是頁面生命週期的第一個階段）中指派 `Page`的 `MasterPageFile` 屬性的最終效果。</span><span class="sxs-lookup"><span data-stu-id="799e6-127">Setting the `MasterPageFile` attribute in the `@Page` directive has the net effect of assigning the `Page`'s `MasterPageFile` property during the Initialization stage, which is the very first stage of the page's lifecycle.</span></span> <span data-ttu-id="799e6-128">或者，我們也可以透過程式設計方式設定此屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-128">We can alternatively set this property programmatically.</span></span> <span data-ttu-id="799e6-129">不過，在 [圖 1] 中進行融合之前，必須先設定此屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-129">However, it is imperative that this property be set before the fusion in Figure 1 takes place.</span></span>

<span data-ttu-id="799e6-130">在 PreInit 階段開始時，`Page` 物件會引發其[`PreInit` 事件](https://msdn.microsoft.com/library/system.web.ui.page.preinit.aspx)，並呼叫其[`OnPreInit` 方法](https://msdn.microsoft.com/library/system.web.ui.page.onpreinit.aspx)。</span><span class="sxs-lookup"><span data-stu-id="799e6-130">At the start of the PreInit stage the `Page` object raises its [`PreInit` event](https://msdn.microsoft.com/library/system.web.ui.page.preinit.aspx) and calls its [`OnPreInit` method](https://msdn.microsoft.com/library/system.web.ui.page.onpreinit.aspx).</span></span> <span data-ttu-id="799e6-131">若要以程式設計方式設定主版頁面，可以建立 `PreInit` 事件的事件處理常式，或覆寫 `OnPreInit` 方法。</span><span class="sxs-lookup"><span data-stu-id="799e6-131">To set the master page programmatically, then, we can either create an event handler for the `PreInit` event or override the `OnPreInit` method.</span></span> <span data-ttu-id="799e6-132">讓我們來看一下這兩種方法。</span><span class="sxs-lookup"><span data-stu-id="799e6-132">Let's look at both approaches.</span></span>

<span data-ttu-id="799e6-133">一開始請先開啟 `Default.aspx.vb`，即網站首頁的程式碼後置類別檔案。</span><span class="sxs-lookup"><span data-stu-id="799e6-133">Start by opening `Default.aspx.vb`, the code-behind class file for our site's homepage.</span></span> <span data-ttu-id="799e6-134">輸入下列程式碼，為頁面的 `PreInit` 事件新增事件處理常式：</span><span class="sxs-lookup"><span data-stu-id="799e6-134">Add an event handler for the page's `PreInit` event by typing in the following code:</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample2.vb)]

<span data-ttu-id="799e6-135">我們可以從這裡設定 `MasterPageFile` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-135">From here we can set the `MasterPageFile` property.</span></span> <span data-ttu-id="799e6-136">更新程式碼，讓它將 "~/Site.master" 值指派給 `MasterPageFile` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-136">Update the code so that it assigns the value "~/Site.master" to the `MasterPageFile` property.</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample3.vb)]

<span data-ttu-id="799e6-137">如果您設定中斷點並開始進行偵錯工具，您會看到每次造訪 `Default.aspx` 頁面時，或每當有回傳此頁面時，就會執行 `Page_PreInit` 事件處理常式，並將 `MasterPageFile` 屬性指派給 "~/Site.master"。</span><span class="sxs-lookup"><span data-stu-id="799e6-137">If you set a breakpoint and start with debugging you'll see that whenever the `Default.aspx` page is visited or whenever there's a postback to this page, the `Page_PreInit` event handler executes and the `MasterPageFile` property is assigned to "~/Site.master".</span></span>

<span data-ttu-id="799e6-138">或者，您可以覆寫 `Page` 類別的 `OnPreInit` 方法，並在該處設定 `MasterPageFile` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-138">Alternatively, you can override the `Page` class's `OnPreInit` method and set the `MasterPageFile` property there.</span></span> <span data-ttu-id="799e6-139">在此範例中，我們不會在特定頁面中設定主版頁面，而是從 `BasePage`。</span><span class="sxs-lookup"><span data-stu-id="799e6-139">For this example, let's not set the master page in a particular page, but rather from `BasePage`.</span></span> <span data-ttu-id="799e6-140">回想一下，我們已在[*主版頁面教學課程中指定標題、中繼標記和其他 HTML 標頭，* ](specifying-the-title-meta-tags-and-other-html-headers-in-the-master-page-vb.md)以在中建立自訂基底頁面類別（`BasePage`）。</span><span class="sxs-lookup"><span data-stu-id="799e6-140">Recall that we created a custom base page class (`BasePage`) back in the [*Specifying the Title, Meta Tags, and Other HTML Headers in the Master Page*](specifying-the-title-meta-tags-and-other-html-headers-in-the-master-page-vb.md) tutorial.</span></span> <span data-ttu-id="799e6-141">目前 `BasePage` 會覆寫 `Page` 類別的 `OnLoadComplete` 方法，其中會根據網站地圖資料設定頁面的 `Title` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-141">Currently `BasePage` overrides the `Page` class's `OnLoadComplete` method, where it sets the page's `Title` property based on the site map data.</span></span> <span data-ttu-id="799e6-142">讓我們更新 `BasePage`，同時覆寫 `OnPreInit` 方法，以程式設計方式指定主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-142">Let's update `BasePage` to also override the `OnPreInit` method to programmatically specify the master page.</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample4.vb)]

<span data-ttu-id="799e6-143">因為我們的所有內容頁面都是衍生自 `BasePage`，所以它們現在會以程式設計方式指派其主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-143">Because all our content pages derive from `BasePage`, all of them now have their master page programmatically assigned.</span></span> <span data-ttu-id="799e6-144">此時，`Default.aspx.vb` 中的 `PreInit` 事件處理常式是多餘的;請隨意移除它。</span><span class="sxs-lookup"><span data-stu-id="799e6-144">At this point the `PreInit` event handler in `Default.aspx.vb` is superfluous; feel free to remove it.</span></span>

### <a name="what-about-thepagedirective"></a><span data-ttu-id="799e6-145">那麼`@Page`指示詞呢？</span><span class="sxs-lookup"><span data-stu-id="799e6-145">What About the`@Page`Directive?</span></span>

<span data-ttu-id="799e6-146">有點困惑的是，現在會在兩個地方指定內容頁的 `MasterPageFile` 屬性：以程式設計方式在 `BasePage` 類別的 `OnPreInit` 方法，以及透過每個內容頁的 `@Page` 指示詞中的 `MasterPageFile` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-146">What may be a little confusing is that the content pages' `MasterPageFile` properties are now being specified in two places: programmatically in the `BasePage` class's `OnPreInit` method as well as through the `MasterPageFile` attribute in each content page's `@Page` directive.</span></span>

<span data-ttu-id="799e6-147">頁面生命週期中的第一個階段是初始化階段。</span><span class="sxs-lookup"><span data-stu-id="799e6-147">The first stage in the page lifecycle is the Initialization stage.</span></span> <span data-ttu-id="799e6-148">在此階段中，`Page` 物件的 `MasterPageFile` 屬性會被指派 `@Page` 指示詞中 `MasterPageFile` 屬性的值（如果有提供的話）。</span><span class="sxs-lookup"><span data-stu-id="799e6-148">During this stage the `Page` object's `MasterPageFile` property is assigned the value of the `MasterPageFile` attribute in the `@Page` directive (if it is provided).</span></span> <span data-ttu-id="799e6-149">PreInit 階段會遵循初始化階段，而在此，我們會以程式設計方式設定 `Page` 物件的 `MasterPageFile` 屬性，進而覆寫從 `@Page` 指示詞指派的值。</span><span class="sxs-lookup"><span data-stu-id="799e6-149">The PreInit stage follows the Initialization stage, and it is here where we programmatically set the `Page` object's `MasterPageFile` property, thereby overwriting the value assigned from the `@Page` directive.</span></span> <span data-ttu-id="799e6-150">因為我們要以程式設計方式設定 `Page` 物件的 `MasterPageFile` 屬性，所以我們可以從 `@Page` 指示詞移除 `MasterPageFile` 屬性，而不會影響使用者的經驗。</span><span class="sxs-lookup"><span data-stu-id="799e6-150">Because we are setting the `Page` object's `MasterPageFile` property programmatically, we could remove the `MasterPageFile` attribute from the `@Page` directive without affecting the end user's experience.</span></span> <span data-ttu-id="799e6-151">為了說服這一點，請繼續並從 `Default.aspx` 的 `@Page` 指示詞中移除 `MasterPageFile` 屬性，然後透過瀏覽器造訪頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-151">To convince yourself of this, go ahead and remove the `MasterPageFile` attribute from the `@Page` directive in `Default.aspx` and then visit the page through a browser.</span></span> <span data-ttu-id="799e6-152">如您所預期，輸出與移除屬性之前相同。</span><span class="sxs-lookup"><span data-stu-id="799e6-152">As you would expect, the output is the same as before the attribute was removed.</span></span>

<span data-ttu-id="799e6-153">`MasterPageFile` 屬性是透過 `@Page` 指示詞還是以程式設計方式設定，會不重要至使用者的體驗。</span><span class="sxs-lookup"><span data-stu-id="799e6-153">Whether the `MasterPageFile` property is set via the `@Page` directive or programmatically is inconsequential to the end user's experience.</span></span> <span data-ttu-id="799e6-154">不過，在設計階段期間，Visual Studio 會使用 `@Page` 指示詞中的 `MasterPageFile` 屬性，在設計工具中產生 WYSIWYG 視圖。</span><span class="sxs-lookup"><span data-stu-id="799e6-154">However, the `MasterPageFile` attribute in the `@Page` directive is used by Visual Studio during design-time to produce the WYSIWYG view in the Designer.</span></span> <span data-ttu-id="799e6-155">如果您在 Visual Studio 中返回 `Default.aspx` 並流覽至設計工具，您會看到訊息：「主版分頁錯誤 . 頁面上有需要主版頁面參考的控制項，但未指定任何內容」（請參閱 [圖 2]）。</span><span class="sxs-lookup"><span data-stu-id="799e6-155">If you return to `Default.aspx` in Visual Studio and navigate to the Designer you'll see the message, "Master Page error: The page has controls that require a Master Page reference, but none is specified" (see Figure 2).</span></span>

<span data-ttu-id="799e6-156">簡言之，您必須將 `MasterPageFile` 屬性保留在 `@Page` 指示詞中，以在 Visual Studio 中享有豐富的設計階段體驗。</span><span class="sxs-lookup"><span data-stu-id="799e6-156">In short, you need to leave the `MasterPageFile` attribute in the `@Page` directive to enjoy a rich design-time experience in Visual Studio.</span></span>

<span data-ttu-id="799e6-157">[![Visual Studio 使用 @Page 指示詞的 MasterPageFile 屬性來轉譯設計檢視](specifying-the-master-page-programmatically-vb/_static/image5.png)](specifying-the-master-page-programmatically-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="799e6-157">[![Visual Studio Uses the @Page Directive's MasterPageFile Attribute to Render the Design View](specifying-the-master-page-programmatically-vb/_static/image5.png)](specifying-the-master-page-programmatically-vb/_static/image4.png)</span></span>

<span data-ttu-id="799e6-158">**圖 02**： Visual Studio 使用 `@Page` 指示詞的 `MasterPageFile` 屬性來轉譯設計檢視（[按一下以觀看完整大小的影像](specifying-the-master-page-programmatically-vb/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="799e6-158">**Figure 02**: Visual Studio Uses the `@Page` Directive's `MasterPageFile` Attribute to Render the Design View  ([Click to view full-size image](specifying-the-master-page-programmatically-vb/_static/image6.png))</span></span>

## <a name="step-3-creating-an-alternative-master-page"></a><span data-ttu-id="799e6-159">步驟3：建立替代的主版頁面</span><span class="sxs-lookup"><span data-stu-id="799e6-159">Step 3: Creating an Alternative Master Page</span></span>

<span data-ttu-id="799e6-160">因為內容頁的主版頁面可在執行時間以程式設計方式設定，所以可以根據某些外部準則動態載入特定的主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-160">Because a content page's master page can be set programmatically at runtime it's possible to dynamically load a particular master page based on some external criteria.</span></span> <span data-ttu-id="799e6-161">當網站的版面配置需要根據使用者而有所不同時，這項功能就很有用。</span><span class="sxs-lookup"><span data-stu-id="799e6-161">This functionality can be useful in situations where the site's layout needs to vary based on the user.</span></span> <span data-ttu-id="799e6-162">比方說，blog engine web 應用程式可能會允許其使用者選擇其 blog 的版面配置，其中每個版面配置都與不同的主版頁面相關聯。</span><span class="sxs-lookup"><span data-stu-id="799e6-162">For instance, a blog engine web application may allow its users to choose a layout for their blog, where each layout is associated with a different master page.</span></span> <span data-ttu-id="799e6-163">在執行時間，當訪客正在觀看使用者的 blog 時，web 應用程式就必須判斷 blog 的版面配置，並以動態方式將對應的主版頁面與內容頁面產生關聯。</span><span class="sxs-lookup"><span data-stu-id="799e6-163">At runtime, when a visitor is viewing a user's blog, the web application would need to determine the blog's layout and dynamically associate the corresponding master page with the content page.</span></span>

<span data-ttu-id="799e6-164">讓我們檢查如何根據某些外部準則，在執行時間動態載入主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-164">Let's examine how to dynamically load a master page at runtime based on some external criteria.</span></span> <span data-ttu-id="799e6-165">我們的網站目前僅包含一個主版頁面（`Site.master`）。</span><span class="sxs-lookup"><span data-stu-id="799e6-165">Our website currently contains just one master page (`Site.master`).</span></span> <span data-ttu-id="799e6-166">我們需要另一個主版頁面，說明如何在執行時間選擇主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-166">We need another master page to illustrate choosing a master page at runtime.</span></span> <span data-ttu-id="799e6-167">此步驟著重于建立和設定新的主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-167">This step focuses on creating and configuring the new master page.</span></span> <span data-ttu-id="799e6-168">步驟4探討如何判斷要在執行時間使用的主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-168">Step 4 looks at determining what master page to use at runtime.</span></span>

<span data-ttu-id="799e6-169">在名為 `Alternate.master`的根資料夾中建立新的主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-169">Create a new master page in the root folder named `Alternate.master`.</span></span> <span data-ttu-id="799e6-170">此外，將新的樣式表單加入至名為 `AlternateStyles.css`的網站。</span><span class="sxs-lookup"><span data-stu-id="799e6-170">Also add a new style sheet to the website named `AlternateStyles.css`.</span></span>

<span data-ttu-id="799e6-171">[![將另一個主版頁面和 CSS 檔案新增至網站](specifying-the-master-page-programmatically-vb/_static/image8.png)](specifying-the-master-page-programmatically-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="799e6-171">[![Add Another Master Page and CSS File to the Website](specifying-the-master-page-programmatically-vb/_static/image8.png)](specifying-the-master-page-programmatically-vb/_static/image7.png)</span></span>

<span data-ttu-id="799e6-172">**圖 03**：將另一個主版頁面和 CSS 檔案新增至網站（[按一下以觀看完整大小的影像](specifying-the-master-page-programmatically-vb/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="799e6-172">**Figure 03**: Add Another Master Page and CSS File to the Website  ([Click to view full-size image](specifying-the-master-page-programmatically-vb/_static/image9.png))</span></span>

<span data-ttu-id="799e6-173">我設計了 `Alternate.master` 主版頁面，讓標題顯示在頁面頂端，置中和海軍藍背景。</span><span class="sxs-lookup"><span data-stu-id="799e6-173">I've designed the `Alternate.master` master page to have the title displayed at the top of the page, centered and on a navy background.</span></span> <span data-ttu-id="799e6-174">我已分配左欄，並將該內容移至 `MainContent` ContentPlaceHolder 控制項底下，這現在會跨越整個頁面寬度。</span><span class="sxs-lookup"><span data-stu-id="799e6-174">I've dispensed of the left column and moved that content beneath the `MainContent` ContentPlaceHolder control, which now spans the entire width of the page.</span></span> <span data-ttu-id="799e6-175">此外，我 nixed 了未排序的課程清單，並將其取代為上方的水準清單 `MainContent`。</span><span class="sxs-lookup"><span data-stu-id="799e6-175">Furthermore, I nixed the unordered Lessons list and replaced it with a horizontal list above `MainContent`.</span></span> <span data-ttu-id="799e6-176">我也更新了主版頁面所使用的字型和色彩（以及延伸模組的內容頁面）。</span><span class="sxs-lookup"><span data-stu-id="799e6-176">I also updated the fonts and colors used by the master page (and, by extension, its content pages).</span></span> <span data-ttu-id="799e6-177">[圖 4] 顯示使用 `Alternate.master` 主版頁面時的 `Default.aspx`。</span><span class="sxs-lookup"><span data-stu-id="799e6-177">Figure 4 shows `Default.aspx` when using the `Alternate.master` master page.</span></span>

> [!NOTE]
> <span data-ttu-id="799e6-178">ASP.NET 包括定義*主題*的能力。</span><span class="sxs-lookup"><span data-stu-id="799e6-178">ASP.NET includes the ability to define *Themes*.</span></span> <span data-ttu-id="799e6-179">主題是影像、CSS 檔案和樣式相關的 Web 控制項屬性設定的集合，可在執行時間套用至頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-179">A Theme is a collection of images, CSS files, and style-related Web control property settings that can be applied to a page at runtime.</span></span> <span data-ttu-id="799e6-180">如果您的網站版面配置只有顯示的影像和其 CSS 規則不同，主題就是一種方式。</span><span class="sxs-lookup"><span data-stu-id="799e6-180">Themes are the way to go if your site's layouts differ only in the images displayed and by their CSS rules.</span></span> <span data-ttu-id="799e6-181">如果版面配置的差異較大（例如使用不同的 Web 控制項或具有完全不同的版面配置），則您必須使用個別的主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-181">If the layouts differ more substantially, such as using different Web controls or having a radically different layout, then you will need to use separate master pages.</span></span> <span data-ttu-id="799e6-182">如需主題的詳細資訊，請參閱本教學課程結尾的進一步閱讀章節。</span><span class="sxs-lookup"><span data-stu-id="799e6-182">Consult the Further Reading section at the end of this tutorial for more information on Themes.</span></span>

<span data-ttu-id="799e6-183">[![我們的內容頁面現在可以使用全新的外觀與風格](specifying-the-master-page-programmatically-vb/_static/image11.png)](specifying-the-master-page-programmatically-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="799e6-183">[![Our Content Pages Can Now Use a New Look and Feel](specifying-the-master-page-programmatically-vb/_static/image11.png)](specifying-the-master-page-programmatically-vb/_static/image10.png)</span></span>

<span data-ttu-id="799e6-184">**圖 04**：我們的內容頁面現在可以使用新的外觀和操作（[按一下以觀看完整大小的影像](specifying-the-master-page-programmatically-vb/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="799e6-184">**Figure 04**: Our Content Pages Can Now Use a New Look and Feel ([Click to view full-size image](specifying-the-master-page-programmatically-vb/_static/image12.png))</span></span>

<span data-ttu-id="799e6-185">當主要和內容頁面的標記已融合時，`MasterPage` 類別會進行檢查，以確保內容頁面中的每個內容控制項都參考主版頁面中的 ContentPlaceHolder。</span><span class="sxs-lookup"><span data-stu-id="799e6-185">When the master and content pages' markup are fused, the `MasterPage` class checks to ensure that every Content control in the content page references a ContentPlaceHolder in the master page.</span></span> <span data-ttu-id="799e6-186">如果找到參考不存在之 ContentPlaceHolder 的內容控制項，則會擲回例外狀況（exception）。</span><span class="sxs-lookup"><span data-stu-id="799e6-186">An exception is thrown if a Content control that references a non-existent ContentPlaceHolder is found.</span></span> <span data-ttu-id="799e6-187">換句話說，指派給 [內容] 頁面的主版頁面必須具有 [內容] 頁面中每個內容控制項的 ContentPlaceHolder。</span><span class="sxs-lookup"><span data-stu-id="799e6-187">In other words, it is imperative that the master page being assigned to the content page have a ContentPlaceHolder for each Content control in the content page.</span></span>

<span data-ttu-id="799e6-188">`Site.master` 主版頁面包含四個 ContentPlaceHolder 控制項：</span><span class="sxs-lookup"><span data-stu-id="799e6-188">The `Site.master` master page includes four ContentPlaceHolder controls:</span></span>

- `head`
- `MainContent`
- `QuickLoginUI`
- `LeftColumnContent`

<span data-ttu-id="799e6-189">網站中的部分內容頁面只包含一個或兩個內容控制項;其他則包含每個可用 ContentPlaceHolders 的內容控制項。</span><span class="sxs-lookup"><span data-stu-id="799e6-189">Some of the content pages in our website include just one or two Content controls; others include a Content control for each of the available ContentPlaceHolders.</span></span> <span data-ttu-id="799e6-190">如果我們的新主版頁面（`Alternate.master`）可能會指派給具有 `Site.master` 中所有 ContentPlaceHolders 之內容控制項的內容頁面，`Alternate.master` 也必須包含與 `Site.master`相同的 ContentPlaceHolder 控制項。</span><span class="sxs-lookup"><span data-stu-id="799e6-190">If our new master page (`Alternate.master`) may ever be assigned to those content pages that have Content controls for all of the ContentPlaceHolders in `Site.master` then it is essential that `Alternate.master` also include the same ContentPlaceHolder controls as `Site.master`.</span></span>

<span data-ttu-id="799e6-191">若要讓您的 `Alternate.master` 主版頁面看起來像我一樣（請參閱 [圖 4]），請從在 `AlternateStyles.css` 樣式表單中定義主版頁面的樣式開始。</span><span class="sxs-lookup"><span data-stu-id="799e6-191">To get your `Alternate.master` master page to look similar to mine (see Figure 4), start by defining the master page's styles in the `AlternateStyles.css` style sheet.</span></span> <span data-ttu-id="799e6-192">將下列規則新增至 `AlternateStyles.css`：</span><span class="sxs-lookup"><span data-stu-id="799e6-192">Add the following rules into `AlternateStyles.css`:</span></span>

[!code-css[Main](specifying-the-master-page-programmatically-vb/samples/sample5.css)]

<span data-ttu-id="799e6-193">接下來，將下列宣告式標記新增至 `Alternate.master`。</span><span class="sxs-lookup"><span data-stu-id="799e6-193">Next, add the following declarative markup to `Alternate.master`.</span></span> <span data-ttu-id="799e6-194">如您所見，`Alternate.master` 包含四個 ContentPlaceHolder 控制項，其 `ID` 值與 `Site.master`中的 ContentPlaceHolder 控制項相同。</span><span class="sxs-lookup"><span data-stu-id="799e6-194">As you can see, `Alternate.master` contains four ContentPlaceHolder controls with the same `ID` values as the ContentPlaceHolder controls in `Site.master`.</span></span> <span data-ttu-id="799e6-195">此外，它還包含 ScriptManager 控制項，這是我們的網站中使用 ASP.NET AJAX 架構的網頁所需的。</span><span class="sxs-lookup"><span data-stu-id="799e6-195">Moreover, it includes a ScriptManager control, which is necessary for those pages in our website that use the ASP.NET AJAX framework.</span></span>

[!code-aspx[Main](specifying-the-master-page-programmatically-vb/samples/sample6.aspx)]

### <a name="testing-the-new-master-page"></a><span data-ttu-id="799e6-196">測試新的主版頁面</span><span class="sxs-lookup"><span data-stu-id="799e6-196">Testing the New Master Page</span></span>

<span data-ttu-id="799e6-197">若要測試這個新的主版頁面，請更新 `BasePage` 類別的 `OnPreInit` 方法，以便將值指派給 `MasterPageFile` 屬性 `"~/Alternate.maser"` 然後流覽網站。</span><span class="sxs-lookup"><span data-stu-id="799e6-197">To test this new master page update the `BasePage` class's `OnPreInit` method so that the `MasterPageFile` property is assigned the value `"~/Alternate.maser"` and then visit the website.</span></span> <span data-ttu-id="799e6-198">除了2： `~/Admin/AddProduct.aspx` 和 `~/Admin/Products.aspx`以外，每個頁面都應該運作而不會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="799e6-198">Every page should function without error except for two: `~/Admin/AddProduct.aspx` and `~/Admin/Products.aspx`.</span></span> <span data-ttu-id="799e6-199">將產品加入至 DetailsView 的 `~/Admin/AddProduct.aspx` 會導致程式程式碼中的 `NullReferenceException` 嘗試設定主版頁面的 `GridMessageText` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-199">Adding a product to the DetailsView in `~/Admin/AddProduct.aspx` results in a `NullReferenceException` from the line of code that attempts to set the master page's `GridMessageText` property.</span></span> <span data-ttu-id="799e6-200">流覽 `~/Admin/Products.aspx` 在頁面載入時擲回 `InvalidCastException`，訊息為：「無法將類型 ' ASP. 替代\_master ' 的物件轉換成類型 ' ASP. site\_master '」。</span><span class="sxs-lookup"><span data-stu-id="799e6-200">When visiting `~/Admin/Products.aspx` an `InvalidCastException` is thrown on page load with the message: "Unable to cast object of type 'ASP.alternate\_master' to type 'ASP.site\_master'."</span></span>

<span data-ttu-id="799e6-201">因為 `Site.master` 程式碼後置類別包含未在 `Alternate.master`中定義的公用事件、屬性和方法，所以會發生這些錯誤。</span><span class="sxs-lookup"><span data-stu-id="799e6-201">These errors occur because the `Site.master` code-behind class includes public events, properties, and methods that are not defined in `Alternate.master`.</span></span> <span data-ttu-id="799e6-202">這兩個頁面的標記部分具有參考 `Site.master` 主版頁面的 `@MasterType` 指示詞。</span><span class="sxs-lookup"><span data-stu-id="799e6-202">The markup portion of these two pages have a `@MasterType` directive that references the `Site.master` master page.</span></span>

[!code-aspx[Main](specifying-the-master-page-programmatically-vb/samples/sample7.aspx)]

<span data-ttu-id="799e6-203">此外，DetailsView 在 `~/Admin/AddProduct.aspx` 中的 `ItemInserted` 事件處理常式包含將鬆散類型 `Page.Master` 屬性轉換為 `Site`類型物件的程式碼。</span><span class="sxs-lookup"><span data-stu-id="799e6-203">Also, the DetailsView's `ItemInserted` event handler in `~/Admin/AddProduct.aspx` includes code that casts the loosely-typed `Page.Master` property to an object of type `Site`.</span></span> <span data-ttu-id="799e6-204">`@MasterType` 指示詞（以這種方式使用）和 `ItemInserted` 事件處理常式中的轉換會將 `~/Admin/AddProduct.aspx` 和 `~/Admin/Products.aspx` 頁面緊密結合到 `Site.master` 主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-204">The `@MasterType` directive (used this way) and the cast in the `ItemInserted` event handler tightly couples the `~/Admin/AddProduct.aspx` and `~/Admin/Products.aspx` pages to the `Site.master` master page.</span></span>

<span data-ttu-id="799e6-205">若要打破這種緊密結合，我們可以讓 `Site.master` 和 `Alternate.master` 衍生自包含公用成員定義的通用基類。</span><span class="sxs-lookup"><span data-stu-id="799e6-205">To break this tight coupling we can have `Site.master` and `Alternate.master` derive from a common base class that contains definitions for the public members.</span></span> <span data-ttu-id="799e6-206">之後，我們可以更新 `@MasterType` 指示詞來參考這個通用基底型別。</span><span class="sxs-lookup"><span data-stu-id="799e6-206">Following that, we can update the `@MasterType` directive to reference this common base type.</span></span>

### <a name="creating-a-custom-base-master-page-class"></a><span data-ttu-id="799e6-207">建立自訂的基底主版頁面類別</span><span class="sxs-lookup"><span data-stu-id="799e6-207">Creating a Custom Base Master Page Class</span></span>

<span data-ttu-id="799e6-208">將新的類別檔案新增至名為 `BaseMasterPage.vb` 的 `App_Code` 資料夾中，並讓它衍生自 `System.Web.UI.MasterPage`。</span><span class="sxs-lookup"><span data-stu-id="799e6-208">Add a new class file to the `App_Code` folder named `BaseMasterPage.vb` and have it derive from `System.Web.UI.MasterPage`.</span></span> <span data-ttu-id="799e6-209">我們需要在 `BaseMasterPage`中定義 `RefreshRecentProductsGrid` 方法和 `GridMessageText` 屬性，但我們無法直接從 `Site.master` 移動它們，因為這些成員會使用 `Site.master` 主版頁面（`RecentProducts` GridView 和 `GridMessage` 標籤）特定的 Web 控制項。</span><span class="sxs-lookup"><span data-stu-id="799e6-209">We need to define the `RefreshRecentProductsGrid` method and the `GridMessageText` property in `BaseMasterPage`, but we can't simply move them there from `Site.master` because these members work with Web controls that are specific to the `Site.master` master page (the `RecentProducts` GridView and `GridMessage` Label).</span></span>

<span data-ttu-id="799e6-210">我們需要做的是設定 `BaseMasterPage`，讓這些成員定義在該處，但實際上是由 `BaseMasterPage`的衍生類別（`Site.master` 和 `Alternate.master`）所實。</span><span class="sxs-lookup"><span data-stu-id="799e6-210">What we need to do is configure `BaseMasterPage` in such a way that these members are defined there, but are actually implemented by `BaseMasterPage`'s derived classes (`Site.master` and `Alternate.master`).</span></span> <span data-ttu-id="799e6-211">將類別標示為 `MustInherit`，並將其成員標記為 `MustOverride`，即可進行這種類型的繼承。</span><span class="sxs-lookup"><span data-stu-id="799e6-211">This type of inheritance is possible by marking the class as `MustInherit` and its members as `MustOverride`.</span></span> <span data-ttu-id="799e6-212">簡單地說，將這些關鍵字新增至類別及其兩個成員，會宣佈 `BaseMasterPage` 尚未實 `RefreshRecentProductsGrid` 和 `GridMessageText`，但其衍生類別將會。</span><span class="sxs-lookup"><span data-stu-id="799e6-212">In short, adding these keywords to the class and its two members announces that `BaseMasterPage` hasn't implemented `RefreshRecentProductsGrid` and `GridMessageText`, but that its derived classes will.</span></span>

<span data-ttu-id="799e6-213">我們也需要在 `BaseMasterPage` 中定義 `PricesDoubled` 事件，並提供衍生類別引發事件的方法。</span><span class="sxs-lookup"><span data-stu-id="799e6-213">We also need to define the `PricesDoubled` event in `BaseMasterPage` and provide a means by the derived classes to raise the event.</span></span> <span data-ttu-id="799e6-214">.NET Framework 中用來協助此行為的模式，是在基類中建立公用事件，並新增名為 `OnEventName`的受保護、可覆寫方法。</span><span class="sxs-lookup"><span data-stu-id="799e6-214">The pattern used in the .NET Framework to facilitate this behavior is to create a public event in the base class and add a protected, overridable method named `OnEventName`.</span></span> <span data-ttu-id="799e6-215">然後，衍生的類別可以呼叫這個方法來引發事件，或覆寫它，以便在引發事件之前或之後立即執行程式碼。</span><span class="sxs-lookup"><span data-stu-id="799e6-215">Derived classes can then call this method to raise the event or can override it to execute code immediately before or after the event is raised.</span></span>

<span data-ttu-id="799e6-216">更新您的 `BaseMasterPage` 類別，使其包含下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="799e6-216">Update your `BaseMasterPage` class so that it contains the following code:</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample8.vb)]

<span data-ttu-id="799e6-217">接下來，移至 `Site.master` 程式碼後置類別，並讓它衍生自 `BaseMasterPage`。</span><span class="sxs-lookup"><span data-stu-id="799e6-217">Next, go to the `Site.master` code-behind class and have it derive from `BaseMasterPage`.</span></span> <span data-ttu-id="799e6-218">因為 `BaseMasterPage` 包含標示 `MustOverride` 的成員，所以必須在 `Site.master`中覆寫這些成員。</span><span class="sxs-lookup"><span data-stu-id="799e6-218">Because `BaseMasterPage` contains members marked `MustOverride` we need to override those members here in `Site.master`.</span></span> <span data-ttu-id="799e6-219">將 `Overrides` 關鍵字新增至方法和屬性定義。</span><span class="sxs-lookup"><span data-stu-id="799e6-219">Add the `Overrides` keyword to the method and property definitions.</span></span> <span data-ttu-id="799e6-220">此外，也請使用基類的 `OnPricesDoubled` 方法的呼叫，更新 `DoublePrice` 按鈕的 `Click` 事件處理常式中引發 `PricesDoubled` 事件的程式碼。</span><span class="sxs-lookup"><span data-stu-id="799e6-220">Also update the code that raises the `PricesDoubled` event in the `DoublePrice` Button's `Click` event handler with a call to the base class's `OnPricesDoubled` method.</span></span>

<span data-ttu-id="799e6-221">這些修改之後，`Site.master` 程式碼後置類別應該包含下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="799e6-221">After these modifications the `Site.master` code-behind class should contain the following code:</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample9.vb)]

<span data-ttu-id="799e6-222">我們也需要更新 `Alternate.master`的程式碼後置類別，以衍生自 `BaseMasterPage` 並覆寫兩個 `MustOverride` 的成員。</span><span class="sxs-lookup"><span data-stu-id="799e6-222">We also need to update `Alternate.master`'s code-behind class to derive from `BaseMasterPage` and override the two `MustOverride` members.</span></span> <span data-ttu-id="799e6-223">但是因為 `Alternate.master` 不包含會列出最新產品的 GridView，或是在新產品新增至資料庫之後顯示訊息的標籤，所以這些方法不需要執行任何動作。</span><span class="sxs-lookup"><span data-stu-id="799e6-223">But because `Alternate.master` does not contain a GridView that lists the most recent products nor a Label that displays a message after a new product is added to the database, these methods do not need to do anything.</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample10.vb)]

### <a name="referencing-the-base-master-page-class"></a><span data-ttu-id="799e6-224">參考基底主版頁面類別</span><span class="sxs-lookup"><span data-stu-id="799e6-224">Referencing the Base Master Page Class</span></span>

<span data-ttu-id="799e6-225">既然我們已完成 `BaseMasterPage` 類別，並將兩個主版頁面延伸，我們的最後一個步驟是更新 `~/Admin/AddProduct.aspx`，並 `~/Admin/Products.aspx` 頁面來參考此一般類型。</span><span class="sxs-lookup"><span data-stu-id="799e6-225">Now that we have completed the `BaseMasterPage` class and have our two master pages extending it, our final step is to update the `~/Admin/AddProduct.aspx` and `~/Admin/Products.aspx` pages to refer to this common type.</span></span> <span data-ttu-id="799e6-226">從變更兩個頁面中的 `@MasterType` 指示詞開始：</span><span class="sxs-lookup"><span data-stu-id="799e6-226">Start by changing the `@MasterType` directive in both pages from:</span></span>

[!code-aspx[Main](specifying-the-master-page-programmatically-vb/samples/sample11.aspx)]

<span data-ttu-id="799e6-227">收件者：</span><span class="sxs-lookup"><span data-stu-id="799e6-227">To:</span></span>

[!code-aspx[Main](specifying-the-master-page-programmatically-vb/samples/sample12.aspx)]

<span data-ttu-id="799e6-228">`@MasterType` 屬性現在會參考基底類型（`BaseMasterPage`），而不是參考檔案路徑。</span><span class="sxs-lookup"><span data-stu-id="799e6-228">Rather than referencing a file path, the `@MasterType` property now references the base type (`BaseMasterPage`).</span></span> <span data-ttu-id="799e6-229">因此，在這兩個頁面的程式碼後置類別中使用的強型別 `Master` 屬性現在是 `BaseMasterPage` 型別（而不是型別 `Site`）。</span><span class="sxs-lookup"><span data-stu-id="799e6-229">Consequently, the strongly-typed `Master` property used in both pages' code-behind classes is now of type `BaseMasterPage` (instead of type `Site`).</span></span> <span data-ttu-id="799e6-230">有了這項變更之後，就 `~/Admin/Products.aspx`。</span><span class="sxs-lookup"><span data-stu-id="799e6-230">With this change in place revisit `~/Admin/Products.aspx`.</span></span> <span data-ttu-id="799e6-231">之前，這會導致轉型錯誤，因為頁面已設定為使用 `Alternate.master` 主版頁面，但 `@MasterType` 指示詞參考 `Site.master` 檔。</span><span class="sxs-lookup"><span data-stu-id="799e6-231">Previously, this resulted in a casting error because the page is configured to use the `Alternate.master` master page, but the `@MasterType` directive referenced the `Site.master` file.</span></span> <span data-ttu-id="799e6-232">但現在頁面會轉譯而不會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="799e6-232">But now the page renders without error.</span></span> <span data-ttu-id="799e6-233">這是因為 `Alternate.master` 主版頁面可以轉換成 `BaseMasterPage` 類型的物件（因為它會將它擴充）。</span><span class="sxs-lookup"><span data-stu-id="799e6-233">This is because the `Alternate.master` master page can be cast to an object of type `BaseMasterPage` (since it extends it).</span></span>

<span data-ttu-id="799e6-234">`~/Admin/AddProduct.aspx`需要進行一項小變更。</span><span class="sxs-lookup"><span data-stu-id="799e6-234">There's one small change that needs to be made in `~/Admin/AddProduct.aspx`.</span></span> <span data-ttu-id="799e6-235">DetailsView 控制項的 `ItemInserted` 事件處理常式會同時使用強型別的 `Master` 屬性和鬆散類型的 `Page.Master` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-235">The DetailsView control's `ItemInserted` event handler uses both the strongly-typed `Master` property and the loosely-typed `Page.Master` property.</span></span> <span data-ttu-id="799e6-236">我們已修正更新 `@MasterType` 指示詞時的強型別參考，但我們仍需要更新鬆散型別參考。</span><span class="sxs-lookup"><span data-stu-id="799e6-236">We fixed the strongly-typed reference when we updated the `@MasterType` directive, but we still need to update the loosely-typed reference.</span></span> <span data-ttu-id="799e6-237">取代下列程式程式碼：</span><span class="sxs-lookup"><span data-stu-id="799e6-237">Replace the following line of code:</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample13.vb)]

<span data-ttu-id="799e6-238">具有下列的，會將 `Page.Master` 轉換成基底類型：</span><span class="sxs-lookup"><span data-stu-id="799e6-238">With the following, which casts `Page.Master` to the base type:</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample14.vb)]

## <a name="step-4-determining-what-master-page-to-bind-to-the-content-pages"></a><span data-ttu-id="799e6-239">步驟4：決定要系結至內容頁面的主版頁面</span><span class="sxs-lookup"><span data-stu-id="799e6-239">Step 4: Determining What Master Page to Bind to the Content Pages</span></span>

<span data-ttu-id="799e6-240">我們的 `BasePage` 類別目前會在頁面生命週期的 PreInit 階段中，將所有內容頁的 `MasterPageFile` 屬性設定為硬式編碼的值。</span><span class="sxs-lookup"><span data-stu-id="799e6-240">Our `BasePage` class currently sets all content pages' `MasterPageFile` properties to a hard-coded value in the PreInit stage of the page lifecycle.</span></span> <span data-ttu-id="799e6-241">我們可以將此程式碼更新為以某個外部因素作為主版頁面的基礎。</span><span class="sxs-lookup"><span data-stu-id="799e6-241">We can update this code to base the master page on some external factor.</span></span> <span data-ttu-id="799e6-242">可能要載入的主版頁面，取決於目前登入之使用者的喜好設定。</span><span class="sxs-lookup"><span data-stu-id="799e6-242">Perhaps the master page to load depends on the preferences of the currently logged on user.</span></span> <span data-ttu-id="799e6-243">在這種情況下，我們需要在 `BasePage` 中的 `OnPreInit` 方法中撰寫程式碼，以查閱目前造訪的使用者主版頁面喜好設定。</span><span class="sxs-lookup"><span data-stu-id="799e6-243">In that case, we'd need to write code in the `OnPreInit` method in `BasePage` that looks up the currently visiting user's master page preferences.</span></span>

<span data-ttu-id="799e6-244">讓我們建立一個網頁，讓使用者選擇要使用的主版頁面-`Site.master` 或 `Alternate.master`，並將此選項儲存在會話變數中。</span><span class="sxs-lookup"><span data-stu-id="799e6-244">Let's create a web page that allows the user to choose which master page to use - `Site.master` or `Alternate.master` - and save this choice in a Session variable.</span></span> <span data-ttu-id="799e6-245">首先，在名為 `ChooseMasterPage.aspx`的根目錄中建立新的網頁。</span><span class="sxs-lookup"><span data-stu-id="799e6-245">Start by creating a new web page in the root directory named `ChooseMasterPage.aspx`.</span></span> <span data-ttu-id="799e6-246">建立此頁面（或任何其他內容頁面因而需要）時，您不需要將它系結至主版頁面，因為主版頁面是以程式設計方式在 `BasePage`中設定。</span><span class="sxs-lookup"><span data-stu-id="799e6-246">When creating this page (or any other content pages henceforth) you don't need to bind it to a master page because the master page is set programmatically in `BasePage`.</span></span> <span data-ttu-id="799e6-247">不過，如果您未將新的頁面系結至主版頁面，則新頁面的預設宣告式標記會包含主版頁面所提供的 Web 表單和其他內容。</span><span class="sxs-lookup"><span data-stu-id="799e6-247">However, if you do not bind the new page to a master page then the new page's default declarative markup contains a Web Form and other content supplied by the master page.</span></span> <span data-ttu-id="799e6-248">您必須以適當的內容控制項手動取代此標記。</span><span class="sxs-lookup"><span data-stu-id="799e6-248">You'll need to manually replace this markup with the appropriate Content controls.</span></span> <span data-ttu-id="799e6-249">基於這個理由，我發現將新的 ASP.NET 網頁系結至主版頁面更容易。</span><span class="sxs-lookup"><span data-stu-id="799e6-249">For that reason, I find it easier to bind the new ASP.NET page to a master page.</span></span>

> [!NOTE]
> <span data-ttu-id="799e6-250">由於 `Site.master` 和 `Alternate.master` 擁有一組相同的 ContentPlaceHolder 控制項，因此在您建立新的內容頁面時，您所選擇的主版頁面並不重要。</span><span class="sxs-lookup"><span data-stu-id="799e6-250">Because `Site.master` and `Alternate.master` have the same set of ContentPlaceHolder controls it doesn't matter what master page you choose when creating the new content page.</span></span> <span data-ttu-id="799e6-251">為求一致，我建議使用 `Site.master`。</span><span class="sxs-lookup"><span data-stu-id="799e6-251">For consistency, I'd suggest using `Site.master`.</span></span>

<span data-ttu-id="799e6-252">[![將新的內容頁面新增至網站](specifying-the-master-page-programmatically-vb/_static/image14.png)](specifying-the-master-page-programmatically-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="799e6-252">[![Add a New Content Page to the Website](specifying-the-master-page-programmatically-vb/_static/image14.png)](specifying-the-master-page-programmatically-vb/_static/image13.png)</span></span>

<span data-ttu-id="799e6-253">**圖 05**：將新的內容頁面新增至網站（[按一下以觀看完整大小的影像](specifying-the-master-page-programmatically-vb/_static/image15.png)）</span><span class="sxs-lookup"><span data-stu-id="799e6-253">**Figure 05**: Add a New Content Page to the Website ([Click to view full-size image](specifying-the-master-page-programmatically-vb/_static/image15.png))</span></span>

<span data-ttu-id="799e6-254">更新 `Web.sitemap` 檔案以包含此課程的專案。</span><span class="sxs-lookup"><span data-stu-id="799e6-254">Update the `Web.sitemap` file to include an entry for this lesson.</span></span> <span data-ttu-id="799e6-255">在主版頁面的 `<siteMapNode>` 下方新增下列標記，並 ASP.NET AJAX 課程：</span><span class="sxs-lookup"><span data-stu-id="799e6-255">Add the following markup beneath the `<siteMapNode>` for the Master Pages and ASP.NET AJAX lesson:</span></span>

[!code-xml[Main](specifying-the-master-page-programmatically-vb/samples/sample15.xml)]

<span data-ttu-id="799e6-256">將任何內容加入至 `ChooseMasterPage.aspx` 頁面之前，請花點時間更新頁面的程式碼後置類別，使其衍生自 `BasePage` （而不是 `System.Web.UI.Page`）。</span><span class="sxs-lookup"><span data-stu-id="799e6-256">Before adding any content to the `ChooseMasterPage.aspx` page take a moment to update the page's code-behind class so that it derives from `BasePage` (rather than `System.Web.UI.Page`).</span></span> <span data-ttu-id="799e6-257">接下來，將 DropDownList 控制項新增至頁面，將其 `ID` 屬性設為 `MasterPageChoice`，然後新增兩個 ListItems，其 `Text` 值為 "~/Site.master" 和 "~/Alternate.master"。</span><span class="sxs-lookup"><span data-stu-id="799e6-257">Next, add a DropDownList control to the page, set its `ID` property to `MasterPageChoice`, and add two ListItems with the `Text` values of "~/Site.master" and "~/Alternate.master".</span></span>

<span data-ttu-id="799e6-258">將按鈕 Web 控制項新增至頁面，並將其 `ID` 和 `Text` 屬性分別設定為 `SaveLayout` 和「儲存版面配置選擇」。</span><span class="sxs-lookup"><span data-stu-id="799e6-258">Add a Button Web control to the page and set its `ID` and `Text` properties to `SaveLayout` and "Save Layout Choice", respectively.</span></span> <span data-ttu-id="799e6-259">此時，您頁面的宣告式標記看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="799e6-259">At this point your page's declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](specifying-the-master-page-programmatically-vb/samples/sample16.aspx)]

<span data-ttu-id="799e6-260">第一次流覽頁面時，我們必須顯示使用者目前選取的主版頁面選擇。</span><span class="sxs-lookup"><span data-stu-id="799e6-260">When the page is first visited we need to display the user's currently selected master page choice.</span></span> <span data-ttu-id="799e6-261">建立 `Page_Load` 事件處理常式，並新增下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="799e6-261">Create a `Page_Load` event handler and add the following code:</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample17.vb)]

<span data-ttu-id="799e6-262">上述程式碼只會在第一頁流覽（而不是在後續回傳時）執行。</span><span class="sxs-lookup"><span data-stu-id="799e6-262">The above code executes only on the first page visit (and not on subsequent postbacks).</span></span> <span data-ttu-id="799e6-263">它會先檢查會話變數 `MyMasterPage` 是否存在。</span><span class="sxs-lookup"><span data-stu-id="799e6-263">It first checks to see if the Session variable `MyMasterPage` exists.</span></span> <span data-ttu-id="799e6-264">如果有的話，它會嘗試在 `MasterPageChoice` DropDownList 中尋找相符的檔案。</span><span class="sxs-lookup"><span data-stu-id="799e6-264">If it does, it attempts to find the matching ListItem in the `MasterPageChoice` DropDownList.</span></span> <span data-ttu-id="799e6-265">如果找到相符的符合內容，其 `Selected` 屬性會設定為 `True`。</span><span class="sxs-lookup"><span data-stu-id="799e6-265">If a matching ListItem is found, its `Selected` property is set to `True`.</span></span>

<span data-ttu-id="799e6-266">我們也需要將使用者選擇儲存到 `MyMasterPage` 會話變數的程式碼。</span><span class="sxs-lookup"><span data-stu-id="799e6-266">We also need code that saves the user's choice into the `MyMasterPage` Session variable.</span></span> <span data-ttu-id="799e6-267">為 `SaveLayout` 按鈕的 `Click` 事件建立事件處理常式，並新增下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="799e6-267">Create an event handler for the `SaveLayout` Button's `Click` event and add the following code:</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample18.vb)]

> [!NOTE]
> <span data-ttu-id="799e6-268">在回傳時，`Click` 事件處理常式執行的時間，已選取主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-268">By the time the `Click` event handler executes on postback, the master page has already been selected.</span></span> <span data-ttu-id="799e6-269">因此，在下一頁流覽之前，使用者的下拉式清單選擇將不會生效。</span><span class="sxs-lookup"><span data-stu-id="799e6-269">Therefore, the user's drop-down list selection won't be in effect until the next page visit.</span></span> <span data-ttu-id="799e6-270">`Response.Redirect` 會強制瀏覽器重新要求 `ChooseMasterPage.aspx`。</span><span class="sxs-lookup"><span data-stu-id="799e6-270">The `Response.Redirect` forces the browser to re-request `ChooseMasterPage.aspx`.</span></span>

<span data-ttu-id="799e6-271">完成 [`ChooseMasterPage.aspx`] 頁面後，我們的最後一項工作是根據 `MyMasterPage` 會話變數的值，`BasePage` 指派 `MasterPageFile` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-271">With the `ChooseMasterPage.aspx` page complete, our final task is to have `BasePage` assign the `MasterPageFile` property based on the value of the `MyMasterPage` Session variable.</span></span> <span data-ttu-id="799e6-272">如果未設定會話變數，`BasePage` 預設為 `Site.master`。</span><span class="sxs-lookup"><span data-stu-id="799e6-272">If the Session variable is not set have `BasePage` default to `Site.master`.</span></span>

[!code-vb[Main](specifying-the-master-page-programmatically-vb/samples/sample19.vb)]

> [!NOTE]
> <span data-ttu-id="799e6-273">我將指派 `Page` 物件之 `MasterPageFile` 屬性的程式碼，從 `OnPreInit` 事件處理常式移至兩個不同的方法。</span><span class="sxs-lookup"><span data-stu-id="799e6-273">I moved the code that assigns the `Page` object's `MasterPageFile` property out of the `OnPreInit` event handler and into two separate methods.</span></span> <span data-ttu-id="799e6-274">第一個方法 `SetMasterPageFile`，會將 `MasterPageFile` 屬性指派給第二個方法所傳回的值，`GetMasterPageFileFromSession`。</span><span class="sxs-lookup"><span data-stu-id="799e6-274">This first method, `SetMasterPageFile`, assigns the `MasterPageFile` property to the value returned by the second method, `GetMasterPageFileFromSession`.</span></span> <span data-ttu-id="799e6-275">我標示了 `SetMasterPageFile` 方法 `Overridable` 讓擴充 `BasePage` 的未來類別可以視需要覆寫它來執行自訂邏輯。</span><span class="sxs-lookup"><span data-stu-id="799e6-275">I marked the `SetMasterPageFile` method `Overridable` so that future classes that extend `BasePage` can optionally override it to implement custom logic, if needed.</span></span> <span data-ttu-id="799e6-276">我們會在下一個教學課程中看到覆寫 `BasePage``SetMasterPageFile` 屬性的範例。</span><span class="sxs-lookup"><span data-stu-id="799e6-276">We'll see an example of overriding `BasePage`'s `SetMasterPageFile` property in the next tutorial.</span></span>

<span data-ttu-id="799e6-277">將此程式碼備妥之後，請造訪 `ChooseMasterPage.aspx` 頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-277">With this code in place, visit the `ChooseMasterPage.aspx` page.</span></span> <span data-ttu-id="799e6-278">一開始會選取 [`Site.master` 主版] 頁面（請參閱 [圖 6]），但使用者可以從下拉式清單中挑選不同的主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-278">Initially, the `Site.master` master page is selected (see Figure 6), but the user can pick a different master page from the drop-down list.</span></span>

<span data-ttu-id="799e6-279">[使用 [網站] 顯示 ![內容頁面。主要主版頁面](specifying-the-master-page-programmatically-vb/_static/image17.png)](specifying-the-master-page-programmatically-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="799e6-279">[![Content Pages are Displayed Using the Site.master Master Page](specifying-the-master-page-programmatically-vb/_static/image17.png)](specifying-the-master-page-programmatically-vb/_static/image16.png)</span></span>

<span data-ttu-id="799e6-280">**圖 06**：內容頁面會使用 `Site.master` 主版頁面顯示（[按一下以觀看完整大小的影像](specifying-the-master-page-programmatically-vb/_static/image18.png)）</span><span class="sxs-lookup"><span data-stu-id="799e6-280">**Figure 06**: Content Pages are Displayed Using the `Site.master` Master Page ([Click to view full-size image](specifying-the-master-page-programmatically-vb/_static/image18.png))</span></span>

<span data-ttu-id="799e6-281">[現在會使用 [其他] 主版頁面來顯示 ![內容頁面](specifying-the-master-page-programmatically-vb/_static/image20.png)](specifying-the-master-page-programmatically-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="799e6-281">[![Content Pages are Now Displayed Using the Alternate.master Master Page](specifying-the-master-page-programmatically-vb/_static/image20.png)](specifying-the-master-page-programmatically-vb/_static/image19.png)</span></span>

<span data-ttu-id="799e6-282">**圖 07**：現在會使用 `Alternate.master` 主版頁面來顯示內容頁面（[按一下以觀看完整大小的影像](specifying-the-master-page-programmatically-vb/_static/image21.png)）</span><span class="sxs-lookup"><span data-stu-id="799e6-282">**Figure 07**: Content Pages are Now Displayed Using the `Alternate.master` Master Page ([Click to view full-size image](specifying-the-master-page-programmatically-vb/_static/image21.png))</span></span>

## <a name="summary"></a><span data-ttu-id="799e6-283">總結</span><span class="sxs-lookup"><span data-stu-id="799e6-283">Summary</span></span>

<span data-ttu-id="799e6-284">流覽內容頁時，其內容控制項會與主版頁面的 ContentPlaceHolder 控制項一起建立。</span><span class="sxs-lookup"><span data-stu-id="799e6-284">When a content page is visited, its Content controls are fused with its master page's ContentPlaceHolder controls.</span></span> <span data-ttu-id="799e6-285">[內容] 頁面的 [主版] 頁面是由 `Page` 類別的 [`MasterPageFile`] 屬性工作表示，在初始化階段期間會指派給 `@Page` 指示詞的 `MasterPageFile` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-285">The content page's master page is denoted by the `Page` class's `MasterPageFile` property, which is assigned to the `@Page` directive's `MasterPageFile` attribute during the Initialization stage.</span></span> <span data-ttu-id="799e6-286">如本教學課程所示，只要在 PreInit 階段結束之前，我們就可以將值指派給 `MasterPageFile` 屬性。</span><span class="sxs-lookup"><span data-stu-id="799e6-286">As this tutorial showed, we can assign a value to the `MasterPageFile` property as long as we do so before the end of the PreInit stage.</span></span> <span data-ttu-id="799e6-287">能夠以程式設計方式指定主版頁面，可為更先進的案例開啟門，例如根據外部因素動態地將內容頁系結至主版頁面。</span><span class="sxs-lookup"><span data-stu-id="799e6-287">Being able to programmatically specify the master page opens the door for more advanced scenarios, such as dynamically binding a content page to a master page based on external factors.</span></span>

<span data-ttu-id="799e6-288">快樂的程式設計！</span><span class="sxs-lookup"><span data-stu-id="799e6-288">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="799e6-289">進一步閱讀</span><span class="sxs-lookup"><span data-stu-id="799e6-289">Further Reading</span></span>

<span data-ttu-id="799e6-290">如需本教學課程中所討論之主題的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="799e6-290">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="799e6-291">ASP.NET 網頁生命週期圖表</span><span class="sxs-lookup"><span data-stu-id="799e6-291">ASP.NET Page Lifecycle Diagram</span></span>](http://emanish.googlepages.com/Asp.Net2.0Lifecycle.PNG)
- [<span data-ttu-id="799e6-292">ASP.NET 網頁生命週期總覽</span><span class="sxs-lookup"><span data-stu-id="799e6-292">ASP.NET Page Lifecycle Overview</span></span>](https://msdn.microsoft.com/library/ms178472.aspx)
- [<span data-ttu-id="799e6-293">ASP.NET 主題和外觀總覽</span><span class="sxs-lookup"><span data-stu-id="799e6-293">ASP.NET Themes and Skins Overview</span></span>](https://msdn.microsoft.com/library/ykzx33wh.aspx)
- [<span data-ttu-id="799e6-294">主版頁面：秘訣、訣竅和陷阱</span><span class="sxs-lookup"><span data-stu-id="799e6-294">Master Pages: Tips, Tricks, and Traps</span></span>](http://www.odetocode.com/articles/450.aspx)
- [<span data-ttu-id="799e6-295">ASP.NET 中的主題</span><span class="sxs-lookup"><span data-stu-id="799e6-295">Themes in ASP.NET</span></span>](http://www.odetocode.com/articles/423.aspx)

### <a name="about-the-author"></a><span data-ttu-id="799e6-296">關於作者</span><span class="sxs-lookup"><span data-stu-id="799e6-296">About the Author</span></span>

<span data-ttu-id="799e6-297">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，自1998起，有多個 ASP/ASP. NET 書籍和創辦人的4GuysFromRolla.com。</span><span class="sxs-lookup"><span data-stu-id="799e6-297">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="799e6-298">Scott 以獨立的顧問、訓練員和作者的身分運作。</span><span class="sxs-lookup"><span data-stu-id="799e6-298">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="799e6-299">他的最新著作是[*在24小時內讓自己的 ASP.NET 3.5*](https://www.amazon.com/exec/obidos/ASIN/0672329972/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="799e6-299">His latest book is [*Sams Teach Yourself ASP.NET 3.5 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672329972/4guysfromrollaco).</span></span> <span data-ttu-id="799e6-300">Scott 可以在[mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)或透過他在[http://ScottOnWriting.NET](http://scottonwriting.net/)的 blog。</span><span class="sxs-lookup"><span data-stu-id="799e6-300">Scott can be reached at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="799e6-301">特別感謝</span><span class="sxs-lookup"><span data-stu-id="799e6-301">Special Thanks To</span></span>

<span data-ttu-id="799e6-302">本教學課程系列已由許多有用的審核者所審查。</span><span class="sxs-lookup"><span data-stu-id="799e6-302">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="799e6-303">本教學課程的領導審查者為 Suchi Banerjee。</span><span class="sxs-lookup"><span data-stu-id="799e6-303">Lead reviewer for this tutorial was Suchi Banerjee.</span></span> <span data-ttu-id="799e6-304">有興趣複習我即將發行的 MSDN 文章嗎？</span><span class="sxs-lookup"><span data-stu-id="799e6-304">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="799e6-305">若是如此，請在[mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)下拉一行</span><span class="sxs-lookup"><span data-stu-id="799e6-305">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="799e6-306">[上一頁](master-pages-and-asp-net-ajax-vb.md)
> [下一頁](nested-master-pages-vb.md)</span><span class="sxs-lookup"><span data-stu-id="799e6-306">[Previous](master-pages-and-asp-net-ajax-vb.md)
[Next](nested-master-pages-vb.md)</span></span>
