---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-cs
title: 處理未處理的C#例外狀況（） |Microsoft Docs
author: rick-anderson
description: 當生產環境中的 web 應用程式發生執行階段錯誤時，請務必通知開發人員並記錄錯誤，讓它可以在 la 中進行診斷 。
ms.author: riande
ms.date: 06/09/2009
ms.assetid: 5bc1afd5-2484-4528-b158-ab218ba150e8
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-cs
msc.type: authoredcontent
ms.openlocfilehash: 27d827238d944f86cd913d2b8ecd12729b99f391
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78629266"
---
# <a name="processing-unhandled-exceptions-c"></a><span data-ttu-id="3f980-103">處理未處理的例外狀況 (C#)</span><span class="sxs-lookup"><span data-stu-id="3f980-103">Processing Unhandled Exceptions (C#)</span></span>

<span data-ttu-id="3f980-104">由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="3f980-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="3f980-105">[檢視或下載範例程式碼](https://github.com/dotnet/AspNetDocs/tree/master/aspnet/web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-cs/samples) \(英文\) ([如何下載](/aspnet/core/tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="3f980-105">[View or download sample code](https://github.com/dotnet/AspNetDocs/tree/master/aspnet/web-forms/overview/older-versions-getting-started/deploying-web-site-projects/processing-unhandled-exceptions-cs/samples) ([how to download](/aspnet/core/tutorials/index#how-to-download-a-sample))</span></span>

> <span data-ttu-id="3f980-106">當生產環境中的 web 應用程式發生執行階段錯誤時，請務必通知開發人員並記錄錯誤，以便在稍後的時間點進行診斷。</span><span class="sxs-lookup"><span data-stu-id="3f980-106">When a runtime error occurs on a web application in production it is important to notify a developer and to log the error so that it may be diagnosed at a later point in time.</span></span> <span data-ttu-id="3f980-107">本教學課程概述 ASP.NET 如何處理執行時間錯誤，並查看在未處理的例外狀況反升至 ASP.NET 執行時間時執行自訂程式碼的一種方式。</span><span class="sxs-lookup"><span data-stu-id="3f980-107">This tutorial provides an overview of how ASP.NET processes runtime errors and looks at one way to have custom code execute whenever an unhandled exception bubbles up to the ASP.NET runtime.</span></span>

## <a name="introduction"></a><span data-ttu-id="3f980-108">簡介</span><span class="sxs-lookup"><span data-stu-id="3f980-108">Introduction</span></span>

<span data-ttu-id="3f980-109">當 ASP.NET 應用程式中發生未處理的例外狀況時，它會向上冒泡至 ASP.NET 執行時間，這會引發 `Error` 事件並顯示適當的錯誤頁面。</span><span class="sxs-lookup"><span data-stu-id="3f980-109">When an unhandled exception occurs in an ASP.NET application, it bubbles up to the ASP.NET runtime, which raises the `Error` event and displays the appropriate error page.</span></span> <span data-ttu-id="3f980-110">有三種不同類型的錯誤頁面：執行階段錯誤的黃色畫面（YSOD）;例外狀況詳細資料 YSOD;和自訂錯誤網頁。</span><span class="sxs-lookup"><span data-stu-id="3f980-110">There are three different types of error pages: the Runtime Error Yellow Screen of Death (YSOD); the Exception Details YSOD; and custom error pages.</span></span> <span data-ttu-id="3f980-111">在[先前的教學](displaying-a-custom-error-page-cs.md)課程中，我們已將應用程式設定為使用遠端使用者的自訂錯誤頁面，並針對使用者造訪本機的例外狀況詳細資料 YSOD。</span><span class="sxs-lookup"><span data-stu-id="3f980-111">In the [preceding tutorial](displaying-a-custom-error-page-cs.md) we configured the application to use a custom error page for remote users and the Exception Details YSOD for users visiting locally.</span></span>

<span data-ttu-id="3f980-112">慣用的自訂錯誤頁面若符合網站的外觀與風格，會偏好使用預設的執行階段錯誤 YSOD，但是顯示自訂錯誤頁面只是完整錯誤處理解決方案的一部分。</span><span class="sxs-lookup"><span data-stu-id="3f980-112">Using a human-friendly custom error page that matches the look and feel of the site is preferred to the default Runtime Error YSOD, but displaying a custom error page is only one part of a comprehensive error handling solution.</span></span> <span data-ttu-id="3f980-113">當應用程式在生產環境中發生錯誤時，請務必讓開發人員收到錯誤的通知，以便他們可以發現例外狀況的原因並加以解決。</span><span class="sxs-lookup"><span data-stu-id="3f980-113">When an error occurs in an application in production, it is important that the developers are notified of the error so that they can unearth the cause of the exception and address it.</span></span> <span data-ttu-id="3f980-114">此外，也應該記錄錯誤的詳細資料，以便在稍後的時間點檢查並診斷錯誤。</span><span class="sxs-lookup"><span data-stu-id="3f980-114">Furthermore, the error's details should be logged so that the error can be examined and diagnosed at a later point in time.</span></span>

<span data-ttu-id="3f980-115">本教學課程會示範如何存取未處理之例外狀況的詳細資料，以便記錄它們和開發人員通知。</span><span class="sxs-lookup"><span data-stu-id="3f980-115">This tutorial shows how to access the details of an unhandled exception so that they can be logged and a developer notified.</span></span> <span data-ttu-id="3f980-116">之後的兩個教學課程會探索錯誤記錄程式庫，在設定之後，會自動通知開發人員發生執行階段錯誤，並記錄其詳細資料。</span><span class="sxs-lookup"><span data-stu-id="3f980-116">The two tutorials following this one explore error logging libraries that, after a bit of configuration, will automatically notify developers of runtime errors and log their details.</span></span>

> [!NOTE]
> <span data-ttu-id="3f980-117">如果您需要以一些獨特或自訂的方式處理未處理的例外狀況，本教學課程中所檢查的資訊最有用。</span><span class="sxs-lookup"><span data-stu-id="3f980-117">The information examined in this tutorial is most useful if you need to process unhandled exceptions in some unique or customized manner.</span></span> <span data-ttu-id="3f980-118">在您只需要記錄例外狀況並通知開發人員的情況下，使用錯誤記錄程式庫是一種方式。</span><span class="sxs-lookup"><span data-stu-id="3f980-118">In cases where you only need to log the exception and notify a developer, using an error logging library is the way to go.</span></span> <span data-ttu-id="3f980-119">接下來的兩個教學課程提供兩個這類程式庫的總覽。</span><span class="sxs-lookup"><span data-stu-id="3f980-119">The next two tutorials provide an overview of two such libraries.</span></span>

## <a name="executing-code-when-theerrorevent-is-raised"></a><span data-ttu-id="3f980-120">在引發`Error`事件時執行程式碼</span><span class="sxs-lookup"><span data-stu-id="3f980-120">Executing Code When The`Error`Event Is Raised</span></span>

<span data-ttu-id="3f980-121">事件為物件提供了一種機制，可表示有問題發生，以及另一個物件在回應中執行程式碼。</span><span class="sxs-lookup"><span data-stu-id="3f980-121">Events provide an object a mechanism for signaling that something interesting has occurred, and for another object to execute code in response.</span></span> <span data-ttu-id="3f980-122">身為 ASP.NET 的開發人員，您習慣以事件的角度思考。</span><span class="sxs-lookup"><span data-stu-id="3f980-122">As an ASP.NET developer you are accustomed to thinking in terms of events.</span></span> <span data-ttu-id="3f980-123">如果您想要在訪客按一下特定按鈕時執行一些程式碼，您可以為該按鈕的 `Click` 事件建立事件處理常式，並將您的程式碼放在該處。</span><span class="sxs-lookup"><span data-stu-id="3f980-123">If you want to run some code when the visitor clicks a particular Button, you create an event handler for that Button's `Click` event and put your code there.</span></span> <span data-ttu-id="3f980-124">假設 ASP.NET 執行時間會在發生未處理的例外狀況時引發它的[`Error` 事件](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx)，它會遵循記錄錯誤詳細資料的程式碼會進入事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="3f980-124">Given that the ASP.NET runtime raises its [`Error` event](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx) whenever an unhandled exception occurs, it follows that the code for logging the error's details would go in an event handler.</span></span> <span data-ttu-id="3f980-125">但是，您要如何建立 `Error` 事件的事件處理常式？</span><span class="sxs-lookup"><span data-stu-id="3f980-125">But how do you create an event handler for the `Error` event?</span></span>

<span data-ttu-id="3f980-126">`Error` 事件是[`HttpApplication` 類別](https://msdn.microsoft.com/library/system.web.httpapplication.aspx)中，在要求的存留期期間，于 HTTP 管線的特定階段引發的許多事件之一。</span><span class="sxs-lookup"><span data-stu-id="3f980-126">The `Error` event is one of many events in the [`HttpApplication` class](https://msdn.microsoft.com/library/system.web.httpapplication.aspx) that are raised at certain stages in the HTTP pipeline during the lifetime of a request.</span></span> <span data-ttu-id="3f980-127">例如，`HttpApplication` 類別的[`BeginRequest` 事件](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx)會在每個要求開始時引發;當安全性模組識別出要求者時，就會引發它的[`AuthenticateRequest` 事件](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx)。</span><span class="sxs-lookup"><span data-stu-id="3f980-127">For example, the `HttpApplication` class's [`BeginRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx) is raised at the start of every request; its [`AuthenticateRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) is raised when a security module has identified the requestor.</span></span> <span data-ttu-id="3f980-128">這些 `HttpApplication` 事件可讓網頁開發人員在要求的存留期內，于不同的時間點執行自訂邏輯。</span><span class="sxs-lookup"><span data-stu-id="3f980-128">These `HttpApplication` events give the page developer a means to execute custom logic at the various points in the lifetime of a request.</span></span>

<span data-ttu-id="3f980-129">`HttpApplication` 事件的事件處理常式可以放在名為 `Global.asax`的特殊檔案中。</span><span class="sxs-lookup"><span data-stu-id="3f980-129">Event handlers for the `HttpApplication` events can be placed in a special file named `Global.asax`.</span></span> <span data-ttu-id="3f980-130">若要在您的網站中建立此檔案，請使用全域應用程式類別範本，將新專案新增至您網站的根目錄，其名稱為 `Global.asax`。</span><span class="sxs-lookup"><span data-stu-id="3f980-130">To create this file in your website, add a new item to the root of your website using the Global Application Class template with the name `Global.asax`.</span></span>

[![](processing-unhandled-exceptions-cs/_static/image2.png)](processing-unhandled-exceptions-cs/_static/image1.png)

<span data-ttu-id="3f980-131">**圖 1**：將 `Global.asax` 新增至您的 Web 應用程式</span><span class="sxs-lookup"><span data-stu-id="3f980-131">**Figure 1**: Add `Global.asax` To Your Web Application</span></span>  
<span data-ttu-id="3f980-132">（[按一下以查看完整大小的影像](processing-unhandled-exceptions-cs/_static/image3.png)）</span><span class="sxs-lookup"><span data-stu-id="3f980-132">([Click to view full-size image](processing-unhandled-exceptions-cs/_static/image3.png))</span></span>

<span data-ttu-id="3f980-133">根據您使用的是 Web 應用程式專案（WAP）還是網站專案（WSP），Visual Studio 所建立之 `Global.asax` 檔案的內容和結構會稍有不同。</span><span class="sxs-lookup"><span data-stu-id="3f980-133">The contents and structure of the `Global.asax` file created by Visual Studio differ slightly based on whether you are using a Web Application Project (WAP) or Web Site Project (WSP).</span></span> <span data-ttu-id="3f980-134">使用 WAP 時，會將 `Global.asax` 實作為兩個不同的檔案，`Global.asax` 和 `Global.asax.cs`。</span><span class="sxs-lookup"><span data-stu-id="3f980-134">With a WAP, the `Global.asax` is implemented as two separate files - `Global.asax` and `Global.asax.cs`.</span></span> <span data-ttu-id="3f980-135">`Global.asax` 檔案只包含參考 `.cs` 檔案的 `@Application` 指示詞;感興趣的事件處理常式會定義在 `Global.asax.cs` 檔案中。</span><span class="sxs-lookup"><span data-stu-id="3f980-135">The `Global.asax` file contains nothing but an `@Application` directive that references the `.cs` file; the event handlers of interest are defined in the `Global.asax.cs` file.</span></span> <span data-ttu-id="3f980-136">針對 WSPs，只會建立一個檔案，`Global.asax`，而事件處理常式則定義于 `<script runat="server">` 區塊中。</span><span class="sxs-lookup"><span data-stu-id="3f980-136">For WSPs, only a single file is created, `Global.asax`, and the event handlers are defined in a `<script runat="server">` block.</span></span>

<span data-ttu-id="3f980-137">Visual Studio 的全域應用程式類別範本在 WAP 中建立的 `Global.asax` 檔案包含名為 `Application_BeginRequest`、`Application_AuthenticateRequest`和 `Application_Error`的事件處理常式，分別是 `HttpApplication` 事件 `BeginRequest`、`AuthenticateRequest`和 `Error`的事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="3f980-137">The `Global.asax` file created in a WAP by Visual Studio's Global Application Class template includes event handlers named `Application_BeginRequest`, `Application_AuthenticateRequest`, and `Application_Error`, which are event handlers for the `HttpApplication` events `BeginRequest`, `AuthenticateRequest`, and `Error`, respectively.</span></span> <span data-ttu-id="3f980-138">還有名為 `Application_Start`、`Session_Start`、`Application_End`和 `Session_End`的事件處理常式，這些事件處理常式會在 web 應用程式啟動、新會話啟動時、應用程式結束時，以及會話結束時引發。</span><span class="sxs-lookup"><span data-stu-id="3f980-138">There are also event handlers named `Application_Start`, `Session_Start`, `Application_End`, and `Session_End`, which are event handlers that fire when the web application starts, when a new session starts, when the application ends, and when a session ends, respectively.</span></span> <span data-ttu-id="3f980-139">在 WSP 中建立的 `Global.asax` 檔案 Visual Studio 只包含 `Application_Error`、`Application_Start`、`Session_Start`、`Application_End`和 `Session_End` 事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="3f980-139">The `Global.asax` file created in a WSP by Visual Studio contains just the `Application_Error`, `Application_Start`, `Session_Start`, `Application_End`, and `Session_End` event handlers.</span></span>

> [!NOTE]
> <span data-ttu-id="3f980-140">部署 ASP.NET 應用程式時，您必須將 `Global.asax` 檔案複製到生產環境。</span><span class="sxs-lookup"><span data-stu-id="3f980-140">When deploying the ASP.NET application you need to copy the `Global.asax` file to the production environment.</span></span> <span data-ttu-id="3f980-141">在 WAP 中建立的 `Global.asax.cs` 檔案不需要複製到生產環境，因為此程式碼會編譯成專案的元件。</span><span class="sxs-lookup"><span data-stu-id="3f980-141">The `Global.asax.cs` file, which is created in the WAP, does not need to be copied to production because this code is compiled into the project's assembly.</span></span>

<span data-ttu-id="3f980-142">Visual Studio 的全域應用程式類別範本所建立的事件處理常式並不完整。</span><span class="sxs-lookup"><span data-stu-id="3f980-142">The event handlers created by Visual Studio's Global Application Class template are not exhaustive.</span></span> <span data-ttu-id="3f980-143">您可以藉由將事件處理常式命名為 `Application_EventName`，為任何 `HttpApplication` 事件加入事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="3f980-143">You can add an event handler for any `HttpApplication` event by naming the event handler `Application_EventName`.</span></span> <span data-ttu-id="3f980-144">例如，您可以將下列程式碼新增至 `Global.asax` 檔案，以建立[`AuthorizeRequest` 事件](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)的事件處理常式：</span><span class="sxs-lookup"><span data-stu-id="3f980-144">For example, you could add the following code to the `Global.asax` file to create an event handler for the [`AuthorizeRequest` event](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx):</span></span>

[!code-cs[Main](processing-unhandled-exceptions-cs/samples/sample1.cs)]

<span data-ttu-id="3f980-145">同樣地，您可以移除不需要的全域應用程式類別範本所建立的任何事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="3f980-145">Likewise, you can remove any event handlers created by the Global Application Class template that are not needed.</span></span> <span data-ttu-id="3f980-146">在本教學課程中，我們只需要 `Error` 事件的事件處理常式;請隨意從 `Global.asax` 檔案移除其他事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="3f980-146">For this tutorial we only require an event handler for the `Error` event; feel free to remove the other event handlers from the `Global.asax` file.</span></span>

> [!NOTE]
> <span data-ttu-id="3f980-147">*HTTP 模組*提供另一種方式來定義 `HttpApplication` 事件的事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="3f980-147">*HTTP Modules* offer another way to define event handlers for `HttpApplication` events.</span></span> <span data-ttu-id="3f980-148">HTTP 模組會建立為類別檔案，該檔案可以直接放在 web 應用程式專案內，或分成不同的類別庫。</span><span class="sxs-lookup"><span data-stu-id="3f980-148">HTTP Modules are created as a class file that can be placed directly within the web application project or separated out into a separate class library.</span></span> <span data-ttu-id="3f980-149">因為它們可以分成一個類別庫，所以 HTTP 模組提供更具彈性且可重複使用的模型，以建立 `HttpApplication` 事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="3f980-149">Because they can be separated out into a class library, HTTP Modules offer a more flexible and reusable model for creating `HttpApplication` event handlers.</span></span> <span data-ttu-id="3f980-150">雖然 `Global.asax` 檔案是它所在位置的 web 應用程式所特有，但是 HTTP 模組可以編譯成元件，此時將 HTTP 模組加入至網站，就像在 [`Bin`] 資料夾中卸載元件，然後在 `Web.config`中註冊模組一樣簡單。</span><span class="sxs-lookup"><span data-stu-id="3f980-150">Whereas the `Global.asax` file is specific to the web application where it resides, HTTP Modules can be compiled into assemblies, at which point adding the HTTP Module to a website is as simple as dropping the assembly in the `Bin` folder and registering the Module in `Web.config`.</span></span> <span data-ttu-id="3f980-151">本教學課程不會探討如何建立和使用 HTTP 模組，但下列兩個教學課程中使用的兩個錯誤記錄程式庫會實作為 HTTP 模組。</span><span class="sxs-lookup"><span data-stu-id="3f980-151">This tutorial does not look at creating and using HTTP Modules, but the two error logging libraries used in the following two tutorials are implemented as HTTP Modules.</span></span> <span data-ttu-id="3f980-152">如需 HTTP 模組優點的詳細背景，請參閱[使用 Http 模組和處理常式來建立可插入的 ASP.NET 元件](https://msdn.microsoft.com/library/aa479332.aspx)。</span><span class="sxs-lookup"><span data-stu-id="3f980-152">For more background on the benefits of HTTP Modules refer to [Using HTTP Modules and Handlers to Create Pluggable ASP.NET Components](https://msdn.microsoft.com/library/aa479332.aspx).</span></span>

## <a name="retrieving-information-about-the-unhandled-exception"></a><span data-ttu-id="3f980-153">正在抓取未處理之例外狀況的相關資訊</span><span class="sxs-lookup"><span data-stu-id="3f980-153">Retrieving Information About the Unhandled Exception</span></span>

<span data-ttu-id="3f980-154">此時，我們有一個具有 `Application_Error` 事件處理常式的 global.asax 檔案。</span><span class="sxs-lookup"><span data-stu-id="3f980-154">At this point we have a Global.asax file with an `Application_Error` event handler.</span></span> <span data-ttu-id="3f980-155">當此事件處理常式執行時，我們需要通知開發人員錯誤，並記錄其詳細資料。</span><span class="sxs-lookup"><span data-stu-id="3f980-155">When this event handler executes we need to notify a developer of the error and log its details.</span></span> <span data-ttu-id="3f980-156">為了完成這些工作，我們必須先決定所引發之例外狀況的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="3f980-156">To accomplish these tasks we first need to determine the details of the exception that was raised.</span></span> <span data-ttu-id="3f980-157">使用伺服器物件的[`GetLastError` 方法](https://msdn.microsoft.com/library/system.web.httpserverutility.getlasterror.aspx)，來抓取導致引發 `Error` 事件之未處理例外狀況的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="3f980-157">Use the Server object's [`GetLastError` method](https://msdn.microsoft.com/library/system.web.httpserverutility.getlasterror.aspx) to retrieve details of the unhandled exception that caused the `Error` event to fire.</span></span>

[!code-csharp[Main](processing-unhandled-exceptions-cs/samples/sample2.cs)]

<span data-ttu-id="3f980-158">`GetLastError` 方法會傳回 `Exception`類型的物件，這是 .NET Framework 中所有例外狀況的基底類型。</span><span class="sxs-lookup"><span data-stu-id="3f980-158">The `GetLastError` method returns an object of type `Exception`, which is the base type for all exceptions in the .NET Framework.</span></span> <span data-ttu-id="3f980-159">不過，在上述程式碼中，我會將 `GetLastError` 所傳回的例外狀況物件，轉換成 `HttpException` 物件。</span><span class="sxs-lookup"><span data-stu-id="3f980-159">However, in the code above I am casting the Exception object returned by `GetLastError` into an `HttpException` object.</span></span> <span data-ttu-id="3f980-160">如果因為 ASP.NET 資源處理期間擲回例外狀況而引發 `Error` 事件，則擲回的例外狀況會包裝在 `HttpException`內。</span><span class="sxs-lookup"><span data-stu-id="3f980-160">If the `Error` event is being fired because an exception was thrown during the processing of an ASP.NET resource then the exception that was thrown is wrapped within an `HttpException`.</span></span> <span data-ttu-id="3f980-161">若要取得促使錯誤事件的實際例外狀況，請使用 `InnerException` 屬性。</span><span class="sxs-lookup"><span data-stu-id="3f980-161">To get the actual exception that precipitated the Error event use the `InnerException` property.</span></span> <span data-ttu-id="3f980-162">如果因為 HTTP 例外狀況而引發 `Error` 事件（例如不存在的頁面要求），則會擲回 `HttpException`，但不會發生內部例外狀況。</span><span class="sxs-lookup"><span data-stu-id="3f980-162">If the `Error` event was raised because of an HTTP-based exception, such as a request for a non-existent page, an `HttpException` is thrown, but it does not have an inner exception.</span></span>

<span data-ttu-id="3f980-163">下列程式碼會使用 `GetLastErrormessage` 來抓取觸發 `Error` 事件之例外狀況的相關資訊，並將 `HttpException` 儲存在名為 `lastErrorWrapper`的變數中。</span><span class="sxs-lookup"><span data-stu-id="3f980-163">The following code uses the `GetLastErrormessage` to retrieve information about the exception that triggered the `Error` event, storing the `HttpException` in a variable named `lastErrorWrapper`.</span></span> <span data-ttu-id="3f980-164">然後，它會將原始例外狀況的類型、訊息和堆疊追蹤儲存在三個字串變數中，檢查 `lastErrorWrapper` 是否為觸發 `Error` 事件的實際例外狀況（如果是以 HTTP 為基礎的例外狀況），或者它只是處理要求時所擲回之例外狀況的包裝函式。</span><span class="sxs-lookup"><span data-stu-id="3f980-164">It then stores the type, message, and stack trace of the originating exception in three string variables, checking to see if the `lastErrorWrapper` is the actual exception that triggered the `Error` event (in the case of HTTP-based exceptions) or if it's merely a wrapper for an exception that was thrown while processing the request.</span></span>

[!code-csharp[Main](processing-unhandled-exceptions-cs/samples/sample3.cs)]

<span data-ttu-id="3f980-165">此時，您已擁有撰寫程式碼所需的所有資訊，以便將例外狀況的詳細資料記錄到資料庫資料表。</span><span class="sxs-lookup"><span data-stu-id="3f980-165">At this point you have all the information you need to write code that will log the exception's details to a database table.</span></span> <span data-ttu-id="3f980-166">您可以針對每個感利率的錯誤詳細資料，建立具有資料行的資料庫資料表-類型、訊息、堆疊追蹤等等，以及其他有用的資訊片段，例如要求的頁面 URL 和目前登入的使用者名稱。</span><span class="sxs-lookup"><span data-stu-id="3f980-166">You could create a database table with columns for each of the error details of interest - the type, the message, the stack trace, and so on - along with other useful pieces of information, such as the URL of the requested page and the name of the currently logged on user.</span></span> <span data-ttu-id="3f980-167">在 `Application_Error` 事件處理常式中，您接著會連接到資料庫，並將記錄插入資料表中。</span><span class="sxs-lookup"><span data-stu-id="3f980-167">In the `Application_Error` event handler you would then connect to the database and insert a record into the table.</span></span> <span data-ttu-id="3f980-168">同樣地，您可以加入程式碼，透過電子郵件將錯誤的開發人員警示。</span><span class="sxs-lookup"><span data-stu-id="3f980-168">Likewise, you could add code to alert a developer of the error via email.</span></span>

<span data-ttu-id="3f980-169">接下來兩個教學課程中所檢查的錯誤記錄程式庫，提供現成的功能，因此不需要自行建立此錯誤記錄和通知。</span><span class="sxs-lookup"><span data-stu-id="3f980-169">The error logging libraries examined in the next two tutorials provide such functionality out of the box, so there's no need to build this error logging and notification yourself.</span></span> <span data-ttu-id="3f980-170">不過，為了說明會引發 `Error` 事件，而且 `Application_Error` 事件處理常式可用來記錄錯誤詳細資料，並通知開發人員，讓我們新增程式碼，以在發生錯誤時通知開發人員。</span><span class="sxs-lookup"><span data-stu-id="3f980-170">However, to illustrate that the `Error` event is being raised and that the `Application_Error` event handler can be used to log error details and notify a developer, let's add code that notifies a developer when an error occurs.</span></span>

## <a name="notifying-a-developer-when-an-unhandled-exception-occurs"></a><span data-ttu-id="3f980-171">當發生未處理的例外狀況時通知開發人員</span><span class="sxs-lookup"><span data-stu-id="3f980-171">Notifying a Developer When an Unhandled Exception Occurs</span></span>

<span data-ttu-id="3f980-172">當生產環境中發生未處理的例外狀況時，請務必提醒開發小組，讓他們能夠評估錯誤，並判斷需要採取哪些動作。</span><span class="sxs-lookup"><span data-stu-id="3f980-172">When an unhandled exception occurs in the production environment it is important to alert the development team so that they can assess the error and determine what actions need to be taken.</span></span> <span data-ttu-id="3f980-173">例如，如果連線到資料庫時發生錯誤，您將需要再次檢查連接字串，或許可以向您的 web 主控公司開啟支援票證。</span><span class="sxs-lookup"><span data-stu-id="3f980-173">For example, if there is an error in connecting to the database then you'll need to double check your connection string and, perhaps, open a support ticket with your web hosting company.</span></span> <span data-ttu-id="3f980-174">如果因程式設計錯誤而發生例外狀況，可能需要新增額外的程式碼或驗證邏輯，以避免未來發生這類錯誤。</span><span class="sxs-lookup"><span data-stu-id="3f980-174">If the exception occurred because of a programming error, additional code or validation logic may need to be added to prevent such errors in the future.</span></span>

<span data-ttu-id="3f980-175">[`System.Net.Mail` 命名空間](https://msdn.microsoft.com/library/system.net.mail.aspx)中的 .NET Framework 類別，可讓您輕鬆地傳送電子郵件。</span><span class="sxs-lookup"><span data-stu-id="3f980-175">The .NET Framework classes in the [`System.Net.Mail` namespace](https://msdn.microsoft.com/library/system.net.mail.aspx) make it easy to send an email.</span></span> <span data-ttu-id="3f980-176">[`MailMessage` 類別](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx)代表電子郵件訊息，而且具有 `To`、`From`、`Subject`、`Body`和 `Attachments`等屬性。</span><span class="sxs-lookup"><span data-stu-id="3f980-176">The [`MailMessage` class](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) represents an email message and has properties like `To`, `From`, `Subject`, `Body`, and `Attachments`.</span></span> <span data-ttu-id="3f980-177">`SmtpClass` 可用來傳送使用指定 SMTP 伺服器的 `MailMessage` 物件;SMTP 伺服器設定可以用程式設計方式或在 `Web.config file`的[`<system.net>` 元素](https://msdn.microsoft.com/library/6484zdc1.aspx)中以宣告方式指定。</span><span class="sxs-lookup"><span data-stu-id="3f980-177">The `SmtpClass` is used to send a `MailMessage` object using a specified SMTP server; the SMTP server settings can be specified programmatically or declaratively in the [`<system.net>` element](https://msdn.microsoft.com/library/6484zdc1.aspx) in the `Web.config file`.</span></span> <span data-ttu-id="3f980-178">如需在 ASP.NET 應用程式中傳送電子郵件訊息的詳細資訊，請參閱我的文章：[在 ASP.NET 中傳送電子郵件](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)和[系統 .NET. Mail 常見問題](http://systemnetmail.com/)。</span><span class="sxs-lookup"><span data-stu-id="3f980-178">For more information on sending email messages in an ASP.NET application check out my article, [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx), and the [System.Net.Mail FAQ](http://systemnetmail.com/).</span></span>

> [!NOTE]
> <span data-ttu-id="3f980-179">`<system.net>` 元素包含傳送電子郵件時，`SmtpClient` 類別所使用的 SMTP 伺服器設定。</span><span class="sxs-lookup"><span data-stu-id="3f980-179">The `<system.net>` element contains the SMTP server settings used by the `SmtpClient` class when sending an email.</span></span> <span data-ttu-id="3f980-180">您的 web 主控公司可能有 SMTP 伺服器，可讓您用來從應用程式傳送電子郵件。</span><span class="sxs-lookup"><span data-stu-id="3f980-180">Your web hosting company likely has an SMTP server that you can use to send email from your application.</span></span> <span data-ttu-id="3f980-181">如需您在 web 應用程式中應使用之 SMTP 伺服器設定的詳細資訊，請參閱您的 web 主機支援一節。</span><span class="sxs-lookup"><span data-stu-id="3f980-181">Consult your web host's support section for information on the SMTP server settings you should use in your web application.</span></span>

<span data-ttu-id="3f980-182">將下列程式碼新增至 `Application_Error` 事件處理常式，以在發生錯誤時傳送電子郵件給開發人員：</span><span class="sxs-lookup"><span data-stu-id="3f980-182">Add the following code to the `Application_Error` event handler to send a developer an email when an error occurs:</span></span>

[!code-csharp[Main](processing-unhandled-exceptions-cs/samples/sample4.cs)]

<span data-ttu-id="3f980-183">雖然上述程式碼相當冗長，但大部分的程式會建立在傳送給開發人員的電子郵件中出現的 HTML。</span><span class="sxs-lookup"><span data-stu-id="3f980-183">While the above code is quite lengthy, the bulk of it creates the HTML that appears in the email sent to the developer.</span></span> <span data-ttu-id="3f980-184">程式碼一開始會參考 `GetLastError` 方法所傳回的 `HttpException` （`lastErrorWrapper`）。</span><span class="sxs-lookup"><span data-stu-id="3f980-184">The code starts by referencing the `HttpException` returned by the `GetLastError` method (`lastErrorWrapper`).</span></span> <span data-ttu-id="3f980-185">要求所引發的實際例外狀況是透過 `lastErrorWrapper.InnerException` 來抓取，並會指派給變數 `lastError`。</span><span class="sxs-lookup"><span data-stu-id="3f980-185">The actual exception that was raised by the request is retrieved via `lastErrorWrapper.InnerException` and is assigned to the variable `lastError`.</span></span> <span data-ttu-id="3f980-186">類型、訊息和堆疊追蹤資訊會從 `lastError` 取出，並儲存在三個字串變數中。</span><span class="sxs-lookup"><span data-stu-id="3f980-186">The type, message, and stack trace information is retrieved from `lastError` and stored in three string variables.</span></span>

<span data-ttu-id="3f980-187">接下來，會建立名為 `mm` 的 `MailMessage` 物件。</span><span class="sxs-lookup"><span data-stu-id="3f980-187">Next, a `MailMessage` object named `mm` is created.</span></span> <span data-ttu-id="3f980-188">電子郵件內文的格式為 HTML，並顯示要求頁面的 URL、目前登入之使用者的名稱，以及例外狀況的相關資訊（類型、訊息和堆疊追蹤）。</span><span class="sxs-lookup"><span data-stu-id="3f980-188">The email body is HTML formatted and displays the URL of the requested page, the name of the currently logged on user, and information about the exception (the type, message, and stack trace).</span></span> <span data-ttu-id="3f980-189">`HttpException` 類別的其中一項很酷的事，就是您可以藉由呼叫[GetHtmlErrorMessage 方法](https://msdn.microsoft.com/library/system.web.httpexception.gethtmlerrormessage.aspx)，產生用來建立例外狀況詳細資料（YSOD）的 HTML。</span><span class="sxs-lookup"><span data-stu-id="3f980-189">One of the cool things about the `HttpException` class is that you can generate the HTML used to create the Exception Details Yellow Screen of Death (YSOD) by calling the [GetHtmlErrorMessage method](https://msdn.microsoft.com/library/system.web.httpexception.gethtmlerrormessage.aspx).</span></span> <span data-ttu-id="3f980-190">這裡會使用這個方法來抓取例外狀況詳細資料 YSOD 標記，並將它新增至電子郵件作為附件。</span><span class="sxs-lookup"><span data-stu-id="3f980-190">This method is used here to retrieve the Exception Details YSOD markup and add it to the email as an attachment.</span></span> <span data-ttu-id="3f980-191">請注意：如果觸發 `Error` 事件的例外狀況是以 HTTP 為基礎的例外狀況（例如不存在的頁面要求），則 `GetHtmlErrorMessage` 方法會傳回 `null`。</span><span class="sxs-lookup"><span data-stu-id="3f980-191">One word of caution: if the exception that triggered the `Error` event was an HTTP-based exception (such as a request for a non-existent page) then the `GetHtmlErrorMessage` method will return `null`.</span></span>

<span data-ttu-id="3f980-192">最後一個步驟是傳送 `MailMessage`。</span><span class="sxs-lookup"><span data-stu-id="3f980-192">The final step is to send the `MailMessage`.</span></span> <span data-ttu-id="3f980-193">這是藉由建立新的 `SmtpClient` 方法並呼叫其 `Send` 方法來完成。</span><span class="sxs-lookup"><span data-stu-id="3f980-193">This is done by creating a new `SmtpClient` method and calling its `Send` method.</span></span>

> [!NOTE]
> <span data-ttu-id="3f980-194">在您的 web 應用程式中使用此程式碼之前，您會想要將 `ToAddress` 中的值和 `FromAddress` 常數從 support@example.com 變更為傳送錯誤通知電子郵件的來源電子郵件地址。</span><span class="sxs-lookup"><span data-stu-id="3f980-194">Before using this code in your web application you'll want to change the values in the `ToAddress` and `FromAddress` constants from support@example.com to whatever email address the error notification email should be sent to and originate from.</span></span> <span data-ttu-id="3f980-195">您也必須在 `Web.config`的 [`<system.net>`] 區段中指定 SMTP 伺服器設定。</span><span class="sxs-lookup"><span data-stu-id="3f980-195">You'll also need to specify SMTP server settings in the `<system.net>` section in `Web.config`.</span></span> <span data-ttu-id="3f980-196">請洽詢您的 web 主機提供者，以判斷要使用的 SMTP 伺服器設定。</span><span class="sxs-lookup"><span data-stu-id="3f980-196">Consult your web host provider to determine the SMTP server settings to use.</span></span>

<span data-ttu-id="3f980-197">當此程式碼隨時都在發生錯誤時，開發人員會傳送一封電子郵件訊息，摘要說明錯誤並包含 YSOD。</span><span class="sxs-lookup"><span data-stu-id="3f980-197">With this code in place anytime there's an error the developer is sent an email message that summarizes the error and includes the YSOD.</span></span> <span data-ttu-id="3f980-198">在先前的教學課程中，我們示範了執行時間錯誤，方法是造訪內容類型 .aspx，並透過 querystring （例如 `Genre.aspx?ID=foo`）傳入不正確 `ID` 值。</span><span class="sxs-lookup"><span data-stu-id="3f980-198">In the preceding tutorial we demonstrated a runtime error by visiting Genre.aspx and passing in an invalid `ID` value through the querystring, like `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="3f980-199">流覽含有 `Global.asax` 檔案的頁面，會產生與上一個教學課程相同的使用者體驗-在開發環境中，您將會繼續看到例外狀況詳細資料的黃色畫面，而在生產環境中，您會看到 [自訂錯誤] 頁面。</span><span class="sxs-lookup"><span data-stu-id="3f980-199">Visiting the page with the `Global.asax` file in place produces the same user experience as in the preceding tutorial - in the development environment you'll continue to see the Exception Details Yellow Screen of Death, while in the production environment you'll see the custom error page.</span></span> <span data-ttu-id="3f980-200">除了此現有的行為之外，開發人員也會傳送電子郵件。</span><span class="sxs-lookup"><span data-stu-id="3f980-200">In addition to this existing behavior, the developer is sent an email.</span></span>

<span data-ttu-id="3f980-201">[**圖 2** ] 顯示造訪 `Genre.aspx?ID=foo`時收到的電子郵件。</span><span class="sxs-lookup"><span data-stu-id="3f980-201">**Figure 2** shows the email received when visiting `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="3f980-202">[電子郵件內文] 會匯總例外狀況資訊，而 [`YSOD.htm` 附件] 會顯示 [例外狀況詳細資料] YSOD 中顯示的內容（請參閱 [**圖 3**]）。</span><span class="sxs-lookup"><span data-stu-id="3f980-202">The email body summarizes the exception information, while the `YSOD.htm` attachment displays the content that is shown in the Exception Details YSOD (see **Figure 3**).</span></span>

[![](processing-unhandled-exceptions-cs/_static/image5.png)](processing-unhandled-exceptions-cs/_static/image4.png)

<span data-ttu-id="3f980-203">**圖 2**：每當有未處理的例外狀況時，就會傳送電子郵件通知給開發人員</span><span class="sxs-lookup"><span data-stu-id="3f980-203">**Figure 2**: The Developer Is Sent An Email Notification Whenever There's An Unhandled Exception</span></span>  
<span data-ttu-id="3f980-204">（[按一下以查看完整大小的影像](processing-unhandled-exceptions-cs/_static/image6.png)）</span><span class="sxs-lookup"><span data-stu-id="3f980-204">([Click to view full-size image](processing-unhandled-exceptions-cs/_static/image6.png))</span></span>

[![](processing-unhandled-exceptions-cs/_static/image8.png)](processing-unhandled-exceptions-cs/_static/image7.png)

<span data-ttu-id="3f980-205">**圖 3**：電子郵件通知包含例外狀況詳細資料 YSOD 作為附件</span><span class="sxs-lookup"><span data-stu-id="3f980-205">**Figure 3**: The Email Notification Includes the Exception Details YSOD As An Attachment</span></span>  
<span data-ttu-id="3f980-206">（[按一下以查看完整大小的影像](processing-unhandled-exceptions-cs/_static/image9.png)）</span><span class="sxs-lookup"><span data-stu-id="3f980-206">([Click to view full-size image](processing-unhandled-exceptions-cs/_static/image9.png))</span></span>

## <a name="what-about-using-the-custom-error-page"></a><span data-ttu-id="3f980-207">使用自訂錯誤網頁呢？</span><span class="sxs-lookup"><span data-stu-id="3f980-207">What About Using the Custom Error Page?</span></span>

<span data-ttu-id="3f980-208">本教學課程示範如何使用 `Global.asax` 和 `Application_Error` 事件處理常式，在發生未處理的例外狀況時執行程式碼。</span><span class="sxs-lookup"><span data-stu-id="3f980-208">This tutorial showed how to use `Global.asax` and the `Application_Error` event handler to execute code when an unhandled exception occurs.</span></span> <span data-ttu-id="3f980-209">具體而言，我們使用這個事件處理常式來通知開發人員發生錯誤;我們可以將它延伸，以便在資料庫中記錄錯誤詳細資料。</span><span class="sxs-lookup"><span data-stu-id="3f980-209">Specifically, we used this event handler to notify a developer of an error; we could extend it to also log the error details in a database.</span></span> <span data-ttu-id="3f980-210">`Application_Error` 事件處理常式的存在並不會影響使用者的體驗。</span><span class="sxs-lookup"><span data-stu-id="3f980-210">The presence of the `Application_Error` event handler does not affect the end user's experience.</span></span> <span data-ttu-id="3f980-211">他們仍然會看到 [設定的錯誤] 頁面，也就是 [錯誤詳細資料] YSOD、[執行時間錯誤] YSOD 或 [自訂錯誤] 頁面。</span><span class="sxs-lookup"><span data-stu-id="3f980-211">They still see the configured error page, be it the Error Details YSOD, the Runtime Error YSOD, or the custom error page.</span></span>

<span data-ttu-id="3f980-212">使用自訂錯誤頁面時，請務必知道 `Global.asax` 檔案和 `Application_Error` 事件是否必要。</span><span class="sxs-lookup"><span data-stu-id="3f980-212">It's natural to wonder whether the `Global.asax` file and `Application_Error` event is necessary when using a custom error page.</span></span> <span data-ttu-id="3f980-213">發生錯誤時，使用者會顯示在 [自訂錯誤] 頁面上，因此為什麼無法讓程式碼通知開發人員，並將錯誤詳細資料記錄到自訂錯誤頁面的程式碼後置類別中？</span><span class="sxs-lookup"><span data-stu-id="3f980-213">When an error occurs the user is shown the custom error page so why can't we put the code to notify the developer and log the error details into the code-behind class of the custom error page?</span></span> <span data-ttu-id="3f980-214">雖然您可以在自訂錯誤頁面的程式碼後置類別中加入程式碼，但在使用我們在先前的教學課程中所探討的技巧時，您無法存取觸發 `Error` 事件之例外狀況的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="3f980-214">While you can certainly add code to the custom error page's code-behind class you do not have access to the details of the exception that triggered the `Error` event when using the technique we explored in the preceding tutorial.</span></span> <span data-ttu-id="3f980-215">從自訂錯誤頁面呼叫 `GetLastError` 方法會傳回 `Nothing`。</span><span class="sxs-lookup"><span data-stu-id="3f980-215">Calling the `GetLastError` method from the custom error page returns `Nothing`.</span></span>

<span data-ttu-id="3f980-216">這種行為的原因是因為透過重新導向來到達自訂錯誤網頁。</span><span class="sxs-lookup"><span data-stu-id="3f980-216">The reason for this behavior is because the custom error page is reached via a redirect.</span></span> <span data-ttu-id="3f980-217">當未處理的例外狀況到達 ASP.NET 執行時間時，ASP.NET 引擎會引發它的 `Error` 事件（這會執行 `Application_Error` 事件處理常式），然後藉由發出 `Response.Redirect(customErrorPageUrl)`，將使用者重新*導向*至自訂錯誤網頁。</span><span class="sxs-lookup"><span data-stu-id="3f980-217">When an unhandled exception reaches the ASP.NET runtime the ASP.NET engine raises its `Error` event (which executes the `Application_Error` event handler) and then *redirects* the user to the custom error page by issuing a `Response.Redirect(customErrorPageUrl)`.</span></span> <span data-ttu-id="3f980-218">`Response.Redirect` 方法會將回應傳送至具有 HTTP 302 狀態碼的用戶端，指示瀏覽器要求新的 URL，也就是自訂錯誤網頁。</span><span class="sxs-lookup"><span data-stu-id="3f980-218">The `Response.Redirect` method sends a response to the client with an HTTP 302 status code, instructing the browser to request a new URL, namely the custom error page.</span></span> <span data-ttu-id="3f980-219">然後，瀏覽器會自動要求這個新頁面。</span><span class="sxs-lookup"><span data-stu-id="3f980-219">The browser then automatically requests this new page.</span></span> <span data-ttu-id="3f980-220">您可以告訴，自訂錯誤頁面是從發生錯誤的頁面分開要求，因為瀏覽器的網址列會變更為自訂錯誤網頁 URL （請參閱 [**圖 4**]）。</span><span class="sxs-lookup"><span data-stu-id="3f980-220">You can tell that the custom error page was requested separately from the page where the error originated because the browser's Address bar changes to the custom error page URL (see **Figure 4**).</span></span>

[![](processing-unhandled-exceptions-cs/_static/image11.png)](processing-unhandled-exceptions-cs/_static/image10.png)

<span data-ttu-id="3f980-221">**圖 4**：當發生錯誤時，瀏覽器會重新導向至自訂錯誤網頁 URL</span><span class="sxs-lookup"><span data-stu-id="3f980-221">**Figure 4**: When an Error Occurs the Browser Gets Redirected to the Custom Error Page URL</span></span>  
<span data-ttu-id="3f980-222">（[按一下以查看完整大小的影像](processing-unhandled-exceptions-cs/_static/image12.png)）</span><span class="sxs-lookup"><span data-stu-id="3f980-222">([Click to view full-size image](processing-unhandled-exceptions-cs/_static/image12.png))</span></span>

<span data-ttu-id="3f980-223">最後的結果是，當伺服器回應 HTTP 302 重新導向時，發生未處理的例外狀況的要求就會結束。</span><span class="sxs-lookup"><span data-stu-id="3f980-223">The net effect is that the request where the unhandled exception occurred ends when the server responds with the HTTP 302 redirect.</span></span> <span data-ttu-id="3f980-224">後續對自訂錯誤頁面提出的要求是全新的要求;此時，ASP.NET 引擎已捨棄錯誤資訊，而且也無法將前一個要求中未處理的例外狀況與自訂錯誤網頁的新要求產生關聯。</span><span class="sxs-lookup"><span data-stu-id="3f980-224">The subsequent request to the custom error page is a brand new request; by this point the ASP.NET engine has discarded the error information and, moreover, has no way to associate the unhandled exception in the previous request with the new request for the custom error page.</span></span> <span data-ttu-id="3f980-225">這就是為什麼當從自訂錯誤頁面呼叫時，`GetLastError` 傳回 `null` 的原因。</span><span class="sxs-lookup"><span data-stu-id="3f980-225">This is why `GetLastError` returns `null` when called from the custom error page.</span></span>

<span data-ttu-id="3f980-226">不過，在導致錯誤的相同要求期間，可能會執行自訂錯誤頁面。</span><span class="sxs-lookup"><span data-stu-id="3f980-226">However, it is possible to have the custom error page executed during the same request that caused the error.</span></span> <span data-ttu-id="3f980-227">[`Server.Transfer(url)`](https://msdn.microsoft.com/library/system.web.httpserverutility.transfer.aspx)方法會將執行傳輸到指定的 URL，並在相同的要求中進行處理。</span><span class="sxs-lookup"><span data-stu-id="3f980-227">The [`Server.Transfer(url)`](https://msdn.microsoft.com/library/system.web.httpserverutility.transfer.aspx) method transfers execution to the specified URL and processes it within the same request.</span></span> <span data-ttu-id="3f980-228">您可以將 `Application_Error` 事件處理常式中的程式碼移至自訂錯誤頁面的程式碼後置類別，並以下列程式碼取代 `Global.asax`：</span><span class="sxs-lookup"><span data-stu-id="3f980-228">You could move the code in the `Application_Error` event handler to the custom error page's code-behind class, replacing it in `Global.asax` with the following code:</span></span>

[!code-csharp[Main](processing-unhandled-exceptions-cs/samples/sample5.cs)]

<span data-ttu-id="3f980-229">現在，當發生未處理的例外狀況時，`Application_Error` 事件處理常式會根據 HTTP 狀態碼，將控制項傳輸至適當的自訂錯誤頁面。</span><span class="sxs-lookup"><span data-stu-id="3f980-229">Now when an unhandled exception occurs the `Application_Error` event handler transfers control to the appropriate custom error page based on the HTTP status code.</span></span> <span data-ttu-id="3f980-230">因為已傳輸控制項，所以自訂錯誤頁面可以透過 `Server.GetLastError` 存取未處理的例外狀況資訊，並可通知開發人員錯誤並記錄其詳細資料。</span><span class="sxs-lookup"><span data-stu-id="3f980-230">Because control was transferred, the custom error page has access to the unhandled exception information via `Server.GetLastError` and can notify a developer of the error and log its details.</span></span> <span data-ttu-id="3f980-231">`Server.Transfer` 呼叫會阻止 ASP.NET 引擎將使用者重新導向至自訂錯誤網頁。</span><span class="sxs-lookup"><span data-stu-id="3f980-231">The `Server.Transfer` call stops the ASP.NET engine from redirecting the user to the custom error page.</span></span> <span data-ttu-id="3f980-232">相反地，會傳回自訂錯誤頁面的內容做為產生錯誤之頁面的回應。</span><span class="sxs-lookup"><span data-stu-id="3f980-232">Instead, the custom error page's content is returned as the response to the page that generated the error.</span></span>

## <a name="summary"></a><span data-ttu-id="3f980-233">總結</span><span class="sxs-lookup"><span data-stu-id="3f980-233">Summary</span></span>

<span data-ttu-id="3f980-234">當 ASP.NET web 應用程式中發生未處理的例外狀況時，ASP.NET 執行時間會引發 `Error` 事件，並顯示已設定的錯誤頁面。</span><span class="sxs-lookup"><span data-stu-id="3f980-234">When an unhandled exception occurs in an ASP.NET web application the ASP.NET runtime raises the `Error` event and displays the configured error page.</span></span> <span data-ttu-id="3f980-235">我們可以藉由建立錯誤事件的事件處理常式，來通知開發人員錯誤、記錄其詳細資料，或以其他方式處理它。</span><span class="sxs-lookup"><span data-stu-id="3f980-235">We can notify the developer of the error, log its details, or process it in some other fashion, by creating an event handler for the Error event.</span></span> <span data-ttu-id="3f980-236">有兩種方式可以建立事件處理常式，以便在 `Global.asax` 檔案或 HTTP 模組中 `HttpApplication` 事件（例如 `Error`：）。</span><span class="sxs-lookup"><span data-stu-id="3f980-236">There are two ways to create an event handler for `HttpApplication` events like `Error`: in the `Global.asax` file or from an HTTP Module.</span></span> <span data-ttu-id="3f980-237">本教學課程示範如何在 `Global.asax` 檔案中建立 `Error` 事件處理常式，以透過電子郵件訊息通知開發人員發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="3f980-237">This tutorial showed how to create an `Error` event handler in the `Global.asax` file that notifies developers of an error by means of an email message.</span></span>

<span data-ttu-id="3f980-238">如果您需要以一些獨特或自訂的方式處理未處理的例外狀況，建立 `Error` 事件處理常式會很有用。</span><span class="sxs-lookup"><span data-stu-id="3f980-238">Creating an `Error` event handler is useful if you need to process unhandled exceptions in some unique or customized manner.</span></span> <span data-ttu-id="3f980-239">不過，建立您自己的 `Error` 事件處理常式來記錄例外狀況或通知開發人員，並不是最有效率的使用時間，因為已有可用的錯誤記錄程式庫，而且可以在幾分鐘內進行設定。</span><span class="sxs-lookup"><span data-stu-id="3f980-239">However, creating your own `Error` event handler to log the exception or to notify a developer is not the most efficient use of your time as there already exist free and easy to use error logging libraries that can be setup in a matter of minutes.</span></span> <span data-ttu-id="3f980-240">接下來的兩個教學課程會檢查兩個這類程式庫。</span><span class="sxs-lookup"><span data-stu-id="3f980-240">The next two tutorials examine two such libraries.</span></span>

<span data-ttu-id="3f980-241">快樂的程式設計！</span><span class="sxs-lookup"><span data-stu-id="3f980-241">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="3f980-242">進一步閱讀</span><span class="sxs-lookup"><span data-stu-id="3f980-242">Further Reading</span></span>

<span data-ttu-id="3f980-243">如需本教學課程中所討論之主題的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="3f980-243">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="3f980-244">ASP.NET HTTP 模組和 HTTP 處理常式總覽</span><span class="sxs-lookup"><span data-stu-id="3f980-244">ASP.NET HTTP Modules and HTTP Handlers Overview</span></span>](https://support.microsoft.com/kb/307985)
- [<span data-ttu-id="3f980-245">正常回應未處理的例外狀況-處理未處理的例外狀況</span><span class="sxs-lookup"><span data-stu-id="3f980-245">Gracefully Responding to Unhandled Exceptions - Processing Unhandled Exceptions</span></span>](http://aspnet.4guysfromrolla.com/articles/091306-1.aspx)
- [<span data-ttu-id="3f980-246">`HttpApplication` 類別和 ASP.NET 應用程式物件</span><span class="sxs-lookup"><span data-stu-id="3f980-246">`HttpApplication` Class and the ASP.NET Application Object</span></span>](http://www.eggheadcafe.com/articles/20030211.asp)
- [<span data-ttu-id="3f980-247">ASP.NET 中的 HTTP 處理常式和 HTTP 模組</span><span class="sxs-lookup"><span data-stu-id="3f980-247">HTTP Handlers and HTTP Modules in ASP.NET</span></span>](http://www.15seconds.com/Issue/020417.htm)
- [<span data-ttu-id="3f980-248">在 ASP.NET 中傳送電子郵件</span><span class="sxs-lookup"><span data-stu-id="3f980-248">Sending Email in ASP.NET</span></span>](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)
- [<span data-ttu-id="3f980-249">瞭解 `Global.asax` 檔案</span><span class="sxs-lookup"><span data-stu-id="3f980-249">Understanding the `Global.asax` File</span></span>](http://aspalliance.com/1114_Understanding_the_Globalasax_file.all)
- [<span data-ttu-id="3f980-250">使用 HTTP 模組和處理常式建立可插入的 ASP.NET 元件</span><span class="sxs-lookup"><span data-stu-id="3f980-250">Using HTTP Modules and Handlers to Create Pluggable ASP.NET Components</span></span>](https://msdn.microsoft.com/library/aa479332.aspx)
- [<span data-ttu-id="3f980-251">使用 ASP.NET `Global.asax` 檔案</span><span class="sxs-lookup"><span data-stu-id="3f980-251">Working with the ASP.NET `Global.asax` File</span></span>](http://articles.techrepublic.com.com/5100-10878_11-5771721.html)
- [<span data-ttu-id="3f980-252">使用 `HttpApplication` 實例</span><span class="sxs-lookup"><span data-stu-id="3f980-252">Working with `HttpApplication` Instances</span></span>](https://msdn.microsoft.com/library/a0xez8f2.aspx)

> [!div class="step-by-step"]
> <span data-ttu-id="3f980-253">[上一頁](displaying-a-custom-error-page-cs.md)
> [下一頁](logging-error-details-with-asp-net-health-monitoring-cs.md)</span><span class="sxs-lookup"><span data-stu-id="3f980-253">[Previous](displaying-a-custom-error-page-cs.md)
[Next](logging-error-details-with-asp-net-health-monitoring-cs.md)</span></span>
