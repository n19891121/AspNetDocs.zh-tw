---
uid: web-forms/overview/deployment/advanced-enterprise-web-deployment/taking-web-applications-offline-with-web-deploy
title: 使用 Web Deploy 讓 Web 應用程式離線 |Microsoft Docs
author: jrjlee
description: 本主題描述如何使用 Internet Information Services （IIS） Web Depl，讓 web 應用程式在自動化部署期間離線。
ms.author: riande
ms.date: 05/04/2012
ms.assetid: 3e9f6e7d-8967-4586-94d5-d3a122f12529
msc.legacyurl: /web-forms/overview/deployment/advanced-enterprise-web-deployment/taking-web-applications-offline-with-web-deploy
msc.type: authoredcontent
ms.openlocfilehash: ba60664a0c3daa0650cd7e7cfc4ab9da08df3440
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78526065"
---
# <a name="taking-web-applications-offline-with-web-deploy"></a><span data-ttu-id="cb50c-103">使用 Web Deploy 讓 Web 應用程式離線</span><span class="sxs-lookup"><span data-stu-id="cb50c-103">Taking Web Applications Offline with Web Deploy</span></span>

<span data-ttu-id="cb50c-104">[Jason 先生](https://github.com/jrjlee)</span><span class="sxs-lookup"><span data-stu-id="cb50c-104">by [Jason Lee](https://github.com/jrjlee)</span></span>

[<span data-ttu-id="cb50c-105">下載 PDF</span><span class="sxs-lookup"><span data-stu-id="cb50c-105">Download PDF</span></span>](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)

> <span data-ttu-id="cb50c-106">本主題描述如何使用 Internet Information Services （IIS） Web 部署工具（Web Deploy），讓 web 應用程式在自動化部署期間離線。</span><span class="sxs-lookup"><span data-stu-id="cb50c-106">This topic describes how to take a web application offline for the duration of an automated deployment using the Internet Information Services (IIS) Web Deployment Tool (Web Deploy).</span></span> <span data-ttu-id="cb50c-107">流覽至 web 應用程式的使用者會被重新導向至*應用程式\_離線 .htm*檔案，直到部署完成為止。</span><span class="sxs-lookup"><span data-stu-id="cb50c-107">Users who browse to the web application are redirected to an *App\_offline.htm* file until the deployment is complete.</span></span>

<span data-ttu-id="cb50c-108">本主題會根據名為 Fabrikam，Inc. 之虛構公司的企業部署需求，形成一系列教學課程的一部分。本教學課程系列使用&#x2014; [Contact Manager 解決方案](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;的範例解決方案，來代表具有實際複雜度層級的 web 應用程式，包括 ASP.NET MVC 3 應用程式、Windows Communication Foundation （WCF）服務和資料庫專案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-108">This topic forms part of a series of tutorials based around the enterprise deployment requirements of a fictional company named Fabrikam, Inc. This tutorial series uses a sample solution&#x2014;the [Contact Manager solution](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)&#x2014;to represent a web application with a realistic level of complexity, including an ASP.NET MVC 3 application, a Windows Communication Foundation (WCF) service, and a database project.</span></span>

<span data-ttu-id="cb50c-109">這些教學課程中的部署方法是以[瞭解專案](../web-deployment-in-the-enterprise/understanding-the-project-file.md)檔中所述的分割專案檔案方法為基礎，其中的組建程式是由兩個專案&#x2014;檔所控制，其中包含適用于每個目的地環境的組建指示，另一個包含環境特定的組建和部署設定。</span><span class="sxs-lookup"><span data-stu-id="cb50c-109">The deployment method at the heart of these tutorials is based on the split project file approach described in [Understanding the Project File](../web-deployment-in-the-enterprise/understanding-the-project-file.md), in which the build process is controlled by two project files&#x2014;one containing build instructions that apply to every destination environment, and one containing environment-specific build and deployment settings.</span></span> <span data-ttu-id="cb50c-110">在組建期間，環境特定的專案檔會合並到環境無關的專案檔中，以形成一組完整的組建指示。</span><span class="sxs-lookup"><span data-stu-id="cb50c-110">At build time, the environment-specific project file is merged into the environment-agnostic project file to form a complete set of build instructions.</span></span>

## <a name="task-overview"></a><span data-ttu-id="cb50c-111">工作總覽</span><span class="sxs-lookup"><span data-stu-id="cb50c-111">Task Overview</span></span>

<span data-ttu-id="cb50c-112">在許多情況下，您會想要在變更相關元件（例如資料庫或 web 服務）時讓 web 應用程式離線。</span><span class="sxs-lookup"><span data-stu-id="cb50c-112">In a lot of scenarios, you'll want to take a web application offline while you make changes to related components, like databases or web services.</span></span> <span data-ttu-id="cb50c-113">一般來說，在 IIS 和 ASP.NET 中，您可以在 IIS 網站或 web 應用程式的根資料夾中，將名為 App 的檔案 *\_離線*，藉此完成這項操作。</span><span class="sxs-lookup"><span data-stu-id="cb50c-113">Typically, in IIS and ASP.NET, you accomplish this by placing a file named *App\_offline.htm* in the root folder of the IIS website or web application.</span></span> <span data-ttu-id="cb50c-114">*應用程式\_離線的 .htm*檔案是標準的 HTML 檔案，而且通常會包含一則訊息，告知使用者網站暫時無法使用，因為進行維護。</span><span class="sxs-lookup"><span data-stu-id="cb50c-114">The *App\_offline.htm* file is a standard HTML file and will usually contain a simple message advising the user that the site is temporarily unavailable due to maintenance.</span></span> <span data-ttu-id="cb50c-115">雖然*應用程式\_離線 .htm*檔案存在於網站的根資料夾中，但 IIS 會自動將所有要求重新導向至檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-115">While the *App\_offline.htm* file exists in the root folder of the website, IIS will automatically redirect any requests to the file.</span></span> <span data-ttu-id="cb50c-116">當您完成更新時，您會移除*應用程式\_離線 .htm*檔案，而網站會如往常般繼續提供要求。</span><span class="sxs-lookup"><span data-stu-id="cb50c-116">When you've finished making updates, you remove the *App\_offline.htm* file and the website resumes serving requests as usual.</span></span>

<span data-ttu-id="cb50c-117">當您使用 Web Deploy 對目標環境執行自動化或單一步驟部署時，您可能會想要將*應用程式\_的離線 .htm*檔案加入至您的部署流程。</span><span class="sxs-lookup"><span data-stu-id="cb50c-117">When you use Web Deploy to perform automated or single-step deployments to a target environment, you may want to incorporate adding and removing the *App\_offline.htm* file into your deployment process.</span></span> <span data-ttu-id="cb50c-118">若要這樣做，您必須完成下列高階工作：</span><span class="sxs-lookup"><span data-stu-id="cb50c-118">To do this, you'll need to complete these high-level tasks:</span></span>

- <span data-ttu-id="cb50c-119">在您用來控制部署程式的 Microsoft Build Engine （MSBuild）專案檔中，建立 MSBuild 目標，以在任何部署工作開始之前，將*應用程式\_離線 .htm*檔案複製到目的地伺服器。</span><span class="sxs-lookup"><span data-stu-id="cb50c-119">In the Microsoft Build Engine (MSBuild) project file that you use to control the deployment process, create an MSBuild target that copies an *App\_offline.htm* file to the destination server before any deployment tasks begin.</span></span>
- <span data-ttu-id="cb50c-120">新增另一個 MSBuild 目標，以便在所有部署工作都完成時，從目的地伺服器移除*應用程式\_離線 .htm*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-120">Add another MSBuild target that removes the *App\_offline.htm* file from the destination server when all deployment tasks are complete.</span></span>
- <span data-ttu-id="cb50c-121">在 web 應用程式專案中，建立一個*wpp .targets*檔案，以確保在叫用 Web Deploy 時，會將*應用程式\_離線的 .htm*檔案加入至部署套件。</span><span class="sxs-lookup"><span data-stu-id="cb50c-121">In the web application project, create a *.wpp.targets* file that ensures that an *App\_offline.htm* file is added to the deployment package when Web Deploy is invoked.</span></span>

<span data-ttu-id="cb50c-122">本主題將說明如何執行這些程式。</span><span class="sxs-lookup"><span data-stu-id="cb50c-122">This topic will show you how to perform these procedures.</span></span> <span data-ttu-id="cb50c-123">本主題中的工作和逐步解說假設您已經建立一個方案，其中包含至少一個 web 應用程式專案，而且您使用自訂專案檔來控制部署程式，如[企業中的 Web 部署中](../web-deployment-in-the-enterprise/web-deployment-in-the-enterprise.md)所述。</span><span class="sxs-lookup"><span data-stu-id="cb50c-123">The tasks and walkthroughs in this topic assume that you've already created a solution that contains at least one web application project, and that you use a custom project file to control the deployment process as described in [Web Deployment in the Enterprise](../web-deployment-in-the-enterprise/web-deployment-in-the-enterprise.md).</span></span> <span data-ttu-id="cb50c-124">或者，您可以使用[Contact Manager](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)範例解決方案，遵循主題中的範例。</span><span class="sxs-lookup"><span data-stu-id="cb50c-124">Alternatively, you can use the [Contact Manager](../web-deployment-in-the-enterprise/the-contact-manager-solution.md) sample solution to follow the examples in the topic.</span></span>

## <a name="adding-an-app_offline-file-to-a-web-application-project"></a><span data-ttu-id="cb50c-125">將應用程式\_離線檔案新增至 Web 應用程式專案</span><span class="sxs-lookup"><span data-stu-id="cb50c-125">Adding an App\_Offline File to a Web Application Project</span></span>

<span data-ttu-id="cb50c-126">您需要完成的第一項工作是將*應用程式\_離線*檔案新增至您的 web 應用程式專案：</span><span class="sxs-lookup"><span data-stu-id="cb50c-126">The first task you need to complete is to add an *App\_offline* file to your web application project:</span></span>

- <span data-ttu-id="cb50c-127">若要防止檔案干擾開發程式（您不想讓應用程式永久離線），您應該將應用程式以外的其他專案呼叫 *\_離線的 .htm*。</span><span class="sxs-lookup"><span data-stu-id="cb50c-127">To prevent the file from interfering with the development process (you don't want your application to be permanently offline), you should call it something other than *App\_offline.htm*.</span></span> <span data-ttu-id="cb50c-128">例如，您可以將檔案*應用程式*命名為 offline-template，\_為 .htm。</span><span class="sxs-lookup"><span data-stu-id="cb50c-128">For example, you could name the file *App\_offline-template.htm*.</span></span>
- <span data-ttu-id="cb50c-129">若要防止檔案依預設部署，您應該將 [組建] 動作設定為 [**無**]。</span><span class="sxs-lookup"><span data-stu-id="cb50c-129">To prevent the file from being deployed as-is, you should set the build action to **None**.</span></span>

<span data-ttu-id="cb50c-130">**將應用程式\_離線檔案加入至 web 應用程式專案**</span><span class="sxs-lookup"><span data-stu-id="cb50c-130">**To add an App\_offline file to a web application project**</span></span>

1. <span data-ttu-id="cb50c-131">在 Visual Studio 2010 中開啟您的方案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-131">Open your solution in Visual Studio 2010.</span></span>
2. <span data-ttu-id="cb50c-132">在 [**方案總管**] 視窗中，以滑鼠右鍵按一下您的 web 應用程式專案，指向 [**加入**]，然後按一下 [**新增專案**]。</span><span class="sxs-lookup"><span data-stu-id="cb50c-132">In the **Solution Explorer** window, right-click your web application project, point to **Add**, and then click **New Item**.</span></span>
3. <span data-ttu-id="cb50c-133">在 [**加入新專案**] 對話方塊中，選取 [ **HTML 網頁**]。</span><span class="sxs-lookup"><span data-stu-id="cb50c-133">In the **Add New Item** dialog box, select **HTML Page**.</span></span>
4. <span data-ttu-id="cb50c-134">在 [**名稱**] 方塊中，輸入**App\_offline-template**，然後按一下 [**新增**]。</span><span class="sxs-lookup"><span data-stu-id="cb50c-134">In the **Name** box, type **App\_offline-template.htm**, and then click **Add**.</span></span>

    ![](taking-web-applications-offline-with-web-deploy/_static/image1.png)
5. <span data-ttu-id="cb50c-135">新增一些簡單的 HTML 以通知使用者應用程式無法使用，然後儲存檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-135">Add some simple HTML to inform users that the application is unavailable, and then save the file.</span></span> <span data-ttu-id="cb50c-136">請勿包含任何伺服器端標記（例如，任何前面加上 "asp：" 的標記）。</span><span class="sxs-lookup"><span data-stu-id="cb50c-136">Do not include any server-side tags (for example, any tags that are prefixed with "asp:").</span></span> 

    ![](taking-web-applications-offline-with-web-deploy/_static/image2.png)
6. <span data-ttu-id="cb50c-137">在 [**方案總管**] 視窗中，以滑鼠右鍵按一下新的檔案，然後按一下 [**屬性**]。</span><span class="sxs-lookup"><span data-stu-id="cb50c-137">In the **Solution Explorer** window, right-click the new file, and then click **Properties**.</span></span>
7. <span data-ttu-id="cb50c-138">在 [**屬性**] 視窗的 [**組建動作**] 資料列中，選取 [**無**]。</span><span class="sxs-lookup"><span data-stu-id="cb50c-138">In the **Properties** window, in the **Build Action** row, select **None**.</span></span>

    ![](taking-web-applications-offline-with-web-deploy/_static/image3.png)

## <a name="deploying-and-deleting-an-app_offline-file"></a><span data-ttu-id="cb50c-139">部署和刪除應用程式\_離線檔案</span><span class="sxs-lookup"><span data-stu-id="cb50c-139">Deploying and Deleting an App\_Offline File</span></span>

<span data-ttu-id="cb50c-140">下一個步驟是修改您的部署邏輯，在部署程式開始時將檔案複製到目的地伺服器，並在結束時將它移除。</span><span class="sxs-lookup"><span data-stu-id="cb50c-140">The next step is to modify your deployment logic to copy the file to the destination server at the start of the deployment process and remove it at the end.</span></span>

> [!NOTE]
> <span data-ttu-id="cb50c-141">下一個程式假設您是使用自訂的 MSBuild 專案檔來控制您的部署程式，如[瞭解專案](../web-deployment-in-the-enterprise/understanding-the-project-file.md)檔中所述。</span><span class="sxs-lookup"><span data-stu-id="cb50c-141">The next procedure assumes that you're using a custom MSBuild project file to control your deployment process, as described in [Understanding the Project File](../web-deployment-in-the-enterprise/understanding-the-project-file.md).</span></span> <span data-ttu-id="cb50c-142">如果您要從 Visual Studio 直接部署，則必須使用不同的方法。</span><span class="sxs-lookup"><span data-stu-id="cb50c-142">If you're deploying direct from Visual Studio, you'll need to use a different approach.</span></span> <span data-ttu-id="cb50c-143">Sayed Ibrahim Hashimi 說明[如何讓您的 Web 應用程式在發佈期間離線](http://sedodream.com/2012/01/08/HowToTakeYourWebAppOfflineDuringPublishing.aspx)的其中一種方法。</span><span class="sxs-lookup"><span data-stu-id="cb50c-143">Sayed Ibrahim Hashimi describes one such approach in [How to Take Your Web App Offline During Publishing](http://sedodream.com/2012/01/08/HowToTakeYourWebAppOfflineDuringPublishing.aspx).</span></span>

<span data-ttu-id="cb50c-144">若要將*應用程式\_離線*檔案部署到目的地 IIS 網站，您必須使用[Web Deploy **contentPath**提供者](https://technet.microsoft.com/library/dd569034(WS.10).aspx)叫用 msdeploy.exe。</span><span class="sxs-lookup"><span data-stu-id="cb50c-144">To deploy an *App\_offline* file to a destination IIS website, you need to invoke MSDeploy.exe using the [Web Deploy **contentPath** provider](https://technet.microsoft.com/library/dd569034(WS.10).aspx).</span></span> <span data-ttu-id="cb50c-145">**ContentPath**提供者同時支援實體目錄路徑和 iis 網站或應用程式路徑，這讓它成為在 Visual Studio 專案資料夾與 iis web 應用程式之間同步處理檔案的理想選擇。</span><span class="sxs-lookup"><span data-stu-id="cb50c-145">The **contentPath** provider supports both physical directory paths and IIS website or application paths, which makes it the ideal choice for synchronizing a file between a Visual Studio project folder and an IIS web application.</span></span> <span data-ttu-id="cb50c-146">若要部署檔案，您的 Msdeploy.exe 命令應如下所示：</span><span class="sxs-lookup"><span data-stu-id="cb50c-146">To deploy the file, your MSDeploy command should resemble this:</span></span>

[!code-console[Main](taking-web-applications-offline-with-web-deploy/samples/sample1.cmd)]

<span data-ttu-id="cb50c-147">若要在部署程式結束時從目的地網站移除檔案，您的 Msdeploy.exe 命令應如下所示：</span><span class="sxs-lookup"><span data-stu-id="cb50c-147">To remove the file from the destination site at the end of the deployment process, your MSDeploy command should resemble this:</span></span>

[!code-console[Main](taking-web-applications-offline-with-web-deploy/samples/sample2.cmd)]

<span data-ttu-id="cb50c-148">若要將這些命令自動化為組建和部署程式的一部分，您需要將它們整合到您的自訂 MSBuild 專案檔中。</span><span class="sxs-lookup"><span data-stu-id="cb50c-148">To automate these commands as part of a build and deployment process, you need to integrate them into your custom MSBuild project file.</span></span> <span data-ttu-id="cb50c-149">下一個程式描述如何執行此動作。</span><span class="sxs-lookup"><span data-stu-id="cb50c-149">The next procedure describes how to do this.</span></span>

<span data-ttu-id="cb50c-150">**若要部署和刪除應用程式\_離線檔案**</span><span class="sxs-lookup"><span data-stu-id="cb50c-150">**To deploy and delete an App\_offline file**</span></span>

1. <span data-ttu-id="cb50c-151">在 Visual Studio 2010 中，開啟可控制部署程式的 MSBuild 專案檔。</span><span class="sxs-lookup"><span data-stu-id="cb50c-151">In Visual Studio 2010, open the MSBuild project file that controls your deployment process.</span></span> <span data-ttu-id="cb50c-152">在[Contact Manager](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)範例解決方案中，這是*Publish*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-152">In the [Contact Manager](../web-deployment-in-the-enterprise/the-contact-manager-solution.md) sample solution, this is the *Publish.proj* file.</span></span>
2. <span data-ttu-id="cb50c-153">在根**專案**元素中，建立新的**PropertyGroup**元素，以儲存*應用程式\_離線*部署的變數：</span><span class="sxs-lookup"><span data-stu-id="cb50c-153">In the root **Project** element, create a new **PropertyGroup** element to store variables for the *App\_offline* deployment:</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample3.xml)]
3. <span data-ttu-id="cb50c-154">**SourceRoot**屬性是在*Publish*檔案中的其他位置定義的。</span><span class="sxs-lookup"><span data-stu-id="cb50c-154">The **SourceRoot** property is defined elsewhere in the *Publish.proj* file.</span></span> <span data-ttu-id="cb50c-155">它會指出相對於目前路徑&#x2014;之來源內容的根資料夾位置（相對於*Publish*檔案的位置）。</span><span class="sxs-lookup"><span data-stu-id="cb50c-155">It indicates the location of the root folder for the source content relative to the current path&#x2014;in other words, relative to the location of the *Publish.proj* file.</span></span>
4. <span data-ttu-id="cb50c-156">**ContentPath**提供者不會接受相對檔案路徑，因此您必須先取得原始程式檔的絕對路徑，才能進行部署。</span><span class="sxs-lookup"><span data-stu-id="cb50c-156">The **contentPath** provider will not accept relative file paths, so you need to get an absolute path to your source file before you can deploy it.</span></span> <span data-ttu-id="cb50c-157">您可以使用[ConvertToAbsolutePath](https://msdn.microsoft.com/library/bb882668.aspx)工作來執行這項操作。</span><span class="sxs-lookup"><span data-stu-id="cb50c-157">You can use the [ConvertToAbsolutePath](https://msdn.microsoft.com/library/bb882668.aspx) task to do this.</span></span>
5. <span data-ttu-id="cb50c-158">新增名為**GetAppOfflineAbsolutePath**的新**目標**元素。</span><span class="sxs-lookup"><span data-stu-id="cb50c-158">Add a new **Target** element named **GetAppOfflineAbsolutePath**.</span></span> <span data-ttu-id="cb50c-159">在此目標中，使用**ConvertToAbsolutePath**工作來取得應用程式的絕對路徑，\_您專案資料夾中的*離線範本*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-159">Within this target, use the **ConvertToAbsolutePath** task to get an absolute path to the *App\_offline-template* file in your project folder.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample4.xml)]
6. <span data-ttu-id="cb50c-160">此目標會採用應用程式的相對路徑\_專案資料夾中的*離線範本*檔案，並將其儲存至新的屬性，做為絕對檔案路徑。</span><span class="sxs-lookup"><span data-stu-id="cb50c-160">This target takes the relative path to the *App\_offline-template* file in your project folder and saves it to a new property as an absolute file path.</span></span> <span data-ttu-id="cb50c-161">**BeforeTargets**屬性會指定您要在下一個步驟中建立的**DeployAppOffline**目標之前，讓此目標執行。</span><span class="sxs-lookup"><span data-stu-id="cb50c-161">The **BeforeTargets** attribute specifies that you want this target to execute before the **DeployAppOffline** target, which you'll create in the next step.</span></span>
7. <span data-ttu-id="cb50c-162">新增名為**DeployAppOffline**的新目標。</span><span class="sxs-lookup"><span data-stu-id="cb50c-162">Add a new target named **DeployAppOffline**.</span></span> <span data-ttu-id="cb50c-163">在此目標中，叫用將您的*應用程式部署\_離線*檔案到目的地 web 伺服器的 msdeploy.exe 命令。</span><span class="sxs-lookup"><span data-stu-id="cb50c-163">Within this target, invoke the MSDeploy.exe command that deploys your *App\_offline* file to the destination web server.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample5.xml)]
8. <span data-ttu-id="cb50c-164">在此範例中， **ContactManagerIisPath**屬性是在專案檔中的其他位置定義的。</span><span class="sxs-lookup"><span data-stu-id="cb50c-164">In this example, the **ContactManagerIisPath** property is defined elsewhere in the project file.</span></span> <span data-ttu-id="cb50c-165">這只是 IIS 應用程式路徑，格式為 *[Iis 網站名稱]/[應用程式名稱]* 。</span><span class="sxs-lookup"><span data-stu-id="cb50c-165">This is simply an IIS application path, in the form *[IIS Website Name]/[Application Name]*.</span></span> <span data-ttu-id="cb50c-166">在目標中包含條件可讓使用者藉由變更屬性值或提供命令列參數，將*應用程式\_離線*部署切換為開啟或關閉。</span><span class="sxs-lookup"><span data-stu-id="cb50c-166">Including a condition in the target enables users to switch the *App\_offline* deployment on or off by changing a property value or providing a command-line parameter.</span></span>
9. <span data-ttu-id="cb50c-167">新增名為**DeleteAppOffline**的新目標。</span><span class="sxs-lookup"><span data-stu-id="cb50c-167">Add a new target named **DeleteAppOffline**.</span></span> <span data-ttu-id="cb50c-168">在此目標中，叫用從目的地 web 伺服器移除*應用程式\_離線*檔案的 msdeploy.exe 命令。</span><span class="sxs-lookup"><span data-stu-id="cb50c-168">Within this target, invoke the MSDeploy.exe command that removes your *App\_offline* file from the destination web server.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample6.xml)]
10. <span data-ttu-id="cb50c-169">最後一項工作是在執行您的專案檔期間，于適當的時間點叫用這些新目標。</span><span class="sxs-lookup"><span data-stu-id="cb50c-169">The final task is to invoke these new targets at appropriate points during the execution of your project file.</span></span> <span data-ttu-id="cb50c-170">您可以透過各種方式來執行這項操作。</span><span class="sxs-lookup"><span data-stu-id="cb50c-170">You can do this in various ways.</span></span> <span data-ttu-id="cb50c-171">例如，在*Publish*檔案中， **FullPublishDependsOn**屬性會指定叫用**FullPublish**預設目標時，必須按照循序執行的目標清單。</span><span class="sxs-lookup"><span data-stu-id="cb50c-171">For example, in the *Publish.proj* file, the **FullPublishDependsOn** property specifies a list of targets that must be executed in order when the **FullPublish** default target is invoked.</span></span>
11. <span data-ttu-id="cb50c-172">修改您的 MSBuild 專案檔，以在發佈程式中的適當時間點叫用**DeployAppOffline**和**DeleteAppOffline**目標。</span><span class="sxs-lookup"><span data-stu-id="cb50c-172">Modify your MSBuild project file to invoke the **DeployAppOffline** and **DeleteAppOffline** targets at appropriate points in the publishing process.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample7.xml)]

<span data-ttu-id="cb50c-173">當您執行自訂 MSBuild 專案檔時，*應用程式\_離線*檔案會在成功組建之後立即部署至伺服器。</span><span class="sxs-lookup"><span data-stu-id="cb50c-173">When you run your custom MSBuild project file, the *App\_offline* file will be deployed to the server immediately after a successful build.</span></span> <span data-ttu-id="cb50c-174">完成所有部署工作之後，它就會從伺服器中刪除。</span><span class="sxs-lookup"><span data-stu-id="cb50c-174">It will then be deleted from the server once all the deployment tasks are complete.</span></span>

## <a name="adding-an-app_offline-file-to-deployment-packages"></a><span data-ttu-id="cb50c-175">將應用程式\_離線檔案新增至部署套件</span><span class="sxs-lookup"><span data-stu-id="cb50c-175">Adding an App\_Offline File to Deployment Packages</span></span>

<span data-ttu-id="cb50c-176">根據您設定部署的方式，當您將 web 套件部署到目的地時，&#x2014;&#x2014;可能會自動刪除目的地 IIS web 應用程式（如 App）上任何現有的內容（例如*應用程式\_離線 .htm*檔案）。</span><span class="sxs-lookup"><span data-stu-id="cb50c-176">Depending on how you configure your deployment, any existing content at the destination IIS web application&#x2014;like the *App\_offline.htm* file&#x2014;may be deleted automatically when you deploy a web package to the destination.</span></span> <span data-ttu-id="cb50c-177">若要確保*應用\_程式*在部署期間仍會保留在相同的位置，您必須將該檔案包含在 web 部署套件本身中，除了在部署程式開始時直接部署該檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-177">To ensure that the *App\_offline.htm* file remains in place for the duration of the deployment, you need to include the file within the web deployment package itself in addition to deploying the file directly at the start of the deployment process.</span></span>

- <span data-ttu-id="cb50c-178">如果您已遵循本主題中先前的工作，則會將應用程式 *\_離線 .htm*檔案新增至您的 web 應用程式專案（我們使用了*應用程式\_offline-template*），而您會將組建動作設定為 [**無**]。</span><span class="sxs-lookup"><span data-stu-id="cb50c-178">If you've followed the previous tasks in this topic, you'll have added the *App\_offline.htm* file to your web application project under a different filename (we used *App\_offline-template.htm*) and you'll have set the build action to **None**.</span></span> <span data-ttu-id="cb50c-179">這些變更是防止檔案干擾開發和調試的必要變更。</span><span class="sxs-lookup"><span data-stu-id="cb50c-179">These changes are necessary to prevent the file from interfering with development and debugging.</span></span> <span data-ttu-id="cb50c-180">因此，您必須自訂封裝程式，以確保 web 部署套件中會包含*應用程式\_離線的 .htm*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-180">As a result, you need to customize the packaging process to ensure that the *App\_offline.htm* file is included in the web deployment package.</span></span>

<span data-ttu-id="cb50c-181">Web 發行管線（WPP）使用名為**FilesForPackagingFromProject**的專案清單，建立應該包含在 Web 部署套件中的檔案清單。</span><span class="sxs-lookup"><span data-stu-id="cb50c-181">The Web Publishing Pipeline (WPP) uses an item list named **FilesForPackagingFromProject** to build a list of files that should be included in the web deployment package.</span></span> <span data-ttu-id="cb50c-182">您可以將自己的專案新增到此清單中，以自訂 web 套件的內容。</span><span class="sxs-lookup"><span data-stu-id="cb50c-182">You can customize the contents of your web packages by adding your own items to this list.</span></span> <span data-ttu-id="cb50c-183">若要這樣做，您需要完成下列高階步驟：</span><span class="sxs-lookup"><span data-stu-id="cb50c-183">To do this, you need to complete these high-level steps:</span></span>

1. <span data-ttu-id="cb50c-184">在與專案檔相同的資料夾中，建立名為 *[project name]* 的自訂專案檔。</span><span class="sxs-lookup"><span data-stu-id="cb50c-184">Create a custom project file named *[project name].wpp.targets* in the same folder as your project file.</span></span>

    > [!NOTE]
    > <span data-ttu-id="cb50c-185">&#x2014;.Csproj &#x2014;.targets 檔案必須與您的 web 應用程式專案檔案位於相同的資料夾中，例如*ContactManager*，而不是與您用來控制組建和部署程式的任何自訂專案檔位於相同的資料夾中。</span><span class="sxs-lookup"><span data-stu-id="cb50c-185">The *.wpp.targets* file needs to go in the same folder as your web application project file&#x2014;for example, *ContactManager.Mvc.csproj*&#x2014;rather than in the same folder as any custom project files you use to control the build and deployment process.</span></span>
2. <span data-ttu-id="cb50c-186">在 *.targets*檔案中，建立在**CopyAllFilesToSingleFolderForPackage**目標*之前*執行的新 MSBuild 目標。</span><span class="sxs-lookup"><span data-stu-id="cb50c-186">In the *.wpp.targets* file, create a new MSBuild target that executes *before* the **CopyAllFilesToSingleFolderForPackage** target.</span></span> <span data-ttu-id="cb50c-187">這是可建立要包含在封裝中之專案清單的 WPP 目標。</span><span class="sxs-lookup"><span data-stu-id="cb50c-187">This is the WPP target that builds a list of things to include in the package.</span></span>
3. <span data-ttu-id="cb50c-188">在新的目標中，建立**ItemGroup**元素。</span><span class="sxs-lookup"><span data-stu-id="cb50c-188">In the new target, create an **ItemGroup** element.</span></span>
4. <span data-ttu-id="cb50c-189">在**ItemGroup**元素中，新增**FilesForPackagingFromProject**專案，並指定*應用程式\_離線 .htm*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-189">In the **ItemGroup** element, add a **FilesForPackagingFromProject** item and specify the *App\_offline.htm* file.</span></span>

<span data-ttu-id="cb50c-190">*. Wpp .targets*檔案應如下所示：</span><span class="sxs-lookup"><span data-stu-id="cb50c-190">The *.wpp.targets* file should resemble this:</span></span>

[!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample8.xml)]

<span data-ttu-id="cb50c-191">以下是此範例中的重點事項：</span><span class="sxs-lookup"><span data-stu-id="cb50c-191">These are the key points of note in this example:</span></span>

- <span data-ttu-id="cb50c-192">**BeforeTargets**屬性會藉由指定應該緊接在**CopyAllFilesToSingleFolderForPackage**目標之前執行，將此目標插入至 WPP。</span><span class="sxs-lookup"><span data-stu-id="cb50c-192">The **BeforeTargets** attribute inserts this target into the WPP by specifying that it should be executed immediately before the **CopyAllFilesToSingleFolderForPackage** target.</span></span>
- <span data-ttu-id="cb50c-193">**FilesForPackagingFromProject**專案會使用**DestinationRelativePath**中繼資料值，將*應用程式\_offline-template*中的檔案重新命名為*應用程式\_離線*，因為它已新增至清單。</span><span class="sxs-lookup"><span data-stu-id="cb50c-193">The **FilesForPackagingFromProject** item uses the **DestinationRelativePath** metadata value to rename the file from *App\_offline-template.htm* to *App\_offline.htm* as it's added to the list.</span></span>

<span data-ttu-id="cb50c-194">下一個程式會示範如何將此*wpp .targets*檔案加入至 web 應用程式專案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-194">The next procedure shows you how to add this *.wpp.targets* file to a web application project.</span></span>

<span data-ttu-id="cb50c-195">**將 .targets 檔案新增至 web 部署套件**</span><span class="sxs-lookup"><span data-stu-id="cb50c-195">**To add a .wpp.targets file to a web deployment package**</span></span>

1. <span data-ttu-id="cb50c-196">在 Visual Studio 2010 中開啟您的方案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-196">Open your solution in Visual Studio 2010.</span></span>
2. <span data-ttu-id="cb50c-197">在 [**方案總管**] 視窗中，以滑鼠右鍵按一下您的 web 應用程式專案節點（例如**ContactManager**），指向 [**加入**]，然後按一下 [**新增專案**]。</span><span class="sxs-lookup"><span data-stu-id="cb50c-197">In the **Solution Explorer** window, right-click your web application project node (for example, **ContactManager.Mvc**), point to **Add**, and then click **New Item**.</span></span>
3. <span data-ttu-id="cb50c-198">在 [**加入新專案**] 對話方塊中，選取 [ **XML**檔案] 範本。</span><span class="sxs-lookup"><span data-stu-id="cb50c-198">In the **Add New Item** dialog box, select the **XML File** template.</span></span>
4. <span data-ttu-id="cb50c-199">在 [**名稱**] 方塊中，輸入 *[project Name] \* \* *. wpp. .targets** （例如， **ContactManager**），然後按一下 [**新增**]。</span><span class="sxs-lookup"><span data-stu-id="cb50c-199">In the **Name** box, type *[project name]\*\*\*.wpp.targets*\* (for example, **ContactManager.Mvc.wpp.targets**), and then click **Add**.</span></span>

    ![](taking-web-applications-offline-with-web-deploy/_static/image4.png)

    > [!NOTE]
    > <span data-ttu-id="cb50c-200">如果您將新的專案加入至專案的根節點，該檔案會建立在與專案檔相同的資料夾中。</span><span class="sxs-lookup"><span data-stu-id="cb50c-200">If you add a new item to the root node of a project, the file is created in the same folder as the project file.</span></span> <span data-ttu-id="cb50c-201">您可以在 Windows Explorer 中開啟資料夾來確認這一點。</span><span class="sxs-lookup"><span data-stu-id="cb50c-201">You can verify this by opening the folder in Windows Explorer.</span></span>
5. <span data-ttu-id="cb50c-202">在檔案中，新增先前所述的 MSBuild 標記。</span><span class="sxs-lookup"><span data-stu-id="cb50c-202">In the file, add the MSBuild markup described previously.</span></span>

    [!code-xml[Main](taking-web-applications-offline-with-web-deploy/samples/sample9.xml)]
6. <span data-ttu-id="cb50c-203">儲存並關閉 *[project name]. wpp .targets*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-203">Save and close the *[project name].wpp.targets* file.</span></span>

<span data-ttu-id="cb50c-204">下一次建立和封裝 web 應用程式專案時，WPP 會自動偵測 *.targets*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-204">The next time you build and package your web application project, the WPP will automatically detect the *.wpp.targets* file.</span></span> <span data-ttu-id="cb50c-205">*應用程式\_offline-template*會包含在產生的 web 部署套件中，作為*應用程式\_離線 .htm*。</span><span class="sxs-lookup"><span data-stu-id="cb50c-205">The *App\_offline-template.htm* file will be included in the resulting web deployment package as *App\_offline.htm*.</span></span>

> [!NOTE]
> <span data-ttu-id="cb50c-206">如果您的部署失敗，*應用程式\_離線 .htm*檔案會保留在原處，且您的應用程式會保持離線狀態。</span><span class="sxs-lookup"><span data-stu-id="cb50c-206">If your deployment fails, the *App\_offline.htm* file will remain in place and your application will remain offline.</span></span> <span data-ttu-id="cb50c-207">這通常是所需的行為。</span><span class="sxs-lookup"><span data-stu-id="cb50c-207">This is typically the desired behavior.</span></span> <span data-ttu-id="cb50c-208">若要讓您的應用程式重新上線，您可以從 web 伺服器刪除*應用程式\_離線 .htm*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-208">To bring your application back online, you can delete the *App\_offline.htm* file from your web server.</span></span> <span data-ttu-id="cb50c-209">或者，如果您更正任何錯誤並執行部署成功，將會移除*應用程式\_離線的 .htm*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-209">Alternatively, if you correct any errors and run a successful deployment, the *App\_offline.htm* file will be removed.</span></span>

## <a name="conclusion"></a><span data-ttu-id="cb50c-210">結論</span><span class="sxs-lookup"><span data-stu-id="cb50c-210">Conclusion</span></span>

<span data-ttu-id="cb50c-211">本主題說明如何在部署期間將 web 應用程式離線，方法是將*應用程式\_離線的 .htm*檔案發佈到目的地伺服器，並在結束時將它移除。</span><span class="sxs-lookup"><span data-stu-id="cb50c-211">This topic described how to take a web application offline for the duration of a deployment, by publishing an *App\_offline.htm* file to the destination server at the start of the deployment process and removing it at the end.</span></span> <span data-ttu-id="cb50c-212">同時也涵蓋了如何在 web 部署套件中包含*應用程式\_離線 .htm*檔案。</span><span class="sxs-lookup"><span data-stu-id="cb50c-212">It also covered how to include an *App\_offline.htm* file in a web deployment package.</span></span>

## <a name="further-reading"></a><span data-ttu-id="cb50c-213">進一步閱讀</span><span class="sxs-lookup"><span data-stu-id="cb50c-213">Further Reading</span></span>

<span data-ttu-id="cb50c-214">如需封裝和部署程式的詳細資訊，請參閱[建立和封裝 Web 應用程式專案](../web-deployment-in-the-enterprise/building-and-packaging-web-application-projects.md)、設定[web 封裝部署的參數](../web-deployment-in-the-enterprise/configuring-parameters-for-web-package-deployment.md)和[部署 web 封裝](../web-deployment-in-the-enterprise/deploying-web-packages.md)。</span><span class="sxs-lookup"><span data-stu-id="cb50c-214">For more information on the packaging and deployment process, see [Building and Packaging Web Application Projects](../web-deployment-in-the-enterprise/building-and-packaging-web-application-projects.md), [Configuring Parameters for Web Package Deployment](../web-deployment-in-the-enterprise/configuring-parameters-for-web-package-deployment.md), and [Deploying Web Packages](../web-deployment-in-the-enterprise/deploying-web-packages.md).</span></span>

<span data-ttu-id="cb50c-215">如果您直接從 Visual Studio 發行 web 應用程式，而不是使用這些教學課程中所述的自訂 MSBuild 專案檔方法，則在發行期間，您將需要使用稍微不同的方法讓應用程式離線流程.</span><span class="sxs-lookup"><span data-stu-id="cb50c-215">If you publish your web applications directly from Visual Studio, rather than using the custom MSBuild project file approach described in these tutorials, you'll need to use a slightly different approach to take your application offline during the publishing process.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="cb50c-216">[上一頁](excluding-files-and-folders-from-deployment.md)
> [下一頁](running-windows-powershell-scripts-from-msbuild-project-files.md)</span><span class="sxs-lookup"><span data-stu-id="cb50c-216">[Previous](excluding-files-and-folders-from-deployment.md)
[Next](running-windows-powershell-scripts-from-msbuild-project-files.md)</span></span>
