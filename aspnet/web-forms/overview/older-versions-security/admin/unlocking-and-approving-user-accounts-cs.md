---
uid: web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
title: 解除鎖定及核准使用者帳戶 (C#) |Microsoft Docs
author: rick-anderson
description: 本教學課程示範如何建置網頁，以供系統管理員管理使用者的鎖定，且已核准狀態。 我們也將了解如何核准新使用者 o...
ms.author: riande
ms.date: 04/01/2008
ms.assetid: 5346aab1-9974-489f-a065-ae3883b8a350
msc.legacyurl: /web-forms/overview/older-versions-security/admin/unlocking-and-approving-user-accounts-cs
msc.type: authoredcontent
ms.openlocfilehash: d4e8591f3090de8f931ffd8eb1dd0a1138674842
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/17/2019
ms.locfileid: "59410041"
---
# <a name="unlocking-and-approving-user-accounts-c"></a><span data-ttu-id="2c4b9-104">解除鎖定及核准使用者帳戶 (C#)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-104">Unlocking and Approving User Accounts (C#)</span></span>

<span data-ttu-id="2c4b9-105">藉由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="2c4b9-106">[下載程式碼](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip)或[下載 PDF](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-106">[Download Code](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/CS.14.zip) or [Download PDF](http://download.microsoft.com/download/6/0/e/60e1bd94-e5f9-4d5a-a079-f23c98f4f67d/aspnet_tutorial14_UnlockAndApprove_cs.pdf)</span></span>

> <span data-ttu-id="2c4b9-107">本教學課程示範如何建置網頁，以供系統管理員管理使用者的鎖定，且已核准狀態。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-107">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="2c4b9-108">我們也將了解如何在他們驗證電子郵件地址時，才核准新使用者。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-108">We will also see how to approve new users only after they have verified their email address.</span></span>


## <a name="introduction"></a><span data-ttu-id="2c4b9-109">簡介</span><span class="sxs-lookup"><span data-stu-id="2c4b9-109">Introduction</span></span>

<span data-ttu-id="2c4b9-110">使用者名稱、 密碼和電子郵件，以及每個使用者帳戶有兩個的 [狀態] 欄位，以指定使用者是否可以登入網站： 鎖定及核准。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-110">Along with a username, password, and email, each user account has two status fields that dictate whether the user can log into the site: locked out and approved.</span></span> <span data-ttu-id="2c4b9-111">使用者會自動會鎖定時，如果他們提供無效的認證 （預設設定鎖定的使用者在 10 分鐘內的 5 個無效的登入嘗試之後） 的分鐘數內指定的次數。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-111">A user is automatically locked out if they provide invalid credentials a specified number of times within a specified number of minutes (the default settings lock a user out after 5 invalid login attempts within 10 minutes).</span></span> <span data-ttu-id="2c4b9-112">已核准的狀態是在新的使用者能夠登入至站台之前，某些動作，必須經過的情況下很有用。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-112">The approved status is useful in scenarios where some action must transpire before a new user is able to log on to the site.</span></span> <span data-ttu-id="2c4b9-113">例如，使用者可能需要先確認電子郵件地址，或由系統管理員核准，才能登入。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-113">For example, a user might need to first verify their email address or be approved by an administrator before being able to login.</span></span>

<span data-ttu-id="2c4b9-114">因為一部鎖定或未核准使用者無法登入，它是唯一的自然想知道可以重設這些狀態的方式。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-114">Because a locked out or unapproved user cannot login, it's only natural to wonder how these statuses can be reset.</span></span> <span data-ttu-id="2c4b9-115">ASP.NET 不包含任何內建的功能或 Web 控制項，來管理使用者的鎖定，且部分核准狀態，因為這些決策必須就站對站個別處理。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-115">ASP.NET does not include any built-in functionality or Web controls for managing users' locked out and approved statuses, in part because these decisions need to be handled on a site-by-site basis.</span></span> <span data-ttu-id="2c4b9-116">某些網站可能會自動核准所有新的使用者帳戶 （預設行為）。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-116">Some sites might automatically approve all new user accounts (the default behavior).</span></span> <span data-ttu-id="2c4b9-117">其他讓系統管理員核准新的帳戶，或請勿核准使用者，直到他們瀏覽連結傳送給他們註冊時所提供的電子郵件地址。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-117">Others have an administrator approve new accounts or do not approve users until they visit a link sent to the email address provided when they signed up.</span></span> <span data-ttu-id="2c4b9-118">同樣地，某些網站可能會鎖定使用者直到系統管理員重設其狀態，而其他站台傳送電子郵件給鎖定使用者的 url 可以瀏覽解除鎖定其帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-118">Likewise, some sites may lock out users until an administrator resets their status, while other sites send an email to the locked out user with a URL they can visit to unlock their account.</span></span>

<span data-ttu-id="2c4b9-119">本教學課程示範如何建置網頁，以供系統管理員管理使用者的鎖定，且已核准狀態。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-119">This tutorial shows how to build a web page for administrators to manage users' locked out and approved statuses.</span></span> <span data-ttu-id="2c4b9-120">我們也將了解如何在他們驗證電子郵件地址時，才核准新使用者。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-120">We will also see how to approve new users only after they have verified their email address.</span></span>

## <a name="step-1-managing-users-locked-out-and-approved-statuses"></a><span data-ttu-id="2c4b9-121">步驟 1：管理使用者的鎖定及核准狀態</span><span class="sxs-lookup"><span data-stu-id="2c4b9-121">Step 1: Managing Users' Locked Out and Approved Statuses</span></span>

<span data-ttu-id="2c4b9-122">在  <a id="Tutorial12"> </a> [*選取一個使用者帳戶來建置介面從許多*](building-an-interface-to-select-one-user-account-from-many-cs.md)教學課程，我們已建構的頁面，列出每個使用者帳戶，在分頁，篩選 GridView。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-122">In the <a id="Tutorial12"></a>[*Building an Interface to Select One User Account from Many*](building-an-interface-to-select-one-user-account-from-many-cs.md) tutorial we constructed a page that listed each user account in a paged, filtered GridView.</span></span> <span data-ttu-id="2c4b9-123">此方格會列出每個使用者的名稱和電子郵件、 其已核准與鎖定的狀態，無論是目前在線上，和任何使用者相關的註解。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-123">The grid lists each user's name and email, their approved and locked out statuses, whether they're currently online, and any comments about the user.</span></span> <span data-ttu-id="2c4b9-124">若要管理使用者核准，並鎖定狀態，我們可以把這個方格編輯。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-124">To manage users' approved and locked out statuses, we could make this grid editable.</span></span> <span data-ttu-id="2c4b9-125">若要變更使用者的核准的狀態，系統管理員會先找出的使用者帳戶，並檢查，或取消選取 已核准的核取方塊，然後編輯對應的 GridView 資料列。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-125">To change a user's approved status, the administrator would first locate the user account and then edit the corresponding GridView row, checking or unchecking the approved checkbox.</span></span> <span data-ttu-id="2c4b9-126">或者，我們無法管理的已核准與鎖定的狀態，透過不同的 ASP.NET 頁面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-126">Alternatively, we could manage the approved and locked out statuses through a separate ASP.NET page.</span></span>

<span data-ttu-id="2c4b9-127">本教學課程中我們使用兩個 ASP.NET 網頁：`ManageUsers.aspx`和`UserInformation.aspx`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-127">For this tutorial let's use two ASP.NET pages: `ManageUsers.aspx` and `UserInformation.aspx`.</span></span> <span data-ttu-id="2c4b9-128">這意思是，`ManageUsers.aspx`列出的使用者帳戶在系統中，雖然`UserInformation.aspx`可讓系統管理員管理特定使用者的核准及鎖定狀態。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-128">The idea here is that `ManageUsers.aspx` lists the user accounts in the system, while `UserInformation.aspx` enables the administrator to manage the approved and locked out statuses for a specific user.</span></span> <span data-ttu-id="2c4b9-129">我們第一要務是加強在 GridView`ManageUsers.aspx`包含 HyperLinkField，會轉譯為連結的資料行。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-129">Our first order of business is to augment the GridView in `ManageUsers.aspx` to include a HyperLinkField, which renders as a column of links.</span></span> <span data-ttu-id="2c4b9-130">我們希望每個連結以指向`UserInformation.aspx?user=UserName`，其中*使用者名稱*是要編輯之使用者的名稱。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-130">We want each link to point to `UserInformation.aspx?user=UserName`, where *UserName* is the name of the user to edit.</span></span>

> [!NOTE]
> <span data-ttu-id="2c4b9-131">如果您已下載的程式碼<a id="Tutorial13"> </a> [*復原及變更密碼*](recovering-and-changing-passwords-cs.md)教學課程，您可能已經注意到，`ManageUsers.aspx`頁面已經包含一組"管理 」 的連結和`UserInformation.aspx`頁面會提供介面變更所選的使用者的密碼。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-131">If you downloaded the code for the <a id="Tutorial13"></a>[*Recovering and Changing Passwords*](recovering-and-changing-passwords-cs.md) tutorial you may have noticed that the `ManageUsers.aspx` page already contains a set of "Manage" links and the `UserInformation.aspx` page provides an interface for changing the selected user's password.</span></span> <span data-ttu-id="2c4b9-132">我決定不要複寫這項功能的程式碼，本教學課程與相關聯，因為它由規避 Membership API 和操作直接與 SQL Server 資料庫，若要變更使用者的密碼。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-132">I decided not to replicate that functionality in the code associated with this tutorial because it worked by circumventing the Membership API and operating directly with the SQL Server database to change a user's password.</span></span> <span data-ttu-id="2c4b9-133">本教學課程會使用從頭開始`UserInformation.aspx`頁面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-133">This tutorial starts from scratch with the `UserInformation.aspx` page.</span></span>


### <a name="adding-manage-links-to-theuseraccountsgridview"></a><span data-ttu-id="2c4b9-134">新增 「 管理 」 連結`UserAccounts`GridView</span><span class="sxs-lookup"><span data-stu-id="2c4b9-134">Adding "Manage" Links to the`UserAccounts`GridView</span></span>

<span data-ttu-id="2c4b9-135">開啟`ManageUsers.aspx`頁面上，並新增至 HyperLinkField `UserAccounts` GridView。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-135">Open the `ManageUsers.aspx` page and add a HyperLinkField to the `UserAccounts` GridView.</span></span> <span data-ttu-id="2c4b9-136">設定 HyperLinkField `Text` [管理] 的屬性並將其`DataNavigateUrlFields`和`DataNavigateUrlFormatString`屬性，以`UserName`和 「 UserInformation.aspx?user={0}"分別。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-136">Set the HyperLinkField's `Text` property to "Manage" and its `DataNavigateUrlFields` and `DataNavigateUrlFormatString` properties to `UserName` and "UserInformation.aspx?user={0}", respectively.</span></span> <span data-ttu-id="2c4b9-137">這些設定會使所有的超連結顯示文字 「 管理 」，但每個連結會將 $ 中適當設定 HyperLinkField *UserName*成查詢字串的值。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-137">These settings configure the HyperLinkField such that all of the hyperlinks display the text "Manage", but each link passes in the appropriate *UserName* value into the querystring.</span></span>

<span data-ttu-id="2c4b9-138">加入之後 HyperLinkField GridView，請花一點時間檢視`ManageUsers.aspx`透過瀏覽器的頁面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-138">After adding the HyperLinkField to the GridView, take a moment to view the `ManageUsers.aspx` page through a browser.</span></span> <span data-ttu-id="2c4b9-139">如 [圖 1] 所示，每個 GridView 資料列現在會包含 [管理] 連結。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-139">As Figure 1 shows, each GridView row now includes a "Manage" link.</span></span> <span data-ttu-id="2c4b9-140">Bruce 的 「 管理 」 連結指向`UserInformation.aspx?user=Bruce`，而 Dave 的 「 管理 」 連結指向`UserInformation.aspx?user=Dave`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-140">The "Manage" link for Bruce points to `UserInformation.aspx?user=Bruce`, whereas the "Manage" link for Dave points to `UserInformation.aspx?user=Dave`.</span></span>


<span data-ttu-id="2c4b9-141">[![HyperLinkField 新增](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-141">[![The HyperLinkField Adds a](unlocking-and-approving-user-accounts-cs/_static/image2.png)](unlocking-and-approving-user-accounts-cs/_static/image1.png)</span></span>

<span data-ttu-id="2c4b9-142">**圖 1**:HyperLinkField 新增每個使用者帳戶的 [管理] 連結 ([按一下以檢視完整大小的影像](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="2c4b9-142">**Figure 1**: The HyperLinkField Adds a "Manage" Link for Each User Account  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image3.png))</span></span>


<span data-ttu-id="2c4b9-143">我們將建立的使用者介面，並為撰寫程式碼`UserInformation.aspx`頁面目前為止，但第一個讓我們來討論有關如何以程式設計方式變更使用者的鎖定，且已核准狀態。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-143">We will create the user interface and code for the `UserInformation.aspx` page in a moment, but first let's talk about how to programmatically change a user's locked out and approved statuses.</span></span> <span data-ttu-id="2c4b9-144">[ `MembershipUser`類別](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx)具有[ `IsLockedOut` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx)並[`IsApproved`屬性](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx)。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-144">The [`MembershipUser` class](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx) has [`IsLockedOut`](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx) and [`IsApproved` properties](https://msdn.microsoft.com/library/system.web.security.membershipuser.isapproved.aspx).</span></span> <span data-ttu-id="2c4b9-145">`IsLockedOut`屬性是唯讀的。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-145">The `IsLockedOut` property is read-only.</span></span> <span data-ttu-id="2c4b9-146">沒有任何機制來以程式設計方式鎖定使用者;若要解除鎖定使用者，請使用`MembershipUser`類別的[`UnlockUser`方法](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-146">There is no mechanism to programmatically lock out a user; to unlock a user, use the `MembershipUser` class's [`UnlockUser` method](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).</span></span> <span data-ttu-id="2c4b9-147">`IsApproved`屬性可讀取和寫入。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-147">The `IsApproved` property is readable and writeable.</span></span> <span data-ttu-id="2c4b9-148">若要儲存這個屬性的任何變更，我們必須呼叫`Membership`類別的[`UpdateUser`方法](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx)，並傳入已修改`MembershipUser`物件。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-148">To save any changes to this property, we need to call the `Membership` class's [`UpdateUser` method](https://msdn.microsoft.com/library/system.web.security.membership.updateuser.aspx), passing in the modified `MembershipUser` object.</span></span>

<span data-ttu-id="2c4b9-149">因為`IsApproved`屬性讀取和寫入，核取方塊控制項可能是最佳的使用者介面項目來設定這個屬性。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-149">Because the `IsApproved` property is readable and writeable, a CheckBox control is probably the best user interface element for configuring this property.</span></span> <span data-ttu-id="2c4b9-150">不過，核取方塊並不適用於`IsLockedOut`屬性因為系統管理員無法鎖定使用者，她可能只能解除鎖定使用者。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-150">However, a CheckBox will not work for the `IsLockedOut` property because an administrator cannot lock out a user, she may only unlock a user.</span></span> <span data-ttu-id="2c4b9-151">適當的使用者介面，讓`IsLockedOut`屬性是一個按鈕，按一下時，會解除鎖定使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-151">A suitable user interface for the `IsLockedOut` property is a Button that, when clicked, unlocks the user account.</span></span> <span data-ttu-id="2c4b9-152">如果使用者遭到鎖定，才應該啟用此按鈕。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-152">This Button should only be enabled if the user is locked out.</span></span>

### <a name="creating-theuserinformationaspxpage"></a><span data-ttu-id="2c4b9-153">建立`UserInformation.aspx`頁面</span><span class="sxs-lookup"><span data-stu-id="2c4b9-153">Creating the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="2c4b9-154">現在，我們已準備好要實作中的使用者介面`UserInformation.aspx`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-154">We are now ready to implement the user interface in `UserInformation.aspx`.</span></span> <span data-ttu-id="2c4b9-155">開啟此頁面，並加入下列的 Web 控制項：</span><span class="sxs-lookup"><span data-stu-id="2c4b9-155">Open this page and add the following Web controls:</span></span>

- <span data-ttu-id="2c4b9-156">超連結控制項，按一下時，會傳回系統管理員`ManageUsers.aspx`頁面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-156">A HyperLink control that, when clicked, returns the administrator to the `ManageUsers.aspx` page.</span></span>
- <span data-ttu-id="2c4b9-157">顯示選取的使用者名稱標籤 Web 控制項。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-157">A Label Web control for displaying the selected user's name.</span></span> <span data-ttu-id="2c4b9-158">設定此標籤`ID`要`UserNameLabel`並清除其`Text`屬性。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-158">Set this Label's `ID` to `UserNameLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="2c4b9-159">核取方塊控制項，名為`IsApproved`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-159">A CheckBox control named `IsApproved`.</span></span> <span data-ttu-id="2c4b9-160">設定其`AutoPostBack`屬性設`true`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-160">Set its `AutoPostBack` property to `true`.</span></span>
- <span data-ttu-id="2c4b9-161">Label 控制項來顯示使用者上次的鎖定的日期。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-161">A Label control for displaying the user's last locked out date.</span></span> <span data-ttu-id="2c4b9-162">此標籤`LastLockedOutDateLabel`並清除其`Text`屬性。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-162">Name this Label `LastLockedOutDateLabel` and clear out its `Text` property.</span></span>
- <span data-ttu-id="2c4b9-163">解除鎖定使用者的按鈕。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-163">A Button for unlocking the user.</span></span> <span data-ttu-id="2c4b9-164">此按鈕命名`UnlockUserButton`並設定其`Text`為 「 解除鎖定使用者 」 的屬性。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-164">Name this Button `UnlockUserButton` and set its `Text` property to "Unlock User".</span></span>
- <span data-ttu-id="2c4b9-165">Label 控制項用於顯示狀態訊息，例如 「 已更新使用者的核准的狀態 」。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-165">A Label control for displaying status messages, such as, "The user's approved status has been updated."</span></span> <span data-ttu-id="2c4b9-166">此控制項`StatusMessage`，清除出其`Text`屬性，並設定其`CssClass`屬性設`Important`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-166">Name this control `StatusMessage`, clear out its `Text` property, and set its `CssClass` property to `Important`.</span></span> <span data-ttu-id="2c4b9-167">( `Important` CSS 類別定義於`Styles.css`樣式表檔案，在大型的紅色字型顯示相對應的文字。)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-167">(The `Important` CSS class is defined in the `Styles.css` stylesheet file; it displays the corresponding text in a large, red font.)</span></span>

<span data-ttu-id="2c4b9-168">之後加入這些控制項，在 Visual Studio 中的 [設計] 檢視看起來應該類似於圖 2 螢幕擷取畫面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-168">After adding these controls, the Design view in Visual Studio should look similar to the screen shot in Figure 2.</span></span>


<span data-ttu-id="2c4b9-169">[![建立 UserInformation.aspx 的使用者介面](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-169">[![Create the User Interface for UserInformation.aspx](unlocking-and-approving-user-accounts-cs/_static/image5.png)](unlocking-and-approving-user-accounts-cs/_static/image4.png)</span></span>

<span data-ttu-id="2c4b9-170">**圖 2**:建立的使用者介面`UserInformation.aspx`([按一下以檢視完整大小的影像](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="2c4b9-170">**Figure 2**: Create the User Interface for `UserInformation.aspx` ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image6.png))</span></span>


<span data-ttu-id="2c4b9-171">使用者介面完成後下, 一步是設定`IsApproved`核取方塊和其他控制項根據所選的使用者的資訊。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-171">With the user interface complete, our next task is to set the `IsApproved` CheckBox and other controls based on the selected user's information.</span></span> <span data-ttu-id="2c4b9-172">建立網頁的事件處理常式`Load`事件，並新增下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="2c4b9-172">Create an event handler for the page's `Load` event and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample1.cs)]

<span data-ttu-id="2c4b9-173">上述程式碼一開始會確保這第一次造訪的網頁和不後續的回傳。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-173">The above code starts by ensuring that this is the first visit to the page and not a subsequent postback.</span></span> <span data-ttu-id="2c4b9-174">它接著會讀取傳遞的使用者名稱`user`查詢字串欄位，並擷取透過該使用者帳戶的相關資訊`Membership.GetUser(username)`方法。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-174">It then reads the username passed through the `user` querystring field and retrieves information about that user account via the `Membership.GetUser(username)` method.</span></span> <span data-ttu-id="2c4b9-175">如果不需要使用者名稱已提供透過查詢字串，或如果找不到指定的使用者，系統管理員會送回到`ManageUsers.aspx`頁面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-175">If no username was supplied through the querystring, or if the specified user could not be found, the administrator is sent back to the `ManageUsers.aspx` page.</span></span>

<span data-ttu-id="2c4b9-176">`MembershipUser`物件的`UserName`值，即會顯示在`UserNameLabel`並`IsApproved`核取方塊已根據`IsApproved`屬性值。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-176">The `MembershipUser` object's `UserName` value is then displayed in the `UserNameLabel` and the `IsApproved` CheckBox is checked based on the `IsApproved` property value.</span></span>

<span data-ttu-id="2c4b9-177">`MembershipUser`物件的[`LastLockoutDate`屬性](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx)傳回`DateTime`值，指出使用者上次遭鎖定。如果使用者被鎖定時，傳回的值取決於成員資格提供者。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-177">The `MembershipUser` object's [`LastLockoutDate` property](https://msdn.microsoft.com/library/system.web.security.membershipuser.lastlockoutdate.aspx) returns a `DateTime` value indicating when the user was last locked out. If the user has never been locked out, the value returned depends on the Membership provider.</span></span> <span data-ttu-id="2c4b9-178">建立新的帳戶時，`SqlMembershipProvider`設定`aspnet_Membership`資料表的`LastLockoutDate`欄位到`1754-01-01 12:00:00 AM`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-178">When a new account is created, the `SqlMembershipProvider` sets the `aspnet_Membership` table's `LastLockoutDate` field to `1754-01-01 12:00:00 AM`.</span></span> <span data-ttu-id="2c4b9-179">上述程式碼會顯示中的空字串`LastLockoutDateLabel`如果`LastLockoutDate`屬性，就會發生年份的前 2000年，否則的日期部分`LastLockoutDate`屬性會顯示在標籤中。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-179">The above code displays an empty string in the `LastLockoutDateLabel` if the `LastLockoutDate` property occurs before year 2000; otherwise, the date portion of the `LastLockoutDate` property is displayed in the Label.</span></span> <span data-ttu-id="2c4b9-180">`UnlockUserButton'` s`Enabled`屬性設定為使用者的鎖定狀態，這表示如果使用者遭到鎖定，才會啟用此按鈕。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-180">The `UnlockUserButton'` s `Enabled` property is set to the user's locked out status, meaning that this Button will only be enabled if the user is locked out.</span></span>

<span data-ttu-id="2c4b9-181">請花一點時間測試`UserInformation.aspx`透過瀏覽器的頁面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-181">Take a moment to test the `UserInformation.aspx` page through a browser.</span></span> <span data-ttu-id="2c4b9-182">當然，必須在開始`ManageUsers.aspx`，然後選取要管理的使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-182">You will, of course, need to start at `ManageUsers.aspx` and select a user account to manage.</span></span> <span data-ttu-id="2c4b9-183">在抵達`UserInformation.aspx`，請注意，`IsApproved`如果使用者核准，才會檢查核取方塊。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-183">Upon arriving at `UserInformation.aspx`, note that the `IsApproved` CheckBox is only checked if the user is approved.</span></span> <span data-ttu-id="2c4b9-184">如果使用者曾被鎖定時，會顯示其最後一個鎖定的日期。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-184">If the user has ever been locked out, their last locked out date is displayed.</span></span> <span data-ttu-id="2c4b9-185">只有當使用者目前已鎖定，則會啟用 解除鎖定使用者 按鈕。檢查或取消選取 `IsApproved`核取方塊，或按一下 解除鎖定使用者 按鈕會導致回傳，但不修改的使用者帳戶因為我們至今還建立這些事件的事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-185">The Unlock User button is enabled only if the user is currently locked out. Checking or unchecking the `IsApproved` CheckBox or clicking the Unlock User button causes a postback, but no modifications are made to the user account because we've yet to create event handlers for these events.</span></span>

<span data-ttu-id="2c4b9-186">返回 Visual Studio 並建立事件處理常式`IsApproved`核取方塊的`CheckedChanged`事件並`UnlockUser` 按鈕的`Click`事件。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-186">Return to Visual Studio and create event handlers for the `IsApproved` CheckBox's `CheckedChanged` event and the `UnlockUser` Button's `Click` event.</span></span> <span data-ttu-id="2c4b9-187">在 `CheckedChanged`事件處理常式中，設定使用者的`IsApproved`屬性設`Checked`屬性的核取方塊，然後儲存變更，透過對呼叫`Membership.UpdateUser`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-187">In the `CheckedChanged` event handler, set the user's `IsApproved` property to the `Checked` property of the CheckBox and then save the changes via a call to `Membership.UpdateUser`.</span></span> <span data-ttu-id="2c4b9-188">在 `Click`事件處理常式，只需呼叫`MembershipUser`物件的`UnlockUser`方法。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-188">In the `Click` event handler, simply call the `MembershipUser` object's `UnlockUser` method.</span></span> <span data-ttu-id="2c4b9-189">在這兩個事件處理常式中，會顯示在適當的訊息`StatusMessage`標籤。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-189">In both event handlers, display a suitable message in the `StatusMessage` Label.</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample2.cs)]

### <a name="testing-theuserinformationaspxpage"></a><span data-ttu-id="2c4b9-190">測試`UserInformation.aspx`頁面</span><span class="sxs-lookup"><span data-stu-id="2c4b9-190">Testing the`UserInformation.aspx`Page</span></span>

<span data-ttu-id="2c4b9-191">在發生這些事件處理常式，重新瀏覽的頁面和未經核准的使用者。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-191">With these event handlers in place, revisit the page and unapproved a user.</span></span> <span data-ttu-id="2c4b9-192">如 [圖 3] 所示，您應該會看到訊息指出此頁面上使用者的簡短`IsApproved`已成功修改屬性。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-192">As Figure 3 shows, you should see a brief message on the page indicating that the user's `IsApproved` property was successfully modified.</span></span>


<span data-ttu-id="2c4b9-193">[![Chris 已經未核准](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-193">[![Chris has been Unapproved](unlocking-and-approving-user-accounts-cs/_static/image8.png)](unlocking-and-approving-user-accounts-cs/_static/image7.png)</span></span>

<span data-ttu-id="2c4b9-194">**圖 3**:Chris 已經未核准 ([按一下以檢視完整大小的影像](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="2c4b9-194">**Figure 3**: Chris has been Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image9.png))</span></span>


<span data-ttu-id="2c4b9-195">接下來，登出，然後嘗試使用者身分，登入帳戶是只要未經核准。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-195">Next, logout and try to login as the user whose account was just unapproved.</span></span> <span data-ttu-id="2c4b9-196">使用者未獲得核准，因為它們無法登入。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-196">Because the user is not approved, they cannot login.</span></span> <span data-ttu-id="2c4b9-197">根據預設，登入控制項可顯示相同的訊息，如果使用者無法登入，不論原因為何。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-197">By default, the Login control displays the same message if the user cannot login, regardless of the reason.</span></span> <span data-ttu-id="2c4b9-198">但在<a id="Tutorial6"> </a> [*驗證使用者認證對成員資格使用者存放區*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md)教學課程中我們探討了增強的登入控制項來顯示更適當的訊息。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-198">But in the <a id="Tutorial6"></a>[*Validating User Credentials Against the Membership User Store*](../membership/validating-user-credentials-against-the-membership-user-store-cs.md) tutorial we looked at enhancing the Login control to display a more appropriate message.</span></span> <span data-ttu-id="2c4b9-199">如 [圖 4] 所示，Chris 會顯示訊息，說明他無法登入因為他的帳戶尚未核准。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-199">As Figure 4 shows, Chris is shown a message explaining that he cannot login because his account is not yet approved.</span></span>


<span data-ttu-id="2c4b9-200">[![Chris 無法登入因為 His 帳戶是未核准](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-200">[![Chris Cannot Login Because His Account is Unapproved](unlocking-and-approving-user-accounts-cs/_static/image11.png)](unlocking-and-approving-user-accounts-cs/_static/image10.png)</span></span>

<span data-ttu-id="2c4b9-201">**圖 4**:Chris 無法登入因為 His 帳戶是未核准 ([按一下以檢視完整大小的影像](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="2c4b9-201">**Figure 4**: Chris Cannot Login Because His Account is Unapproved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image12.png))</span></span>


<span data-ttu-id="2c4b9-202">若要測試鎖定的功能，請嘗試已核准的使用者身分登入，但使用不正確的密碼。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-202">To test the locked out functionality, attempt to login as an approved user, but use an incorrect password.</span></span> <span data-ttu-id="2c4b9-203">重複此程序所需的次數之前使用者的帳戶已被鎖定。Login 控制項也已更新以顯示自訂訊息，如果嘗試從鎖定的帳戶登入。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-203">Repeat this process the necessary number of times until the user's account has been locked out. The Login control was also updated to show a custom message if attempting to login from a locked out account.</span></span> <span data-ttu-id="2c4b9-204">您知道該帳戶已被鎖定之後您會開始看到登入頁面的下列訊息：「 您的帳戶已經鎖定時因為無效的登入嘗試次數過多。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-204">You know that an account has been locked out once you start seeing the following message at the login page: "Your account has been locked out because of too many invalid login attempts.</span></span> <span data-ttu-id="2c4b9-205">請連絡系統管理員將您的帳戶解除鎖定。 」</span><span class="sxs-lookup"><span data-stu-id="2c4b9-205">Please contact the administrator to have your account unlocked."</span></span>

<span data-ttu-id="2c4b9-206">返回`ManageUsers.aspx`頁面上，按一下 鎖定使用者的 管理 連結。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-206">Return to the `ManageUsers.aspx` page and click the Manage link for the locked out user.</span></span> <span data-ttu-id="2c4b9-207">如 [圖 5] 所示，您應該會看到中的值`LastLockedOutDateLabel`解除鎖定使用者按鈕應會啟用。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-207">As Figure 5 shows, you should see a value in the `LastLockedOutDateLabel` the Unlock User button should be enabled.</span></span> <span data-ttu-id="2c4b9-208">按一下 [解除鎖定使用者] 按鈕，以解除鎖定使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-208">Click the Unlock User button to unlock the user account.</span></span> <span data-ttu-id="2c4b9-209">一旦您已解鎖使用者，他們將能夠再次登入。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-209">Once you have unlocked the user, they will be able to login again.</span></span>


<span data-ttu-id="2c4b9-210">[![Dave 已被鎖定系統](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-210">[![Dave Has Been Locked Out of the System](unlocking-and-approving-user-accounts-cs/_static/image14.png)](unlocking-and-approving-user-accounts-cs/_static/image13.png)</span></span>

<span data-ttu-id="2c4b9-211">**圖 5**:Dave 有已鎖定的系統 ([按一下以檢視完整大小的影像](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="2c4b9-211">**Figure 5**: Dave Has Been Locked Out of the System  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image15.png))</span></span>


## <a name="step-2-specifying-new-users-approved-status"></a><span data-ttu-id="2c4b9-212">步驟 2：指定新使用者的核准狀態</span><span class="sxs-lookup"><span data-stu-id="2c4b9-212">Step 2: Specifying New Users' Approved Status</span></span>

<span data-ttu-id="2c4b9-213">已核准的狀態是在您想要新的使用者就能夠將登入並存取該網站的使用者特定功能之前要執行某些動作的情況下很有用。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-213">The approved status is useful in scenarios where you want some action to be performed before a new user is able to login and access the user-specific features of the site.</span></span> <span data-ttu-id="2c4b9-214">例如，您可能會執行私用網站所有頁面，除了登入和註冊頁面，其中都是僅供已驗證的使用者存取。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-214">For example, you may be running a private website where all pages, except for the login and signup pages, are accessible only to authenticated users.</span></span> <span data-ttu-id="2c4b9-215">但要是完全達到您的網站，尋找 [註冊] 頁面中，會建立一個帳戶？</span><span class="sxs-lookup"><span data-stu-id="2c4b9-215">But what happens if a stranger reaches your website, finds the signup page, and creates an account?</span></span> <span data-ttu-id="2c4b9-216">若要避免這種情況中，您無法移動註冊頁面以`Administration`資料夾中，而且需要系統管理員手動建立每個帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-216">To prevent this from happening you could move the signup page to an `Administration` folder, and require that an administrator manually create each account.</span></span> <span data-ttu-id="2c4b9-217">或者，您可以允許任何人註冊，但禁止網站存取權，直到系統管理員核准的使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-217">Alternatively, you could allow anyone to signup, but prohibit site access until an administrator approves the user account.</span></span>

<span data-ttu-id="2c4b9-218">根據預設，CreateUserWizard 控制項核准新的帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-218">By default, the CreateUserWizard control approves new accounts.</span></span> <span data-ttu-id="2c4b9-219">您可以設定此控制項的行為[`DisableCreatedUser`屬性](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-219">You can configure this behavior using the control's [`DisableCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.disablecreateduser.aspx).</span></span> <span data-ttu-id="2c4b9-220">將此屬性設定為`true`不核准新的使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-220">Set this property to `true` to not approve new user accounts.</span></span>

> [!NOTE]
> <span data-ttu-id="2c4b9-221">預設 CreateUserWizard 控制項自動登入新的使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-221">By default the CreateUserWizard control automatically logs on the new user account.</span></span> <span data-ttu-id="2c4b9-222">此行為取決於控制項的[`LoginCreatedUser`屬性](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx)。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-222">This behavior is dictated by the control's [`LoginCreatedUser` property](https://msdn.microsoft.com/en-gb/library/system.web.ui.webcontrols.createuserwizard.logincreateduser.aspx).</span></span> <span data-ttu-id="2c4b9-223">因為未核准的使用者無法登入網站時`DisableCreatedUser`已`true`新的使用者帳戶未登入站台，不論值`LoginCreatedUser`屬性。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-223">Because unapproved users cannot login to the site, when `DisableCreatedUser` is `true` the new user account is not logged into the site, regardless of the value of the `LoginCreatedUser` property.</span></span>


<span data-ttu-id="2c4b9-224">如果您要以程式設計方式建立新的使用者帳戶，透過`Membership.CreateUser`方法中，建立未經核准的使用者帳戶使用其中一個多載會接受新使用者的`IsApproved`做為輸入參數的屬性值。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-224">If you are programmatically creating new user accounts via the `Membership.CreateUser` method, to create an unapproved user account use one of the overloads that accept the new user's `IsApproved` property value as an input parameter.</span></span>

## <a name="step-3-approving-users-by-verifying-their-email-address"></a><span data-ttu-id="2c4b9-225">步驟 3：核准使用者藉由驗證電子郵件地址</span><span class="sxs-lookup"><span data-stu-id="2c4b9-225">Step 3: Approving Users By Verifying their Email Address</span></span>

<span data-ttu-id="2c4b9-226">支援使用者帳戶的許多網站請勿核准新使用者，直到他們會驗證他們在註冊時提供的電子郵件地址。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-226">Many websites that support user accounts do not approve new users until they verify the email address they supplied when registering.</span></span> <span data-ttu-id="2c4b9-227">這個驗證程序常用來阻止 bot、 濫發垃圾郵件者和其他 ne'er-do-wells，因為它需要唯一的、 已驗證的電子郵件地址，並在註冊程序中新增額外的步驟。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-227">This verification process is commonly used to thwart bots, spammers, and other ne'er-do-wells as it requires a unique, verified email address and adds an extra step in the signup process.</span></span> <span data-ttu-id="2c4b9-228">使用此模型中，新的使用者註冊時傳送電子郵件訊息，其中包含驗證頁面的連結。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-228">With this model, when a new user signs up they are sent an email message that includes a link to a verification page.</span></span> <span data-ttu-id="2c4b9-229">瀏覽連結使用者證明他們有收到電子郵件，因此，電子郵件地址，前提是有效。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-229">By visiting the link the user has proven that they received the email and, therefore, that the email address provided is valid.</span></span> <span data-ttu-id="2c4b9-230">[驗證] 頁面會負責核准的使用者。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-230">The verification page is responsible for approving the user.</span></span> <span data-ttu-id="2c4b9-231">這可能會自動發生，藉此核准到達此頁面上，任何使用者或使用者提供一些額外的資訊，例如之後，才[CAPTCHA](http://en.wikipedia.org/wiki/Captcha)。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-231">This may happen automatically, thereby approving any user who reaches this page, or only after the user provides some additional information, such as a [CAPTCHA](http://en.wikipedia.org/wiki/Captcha).</span></span>

<span data-ttu-id="2c4b9-232">為了符合此工作流程，我們需要先更新帳戶的 [建立] 頁面，以便讓新的使用者未經核准。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-232">To accommodate this workflow, we need to first update the account creation page so that new users are unapproved.</span></span> <span data-ttu-id="2c4b9-233">開啟`EnhancedCreateUserWizard.aspx`頁面中`Membership`資料夾，然後設定 CreateUserWizard 控制項的`DisableCreatedUser`屬性設`true`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-233">Open the `EnhancedCreateUserWizard.aspx` page in the `Membership` folder and set the CreateUserWizard control's `DisableCreatedUser` property to `true`.</span></span>

<span data-ttu-id="2c4b9-234">接下來，我們需要設定 CreateUserWizard 控制項傳送給新的使用者，以驗證其帳戶指示的電子郵件。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-234">Next, we need to configure the CreateUserWizard control to send an email to the new user with instructions on how to verify their account.</span></span> <span data-ttu-id="2c4b9-235">特別是，我們將電子郵件中包含的連結`Verification.aspx`頁面上 (這我們至今還建立)，並傳入新使用者的`UserId`透過查詢字串。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-235">In particular, we will include a link in the email to the `Verification.aspx` page (which we've yet to create), passing in the new user's `UserId` through the querystring.</span></span> <span data-ttu-id="2c4b9-236">`Verification.aspx`會查閱指定的使用者 頁面，並將其標示核准它們。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-236">The `Verification.aspx` page will lookup the specified user and mark them approved.</span></span>

### <a name="sending-a-verification-email-to-new-users"></a><span data-ttu-id="2c4b9-237">將驗證電子郵件傳送給新使用者</span><span class="sxs-lookup"><span data-stu-id="2c4b9-237">Sending a Verification Email to New Users</span></span>

<span data-ttu-id="2c4b9-238">若要從 CreateUserWizard 控制項傳送一封電子郵件，設定其`MailDefinition`屬性適當地。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-238">To send an email from the CreateUserWizard control, configure its `MailDefinition` property appropriately.</span></span> <span data-ttu-id="2c4b9-239">中所述<a id="Tutorial13"> </a>[先前的教學課程](recovering-and-changing-passwords-cs.md)，包含 「 變更密碼 」 和 「 Provider 控制項[`MailDefinition`屬性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx)的運作方式與CreateUserWizard 控制項。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-239">As discussed in the <a id="Tutorial13"></a>[previous tutorial](recovering-and-changing-passwords-cs.md), the ChangePassword and PasswordRecovery controls include a [`MailDefinition` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.maildefinition.aspx) that works in the same manner as the CreateUserWizard control's.</span></span>

> [!NOTE]
> <span data-ttu-id="2c4b9-240">若要使用`MailDefinition`中的屬性，您必須指定郵件的傳遞選項`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-240">To use the `MailDefinition` property you need to specify mail delivery options in `Web.config`.</span></span> <span data-ttu-id="2c4b9-241">如需詳細資訊，請參閱[在 ASP.NET 中的 傳送電子郵件](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-241">For more information, refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx).</span></span>


<span data-ttu-id="2c4b9-242">建立名為的新電子郵件範本著手`CreateUserWizard.txt`在`EmailTemplates`資料夾。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-242">Start by creating a new email template named `CreateUserWizard.txt` in the `EmailTemplates` folder.</span></span> <span data-ttu-id="2c4b9-243">範本中使用下列文字：</span><span class="sxs-lookup"><span data-stu-id="2c4b9-243">Use the following text for the template:</span></span>

[!code-aspx[Main](unlocking-and-approving-user-accounts-cs/samples/sample3.aspx)]

<span data-ttu-id="2c4b9-244">設定`MailDefinition'`s`BodyFileName`屬性，以"~ / EmailTemplates/CreateUserWizard.txt"並將其`Subject`屬性，以 「 歡迎使用我的網站 ！</span><span class="sxs-lookup"><span data-stu-id="2c4b9-244">Set the `MailDefinition'` s `BodyFileName` property to "~/EmailTemplates/CreateUserWizard.txt" and its `Subject` property to "Welcome to My Website!</span></span> <span data-ttu-id="2c4b9-245">請啟用您的帳戶。 」</span><span class="sxs-lookup"><span data-stu-id="2c4b9-245">Please activate your account."</span></span>

<span data-ttu-id="2c4b9-246">請注意，`CreateUserWizard.txt`電子郵件範本包含`<%VerificationUrl%>`預留位置。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-246">Note that the `CreateUserWizard.txt` email template includes a `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="2c4b9-247">這正是 URL`Verification.aspx`會置於頁面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-247">This is where the URL for the `Verification.aspx` page will be placed.</span></span> <span data-ttu-id="2c4b9-248">會自動取代 CreateUserWizard`<%UserName%>`並`<%Password%>`預留位置取代為新的帳戶使用者名稱和密碼，但沒有任何內建`<%VerificationUrl%>`預留位置。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-248">The CreateUserWizard automatically replaces the `<%UserName%>` and `<%Password%>` placeholders with the new account's username and password, but there is no built-in `<%VerificationUrl%>` placeholder.</span></span> <span data-ttu-id="2c4b9-249">我們需要以手動方式將它取代適當的驗證 URL。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-249">We need to manually replace it with the appropriate verification URL.</span></span>

<span data-ttu-id="2c4b9-250">若要達成此目的，建立事件處理常式 CreateUserWizard [ `SendingMail`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx)並加入下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="2c4b9-250">To accomplish this, create an event handler for the CreateUserWizard's [`SendingMail` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.sendingmail.aspx) and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample4.cs)]

<span data-ttu-id="2c4b9-251">`SendingMail`事件引發之後`CreatedUser`事件，這表示，上述的事件處理常式執行新的使用者時的帳戶已經存在。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-251">The `SendingMail` event fires after the `CreatedUser` event, meaning that by the time the above event handler executes the new user account has already been created.</span></span> <span data-ttu-id="2c4b9-252">我們可以存取新的使用者`UserId`值，藉由呼叫`Membership.GetUser`方法並傳入`UserName`CreateUserWizard 控制項中輸入。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-252">We can access the new user's `UserId` value by calling the `Membership.GetUser` method, passing in the `UserName` entered into the CreateUserWizard control.</span></span> <span data-ttu-id="2c4b9-253">接下來，會形成驗證 URL。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-253">Next, the verification URL is formed.</span></span> <span data-ttu-id="2c4b9-254">陳述式`Request.Url.GetLeftPart(UriPartial.Authority)`傳回`http://yourserver.com`一部分 URL;`Request.ApplicationPath`傳回路徑的應用程式的根位置。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-254">The statement `Request.Url.GetLeftPart(UriPartial.Authority)` returns the `http://yourserver.com` portion of the URL; `Request.ApplicationPath` returns path where the application is rooted.</span></span> <span data-ttu-id="2c4b9-255">驗證 URL 定義為`Verification.aspx?ID=userId`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-255">The verification URL is then defined as `Verification.aspx?ID=userId`.</span></span> <span data-ttu-id="2c4b9-256">然後這兩個字串串連來形成完整的 URL。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-256">These two strings are then concatenated to form the complete URL.</span></span> <span data-ttu-id="2c4b9-257">最後，電子郵件訊息內文 (`e.Message.Body`) 具有所有發生次數`<%VerificationUrl%>`取代完整的 URL。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-257">Finally, the email message body (`e.Message.Body`) has all occurrences of `<%VerificationUrl%>` replaced with the full URL.</span></span>

<span data-ttu-id="2c4b9-258">實質效果是新的使用者未經核准，這表示它們無法登入網站。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-258">The net effect is that new users are unapproved, meaning that they cannot log into the site.</span></span> <span data-ttu-id="2c4b9-259">此外，它們會自動傳送電子郵件，內含連結至驗證 URL （請參閱 圖 6）。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-259">Furthermore, they are automatically sent an email with a link to the verification URL (see Figure 6).</span></span>


<span data-ttu-id="2c4b9-260">[![新的使用者會收到一封電子郵件驗證 URL 的連結](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-260">[![The New User Receives an Email with a Link to the Verification URL](unlocking-and-approving-user-accounts-cs/_static/image17.png)](unlocking-and-approving-user-accounts-cs/_static/image16.png)</span></span>

<span data-ttu-id="2c4b9-261">**圖 6**:新的使用者會收到一封電子郵件驗證 URL 的連結 ([按一下以檢視完整大小的影像](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="2c4b9-261">**Figure 6**: The New User Receives an Email with a Link to the Verification URL  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image18.png))</span></span>


> [!NOTE]
> <span data-ttu-id="2c4b9-262">CreateUserWizard 控制項的預設 CreateUserWizard 步驟會顯示訊息，通知的使用者他們的帳戶已建立，並顯示 [繼續] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-262">The CreateUserWizard control's default CreateUserWizard step displays a message informing the user their account has been created and displays a Continue button.</span></span> <span data-ttu-id="2c4b9-263">按一下這會將使用者帶至由控制項的指定的 URL`ContinueDestinationPageUrl`屬性。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-263">Clicking this takes the user to the URL specified by the control's `ContinueDestinationPageUrl` property.</span></span> <span data-ttu-id="2c4b9-264">在 CreateUserWizard`EnhancedCreateUserWizard.aspx`設定為傳送給新使用者`~/Membership/AdditionalUserInfo.aspx`，這時系統會提示使用者輸入他們的出生地、 首頁 URL 和簽章。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-264">The CreateUserWizard in `EnhancedCreateUserWizard.aspx` is configured to send new users to the `~/Membership/AdditionalUserInfo.aspx`, which prompts the user for their hometown, homepage URL, and signature.</span></span> <span data-ttu-id="2c4b9-265">因為這項資訊可以只新增登入的使用者，所以合理更新這個屬性，以將使用者傳送回站台的首頁 (`~/Default.aspx`)。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-265">Because this information can only be added by logged on users, it makes sense to update this property to send users back to the site's homepage (`~/Default.aspx`).</span></span> <span data-ttu-id="2c4b9-266">此外，`EnhancedCreateUserWizard.aspx`頁面或 CreateUserWizard 步驟應該予以增加以通知使用者已傳送驗證電子郵件，以及它們遵循這封電子郵件中的指示之前，不會啟用其帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-266">Moreover, the `EnhancedCreateUserWizard.aspx` page or the CreateUserWizard step should be augmented to inform the user that they have been sent a verification email and their account won't be activated until they follow the instructions in this email.</span></span> <span data-ttu-id="2c4b9-267">我可以作為練習，保留這些修改來讀取器。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-267">I leave these modifications as an exercise for the reader.</span></span>


### <a name="creating-the-verification-page"></a><span data-ttu-id="2c4b9-268">建立 [驗證] 頁面</span><span class="sxs-lookup"><span data-stu-id="2c4b9-268">Creating the Verification Page</span></span>

<span data-ttu-id="2c4b9-269">最後一項工作是建立`Verification.aspx`頁面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-269">Our final task is to create the `Verification.aspx` page.</span></span> <span data-ttu-id="2c4b9-270">將此頁面新增至根資料夾中，將它與`Site.master`主版頁面。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-270">Add this page to the root folder, associating it with the `Site.master` master page.</span></span> <span data-ttu-id="2c4b9-271">我們已在先前的內容頁面，新增至網站的大部分完成之後，移除參考的內容控制項`LoginContent`ContentPlaceHolder 使 [內容] 頁面會使用主版頁面的預設內容。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-271">As we've done with most of the previous content pages added to the site, remove the Content control that references the `LoginContent` ContentPlaceHolder so that the content page uses the master page's default content.</span></span>

<span data-ttu-id="2c4b9-272">加入標籤 Web 控制項來`Verification.aspx`頁面上，將其`ID`到`StatusMessage`和清除其 text 屬性。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-272">Add a Label Web control to the `Verification.aspx` page, set its `ID` to `StatusMessage` and clear out its text property.</span></span> <span data-ttu-id="2c4b9-273">接下來，建立`Page_Load`事件處理常式，並新增下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="2c4b9-273">Next, create the `Page_Load` event handler and add the following code:</span></span>

[!code-csharp[Main](unlocking-and-approving-user-accounts-cs/samples/sample5.cs)]

<span data-ttu-id="2c4b9-274">大部分的上述程式碼會確認`UserId`提供透過查詢字串存在，它是有效`Guid`值，而且它會參考現有的使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-274">The bulk of the above code verifies that the `UserId` supplied through the querystring exists, that it is a valid `Guid` value, and that it references an existing user account.</span></span> <span data-ttu-id="2c4b9-275">如果所有檢查都通過，已核准的使用者帳戶;否則，會顯示適當的狀態訊息。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-275">If all of these checks pass, the user account is approved; otherwise, a suitable status message is displayed.</span></span>

<span data-ttu-id="2c4b9-276">[圖 7] 顯示`Verification.aspx`頁面上，當透過瀏覽器瀏覽。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-276">Figure 7 shows the `Verification.aspx` page when visited through a browser.</span></span>


<span data-ttu-id="2c4b9-277">[![新的使用者帳戶是現在核准](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-277">[![The New User's Account is Now Approved](unlocking-and-approving-user-accounts-cs/_static/image20.png)](unlocking-and-approving-user-accounts-cs/_static/image19.png)</span></span>

<span data-ttu-id="2c4b9-278">**圖 7**:新的使用者帳戶是現在核准 ([按一下以檢視完整大小的影像](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="2c4b9-278">**Figure 7**: The New User's Account is Now Approved  ([Click to view full-size image](unlocking-and-approving-user-accounts-cs/_static/image21.png))</span></span>


## <a name="summary"></a><span data-ttu-id="2c4b9-279">總結</span><span class="sxs-lookup"><span data-stu-id="2c4b9-279">Summary</span></span>

<span data-ttu-id="2c4b9-280">成員資格的所有使用者帳戶都有兩個決定使用者是否可以登入網站的狀態：`IsLockedOut`和`IsApproved`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-280">All Membership user accounts have two statuses that determine whether the user can log into the site: `IsLockedOut` and `IsApproved`.</span></span> <span data-ttu-id="2c4b9-281">這兩個屬性必須是`true`登入使用者。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-281">Both of these properties must be `true` for the user to login.</span></span>

<span data-ttu-id="2c4b9-282">使用者的鎖定狀態使用基於安全性考量，以減少駭客透過暴力密碼破解方法分成多站台的可能性。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-282">The user's locked out status is used as a security measure to reduce the likelihood of a hacker breaking into a site through brute force methods.</span></span> <span data-ttu-id="2c4b9-283">具體而言，將使用者鎖定時，如果有特定數目的特定時段內無效的登入嘗試。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-283">Specifically, a user is locked out if there are a certain number of invalid login attempts within a certain window of time.</span></span> <span data-ttu-id="2c4b9-284">這些範圍會透過成員資格提供者的設定可設定`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-284">These bounds are configurable through the Membership provider settings in `Web.config`.</span></span>

<span data-ttu-id="2c4b9-285">已核准的狀態通常用於做為禁止新的使用者登入，直到發生某些動作。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-285">The approved status is commonly used as a means to prohibit new users from logging in until some action has transpired.</span></span> <span data-ttu-id="2c4b9-286">可能是站台都需要由系統管理員第一次核准新的帳戶或如我們在步驟 3 中所見驗證電子郵件地址。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-286">Perhaps the site requires that new accounts first be approved by the administrator or, as we saw in Step 3, by verifying their email address.</span></span>

<span data-ttu-id="2c4b9-287">快樂地寫程式 ！</span><span class="sxs-lookup"><span data-stu-id="2c4b9-287">Happy Programming!</span></span>

### <a name="about-the-author"></a><span data-ttu-id="2c4b9-288">關於作者</span><span class="sxs-lookup"><span data-stu-id="2c4b9-288">About the Author</span></span>

<span data-ttu-id="2c4b9-289">Scott Mitchell，多個 ASP 書籍的作者，他是 4GuysFromRolla.com 的創辦人，從事 Microsoft Web 技術工作自 1998 年。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-289">Scott Mitchell, author of multiple ASP/ASP.NET books and founder of 4GuysFromRolla.com, has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="2c4b9-290">Scott 會擔任獨立的顧問、 培訓講師和作家。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-290">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="2c4b9-291">他最新的著作是 *[Sams 教導您自己 ASP.NET 2.0 在 24 小時內](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-291">His latest book is *[Sams Teach Yourself ASP.NET 2.0 in 24 Hours](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*.</span></span> <span data-ttu-id="2c4b9-292">Scott 要聯絡[ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com)或透過他的部落格[ http://ScottOnWriting.NET ](http://scottonwriting.net/)。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-292">Scott can be reached at [mitchell@4guysfromrolla.com](mailto:mitchell@4guysfromrolla.com) or via his blog at [http://ScottOnWriting.NET](http://scottonwriting.net/).</span></span>

### <a name="special-thanks-to"></a><span data-ttu-id="2c4b9-293">特別感謝...</span><span class="sxs-lookup"><span data-stu-id="2c4b9-293">Special Thanks To…</span></span>

<span data-ttu-id="2c4b9-294">本教學課程系列是由許多實用的檢閱者檢閱。</span><span class="sxs-lookup"><span data-stu-id="2c4b9-294">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="2c4b9-295">有興趣檢閱我即將推出的 MSDN 文章嗎？</span><span class="sxs-lookup"><span data-stu-id="2c4b9-295">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="2c4b9-296">如果是這樣，psychic 在 [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-296">If so, drop me a line at [mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="2c4b9-297">[上一頁](recovering-and-changing-passwords-cs.md)
> [下一頁](building-an-interface-to-select-one-user-account-from-many-vb.md)</span><span class="sxs-lookup"><span data-stu-id="2c4b9-297">[Previous](recovering-and-changing-passwords-cs.md)
[Next](building-an-interface-to-select-one-user-account-from-many-vb.md)</span></span>
