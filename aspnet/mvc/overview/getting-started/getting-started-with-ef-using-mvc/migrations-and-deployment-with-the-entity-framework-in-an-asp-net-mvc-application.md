---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: 教學課程：ASP.NET MVC 應用程式中使用 EF 移轉並部署至 Azure
author: tdykstra
description: 在本教學課程中，您可以啟用 Code First 移轉，並部署至 Azure 中雲端應用程式。
ms.author: riande
ms.date: 01/16/2019
ms.topic: tutorial
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 1f25a9afdf379d725496bd88f6ac192ab19930ca
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/17/2019
ms.locfileid: "59384509"
---
# <a name="tutorial-use-ef-migrations-in-an-aspnet-mvc-app-and-deploy-to-azure"></a><span data-ttu-id="6cebc-103">教學課程：ASP.NET MVC 應用程式中使用 EF 移轉並部署至 Azure</span><span class="sxs-lookup"><span data-stu-id="6cebc-103">Tutorial: Use EF Migrations in an ASP.NET MVC app and deploy to Azure</span></span>

<span data-ttu-id="6cebc-104">到目前為止 Contoso 大學範例 web 應用程式已經執行本機 IIS Express 中的開發電腦上。</span><span class="sxs-lookup"><span data-stu-id="6cebc-104">So far the Contoso University sample web application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="6cebc-105">若要讓實際的應用程式供其他人透過網際網路使用，您必須將它部署至 web 主控提供者。</span><span class="sxs-lookup"><span data-stu-id="6cebc-105">To make a real application available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="6cebc-106">在本教學課程中，您可以啟用 Code First 移轉，並部署至 Azure 中雲端應用程式：</span><span class="sxs-lookup"><span data-stu-id="6cebc-106">In this tutorial, you enable Code First migrations and deploy the application to the cloud in Azure:</span></span>

- <span data-ttu-id="6cebc-107">啟用 Code First 移轉。</span><span class="sxs-lookup"><span data-stu-id="6cebc-107">Enable Code First Migrations.</span></span> <span data-ttu-id="6cebc-108">移轉功能可讓您變更資料模型，並將變更部署到生產環境，藉由更新資料庫結構描述，而不需卸除並重新建立資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-108">The Migrations feature enables you to change the data model and deploy your changes to production by updating the database schema without having to drop and re-create the database.</span></span>
- <span data-ttu-id="6cebc-109">部署到 Azure。</span><span class="sxs-lookup"><span data-stu-id="6cebc-109">Deploy to Azure.</span></span> <span data-ttu-id="6cebc-110">這個步驟是選擇性的;而不部署專案，您可以繼續進行其餘的教學課程。</span><span class="sxs-lookup"><span data-stu-id="6cebc-110">This step is optional; you can continue with the remaining tutorials without having deployed the project.</span></span>

<span data-ttu-id="6cebc-111">我們建議您進行部署，使用與原始檔控制持續整合程序，但本教學課程並未涵蓋這些主題。</span><span class="sxs-lookup"><span data-stu-id="6cebc-111">We recommend that you use a continuous integration process with source control for deployment, but this tutorial does not cover those topics.</span></span> <span data-ttu-id="6cebc-112">如需詳細資訊，請參閱 <<c0> [ 原始檔控制](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control)並[連續整合](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery)章[使用 Azure 建置真實世界雲端應用程式](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-112">For more information, see the [source control](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) and [continuous integration](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) chapters of [Building Real-World Cloud Apps with Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span></span>

<span data-ttu-id="6cebc-113">在本教學課程中，您已：</span><span class="sxs-lookup"><span data-stu-id="6cebc-113">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="6cebc-114">啟用 Code First 移轉</span><span class="sxs-lookup"><span data-stu-id="6cebc-114">Enable Code First migrations</span></span>
> * <span data-ttu-id="6cebc-115">（選擇性） 的 Azure 中的應用程式部署</span><span class="sxs-lookup"><span data-stu-id="6cebc-115">Deploy the app in Azure (optional)</span></span>

## <a name="prerequisites"></a><span data-ttu-id="6cebc-116">必要條件</span><span class="sxs-lookup"><span data-stu-id="6cebc-116">Prerequisites</span></span>

- [<span data-ttu-id="6cebc-117">連線恢復功能和命令攔截</span><span class="sxs-lookup"><span data-stu-id="6cebc-117">Connection Resiliency and Command Interception</span></span>](connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md)

## <a name="enable-code-first-migrations"></a><span data-ttu-id="6cebc-118">啟用 Code First 移轉</span><span class="sxs-lookup"><span data-stu-id="6cebc-118">Enable Code First migrations</span></span>

<span data-ttu-id="6cebc-119">在開發新的應用程式時，您的資料模型會頻繁變更，而每次模型變更時，模型會與資料庫不同步。</span><span class="sxs-lookup"><span data-stu-id="6cebc-119">When you develop a new application, your data model changes frequently, and each time the model changes, it gets out of sync with the database.</span></span> <span data-ttu-id="6cebc-120">您已設定 Entity Framework 自動卸除並重新建立每次變更資料模型資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-120">You have configured the Entity Framework to automatically drop and re-create the database each time you change the data model.</span></span> <span data-ttu-id="6cebc-121">當您新增、 移除或變更實體類別或變更您`DbContext`類別的下次您執行應用程式會自動刪除您現有的資料庫，會建立一個新的符合模型，並植入測試資料。</span><span class="sxs-lookup"><span data-stu-id="6cebc-121">When you add, remove, or change entity classes or change your `DbContext` class, the next time you run the application it automatically deletes your existing database, creates a new one that matches the model, and seeds it with test data.</span></span>

<span data-ttu-id="6cebc-122">在您將應用程式部署到生產環境之前，都可以使用上述方法讓資料庫與資料模型保持同步。</span><span class="sxs-lookup"><span data-stu-id="6cebc-122">This method of keeping the database in sync with the data model works well until you deploy the application to production.</span></span> <span data-ttu-id="6cebc-123">當在生產環境中執行應用程式時，通常會儲存您想要保留，且您不希望遺失任何項目每次進行變更，例如加入新的資料行的資料。</span><span class="sxs-lookup"><span data-stu-id="6cebc-123">When the application is running in production, it is usually storing data that you want to keep, and you don't want to lose everything each time you make a change such as adding a new column.</span></span> <span data-ttu-id="6cebc-124">[Code First 移轉](https://msdn.microsoft.com/data/jj591621)功能解決這個問題，藉由啟用 Code First 來更新資料庫結構描述，而不是卸除並重新建立資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-124">The [Code First Migrations](https://msdn.microsoft.com/data/jj591621) feature solves this problem by enabling Code First to update the database schema instead of dropping and re-creating the database.</span></span> <span data-ttu-id="6cebc-125">在本教學課程中，您要部署的應用程式，並準備進行，您會啟用移轉。</span><span class="sxs-lookup"><span data-stu-id="6cebc-125">In this tutorial, you'll deploy the application, and to prepare for that you'll enable Migrations.</span></span>

1. <span data-ttu-id="6cebc-126">停用您稍早設定的註解化或刪除的初始設定式`contexts`您新增至應用程式 Web.config 檔案的項目。</span><span class="sxs-lookup"><span data-stu-id="6cebc-126">Disable the initializer that you set up earlier by commenting out or deleting the `contexts` element that you added to the application Web.config file.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. <span data-ttu-id="6cebc-127">應用程式中而且*Web.config*檔案中，將連接字串中資料庫的名稱變更為 ContosoUniversity2。</span><span class="sxs-lookup"><span data-stu-id="6cebc-127">Also in the application *Web.config* file, change the name of the database in the connection string to ContosoUniversity2.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    <span data-ttu-id="6cebc-128">這項變更會設定專案，以便在第一次移轉建立新的資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-128">This change sets up the project so that the first migration creates a new database.</span></span> <span data-ttu-id="6cebc-129">這不是必要，但您稍後所見，為什麼它是個不錯的主意。</span><span class="sxs-lookup"><span data-stu-id="6cebc-129">This isn't required but you'll see later why it's a good idea.</span></span>
3. <span data-ttu-id="6cebc-130">從 [工具] 功能表中，選取 [NuGet 套件管理員] > [套件管理員主控台]。</span><span class="sxs-lookup"><span data-stu-id="6cebc-130">From the **Tools** menu, select **NuGet Package Manager** > **Package Manager Console**.</span></span>

1. <span data-ttu-id="6cebc-131">在`PM>`提示字元輸入下列命令：</span><span class="sxs-lookup"><span data-stu-id="6cebc-131">At the `PM>` prompt enter the following commands:</span></span>

    ```text
    enable-migrations
    add-migration InitialCreate
    ```

    <span data-ttu-id="6cebc-132">`enable-migrations`命令會建立*移轉*資料夾中 [ContosoUniversity] 專案，並將該資料夾中放*Configuration.cs*設定移轉，您可以編輯的檔案。</span><span class="sxs-lookup"><span data-stu-id="6cebc-132">The `enable-migrations` command creates a *Migrations* folder in the ContosoUniversity project, and it puts in that folder a *Configuration.cs* file that you can edit to configure Migrations.</span></span>

    <span data-ttu-id="6cebc-133">(如果您錯過了上述步驟，將引導您變更資料庫名稱，移轉會尋找現有的資料庫，並自動執行`add-migration`命令。</span><span class="sxs-lookup"><span data-stu-id="6cebc-133">(If you missed the step above that directs you to change the database name, Migrations will find the existing database and automatically do the `add-migration` command.</span></span> <span data-ttu-id="6cebc-134">這是好的它只是表示部署資料庫之前，您將不會執行移轉程式碼的測試。</span><span class="sxs-lookup"><span data-stu-id="6cebc-134">That's okay, it just means you won't run a test of the migrations code before you deploy the database.</span></span> <span data-ttu-id="6cebc-135">稍後當您執行`update-database`命令不會有因為資料庫已經存在。)</span><span class="sxs-lookup"><span data-stu-id="6cebc-135">Later when you run the `update-database` command nothing will happen because the database already exists.)</span></span>

    <span data-ttu-id="6cebc-136">開啟*ContosoUniversity\Migrations\Configuration.cs*檔案。</span><span class="sxs-lookup"><span data-stu-id="6cebc-136">Open the *ContosoUniversity\Migrations\Configuration.cs* file.</span></span> <span data-ttu-id="6cebc-137">如同您先前看到的初始設定式類別`Configuration`類別包含`Seed`方法。</span><span class="sxs-lookup"><span data-stu-id="6cebc-137">Like the initializer class that you saw earlier, the `Configuration` class includes a `Seed` method.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    <span data-ttu-id="6cebc-138">目的[種子](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)方法是讓您插入或更新的測試資料，Code First 會建立或更新資料庫之後。</span><span class="sxs-lookup"><span data-stu-id="6cebc-138">The purpose of the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is to enable you to insert or update test data after Code First creates or updates the database.</span></span> <span data-ttu-id="6cebc-139">在建立資料庫時，以及每次變更資料模型之後，會更新資料庫結構描述，會呼叫方法。</span><span class="sxs-lookup"><span data-stu-id="6cebc-139">The method is called when the database is created and every time the database schema is updated after a data model change.</span></span>

### <a name="set-up-the-seed-method"></a><span data-ttu-id="6cebc-140">設定種子方法</span><span class="sxs-lookup"><span data-stu-id="6cebc-140">Set up the Seed method</span></span>

<span data-ttu-id="6cebc-141">當您卸除並重新建立資料庫中的每個資料模型變更時，您可以使用初始設定式類別`Seed`插入測試資料，因為每次模型變更之後卸除資料庫的方法，並測試的所有資料都會遺失。</span><span class="sxs-lookup"><span data-stu-id="6cebc-141">When you drop and re-create the database for every data model change, you use the initializer class's `Seed` method to insert test data, because after every model change the database is dropped and all the test data is lost.</span></span> <span data-ttu-id="6cebc-142">使用 Code First 移轉，資料會保留在資料庫變更後的測試，包括中的測試資料[種子](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)方法通常不是必要。</span><span class="sxs-lookup"><span data-stu-id="6cebc-142">With Code First Migrations, test data is retained after database changes, so including test data in the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is typically not necessary.</span></span> <span data-ttu-id="6cebc-143">事實上，您不想`Seed`方法來插入測試資料，如果您將使用移轉將資料庫部署到生產環境，因為`Seed`方法會在生產環境中執行。</span><span class="sxs-lookup"><span data-stu-id="6cebc-143">In fact, you don't want the `Seed` method to insert test data if you'll be using Migrations to deploy the database to production, because the `Seed` method will run in production.</span></span> <span data-ttu-id="6cebc-144">在此情況下，您想`Seed`插入資料庫，您需要的資料在生產環境中的方法。</span><span class="sxs-lookup"><span data-stu-id="6cebc-144">In that case, you want the `Seed` method to insert into the database only the data that you need in production.</span></span> <span data-ttu-id="6cebc-145">例如，您可能想要包括在實際的部門名稱的資料庫`Department`資料表在生產環境中，您可以使用應用程式時。</span><span class="sxs-lookup"><span data-stu-id="6cebc-145">For example, you might want the database to include actual department names in the `Department` table when the application becomes available in production.</span></span>

<span data-ttu-id="6cebc-146">本教學課程中，您將使用移轉來進行部署，但您`Seed`方法都會仍要插入的測試資料，以便讓您更輕鬆地查看應用程式的功能而不需要以手動方式插入大量資料的運作方式。</span><span class="sxs-lookup"><span data-stu-id="6cebc-146">For this tutorial, you'll be using Migrations for deployment, but your `Seed` method will insert test data anyway in order to make it easier to see how application functionality works without having to manually insert a lot of data.</span></span>

1. <span data-ttu-id="6cebc-147">內容取代*Configuration.cs*下列程式碼，將測試資料載入至新的資料庫檔案。</span><span class="sxs-lookup"><span data-stu-id="6cebc-147">Replace the contents of the *Configuration.cs* file with the following code, which loads test data into the new database.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    <span data-ttu-id="6cebc-148">[種子](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)方法會採用資料庫內容物件做為輸入參數，並在方法中的程式碼會使用該物件來將新實體新增至資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-148">The [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method takes the database context object as an input parameter, and the code in the method uses that object to add new entities to the database.</span></span> <span data-ttu-id="6cebc-149">每個實體類型，程式碼會建立新實體的集合，將它們新增至適當[DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx)屬性，然後按一下 儲存至資料庫的變更。</span><span class="sxs-lookup"><span data-stu-id="6cebc-149">For each entity type, the code creates a collection of new entities, adds them to the appropriate [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) property, and then saves the changes to the database.</span></span> <span data-ttu-id="6cebc-150">不需要呼叫[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)實體的每一個群組之後的方法，做為在這裡，完成，但這麼做可協助您找出問題的來源，如果程式碼寫入資料庫時發生例外狀況。</span><span class="sxs-lookup"><span data-stu-id="6cebc-150">It isn't necessary to call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method after each group of entities, as is done here, but doing that helps you locate the source of a problem if an exception occurs while the code is writing to the database.</span></span>

    <span data-ttu-id="6cebc-151">某些插入資料的陳述式使用[AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx)執行"upsert"作業的方法。</span><span class="sxs-lookup"><span data-stu-id="6cebc-151">Some of the statements that insert data use the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method to perform an "upsert" operation.</span></span> <span data-ttu-id="6cebc-152">因為`Seed`方法會執行，每次您執行`update-database`命令時，通常每個移轉之後，因為您嘗試新增的資料列會有第一個移轉建立資料庫之後插入資料。</span><span class="sxs-lookup"><span data-stu-id="6cebc-152">Because the `Seed` method runs every time you execute the `update-database` command, typically after each migration, you can't just insert data, because the rows you are trying to add will already be there after the first migration that creates the database.</span></span> <span data-ttu-id="6cebc-153">"Upsert"作業可避免當您嘗試插入資料列已存在，但它會發生的錯誤***會覆寫***資料，您可能會在測試應用程式時所做的任何變更。</span><span class="sxs-lookup"><span data-stu-id="6cebc-153">The "upsert" operation prevents errors that would happen if you try to insert a row that already exists, but it ***overrides*** any changes to data that you may have made while testing the application.</span></span> <span data-ttu-id="6cebc-154">某些資料表中的測試資料與您可能不想發生這種情況： 在某些情況下當您將資料變更時測試您的要資料庫更新後要保持變更。</span><span class="sxs-lookup"><span data-stu-id="6cebc-154">With test data in some tables you might not want that to happen: in some cases when you change data while testing you want your changes to remain after database updates.</span></span> <span data-ttu-id="6cebc-155">在此情況下您想要進行條件式的 insert 作業： 插入資料列，只有當不存在。</span><span class="sxs-lookup"><span data-stu-id="6cebc-155">In that case you want to do a conditional insert operation: insert a row only if it doesn't already exist.</span></span> <span data-ttu-id="6cebc-156">種子方法會使用這兩種方法。</span><span class="sxs-lookup"><span data-stu-id="6cebc-156">The Seed method uses both approaches.</span></span>

    <span data-ttu-id="6cebc-157">第一個參數傳遞給[AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx)方法會指定要用來檢查資料列是否已經存在的屬性。</span><span class="sxs-lookup"><span data-stu-id="6cebc-157">The first parameter passed to the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method specifies the property to use to check if a row already exists.</span></span> <span data-ttu-id="6cebc-158">為您提供測試學生資料`LastName`屬性可以使用針對此目的，因為每個清單中的最後一個名稱是唯一的：</span><span class="sxs-lookup"><span data-stu-id="6cebc-158">For the test student data that you are providing, the `LastName` property can be used for this purpose since each last name in the list is unique:</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    <span data-ttu-id="6cebc-159">此程式碼會假設這些姓氏是唯一。</span><span class="sxs-lookup"><span data-stu-id="6cebc-159">This code assumes that last names are unique.</span></span> <span data-ttu-id="6cebc-160">如果您以手動方式新增最後一個名稱重複的學生，您會收到下列例外狀況下一次您執行移轉：</span><span class="sxs-lookup"><span data-stu-id="6cebc-160">If you manually add a student with a duplicate last name, you'll get the following exception the next time you perform a migration:</span></span>

    <span data-ttu-id="6cebc-161">**序列包含一個以上的項目**</span><span class="sxs-lookup"><span data-stu-id="6cebc-161">**Sequence contains more than one element**</span></span>

    <span data-ttu-id="6cebc-162">如需如何處理重複的資料，例如兩個名為"Alexander Carson"的學生資訊，請參閱[植入及偵錯 Entity Framework (EF) Db](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) Rick Anderson 部落格上。</span><span class="sxs-lookup"><span data-stu-id="6cebc-162">For information about how to handle redundant data such as two students named "Alexander Carson", see [Seeding and Debugging Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) on Rick Anderson's blog.</span></span> <span data-ttu-id="6cebc-163">如需詳細資訊`AddOrUpdate`方法，請參閱 <<c2> [ 負責使用 EF 4.3 AddOrUpdate 方法](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/)Julie Lerman 的部落格上。</span><span class="sxs-lookup"><span data-stu-id="6cebc-163">For more information about the `AddOrUpdate` method, see [Take care with EF 4.3 AddOrUpdate Method](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) on Julie Lerman's blog.</span></span>

    <span data-ttu-id="6cebc-164">建立的程式碼`Enrollment`實體會假設您已`ID`的實體中的值`students`集合，雖然您未設定該屬性在建立集合的程式碼。</span><span class="sxs-lookup"><span data-stu-id="6cebc-164">The code that creates `Enrollment` entities assumes you have the `ID` value in the entities in the `students` collection, although you didn't set that property in the code that creates the collection.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    <span data-ttu-id="6cebc-165">您可以使用`ID`以下屬性因為`ID`設定值，當您呼叫`SaveChanges`如`students`集合。</span><span class="sxs-lookup"><span data-stu-id="6cebc-165">You can use the `ID` property here because the `ID` value is set when you call `SaveChanges` for the `students` collection.</span></span> <span data-ttu-id="6cebc-166">EF 會自動取得主索引鍵值，當它將實體插入資料庫，並更新`ID`在記憶體中實體的屬性。</span><span class="sxs-lookup"><span data-stu-id="6cebc-166">EF automatically gets the primary key value when it inserts an entity into the database, and it updates the `ID` property of the entity in memory.</span></span>

    <span data-ttu-id="6cebc-167">將每一個程式碼`Enrollment`實體`Enrollments`不會使用實體集`AddOrUpdate`方法。</span><span class="sxs-lookup"><span data-stu-id="6cebc-167">The code that adds each `Enrollment` entity to the `Enrollments` entity set doesn't use the `AddOrUpdate` method.</span></span> <span data-ttu-id="6cebc-168">它會檢查是否實體已經存在，而且如果不存在，插入實體。</span><span class="sxs-lookup"><span data-stu-id="6cebc-168">It checks if an entity already exists and inserts the entity if it doesn't exist.</span></span> <span data-ttu-id="6cebc-169">這種方法將會保留您對使用應用程式 UI 的註冊級變更。</span><span class="sxs-lookup"><span data-stu-id="6cebc-169">This approach will preserve changes you make to an enrollment grade by using the application UI.</span></span> <span data-ttu-id="6cebc-170">此程式碼迴圈的每個成員`Enrollment`[清單](https://msdn.microsoft.com/library/6sh2ey19.aspx)和資料庫中找不到註冊，它會將註冊加入資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-170">The code loops through each member of the `Enrollment`[List](https://msdn.microsoft.com/library/6sh2ey19.aspx) and if the enrollment is not found in the database, it adds the enrollment to the database.</span></span> <span data-ttu-id="6cebc-171">第一次更新資料庫，資料庫將會是空的因此它會將新增每個註冊。</span><span class="sxs-lookup"><span data-stu-id="6cebc-171">The first time you update the database, the database will be empty, so it will add each enrollment.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]

2. <span data-ttu-id="6cebc-172">建置專案。</span><span class="sxs-lookup"><span data-stu-id="6cebc-172">Build the project.</span></span>

### <a name="execute-the-first-migration"></a><span data-ttu-id="6cebc-173">執行第一次移轉</span><span class="sxs-lookup"><span data-stu-id="6cebc-173">Execute the first migration</span></span>

<span data-ttu-id="6cebc-174">當您執行`add-migration`命令，移轉作業產生的程式碼，會從頭開始建立資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-174">When you executed the `add-migration` command, Migrations generated the code that would create the database from scratch.</span></span> <span data-ttu-id="6cebc-175">此程式碼也是*移轉*資料夾中名為的檔案*&lt;時間戳記&gt;\_InitialCreate.cs*。</span><span class="sxs-lookup"><span data-stu-id="6cebc-175">This code is also in the *Migrations* folder, in the file named *&lt;timestamp&gt;\_InitialCreate.cs*.</span></span> <span data-ttu-id="6cebc-176">`Up`方法`InitialCreate`類別會建立對應至資料模型實體集，資料庫資料表和`Down`方法會刪除它們。</span><span class="sxs-lookup"><span data-stu-id="6cebc-176">The `Up` method of the `InitialCreate` class creates the database tables that correspond to the data model entity sets, and the `Down` method deletes them.</span></span>

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

<span data-ttu-id="6cebc-177">Migrations 會呼叫 `Up` 方法，以實作移轉所需的資料模型變更。</span><span class="sxs-lookup"><span data-stu-id="6cebc-177">Migrations calls the `Up` method to implement the data model changes for a migration.</span></span> <span data-ttu-id="6cebc-178">當您輸入命令以復原更新時，Migrations 會呼叫 `Down` 方法。</span><span class="sxs-lookup"><span data-stu-id="6cebc-178">When you enter a command to roll back the update, Migrations calls the `Down` method.</span></span>

<span data-ttu-id="6cebc-179">這是當您輸入時所建立的初始移轉`add-migration InitialCreate`命令。</span><span class="sxs-lookup"><span data-stu-id="6cebc-179">This is the initial migration that was created when you entered the `add-migration InitialCreate` command.</span></span> <span data-ttu-id="6cebc-180">參數 (`InitialCreate`在範例中) 用於檔案名稱，而且可以是任何您想要的結果，您通常會選擇的單字或片語，概括未移轉正在進行。</span><span class="sxs-lookup"><span data-stu-id="6cebc-180">The parameter (`InitialCreate` in the example) is used for the file name and can be whatever you want; you typically choose a word or phrase that summarizes what is being done in the migration.</span></span> <span data-ttu-id="6cebc-181">例如，您可能會在此名稱稍後進行移轉&quot;AddDepartmentTable&quot;。</span><span class="sxs-lookup"><span data-stu-id="6cebc-181">For example, you might name a later migration &quot;AddDepartmentTable&quot;.</span></span>

<span data-ttu-id="6cebc-182">如果在您建立初始移轉時資料庫已經存在，系統會產生資料庫建立程式碼，但不需要執行，因為資料庫已經符合資料模型。</span><span class="sxs-lookup"><span data-stu-id="6cebc-182">If you created the initial migration when the database already exists, the database creation code is generated but it doesn't have to run because the database already matches the data model.</span></span> <span data-ttu-id="6cebc-183">當您將應用程式部署到資料庫尚未存在的其他環境中時，即會執行這個程式碼以建立您的資料庫；建議您先進行測試。</span><span class="sxs-lookup"><span data-stu-id="6cebc-183">When you deploy the app to another environment where the database doesn't exist yet, this code will run to create your database, so it's a good idea to test it first.</span></span> <span data-ttu-id="6cebc-184">這就是為什麼您變更先前的連接字串中的資料庫名稱&mdash;以便移轉可以建立一個新從零開始。</span><span class="sxs-lookup"><span data-stu-id="6cebc-184">That's why you changed the name of the database in the connection string earlier&mdash;so that migrations can create a new one from scratch.</span></span>

1. <span data-ttu-id="6cebc-185">在 [ **Package Manager Console** ] 視窗中，輸入下列命令：</span><span class="sxs-lookup"><span data-stu-id="6cebc-185">In the **Package Manager Console** window, enter the following command:</span></span>

    `update-database`

    <span data-ttu-id="6cebc-186">`update-database`命令會執行`Up`方法來建立資料庫然後執行`Seed`方法來填入資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-186">The `update-database` command runs the `Up` method to create the database and then it runs the `Seed` method to populate the database.</span></span> <span data-ttu-id="6cebc-187">相同的程序會自動執行在生產環境中之後部署應用程式，如您所見下一節。</span><span class="sxs-lookup"><span data-stu-id="6cebc-187">The same process will run automatically in production after you deploy the application, as you'll see in the following section.</span></span>
2. <span data-ttu-id="6cebc-188">使用**伺服器總管**來檢查資料庫，如同在第一個教學課程中，並執行的應用程式，以確認所有項目仍可運作相同和以前一樣。</span><span class="sxs-lookup"><span data-stu-id="6cebc-188">Use **Server Explorer** to inspect the database as you did in the first tutorial, and run the application to verify that everything still works the same as before.</span></span>

## <a name="deploy-to-azure"></a><span data-ttu-id="6cebc-189">部署到 Azure</span><span class="sxs-lookup"><span data-stu-id="6cebc-189">Deploy to Azure</span></span>

<span data-ttu-id="6cebc-190">到目前為止應用程式具有已在本機執行 IIS Express 中的開發電腦上。</span><span class="sxs-lookup"><span data-stu-id="6cebc-190">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="6cebc-191">若要使其可供其他人透過網際網路使用，您必須將它部署至 web 主控提供者。</span><span class="sxs-lookup"><span data-stu-id="6cebc-191">To make it available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="6cebc-192">在本節的教學課程中，您會將它部署至 Azure。</span><span class="sxs-lookup"><span data-stu-id="6cebc-192">In this section of the tutorial, you'll deploy it to Azure.</span></span> <span data-ttu-id="6cebc-193">本節為選擇性;您可以略過這個，並繼續進行下列教學課程中，或者您可以調整的指示在本節中不同的主機服務提供者的您所選擇。</span><span class="sxs-lookup"><span data-stu-id="6cebc-193">This section is optional; you can skip this and continue with the following tutorial, or you can adapt the instructions in this section for a different hosting provider of your choice.</span></span>

### <a name="use-code-first-migrations-to-deploy-the-database"></a><span data-ttu-id="6cebc-194">使用 Code First 移轉來部署資料庫</span><span class="sxs-lookup"><span data-stu-id="6cebc-194">Use Code First migrations to deploy the database</span></span>

<span data-ttu-id="6cebc-195">若要部署資料庫，您將使用 Code First 移轉。</span><span class="sxs-lookup"><span data-stu-id="6cebc-195">To deploy the database, you'll use Code First Migrations.</span></span> <span data-ttu-id="6cebc-196">當您建立發行設定檔，您用來設定從 Visual Studio 部署的設定時，您會選取核取方塊**更新資料庫**。</span><span class="sxs-lookup"><span data-stu-id="6cebc-196">When you create the publish profile that you use to configure settings for deploying from Visual Studio, you'll select a check box labeled **Update Database**.</span></span> <span data-ttu-id="6cebc-197">此設定會使部署程序會自動設定應用程式*Web.config*檔案在目的地伺服器上，讓 Code First 會使用`MigrateDatabaseToLatestVersion`初始設定式類別。</span><span class="sxs-lookup"><span data-stu-id="6cebc-197">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>

<span data-ttu-id="6cebc-198">Visual Studio 不會執行任何與資料庫在部署程序時，它會將您的專案複製到目的地伺服器。</span><span class="sxs-lookup"><span data-stu-id="6cebc-198">Visual Studio doesn't do anything with the database during the deployment process while it is copying your project to the destination server.</span></span> <span data-ttu-id="6cebc-199">當您執行部署的應用程式並在部署後第一次存取資料庫時，Code First 會檢查資料庫是否符合資料模型。</span><span class="sxs-lookup"><span data-stu-id="6cebc-199">When you run the deployed application and it accesses the database for the first time after deployment, Code First checks if the database matches the data model.</span></span> <span data-ttu-id="6cebc-200">如果不相符，Code First 會自動建立資料庫 （如果尚不存在） 或更新為最新版本的資料庫結構描述 （如果資料庫存在，但不符合模型）。</span><span class="sxs-lookup"><span data-stu-id="6cebc-200">If there's a mismatch, Code First automatically creates the database (if it doesn't exist yet) or updates the database schema to the latest version (if a database exists but doesn't match the model).</span></span> <span data-ttu-id="6cebc-201">如果應用程式實作移轉`Seed`方法，在方法執行之後建立資料庫，或在更新結構描述。</span><span class="sxs-lookup"><span data-stu-id="6cebc-201">If the application implements a Migrations `Seed` method, the method runs after the database is created or the schema is updated.</span></span>

<span data-ttu-id="6cebc-202">移轉`Seed`方法會將測試資料。</span><span class="sxs-lookup"><span data-stu-id="6cebc-202">Your Migrations `Seed` method inserts test data.</span></span> <span data-ttu-id="6cebc-203">如果您已部署至生產環境中，您必須變更`Seed`方法，讓它只會插入您想要插入到您的生產資料庫的資料。</span><span class="sxs-lookup"><span data-stu-id="6cebc-203">If you were deploying to a production environment, you would have to change the `Seed` method so that it only inserts data that you want to be inserted into your production database.</span></span> <span data-ttu-id="6cebc-204">比方說，您目前的資料模型中可能會想要在開發資料庫的實際課程但虛構的學生。</span><span class="sxs-lookup"><span data-stu-id="6cebc-204">For example, in your current data model you might want to have real courses but fictional students in the development database.</span></span> <span data-ttu-id="6cebc-205">您可以撰寫`Seed`負載皆在開發中，並再標記為註解虛構的學生在部署至生產環境之前的方法。</span><span class="sxs-lookup"><span data-stu-id="6cebc-205">You can write a `Seed` method to load both in development, and then comment out the fictional students before you deploy to production.</span></span> <span data-ttu-id="6cebc-206">或者您可以撰寫`Seed`方法來載入只有課程，並使用應用程式的 UI 手動輸入虛構的學生在測試資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-206">Or you can write a `Seed` method to load only courses, and enter the fictional students in the test database manually by using the application's UI.</span></span>

### <a name="get-an-azure-account"></a><span data-ttu-id="6cebc-207">取得 Azure 帳戶</span><span class="sxs-lookup"><span data-stu-id="6cebc-207">Get an Azure account</span></span>

<span data-ttu-id="6cebc-208">您將需要 Azure 帳戶。</span><span class="sxs-lookup"><span data-stu-id="6cebc-208">You'll need an Azure account.</span></span> <span data-ttu-id="6cebc-209">如果您還沒有的話，但您沒有 Visual Studio 訂用帳戶，您可以[啟用您的訂用帳戶權益](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-209">If you don't already have one, but you do have a Visual Studio subscription, you can [activate your subscription benefits](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
).</span></span> <span data-ttu-id="6cebc-210">否則，您可以建立免費的試用帳戶只需要幾分鐘的時間。</span><span class="sxs-lookup"><span data-stu-id="6cebc-210">Otherwise, you can create a free trial account in just a couple of minutes.</span></span> <span data-ttu-id="6cebc-211">如需詳細資訊，請參閱 < [Azure 免費試用](https://azure.microsoft.com/free/)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-211">For details, see [Azure Free Trial](https://azure.microsoft.com/free/).</span></span>

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a><span data-ttu-id="6cebc-212">在 Azure 中建立網站和 SQL database</span><span class="sxs-lookup"><span data-stu-id="6cebc-212">Create a web site and a SQL database in Azure</span></span>

<span data-ttu-id="6cebc-213">在 Azure web 應用程式會執行在共用主控環境中，這表示它會在與其他 Azure 用戶端所共用的虛擬機器 (Vm) 上執行。</span><span class="sxs-lookup"><span data-stu-id="6cebc-213">Your web app in Azure will run in a shared hosting environment, which means it runs on virtual machines (VMs) that are shared with other Azure clients.</span></span> <span data-ttu-id="6cebc-214">共用主控環境是開始在雲端中的低成本方法。</span><span class="sxs-lookup"><span data-stu-id="6cebc-214">A shared hosting environment is a low-cost way to get started in the cloud.</span></span> <span data-ttu-id="6cebc-215">稍後，如果您的 web 流量增加，應用程式可擴充至專用的 Vm 上執行依需求。</span><span class="sxs-lookup"><span data-stu-id="6cebc-215">Later, if your web traffic increases, the application can scale to meet the need by running on dedicated VMs.</span></span> <span data-ttu-id="6cebc-216">若要深入了解價格選項適用於 Azure App Service，請閱讀[App Service 定價](https://azure.microsoft.com/pricing/details/app-service/)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-216">To learn more about Pricing Options for Azure App Service, read [App Service pricing](https://azure.microsoft.com/pricing/details/app-service/).</span></span>

<span data-ttu-id="6cebc-217">您會將資料庫部署到 Azure SQL database。</span><span class="sxs-lookup"><span data-stu-id="6cebc-217">You'll deploy the database to Azure SQL database.</span></span> <span data-ttu-id="6cebc-218">SQL database 是建置在 SQL Server 技術的雲端型關聯式資料庫服務。</span><span class="sxs-lookup"><span data-stu-id="6cebc-218">SQL database is a cloud-based relational database service that is built on SQL Server technologies.</span></span> <span data-ttu-id="6cebc-219">工具和使用 SQL Server 的應用程式也可以使用 SQL database。</span><span class="sxs-lookup"><span data-stu-id="6cebc-219">Tools and applications that work with SQL Server also work with SQL database.</span></span>

1. <span data-ttu-id="6cebc-220">在[Azure 管理入口網站](https://portal.azure.com)，選擇**建立資源**左側索引標籤，然後選擇**查看所有**上**新增**窗格 （或\* 刀鋒視窗\*) 若要查看所有可用的資源。</span><span class="sxs-lookup"><span data-stu-id="6cebc-220">In the [Azure Management Portal](https://portal.azure.com), choose **Create a resource** in the left tab and then choose **See all** on the **New** pane (or *blade*) to see all available resources.</span></span> <span data-ttu-id="6cebc-221">選擇**Web 應用程式 + SQL**中**Web**一節**所有項目**刀鋒視窗。</span><span class="sxs-lookup"><span data-stu-id="6cebc-221">Choose **Web App + SQL** in the **Web** section of the **Everything** blade.</span></span> <span data-ttu-id="6cebc-222">最後，選擇**建立**。</span><span class="sxs-lookup"><span data-stu-id="6cebc-222">Finally, choose **Create**.</span></span>

    ![在 Azure 入口網站中建立資源](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/create-azure-resource.png)

   <span data-ttu-id="6cebc-224">要建立新的表單**新 Web 應用程式 + SQL**資源隨即開啟。</span><span class="sxs-lookup"><span data-stu-id="6cebc-224">The form to create a new **New Web App + SQL** resource opens.</span></span>

2. <span data-ttu-id="6cebc-225">中，輸入字串**應用程式名稱**方塊，以使用唯一的 URL 做為您的應用程式。</span><span class="sxs-lookup"><span data-stu-id="6cebc-225">Enter a string in the **App name** box to use as the unique URL for your application.</span></span> <span data-ttu-id="6cebc-226">完整的 URL 將包含您在此處輸入再加上 Azure App Service 的預設網域 (。 azurewebsites.net)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-226">The complete URL will consist of what you enter here plus the default domain of Azure App Services (.azurewebsites.net).</span></span> <span data-ttu-id="6cebc-227">如果**應用程式名稱**已被使用，精靈會通知您有紅色*應用程式名稱不提供*訊息。</span><span class="sxs-lookup"><span data-stu-id="6cebc-227">If the **App name** is already taken, the Wizard notifies you with a red *The app name is not available* message.</span></span> <span data-ttu-id="6cebc-228">如果**應用程式名稱**是可用，您會看到綠色的核取記號。</span><span class="sxs-lookup"><span data-stu-id="6cebc-228">If the **App name** is available, you see a green checkmark.</span></span>

3. <span data-ttu-id="6cebc-229">在 **訂用帳戶**方塊中，選擇您想在其中的 Azure 訂用帳戶**App Service**存放。</span><span class="sxs-lookup"><span data-stu-id="6cebc-229">In the **Subscription** box, choose the Azure Subscription in which you want the **App Service** to reside.</span></span>

4. <span data-ttu-id="6cebc-230">在 **資源群組**文字方塊中，選擇資源群組，或建立新的帳戶。</span><span class="sxs-lookup"><span data-stu-id="6cebc-230">In the **Resource Group** text box, choose a Resource Group or create a new one.</span></span> <span data-ttu-id="6cebc-231">此設定會指定您的網站會以哪個資料中心。</span><span class="sxs-lookup"><span data-stu-id="6cebc-231">This setting specifies which data center your web site will run in.</span></span> <span data-ttu-id="6cebc-232">如需資源群組的詳細資訊，請參閱[資源群組](/azure/azure-resource-manager/resource-group-overview#resource-groups)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-232">For more information about Resource Groups, see [Resource groups](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span></span>

5. <span data-ttu-id="6cebc-233">建立新**App Service 方案**依序按一下*應用程式服務 區段*，**新建**，並填寫**App Service 方案**（可以是相同的名稱App Service 中)，**位置**，並**定價層**（沒有可用的選項）。</span><span class="sxs-lookup"><span data-stu-id="6cebc-233">Create a new **App Service Plan** by clicking the *App Service section*, **Create New**, and fill in **App Service plan** (can be same name as App Service), **Location**, and **Pricing tier** (there is a free option).</span></span>

6. <span data-ttu-id="6cebc-234">按一下  **SQL Database**，然後選擇**建立新的資料庫**或選取現有的資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-234">Click **SQL Database**, and then choose **Create a new database** or select an existing database.</span></span>

7. <span data-ttu-id="6cebc-235">在 **名稱**方塊中，輸入您的資料庫的名稱。</span><span class="sxs-lookup"><span data-stu-id="6cebc-235">In the **Name** box, enter a name for your database.</span></span>
8. <span data-ttu-id="6cebc-236">按一下 **目標伺服器**方塊，然後按**建立新的伺服器**。</span><span class="sxs-lookup"><span data-stu-id="6cebc-236">Click the **Target Server** box, and then select **Create a new server**.</span></span> <span data-ttu-id="6cebc-237">或者，如果您先前建立的伺服器，您就可以從可用伺服器清單選取該伺服器。</span><span class="sxs-lookup"><span data-stu-id="6cebc-237">Alternatively, if you previously created a server, you can select that server from list of available servers.</span></span>
9. <span data-ttu-id="6cebc-238">選擇**定價層**區段中，選擇*免費*。</span><span class="sxs-lookup"><span data-stu-id="6cebc-238">Choose **Pricing tier** section, choose *Free*.</span></span> <span data-ttu-id="6cebc-239">如果需要額外的資源，可以隨時相應資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-239">If additional resources are needed, the database can be scaled up at any time.</span></span> <span data-ttu-id="6cebc-240">若要進一步了解在 Azure SQL 定價，請參閱[Azure SQL Database 定價](https://azure.microsoft.com/pricing/details/sql-database/managed/)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-240">To learn more on Azure SQL Pricing, see [Azure SQL Database pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span></span>
10. <span data-ttu-id="6cebc-241">修改[定序](/sql/relational-databases/collations/collation-and-unicode-support)視。</span><span class="sxs-lookup"><span data-stu-id="6cebc-241">Modify [collation](/sql/relational-databases/collations/collation-and-unicode-support) as needed.</span></span>
11. <span data-ttu-id="6cebc-242">輸入系統管理員**SQL 系統管理員使用者名稱**並**SQL 管理員密碼**。</span><span class="sxs-lookup"><span data-stu-id="6cebc-242">Enter an administrator **SQL Admin Username** and **SQL Admin Password**.</span></span>

    - <span data-ttu-id="6cebc-243">如果您選取**新的 SQL Database 伺服器**，定義新的名稱和密碼，稍後會用到存取資料庫時。</span><span class="sxs-lookup"><span data-stu-id="6cebc-243">If you selected **New SQL Database server**, define a new name and password that you'll use later when you access the database.</span></span>
    - <span data-ttu-id="6cebc-244">如果您選取您先前建立的伺服器時，輸入該伺服器的認證。</span><span class="sxs-lookup"><span data-stu-id="6cebc-244">If you selected a server that you created previously, enter credentials for that server.</span></span>

12. <span data-ttu-id="6cebc-245">使用 Application Insights 的 App Service 時，可以啟用遙測收集。</span><span class="sxs-lookup"><span data-stu-id="6cebc-245">Telemetry collection can be enabled for App Service using Application Insights.</span></span> <span data-ttu-id="6cebc-246">使用小設定時，Application Insights 會收集重要的事件、 例外狀況、 相依性、 要求，以及追蹤資訊。</span><span class="sxs-lookup"><span data-stu-id="6cebc-246">With little configuration, Application Insights collects valuable event, exception, dependency, request, and trace information.</span></span> <span data-ttu-id="6cebc-247">若要深入了解 Application Insights，請參閱[Azure 監視器](https://azure.microsoft.com/services/monitor/)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-247">To learn more about Application Insights, see [Azure Monitor](https://azure.microsoft.com/services/monitor/).</span></span>
13. <span data-ttu-id="6cebc-248">按一下 **建立**底部指出您已完成。</span><span class="sxs-lookup"><span data-stu-id="6cebc-248">Click **Create** at the bottom to indicate that you're finished.</span></span>

    <span data-ttu-id="6cebc-249">在管理入口網站會回到儀表板 頁面中，而**通知**區域在頁面頂端會顯示正在建立網站。</span><span class="sxs-lookup"><span data-stu-id="6cebc-249">The Management Portal returns to the Dashboard page, and the **Notifications** area at the top of the page shows that the site is being created.</span></span> <span data-ttu-id="6cebc-250">一段時間之後 （通常少於一分鐘），還有部署成功的通知。</span><span class="sxs-lookup"><span data-stu-id="6cebc-250">After a while (typically less than a minute), there's a notification that the Deployment succeeded.</span></span> <span data-ttu-id="6cebc-251">在左側導覽列中，新的 App Service 會出現在**應用程式服務**一節和新的 SQL 資料庫會出現在**SQL 資料庫**一節。</span><span class="sxs-lookup"><span data-stu-id="6cebc-251">In the navigation bar at the left, the new App Service appears in the **App Services** section and the new SQL database appears in the **SQL databases** section.</span></span>

### <a name="deploy-the-app-to-azure"></a><span data-ttu-id="6cebc-252">將應用程式部署至 Azure</span><span class="sxs-lookup"><span data-stu-id="6cebc-252">Deploy the app to Azure</span></span>

1. <span data-ttu-id="6cebc-253">在 Visual Studio 中的專案上按一下滑鼠右鍵**方案總管**，然後選取**發佈**從內容功能表。</span><span class="sxs-lookup"><span data-stu-id="6cebc-253">In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.</span></span>

2. <span data-ttu-id="6cebc-254">在上**挑選發行目標**頁面上，選擇**App Service** ，然後**選取現有**，然後選擇**發行**。</span><span class="sxs-lookup"><span data-stu-id="6cebc-254">On the **Pick a publish target** page, choose **App Service** and then **Select Existing**, and then choose **Publish**.</span></span>

    ![挑選發行目標 頁面](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/publish-select-existing-azure-app-service.png)

3. <span data-ttu-id="6cebc-256">如果您先前尚未在 Visual Studio 中加入您 Azure 訂用帳戶，請在螢幕上執行步驟。</span><span class="sxs-lookup"><span data-stu-id="6cebc-256">If you haven't previously added your Azure subscription in Visual Studio, perform the steps on the screen.</span></span> <span data-ttu-id="6cebc-257">這些步驟可讓 Visual Studio 能夠連線到您 Azure 訂用帳戶因此的清單**應用程式服務**會包含您的網站。</span><span class="sxs-lookup"><span data-stu-id="6cebc-257">These steps enable Visual Studio to connect to your Azure subscription so that the list of **App Services** will include your web site.</span></span>

4. <span data-ttu-id="6cebc-258">在  **App Service**頁面上，選取**訂用帳戶**新增至 App Service。</span><span class="sxs-lookup"><span data-stu-id="6cebc-258">On the **App Service** page, select the **Subscription** you added the App Service to.</span></span> <span data-ttu-id="6cebc-259">底下**檢視**，選取**資源群組**。</span><span class="sxs-lookup"><span data-stu-id="6cebc-259">Under **View**, select **Resource Group**.</span></span> <span data-ttu-id="6cebc-260">展開您新增應用程式服務的資源群組，然後選取 App Service。</span><span class="sxs-lookup"><span data-stu-id="6cebc-260">Expand the resource group you added the App Service to, and then select the App Service.</span></span> <span data-ttu-id="6cebc-261">選擇**確定**發行應用程式。</span><span class="sxs-lookup"><span data-stu-id="6cebc-261">Choose **OK** to publish the app.</span></span>

5. <span data-ttu-id="6cebc-262">**輸出**視窗會顯示所執行的部署動作，並回報成功完成部署。</span><span class="sxs-lookup"><span data-stu-id="6cebc-262">The **Output** window shows what deployment actions were taken and reports successful completion of the deployment.</span></span>

6. <span data-ttu-id="6cebc-263">部署成功時，預設瀏覽器會自動開啟至已部署的網站的 URL。</span><span class="sxs-lookup"><span data-stu-id="6cebc-263">Upon successful deployment, the default browser automatically opens to the URL of the deployed web site.</span></span>

    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/cloud-app-browser.png)

    <span data-ttu-id="6cebc-265">您的應用程式現在正在雲端中執行。</span><span class="sxs-lookup"><span data-stu-id="6cebc-265">Your app is now running in the cloud.</span></span>

<span data-ttu-id="6cebc-266">在此時*SchoolContext*資料庫具有 Azure SQL 資料庫中已建立，因為您選取**Execute Code First Migrations （在應用程式啟動時執行）**。</span><span class="sxs-lookup"><span data-stu-id="6cebc-266">At this point, the *SchoolContext* database has been created in the Azure SQL database because you selected **Execute Code First Migrations (runs on app start)**.</span></span> <span data-ttu-id="6cebc-267">*Web.config*在已部署的網站上的檔案已變更，讓[MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx)初始設定式會執行您的程式碼中讀取或寫入資料的資料庫 （發生在第一次當您選取**學生** 索引標籤上):</span><span class="sxs-lookup"><span data-stu-id="6cebc-267">The *Web.config* file in the deployed web site has been changed so that the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer runs the first time your code reads or writes data in the database (which happened when you selected the **Students** tab):</span></span>

![Web.config 檔案摘錄](https://asp.net/media/4367421/mig.png)

<span data-ttu-id="6cebc-269">部署程序也會建立新的連接字串 *(SchoolContext\_DatabasePublish*) 對要用於更新資料庫結構描述和植入資料庫的 Code First 移轉。</span><span class="sxs-lookup"><span data-stu-id="6cebc-269">The deployment process also created a new connection string *(SchoolContext\_DatabasePublish*) for Code First Migrations to use for updating the database schema and seeding the database.</span></span>

![在 Web.config 檔案中的連接字串](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

<span data-ttu-id="6cebc-271">您可以找到 Web.config 檔案在電腦上部署的版本*ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*。您可以存取已部署*Web.config*檔案本身使用 FTP。</span><span class="sxs-lookup"><span data-stu-id="6cebc-271">You can find the deployed version of the Web.config file on your own computer in *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. You can access the deployed *Web.config* file itself by using FTP.</span></span> <span data-ttu-id="6cebc-272">如需指示，請參閱[使用 Visual Studio 的 ASP.NET Web 部署：部署程式碼更新](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-272">For instructions, see [ASP.NET Web Deployment using Visual Studio: Deploying a Code Update](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span></span> <span data-ttu-id="6cebc-273">遵循指示以開始 「 若要使用 FTP 工具，您需要三件事： FTP URL、 使用者名稱和密碼。 」</span><span class="sxs-lookup"><span data-stu-id="6cebc-273">Follow the instructions that start with "To use an FTP tool, you need three things: the FTP URL, the user name, and the password."</span></span>

> [!NOTE]
> <span data-ttu-id="6cebc-274">Web 應用程式不會實作安全性，以便找到 URL 的任何人可以變更的資料。</span><span class="sxs-lookup"><span data-stu-id="6cebc-274">The web app doesn't implement security, so anyone who finds the URL can change the data.</span></span> <span data-ttu-id="6cebc-275">如需有關如何保護網站上的指示，請參閱[將使用成員資格、 OAuth 和 SQL database 的安全 ASP.NET MVC 應用程式部署至 Azure](/aspnet/core/security/authorization/secure-data)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-275">For instructions on how to secure the web site, see [Deploy a Secure ASP.NET MVC app with Membership, OAuth, and SQL database to Azure](/aspnet/core/security/authorization/secure-data).</span></span> <span data-ttu-id="6cebc-276">您可以防止其他人使用網站服務使用 Azure 管理入口網站或**伺服器總管**Visual Studio 中。</span><span class="sxs-lookup"><span data-stu-id="6cebc-276">You can prevent other people from using the site by stopping the service using the Azure Management Portal or **Server Explorer** in Visual Studio.</span></span>

![停止應用程式服務 功能表項目](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/server-explorer-stop-app-service.png)

## <a name="advanced-migrations-scenarios"></a><span data-ttu-id="6cebc-278">進階的移轉案例</span><span class="sxs-lookup"><span data-stu-id="6cebc-278">Advanced migrations scenarios</span></span>

<span data-ttu-id="6cebc-279">如果您部署資料庫中執行本教學課程中所示的會自動移轉，而且您要部署到多部伺服器執行的 web 站台，您可以取得多部伺服器，嘗試在同一時間執行移轉。</span><span class="sxs-lookup"><span data-stu-id="6cebc-279">If you deploy a database by running migrations automatically as shown in this tutorial, and you are deploying to a web site that runs on multiple servers, you could get multiple servers trying to run migrations at the same time.</span></span> <span data-ttu-id="6cebc-280">移轉是不可部分完成的所以如果兩部伺服器會嘗試執行相同的移轉，其中將會成功，而且其他將會失敗 （假設作業無法完成兩次）。</span><span class="sxs-lookup"><span data-stu-id="6cebc-280">Migrations are atomic, so if two servers try to run the same migration, one will succeed and the other will fail (assuming the operations can't be done twice).</span></span> <span data-ttu-id="6cebc-281">在案例中，如果您想要避免這些問題，您可以手動呼叫移轉並設定自己的程式碼，讓它只會發生一次。</span><span class="sxs-lookup"><span data-stu-id="6cebc-281">In that scenario if you want to avoid those issues, you can call migrations manually and set up your own code so that it only happens once.</span></span> <span data-ttu-id="6cebc-282">如需詳細資訊，請參閱 <<c0> [ 執行，並從程式碼的指令碼移轉](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/)Rowan Miller 部落格上並[Migrate.exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) （適用於從命令列執行移轉）。</span><span class="sxs-lookup"><span data-stu-id="6cebc-282">For more information, see [Running and Scripting Migrations from Code](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) on Rowan Miller's blog and [Migrate.exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (for executing migrations from the command line).</span></span>

<span data-ttu-id="6cebc-283">如需其他移轉案例的資訊，請參閱[移轉螢幕錄製影片系列](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-283">For information about other migrations scenarios, see [Migrations Screencast Series](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span></span>

## <a name="code-first-initializers"></a><span data-ttu-id="6cebc-284">程式碼的第一個初始設定式</span><span class="sxs-lookup"><span data-stu-id="6cebc-284">Code First initializers</span></span>

<span data-ttu-id="6cebc-285">在 [部署] 區段中，您已看到[MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx)所使用的初始設定式。</span><span class="sxs-lookup"><span data-stu-id="6cebc-285">In the deployment section, you saw the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer being used.</span></span> <span data-ttu-id="6cebc-286">程式碼第一次也提供其他初始設定式，包括[CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) （預設值）， [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) （其中您稍早使用） 和[DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-286">Code First also provides other initializers, including [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (the default), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (which you used earlier) and [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span></span> <span data-ttu-id="6cebc-287">`DropCreateAlways`初始設定式可用於設定 單元測試的條件。</span><span class="sxs-lookup"><span data-stu-id="6cebc-287">The `DropCreateAlways` initializer can be useful for setting up conditions for unit tests.</span></span> <span data-ttu-id="6cebc-288">您也可以撰寫您自己的初始設定式，而您可以呼叫初始設定式明確地如果您不想等候，直到應用程式讀取或寫入資料庫。</span><span class="sxs-lookup"><span data-stu-id="6cebc-288">You can also write your own initializers, and you can call an initializer explicitly if you don't want to wait until the application reads from or writes to the database.</span></span>

<span data-ttu-id="6cebc-289">如需初始設定式的詳細資訊，請參閱[了解在 Entity Framework Code First 資料庫初始設定式](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm)並在本書第 6 章[Programming Entity Framework:Code First](http://shop.oreilly.com/product/0636920022220.do) Julie Lerman 和 Rowan Miller。</span><span class="sxs-lookup"><span data-stu-id="6cebc-289">For more information about initializers, see [Understanding Database Initializers in Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) and chapter 6 of the book [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) by Julie Lerman and Rowan Miller.</span></span>

## <a name="get-the-code"></a><span data-ttu-id="6cebc-290">取得程式碼</span><span class="sxs-lookup"><span data-stu-id="6cebc-290">Get the code</span></span>

[<span data-ttu-id="6cebc-291">下載已完成的專案</span><span class="sxs-lookup"><span data-stu-id="6cebc-291">Download the Completed Project</span></span>](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a><span data-ttu-id="6cebc-292">其他資源</span><span class="sxs-lookup"><span data-stu-id="6cebc-292">Additional resources</span></span>

<span data-ttu-id="6cebc-293">其他 Entity Framework 資源連結可在[ASP.NET 資料存取-建議資源](xref:whitepapers/aspnet-data-access-content-map)。</span><span class="sxs-lookup"><span data-stu-id="6cebc-293">Links to other Entity Framework resources can be found in [ASP.NET Data Access - Recommended Resources](xref:whitepapers/aspnet-data-access-content-map).</span></span>

## <a name="next-steps"></a><span data-ttu-id="6cebc-294">後續步驟</span><span class="sxs-lookup"><span data-stu-id="6cebc-294">Next steps</span></span>

<span data-ttu-id="6cebc-295">在本教學課程中，您已：</span><span class="sxs-lookup"><span data-stu-id="6cebc-295">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="6cebc-296">啟用的 Code First 移轉</span><span class="sxs-lookup"><span data-stu-id="6cebc-296">Enabled Code First migrations</span></span>
> * <span data-ttu-id="6cebc-297">在 Azure 中 （選擇性） 將應用程式部署</span><span class="sxs-lookup"><span data-stu-id="6cebc-297">Deployed the app in Azure (optional)</span></span>

<span data-ttu-id="6cebc-298">請前往下一篇文章，以了解如何建立 ASP.NET MVC 應用程式的更複雜的資料模型。</span><span class="sxs-lookup"><span data-stu-id="6cebc-298">Advance to the next article to learn how to create a more complex data model for an ASP.NET MVC Application.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="6cebc-299">建立更複雜的資料模型</span><span class="sxs-lookup"><span data-stu-id="6cebc-299">Create a more complex data model</span></span>](creating-a-more-complex-data-model-for-an-asp-net-mvc-application.md)
