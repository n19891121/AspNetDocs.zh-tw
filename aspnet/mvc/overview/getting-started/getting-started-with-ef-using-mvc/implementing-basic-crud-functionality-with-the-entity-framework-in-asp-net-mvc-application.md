---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
title: 教學課程：使用 ASP.NET MVC 中的 Entity Framework 來執行 CRUD 功能 |Microsoft Docs
description: 檢查及自訂 MVC 架構在控制器和 views 中自動建立的建立、讀取、更新、刪除（CRUD）程式碼。
author: tdykstra
ms.author: riande
ms.date: 01/22/2019
ms.topic: tutorial
ms.assetid: a2f70ba4-83d1-4002-9255-24732726c4f2
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 9ed388543dd54d209ff2a0b92df4f7659962582c
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 03/06/2020
ms.locfileid: "78583157"
---
# <a name="tutorial-implement-crud-functionality-with-the-entity-framework-in-aspnet-mvc"></a><span data-ttu-id="8f189-103">教學課程：使用 ASP.NET MVC 中的 Entity Framework 來執行 CRUD 功能</span><span class="sxs-lookup"><span data-stu-id="8f189-103">Tutorial: Implement CRUD Functionality with the Entity Framework in ASP.NET MVC</span></span>

<span data-ttu-id="8f189-104">在[上一個教學](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)課程中，您建立了一個 MVC 應用程式，它會使用 ENTITY FRAMEWORK （EF）6和 SQL Server LocalDB 來儲存和顯示資料。</span><span class="sxs-lookup"><span data-stu-id="8f189-104">In the [previous tutorial](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md), you created an MVC application that stores and displays data using the Entity Framework (EF) 6 and SQL Server LocalDB.</span></span> <span data-ttu-id="8f189-105">在本教學課程中，您會檢查和自訂 MVC 架構在控制器和 views 中為您自動建立的建立、讀取、更新、刪除（CRUD）程式碼。</span><span class="sxs-lookup"><span data-stu-id="8f189-105">In this tutorial, you review and customize the create, read, update, delete (CRUD) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE]
> <span data-ttu-id="8f189-106">實作儲存機制模式，以在您的控制器及資料存取層之間建立抽象層是一種非常常見的做法。</span><span class="sxs-lookup"><span data-stu-id="8f189-106">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="8f189-107">為了讓這些教學課程保持簡單且專注于教學如何使用 EF 6，它們不會使用存放庫。</span><span class="sxs-lookup"><span data-stu-id="8f189-107">To keep these tutorials simple and focused on teaching how to use EF 6 itself, they don't use repositories.</span></span> <span data-ttu-id="8f189-108">如需如何執行存放庫的資訊，請參閱[ASP.NET 資料存取內容地圖](../../../../whitepapers/aspnet-data-access-content-map.md)。</span><span class="sxs-lookup"><span data-stu-id="8f189-108">For info about how to implement repositories, see the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

<span data-ttu-id="8f189-109">以下是您所建立網頁的範例：</span><span class="sxs-lookup"><span data-stu-id="8f189-109">Here are examples of the web pages you create:</span></span>

![[學生詳細資料] 頁面的螢幕擷取畫面。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image1.png)

![學生 [建立] 頁面的螢幕擷取畫面。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image2.png)

![學生的 [刪除] 頁面的螢幕擷取畫面。](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image3.png)

<span data-ttu-id="8f189-113">在本教學課程中，您已：</span><span class="sxs-lookup"><span data-stu-id="8f189-113">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="8f189-114">建立詳細資料頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-114">Create a Details page</span></span>
> * <span data-ttu-id="8f189-115">更新 [建立] 頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-115">Update the Create page</span></span>
> * <span data-ttu-id="8f189-116">更新 HttpPost Edit 方法</span><span class="sxs-lookup"><span data-stu-id="8f189-116">Update the HttpPost Edit method</span></span>
> * <span data-ttu-id="8f189-117">更新 [刪除] 頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-117">Update the Delete page</span></span>
> * <span data-ttu-id="8f189-118">關閉資料庫連線</span><span class="sxs-lookup"><span data-stu-id="8f189-118">Close database connections</span></span>
> * <span data-ttu-id="8f189-119">處理交易</span><span class="sxs-lookup"><span data-stu-id="8f189-119">Handle transactions</span></span>

## <a name="prerequisites"></a><span data-ttu-id="8f189-120">Prerequisites</span><span class="sxs-lookup"><span data-stu-id="8f189-120">Prerequisites</span></span>

* [<span data-ttu-id="8f189-121">建立 Entity Framework 資料模型</span><span class="sxs-lookup"><span data-stu-id="8f189-121">Create the Entity Framework Data Model</span></span>](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)

## <a name="create-a-details-page"></a><span data-ttu-id="8f189-122">建立詳細資料頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-122">Create a Details page</span></span>

<span data-ttu-id="8f189-123">學生 `Index` 頁面的 scaffold 程式碼會省略 `Enrollments` 屬性，因為該屬性會保存一個集合。</span><span class="sxs-lookup"><span data-stu-id="8f189-123">The scaffolded code for the Students `Index` page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="8f189-124">在 [`Details`] 頁面中，您會在 HTML 資料表中顯示集合的內容。</span><span class="sxs-lookup"><span data-stu-id="8f189-124">In the `Details` page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="8f189-125">在*Controllers\StudentController.cs*中，`Details` 視圖的動作方法會使用[Find](https://msdn.microsoft.com/library/gg696418(v=VS.103).aspx)方法來取出單一 `Student` 實體。</span><span class="sxs-lookup"><span data-stu-id="8f189-125">In *Controllers\StudentController.cs*, the action method for the `Details` view uses the [Find](https://msdn.microsoft.com/library/gg696418(v=VS.103).aspx) method to retrieve a single `Student` entity.</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="8f189-126">金鑰值會當做 `id` 參數傳遞至方法，並來自 [索引] 頁面上 [**詳細**資料] 超連結中的*路由資料*。</span><span class="sxs-lookup"><span data-stu-id="8f189-126">The key value is passed to the method as the `id` parameter and comes from *route data* in the **Details** hyperlink on the Index page.</span></span>

### <a name="tip-route-data"></a><span data-ttu-id="8f189-127">提示：**路由資料**</span><span class="sxs-lookup"><span data-stu-id="8f189-127">Tip: **Route data**</span></span>

<span data-ttu-id="8f189-128">路由資料是模型系結器在路由表中指定的 URL 區段中找到的資料。</span><span class="sxs-lookup"><span data-stu-id="8f189-128">Route data is data that the model binder found in a URL segment specified in the routing table.</span></span> <span data-ttu-id="8f189-129">例如，預設路由會指定 `controller`、`action`和 `id` 區段：</span><span class="sxs-lookup"><span data-stu-id="8f189-129">For example, the default route specifies `controller`, `action`, and `id` segments:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample2.cs?highlight=3)]

<span data-ttu-id="8f189-130">在下列 URL 中，預設路由會將 `Instructor` 為 `controller`，`Index` 做為 `action`，1則做為 `id`;這些是路由資料值。</span><span class="sxs-lookup"><span data-stu-id="8f189-130">In the following URL, the default route maps `Instructor` as the `controller`, `Index` as the `action` and 1 as the `id`; these are route data values.</span></span>

`http://localhost:1230/Instructor/Index/1?courseID=2021`

<span data-ttu-id="8f189-131">`?courseID=2021` 是查詢字串值。</span><span class="sxs-lookup"><span data-stu-id="8f189-131">`?courseID=2021` is a query string value.</span></span> <span data-ttu-id="8f189-132">如果您傳遞 `id` 做為查詢字串值，模型系結器也可以使用：</span><span class="sxs-lookup"><span data-stu-id="8f189-132">The model binder will also work if you pass the `id` as a query string value:</span></span>

`http://localhost:1230/Instructor/Index?id=1&CourseID=2021`

<span data-ttu-id="8f189-133">這些 Url 是由 Razor 視圖中的 `ActionLink` 語句所建立。</span><span class="sxs-lookup"><span data-stu-id="8f189-133">The URLs are created by `ActionLink` statements in the Razor view.</span></span> <span data-ttu-id="8f189-134">在下列程式碼中，`id` 參數符合預設路由，因此 `id` 會加入至路由資料。</span><span class="sxs-lookup"><span data-stu-id="8f189-134">In the following code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample3.cshtml)]

<span data-ttu-id="8f189-135">在下列程式碼中，`courseID` 不符合預設路由中的參數，因此會將它新增為查詢字串。</span><span class="sxs-lookup"><span data-stu-id="8f189-135">In the following code, `courseID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample4.cshtml)]

### <a name="to-create-the-details-page"></a><span data-ttu-id="8f189-136">若要建立詳細資料頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-136">To create the Details page</span></span>

1. <span data-ttu-id="8f189-137">開啟*Views\Student\Details.cshtml*。</span><span class="sxs-lookup"><span data-stu-id="8f189-137">Open *Views\Student\Details.cshtml*.</span></span>

   <span data-ttu-id="8f189-138">每個欄位都會使用 `DisplayFor` helper 來顯示，如下列範例所示：</span><span class="sxs-lookup"><span data-stu-id="8f189-138">Each field is displayed using a `DisplayFor` helper, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample5.cshtml)]

2. <span data-ttu-id="8f189-139">在 [`EnrollmentDate`] 欄位之後，以及緊接在結尾 `</dl>` 標記之前，新增反白顯示的程式碼以顯示註冊清單，如下列範例所示：</span><span class="sxs-lookup"><span data-stu-id="8f189-139">After the `EnrollmentDate` field and immediately before the closing `</dl>` tag, add the highlighted code to display a list of enrollments, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample6.cshtml?highlight=8-29)]

    <span data-ttu-id="8f189-140">當您貼上程式碼之後，如果代碼縮排錯誤，請按**ctrl**+**K**， **ctrl**+**D**來格式化它。</span><span class="sxs-lookup"><span data-stu-id="8f189-140">If code indentation is wrong after you paste the code, press **Ctrl**+**K**, **Ctrl**+**D** to format it.</span></span>

    <span data-ttu-id="8f189-141">此程式碼會以迴圈逐一巡覽 `Enrollments` 導覽屬性中的實體。</span><span class="sxs-lookup"><span data-stu-id="8f189-141">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="8f189-142">針對屬性中的每個 `Enrollment` 實體，它會顯示課程標題和等級。</span><span class="sxs-lookup"><span data-stu-id="8f189-142">For each `Enrollment` entity in the property, it displays the course title and the grade.</span></span> <span data-ttu-id="8f189-143">課程標題會從儲存在 `Enrollments` 實體之 `Course` 導覽屬性中的 `Course` 實體中抓取。</span><span class="sxs-lookup"><span data-stu-id="8f189-143">The course title is retrieved from the `Course` entity that's stored in the `Course` navigation property of the `Enrollments` entity.</span></span> <span data-ttu-id="8f189-144">這項資料會在需要時自動從資料庫中取出。</span><span class="sxs-lookup"><span data-stu-id="8f189-144">All of this data is retrieved from the database automatically when it's needed.</span></span> <span data-ttu-id="8f189-145">換句話說，您在這裡使用的是消極式載入。</span><span class="sxs-lookup"><span data-stu-id="8f189-145">In other words, you are using lazy loading here.</span></span> <span data-ttu-id="8f189-146">您未指定 `Courses` 導覽屬性的*積極式載入*，因此不會在獲得學生的相同查詢中抓取註冊。</span><span class="sxs-lookup"><span data-stu-id="8f189-146">You did not specify *eager loading* for the `Courses` navigation property, so the enrollments were not retrieved in the same query that got the students.</span></span> <span data-ttu-id="8f189-147">相反地，當您第一次嘗試存取 `Enrollments` 導覽屬性時，會將新的查詢傳送至資料庫，以取得資料。</span><span class="sxs-lookup"><span data-stu-id="8f189-147">Instead, the first time you try to access the `Enrollments` navigation property, a new query is sent to the database to retrieve the data.</span></span> <span data-ttu-id="8f189-148">您可以在本系列稍後的[閱讀相關資料](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md)教學課程中深入瞭解消極式載入和積極式載入。</span><span class="sxs-lookup"><span data-stu-id="8f189-148">You can read more about lazy loading and eager loading in the [Reading Related Data](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial later in this series.</span></span>

3. <span data-ttu-id="8f189-149">啟動程式（**Ctrl**+**F5**），選取 [**學生**] 索引標籤，然後按一下 [Alexander Carson] 的 [**詳細資料**] 連結，以開啟 [詳細資料] 頁面。</span><span class="sxs-lookup"><span data-stu-id="8f189-149">Open the Details page by starting the program (**Ctrl**+**F5**), selecting the **Students** tab, and then clicking the **Details** link for Alexander Carson.</span></span> <span data-ttu-id="8f189-150">（如果您按**Ctrl**+**F5** ，而*Details*檔案已開啟，則會收到 HTTP 400 錯誤。</span><span class="sxs-lookup"><span data-stu-id="8f189-150">(If you press **Ctrl**+**F5** while the *Details.cshtml* file is open, you get an HTTP 400 error.</span></span> <span data-ttu-id="8f189-151">這是因為 Visual Studio 嘗試執行詳細資料頁面，但無法從指定要顯示之學生的連結中取得。</span><span class="sxs-lookup"><span data-stu-id="8f189-151">This is because Visual Studio tries to run the Details page, but it wasn't reached from a link that specifies the student to display.</span></span> <span data-ttu-id="8f189-152">如果發生這種情況，請從 URL 移除 "Student/Details"，然後再試一次，或關閉瀏覽器，以滑鼠**按右鍵專案，然後按一下 [** **在瀏覽器中 > 視圖**]）。</span><span class="sxs-lookup"><span data-stu-id="8f189-152">If that happens, remove "Student/Details" from the URL and try again, or, close the browser, right-click the project, and click **View** > **View in Browser**.)</span></span>

    <span data-ttu-id="8f189-153">您會看到所選學生的課程和成績清單。</span><span class="sxs-lookup"><span data-stu-id="8f189-153">You see the list of courses and grades for the selected student.</span></span>

4. <span data-ttu-id="8f189-154">關閉瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="8f189-154">Close the browser.</span></span>

## <a name="update-the-create-page"></a><span data-ttu-id="8f189-155">更新 [建立] 頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-155">Update the Create page</span></span>

1. <span data-ttu-id="8f189-156">在*Controllers\StudentController.cs*中，將 <xref:System.Web.Mvc.HttpPostAttribute> `Create` 動作方法取代為下列程式碼。</span><span class="sxs-lookup"><span data-stu-id="8f189-156">In *Controllers\StudentController.cs*, replace the <xref:System.Web.Mvc.HttpPostAttribute> `Create` action method with the following code.</span></span> <span data-ttu-id="8f189-157">此程式碼會新增 `try-catch` 區塊，並從 scaffold 方法的 <xref:System.Web.Mvc.BindAttribute> 屬性移除 `ID`：</span><span class="sxs-lookup"><span data-stu-id="8f189-157">This code adds a `try-catch` block and removes `ID` from the <xref:System.Web.Mvc.BindAttribute> attribute for the scaffolded method:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample7.cs?highlight=3,5-6,13-18)]

    <span data-ttu-id="8f189-158">此程式碼會將 ASP.NET MVC 模型系結器所建立的 `Student` 實體加入 `Students` 實體集，然後將變更儲存至資料庫。</span><span class="sxs-lookup"><span data-stu-id="8f189-158">This code adds the `Student` entity created by the ASP.NET MVC model binder to the `Students` entity set and then saves the changes to the database.</span></span> <span data-ttu-id="8f189-159">*模型*系結器指的是 ASP.NET 的 MVC 功能，可讓您更輕鬆地使用表單所提交的資料;模型系結器會將已張貼的表單值轉換成 CLR 類型，並將它們傳遞至參數中的動作方法。</span><span class="sxs-lookup"><span data-stu-id="8f189-159">*Model binder* refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="8f189-160">在此情況下，模型系結器會使用 `Form` 集合中的屬性值，為您具現化 `Student` 實體。</span><span class="sxs-lookup"><span data-stu-id="8f189-160">In this case, the model binder instantiates a `Student` entity for you using property values from the `Form` collection.</span></span>

    <span data-ttu-id="8f189-161">您已從系結屬性中移除 `ID`，因為 `ID` 是 SQL Server 會在插入資料列時自動設定的主要索引鍵值。</span><span class="sxs-lookup"><span data-stu-id="8f189-161">You removed `ID` from the Bind attribute because `ID` is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="8f189-162">使用者的輸入未設定 `ID` 值。</span><span class="sxs-lookup"><span data-stu-id="8f189-162">Input from the user does not set the `ID` value.</span></span>

    <a id="overpost"></a>

    ### <a name="security-warning---the-validateantiforgerytoken-attribute-helps-prevent-cross-site-request-forgery-attacks-it-requires-a-corresponding-htmlantiforgerytoken-statement-in-the-view-which-youll-see-later"></a><span data-ttu-id="8f189-163">安全性警告-`ValidateAntiForgeryToken` 屬性有助於防止[跨網站偽造要求](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻擊。</span><span class="sxs-lookup"><span data-stu-id="8f189-163">Security warning - The `ValidateAntiForgeryToken` attribute helps prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span> <span data-ttu-id="8f189-164">它在視圖中需要有對應的 `Html.AntiForgeryToken()` 語句，稍後您會看到。</span><span class="sxs-lookup"><span data-stu-id="8f189-164">It requires a corresponding `Html.AntiForgeryToken()` statement in the view, which you'll see later.</span></span>

    <span data-ttu-id="8f189-165">`Bind` 屬性是在建立案例中保護不會*過度張貼*的一種方式。</span><span class="sxs-lookup"><span data-stu-id="8f189-165">The `Bind` attribute is one way to protect against *over-posting* in create scenarios.</span></span> <span data-ttu-id="8f189-166">例如，假設 `Student` 實體包含您不想要讓此網頁設定的 `Secret` 屬性。</span><span class="sxs-lookup"><span data-stu-id="8f189-166">For example, suppose the `Student` entity includes a `Secret` property that you don't want this web page to set.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample8.cs?highlight=7)]

    <span data-ttu-id="8f189-167">即使網頁上沒有 `Secret` 欄位，駭客也可以使用[fiddler](http://fiddler2.com/home)之類的工具，或是撰寫一些 JavaScript，以張貼 `Secret` 的表單值。</span><span class="sxs-lookup"><span data-stu-id="8f189-167">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as [fiddler](http://fiddler2.com/home), or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="8f189-168">如果沒有 <xref:System.Web.Mvc.BindAttribute> 屬性會限制模型系結器在建立 `Student` 實例時所使用的欄位<em>，</em>模型系結器會收取該 `Secret` 的表單值，並使用它來建立 `Student` 實體實例。</span><span class="sxs-lookup"><span data-stu-id="8f189-168">Without the <xref:System.Web.Mvc.BindAttribute> attribute limiting the fields that the model binder uses when it creates a `Student` instance<em>,</em> the model binder would pick up that `Secret` form value and use it to create the `Student` entity instance.</span></span> <span data-ttu-id="8f189-169">則無論駭客在 `Secret` 表單欄位中指定了什麼值，該值都會更新到您的資料庫中。</span><span class="sxs-lookup"><span data-stu-id="8f189-169">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="8f189-170">下圖顯示 fiddler 工具將 [`Secret`] 欄位（值為 "OverPost"）新增至張貼的表單值。</span><span class="sxs-lookup"><span data-stu-id="8f189-170">The following image shows the fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

    ![](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image5.png)

    <span data-ttu-id="8f189-171">"OverPost" 的值會成功新增到插入資料列的 `Secret` 屬性中，即使您沒有要讓網頁設定該屬性。</span><span class="sxs-lookup"><span data-stu-id="8f189-171">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

    <span data-ttu-id="8f189-172">最佳做法是使用 `Include` 參數搭配 `Bind` 屬性來將欄位*列入白名單*。</span><span class="sxs-lookup"><span data-stu-id="8f189-172">It's best to use the `Include` parameter with the `Bind` attribute to *whitelist* fields.</span></span> <span data-ttu-id="8f189-173">您也可以使用 `Exclude` 參數，將您要排除的欄位*列入*封鎖清單。</span><span class="sxs-lookup"><span data-stu-id="8f189-173">It's also possible to use the `Exclude` parameter to *blacklist* fields you want to exclude.</span></span> <span data-ttu-id="8f189-174">`Include` 的原因較安全，因為當您將新的屬性加入至實體時，新的欄位不會自動受到 `Exclude` 清單的保護。</span><span class="sxs-lookup"><span data-stu-id="8f189-174">The reason `Include` is more secure is that when you add a new property to the entity, the new field is not automatically protected by an `Exclude` list.</span></span>

    <span data-ttu-id="8f189-175">您可以在編輯案例中避免防止大量指派，方法是先從資料庫讀取實體，然後呼叫 `TryUpdateModel`，傳入明確允許的屬性清單。</span><span class="sxs-lookup"><span data-stu-id="8f189-175">You can prevent overposting in edit scenarios is by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="8f189-176">這是在這些教學課程中使用的方法。</span><span class="sxs-lookup"><span data-stu-id="8f189-176">That is the method used in these tutorials.</span></span>

    <span data-ttu-id="8f189-177">另一種避免許多開發人員慣用的防止大量指派的方法，就是使用視圖模型，而不是透過模型系結的實體類別。</span><span class="sxs-lookup"><span data-stu-id="8f189-177">An alternative way to prevent overposting that is preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="8f189-178">意即僅在檢視模型中包含您想要更新的屬性。</span><span class="sxs-lookup"><span data-stu-id="8f189-178">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="8f189-179">一旦 MVC 模型系結器完成，請將視圖模型屬性複製到實體實例，並選擇性地使用[AutoMapper](http://automapper.org/)之類的工具。</span><span class="sxs-lookup"><span data-stu-id="8f189-179">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as [AutoMapper](http://automapper.org/).</span></span> <span data-ttu-id="8f189-180">使用 db。在實體實例上的專案，將其狀態設定為 [未變更]，然後設定屬性（"PropertyName"）。在視圖模型所包含的每個實體屬性上，IsModified 為 true。</span><span class="sxs-lookup"><span data-stu-id="8f189-180">Use db.Entry on the entity instance to set its state to Unchanged, and then set Property("PropertyName").IsModified to true on each entity property that is included in the view model.</span></span> <span data-ttu-id="8f189-181">這個方法可同時運用在編輯及建立案例中。</span><span class="sxs-lookup"><span data-stu-id="8f189-181">This method works in both edit and create scenarios.</span></span>

    <span data-ttu-id="8f189-182">除了 `Bind` 屬性以外，`try-catch` 區塊是您對 scaffold 程式碼所做的唯一變更。</span><span class="sxs-lookup"><span data-stu-id="8f189-182">Other than the `Bind` attribute, the `try-catch` block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="8f189-183">若在儲存變更時捕捉到衍生自 <xref:System.Data.DataException> 的例外狀況，則會顯示一般錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="8f189-183">If an exception that derives from <xref:System.Data.DataException> is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="8f189-184"><xref:System.Data.DataException> 例外狀況有時候是因為某些外部因素造成的，而非程式設計上的錯誤，因此系統會建議使用者再試一次。</span><span class="sxs-lookup"><span data-stu-id="8f189-184"><xref:System.Data.DataException> exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="8f189-185">雖然在此範例中並未實作，但生產環境品質的應用程式應記錄例外狀況。</span><span class="sxs-lookup"><span data-stu-id="8f189-185">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="8f189-186">如需詳細資訊，請參閱**監視及遙測 (使用 Azure 建置現實世界的雲端應用程式)** 中的[深入解析記錄檔](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log)一節。</span><span class="sxs-lookup"><span data-stu-id="8f189-186">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log).</span></span>

    <span data-ttu-id="8f189-187">*Views\Student\Create.cshtml*中的程式碼類似于您在*詳細資料*中所看到的內容，不同之處在于，`EditorFor` 和 `ValidationMessageFor` helper 會用於每個欄位，而不是 `DisplayFor`。</span><span class="sxs-lookup"><span data-stu-id="8f189-187">The code in *Views\Student\Create.cshtml* is similar to what you saw in *Details.cshtml*, except that `EditorFor` and `ValidationMessageFor` helpers are used for each field instead of `DisplayFor`.</span></span> <span data-ttu-id="8f189-188">以下是相關的程式碼：</span><span class="sxs-lookup"><span data-stu-id="8f189-188">Here is the relevant code:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample9.cshtml)]

    <span data-ttu-id="8f189-189">*Create. cshtml*也包含 `@Html.AntiForgeryToken()`，其可與控制器中的 `ValidateAntiForgeryToken` 屬性搭配使用，以協助防止[跨網站偽造要求](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻擊。</span><span class="sxs-lookup"><span data-stu-id="8f189-189">*Create.cshtml* also includes `@Html.AntiForgeryToken()`, which works with the `ValidateAntiForgeryToken` attribute in the controller to help prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span>

    <span data-ttu-id="8f189-190">*Create. cshtml*中不需要進行任何變更。</span><span class="sxs-lookup"><span data-stu-id="8f189-190">No changes are required in *Create.cshtml*.</span></span>

2. <span data-ttu-id="8f189-191">啟動程式、選取 [**學生**] 索引標籤，**然後按一下 [新建]** ，以執行頁面。</span><span class="sxs-lookup"><span data-stu-id="8f189-191">Run the page by starting the program, selecting the **Students** tab, and then clicking **Create New**.</span></span>

3. <span data-ttu-id="8f189-192">輸入名稱和不正確日期，然後按一下 [**建立**] 以查看錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="8f189-192">Enter names and an invalid date and click **Create** to see the error message.</span></span>

    <span data-ttu-id="8f189-193">這是您預設會取得的伺服器端驗證。</span><span class="sxs-lookup"><span data-stu-id="8f189-193">This is server-side validation that you get by default.</span></span> <span data-ttu-id="8f189-194">在稍後的教學課程中，您將瞭解如何新增屬性來產生用戶端驗證的程式碼。</span><span class="sxs-lookup"><span data-stu-id="8f189-194">In a later tutorial, you'll see how to add attributes that generate code for client-side validation.</span></span> <span data-ttu-id="8f189-195">下列反白顯示的程式碼顯示**Create**方法中的模型驗證檢查。</span><span class="sxs-lookup"><span data-stu-id="8f189-195">The following highlighted code shows the model validation check in the **Create** method.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample10.cs?highlight=1)]

4. <span data-ttu-id="8f189-196">將日期變更為有效的值，然後按一下 [建立] 來在 [索引] 頁面上查看新增的學生。</span><span class="sxs-lookup"><span data-stu-id="8f189-196">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

5. <span data-ttu-id="8f189-197">關閉瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="8f189-197">Close the browser.</span></span>

## <a name="update-httppost-edit-method"></a><span data-ttu-id="8f189-198">更新 HttpPost 編輯方法</span><span class="sxs-lookup"><span data-stu-id="8f189-198">Update HttpPost Edit method</span></span>

1. <span data-ttu-id="8f189-199">使用下列程式碼取代 <xref:System.Web.Mvc.HttpPostAttribute> `Edit` 動作方法：</span><span class="sxs-lookup"><span data-stu-id="8f189-199">Replace the <xref:System.Web.Mvc.HttpPostAttribute> `Edit` action method with the following code:</span></span>

   [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample11.cs)]

   > [!NOTE]
   > <span data-ttu-id="8f189-200">在*Controllers\StudentController.cs*中，`HttpGet Edit` 方法（沒有 `HttpPost` 屬性的方法）會使用 `Find` 方法來抓取選取的 `Student` 實體，如同您在 `Details` 方法中所見。</span><span class="sxs-lookup"><span data-stu-id="8f189-200">In *Controllers\StudentController.cs*, the `HttpGet Edit` method (the one without the `HttpPost` attribute) uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="8f189-201">您不需要變更這個方法。</span><span class="sxs-lookup"><span data-stu-id="8f189-201">You don't need to change this method.</span></span>

   <span data-ttu-id="8f189-202">這些變更會執行安全性最佳作法，以避免[防止大量指派](#overpost)，scaffolder 會產生 `Bind` 屬性，並將模型系結器所建立的實體新增至具有修改旗標的實體集。</span><span class="sxs-lookup"><span data-stu-id="8f189-202">These changes implement a security best practice to prevent [overposting](#overpost), The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a Modified flag.</span></span> <span data-ttu-id="8f189-203">不再建議該程式碼，因為 `Bind` 屬性會清除 `Include` 參數中未列出之欄位中的任何預先存在的資料。</span><span class="sxs-lookup"><span data-stu-id="8f189-203">That code is no longer recommended because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span> <span data-ttu-id="8f189-204">在未來，將會更新 MVC 控制器 scaffolder，使其不會產生編輯方法的 `Bind` 屬性。</span><span class="sxs-lookup"><span data-stu-id="8f189-204">In the future, the MVC controller scaffolder will be updated so that it doesn't generate `Bind` attributes for Edit methods.</span></span>

   <span data-ttu-id="8f189-205">新的程式碼會讀取現有的實體，並呼叫 <xref:System.Web.Mvc.Controller.TryUpdateModel%2A>，以在張貼的表單資料中更新使用者輸入的欄位。</span><span class="sxs-lookup"><span data-stu-id="8f189-205">The new code reads the existing entity and calls <xref:System.Web.Mvc.Controller.TryUpdateModel%2A> to update fields from user input in the posted form data.</span></span> <span data-ttu-id="8f189-206">Entity Framework 的自動變更追蹤會在實體上設定[EntityState](<xref:System.Data.EntityState.Modified>)旗標。</span><span class="sxs-lookup"><span data-stu-id="8f189-206">The Entity Framework's automatic change tracking sets the [EntityState.Modified](<xref:System.Data.EntityState.Modified>) flag on the entity.</span></span> <span data-ttu-id="8f189-207">呼叫[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)方法時，<xref:System.Data.EntityState.Modified> 旗標會使 ENTITY FRAMEWORK 建立 SQL 語句以更新資料庫資料列。</span><span class="sxs-lookup"><span data-stu-id="8f189-207">When the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method is called, the <xref:System.Data.EntityState.Modified> flag causes the Entity Framework to create SQL statements to update the database row.</span></span> <span data-ttu-id="8f189-208">系統會忽略[並行衝突](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)，而且會更新資料庫資料列的所有資料行，包括使用者未變更的欄位。</span><span class="sxs-lookup"><span data-stu-id="8f189-208">[Concurrency conflicts](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) are ignored, and all columns of the database row are updated, including those that the user didn't change.</span></span> <span data-ttu-id="8f189-209">（稍後的教學課程會示範如何處理並行衝突，如果您只想要在資料庫中更新個別的欄位，您可以將實體設定為[EntityState](<xref:System.Data.EntityState.Unchanged>) ，並將個別欄位設定為[EntityState. Modified](<xref:System.Data.EntityState.Modified>)）。</span><span class="sxs-lookup"><span data-stu-id="8f189-209">(A later tutorial shows how to handle concurrency conflicts, and if you only want individual fields to be updated in the database, you can set the entity to [EntityState.Unchanged](<xref:System.Data.EntityState.Unchanged>) and set individual fields to [EntityState.Modified](<xref:System.Data.EntityState.Modified>).)</span></span>

   <span data-ttu-id="8f189-210">若要避免防止大量指派，您要由 [編輯] 頁面更新的欄位會在 `TryUpdateModel` 參數的白名單中。</span><span class="sxs-lookup"><span data-stu-id="8f189-210">To prevent overposting, the fields that you want to be updateable by the Edit page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="8f189-211">雖然目前沒有額外保護的欄位，但列出您希望模型繫結器繫結的欄位可確保您於未來將欄位新增到資料模型中時，新增的欄位會自動獲得保護，直到您明確的在這裡新增它們為止。</span><span class="sxs-lookup"><span data-stu-id="8f189-211">Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

   <span data-ttu-id="8f189-212">由於這些變更的結果，HttpPost Edit 方法的方法簽章與 HttpGet edit 方法相同。因此，您已將方法重新命名為 EditPost。</span><span class="sxs-lookup"><span data-stu-id="8f189-212">As a result of these changes, the method signature of the HttpPost Edit method is the same as the HttpGet edit method; therefore you've renamed the method EditPost.</span></span>

   > [!TIP]
   >
   > <span data-ttu-id="8f189-213">**實體狀態和 Attach 和 SaveChanges 方法**</span><span class="sxs-lookup"><span data-stu-id="8f189-213">**Entity States and the Attach and SaveChanges Methods**</span></span>
   >
   > <span data-ttu-id="8f189-214">資料庫內容會追蹤實體在記憶體中是否與其在資料庫中相對應的資料列保持同步，並且此項資訊會決定當您呼叫 `SaveChanges` 方法時會發生什麼事情。</span><span class="sxs-lookup"><span data-stu-id="8f189-214">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="8f189-215">例如，當您將新實體傳遞至[Add](https://msdn.microsoft.com/library/system.data.entity.dbset.add(v=vs.103).aspx)方法時，該實體的狀態會設定為 `Added`。</span><span class="sxs-lookup"><span data-stu-id="8f189-215">For example, when you pass a new entity to the [Add](https://msdn.microsoft.com/library/system.data.entity.dbset.add(v=vs.103).aspx) method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="8f189-216">然後，當您呼叫[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)方法時，資料庫內容就會發出 SQL `INSERT` 命令。</span><span class="sxs-lookup"><span data-stu-id="8f189-216">Then when you call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method, the database context issues a SQL `INSERT` command.</span></span>
   >
   > <span data-ttu-id="8f189-217">實體可能處於下列其中一種[狀態](xref:System.Data.EntityState)：</span><span class="sxs-lookup"><span data-stu-id="8f189-217">An entity may be in one of the following [states](xref:System.Data.EntityState):</span></span>
   >
   > - <span data-ttu-id="8f189-218">`Added`</span><span class="sxs-lookup"><span data-stu-id="8f189-218">`Added`.</span></span> <span data-ttu-id="8f189-219">實體尚未存在於資料庫中。</span><span class="sxs-lookup"><span data-stu-id="8f189-219">The entity does not yet exist in the database.</span></span> <span data-ttu-id="8f189-220">`SaveChanges` 的方法必須發出 `INSERT` 語句。</span><span class="sxs-lookup"><span data-stu-id="8f189-220">The `SaveChanges` method must issue an `INSERT` statement.</span></span>
   > - <span data-ttu-id="8f189-221">`Unchanged`</span><span class="sxs-lookup"><span data-stu-id="8f189-221">`Unchanged`.</span></span> <span data-ttu-id="8f189-222">`SaveChanges` 方法針對這個實體不需要進行任何動作。</span><span class="sxs-lookup"><span data-stu-id="8f189-222">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="8f189-223">當您從資料庫讀取一個實體時，實體便會以此狀態開始。</span><span class="sxs-lookup"><span data-stu-id="8f189-223">When you read an entity from the database, the entity starts out with this status.</span></span>
   > - <span data-ttu-id="8f189-224">`Modified`</span><span class="sxs-lookup"><span data-stu-id="8f189-224">`Modified`.</span></span> <span data-ttu-id="8f189-225">實體中一部分或全部的屬性值已經過修改。</span><span class="sxs-lookup"><span data-stu-id="8f189-225">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="8f189-226">`SaveChanges` 的方法必須發出 `UPDATE` 語句。</span><span class="sxs-lookup"><span data-stu-id="8f189-226">The `SaveChanges` method must issue an `UPDATE` statement.</span></span>
   > - <span data-ttu-id="8f189-227">`Deleted`</span><span class="sxs-lookup"><span data-stu-id="8f189-227">`Deleted`.</span></span> <span data-ttu-id="8f189-228">實體已遭標示刪除。</span><span class="sxs-lookup"><span data-stu-id="8f189-228">The entity has been marked for deletion.</span></span> <span data-ttu-id="8f189-229">`SaveChanges` 的方法必須發出 `DELETE` 語句。</span><span class="sxs-lookup"><span data-stu-id="8f189-229">The `SaveChanges` method must issue a `DELETE` statement.</span></span>
   > - <span data-ttu-id="8f189-230">`Detached`</span><span class="sxs-lookup"><span data-stu-id="8f189-230">`Detached`.</span></span> <span data-ttu-id="8f189-231">實體未獲得資料庫內容追蹤。</span><span class="sxs-lookup"><span data-stu-id="8f189-231">The entity isn't being tracked by the database context.</span></span>
   >
   > <span data-ttu-id="8f189-232">在桌面應用程式中，狀態變更通常會自動進行設定。</span><span class="sxs-lookup"><span data-stu-id="8f189-232">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="8f189-233">在桌上型電腦類型的應用程式中，您會讀取實體並對其部分屬性值進行變更。</span><span class="sxs-lookup"><span data-stu-id="8f189-233">In a desktop type of application, you read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="8f189-234">這會使得其實體狀態自動變更為 `Modified`。</span><span class="sxs-lookup"><span data-stu-id="8f189-234">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="8f189-235">然後，當您呼叫 `SaveChanges`時，Entity Framework 會產生 SQL `UPDATE` 語句，只更新您所變更的實際屬性。</span><span class="sxs-lookup"><span data-stu-id="8f189-235">Then when you call `SaveChanges`, the Entity Framework generates a SQL `UPDATE` statement that updates only the actual properties that you changed.</span></span>
   >
   > <span data-ttu-id="8f189-236">Web apps 中斷連線的本質不允許此連續順序。</span><span class="sxs-lookup"><span data-stu-id="8f189-236">The disconnected nature of web apps doesn't allow for this continuous sequence.</span></span> <span data-ttu-id="8f189-237">在呈現頁面之後，會處置讀取實體的[DbCoNtext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx) 。</span><span class="sxs-lookup"><span data-stu-id="8f189-237">The [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx) that reads an entity is disposed after a page is rendered.</span></span> <span data-ttu-id="8f189-238">呼叫 `HttpPost` `Edit` 動作方法時，會提出新的要求，而且您會有新的[DbCoNtext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx)實例，因此您必須手動將實體狀態設定為 `Modified.` 然後當您呼叫 `SaveChanges`時，Entity Framework 會更新資料庫資料列的所有資料行，因為內容無法得知您變更的屬性。</span><span class="sxs-lookup"><span data-stu-id="8f189-238">When the `HttpPost` `Edit` action method is called, a new request is made and you have a new instance of the [DbContext](https://msdn.microsoft.com/library/system.data.entity.dbcontext(v=VS.103).aspx), so you have to manually set the entity state to `Modified.` Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>
   >
   > <span data-ttu-id="8f189-239">如果您想要 SQL `Update` 語句僅更新使用者實際變更的欄位，您可以用某種方式儲存原始值（例如隱藏欄位），以便在呼叫 `HttpPost` `Edit` 方法時使用它們。</span><span class="sxs-lookup"><span data-stu-id="8f189-239">If you want the SQL `Update` statement to update only the fields that the user actually changed, you can save the original values in some way (such as hidden fields) so that they are available when the `HttpPost` `Edit` method is called.</span></span> <span data-ttu-id="8f189-240">接著，您可以使用原始值來建立 `Student` 實體、以該實體的原始版本呼叫 `Attach` 方法、將實體的值更新為新的值，然後呼叫 `SaveChanges.` 以取得詳細資訊，請參閱[實體狀態和 SaveChanges](/ef/ef6/saving/change-tracking/entity-state)和[本機資料](/ef/ef6/querying/local-data)。</span><span class="sxs-lookup"><span data-stu-id="8f189-240">Then you can create a `Student` entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges.` For more information, see [Entity states and SaveChanges](/ef/ef6/saving/change-tracking/entity-state) and [Local Data](/ef/ef6/querying/local-data).</span></span>

   <span data-ttu-id="8f189-241">*Views\Student\Edit.cshtml*中的 HTML 和 Razor 程式碼類似于您在*Create. cshtml*中看到的內容，而且不需要進行任何變更。</span><span class="sxs-lookup"><span data-stu-id="8f189-241">The HTML and Razor code in *Views\Student\Edit.cshtml* is similar to what you saw in *Create.cshtml*, and no changes are required.</span></span>

2. <span data-ttu-id="8f189-242">啟動程式、選取 [**學生**] 索引標籤，然後按一下 [**編輯**] 超連結，以執行頁面。</span><span class="sxs-lookup"><span data-stu-id="8f189-242">Run the page by starting the program, selecting the **Students** tab, and then clicking an **Edit** hyperlink.</span></span>

3. <span data-ttu-id="8f189-243">變更一部分的資料，然後按一下 [儲存]。</span><span class="sxs-lookup"><span data-stu-id="8f189-243">Change some of the data and click **Save**.</span></span> <span data-ttu-id="8f189-244">您會在 [索引] 頁面中看到變更的資料。</span><span class="sxs-lookup"><span data-stu-id="8f189-244">You see the changed data in the Index page.</span></span>

4. <span data-ttu-id="8f189-245">關閉瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="8f189-245">Close the browser.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="8f189-246">更新 [刪除] 頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-246">Update the Delete page</span></span>

<span data-ttu-id="8f189-247">在*Controllers\StudentController.cs*中，<xref:System.Web.Mvc.HttpGetAttribute> `Delete` 方法的範本程式碼會使用 `Find` 方法來抓取選取的 `Student` 實體，如同您在 `Details` 和 `Edit` 方法中所見。</span><span class="sxs-lookup"><span data-stu-id="8f189-247">In *Controllers\StudentController.cs*, the template code for the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` and `Edit` methods.</span></span> <span data-ttu-id="8f189-248">然而，若要在呼叫 `SaveChanges` 失敗時實作自訂錯誤訊息，您需要將一些功能新增至此方法及其對應的檢視。</span><span class="sxs-lookup"><span data-stu-id="8f189-248">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="8f189-249">如同您在更新及建立作業中所看到的，刪除作業需要兩個動作方法。</span><span class="sxs-lookup"><span data-stu-id="8f189-249">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="8f189-250">回應 GET 要求所呼叫的方法會顯示一個視圖，讓使用者有機會核准或取消刪除作業。</span><span class="sxs-lookup"><span data-stu-id="8f189-250">The method that is called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="8f189-251">若使用者核准，則便會建立 POST 要求。</span><span class="sxs-lookup"><span data-stu-id="8f189-251">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="8f189-252">發生這種情況時，會呼叫 `HttpPost` `Delete` 方法，然後該方法會實際執行刪除作業。</span><span class="sxs-lookup"><span data-stu-id="8f189-252">When that happens, the `HttpPost` `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="8f189-253">您會將 `try-catch` 區塊新增至 <xref:System.Web.Mvc.HttpPostAttribute> `Delete` 方法，以處理資料庫更新時可能發生的任何錯誤。</span><span class="sxs-lookup"><span data-stu-id="8f189-253">You'll add a `try-catch` block to the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="8f189-254">如果發生錯誤，<xref:System.Web.Mvc.HttpPostAttribute> `Delete` 方法會呼叫 <xref:System.Web.Mvc.HttpGetAttribute> `Delete` 方法，並將指出發生錯誤的參數傳遞給它。</span><span class="sxs-lookup"><span data-stu-id="8f189-254">If an error occurs, the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` method calls the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="8f189-255"><xref:System.Web.Mvc.HttpGetAttribute> `Delete` 方法接著會重新顯示確認頁面，並顯示錯誤訊息，讓使用者有機會取消或再試一次。</span><span class="sxs-lookup"><span data-stu-id="8f189-255">The <xref:System.Web.Mvc.HttpGetAttribute> `Delete` method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

1. <span data-ttu-id="8f189-256">將 <xref:System.Web.Mvc.HttpGetAttribute> `Delete` 動作方法取代為下列程式碼，以管理錯誤報表：</span><span class="sxs-lookup"><span data-stu-id="8f189-256">Replace the <xref:System.Web.Mvc.HttpGetAttribute> `Delete` action method with the following code, which manages error reporting:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample12.cs?highlight=1,7-10)]

    <span data-ttu-id="8f189-257">此程式碼會接受[選擇性的參數](https://msdn.microsoft.com/library/dd264739.aspx)，指出在無法儲存變更之後是否呼叫了方法。</span><span class="sxs-lookup"><span data-stu-id="8f189-257">This code accepts an [optional parameter](https://msdn.microsoft.com/library/dd264739.aspx) that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="8f189-258">呼叫 `HttpGet` `Delete` 方法時，如果沒有先前的失敗，就會 `false` 此參數。</span><span class="sxs-lookup"><span data-stu-id="8f189-258">This parameter is `false` when the `HttpGet` `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="8f189-259">當 `HttpPost` `Delete` 方法呼叫它來回應資料庫更新錯誤時，會 `true` 參數，並將錯誤訊息傳遞給視圖。</span><span class="sxs-lookup"><span data-stu-id="8f189-259">When it is called by the `HttpPost` `Delete` method in response to a database update error, the parameter is `true` and an error message is passed to the view.</span></span>

2. <span data-ttu-id="8f189-260">將 <xref:System.Web.Mvc.HttpPostAttribute> `Delete` 動作方法（名為 `DeleteConfirmed`）取代為下列程式碼，以執行實際的刪除作業並捕捉任何資料庫更新錯誤。</span><span class="sxs-lookup"><span data-stu-id="8f189-260">Replace the <xref:System.Web.Mvc.HttpPostAttribute> `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample13.cs)]

    <span data-ttu-id="8f189-261">此程式碼會抓取選取的實體，然後呼叫[Remove](https://msdn.microsoft.com/library/system.data.entity.dbset.remove(v=vs.103).aspx)方法，將實體的狀態設定為 `Deleted`。</span><span class="sxs-lookup"><span data-stu-id="8f189-261">This code retrieves the selected entity, then calls the [Remove](https://msdn.microsoft.com/library/system.data.entity.dbset.remove(v=vs.103).aspx) method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="8f189-262">呼叫 `SaveChanges` 時，會產生 SQL `DELETE` 命令。</span><span class="sxs-lookup"><span data-stu-id="8f189-262">When `SaveChanges` is called, a SQL `DELETE` command is generated.</span></span> <span data-ttu-id="8f189-263">您也將動作方法的名稱從 `DeleteConfirmed` 變更為 `Delete`。</span><span class="sxs-lookup"><span data-stu-id="8f189-263">You have also changed the action method name from `DeleteConfirmed` to `Delete`.</span></span> <span data-ttu-id="8f189-264">名為 `HttpPost` 的 scaffold 程式碼 `Delete` 方法 `DeleteConfirmed`，為 `HttpPost` 方法提供唯一的簽章。</span><span class="sxs-lookup"><span data-stu-id="8f189-264">The scaffolded code named the `HttpPost` `Delete` method `DeleteConfirmed` to give the `HttpPost` method a unique signature.</span></span> <span data-ttu-id="8f189-265">（CLR 需要多載的方法，才能有不同的方法參數）。簽章是唯一的，您可以使用 MVC 慣例，並將相同的名稱用於 `HttpPost` 和 `HttpGet` delete 方法。</span><span class="sxs-lookup"><span data-stu-id="8f189-265">(The CLR requires overloaded methods to have different method parameters.) Now that the signatures are unique, you can stick with the MVC convention and use the same name for the `HttpPost` and `HttpGet` delete methods.</span></span>

    <span data-ttu-id="8f189-266">如果提升高容量應用程式的效能是一項優先考慮，您可以使用下列程式碼取代呼叫 `Find` 和 `Remove` 方法的程式程式碼，以避免不必要的 SQL 查詢抓取資料列：</span><span class="sxs-lookup"><span data-stu-id="8f189-266">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query to retrieve the row by replacing the lines of code that call the `Find` and `Remove` methods with the following code:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample14.cs)]

    <span data-ttu-id="8f189-267">此程式碼會只使用主要索引鍵值來具現化 `Student` 實體，然後將實體狀態設定為 `Deleted`。</span><span class="sxs-lookup"><span data-stu-id="8f189-267">This code instantiates a `Student` entity using only the primary key value and then sets the entity state to `Deleted`.</span></span> <span data-ttu-id="8f189-268">這便是 Entity Framework 要刪除實體所需要的一切資訊。</span><span class="sxs-lookup"><span data-stu-id="8f189-268">That's all that the Entity Framework needs in order to delete the entity.</span></span>

    <span data-ttu-id="8f189-269">如先前所述，`HttpGet` `Delete` 方法不會刪除資料。</span><span class="sxs-lookup"><span data-stu-id="8f189-269">As noted, the `HttpGet` `Delete` method doesn't delete the data.</span></span> <span data-ttu-id="8f189-270">執行刪除作業以回應 GET 要求（也就是，執行任何編輯作業、建立作業或任何其他變更資料的作業）會造成安全性風險。</span><span class="sxs-lookup"><span data-stu-id="8f189-270">Performing a delete operation in response to a GET request (or for that matter, performing any edit operation, create operation, or any other operation that changes data) creates a security risk.</span></span> <span data-ttu-id="8f189-271">如需詳細資訊，請參閱[ASP.NET MVC Tip #46-不要使用刪除連結，因為它們會](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx)在 Stephen Walther 的 blog 上建立安全性漏洞。</span><span class="sxs-lookup"><span data-stu-id="8f189-271">For more information, see [ASP.NET MVC Tip #46 — Don't use Delete Links because they create Security Holes](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx) on Stephen Walther's blog.</span></span>

3. <span data-ttu-id="8f189-272">在*Views\Student\Delete.cshtml*中，于 [`h2`] 標題和 [`h3`] 標題之間新增錯誤訊息，如下列範例所示：</span><span class="sxs-lookup"><span data-stu-id="8f189-272">In *Views\Student\Delete.cshtml*, add an error message between the `h2` heading and the `h3` heading, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample15.cshtml?highlight=2)]

4. <span data-ttu-id="8f189-273">啟動程式、選取 [**學生**] 索引標籤，然後按一下 [**刪除**] 超連結，以執行頁面。</span><span class="sxs-lookup"><span data-stu-id="8f189-273">Run the page by starting the program, selecting the **Students** tab, and then clicking a **Delete** hyperlink.</span></span>

5. <span data-ttu-id="8f189-274">在顯示**您確定要刪除此專案**的頁面上，選擇 [**刪除**]。</span><span class="sxs-lookup"><span data-stu-id="8f189-274">Choose **Delete** on the page that says **Are you sure you want to delete this?**.</span></span>

    <span data-ttu-id="8f189-275">[索引] 頁面會顯示，但不含已刪除的學生。</span><span class="sxs-lookup"><span data-stu-id="8f189-275">The Index page displays without the deleted student.</span></span> <span data-ttu-id="8f189-276">（您會在[並行教學](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)課程中看到錯誤處理常式代碼的範例）。</span><span class="sxs-lookup"><span data-stu-id="8f189-276">(You'll see an example of the error handling code in action in the [concurrency tutorial](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md).)</span></span>

## <a name="close-database-connections"></a><span data-ttu-id="8f189-277">關閉資料庫連線</span><span class="sxs-lookup"><span data-stu-id="8f189-277">Close database connections</span></span>

<span data-ttu-id="8f189-278">若要關閉資料庫連接，並儘快釋放其保留的資源，請在完成時處置內容實例。</span><span class="sxs-lookup"><span data-stu-id="8f189-278">To close database connections and free up the resources they hold as soon as possible, dispose the context instance when you are done with it.</span></span> <span data-ttu-id="8f189-279">這就是為什麼 scaffold 程式碼會在*StudentController.cs*中的 `StudentController` 類別結尾提供[Dispose](https://msdn.microsoft.com/library/system.idisposable.dispose(v=vs.110).aspx)方法，如下列範例所示：</span><span class="sxs-lookup"><span data-stu-id="8f189-279">That is why the scaffolded code provides a [Dispose](https://msdn.microsoft.com/library/system.idisposable.dispose(v=vs.110).aspx) method at the end of the `StudentController` class in *StudentController.cs*, as shown in the following example:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample16.cs)]

<span data-ttu-id="8f189-280">基底 `Controller` 類別已經實 `IDisposable` 介面，因此此程式碼只會將覆寫加入至 `Dispose(bool)` 方法，以明確處置內容實例。</span><span class="sxs-lookup"><span data-stu-id="8f189-280">The base `Controller` class already implements the `IDisposable` interface, so this code simply adds an override to the `Dispose(bool)` method to explicitly dispose the context instance.</span></span>

## <a name="handle-transactions"></a><span data-ttu-id="8f189-281">處理交易</span><span class="sxs-lookup"><span data-stu-id="8f189-281">Handle transactions</span></span>

<span data-ttu-id="8f189-282">根據預設，Entity Framework 隱含性的實作了交易。</span><span class="sxs-lookup"><span data-stu-id="8f189-282">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="8f189-283">在您對多個資料列或資料表進行變更，然後呼叫 `SaveChanges`的情況下，Entity Framework 會自動確保所有變更都成功或全部失敗。</span><span class="sxs-lookup"><span data-stu-id="8f189-283">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or all fail.</span></span> <span data-ttu-id="8f189-284">若有些變更已先完成，之後卻發生錯誤，則這些變更都會自動進行復原。</span><span class="sxs-lookup"><span data-stu-id="8f189-284">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="8f189-285">針對您需要更多控制&mdash;例如，如果您想要在交易中包含在 Entity Framework 外部完成的作業&mdash;請參閱[使用交易](/ef/ef6/saving/transactions)。</span><span class="sxs-lookup"><span data-stu-id="8f189-285">For scenarios where you need more control&mdash;for example, if you want to include operations done outside of Entity Framework in a transaction&mdash;see [Working with Transactions](/ef/ef6/saving/transactions).</span></span>

## <a name="get-the-code"></a><span data-ttu-id="8f189-286">取得程式碼</span><span class="sxs-lookup"><span data-stu-id="8f189-286">Get the code</span></span>

[<span data-ttu-id="8f189-287">下載已完成的專案</span><span class="sxs-lookup"><span data-stu-id="8f189-287">Download Completed Project</span></span>](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a><span data-ttu-id="8f189-288">其他資源</span><span class="sxs-lookup"><span data-stu-id="8f189-288">Additional resources</span></span>

<span data-ttu-id="8f189-289">您現在有一組完整的頁面，可為 `Student` 實體執行簡單的 CRUD 作業。</span><span class="sxs-lookup"><span data-stu-id="8f189-289">You now have a complete set of pages that perform simple CRUD operations for `Student` entities.</span></span> <span data-ttu-id="8f189-290">您使用 MVC helper 來產生資料欄位的 UI 元素。</span><span class="sxs-lookup"><span data-stu-id="8f189-290">You used MVC helpers to generate UI elements for data fields.</span></span> <span data-ttu-id="8f189-291">如需 MVC helper 的詳細資訊，請參閱使用 HTML 協助程式轉譯[表單](/previous-versions/aspnet/dd410596(v=vs.98))（這篇文章是針對 mvc 3，但仍與 mvc 5 有關）。</span><span class="sxs-lookup"><span data-stu-id="8f189-291">For more info about MVC helpers, see [Rendering a Form Using HTML Helpers](/previous-versions/aspnet/dd410596(v=vs.98)) (the article is for MVC 3 but is still relevant for MVC 5).</span></span>

<span data-ttu-id="8f189-292">您可以在[ASP.NET 資料存取-建議的資源](../../../../whitepapers/aspnet-data-access-content-map.md)中找到其他 EF 6 資源的連結。</span><span class="sxs-lookup"><span data-stu-id="8f189-292">Links to other EF 6 resources can be found in [ASP.NET Data Access - Recommended Resources](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

## <a name="next-steps"></a><span data-ttu-id="8f189-293">後續步驟</span><span class="sxs-lookup"><span data-stu-id="8f189-293">Next steps</span></span>

<span data-ttu-id="8f189-294">在本教學課程中，您已：</span><span class="sxs-lookup"><span data-stu-id="8f189-294">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="8f189-295">建立詳細資料頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-295">Created a Details page</span></span>
> * <span data-ttu-id="8f189-296">更新 [建立] 頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-296">Updated the Create page</span></span>
> * <span data-ttu-id="8f189-297">已更新 HttpPost Edit 方法</span><span class="sxs-lookup"><span data-stu-id="8f189-297">Updated the HttpPost Edit method</span></span>
> * <span data-ttu-id="8f189-298">更新 [刪除] 頁面</span><span class="sxs-lookup"><span data-stu-id="8f189-298">Updated the Delete page</span></span>
> * <span data-ttu-id="8f189-299">關閉資料庫連線</span><span class="sxs-lookup"><span data-stu-id="8f189-299">Closed database connections</span></span>
> * <span data-ttu-id="8f189-300">已處理的交易</span><span class="sxs-lookup"><span data-stu-id="8f189-300">Handled transactions</span></span>

<span data-ttu-id="8f189-301">前進到下一篇文章，以瞭解如何將排序、篩選和分頁加入至專案。</span><span class="sxs-lookup"><span data-stu-id="8f189-301">Advance to the next article to learn how to add sorting, filtering, and paging to the project.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="8f189-302">排序、篩選與分頁</span><span class="sxs-lookup"><span data-stu-id="8f189-302">Sorting, Filtering, and Paging</span></span>](sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md)
